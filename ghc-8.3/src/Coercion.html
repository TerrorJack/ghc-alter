<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>types/Coercion.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The University of Glasgow 2006
<a name="line-3"></a>-}</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-comment'>{-# LANGUAGE RankNTypes, CPP, MultiWayIf, FlexibleContexts #-}</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-comment'>-- | Module for (a) type kinds and (b) type coercions,</span>
<a name="line-8"></a><span class='hs-comment'>-- as used in System FC. See 'CoreSyn.Expr' for</span>
<a name="line-9"></a><span class='hs-comment'>-- more on System FC and how coercions fit into it.</span>
<a name="line-10"></a><span class='hs-comment'>--</span>
<a name="line-11"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Coercion</span> <span class='hs-layout'>(</span>
<a name="line-12"></a>        <span class='hs-comment'>-- * Main data type</span>
<a name="line-13"></a>        <span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoercionN</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoercionR</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoercionP</span><span class='hs-layout'>,</span>
<a name="line-14"></a>        <span class='hs-conid'>UnivCoProvenance</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoercionHole</span><span class='hs-layout'>,</span> <span class='hs-conid'>LeftOrRight</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-15"></a>        <span class='hs-conid'>Var</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCoVar</span><span class='hs-layout'>,</span>
<a name="line-16"></a>        <span class='hs-conid'>Role</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ltRole</span><span class='hs-layout'>,</span>
<a name="line-17"></a>
<a name="line-18"></a>        <span class='hs-comment'>-- ** Functions over coercions</span>
<a name="line-19"></a>        <span class='hs-varid'>coVarTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarKindsTypesRole</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarRole</span><span class='hs-layout'>,</span>
<a name="line-20"></a>        <span class='hs-varid'>coercionType</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionKinds</span><span class='hs-layout'>,</span>
<a name="line-21"></a>        <span class='hs-varid'>mkCoercionType</span><span class='hs-layout'>,</span>
<a name="line-22"></a>        <span class='hs-varid'>coercionRole</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionKindRole</span><span class='hs-layout'>,</span>
<a name="line-23"></a>
<a name="line-24"></a>        <span class='hs-comment'>-- ** Constructing coercions</span>
<a name="line-25"></a>        <span class='hs-varid'>mkReflCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkRepReflCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkNomReflCo</span><span class='hs-layout'>,</span>
<a name="line-26"></a>        <span class='hs-varid'>mkCoVarCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCoVarCos</span><span class='hs-layout'>,</span>
<a name="line-27"></a>        <span class='hs-varid'>mkAxInstCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkUnbranchedAxInstCo</span><span class='hs-layout'>,</span>
<a name="line-28"></a>        <span class='hs-varid'>mkAxInstRHS</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkUnbranchedAxInstRHS</span><span class='hs-layout'>,</span>
<a name="line-29"></a>        <span class='hs-varid'>mkAxInstLHS</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkUnbranchedAxInstLHS</span><span class='hs-layout'>,</span>
<a name="line-30"></a>        <span class='hs-varid'>mkPiCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkPiCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCoCast</span><span class='hs-layout'>,</span>
<a name="line-31"></a>        <span class='hs-varid'>mkSymCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTransCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTransAppCo</span><span class='hs-layout'>,</span>
<a name="line-32"></a>        <span class='hs-varid'>mkNthCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkNthCoRole</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkLRCo</span><span class='hs-layout'>,</span>
<a name="line-33"></a>        <span class='hs-varid'>mkInstCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAppCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAppCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyConAppCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFunCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFunCos</span><span class='hs-layout'>,</span>
<a name="line-34"></a>        <span class='hs-varid'>mkForAllCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkForAllCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkHomoForAllCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkHomoForAllCos_NoRefl</span><span class='hs-layout'>,</span>
<a name="line-35"></a>        <span class='hs-varid'>mkPhantomCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkHomoPhantomCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>toPhantomCo</span><span class='hs-layout'>,</span>
<a name="line-36"></a>        <span class='hs-varid'>mkUnsafeCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkHoleCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkUnivCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSubCo</span><span class='hs-layout'>,</span>
<a name="line-37"></a>        <span class='hs-varid'>mkAxiomInstCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkProofIrrelCo</span><span class='hs-layout'>,</span>
<a name="line-38"></a>        <span class='hs-varid'>downgradeRole</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybeSubCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAxiomRuleCo</span><span class='hs-layout'>,</span>
<a name="line-39"></a>        <span class='hs-varid'>mkCoherenceCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCoherenceRightCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCoherenceLeftCo</span><span class='hs-layout'>,</span>
<a name="line-40"></a>        <span class='hs-varid'>mkKindCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>castCoercionKind</span><span class='hs-layout'>,</span>
<a name="line-41"></a>
<a name="line-42"></a>        <span class='hs-varid'>mkHeteroCoercionType</span><span class='hs-layout'>,</span>
<a name="line-43"></a>
<a name="line-44"></a>        <span class='hs-comment'>-- ** Decomposition</span>
<a name="line-45"></a>        <span class='hs-varid'>instNewTyCon_maybe</span><span class='hs-layout'>,</span>
<a name="line-46"></a>
<a name="line-47"></a>        <span class='hs-conid'>NormaliseStepper</span><span class='hs-layout'>,</span> <span class='hs-conid'>NormaliseStepResult</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>composeSteppers</span><span class='hs-layout'>,</span>
<a name="line-48"></a>        <span class='hs-varid'>mapStepResult</span><span class='hs-layout'>,</span> <span class='hs-varid'>unwrapNewTypeStepper</span><span class='hs-layout'>,</span>
<a name="line-49"></a>        <span class='hs-varid'>topNormaliseNewType_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>topNormaliseTypeX</span><span class='hs-layout'>,</span>
<a name="line-50"></a>
<a name="line-51"></a>        <span class='hs-varid'>decomposeCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>decomposeFunCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>getCoVar_maybe</span><span class='hs-layout'>,</span>
<a name="line-52"></a>        <span class='hs-varid'>splitTyConAppCo_maybe</span><span class='hs-layout'>,</span>
<a name="line-53"></a>        <span class='hs-varid'>splitAppCo_maybe</span><span class='hs-layout'>,</span>
<a name="line-54"></a>        <span class='hs-varid'>splitFunCo_maybe</span><span class='hs-layout'>,</span>
<a name="line-55"></a>        <span class='hs-varid'>splitForAllCo_maybe</span><span class='hs-layout'>,</span>
<a name="line-56"></a>
<a name="line-57"></a>        <span class='hs-varid'>nthRole</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConRolesX</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConRolesRepresentational</span><span class='hs-layout'>,</span> <span class='hs-varid'>setNominalRole_maybe</span><span class='hs-layout'>,</span>
<a name="line-58"></a>
<a name="line-59"></a>        <span class='hs-varid'>pickLR</span><span class='hs-layout'>,</span>
<a name="line-60"></a>
<a name="line-61"></a>        <span class='hs-varid'>isReflCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>isReflCo_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>isReflexiveCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>isReflexiveCo_maybe</span><span class='hs-layout'>,</span>
<a name="line-62"></a>        <span class='hs-varid'>isReflCoVar_maybe</span><span class='hs-layout'>,</span>
<a name="line-63"></a>
<a name="line-64"></a>        <span class='hs-comment'>-- ** Coercion variables</span>
<a name="line-65"></a>        <span class='hs-varid'>mkCoVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCoVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarName</span><span class='hs-layout'>,</span> <span class='hs-varid'>setCoVarName</span><span class='hs-layout'>,</span> <span class='hs-varid'>setCoVarUnique</span><span class='hs-layout'>,</span>
<a name="line-66"></a>        <span class='hs-varid'>isCoVar_maybe</span><span class='hs-layout'>,</span>
<a name="line-67"></a>
<a name="line-68"></a>        <span class='hs-comment'>-- ** Free variables</span>
<a name="line-69"></a>        <span class='hs-varid'>tyCoVarsOfCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarsOfCo</span><span class='hs-layout'>,</span>
<a name="line-70"></a>        <span class='hs-varid'>tyCoFVsOfCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoFVsOfCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfCoDSet</span><span class='hs-layout'>,</span>
<a name="line-71"></a>        <span class='hs-varid'>coercionSize</span><span class='hs-layout'>,</span>
<a name="line-72"></a>
<a name="line-73"></a>        <span class='hs-comment'>-- ** Substitution</span>
<a name="line-74"></a>        <span class='hs-conid'>CvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyCvSubstEnv</span><span class='hs-layout'>,</span>
<a name="line-75"></a>        <span class='hs-varid'>lookupCoVar</span><span class='hs-layout'>,</span>
<a name="line-76"></a>        <span class='hs-varid'>substCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoWith</span><span class='hs-layout'>,</span>
<a name="line-77"></a>        <span class='hs-varid'>substCoVarBndr</span><span class='hs-layout'>,</span>
<a name="line-78"></a>        <span class='hs-varid'>extendTvSubstAndInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>getCvSubstEnv</span><span class='hs-layout'>,</span>
<a name="line-79"></a>
<a name="line-80"></a>        <span class='hs-comment'>-- ** Lifting</span>
<a name="line-81"></a>        <span class='hs-varid'>liftCoSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftCoSubstTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftCoSubstWith</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftCoSubstWithEx</span><span class='hs-layout'>,</span>
<a name="line-82"></a>        <span class='hs-varid'>emptyLiftingContext</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendLiftingContext</span><span class='hs-layout'>,</span>
<a name="line-83"></a>        <span class='hs-varid'>liftCoSubstVarBndrCallback</span><span class='hs-layout'>,</span> <span class='hs-varid'>isMappedByLC</span><span class='hs-layout'>,</span>
<a name="line-84"></a>
<a name="line-85"></a>        <span class='hs-varid'>mkSubstLiftingContext</span><span class='hs-layout'>,</span> <span class='hs-varid'>zapLiftingContext</span><span class='hs-layout'>,</span>
<a name="line-86"></a>        <span class='hs-varid'>substForAllCoBndrCallbackLC</span><span class='hs-layout'>,</span> <span class='hs-varid'>lcTCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>lcInScopeSet</span><span class='hs-layout'>,</span>
<a name="line-87"></a>
<a name="line-88"></a>        <span class='hs-conid'>LiftCoEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>LiftingContext</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftEnvSubstLeft</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftEnvSubstRight</span><span class='hs-layout'>,</span>
<a name="line-89"></a>        <span class='hs-varid'>substRightCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>substLeftCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>swapLiftCoEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>lcSubstLeft</span><span class='hs-layout'>,</span> <span class='hs-varid'>lcSubstRight</span><span class='hs-layout'>,</span>
<a name="line-90"></a>
<a name="line-91"></a>        <span class='hs-comment'>-- ** Comparison</span>
<a name="line-92"></a>        <span class='hs-varid'>eqCoercion</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqCoercionX</span><span class='hs-layout'>,</span>
<a name="line-93"></a>
<a name="line-94"></a>        <span class='hs-comment'>-- ** Forcing evaluation of coercions</span>
<a name="line-95"></a>        <span class='hs-varid'>seqCo</span><span class='hs-layout'>,</span>
<a name="line-96"></a>
<a name="line-97"></a>        <span class='hs-comment'>-- * Pretty-printing</span>
<a name="line-98"></a>        <span class='hs-varid'>pprCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendCo</span><span class='hs-layout'>,</span>
<a name="line-99"></a>        <span class='hs-varid'>pprCoAxiom</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprCoAxBranch</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprCoAxBranchHdr</span><span class='hs-layout'>,</span>
<a name="line-100"></a>
<a name="line-101"></a>        <span class='hs-comment'>-- * Tidying</span>
<a name="line-102"></a>        <span class='hs-varid'>tidyCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyCos</span><span class='hs-layout'>,</span>
<a name="line-103"></a>
<a name="line-104"></a>        <span class='hs-comment'>-- * Other</span>
<a name="line-105"></a>        <span class='hs-varid'>promoteCoercion</span>
<a name="line-106"></a>       <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-107"></a>
<a name="line-108"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-109"></a>
<a name="line-110"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCoRep</span>
<a name="line-111"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-112"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-113"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoAxiom</span>
<a name="line-114"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-115"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-116"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-varid'>varName</span> <span class='hs-layout'>)</span>
<a name="line-117"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-118"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-119"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-120"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-121"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Pair</span>
<a name="line-122"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-123"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-124"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysPrim</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>eqPhantPrimTyCon</span> <span class='hs-layout'>)</span>
<a name="line-125"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>
<a name="line-126"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-127"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-128"></a>
<a name="line-129"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldM</span><span class='hs-layout'>)</span>
<a name="line-130"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Arrow</span> <span class='hs-layout'>(</span> <span class='hs-varid'>first</span> <span class='hs-layout'>)</span>
<a name="line-131"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Function</span> <span class='hs-layout'>(</span> <span class='hs-varid'>on</span> <span class='hs-layout'>)</span>
<a name="line-132"></a>
<a name="line-133"></a><span class='hs-comment'>{-
<a name="line-134"></a>%************************************************************************
<a name="line-135"></a>%*                                                                      *
<a name="line-136"></a>     -- The coercion arguments always *precisely* saturate
<a name="line-137"></a>     -- arity of (that branch of) the CoAxiom.  If there are
<a name="line-138"></a>     -- any left over, we use AppCo.  See
<a name="line-139"></a>     -- See [Coercion axioms applied to coercions] in TyCoRep
<a name="line-140"></a>
<a name="line-141"></a>\subsection{Coercion variables}
<a name="line-142"></a>%*                                                                      *
<a name="line-143"></a>%************************************************************************
<a name="line-144"></a>-}</span>
<a name="line-145"></a>
<a name="line-146"></a><a name="coVarName"></a><span class='hs-definition'>coVarName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-147"></a><span class='hs-definition'>coVarName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varName</span>
<a name="line-148"></a>
<a name="line-149"></a><a name="setCoVarUnique"></a><span class='hs-definition'>setCoVarUnique</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span>
<a name="line-150"></a><span class='hs-definition'>setCoVarUnique</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setVarUnique</span>
<a name="line-151"></a>
<a name="line-152"></a><a name="setCoVarName"></a><span class='hs-definition'>setCoVarName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span>
<a name="line-153"></a><span class='hs-definition'>setCoVarName</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setVarName</span>
<a name="line-154"></a>
<a name="line-155"></a><span class='hs-comment'>{-
<a name="line-156"></a>%************************************************************************
<a name="line-157"></a>%*                                                                      *
<a name="line-158"></a>                   Pretty-printing CoAxioms
<a name="line-159"></a>%*                                                                      *
<a name="line-160"></a>%************************************************************************
<a name="line-161"></a>
<a name="line-162"></a>Defined here to avoid module loops. CoAxiom is loaded very early on.
<a name="line-163"></a>
<a name="line-164"></a>-}</span>
<a name="line-165"></a>
<a name="line-166"></a><a name="pprCoAxiom"></a><span class='hs-definition'>pprCoAxiom</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-167"></a><span class='hs-definition'>pprCoAxiom</span> <span class='hs-varid'>ax</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_branches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>branches</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-168"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"axiom"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ax</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span><span class='hs-layout'>)</span>
<a name="line-169"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_co_ax_branch</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>pprType</span><span class='hs-layout'>)</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fromBranches</span> <span class='hs-varid'>branches</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-170"></a>
<a name="line-171"></a><a name="pprCoAxBranch"></a><span class='hs-definition'>pprCoAxBranch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-172"></a><span class='hs-definition'>pprCoAxBranch</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_co_ax_branch</span> <span class='hs-varid'>pprRhs</span>
<a name="line-173"></a>  <span class='hs-keyword'>where</span>
<a name="line-174"></a>    <span class='hs-varid'>pprRhs</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>rhs</span>
<a name="line-175"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tycon</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>rhs</span>
<a name="line-176"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>isDataFamilyTyCon</span> <span class='hs-varid'>fam_tc</span>
<a name="line-177"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprDataCons</span> <span class='hs-varid'>tycon</span>
<a name="line-178"></a>
<a name="line-179"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-180"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rhs</span>
<a name="line-181"></a>
<a name="line-182"></a><a name="pprCoAxBranchHdr"></a><span class='hs-definition'>pprCoAxBranchHdr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchIndex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-183"></a><span class='hs-definition'>pprCoAxBranchHdr</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprCoAxBranch</span> <span class='hs-varid'>ax</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span><span class='hs-layout'>)</span>
<a name="line-184"></a>
<a name="line-185"></a><a name="ppr_co_ax_branch"></a><span class='hs-definition'>ppr_co_ax_branch</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-186"></a><span class='hs-definition'>ppr_co_ax_branch</span> <span class='hs-varid'>ppr_rhs</span>
<a name="line-187"></a>              <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-188"></a>              <span class='hs-layout'>(</span><span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span>
<a name="line-189"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>cab_cvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cvs</span>
<a name="line-190"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span>
<a name="line-191"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span>
<a name="line-192"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>cab_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-193"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr1</span> <span class='hs-layout'>(</span><span class='hs-varid'>flip</span> <span class='hs-varid'>hangNotEmpty</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-194"></a>        <span class='hs-keyglyph'>[</span> <span class='hs-varid'>pprUserForAll</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarBinders</span> <span class='hs-conid'>Inferred</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-195"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>pprTypeApp</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>lhs</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>equals</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_rhs</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>rhs</span>
<a name="line-196"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"-- Defined"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprLoc</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>]</span>
<a name="line-197"></a>  <span class='hs-keyword'>where</span>
<a name="line-198"></a>        <span class='hs-varid'>pprLoc</span> <span class='hs-varid'>loc</span>
<a name="line-199"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGoodSrcSpan</span> <span class='hs-varid'>loc</span>
<a name="line-200"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"at"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcSpanStart</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-201"></a>
<a name="line-202"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-203"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"in"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-204"></a>              <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameModule</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-205"></a>
<a name="line-206"></a><span class='hs-comment'>{-
<a name="line-207"></a>%************************************************************************
<a name="line-208"></a>%*                                                                      *
<a name="line-209"></a>        Destructing coercions
<a name="line-210"></a>%*                                                                      *
<a name="line-211"></a>%************************************************************************
<a name="line-212"></a>
<a name="line-213"></a>Note [Function coercions]
<a name="line-214"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-215"></a>Remember that
<a name="line-216"></a>  (-&gt;) :: forall r1 r2. TYPE r1 -&gt; TYPE r2 -&gt; TYPE LiftedRep
<a name="line-217"></a>
<a name="line-218"></a>Hence
<a name="line-219"></a>  FunCo r co1 co2 :: (s1-&gt;t1) ~r (s2-&gt;t2)
<a name="line-220"></a>is short for
<a name="line-221"></a>  TyConAppCo (-&gt;) co_rep1 co_rep2 co1 co2
<a name="line-222"></a>where co_rep1, co_rep2 are the coercions on the representations.
<a name="line-223"></a>-}</span>
<a name="line-224"></a>
<a name="line-225"></a>
<a name="line-226"></a><a name="decomposeCo"></a><span class='hs-comment'>-- | This breaks a 'Coercion' with type @T A B C ~ T D E F@ into</span>
<a name="line-227"></a><span class='hs-comment'>-- a list of 'Coercion's of kinds @A ~ D@, @B ~ E@ and @E ~ F@. Hence:</span>
<a name="line-228"></a><span class='hs-comment'>--</span>
<a name="line-229"></a><span class='hs-comment'>-- &gt; decomposeCo 3 c = [nth 0 c, nth 1 c, nth 2 c]</span>
<a name="line-230"></a><span class='hs-definition'>decomposeCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-231"></a><span class='hs-definition'>decomposeCo</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>co</span>
<a name="line-232"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>(</span><span class='hs-varid'>arity</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-233"></a>           <span class='hs-comment'>-- Remember, Nth is zero-indexed</span>
<a name="line-234"></a>
<a name="line-235"></a><a name="decomposeFunCo"></a><span class='hs-definition'>decomposeFunCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-236"></a><span class='hs-comment'>-- Expects co :: (s1 -&gt; t1) ~ (s2 -&gt; t2)</span>
<a name="line-237"></a><span class='hs-comment'>-- Returns (co1 :: s1~s2, co2 :: t1~t2)</span>
<a name="line-238"></a><span class='hs-comment'>-- See Note [Function coercions] for the "2" and "3"</span>
<a name="line-239"></a><span class='hs-definition'>decomposeFunCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>all_ok</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span> <span class='hs-layout'>)</span>
<a name="line-240"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>mkNthCo</span> <span class='hs-num'>2</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-num'>3</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-241"></a>  <span class='hs-keyword'>where</span>
<a name="line-242"></a>    <span class='hs-conid'>Pair</span> <span class='hs-varid'>s1t1</span> <span class='hs-varid'>s2t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span>
<a name="line-243"></a>    <span class='hs-varid'>all_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isFunTy</span> <span class='hs-varid'>s1t1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isFunTy</span> <span class='hs-varid'>s2t2</span>
<a name="line-244"></a>
<a name="line-245"></a><a name="getCoVar_maybe"></a><span class='hs-comment'>-- | Attempts to obtain the type variable underlying a 'Coercion'</span>
<a name="line-246"></a><span class='hs-definition'>getCoVar_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CoVar</span>
<a name="line-247"></a><span class='hs-definition'>getCoVar_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cv</span>
<a name="line-248"></a><span class='hs-definition'>getCoVar_maybe</span> <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-249"></a>
<a name="line-250"></a><a name="splitTyConAppCo_maybe"></a><span class='hs-comment'>-- | Attempts to tease a coercion apart into a type constructor and the application</span>
<a name="line-251"></a><span class='hs-comment'>-- of a number of coercion arguments to that constructor</span>
<a name="line-252"></a><span class='hs-definition'>splitTyConAppCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-253"></a><span class='hs-definition'>splitTyConAppCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-254"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-255"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-256"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-257"></a><span class='hs-definition'>splitTyConAppCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-258"></a><span class='hs-definition'>splitTyConAppCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>funTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-259"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkRuntimeRepCo</span> <span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkRuntimeRepCo</span> <span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-keyglyph'>]</span>
<a name="line-260"></a><span class='hs-definition'>splitTyConAppCo_maybe</span> <span class='hs-keyword'>_</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-261"></a>
<a name="line-262"></a><a name="splitAppCo_maybe"></a><span class='hs-comment'>-- first result has role equal to input; third result is Nominal</span>
<a name="line-263"></a><span class='hs-definition'>splitAppCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-264"></a><span class='hs-comment'>-- ^ Attempt to take a coercion application apart.</span>
<a name="line-265"></a><span class='hs-definition'>splitAppCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-266"></a><span class='hs-definition'>splitAppCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-267"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mightBeUnsaturatedTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>||</span> <span class='hs-varid'>args</span> <span class='hs-varop'>`lengthExceeds`</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span>
<a name="line-268"></a>    <span class='hs-comment'>-- Never create unsaturated type family apps!</span>
<a name="line-269"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>args'</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>snocView</span> <span class='hs-varid'>args</span>
<a name="line-270"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>arg''</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-varid'>arg'</span>
<a name="line-271"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args'</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg''</span> <span class='hs-layout'>)</span>
<a name="line-272"></a>       <span class='hs-comment'>-- Use mkTyConAppCo to preserve the invariant</span>
<a name="line-273"></a>       <span class='hs-comment'>--  that identity coercions are always represented by Refl</span>
<a name="line-274"></a>
<a name="line-275"></a><span class='hs-definition'>splitAppCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-276"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitAppTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-277"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-278"></a><span class='hs-definition'>splitAppCo_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-279"></a>
<a name="line-280"></a><a name="splitFunCo_maybe"></a><span class='hs-definition'>splitFunCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-281"></a><span class='hs-definition'>splitFunCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-282"></a><span class='hs-definition'>splitFunCo_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-283"></a>
<a name="line-284"></a><a name="splitForAllCo_maybe"></a><span class='hs-definition'>splitForAllCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-285"></a><span class='hs-definition'>splitForAllCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>k_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>k_co</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-286"></a><span class='hs-definition'>splitForAllCo_maybe</span> <span class='hs-keyword'>_</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-287"></a>
<a name="line-288"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-289"></a><span class='hs-comment'>-- and some coercion kind stuff</span>
<a name="line-290"></a>
<a name="line-291"></a><a name="coVarTypes"></a><span class='hs-definition'>coVarTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span>
<a name="line-292"></a><span class='hs-definition'>coVarTypes</span> <span class='hs-varid'>cv</span>
<a name="line-293"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coVarKindsTypesRole</span> <span class='hs-varid'>cv</span>
<a name="line-294"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-295"></a>
<a name="line-296"></a><a name="coVarKindsTypesRole"></a><span class='hs-definition'>coVarKindsTypesRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Kind</span><span class='hs-layout'>,</span><span class='hs-conid'>Kind</span><span class='hs-layout'>,</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span><span class='hs-conid'>Role</span><span class='hs-layout'>)</span>
<a name="line-297"></a><span class='hs-definition'>coVarKindsTypesRole</span> <span class='hs-varid'>cv</span>
<a name="line-298"></a> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k1</span><span class='hs-layout'>,</span><span class='hs-varid'>k2</span><span class='hs-layout'>,</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-299"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>role</span>
<a name="line-300"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqPrimTyConKey</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nominal</span>
<a name="line-301"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqReprPrimTyConKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Representational</span>
<a name="line-302"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"coVarKindsTypesRole"</span>
<a name="line-303"></a>   <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>k1</span><span class='hs-layout'>,</span><span class='hs-varid'>k2</span><span class='hs-layout'>,</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-layout'>,</span><span class='hs-varid'>role</span><span class='hs-layout'>)</span>
<a name="line-304"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"coVarKindsTypesRole, non coercion variable"</span>
<a name="line-305"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cv</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-306"></a>
<a name="line-307"></a><a name="coVarKind"></a><span class='hs-definition'>coVarKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-308"></a><span class='hs-definition'>coVarKind</span> <span class='hs-varid'>cv</span>
<a name="line-309"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>cv</span> <span class='hs-layout'>)</span>
<a name="line-310"></a>    <span class='hs-varid'>varType</span> <span class='hs-varid'>cv</span>
<a name="line-311"></a>
<a name="line-312"></a><a name="coVarRole"></a><span class='hs-definition'>coVarRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>
<a name="line-313"></a><span class='hs-definition'>coVarRole</span> <span class='hs-varid'>cv</span>
<a name="line-314"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqPrimTyConKey</span>
<a name="line-315"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nominal</span>
<a name="line-316"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqReprPrimTyConKey</span>
<a name="line-317"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Representational</span>
<a name="line-318"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-319"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"coVarRole: unknown tycon"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-320"></a>
<a name="line-321"></a>  <span class='hs-keyword'>where</span>
<a name="line-322"></a>    <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-323"></a>           <span class='hs-conid'>Just</span> <span class='hs-varid'>tc0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tc0</span>
<a name="line-324"></a>           <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"coVarRole: not tyconapp"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-325"></a>
<a name="line-326"></a><a name="mkCoercionType"></a><span class='hs-comment'>-- | Makes a coercion type from two types: the types whose equality</span>
<a name="line-327"></a><span class='hs-comment'>-- is proven by the relevant 'Coercion'</span>
<a name="line-328"></a><span class='hs-definition'>mkCoercionType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-329"></a><span class='hs-definition'>mkCoercionType</span> <span class='hs-conid'>Nominal</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPrimEqPred</span>
<a name="line-330"></a><span class='hs-definition'>mkCoercionType</span> <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReprPrimEqPred</span>
<a name="line-331"></a><span class='hs-definition'>mkCoercionType</span> <span class='hs-conid'>Phantom</span>          <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-332"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>ki1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty1</span>
<a name="line-333"></a>      <span class='hs-varid'>ki2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty2</span>
<a name="line-334"></a>  <span class='hs-keyword'>in</span>
<a name="line-335"></a>  <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>eqPhantPrimTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ki1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ki2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span>
<a name="line-336"></a>
<a name="line-337"></a><a name="mkHeteroCoercionType"></a><span class='hs-definition'>mkHeteroCoercionType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-338"></a><span class='hs-definition'>mkHeteroCoercionType</span> <span class='hs-conid'>Nominal</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHeteroPrimEqPred</span>
<a name="line-339"></a><span class='hs-definition'>mkHeteroCoercionType</span> <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHeteroReprPrimEqPred</span>
<a name="line-340"></a><span class='hs-definition'>mkHeteroCoercionType</span> <span class='hs-conid'>Phantom</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"mkHeteroCoercionType"</span>
<a name="line-341"></a>
<a name="line-342"></a><a name="mkRuntimeRepCo"></a><span class='hs-comment'>-- | Given a coercion @co1 :: (a :: TYPE r1) ~ (b :: TYPE r2)@,</span>
<a name="line-343"></a><span class='hs-comment'>-- produce a coercion @rep_co :: r1 ~ r2@.</span>
<a name="line-344"></a><span class='hs-definition'>mkRuntimeRepCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-345"></a><span class='hs-definition'>mkRuntimeRepCo</span> <span class='hs-varid'>co</span>
<a name="line-346"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-num'>0</span> <span class='hs-varid'>kind_co</span>
<a name="line-347"></a>  <span class='hs-keyword'>where</span>
<a name="line-348"></a>    <span class='hs-varid'>kind_co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co</span>  <span class='hs-comment'>-- kind_co :: TYPE r1 ~ TYPE r2</span>
<a name="line-349"></a>                           <span class='hs-comment'>-- (up to silliness with Constraint)</span>
<a name="line-350"></a>
<a name="line-351"></a><a name="isReflCoVar_maybe"></a><span class='hs-definition'>isReflCoVar_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-352"></a><span class='hs-comment'>-- If cv :: t~t then isReflCoVar_maybe cv = Just (Refl t)</span>
<a name="line-353"></a><span class='hs-definition'>isReflCoVar_maybe</span> <span class='hs-varid'>cv</span>
<a name="line-354"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coVarTypes</span> <span class='hs-varid'>cv</span>
<a name="line-355"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ty2</span>
<a name="line-356"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-layout'>(</span><span class='hs-varid'>coVarRole</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span>
<a name="line-357"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-358"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-359"></a>
<a name="line-360"></a><a name="isReflCo"></a><span class='hs-comment'>-- | Tests if this coercion is obviously reflexive. Guaranteed to work</span>
<a name="line-361"></a><span class='hs-comment'>-- very quickly. Sometimes a coercion can be reflexive, but not obviously</span>
<a name="line-362"></a><span class='hs-comment'>-- so. c.f. 'isReflexiveCo'</span>
<a name="line-363"></a><span class='hs-definition'>isReflCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-364"></a><span class='hs-definition'>isReflCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-365"></a><span class='hs-definition'>isReflCo</span> <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-366"></a>
<a name="line-367"></a><a name="isReflCo_maybe"></a><span class='hs-comment'>-- | Returns the type coerced if this coercion is reflexive. Guaranteed</span>
<a name="line-368"></a><span class='hs-comment'>-- to work very quickly. Sometimes a coercion can be reflexive, but not</span>
<a name="line-369"></a><span class='hs-comment'>-- obviously so. c.f. 'isReflexiveCo_maybe'</span>
<a name="line-370"></a><span class='hs-definition'>isReflCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Role</span><span class='hs-layout'>)</span>
<a name="line-371"></a><span class='hs-definition'>isReflCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-372"></a><span class='hs-definition'>isReflCo_maybe</span> <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-373"></a>
<a name="line-374"></a><a name="isReflexiveCo"></a><span class='hs-comment'>-- | Slowly checks if the coercion is reflexive. Don't call this in a loop,</span>
<a name="line-375"></a><span class='hs-comment'>-- as it walks over the entire coercion.</span>
<a name="line-376"></a><span class='hs-definition'>isReflexiveCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-377"></a><span class='hs-definition'>isReflexiveCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isJust</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isReflexiveCo_maybe</span>
<a name="line-378"></a>
<a name="line-379"></a><a name="isReflexiveCo_maybe"></a><span class='hs-comment'>-- | Extracts the coerced type from a reflexive coercion. This potentially</span>
<a name="line-380"></a><span class='hs-comment'>-- walks over the entire coercion, so avoid doing this in a loop.</span>
<a name="line-381"></a><span class='hs-definition'>isReflexiveCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Role</span><span class='hs-layout'>)</span>
<a name="line-382"></a><span class='hs-definition'>isReflexiveCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-383"></a><span class='hs-definition'>isReflexiveCo_maybe</span> <span class='hs-varid'>co</span>
<a name="line-384"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ty2</span>
<a name="line-385"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-386"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-387"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-388"></a>  <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKindRole</span> <span class='hs-varid'>co</span>
<a name="line-389"></a>
<a name="line-390"></a><span class='hs-comment'>{-
<a name="line-391"></a>%************************************************************************
<a name="line-392"></a>%*                                                                      *
<a name="line-393"></a>            Building coercions
<a name="line-394"></a>%*                                                                      *
<a name="line-395"></a>%************************************************************************
<a name="line-396"></a>
<a name="line-397"></a>These "smart constructors" maintain the invariants listed in the definition
<a name="line-398"></a>of Coercion, and they perform very basic optimizations.
<a name="line-399"></a>
<a name="line-400"></a>Note [Role twiddling functions]
<a name="line-401"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-402"></a>
<a name="line-403"></a>There are a plethora of functions for twiddling roles:
<a name="line-404"></a>
<a name="line-405"></a>mkSubCo: Requires a nominal input coercion and always produces a
<a name="line-406"></a>representational output. This is used when you (the programmer) are sure you
<a name="line-407"></a>know exactly that role you have and what you want.
<a name="line-408"></a>
<a name="line-409"></a>downgradeRole_maybe: This function takes both the input role and the output role
<a name="line-410"></a>as parameters. (The *output* role comes first!) It can only *downgrade* a
<a name="line-411"></a>role -- that is, change it from N to R or P, or from R to P. This one-way
<a name="line-412"></a>behavior is why there is the "_maybe". If an upgrade is requested, this
<a name="line-413"></a>function produces Nothing. This is used when you need to change the role of a
<a name="line-414"></a>coercion, but you're not sure (as you're writing the code) of which roles are
<a name="line-415"></a>involved.
<a name="line-416"></a>
<a name="line-417"></a>This function could have been written using coercionRole to ascertain the role
<a name="line-418"></a>of the input. But, that function is recursive, and the caller of downgradeRole_maybe
<a name="line-419"></a>often knows the input role. So, this is more efficient.
<a name="line-420"></a>
<a name="line-421"></a>downgradeRole: This is just like downgradeRole_maybe, but it panics if the
<a name="line-422"></a>conversion isn't a downgrade.
<a name="line-423"></a>
<a name="line-424"></a>setNominalRole_maybe: This is the only function that can *upgrade* a coercion.
<a name="line-425"></a>The result (if it exists) is always Nominal. The input can be at any role. It
<a name="line-426"></a>works on a "best effort" basis, as it should never be strictly necessary to
<a name="line-427"></a>upgrade a coercion during compilation. It is currently only used within GHC in
<a name="line-428"></a>splitAppCo_maybe. In order to be a proper inverse of mkAppCo, the second
<a name="line-429"></a>coercion that splitAppCo_maybe returns must be nominal. But, it's conceivable
<a name="line-430"></a>that splitAppCo_maybe is operating over a TyConAppCo that uses a
<a name="line-431"></a>representational coercion. Hence the need for setNominalRole_maybe.
<a name="line-432"></a>splitAppCo_maybe, in turn, is used only within coercion optimization -- thus,
<a name="line-433"></a>it is not absolutely critical that setNominalRole_maybe be complete.
<a name="line-434"></a>
<a name="line-435"></a>Note that setNominalRole_maybe will never upgrade a phantom UnivCo. Phantom
<a name="line-436"></a>UnivCos are perfectly type-safe, whereas representational and nominal ones are
<a name="line-437"></a>not. Indeed, `unsafeCoerce` is implemented via a representational UnivCo.
<a name="line-438"></a>(Nominal ones are no worse than representational ones, so this function *will*
<a name="line-439"></a>change a UnivCo Representational to a UnivCo Nominal.)
<a name="line-440"></a>
<a name="line-441"></a>Conal Elliott also came across a need for this function while working with the
<a name="line-442"></a>GHC API, as he was decomposing Core casts. The Core casts use representational
<a name="line-443"></a>coercions, as they must, but his use case required nominal coercions (he was
<a name="line-444"></a>building a GADT). So, that's why this function is exported from this module.
<a name="line-445"></a>
<a name="line-446"></a>One might ask: shouldn't downgradeRole_maybe just use setNominalRole_maybe as
<a name="line-447"></a>appropriate? I (Richard E.) have decided not to do this, because upgrading a
<a name="line-448"></a>role is bizarre and a caller should have to ask for this behavior explicitly.
<a name="line-449"></a>
<a name="line-450"></a>Note [mkTransAppCo]
<a name="line-451"></a>~~~~~~~~~~~~~~~~~~~
<a name="line-452"></a>Suppose we have
<a name="line-453"></a>
<a name="line-454"></a>  co1 :: a ~R Maybe
<a name="line-455"></a>  co2 :: b ~R Int
<a name="line-456"></a>
<a name="line-457"></a>and we want
<a name="line-458"></a>
<a name="line-459"></a>  co3 :: a b ~R Maybe Int
<a name="line-460"></a>
<a name="line-461"></a>This seems sensible enough. But, we can't let (co3 = co1 co2), because
<a name="line-462"></a>that's ill-roled! Note that mkAppCo requires a *nominal* second coercion.
<a name="line-463"></a>
<a name="line-464"></a>The way around this is to use transitivity:
<a name="line-465"></a>
<a name="line-466"></a>  co3 = (co1 &lt;b&gt;_N) ; (Maybe co2) :: a b ~R Maybe Int
<a name="line-467"></a>
<a name="line-468"></a>Or, it's possible everything is the other way around:
<a name="line-469"></a>
<a name="line-470"></a>  co1' :: Maybe ~R a
<a name="line-471"></a>  co2' :: Int   ~R b
<a name="line-472"></a>
<a name="line-473"></a>and we want
<a name="line-474"></a>
<a name="line-475"></a>  co3' :: Maybe Int ~R a b
<a name="line-476"></a>
<a name="line-477"></a>then
<a name="line-478"></a>
<a name="line-479"></a>  co3' = (Maybe co2') ; (co1' &lt;b&gt;_N)
<a name="line-480"></a>
<a name="line-481"></a>This is exactly what `mkTransAppCo` builds for us. Information for all
<a name="line-482"></a>the arguments tends to be to hand at call sites, so it's quicker than
<a name="line-483"></a>using, say, coercionKind.
<a name="line-484"></a>
<a name="line-485"></a>-}</span>
<a name="line-486"></a>
<a name="line-487"></a><a name="mkReflCo"></a><span class='hs-definition'>mkReflCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-488"></a><span class='hs-definition'>mkReflCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span>
<a name="line-489"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span>
<a name="line-490"></a>
<a name="line-491"></a><a name="mkRepReflCo"></a><span class='hs-comment'>-- | Make a representational reflexive coercion</span>
<a name="line-492"></a><span class='hs-definition'>mkRepReflCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-493"></a><span class='hs-definition'>mkRepReflCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-conid'>Representational</span>
<a name="line-494"></a>
<a name="line-495"></a><a name="mkNomReflCo"></a><span class='hs-comment'>-- | Make a nominal reflexive coercion</span>
<a name="line-496"></a><span class='hs-definition'>mkNomReflCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-497"></a><span class='hs-definition'>mkNomReflCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-conid'>Nominal</span>
<a name="line-498"></a>
<a name="line-499"></a><a name="mkTyConAppCo"></a><span class='hs-comment'>-- | Apply a type constructor to a list of coercions. It is the</span>
<a name="line-500"></a><span class='hs-comment'>-- caller's responsibility to get the roles correct on argument coercions.</span>
<a name="line-501"></a><span class='hs-definition'>mkTyConAppCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-502"></a><span class='hs-definition'>mkTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>
<a name="line-503"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>funTyConKey</span>
<a name="line-504"></a>  <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-sel'>_rep1</span><span class='hs-layout'>,</span> <span class='hs-sel'>_rep2</span><span class='hs-layout'>,</span> <span class='hs-varid'>co1</span><span class='hs-layout'>,</span> <span class='hs-varid'>co2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cos</span>   <span class='hs-comment'>-- See Note [Function coercions]</span>
<a name="line-505"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- (a :: TYPE ra) -&gt; (b :: TYPE rb)  ~  (c :: TYPE rc) -&gt; (d :: TYPE rd)</span>
<a name="line-506"></a>    <span class='hs-comment'>-- rep1 :: ra  ~  rc        rep2 :: rb  ~  rd</span>
<a name="line-507"></a>    <span class='hs-comment'>-- co1  :: a   ~  c         co2  :: b   ~  d</span>
<a name="line-508"></a>    <span class='hs-varid'>mkFunCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-509"></a>
<a name="line-510"></a>               <span class='hs-comment'>-- Expand type synonyms</span>
<a name="line-511"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv_co_prs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>leftover_cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>expandSynTyCon_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>
<a name="line-512"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppCos</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftCoSubst</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLiftingContext</span> <span class='hs-varid'>tv_co_prs</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>leftover_cos</span>
<a name="line-513"></a>
<a name="line-514"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tys_roles</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>traverse</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>cos</span>
<a name="line-515"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>tys_roles</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- See Note [Refl invariant]</span>
<a name="line-516"></a>
<a name="line-517"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>
<a name="line-518"></a>
<a name="line-519"></a><a name="mkFunCo"></a><span class='hs-comment'>-- | Build a function 'Coercion' from two other 'Coercion's. That is,</span>
<a name="line-520"></a><span class='hs-comment'>-- given @co1 :: a ~ b@ and @co2 :: x ~ y@ produce @co :: (a -&gt; x) ~ (b -&gt; y)@.</span>
<a name="line-521"></a><span class='hs-definition'>mkFunCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-522"></a><span class='hs-definition'>mkFunCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-523"></a>    <span class='hs-comment'>-- See Note [Refl invariant]</span>
<a name="line-524"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>co1</span>
<a name="line-525"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>co2</span>
<a name="line-526"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-527"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-528"></a>
<a name="line-529"></a><a name="mkFunCos"></a><span class='hs-comment'>-- | Make nested function 'Coercion's</span>
<a name="line-530"></a><span class='hs-definition'>mkFunCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-531"></a><span class='hs-definition'>mkFunCos</span> <span class='hs-varid'>r</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>res_co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunCo</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_co</span> <span class='hs-varid'>cos</span>
<a name="line-532"></a>
<a name="line-533"></a><a name="mkAppCo"></a><span class='hs-comment'>-- | Apply a 'Coercion' to another 'Coercion'.</span>
<a name="line-534"></a><span class='hs-comment'>-- The second coercion must be Nominal, unless the first is Phantom.</span>
<a name="line-535"></a><span class='hs-comment'>-- If the first is Phantom, then the second can be either Phantom or Nominal.</span>
<a name="line-536"></a><span class='hs-definition'>mkAppCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span>     <span class='hs-comment'>-- ^ :: t1 ~r t2</span>
<a name="line-537"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>     <span class='hs-comment'>-- ^ :: s1 ~N s2, where s1 :: k1, s2 :: k2</span>
<a name="line-538"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>     <span class='hs-comment'>-- ^ :: t1 s1 ~r t2 s2</span>
<a name="line-539"></a><span class='hs-definition'>mkAppCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg</span>
<a name="line-540"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>arg</span>
<a name="line-541"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-542"></a>
<a name="line-543"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty1</span>
<a name="line-544"></a>    <span class='hs-comment'>-- Expand type synonyms; a TyConAppCo can't have a type synonym (Trac #9102)</span>
<a name="line-545"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip_roles</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-546"></a>  <span class='hs-keyword'>where</span>
<a name="line-547"></a>    <span class='hs-varid'>zip_roles</span> <span class='hs-layout'>(</span><span class='hs-varid'>r1</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-conid'>[]</span>            <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>downgradeRole</span> <span class='hs-varid'>r1</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span>
<a name="line-548"></a>    <span class='hs-varid'>zip_roles</span> <span class='hs-layout'>(</span><span class='hs-varid'>r1</span><span class='hs-conop'>:</span><span class='hs-varid'>rs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>ty1</span> <span class='hs-conop'>:</span> <span class='hs-varid'>zip_roles</span> <span class='hs-varid'>rs</span> <span class='hs-varid'>tys</span>
<a name="line-549"></a>    <span class='hs-varid'>zip_roles</span> <span class='hs-keyword'>_</span>       <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"zip_roles"</span> <span class='hs-comment'>-- but the roles are infinite...</span>
<a name="line-550"></a>
<a name="line-551"></a><span class='hs-definition'>mkAppCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg</span>
<a name="line-552"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>of</span>
<a name="line-553"></a>      <span class='hs-conid'>Nominal</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>args</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-554"></a>      <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>args</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-555"></a>        <span class='hs-keyword'>where</span> <span class='hs-varid'>new_role</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesRepresentational</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>!!</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-556"></a>              <span class='hs-varid'>arg'</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>downgradeRole</span> <span class='hs-varid'>new_role</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>arg</span>
<a name="line-557"></a>      <span class='hs-conid'>Phantom</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-conid'>Phantom</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>args</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>toPhantomCo</span> <span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-558"></a><span class='hs-definition'>mkAppCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AppCo</span> <span class='hs-varid'>co</span>  <span class='hs-varid'>arg</span>
<a name="line-559"></a><span class='hs-comment'>-- Note, mkAppCo is careful to maintain invariants regarding</span>
<a name="line-560"></a><span class='hs-comment'>-- where Refl constructors appear; see the comments in the definition</span>
<a name="line-561"></a><span class='hs-comment'>-- of Coercion and the Note [Refl invariant] in TyCoRep.</span>
<a name="line-562"></a>
<a name="line-563"></a><a name="mkAppCos"></a><span class='hs-comment'>-- | Applies multiple 'Coercion's to another 'Coercion', from left to right.</span>
<a name="line-564"></a><span class='hs-comment'>-- See also 'mkAppCo'.</span>
<a name="line-565"></a><span class='hs-definition'>mkAppCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span>
<a name="line-566"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-567"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-568"></a><span class='hs-definition'>mkAppCos</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>mkAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>cos</span>
<a name="line-569"></a>
<a name="line-570"></a><a name="mkTransAppCo"></a><span class='hs-comment'>-- | Like `mkAppCo`, but allows the second coercion to be other than</span>
<a name="line-571"></a><span class='hs-comment'>-- nominal. See Note [mkTransAppCo]. Role r3 cannot be more stringent</span>
<a name="line-572"></a><span class='hs-comment'>-- than either r1 or r2.</span>
<a name="line-573"></a><span class='hs-definition'>mkTransAppCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span>         <span class='hs-comment'>-- ^ r1</span>
<a name="line-574"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>     <span class='hs-comment'>-- ^ co1 :: ty1a ~r1 ty1b</span>
<a name="line-575"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>         <span class='hs-comment'>-- ^ ty1a</span>
<a name="line-576"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>         <span class='hs-comment'>-- ^ ty1b</span>
<a name="line-577"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>         <span class='hs-comment'>-- ^ r2</span>
<a name="line-578"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>     <span class='hs-comment'>-- ^ co2 :: ty2a ~r2 ty2b</span>
<a name="line-579"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>         <span class='hs-comment'>-- ^ ty2a</span>
<a name="line-580"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>         <span class='hs-comment'>-- ^ ty2b</span>
<a name="line-581"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>         <span class='hs-comment'>-- ^ r3</span>
<a name="line-582"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>     <span class='hs-comment'>-- ^ :: ty1a ty2a ~r3 ty1b ty2b</span>
<a name="line-583"></a><span class='hs-definition'>mkTransAppCo</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>ty1a</span> <span class='hs-varid'>ty1b</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>co2</span> <span class='hs-varid'>ty2a</span> <span class='hs-varid'>ty2b</span> <span class='hs-varid'>r3</span>
<a name="line-584"></a><span class='hs-comment'>-- How incredibly fiddly! Is there a better way??</span>
<a name="line-585"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>r1</span><span class='hs-layout'>,</span> <span class='hs-varid'>r2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r3</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-586"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span>                <span class='hs-keyword'>_</span><span class='hs-layout'>,</span>                <span class='hs-conid'>Phantom</span><span class='hs-layout'>)</span>
<a name="line-587"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkPhantomCo</span> <span class='hs-varid'>kind_co</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>ty1a</span> <span class='hs-varid'>ty2a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>ty1b</span> <span class='hs-varid'>ty2b</span><span class='hs-layout'>)</span>
<a name="line-588"></a>        <span class='hs-keyword'>where</span> <span class='hs-comment'>-- ty1a :: k1a -&gt; k2a</span>
<a name="line-589"></a>              <span class='hs-comment'>-- ty1b :: k1b -&gt; k2b</span>
<a name="line-590"></a>              <span class='hs-comment'>-- ty2a :: k1a</span>
<a name="line-591"></a>              <span class='hs-comment'>-- ty2b :: k1b</span>
<a name="line-592"></a>              <span class='hs-comment'>-- ty1a ty2a :: k2a</span>
<a name="line-593"></a>              <span class='hs-comment'>-- ty1b ty2b :: k2b</span>
<a name="line-594"></a>              <span class='hs-varid'>kind_co1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co1</span>        <span class='hs-comment'>-- :: k1a -&gt; k2a ~N k1b -&gt; k2b</span>
<a name="line-595"></a>              <span class='hs-varid'>kind_co</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-num'>1</span> <span class='hs-varid'>kind_co1</span>  <span class='hs-comment'>-- :: k2a ~N k2b</span>
<a name="line-596"></a>
<a name="line-597"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span>                <span class='hs-keyword'>_</span><span class='hs-layout'>,</span>                <span class='hs-conid'>Nominal</span><span class='hs-layout'>)</span>
<a name="line-598"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>r2</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>)</span>
<a name="line-599"></a>           <span class='hs-varid'>mkAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-600"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>Nominal</span><span class='hs-layout'>,</span>          <span class='hs-conid'>Nominal</span><span class='hs-layout'>,</span>          <span class='hs-conid'>Representational</span><span class='hs-layout'>)</span>
<a name="line-601"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkSubCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-602"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span>                <span class='hs-conid'>Nominal</span><span class='hs-layout'>,</span>          <span class='hs-conid'>Representational</span><span class='hs-layout'>)</span>
<a name="line-603"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Representational</span> <span class='hs-layout'>)</span>
<a name="line-604"></a>           <span class='hs-varid'>mkAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-605"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>Nominal</span><span class='hs-layout'>,</span>          <span class='hs-conid'>Representational</span><span class='hs-layout'>,</span> <span class='hs-conid'>Representational</span><span class='hs-layout'>)</span>
<a name="line-606"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSubCo</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span>
<a name="line-607"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>_</span>               <span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span>                <span class='hs-conid'>Representational</span><span class='hs-layout'>)</span>
<a name="line-608"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Representational</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>r2</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Representational</span> <span class='hs-layout'>)</span>
<a name="line-609"></a>           <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span>
<a name="line-610"></a>  <span class='hs-keyword'>where</span>
<a name="line-611"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>co1_repr</span>
<a name="line-612"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc1b</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys1b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty1b</span>
<a name="line-613"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>nextRole</span> <span class='hs-varid'>ty1b</span> <span class='hs-varop'>==</span> <span class='hs-varid'>r2</span>
<a name="line-614"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppCo</span> <span class='hs-varid'>co1_repr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>ty2a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>`mkTransCo`</span>
<a name="line-615"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConAppCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc1b</span>
<a name="line-616"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesRepresentational</span> <span class='hs-varid'>tc1b</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys1b</span>
<a name="line-617"></a>            <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>co2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-618"></a>
<a name="line-619"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc1a</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys1a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty1a</span>
<a name="line-620"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>nextRole</span> <span class='hs-varid'>ty1a</span> <span class='hs-varop'>==</span> <span class='hs-varid'>r2</span>
<a name="line-621"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConAppCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc1a</span>
<a name="line-622"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesRepresentational</span> <span class='hs-varid'>tc1a</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys1a</span>
<a name="line-623"></a>            <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>co2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-624"></a>        <span class='hs-varop'>`mkTransCo`</span>
<a name="line-625"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>mkAppCo</span> <span class='hs-varid'>co1_repr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>ty2b</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-626"></a>
<a name="line-627"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-628"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"mkTransAppCo"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>r1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1a</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1b</span>
<a name="line-629"></a>                                      <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>r2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2a</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2b</span>
<a name="line-630"></a>                                      <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>r3</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-631"></a>
<a name="line-632"></a><a name="mkForAllCo"></a><span class='hs-comment'>-- | Make a Coercion from a tyvar, a kind coercion, and a body coercion.</span>
<a name="line-633"></a><span class='hs-comment'>-- The kind of the tyvar should be the left-hand kind of the kind coercion.</span>
<a name="line-634"></a><span class='hs-definition'>mkForAllCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-635"></a><span class='hs-definition'>mkForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span>
<a name="line-636"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>co</span>
<a name="line-637"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Refl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kind_co</span>
<a name="line-638"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInvForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-639"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-640"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span>
<a name="line-641"></a>
<a name="line-642"></a><a name="mkForAllCos"></a><span class='hs-comment'>-- | Make nested ForAllCos</span>
<a name="line-643"></a><span class='hs-definition'>mkForAllCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-644"></a><span class='hs-definition'>mkForAllCos</span> <span class='hs-varid'>bndrs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-645"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>refls_rev'd</span><span class='hs-layout'>,</span> <span class='hs-varid'>non_refls_rev'd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>span</span> <span class='hs-layout'>(</span><span class='hs-varid'>isReflCo</span> <span class='hs-varop'>.</span> <span class='hs-varid'>snd</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span> <span class='hs-keyword'>in</span>
<a name="line-646"></a>    <span class='hs-varid'>foldl</span> <span class='hs-layout'>(</span><span class='hs-varid'>flip</span> <span class='hs-varop'>$</span> <span class='hs-varid'>uncurry</span> <span class='hs-conid'>ForAllCo</span><span class='hs-layout'>)</span>
<a name="line-647"></a>          <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkInvForAllTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>refls_rev'd</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-648"></a>          <span class='hs-varid'>non_refls_rev'd</span>
<a name="line-649"></a><span class='hs-definition'>mkForAllCos</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-conid'>ForAllCo</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span> <span class='hs-varid'>bndrs</span>
<a name="line-650"></a>
<a name="line-651"></a><a name="mkHomoForAllCos"></a><span class='hs-comment'>-- | Make a Coercion quantified over a type variable;</span>
<a name="line-652"></a><span class='hs-comment'>-- the variable has the same type in both sides of the coercion</span>
<a name="line-653"></a><span class='hs-definition'>mkHomoForAllCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-654"></a><span class='hs-definition'>mkHomoForAllCos</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-655"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInvForAllTys</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-656"></a><span class='hs-definition'>mkHomoForAllCos</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHomoForAllCos_NoRefl</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>ty</span>
<a name="line-657"></a>
<a name="line-658"></a><a name="mkHomoForAllCos_NoRefl"></a><span class='hs-comment'>-- | Like 'mkHomoForAllCos', but doesn't check if the inner coercion</span>
<a name="line-659"></a><span class='hs-comment'>-- is reflexive.</span>
<a name="line-660"></a><span class='hs-definition'>mkHomoForAllCos_NoRefl</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-661"></a><span class='hs-definition'>mkHomoForAllCos_NoRefl</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>orig_co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>go</span> <span class='hs-varid'>orig_co</span> <span class='hs-varid'>tvs</span>
<a name="line-662"></a>  <span class='hs-keyword'>where</span>
<a name="line-663"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNomReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-664"></a>
<a name="line-665"></a><a name="mkCoVarCo"></a><span class='hs-definition'>mkCoVarCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-666"></a><span class='hs-comment'>-- cv :: s ~# t</span>
<a name="line-667"></a><span class='hs-comment'>-- See Note [mkCoVarCo]</span>
<a name="line-668"></a><span class='hs-definition'>mkCoVarCo</span> <span class='hs-varid'>cv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span>
<a name="line-669"></a>
<a name="line-670"></a><a name="mkCoVarCos"></a><span class='hs-definition'>mkCoVarCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-671"></a><span class='hs-definition'>mkCoVarCos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>mkCoVarCo</span>
<a name="line-672"></a>
<a name="line-673"></a><span class='hs-comment'>{- Note [mkCoVarCo]
<a name="line-674"></a>~~~~~~~~~~~~~~~~~~~
<a name="line-675"></a>In the past, mkCoVarCo optimised (c :: t~t) to (Refl t).  That is
<a name="line-676"></a>valid (although see Note [Unbound RULE binders] in Rules), but
<a name="line-677"></a>it's a relatively expensive test and perhaps better done in
<a name="line-678"></a>optCoercion.  Not a big deal either way.
<a name="line-679"></a>-}</span>
<a name="line-680"></a>
<a name="line-681"></a><a name="isCoVar_maybe"></a><span class='hs-comment'>-- | Extract a covar, if possible. This check is dirty. Be ashamed</span>
<a name="line-682"></a><span class='hs-comment'>-- of yourself. (It's dirty because it cares about the structure of</span>
<a name="line-683"></a><span class='hs-comment'>-- a coercion, which is morally reprehensible.)</span>
<a name="line-684"></a><span class='hs-definition'>isCoVar_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CoVar</span>
<a name="line-685"></a><span class='hs-definition'>isCoVar_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cv</span>
<a name="line-686"></a><span class='hs-definition'>isCoVar_maybe</span> <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-687"></a>
<a name="line-688"></a><a name="mkAxInstCo"></a><span class='hs-definition'>mkAxInstCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchIndex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-689"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-690"></a><span class='hs-comment'>-- mkAxInstCo can legitimately be called over-staturated;</span>
<a name="line-691"></a><span class='hs-comment'>-- i.e. with more type arguments than the coercion requires</span>
<a name="line-692"></a><span class='hs-definition'>mkAxInstCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cos</span>
<a name="line-693"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>==</span> <span class='hs-varid'>n_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>downgradeRole</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax_role</span> <span class='hs-varop'>$</span>
<a name="line-694"></a>                     <span class='hs-varid'>mkAxiomInstCo</span> <span class='hs-varid'>ax_br</span> <span class='hs-varid'>index</span> <span class='hs-layout'>(</span><span class='hs-varid'>rtys</span> <span class='hs-varop'>`chkAppend`</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-695"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>n_tys</span> <span class='hs-layout'>)</span>
<a name="line-696"></a>                     <span class='hs-varid'>downgradeRole</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax_role</span> <span class='hs-varop'>$</span>
<a name="line-697"></a>                     <span class='hs-varid'>mkAppCos</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAxiomInstCo</span> <span class='hs-varid'>ax_br</span> <span class='hs-varid'>index</span>
<a name="line-698"></a>                                             <span class='hs-layout'>(</span><span class='hs-varid'>ax_args</span> <span class='hs-varop'>`chkAppend`</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-699"></a>                              <span class='hs-varid'>leftover_args</span>
<a name="line-700"></a>  <span class='hs-keyword'>where</span>
<a name="line-701"></a>    <span class='hs-varid'>n_tys</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span>
<a name="line-702"></a>    <span class='hs-varid'>ax_br</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toBranchedAxiom</span> <span class='hs-varid'>ax</span>
<a name="line-703"></a>    <span class='hs-varid'>branch</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax_br</span> <span class='hs-varid'>index</span>
<a name="line-704"></a>    <span class='hs-varid'>tvs</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchTyVars</span> <span class='hs-varid'>branch</span>
<a name="line-705"></a>    <span class='hs-varid'>arity</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span>
<a name="line-706"></a>    <span class='hs-varid'>arg_roles</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchRoles</span> <span class='hs-varid'>branch</span>
<a name="line-707"></a>    <span class='hs-varid'>rtys</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_roles</span> <span class='hs-varop'>++</span> <span class='hs-varid'>repeat</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-708"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>ax_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>leftover_args</span><span class='hs-layout'>)</span>
<a name="line-709"></a>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAt</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>rtys</span>
<a name="line-710"></a>    <span class='hs-varid'>ax_role</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomRole</span> <span class='hs-varid'>ax</span>
<a name="line-711"></a>
<a name="line-712"></a><a name="mkAxiomInstCo"></a><span class='hs-comment'>-- worker function; just checks to see if it should produce Refl</span>
<a name="line-713"></a><span class='hs-definition'>mkAxiomInstCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Branched</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchIndex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-714"></a><span class='hs-definition'>mkAxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span> <span class='hs-varid'>args</span>
<a name="line-715"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>args</span> <span class='hs-varop'>`lengthIs`</span> <span class='hs-varid'>coAxiomArity</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span> <span class='hs-layout'>)</span>
<a name="line-716"></a>    <span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span> <span class='hs-varid'>args</span>
<a name="line-717"></a>
<a name="line-718"></a><a name="mkUnbranchedAxInstCo"></a><span class='hs-comment'>-- to be used only with unbranched axioms</span>
<a name="line-719"></a><span class='hs-definition'>mkUnbranchedAxInstCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Unbranched</span>
<a name="line-720"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-721"></a><span class='hs-definition'>mkUnbranchedAxInstCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cos</span>
<a name="line-722"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAxInstCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax</span> <span class='hs-num'>0</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cos</span>
<a name="line-723"></a>
<a name="line-724"></a><a name="mkAxInstRHS"></a><span class='hs-definition'>mkAxInstRHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchIndex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-725"></a><span class='hs-comment'>-- Instantiate the axiom with specified types,</span>
<a name="line-726"></a><span class='hs-comment'>-- returning the instantiated RHS</span>
<a name="line-727"></a><span class='hs-comment'>-- A companion to mkAxInstCo:</span>
<a name="line-728"></a><span class='hs-comment'>--    mkAxInstRhs ax index tys = snd (coercionKind (mkAxInstCo ax index tys))</span>
<a name="line-729"></a><span class='hs-definition'>mkAxInstRHS</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cos</span>
<a name="line-730"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>tys1</span> <span class='hs-layout'>)</span>
<a name="line-731"></a>    <span class='hs-varid'>mkAppTys</span> <span class='hs-varid'>rhs'</span> <span class='hs-varid'>tys2</span>
<a name="line-732"></a>  <span class='hs-keyword'>where</span>
<a name="line-733"></a>    <span class='hs-varid'>branch</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span>
<a name="line-734"></a>    <span class='hs-varid'>tvs</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchTyVars</span> <span class='hs-varid'>branch</span>
<a name="line-735"></a>    <span class='hs-varid'>cvs</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchCoVars</span> <span class='hs-varid'>branch</span>
<a name="line-736"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tys1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAtList</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-737"></a>    <span class='hs-varid'>rhs'</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys1</span> <span class='hs-varop'>$</span>
<a name="line-738"></a>                   <span class='hs-varid'>substTyWithCoVars</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span> <span class='hs-varop'>$</span>
<a name="line-739"></a>                   <span class='hs-varid'>coAxBranchRHS</span> <span class='hs-varid'>branch</span>
<a name="line-740"></a>
<a name="line-741"></a><a name="mkUnbranchedAxInstRHS"></a><span class='hs-definition'>mkUnbranchedAxInstRHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Unbranched</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-742"></a><span class='hs-definition'>mkUnbranchedAxInstRHS</span> <span class='hs-varid'>ax</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAxInstRHS</span> <span class='hs-varid'>ax</span> <span class='hs-num'>0</span>
<a name="line-743"></a>
<a name="line-744"></a><a name="mkAxInstLHS"></a><span class='hs-comment'>-- | Return the left-hand type of the axiom, when the axiom is instantiated</span>
<a name="line-745"></a><span class='hs-comment'>-- at the types given.</span>
<a name="line-746"></a><span class='hs-definition'>mkAxInstLHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchIndex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-747"></a><span class='hs-definition'>mkAxInstLHS</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cos</span>
<a name="line-748"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>tys1</span> <span class='hs-layout'>)</span>
<a name="line-749"></a>    <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>fam_tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>lhs_tys</span> <span class='hs-varop'>`chkAppend`</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span>
<a name="line-750"></a>  <span class='hs-keyword'>where</span>
<a name="line-751"></a>    <span class='hs-varid'>branch</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span>
<a name="line-752"></a>    <span class='hs-varid'>tvs</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchTyVars</span> <span class='hs-varid'>branch</span>
<a name="line-753"></a>    <span class='hs-varid'>cvs</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchCoVars</span> <span class='hs-varid'>branch</span>
<a name="line-754"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tys1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAtList</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-755"></a>    <span class='hs-varid'>lhs_tys</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTysWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys1</span> <span class='hs-varop'>$</span>
<a name="line-756"></a>                   <span class='hs-varid'>substTysWithCoVars</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span> <span class='hs-varop'>$</span>
<a name="line-757"></a>                   <span class='hs-varid'>coAxBranchLHS</span> <span class='hs-varid'>branch</span>
<a name="line-758"></a>    <span class='hs-varid'>fam_tc</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomTyCon</span> <span class='hs-varid'>ax</span>
<a name="line-759"></a>
<a name="line-760"></a><a name="mkUnbranchedAxInstLHS"></a><span class='hs-comment'>-- | Instantiate the left-hand side of an unbranched axiom</span>
<a name="line-761"></a><span class='hs-definition'>mkUnbranchedAxInstLHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Unbranched</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-762"></a><span class='hs-definition'>mkUnbranchedAxInstLHS</span> <span class='hs-varid'>ax</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAxInstLHS</span> <span class='hs-varid'>ax</span> <span class='hs-num'>0</span>
<a name="line-763"></a>
<a name="line-764"></a><a name="mkUnsafeCo"></a><span class='hs-comment'>-- | Manufacture an unsafe coercion from thin air.</span>
<a name="line-765"></a><span class='hs-comment'>--   Currently (May 14) this is used only to implement the</span>
<a name="line-766"></a><span class='hs-comment'>--   @unsafeCoerce#@ primitive.  Optimise by pushing</span>
<a name="line-767"></a><span class='hs-comment'>--   down through type constructors.</span>
<a name="line-768"></a><span class='hs-definition'>mkUnsafeCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-769"></a><span class='hs-definition'>mkUnsafeCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-770"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnivCo</span> <span class='hs-conid'>UnsafeCoerceProv</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-771"></a>
<a name="line-772"></a><a name="mkHoleCo"></a><span class='hs-comment'>-- | Make a coercion from a coercion hole</span>
<a name="line-773"></a><span class='hs-definition'>mkHoleCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoercionHole</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>
<a name="line-774"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-775"></a><span class='hs-definition'>mkHoleCo</span> <span class='hs-varid'>h</span> <span class='hs-varid'>r</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnivCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleProv</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-varid'>r</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-776"></a>
<a name="line-777"></a><a name="mkUnivCo"></a><span class='hs-comment'>-- | Make a universal coercion between two arbitrary types.</span>
<a name="line-778"></a><span class='hs-definition'>mkUnivCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnivCoProvenance</span>
<a name="line-779"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>       <span class='hs-comment'>-- ^ role of the built coercion, "r"</span>
<a name="line-780"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>       <span class='hs-comment'>-- ^ t1 :: k1</span>
<a name="line-781"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>       <span class='hs-comment'>-- ^ t2 :: k2</span>
<a name="line-782"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>   <span class='hs-comment'>-- ^ :: t1 ~r t2</span>
<a name="line-783"></a><span class='hs-definition'>mkUnivCo</span> <span class='hs-varid'>prov</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-784"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span>
<a name="line-785"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnivCo</span> <span class='hs-varid'>prov</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-786"></a>
<a name="line-787"></a><a name="mkSymCo"></a><span class='hs-comment'>-- | Create a symmetric version of the given 'Coercion' that asserts</span>
<a name="line-788"></a><span class='hs-comment'>--   equality between the same types but in the other "direction", so</span>
<a name="line-789"></a><span class='hs-comment'>--   a kind of @t1 ~ t2@ becomes the kind @t2 ~ t1@.</span>
<a name="line-790"></a><span class='hs-definition'>mkSymCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-791"></a>
<a name="line-792"></a><span class='hs-comment'>-- Do a few simple optimizations, but don't bother pushing occurrences</span>
<a name="line-793"></a><span class='hs-comment'>-- of symmetry to the leaves; the optimizer will take care of that.</span>
<a name="line-794"></a><span class='hs-definition'>mkSymCo</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-795"></a><span class='hs-definition'>mkSymCo</span>    <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-796"></a><span class='hs-definition'>mkSymCo</span>    <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span>
<a name="line-797"></a><span class='hs-definition'>mkSymCo</span> <span class='hs-varid'>co</span>                        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span>
<a name="line-798"></a>
<a name="line-799"></a><a name="mkTransCo"></a><span class='hs-comment'>-- | Create a new 'Coercion' by composing the two given 'Coercion's transitively.</span>
<a name="line-800"></a><span class='hs-comment'>--   (co1 ; co2)</span>
<a name="line-801"></a><span class='hs-definition'>mkTransCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-802"></a><span class='hs-definition'>mkTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co1</span>
<a name="line-803"></a><span class='hs-definition'>mkTransCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co2</span>
<a name="line-804"></a><span class='hs-definition'>mkTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-805"></a>
<a name="line-806"></a><a name="mkNthCoRole"></a><span class='hs-comment'>-- the Role is the desired one. It is the caller's responsibility to make</span>
<a name="line-807"></a><span class='hs-comment'>-- sure this request is reasonable</span>
<a name="line-808"></a><span class='hs-definition'>mkNthCoRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-809"></a><span class='hs-definition'>mkNthCoRole</span> <span class='hs-varid'>role</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span>
<a name="line-810"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>downgradeRole</span> <span class='hs-varid'>role</span> <span class='hs-varid'>nth_role</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nth_co</span>
<a name="line-811"></a>  <span class='hs-keyword'>where</span>
<a name="line-812"></a>    <span class='hs-varid'>nth_co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span>
<a name="line-813"></a>    <span class='hs-varid'>nth_role</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionRole</span> <span class='hs-varid'>nth_co</span>
<a name="line-814"></a>
<a name="line-815"></a><a name="mkNthCo"></a><span class='hs-definition'>mkNthCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-816"></a><span class='hs-definition'>mkNthCo</span> <span class='hs-num'>0</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-817"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-818"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-819"></a><span class='hs-definition'>mkNthCo</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-820"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>ok_tc_app</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>)</span>
<a name="line-821"></a>    <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r'</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConAppArgN</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-822"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppTyCon</span> <span class='hs-varid'>ty</span>
<a name="line-823"></a>        <span class='hs-varid'>r'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nthRole</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>n</span>
<a name="line-824"></a>
<a name="line-825"></a>        <span class='hs-varid'>ok_tc_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-826"></a>        <span class='hs-varid'>ok_tc_app</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>n</span>
<a name="line-827"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-828"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`lengthExceeds`</span> <span class='hs-varid'>n</span>
<a name="line-829"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isForAllTy</span> <span class='hs-varid'>ty</span>  <span class='hs-comment'>-- nth:0 pulls out a kind coercion from a hetero forall</span>
<a name="line-830"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>
<a name="line-831"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-832"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-833"></a>
<a name="line-834"></a><span class='hs-definition'>mkNthCo</span> <span class='hs-num'>0</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>kind_co</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kind_co</span>
<a name="line-835"></a>  <span class='hs-comment'>-- If co :: (forall a1:k1. t1) ~ (forall a2:k2. t2)</span>
<a name="line-836"></a>  <span class='hs-comment'>-- then (nth 0 co :: k1 ~ k2)</span>
<a name="line-837"></a>
<a name="line-838"></a><span class='hs-definition'>mkNthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-839"></a>  <span class='hs-comment'>-- See Note [Function coercions]</span>
<a name="line-840"></a>  <span class='hs-comment'>-- If FunCo _ arg_co res_co ::   (s1:TYPE sk1 -&gt; s2:TYPE sk2)</span>
<a name="line-841"></a>  <span class='hs-comment'>--                             ~ (t1:TYPE tk1 -&gt; t2:TYPE tk2)</span>
<a name="line-842"></a>  <span class='hs-comment'>-- Then we want to behave as if co was</span>
<a name="line-843"></a>  <span class='hs-comment'>--    TyConAppCo argk_co resk_co arg_co res_co</span>
<a name="line-844"></a>  <span class='hs-comment'>-- where</span>
<a name="line-845"></a>  <span class='hs-comment'>--    argk_co :: sk1 ~ tk1  =  mkNthCo 0 (mkKindCo arg_co)</span>
<a name="line-846"></a>  <span class='hs-comment'>--    resk_co :: sk2 ~ tk2  =  mkNthCo 0 (mkKindCo res_co)</span>
<a name="line-847"></a>  <span class='hs-comment'>--                             i.e. mkRuntimeRepCo</span>
<a name="line-848"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>of</span>
<a name="line-849"></a>      <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRuntimeRepCo</span> <span class='hs-varid'>arg</span>
<a name="line-850"></a>      <span class='hs-num'>1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRuntimeRepCo</span> <span class='hs-varid'>res</span>
<a name="line-851"></a>      <span class='hs-num'>2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>arg</span>
<a name="line-852"></a>      <span class='hs-num'>3</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>res</span>
<a name="line-853"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"mkNthCo(FunCo)"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-854"></a>
<a name="line-855"></a><span class='hs-definition'>mkNthCo</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>arg_cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_cos</span> <span class='hs-varop'>`getNth`</span> <span class='hs-varid'>n</span>
<a name="line-856"></a>
<a name="line-857"></a><span class='hs-definition'>mkNthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span>
<a name="line-858"></a>
<a name="line-859"></a><a name="mkLRCo"></a><span class='hs-definition'>mkLRCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LeftOrRight</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-860"></a><span class='hs-definition'>mkLRCo</span> <span class='hs-varid'>lr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>eq</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>eq</span> <span class='hs-layout'>(</span><span class='hs-varid'>pickLR</span> <span class='hs-varid'>lr</span> <span class='hs-layout'>(</span><span class='hs-varid'>splitAppTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-861"></a><span class='hs-definition'>mkLRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span>
<a name="line-862"></a>
<a name="line-863"></a><a name="mkInstCo"></a><span class='hs-comment'>-- | Instantiates a 'Coercion'.</span>
<a name="line-864"></a><span class='hs-definition'>mkInstCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-865"></a><span class='hs-definition'>mkInstCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-sel'>_kind_co</span> <span class='hs-varid'>body_co</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-866"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substCoWithUnchecked</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tv</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>body_co</span>
<a name="line-867"></a><span class='hs-definition'>mkInstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span>
<a name="line-868"></a>
<a name="line-869"></a><a name="mkCoherenceCo"></a><span class='hs-comment'>-- This could work harder to produce Refl coercions, but that would be</span>
<a name="line-870"></a><span class='hs-comment'>-- quite inefficient. Seems better not to try.</span>
<a name="line-871"></a><span class='hs-definition'>mkCoherenceCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-872"></a><span class='hs-definition'>mkCoherenceCo</span> <span class='hs-varid'>co1</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co1</span>
<a name="line-873"></a><span class='hs-definition'>mkCoherenceCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoherenceCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-varid'>co3</span>
<a name="line-874"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoherenceCo</span> <span class='hs-varid'>co1</span> <span class='hs-layout'>(</span><span class='hs-varid'>co2</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>co3</span><span class='hs-layout'>)</span>
<a name="line-875"></a><span class='hs-definition'>mkCoherenceCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoherenceCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-876"></a>
<a name="line-877"></a><a name="mkCoherenceRightCo"></a><span class='hs-comment'>-- | A CoherenceCo c1 c2 applies the coercion c2 to the left-hand type</span>
<a name="line-878"></a><span class='hs-comment'>-- in the kind of c1. This function uses sym to get the coercion on the</span>
<a name="line-879"></a><span class='hs-comment'>-- right-hand type of c1. Thus, if c1 :: s ~ t, then mkCoherenceRightCo c1 c2</span>
<a name="line-880"></a><span class='hs-comment'>-- has the kind (s ~ (t |&gt; c2)) down through type constructors.</span>
<a name="line-881"></a><span class='hs-comment'>-- The second coercion must be representational.</span>
<a name="line-882"></a><span class='hs-definition'>mkCoherenceRightCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-883"></a><span class='hs-definition'>mkCoherenceRightCo</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoherenceCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>c1</span><span class='hs-layout'>)</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span>
<a name="line-884"></a>
<a name="line-885"></a><a name="mkCoherenceLeftCo"></a><span class='hs-comment'>-- | An explicitly directed synonym of mkCoherenceCo. The second</span>
<a name="line-886"></a><span class='hs-comment'>-- coercion must be representational.</span>
<a name="line-887"></a><span class='hs-definition'>mkCoherenceLeftCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-888"></a><span class='hs-definition'>mkCoherenceLeftCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoherenceCo</span>
<a name="line-889"></a>
<a name="line-890"></a><span class='hs-keyword'>infixl</span> <span class='hs-num'>5</span> <span class='hs-varop'>`mkCoherenceCo`</span>
<a name="line-891"></a><span class='hs-keyword'>infixl</span> <span class='hs-num'>5</span> <span class='hs-varop'>`mkCoherenceRightCo`</span>
<a name="line-892"></a><span class='hs-keyword'>infixl</span> <span class='hs-num'>5</span> <span class='hs-varop'>`mkCoherenceLeftCo`</span>
<a name="line-893"></a>
<a name="line-894"></a><a name="mkKindCo"></a><span class='hs-comment'>-- | Given @co :: (a :: k) ~ (b :: k')@ produce @co' :: k ~ k'@.</span>
<a name="line-895"></a><span class='hs-definition'>mkKindCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-896"></a><span class='hs-definition'>mkKindCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-897"></a><span class='hs-definition'>mkKindCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>h</span>
<a name="line-898"></a><span class='hs-definition'>mkKindCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>h</span>
<a name="line-899"></a><span class='hs-definition'>mkKindCo</span> <span class='hs-varid'>co</span>
<a name="line-900"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span>
<a name="line-901"></a>       <span class='hs-comment'>-- generally, calling coercionKind during coercion creation is a bad idea,</span>
<a name="line-902"></a>       <span class='hs-comment'>-- as it can lead to exponential behavior. But, we don't have nested mkKindCos,</span>
<a name="line-903"></a>       <span class='hs-comment'>-- so it's OK here.</span>
<a name="line-904"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tk1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty1</span>
<a name="line-905"></a>        <span class='hs-varid'>tk2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty2</span>
<a name="line-906"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tk1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>tk2</span>
<a name="line-907"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>tk1</span>
<a name="line-908"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-909"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span>
<a name="line-910"></a>
<a name="line-911"></a><a name="mkSubCo"></a><span class='hs-comment'>-- input coercion is Nominal; see also Note [Role twiddling functions]</span>
<a name="line-912"></a><span class='hs-definition'>mkSubCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-913"></a><span class='hs-definition'>mkSubCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>ty</span>
<a name="line-914"></a><span class='hs-definition'>mkSubCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-915"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>applyRoles</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-916"></a><span class='hs-definition'>mkSubCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-917"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunCo</span> <span class='hs-conid'>Representational</span>
<a name="line-918"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>downgradeRole</span> <span class='hs-conid'>Representational</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-919"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>downgradeRole</span> <span class='hs-conid'>Representational</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-920"></a><span class='hs-definition'>mkSubCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-921"></a>             <span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span>
<a name="line-922"></a>
<a name="line-923"></a><a name="downgradeRole_maybe"></a><span class='hs-comment'>-- | Changes a role, but only a downgrade. See Note [Role twiddling functions]</span>
<a name="line-924"></a><span class='hs-definition'>downgradeRole_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span>   <span class='hs-comment'>-- ^ desired role</span>
<a name="line-925"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>   <span class='hs-comment'>-- ^ current role</span>
<a name="line-926"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-927"></a><span class='hs-comment'>-- In (downgradeRole_maybe dr cr co) it's a precondition that</span>
<a name="line-928"></a><span class='hs-comment'>--                                   cr = coercionRole co</span>
<a name="line-929"></a><span class='hs-definition'>downgradeRole_maybe</span> <span class='hs-conid'>Representational</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-930"></a><span class='hs-definition'>downgradeRole_maybe</span> <span class='hs-conid'>Nominal</span> <span class='hs-conid'>Representational</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-931"></a><span class='hs-definition'>downgradeRole_maybe</span> <span class='hs-conid'>Phantom</span> <span class='hs-conid'>Phantom</span>          <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span>
<a name="line-932"></a><span class='hs-definition'>downgradeRole_maybe</span> <span class='hs-conid'>Phantom</span> <span class='hs-keyword'>_</span>                <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>toPhantomCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-933"></a><span class='hs-definition'>downgradeRole_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Phantom</span>                <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-934"></a><span class='hs-definition'>downgradeRole_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                      <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span>
<a name="line-935"></a>
<a name="line-936"></a><a name="downgradeRole"></a><span class='hs-comment'>-- | Like 'downgradeRole_maybe', but panics if the change isn't a downgrade.</span>
<a name="line-937"></a><span class='hs-comment'>-- See Note [Role twiddling functions]</span>
<a name="line-938"></a><span class='hs-definition'>downgradeRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span>  <span class='hs-comment'>-- desired role</span>
<a name="line-939"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>  <span class='hs-comment'>-- current role</span>
<a name="line-940"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-941"></a><span class='hs-definition'>downgradeRole</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>co</span>
<a name="line-942"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>downgradeRole_maybe</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>of</span>
<a name="line-943"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>co'</span>
<a name="line-944"></a>      <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"downgradeRole"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-945"></a>
<a name="line-946"></a><a name="maybeSubCo"></a><span class='hs-comment'>-- | If the EqRel is ReprEq, makes a SubCo; otherwise, does nothing.</span>
<a name="line-947"></a><span class='hs-comment'>-- Note that the input coercion should always be nominal.</span>
<a name="line-948"></a><span class='hs-definition'>maybeSubCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqRel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-949"></a><span class='hs-definition'>maybeSubCo</span> <span class='hs-conid'>NomEq</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span>
<a name="line-950"></a><span class='hs-definition'>maybeSubCo</span> <span class='hs-conid'>ReprEq</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSubCo</span>
<a name="line-951"></a>
<a name="line-952"></a>
<a name="line-953"></a><a name="mkAxiomRuleCo"></a><span class='hs-definition'>mkAxiomRuleCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiomRule</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-954"></a><span class='hs-definition'>mkAxiomRuleCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AxiomRuleCo</span>
<a name="line-955"></a>
<a name="line-956"></a><a name="mkProofIrrelCo"></a><span class='hs-comment'>-- | Make a "coercion between coercions".</span>
<a name="line-957"></a><span class='hs-definition'>mkProofIrrelCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span>       <span class='hs-comment'>-- ^ role of the created coercion, "r"</span>
<a name="line-958"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>   <span class='hs-comment'>-- ^ :: phi1 ~N phi2</span>
<a name="line-959"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>   <span class='hs-comment'>-- ^ g1 :: phi1</span>
<a name="line-960"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>   <span class='hs-comment'>-- ^ g2 :: phi2</span>
<a name="line-961"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>   <span class='hs-comment'>-- ^ :: g1 ~r g2</span>
<a name="line-962"></a>
<a name="line-963"></a><span class='hs-comment'>-- if the two coercion prove the same fact, I just don't care what</span>
<a name="line-964"></a><span class='hs-comment'>-- the individual coercions are.</span>
<a name="line-965"></a><span class='hs-definition'>mkProofIrrelCo</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>g</span>  <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>
<a name="line-966"></a><span class='hs-definition'>mkProofIrrelCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>kco</span>       <span class='hs-varid'>g1</span> <span class='hs-varid'>g2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnivCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>kco</span><span class='hs-layout'>)</span> <span class='hs-varid'>r</span>
<a name="line-967"></a>                                     <span class='hs-layout'>(</span><span class='hs-varid'>mkCoercionTy</span> <span class='hs-varid'>g1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoercionTy</span> <span class='hs-varid'>g2</span><span class='hs-layout'>)</span>
<a name="line-968"></a>
<a name="line-969"></a><span class='hs-comment'>{-
<a name="line-970"></a>%************************************************************************
<a name="line-971"></a>%*                                                                      *
<a name="line-972"></a>   Roles
<a name="line-973"></a>%*                                                                      *
<a name="line-974"></a>%************************************************************************
<a name="line-975"></a>-}</span>
<a name="line-976"></a>
<a name="line-977"></a><a name="setNominalRole_maybe"></a><span class='hs-comment'>-- | Converts a coercion to be nominal, if possible.</span>
<a name="line-978"></a><span class='hs-comment'>-- See Note [Role twiddling functions]</span>
<a name="line-979"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-980"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-varid'>co</span>
<a name="line-981"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Nominal</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span>
<a name="line-982"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span>
<a name="line-983"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Refl</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty</span>
<a name="line-984"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-985"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cos'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-varid'>cos</span>
<a name="line-986"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos'</span> <span class='hs-layout'>}</span>
<a name="line-987"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-988"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-varid'>co1</span>
<a name="line-989"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>co2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-varid'>co2</span>
<a name="line-990"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>FunCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>co1'</span> <span class='hs-varid'>co2'</span>
<a name="line-991"></a>       <span class='hs-layout'>}</span>
<a name="line-992"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-993"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SymCo</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-varid'>co</span>
<a name="line-994"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-995"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TransCo</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-varid'>co2</span>
<a name="line-996"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-997"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AppCo</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>co2</span>
<a name="line-998"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-999"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind_co</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-varid'>co</span>
<a name="line-1000"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1001"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NthCo</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-varid'>co</span>
<a name="line-1002"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-1003"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InstCo</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-varid'>co</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>arg</span>
<a name="line-1004"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoherenceCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1005"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoherenceCo</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>co2</span>
<a name="line-1006"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>prov</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1007"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>prov</span> <span class='hs-keyword'>of</span> <span class='hs-conid'>UnsafeCoerceProv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>   <span class='hs-comment'>-- it's always unsafe</span>
<a name="line-1008"></a>                 <span class='hs-conid'>PhantomProv</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>  <span class='hs-comment'>-- should always be phantom</span>
<a name="line-1009"></a>                 <span class='hs-conid'>ProofIrrelProv</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>   <span class='hs-comment'>-- it's always safe</span>
<a name="line-1010"></a>                 <span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>  <span class='hs-comment'>-- who knows? This choice is conservative.</span>
<a name="line-1011"></a>                 <span class='hs-conid'>HoleProv</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>  <span class='hs-comment'>-- no no no.</span>
<a name="line-1012"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-conid'>UnivCo</span> <span class='hs-varid'>prov</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-1013"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1014"></a>
<a name="line-1015"></a><a name="mkPhantomCo"></a><span class='hs-comment'>-- | Make a phantom coercion between two types. The coercion passed</span>
<a name="line-1016"></a><span class='hs-comment'>-- in must be a nominal coercion between the kinds of the</span>
<a name="line-1017"></a><span class='hs-comment'>-- types.</span>
<a name="line-1018"></a><span class='hs-definition'>mkPhantomCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1019"></a><span class='hs-definition'>mkPhantomCo</span> <span class='hs-varid'>h</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-1020"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnivCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-conid'>Phantom</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-1021"></a>
<a name="line-1022"></a><a name="mkHomoPhantomCo"></a><span class='hs-comment'>-- | Make a phantom coercion between two types of the same kind.</span>
<a name="line-1023"></a><span class='hs-definition'>mkHomoPhantomCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1024"></a><span class='hs-definition'>mkHomoPhantomCo</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-1025"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>k1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>t2</span> <span class='hs-layout'>)</span>
<a name="line-1026"></a>    <span class='hs-varid'>mkPhantomCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>k1</span><span class='hs-layout'>)</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-1027"></a>  <span class='hs-keyword'>where</span>
<a name="line-1028"></a>    <span class='hs-varid'>k1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>t1</span>
<a name="line-1029"></a>
<a name="line-1030"></a><a name="toPhantomCo"></a><span class='hs-comment'>-- takes any coercion and turns it into a Phantom coercion</span>
<a name="line-1031"></a><span class='hs-definition'>toPhantomCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1032"></a><span class='hs-definition'>toPhantomCo</span> <span class='hs-varid'>co</span>
<a name="line-1033"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPhantomCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1034"></a>  <span class='hs-keyword'>where</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span>
<a name="line-1035"></a>
<a name="line-1036"></a><a name="applyRoles"></a><span class='hs-comment'>-- Convert args to a TyConAppCo Nominal to the same TyConAppCo Representational</span>
<a name="line-1037"></a><span class='hs-definition'>applyRoles</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-1038"></a><span class='hs-definition'>applyRoles</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>
<a name="line-1039"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>r</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>downgradeRole</span> <span class='hs-varid'>r</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesRepresentational</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos</span>
<a name="line-1040"></a>
<a name="line-1041"></a><a name="tyConRolesX"></a><span class='hs-comment'>-- the Role parameter is the Role of the TyConAppCo</span>
<a name="line-1042"></a><span class='hs-comment'>-- defined here because this is intimiately concerned with the implementation</span>
<a name="line-1043"></a><span class='hs-comment'>-- of TyConAppCo</span>
<a name="line-1044"></a><span class='hs-definition'>tyConRolesX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Role</span><span class='hs-keyglyph'>]</span>
<a name="line-1045"></a><span class='hs-definition'>tyConRolesX</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConRolesRepresentational</span> <span class='hs-varid'>tc</span>
<a name="line-1046"></a><span class='hs-definition'>tyConRolesX</span> <span class='hs-varid'>role</span>             <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>repeat</span> <span class='hs-varid'>role</span>
<a name="line-1047"></a>
<a name="line-1048"></a><a name="tyConRolesRepresentational"></a><span class='hs-definition'>tyConRolesRepresentational</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Role</span><span class='hs-keyglyph'>]</span>
<a name="line-1049"></a><span class='hs-definition'>tyConRolesRepresentational</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConRoles</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>++</span> <span class='hs-varid'>repeat</span> <span class='hs-conid'>Nominal</span>
<a name="line-1050"></a>
<a name="line-1051"></a><a name="nthRole"></a><span class='hs-definition'>nthRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>
<a name="line-1052"></a><span class='hs-definition'>nthRole</span> <span class='hs-conid'>Nominal</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nominal</span>
<a name="line-1053"></a><span class='hs-definition'>nthRole</span> <span class='hs-conid'>Phantom</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Phantom</span>
<a name="line-1054"></a><span class='hs-definition'>nthRole</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>n</span>
<a name="line-1055"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesRepresentational</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>`getNth`</span> <span class='hs-varid'>n</span>
<a name="line-1056"></a>
<a name="line-1057"></a><a name="ltRole"></a><span class='hs-definition'>ltRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1058"></a><span class='hs-comment'>-- Is one role "less" than another?</span>
<a name="line-1059"></a><span class='hs-comment'>--     Nominal &lt; Representational &lt; Phantom</span>
<a name="line-1060"></a><span class='hs-definition'>ltRole</span> <span class='hs-conid'>Phantom</span>          <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1061"></a><span class='hs-definition'>ltRole</span> <span class='hs-conid'>Representational</span> <span class='hs-conid'>Phantom</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1062"></a><span class='hs-definition'>ltRole</span> <span class='hs-conid'>Representational</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1063"></a><span class='hs-definition'>ltRole</span> <span class='hs-conid'>Nominal</span>          <span class='hs-conid'>Nominal</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1064"></a><span class='hs-definition'>ltRole</span> <span class='hs-conid'>Nominal</span>          <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1065"></a>
<a name="line-1066"></a><span class='hs-comment'>-------------------------------</span>
<a name="line-1067"></a>
<a name="line-1068"></a><a name="promoteCoercion"></a><span class='hs-comment'>-- | like mkKindCo, but aggressively &amp; recursively optimizes to avoid using</span>
<a name="line-1069"></a><span class='hs-comment'>-- a KindCo constructor. The output role is nominal.</span>
<a name="line-1070"></a><span class='hs-definition'>promoteCoercion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1071"></a>
<a name="line-1072"></a><span class='hs-comment'>-- First cases handles anything that should yield refl.</span>
<a name="line-1073"></a><span class='hs-definition'>promoteCoercion</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>of</span>
<a name="line-1074"></a>
<a name="line-1075"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ki1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ki2</span>
<a name="line-1076"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkNomReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span>
<a name="line-1077"></a>     <span class='hs-comment'>-- no later branch should return refl</span>
<a name="line-1078"></a>     <span class='hs-comment'>--    The ASSERT( False )s throughout</span>
<a name="line-1079"></a>     <span class='hs-comment'>-- are these cases explicitly, but they should never fire.</span>
<a name="line-1080"></a>
<a name="line-1081"></a>    <span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-conid'>False</span> <span class='hs-layout'>)</span>
<a name="line-1082"></a>                 <span class='hs-varid'>mkNomReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1083"></a>
<a name="line-1084"></a>    <span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span>
<a name="line-1085"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instCoercions</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNomReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-1086"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>co'</span>
<a name="line-1087"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1088"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co</span>
<a name="line-1089"></a>
<a name="line-1090"></a>    <span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>arg</span>
<a name="line-1091"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instCoercion</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1092"></a>                                 <span class='hs-layout'>(</span><span class='hs-varid'>promoteCoercion</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg</span>
<a name="line-1093"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>co'</span>
<a name="line-1094"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1095"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co</span>
<a name="line-1096"></a>
<a name="line-1097"></a>    <span class='hs-conid'>ForAllCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>g</span>
<a name="line-1098"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>promoteCoercion</span> <span class='hs-varid'>g</span>
<a name="line-1099"></a>
<a name="line-1100"></a>    <span class='hs-conid'>FunCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-1101"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-1102"></a>
<a name="line-1103"></a>    <span class='hs-conid'>CoVarCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>
<a name="line-1104"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co</span>
<a name="line-1105"></a>
<a name="line-1106"></a>    <span class='hs-conid'>AxiomInstCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>
<a name="line-1107"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co</span>
<a name="line-1108"></a>
<a name="line-1109"></a>    <span class='hs-conid'>UnivCo</span> <span class='hs-conid'>UnsafeCoerceProv</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-1110"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkUnsafeCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-1111"></a>    <span class='hs-conid'>UnivCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>kco</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-1112"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>kco</span>
<a name="line-1113"></a>    <span class='hs-conid'>UnivCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>kco</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-1114"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>kco</span>
<a name="line-1115"></a>    <span class='hs-conid'>UnivCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-1116"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co</span>
<a name="line-1117"></a>    <span class='hs-conid'>UnivCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-1118"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co</span>
<a name="line-1119"></a>
<a name="line-1120"></a>    <span class='hs-conid'>SymCo</span> <span class='hs-varid'>g</span>
<a name="line-1121"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteCoercion</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>
<a name="line-1122"></a>
<a name="line-1123"></a>    <span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-1124"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkTransCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteCoercion</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteCoercion</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1125"></a>
<a name="line-1126"></a>    <span class='hs-conid'>NthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co1</span>
<a name="line-1127"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConAppCo_maybe</span> <span class='hs-varid'>co1</span>
<a name="line-1128"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>args</span> <span class='hs-varop'>`lengthExceeds`</span> <span class='hs-varid'>n</span>
<a name="line-1129"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>promoteCoercion</span> <span class='hs-layout'>(</span><span class='hs-varid'>args</span> <span class='hs-varop'>!!</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-1130"></a>
<a name="line-1131"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllCo_maybe</span> <span class='hs-varid'>co</span>
<a name="line-1132"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>
<a name="line-1133"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-conid'>False</span> <span class='hs-layout'>)</span> <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-1134"></a>
<a name="line-1135"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1136"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co</span>
<a name="line-1137"></a>
<a name="line-1138"></a>    <span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co1</span>
<a name="line-1139"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>lco</span><span class='hs-layout'>,</span> <span class='hs-varid'>rco</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitAppCo_maybe</span> <span class='hs-varid'>co1</span>
<a name="line-1140"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lr</span> <span class='hs-keyword'>of</span>
<a name="line-1141"></a>           <span class='hs-conid'>CLeft</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>promoteCoercion</span> <span class='hs-varid'>lco</span>
<a name="line-1142"></a>           <span class='hs-conid'>CRight</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>promoteCoercion</span> <span class='hs-varid'>rco</span>
<a name="line-1143"></a>
<a name="line-1144"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1145"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co</span>
<a name="line-1146"></a>
<a name="line-1147"></a>    <span class='hs-conid'>InstCo</span> <span class='hs-varid'>g</span> <span class='hs-keyword'>_</span>
<a name="line-1148"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>promoteCoercion</span> <span class='hs-varid'>g</span>
<a name="line-1149"></a>
<a name="line-1150"></a>    <span class='hs-conid'>CoherenceCo</span> <span class='hs-varid'>g</span> <span class='hs-varid'>h</span>
<a name="line-1151"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>h</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>promoteCoercion</span> <span class='hs-varid'>g</span>
<a name="line-1152"></a>
<a name="line-1153"></a>    <span class='hs-conid'>KindCo</span> <span class='hs-keyword'>_</span>
<a name="line-1154"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-conid'>False</span> <span class='hs-layout'>)</span>
<a name="line-1155"></a>         <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-1156"></a>
<a name="line-1157"></a>    <span class='hs-conid'>SubCo</span> <span class='hs-varid'>g</span>
<a name="line-1158"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>promoteCoercion</span> <span class='hs-varid'>g</span>
<a name="line-1159"></a>
<a name="line-1160"></a>    <span class='hs-conid'>AxiomRuleCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>
<a name="line-1161"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co</span>
<a name="line-1162"></a>
<a name="line-1163"></a>  <span class='hs-keyword'>where</span>
<a name="line-1164"></a>    <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span>
<a name="line-1165"></a>    <span class='hs-varid'>ki1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty1</span>
<a name="line-1166"></a>    <span class='hs-varid'>ki2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty2</span>
<a name="line-1167"></a>
<a name="line-1168"></a><a name="instCoercion"></a><span class='hs-comment'>-- | say @g = promoteCoercion h@. Then, @instCoercion g w@ yields @Just g'@,</span>
<a name="line-1169"></a><span class='hs-comment'>-- where @g' = promoteCoercion (h w)@.</span>
<a name="line-1170"></a><span class='hs-comment'>-- fails if this is not possible, if @g@ coerces between a forall and an -&gt;</span>
<a name="line-1171"></a><span class='hs-comment'>-- or if second parameter has a representational role and can't be used</span>
<a name="line-1172"></a><span class='hs-comment'>-- with an InstCo. The result role matches is representational.</span>
<a name="line-1173"></a><span class='hs-definition'>instCoercion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span> <span class='hs-comment'>-- type of the first coercion</span>
<a name="line-1174"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>  <span class='hs-comment'>-- ^ must be nominal</span>
<a name="line-1175"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1176"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-1177"></a><span class='hs-definition'>instCoercion</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>lty</span> <span class='hs-varid'>rty</span><span class='hs-layout'>)</span> <span class='hs-varid'>g</span> <span class='hs-varid'>w</span>
<a name="line-1178"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isForAllTy</span> <span class='hs-varid'>lty</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isForAllTy</span> <span class='hs-varid'>rty</span>
<a name="line-1179"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>w'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-varid'>w</span>
<a name="line-1180"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkInstCo</span> <span class='hs-varid'>g</span> <span class='hs-varid'>w'</span>
<a name="line-1181"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFunTy</span> <span class='hs-varid'>lty</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isFunTy</span> <span class='hs-varid'>rty</span>
<a name="line-1182"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-num'>3</span> <span class='hs-varid'>g</span> <span class='hs-comment'>-- extract result type, which is the 4th argument to (-&gt;)</span>
<a name="line-1183"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-comment'>-- one forall, one funty...</span>
<a name="line-1184"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1185"></a>  <span class='hs-keyword'>where</span>
<a name="line-1186"></a>
<a name="line-1187"></a><a name="instCoercions"></a><span class='hs-definition'>instCoercions</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-1188"></a><span class='hs-definition'>instCoercions</span> <span class='hs-varid'>g</span> <span class='hs-varid'>ws</span>
<a name="line-1189"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arg_ty_pairs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>ws</span> <span class='hs-keyword'>in</span>
<a name="line-1190"></a>    <span class='hs-varid'>snd</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>foldM</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>g</span><span class='hs-layout'>,</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-varid'>arg_ty_pairs</span> <span class='hs-varid'>ws</span><span class='hs-layout'>)</span>
<a name="line-1191"></a>  <span class='hs-keyword'>where</span>
<a name="line-1192"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-1193"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-1194"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>g_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>w_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span>
<a name="line-1195"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>g'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instCoercion</span> <span class='hs-varid'>g_tys</span> <span class='hs-varid'>g</span> <span class='hs-varid'>w</span>
<a name="line-1196"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>piResultTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>g_tys</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>w_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>g'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1197"></a>
<a name="line-1198"></a><a name="castCoercionKind"></a><span class='hs-comment'>-- | Creates a new coercion with both of its types casted by different casts</span>
<a name="line-1199"></a><span class='hs-comment'>-- castCoercionKind g h1 h2, where g :: t1 ~ t2, has type (t1 |&gt; h1) ~ (t2 |&gt; h2)</span>
<a name="line-1200"></a><span class='hs-comment'>-- The second and third coercions must be nominal.</span>
<a name="line-1201"></a><span class='hs-definition'>castCoercionKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1202"></a><span class='hs-definition'>castCoercionKind</span> <span class='hs-varid'>g</span> <span class='hs-varid'>h1</span> <span class='hs-varid'>h2</span>
<a name="line-1203"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>g</span> <span class='hs-varop'>`mkCoherenceLeftCo`</span> <span class='hs-varid'>h1</span> <span class='hs-varop'>`mkCoherenceRightCo`</span> <span class='hs-varid'>h2</span>
<a name="line-1204"></a>
<a name="line-1205"></a><span class='hs-comment'>-- See note [Newtype coercions] in TyCon</span>
<a name="line-1206"></a>
<a name="line-1207"></a><a name="mkPiCos"></a><span class='hs-definition'>mkPiCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1208"></a><span class='hs-definition'>mkPiCos</span> <span class='hs-varid'>r</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPiCo</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span> <span class='hs-varid'>vs</span>
<a name="line-1209"></a>
<a name="line-1210"></a><a name="mkPiCo"></a><span class='hs-comment'>-- | Make a forall 'Coercion', where both types related by the coercion</span>
<a name="line-1211"></a><span class='hs-comment'>-- are quantified over the same type variable.</span>
<a name="line-1212"></a><span class='hs-definition'>mkPiCo</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1213"></a><span class='hs-definition'>mkPiCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>v</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHomoForAllCos</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>v</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>co</span>
<a name="line-1214"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunCo</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-1215"></a>
<a name="line-1216"></a><a name="mkCoCast"></a><span class='hs-comment'>-- The second coercion is sometimes lifted (~) and sometimes unlifted (~#).</span>
<a name="line-1217"></a><span class='hs-comment'>-- So, we have to make sure to supply the right parameter to decomposeCo.</span>
<a name="line-1218"></a><span class='hs-comment'>-- mkCoCast (c :: s1 ~# t1) (g :: (s1 ~# s2) ~# (t1 ~# t2)) :: s2 ~# t2</span>
<a name="line-1219"></a><span class='hs-comment'>-- Both coercions *must* have the same role.</span>
<a name="line-1220"></a><span class='hs-definition'>mkCoCast</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1221"></a><span class='hs-definition'>mkCoCast</span> <span class='hs-varid'>c</span> <span class='hs-varid'>g</span>
<a name="line-1222"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>g1</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>c</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>g2</span>
<a name="line-1223"></a>  <span class='hs-keyword'>where</span>
<a name="line-1224"></a>       <span class='hs-comment'>-- g  :: (s1 ~# s2) ~# (t1 ~#  t2)</span>
<a name="line-1225"></a>       <span class='hs-comment'>-- g1 :: s1 ~# t1</span>
<a name="line-1226"></a>       <span class='hs-comment'>-- g2 :: s2 ~# t2</span>
<a name="line-1227"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>pFst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>
<a name="line-1228"></a>    <span class='hs-varid'>n_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>args</span>
<a name="line-1229"></a>    <span class='hs-varid'>co_list</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decomposeCo</span> <span class='hs-varid'>n_args</span> <span class='hs-varid'>g</span>
<a name="line-1230"></a>    <span class='hs-varid'>g1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co_list</span> <span class='hs-varop'>`getNth`</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_args</span> <span class='hs-comment'>-</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-1231"></a>    <span class='hs-varid'>g2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co_list</span> <span class='hs-varop'>`getNth`</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_args</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-1232"></a>
<a name="line-1233"></a><span class='hs-comment'>{-
<a name="line-1234"></a>%************************************************************************
<a name="line-1235"></a>%*                                                                      *
<a name="line-1236"></a>            Newtypes
<a name="line-1237"></a>%*                                                                      *
<a name="line-1238"></a>%************************************************************************
<a name="line-1239"></a>-}</span>
<a name="line-1240"></a>
<a name="line-1241"></a><a name="instNewTyCon_maybe"></a><span class='hs-comment'>-- | If @co :: T ts ~ rep_ty@ then:</span>
<a name="line-1242"></a><span class='hs-comment'>--</span>
<a name="line-1243"></a><span class='hs-comment'>-- &gt; instNewTyCon_maybe T ts = Just (rep_ty, co)</span>
<a name="line-1244"></a><span class='hs-comment'>--</span>
<a name="line-1245"></a><span class='hs-comment'>-- Checks for a newtype, and for being saturated</span>
<a name="line-1246"></a><span class='hs-definition'>instNewTyCon_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-1247"></a><span class='hs-definition'>instNewTyCon_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-1248"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>co_tc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unwrapNewTyConEtad_maybe</span> <span class='hs-varid'>tc</span>  <span class='hs-comment'>-- Check for newtype</span>
<a name="line-1249"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`leLength`</span> <span class='hs-varid'>tys</span>                                    <span class='hs-comment'>-- Check saturated enough</span>
<a name="line-1250"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>applyTysX</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkUnbranchedAxInstCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>co_tc</span> <span class='hs-varid'>tys</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-1251"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1252"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1253"></a>
<a name="line-1254"></a><span class='hs-comment'>{-
<a name="line-1255"></a>************************************************************************
<a name="line-1256"></a>*                                                                      *
<a name="line-1257"></a>         Type normalisation
<a name="line-1258"></a>*                                                                      *
<a name="line-1259"></a>************************************************************************
<a name="line-1260"></a>-}</span>
<a name="line-1261"></a>
<a name="line-1262"></a><a name="NormaliseStepper"></a><span class='hs-comment'>-- | A function to check if we can reduce a type by one step. Used</span>
<a name="line-1263"></a><a name="NormaliseStepper"></a><span class='hs-comment'>-- with 'topNormaliseTypeX'.</span>
<a name="line-1264"></a><a name="NormaliseStepper"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>NormaliseStepper</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RecTcChecker</span>
<a name="line-1265"></a>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span>     <span class='hs-comment'>-- tc</span>
<a name="line-1266"></a>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- tys</span>
<a name="line-1267"></a>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormaliseStepResult</span> <span class='hs-varid'>ev</span>
<a name="line-1268"></a>
<a name="line-1269"></a><a name="NormaliseStepResult"></a><span class='hs-comment'>-- | The result of stepping in a normalisation function.</span>
<a name="line-1270"></a><a name="NormaliseStepResult"></a><span class='hs-comment'>-- See 'topNormaliseTypeX'.</span>
<a name="line-1271"></a><a name="NormaliseStepResult"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>NormaliseStepResult</span> <span class='hs-varid'>ev</span>
<a name="line-1272"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NS_Done</span>   <span class='hs-comment'>-- ^ Nothing more to do</span>
<a name="line-1273"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NS_Abort</span>  <span class='hs-comment'>-- ^ Utter failure. The outer function should fail too.</span>
<a name="line-1274"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NS_Step</span> <span class='hs-conid'>RecTcChecker</span> <span class='hs-conid'>Type</span> <span class='hs-varid'>ev</span>    <span class='hs-comment'>-- ^ We stepped, yielding new bits;</span>
<a name="line-1275"></a>                                    <span class='hs-comment'>-- ^ ev is evidence;</span>
<a name="line-1276"></a>                                    <span class='hs-comment'>-- Usually a co :: old type ~ new type</span>
<a name="line-1277"></a>
<a name="line-1278"></a><a name="mapStepResult"></a><span class='hs-definition'>mapStepResult</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ev2</span><span class='hs-layout'>)</span>
<a name="line-1279"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormaliseStepResult</span> <span class='hs-varid'>ev1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormaliseStepResult</span> <span class='hs-varid'>ev2</span>
<a name="line-1280"></a><span class='hs-definition'>mapStepResult</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>NS_Step</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NS_Step</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-1281"></a><span class='hs-definition'>mapStepResult</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>NS_Done</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NS_Done</span>
<a name="line-1282"></a><span class='hs-definition'>mapStepResult</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>NS_Abort</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NS_Abort</span>
<a name="line-1283"></a>
<a name="line-1284"></a><a name="composeSteppers"></a><span class='hs-comment'>-- | Try one stepper and then try the next, if the first doesn't make</span>
<a name="line-1285"></a><span class='hs-comment'>-- progress.</span>
<a name="line-1286"></a><span class='hs-comment'>-- So if it returns NS_Done, it means that both steppers are satisfied</span>
<a name="line-1287"></a><span class='hs-definition'>composeSteppers</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NormaliseStepper</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormaliseStepper</span> <span class='hs-varid'>ev</span>
<a name="line-1288"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormaliseStepper</span> <span class='hs-varid'>ev</span>
<a name="line-1289"></a><span class='hs-definition'>composeSteppers</span> <span class='hs-varid'>step1</span> <span class='hs-varid'>step2</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-1290"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>step1</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyword'>of</span>
<a name="line-1291"></a>      <span class='hs-varid'>success</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>NS_Step</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>success</span>
<a name="line-1292"></a>      <span class='hs-conid'>NS_Done</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>step2</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-1293"></a>      <span class='hs-conid'>NS_Abort</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NS_Abort</span>
<a name="line-1294"></a>
<a name="line-1295"></a><a name="unwrapNewTypeStepper"></a><span class='hs-comment'>-- | A 'NormaliseStepper' that unwraps newtypes, careful not to fall into</span>
<a name="line-1296"></a><span class='hs-comment'>-- a loop. If it would fall into a loop, it produces 'NS_Abort'.</span>
<a name="line-1297"></a><span class='hs-definition'>unwrapNewTypeStepper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NormaliseStepper</span> <span class='hs-conid'>Coercion</span>
<a name="line-1298"></a><span class='hs-definition'>unwrapNewTypeStepper</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-1299"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instNewTyCon_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-1300"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>checkRecTc</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>of</span>
<a name="line-1301"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>rec_nts'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NS_Step</span> <span class='hs-varid'>rec_nts'</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>co</span>
<a name="line-1302"></a>      <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NS_Abort</span>
<a name="line-1303"></a>
<a name="line-1304"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1305"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NS_Done</span>
<a name="line-1306"></a>
<a name="line-1307"></a><a name="topNormaliseTypeX"></a><span class='hs-comment'>-- | A general function for normalising the top-level of a type. It continues</span>
<a name="line-1308"></a><span class='hs-comment'>-- to use the provided 'NormaliseStepper' until that function fails, and then</span>
<a name="line-1309"></a><span class='hs-comment'>-- this function returns. The roles of the coercions produced by the</span>
<a name="line-1310"></a><span class='hs-comment'>-- 'NormaliseStepper' must all be the same, which is the role returned from</span>
<a name="line-1311"></a><span class='hs-comment'>-- the call to 'topNormaliseTypeX'.</span>
<a name="line-1312"></a><span class='hs-comment'>--</span>
<a name="line-1313"></a><span class='hs-comment'>-- Typically ev is Coercion.</span>
<a name="line-1314"></a><span class='hs-comment'>--</span>
<a name="line-1315"></a><span class='hs-comment'>-- If topNormaliseTypeX step plus ty = Just (ev, ty')</span>
<a name="line-1316"></a><span class='hs-comment'>-- then ty ~ev1~ t1 ~ev2~ t2 ... ~evn~ ty'</span>
<a name="line-1317"></a><span class='hs-comment'>-- and ev = ev1 `plus` ev2 `plus` ... `plus` evn</span>
<a name="line-1318"></a><span class='hs-comment'>-- If it returns Nothing then no newtype unwrapping could happen</span>
<a name="line-1319"></a><span class='hs-definition'>topNormaliseTypeX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NormaliseStepper</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-1320"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1321"></a><span class='hs-definition'>topNormaliseTypeX</span> <span class='hs-varid'>stepper</span> <span class='hs-varid'>plus</span> <span class='hs-varid'>ty</span>
<a name="line-1322"></a> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1323"></a> <span class='hs-layout'>,</span> <span class='hs-conid'>NS_Step</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepper</span> <span class='hs-varid'>initRecTc</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-1324"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>ty'</span>
<a name="line-1325"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1326"></a> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1327"></a> <span class='hs-keyword'>where</span>
<a name="line-1328"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>ty</span>
<a name="line-1329"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1330"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stepper</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyword'>of</span>
<a name="line-1331"></a>          <span class='hs-conid'>NS_Step</span> <span class='hs-varid'>rec_nts'</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>ev'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts'</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev</span> <span class='hs-varop'>`plus`</span> <span class='hs-varid'>ev'</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty'</span>
<a name="line-1332"></a>          <span class='hs-conid'>NS_Done</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1333"></a>          <span class='hs-conid'>NS_Abort</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1334"></a>
<a name="line-1335"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1336"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1337"></a>
<a name="line-1338"></a><a name="topNormaliseNewType_maybe"></a><span class='hs-definition'>topNormaliseNewType_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1339"></a><span class='hs-comment'>-- ^ Sometimes we want to look through a @newtype@ and get its associated coercion.</span>
<a name="line-1340"></a><span class='hs-comment'>-- This function strips off @newtype@ layers enough to reveal something that isn't</span>
<a name="line-1341"></a><span class='hs-comment'>-- a @newtype@.  Specifically, here's the invariant:</span>
<a name="line-1342"></a><span class='hs-comment'>--</span>
<a name="line-1343"></a><span class='hs-comment'>-- &gt; topNormaliseNewType_maybe rec_nts ty = Just (co, ty')</span>
<a name="line-1344"></a><span class='hs-comment'>--</span>
<a name="line-1345"></a><span class='hs-comment'>-- then (a)  @co : ty0 ~ ty'@.</span>
<a name="line-1346"></a><span class='hs-comment'>--      (b)  ty' is not a newtype.</span>
<a name="line-1347"></a><span class='hs-comment'>--</span>
<a name="line-1348"></a><span class='hs-comment'>-- The function returns @Nothing@ for non-@newtypes@,</span>
<a name="line-1349"></a><span class='hs-comment'>-- or unsaturated applications</span>
<a name="line-1350"></a><span class='hs-comment'>--</span>
<a name="line-1351"></a><span class='hs-comment'>-- This function does *not* look through type families, because it has no access to</span>
<a name="line-1352"></a><span class='hs-comment'>-- the type family environment. If you do have that at hand, consider to use</span>
<a name="line-1353"></a><span class='hs-comment'>-- topNormaliseType_maybe, which should be a drop-in replacement for</span>
<a name="line-1354"></a><span class='hs-comment'>-- topNormaliseNewType_maybe</span>
<a name="line-1355"></a><span class='hs-comment'>-- If topNormliseNewType_maybe ty = Just (co, ty'), then co : ty ~R ty'</span>
<a name="line-1356"></a><span class='hs-definition'>topNormaliseNewType_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1357"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topNormaliseTypeX</span> <span class='hs-varid'>unwrapNewTypeStepper</span> <span class='hs-varid'>mkTransCo</span> <span class='hs-varid'>ty</span>
<a name="line-1358"></a>
<a name="line-1359"></a><span class='hs-comment'>{-
<a name="line-1360"></a>%************************************************************************
<a name="line-1361"></a>%*                                                                      *
<a name="line-1362"></a>                   Comparison of coercions
<a name="line-1363"></a>%*                                                                      *
<a name="line-1364"></a>%************************************************************************
<a name="line-1365"></a>-}</span>
<a name="line-1366"></a>
<a name="line-1367"></a><a name="eqCoercion"></a><span class='hs-comment'>-- | Syntactic equality of coercions</span>
<a name="line-1368"></a><span class='hs-definition'>eqCoercion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1369"></a><span class='hs-definition'>eqCoercion</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqType</span> <span class='hs-varop'>`on`</span> <span class='hs-varid'>coercionType</span>
<a name="line-1370"></a>
<a name="line-1371"></a><a name="eqCoercionX"></a><span class='hs-comment'>-- | Compare two 'Coercion's, with respect to an RnEnv2</span>
<a name="line-1372"></a><span class='hs-definition'>eqCoercionX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RnEnv2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1373"></a><span class='hs-definition'>eqCoercionX</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varop'>`on`</span> <span class='hs-varid'>coercionType</span>
<a name="line-1374"></a>
<a name="line-1375"></a><span class='hs-comment'>{-
<a name="line-1376"></a>%************************************************************************
<a name="line-1377"></a>%*                                                                      *
<a name="line-1378"></a>                   "Lifting" substitution
<a name="line-1379"></a>           [(TyCoVar,Coercion)] -&gt; Type -&gt; Coercion
<a name="line-1380"></a>%*                                                                      *
<a name="line-1381"></a>%************************************************************************
<a name="line-1382"></a>
<a name="line-1383"></a>Note [Lifting coercions over types: liftCoSubst]
<a name="line-1384"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1385"></a>The KPUSH rule deals with this situation
<a name="line-1386"></a>   data T a = MkK (a -&gt; Maybe a)
<a name="line-1387"></a>   g :: T t1 ~ K t2
<a name="line-1388"></a>   x :: t1 -&gt; Maybe t1
<a name="line-1389"></a>
<a name="line-1390"></a>   case (K @t1 x) |&gt; g of
<a name="line-1391"></a>     K (y:t2 -&gt; Maybe t2) -&gt; rhs
<a name="line-1392"></a>
<a name="line-1393"></a>We want to push the coercion inside the constructor application.
<a name="line-1394"></a>So we do this
<a name="line-1395"></a>
<a name="line-1396"></a>   g' :: t1~t2  =  Nth 0 g
<a name="line-1397"></a>
<a name="line-1398"></a>   case K @t2 (x |&gt; g' -&gt; Maybe g') of
<a name="line-1399"></a>     K (y:t2 -&gt; Maybe t2) -&gt; rhs
<a name="line-1400"></a>
<a name="line-1401"></a>The crucial operation is that we
<a name="line-1402"></a>  * take the type of K's argument: a -&gt; Maybe a
<a name="line-1403"></a>  * and substitute g' for a
<a name="line-1404"></a>thus giving *coercion*.  This is what liftCoSubst does.
<a name="line-1405"></a>
<a name="line-1406"></a>In the presence of kind coercions, this is a bit
<a name="line-1407"></a>of a hairy operation. So, we refer you to the paper introducing kind coercions,
<a name="line-1408"></a>available at www.cis.upenn.edu/~sweirich/papers/fckinds-extended.pdf
<a name="line-1409"></a>-}</span>
<a name="line-1410"></a>
<a name="line-1411"></a><span class='hs-comment'>-- ----------------------------------------------------</span>
<a name="line-1412"></a><span class='hs-comment'>-- See Note [Lifting coercions over types: liftCoSubst]</span>
<a name="line-1413"></a><span class='hs-comment'>-- ----------------------------------------------------</span>
<a name="line-1414"></a>
<a name="line-1415"></a><a name="LiftingContext"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LC</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-conid'>LiftCoEnv</span>
<a name="line-1416"></a>  <span class='hs-comment'>-- in optCoercion, we need to lift when optimizing InstCo.</span>
<a name="line-1417"></a>  <span class='hs-comment'>-- See Note [Optimising InstCo] in OptCoercion</span>
<a name="line-1418"></a>  <span class='hs-comment'>-- We thus propagate the substitution from OptCoercion here.</span>
<a name="line-1419"></a>
<a name="line-1420"></a><a name="instance%20Outputable%20LiftingContext"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyword'>where</span>
<a name="line-1421"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"LiftingContext:"</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-1422"></a>
<a name="line-1423"></a><a name="LiftCoEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>LiftCoEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VarEnv</span> <span class='hs-conid'>Coercion</span>
<a name="line-1424"></a>     <span class='hs-comment'>-- Maps *type variables* to *coercions*.</span>
<a name="line-1425"></a>     <span class='hs-comment'>-- That's the whole point of this function!</span>
<a name="line-1426"></a>
<a name="line-1427"></a><a name="liftCoSubstWithEx"></a><span class='hs-comment'>-- like liftCoSubstWith, but allows for existentially-bound types as well</span>
<a name="line-1428"></a><span class='hs-definition'>liftCoSubstWithEx</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span>          <span class='hs-comment'>-- desired role for output coercion</span>
<a name="line-1429"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>       <span class='hs-comment'>-- universally quantified tyvars</span>
<a name="line-1430"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- coercions to substitute for those</span>
<a name="line-1431"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>       <span class='hs-comment'>-- existentially quantified tyvars</span>
<a name="line-1432"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- types to be bound to ex vars</span>
<a name="line-1433"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- (lifting function, converted ex args)</span>
<a name="line-1434"></a><span class='hs-definition'>liftCoSubstWithEx</span> <span class='hs-varid'>role</span> <span class='hs-varid'>univs</span> <span class='hs-varid'>omegas</span> <span class='hs-varid'>exs</span> <span class='hs-varid'>rhos</span>
<a name="line-1435"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLiftingContext</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipEqual</span> <span class='hs-str'>"liftCoSubstWithExU"</span> <span class='hs-varid'>univs</span> <span class='hs-varid'>omegas</span><span class='hs-layout'>)</span>
<a name="line-1436"></a>        <span class='hs-varid'>psi</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendLiftingContextEx</span> <span class='hs-varid'>theta</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipEqual</span> <span class='hs-str'>"liftCoSubstWithExX"</span> <span class='hs-varid'>exs</span> <span class='hs-varid'>rhos</span><span class='hs-layout'>)</span>
<a name="line-1437"></a>    <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty_co_subst</span> <span class='hs-varid'>psi</span> <span class='hs-varid'>role</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>lcSubstRight</span> <span class='hs-varid'>psi</span><span class='hs-layout'>)</span> <span class='hs-varid'>exs</span><span class='hs-layout'>)</span>
<a name="line-1438"></a>
<a name="line-1439"></a><a name="liftCoSubstWith"></a><span class='hs-definition'>liftCoSubstWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1440"></a><span class='hs-comment'>-- NB: This really can be called with CoVars, when optimising axioms.</span>
<a name="line-1441"></a><span class='hs-definition'>liftCoSubstWith</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>ty</span>
<a name="line-1442"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftCoSubst</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLiftingContext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>zipEqual</span> <span class='hs-str'>"liftCoSubstWith"</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1443"></a>
<a name="line-1444"></a><a name="liftCoSubst"></a><span class='hs-comment'>-- | @liftCoSubst role lc ty@ produces a coercion (at role @role@)</span>
<a name="line-1445"></a><span class='hs-comment'>-- that coerces between @lc_left(ty)@ and @lc_right(ty)@, where</span>
<a name="line-1446"></a><span class='hs-comment'>-- @lc_left@ is a substitution mapping type variables to the left-hand</span>
<a name="line-1447"></a><span class='hs-comment'>-- types of the mapped coercions in @lc@, and similar for @lc_right@.</span>
<a name="line-1448"></a><span class='hs-definition'>liftCoSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1449"></a><span class='hs-definition'>liftCoSubst</span> <span class='hs-varid'>r</span> <span class='hs-varid'>lc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1450"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1451"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_subst</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span>
<a name="line-1452"></a>
<a name="line-1453"></a><a name="emptyLiftingContext"></a><span class='hs-definition'>emptyLiftingContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftingContext</span>
<a name="line-1454"></a><span class='hs-definition'>emptyLiftingContext</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LC</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkEmptyTCvSubst</span> <span class='hs-varid'>in_scope</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-1455"></a>
<a name="line-1456"></a><a name="mkLiftingContext"></a><span class='hs-definition'>mkLiftingContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TyCoVar</span><span class='hs-layout'>,</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftingContext</span>
<a name="line-1457"></a><span class='hs-definition'>mkLiftingContext</span> <span class='hs-varid'>pairs</span>
<a name="line-1458"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LC</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkEmptyTCvSubst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoVarsOfCos</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1459"></a>       <span class='hs-layout'>(</span><span class='hs-varid'>mkVarEnv</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>
<a name="line-1460"></a>
<a name="line-1461"></a><a name="mkSubstLiftingContext"></a><span class='hs-definition'>mkSubstLiftingContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftingContext</span>
<a name="line-1462"></a><span class='hs-definition'>mkSubstLiftingContext</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-1463"></a>
<a name="line-1464"></a><a name="extendLiftingContext"></a><span class='hs-comment'>-- | Extend a lifting context with a new /type/ mapping.</span>
<a name="line-1465"></a><span class='hs-definition'>extendLiftingContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span>  <span class='hs-comment'>-- ^ original LC</span>
<a name="line-1466"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span>           <span class='hs-comment'>-- ^ new variable to map...</span>
<a name="line-1467"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>        <span class='hs-comment'>-- ^ ...to this lifted version</span>
<a name="line-1468"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftingContext</span>
<a name="line-1469"></a><span class='hs-definition'>extendLiftingContext</span> <span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>arg</span>
<a name="line-1470"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-1471"></a>    <span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-1472"></a>
<a name="line-1473"></a><a name="extendLiftingContextEx"></a><span class='hs-comment'>-- | Extend a lifting context with existential-variable bindings.</span>
<a name="line-1474"></a><span class='hs-comment'>-- This follows the lifting context extension definition in the</span>
<a name="line-1475"></a><span class='hs-comment'>-- "FC with Explicit Kind Equality" paper.</span>
<a name="line-1476"></a><span class='hs-definition'>extendLiftingContextEx</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span>    <span class='hs-comment'>-- ^ original lifting context</span>
<a name="line-1477"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span><span class='hs-conid'>Type</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- ^ ex. var / value pairs</span>
<a name="line-1478"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftingContext</span>
<a name="line-1479"></a><span class='hs-comment'>-- Note that this is more involved than extendLiftingContext. That function</span>
<a name="line-1480"></a><span class='hs-comment'>-- takes a coercion to extend with, so it's assumed that the caller has taken</span>
<a name="line-1481"></a><span class='hs-comment'>-- into account any of the kind-changing stuff worried about here.</span>
<a name="line-1482"></a><span class='hs-definition'>extendLiftingContextEx</span> <span class='hs-varid'>lc</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lc</span>
<a name="line-1483"></a><span class='hs-definition'>extendLiftingContextEx</span> <span class='hs-varid'>lc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>rest</span><span class='hs-layout'>)</span>
<a name="line-1484"></a><span class='hs-comment'>-- This function adds bindings for *Nominal* coercions. Why? Because it</span>
<a name="line-1485"></a><span class='hs-comment'>-- works with existentially bound variables, which are considered to have</span>
<a name="line-1486"></a><span class='hs-comment'>-- nominal roles.</span>
<a name="line-1487"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>lc'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LC</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span> <span class='hs-varop'>`extendTCvInScopeSet`</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1488"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSymCo</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkCoherenceCo</span>
<a name="line-1489"></a>                                         <span class='hs-layout'>(</span><span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1490"></a>                                         <span class='hs-layout'>(</span><span class='hs-varid'>ty_co_subst</span> <span class='hs-varid'>lc</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1491"></a>    <span class='hs-keyword'>in</span> <span class='hs-varid'>extendLiftingContextEx</span> <span class='hs-varid'>lc'</span> <span class='hs-varid'>rest</span>
<a name="line-1492"></a>
<a name="line-1493"></a><a name="zapLiftingContext"></a><span class='hs-comment'>-- | Erase the environments in a lifting context</span>
<a name="line-1494"></a><span class='hs-definition'>zapLiftingContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftingContext</span>
<a name="line-1495"></a><span class='hs-definition'>zapLiftingContext</span> <span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LC</span> <span class='hs-layout'>(</span><span class='hs-varid'>zapTCvSubst</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-1496"></a>
<a name="line-1497"></a><a name="substForAllCoBndrCallbackLC"></a><span class='hs-comment'>-- | Like 'substForAllCoBndr', but works on a lifting context</span>
<a name="line-1498"></a><span class='hs-definition'>substForAllCoBndrCallbackLC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-1499"></a>                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-1500"></a>                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1501"></a>                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LiftingContext</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-1502"></a><span class='hs-definition'>substForAllCoBndrCallbackLC</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>sco</span> <span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>lc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span>
<a name="line-1503"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>lc_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>,</span> <span class='hs-varid'>co'</span><span class='hs-layout'>)</span>
<a name="line-1504"></a>  <span class='hs-keyword'>where</span>
<a name="line-1505"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>,</span> <span class='hs-varid'>co'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substForAllCoBndrCallback</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>sco</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span>
<a name="line-1506"></a>
<a name="line-1507"></a><a name="ty_co_subst"></a><span class='hs-comment'>-- | The \"lifting\" operation which substitutes coercions for type</span>
<a name="line-1508"></a><span class='hs-comment'>--   variables in a type to produce a coercion.</span>
<a name="line-1509"></a><span class='hs-comment'>--</span>
<a name="line-1510"></a><span class='hs-comment'>--   For the inverse operation, see 'liftCoMatch'</span>
<a name="line-1511"></a><span class='hs-definition'>ty_co_subst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1512"></a><span class='hs-definition'>ty_co_subst</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty</span>
<a name="line-1513"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty</span>
<a name="line-1514"></a>  <span class='hs-keyword'>where</span>
<a name="line-1515"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1516"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span>                <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span>
<a name="line-1517"></a>                           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty'</span>
<a name="line-1518"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>Phantom</span> <span class='hs-varid'>ty</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift_phantom</span> <span class='hs-varid'>ty</span>
<a name="line-1519"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"ty_co_subst bad roles"</span> <span class='hs-varop'>$</span>
<a name="line-1520"></a>                             <span class='hs-varid'>liftCoSubstTyVar</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tv</span>
<a name="line-1521"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-1522"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-1523"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunCo</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-1524"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvBndr</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1525"></a>                           <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>lc'</span><span class='hs-layout'>,</span> <span class='hs-varid'>v'</span><span class='hs-layout'>,</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftCoSubstVarBndr</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>in</span>
<a name="line-1526"></a>                             <span class='hs-varid'>mkForAllCo</span> <span class='hs-varid'>v'</span> <span class='hs-varid'>h</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>ty_co_subst</span> <span class='hs-varid'>lc'</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span>
<a name="line-1527"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>r</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>)</span>
<a name="line-1528"></a>                             <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span>
<a name="line-1529"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>castCoercionKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>substLeftCo</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1530"></a>                                                        <span class='hs-layout'>(</span><span class='hs-varid'>substRightCo</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1531"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkProofIrrelCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>kco</span> <span class='hs-layout'>(</span><span class='hs-varid'>substLeftCo</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1532"></a>                                                  <span class='hs-layout'>(</span><span class='hs-varid'>substRightCo</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1533"></a>      <span class='hs-keyword'>where</span> <span class='hs-varid'>kco</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionType</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1534"></a>
<a name="line-1535"></a>    <span class='hs-varid'>lift_phantom</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPhantomCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1536"></a>                                  <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>lcSubstLeft</span>  <span class='hs-varid'>lc</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1537"></a>                                  <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>lcSubstRight</span> <span class='hs-varid'>lc</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1538"></a>
<a name="line-1539"></a><span class='hs-comment'>{-
<a name="line-1540"></a>Note [liftCoSubstTyVar]
<a name="line-1541"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1542"></a>This function can fail if a coercion in the environment is of too low a role.
<a name="line-1543"></a>
<a name="line-1544"></a>liftCoSubstTyVar is called from two places: in liftCoSubst (naturally), and
<a name="line-1545"></a>also in matchAxiom in OptCoercion. From liftCoSubst, the so-called lifting
<a name="line-1546"></a>lemma guarantees that the roles work out. If we fail in this
<a name="line-1547"></a>case, we really should panic -- something is deeply wrong. But, in matchAxiom,
<a name="line-1548"></a>failing is fine. matchAxiom is trying to find a set of coercions
<a name="line-1549"></a>that match, but it may fail, and this is healthy behavior.
<a name="line-1550"></a>-}</span>
<a name="line-1551"></a>
<a name="line-1552"></a><a name="liftCoSubstTyVar"></a><span class='hs-comment'>-- See Note [liftCoSubstTyVar]</span>
<a name="line-1553"></a><span class='hs-definition'>liftCoSubstTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-1554"></a><span class='hs-definition'>liftCoSubstTyVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>r</span> <span class='hs-varid'>v</span>
<a name="line-1555"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co_arg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v</span>
<a name="line-1556"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>downgradeRole_maybe</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co_arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>co_arg</span>
<a name="line-1557"></a>
<a name="line-1558"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1559"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTyVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-1560"></a>
<a name="line-1561"></a><a name="liftCoSubstVarBndr"></a><span class='hs-definition'>liftCoSubstVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span>
<a name="line-1562"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LiftingContext</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-1563"></a><span class='hs-definition'>liftCoSubstVarBndr</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>tv</span>
<a name="line-1564"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>lc'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>,</span> <span class='hs-varid'>h</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftCoSubstVarBndrCallback</span> <span class='hs-varid'>callback</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>in</span>
<a name="line-1565"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>lc'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>,</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>
<a name="line-1566"></a>  <span class='hs-keyword'>where</span>
<a name="line-1567"></a>    <span class='hs-varid'>callback</span> <span class='hs-varid'>lc'</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty_co_subst</span> <span class='hs-varid'>lc'</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-1568"></a>
<a name="line-1569"></a><a name="liftCoSubstVarBndrCallback"></a><span class='hs-comment'>-- the callback must produce a nominal coercion</span>
<a name="line-1570"></a><span class='hs-definition'>liftCoSubstVarBndrCallback</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1571"></a>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span>
<a name="line-1572"></a>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LiftingContext</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1573"></a><span class='hs-definition'>liftCoSubstVarBndrCallback</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>lc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_var</span>
<a name="line-1574"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-conid'>LC</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span> <span class='hs-varop'>`extendTCvInScope`</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_cenv</span>
<a name="line-1575"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>,</span> <span class='hs-varid'>eta</span><span class='hs-layout'>,</span> <span class='hs-varid'>stuff</span> <span class='hs-layout'>)</span>
<a name="line-1576"></a>  <span class='hs-keyword'>where</span>
<a name="line-1577"></a>    <span class='hs-varid'>old_kind</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>old_var</span>
<a name="line-1578"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>eta</span><span class='hs-layout'>,</span> <span class='hs-varid'>stuff</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>old_kind</span>
<a name="line-1579"></a>    <span class='hs-conid'>Pair</span> <span class='hs-varid'>k1</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>eta</span>
<a name="line-1580"></a>    <span class='hs-varid'>new_var</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-layout'>(</span><span class='hs-varid'>getTCvInScope</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>setVarType</span> <span class='hs-varid'>old_var</span> <span class='hs-varid'>k1</span><span class='hs-layout'>)</span>
<a name="line-1581"></a>
<a name="line-1582"></a>    <span class='hs-varid'>lifted</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span>
<a name="line-1583"></a>    <span class='hs-varid'>new_cenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>old_var</span> <span class='hs-varid'>lifted</span>
<a name="line-1584"></a>
<a name="line-1585"></a><a name="isMappedByLC"></a><span class='hs-comment'>-- | Is a var in the domain of a lifting context?</span>
<a name="line-1586"></a><span class='hs-definition'>isMappedByLC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1587"></a><span class='hs-definition'>isMappedByLC</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarEnv`</span> <span class='hs-varid'>env</span>
<a name="line-1588"></a>
<a name="line-1589"></a><a name="substLeftCo"></a><span class='hs-comment'>-- If [a |-&gt; g] is in the substitution and g :: t1 ~ t2, substitute a for t1</span>
<a name="line-1590"></a><span class='hs-comment'>-- If [a |-&gt; (g1, g2)] is in the substitution, substitute a for g1</span>
<a name="line-1591"></a><span class='hs-definition'>substLeftCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1592"></a><span class='hs-definition'>substLeftCo</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>co</span>
<a name="line-1593"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>lcSubstLeft</span> <span class='hs-varid'>lc</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-1594"></a>
<a name="line-1595"></a><a name="substRightCo"></a><span class='hs-comment'>-- Ditto, but for t2 and g2</span>
<a name="line-1596"></a><span class='hs-definition'>substRightCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1597"></a><span class='hs-definition'>substRightCo</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>co</span>
<a name="line-1598"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>lcSubstRight</span> <span class='hs-varid'>lc</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-1599"></a>
<a name="line-1600"></a><a name="swapLiftCoEnv"></a><span class='hs-comment'>-- | Apply "sym" to all coercions in a 'LiftCoEnv'</span>
<a name="line-1601"></a><span class='hs-definition'>swapLiftCoEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftCoEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftCoEnv</span>
<a name="line-1602"></a><span class='hs-definition'>swapLiftCoEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapVarEnv</span> <span class='hs-varid'>mkSymCo</span>
<a name="line-1603"></a>
<a name="line-1604"></a><a name="lcSubstLeft"></a><span class='hs-definition'>lcSubstLeft</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1605"></a><span class='hs-definition'>lcSubstLeft</span> <span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>lc_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftEnvSubstLeft</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>lc_env</span>
<a name="line-1606"></a>
<a name="line-1607"></a><a name="lcSubstRight"></a><span class='hs-definition'>lcSubstRight</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1608"></a><span class='hs-definition'>lcSubstRight</span> <span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>lc_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftEnvSubstRight</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>lc_env</span>
<a name="line-1609"></a>
<a name="line-1610"></a><a name="liftEnvSubstLeft"></a><span class='hs-definition'>liftEnvSubstLeft</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftCoEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1611"></a><span class='hs-definition'>liftEnvSubstLeft</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftEnvSubst</span> <span class='hs-varid'>pFst</span>
<a name="line-1612"></a>
<a name="line-1613"></a><a name="liftEnvSubstRight"></a><span class='hs-definition'>liftEnvSubstRight</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftCoEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1614"></a><span class='hs-definition'>liftEnvSubstRight</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftEnvSubst</span> <span class='hs-varid'>pSnd</span>
<a name="line-1615"></a>
<a name="line-1616"></a><a name="liftEnvSubst"></a><span class='hs-definition'>liftEnvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-keyword'>forall</span> <span class='hs-varid'>a</span><span class='hs-varop'>.</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftCoEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1617"></a><span class='hs-definition'>liftEnvSubst</span> <span class='hs-varid'>selector</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>lc_env</span>
<a name="line-1618"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>composeTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>emptyInScopeSet</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span>
<a name="line-1619"></a>  <span class='hs-keyword'>where</span>
<a name="line-1620"></a>    <span class='hs-varid'>pairs</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nonDetUFMToList</span> <span class='hs-varid'>lc_env</span>
<a name="line-1621"></a>                       <span class='hs-comment'>-- It's OK to use nonDetUFMToList here because we</span>
<a name="line-1622"></a>                       <span class='hs-comment'>-- immediately forget the ordering by creating</span>
<a name="line-1623"></a>                       <span class='hs-comment'>-- a VarEnv</span>
<a name="line-1624"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tpairs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cpairs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionWith</span> <span class='hs-varid'>ty_or_co</span> <span class='hs-varid'>pairs</span>
<a name="line-1625"></a>    <span class='hs-varid'>tenv</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarEnv_Directly</span> <span class='hs-varid'>tpairs</span>
<a name="line-1626"></a>    <span class='hs-varid'>cenv</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarEnv_Directly</span> <span class='hs-varid'>cpairs</span>
<a name="line-1627"></a>
<a name="line-1628"></a>    <span class='hs-varid'>ty_or_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unique</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unique</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unique</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-1629"></a>    <span class='hs-varid'>ty_or_co</span> <span class='hs-layout'>(</span><span class='hs-varid'>u</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1630"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>equality_co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isCoercionTy_maybe</span> <span class='hs-varid'>equality_ty</span>
<a name="line-1631"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-varid'>u</span><span class='hs-layout'>,</span> <span class='hs-varid'>equality_co</span><span class='hs-layout'>)</span>
<a name="line-1632"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1633"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Left</span> <span class='hs-layout'>(</span><span class='hs-varid'>u</span><span class='hs-layout'>,</span> <span class='hs-varid'>equality_ty</span><span class='hs-layout'>)</span>
<a name="line-1634"></a>      <span class='hs-keyword'>where</span>
<a name="line-1635"></a>        <span class='hs-varid'>equality_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>selector</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1636"></a>
<a name="line-1637"></a><a name="lcTCvSubst"></a><span class='hs-comment'>-- | Extract the underlying substitution from the LiftingContext</span>
<a name="line-1638"></a><span class='hs-definition'>lcTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1639"></a><span class='hs-definition'>lcTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst</span>
<a name="line-1640"></a>
<a name="line-1641"></a><a name="lcInScopeSet"></a><span class='hs-comment'>-- | Get the 'InScopeSet' from a 'LiftingContext'</span>
<a name="line-1642"></a><span class='hs-definition'>lcInScopeSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InScopeSet</span>
<a name="line-1643"></a><span class='hs-definition'>lcInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getTCvInScope</span> <span class='hs-varid'>subst</span>
<a name="line-1644"></a>
<a name="line-1645"></a><span class='hs-comment'>{-
<a name="line-1646"></a>%************************************************************************
<a name="line-1647"></a>%*                                                                      *
<a name="line-1648"></a>            Sequencing on coercions
<a name="line-1649"></a>%*                                                                      *
<a name="line-1650"></a>%************************************************************************
<a name="line-1651"></a>-}</span>
<a name="line-1652"></a>
<a name="line-1653"></a><a name="seqCo"></a><span class='hs-definition'>seqCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-1654"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>ty</span>
<a name="line-1655"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCos</span> <span class='hs-varid'>cos</span>
<a name="line-1656"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co2</span>
<a name="line-1657"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>k</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>k</span>
<a name="line-1658"></a>                                                         <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-1659"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co2</span>
<a name="line-1660"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cv</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>()</span>
<a name="line-1661"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>ind</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCos</span> <span class='hs-varid'>cos</span>
<a name="line-1662"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-varid'>r</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-1663"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqProv</span> <span class='hs-varid'>p</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>r</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>t2</span>
<a name="line-1664"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-1665"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co2</span>
<a name="line-1666"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-1667"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lr</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-1668"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>arg</span>
<a name="line-1669"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoherenceCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co2</span>
<a name="line-1670"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-1671"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-1672"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCos</span> <span class='hs-varid'>cs</span>
<a name="line-1673"></a>
<a name="line-1674"></a><a name="seqProv"></a><span class='hs-definition'>seqProv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnivCoProvenance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-1675"></a><span class='hs-definition'>seqProv</span> <span class='hs-conid'>UnsafeCoerceProv</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-1676"></a><span class='hs-definition'>seqProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-1677"></a><span class='hs-definition'>seqProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-1678"></a><span class='hs-definition'>seqProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-1679"></a><span class='hs-definition'>seqProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-1680"></a>
<a name="line-1681"></a><a name="seqCos"></a><span class='hs-definition'>seqCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-1682"></a><span class='hs-definition'>seqCos</span> <span class='hs-conid'>[]</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-1683"></a><span class='hs-definition'>seqCos</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-conop'>:</span><span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCos</span> <span class='hs-varid'>cos</span>
<a name="line-1684"></a>
<a name="line-1685"></a><span class='hs-comment'>{-
<a name="line-1686"></a>%************************************************************************
<a name="line-1687"></a>%*                                                                      *
<a name="line-1688"></a>             The kind of a type, and of a coercion
<a name="line-1689"></a>%*                                                                      *
<a name="line-1690"></a>%************************************************************************
<a name="line-1691"></a>
<a name="line-1692"></a>Note [Computing a coercion kind and role]
<a name="line-1693"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1694"></a>To compute a coercion's kind is straightforward: see coercionKind.
<a name="line-1695"></a>But to compute a coercion's role, in the case for NthCo we need
<a name="line-1696"></a>its kind as well.  So if we have two separate functions (one for kinds
<a name="line-1697"></a>and one for roles) we can get exponentially bad behaviour, since each
<a name="line-1698"></a>NthCo node makes a separate call to coercionKind, which traverses the
<a name="line-1699"></a>sub-tree again.  This was part of the problem in Trac #9233.
<a name="line-1700"></a>
<a name="line-1701"></a>Solution: compute both together; hence coercionKindRole.  We keep a
<a name="line-1702"></a>separate coercionKind function because it's a bit more efficient if
<a name="line-1703"></a>the kind is all you want.
<a name="line-1704"></a>-}</span>
<a name="line-1705"></a>
<a name="line-1706"></a><a name="coercionType"></a><span class='hs-definition'>coercionType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1707"></a><span class='hs-definition'>coercionType</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>coercionKindRole</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>of</span>
<a name="line-1708"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkCoercionType</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1709"></a>
<a name="line-1710"></a><span class='hs-comment'>------------------</span>
<a name="line-1711"></a><span class='hs-comment'>-- | If it is the case that</span>
<a name="line-1712"></a><span class='hs-comment'>--</span>
<a name="line-1713"></a><span class='hs-comment'>-- &gt; c :: (t1 ~ t2)</span>
<a name="line-1714"></a><span class='hs-comment'>--</span>
<a name="line-1715"></a><span class='hs-comment'>-- i.e. the kind of @c@ relates @t1@ and @t2@, then @coercionKind c = Pair t1 t2@.</span>
<a name="line-1716"></a>
<a name="line-1717"></a><a name="coercionKind"></a><span class='hs-definition'>coercionKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span>
<a name="line-1718"></a><span class='hs-definition'>coercionKind</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-1719"></a>  <span class='hs-keyword'>where</span>
<a name="line-1720"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span>
<a name="line-1721"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>sequenceA</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-1722"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-1723"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>k_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1724"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-conid'>Pair</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>k2</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>k_co</span>
<a name="line-1725"></a>            <span class='hs-varid'>tv2</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setTyVarKind</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>k2</span>
<a name="line-1726"></a>            <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-1727"></a>            <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipTvSubst</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tv1</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv2</span> <span class='hs-varop'>`mk_cast_ty`</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>k_co</span><span class='hs-keyglyph'>]</span>
<a name="line-1728"></a>            <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyAddInScope</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty2</span> <span class='hs-keyword'>in</span>
<a name="line-1729"></a>            <span class='hs-comment'>-- We need free vars of ty2 in scope to satisfy the invariant</span>
<a name="line-1730"></a>            <span class='hs-comment'>-- from Note [The substitution invariant]</span>
<a name="line-1731"></a>            <span class='hs-comment'>-- This is doing repeated substitutions and probably doesn't</span>
<a name="line-1732"></a>            <span class='hs-comment'>-- need to, see #11735</span>
<a name="line-1733"></a>        <span class='hs-varid'>mkInvForAllTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>tv2</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2'</span>
<a name="line-1734"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-1735"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarTypes</span> <span class='hs-varid'>cv</span>
<a name="line-1736"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-1737"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_cvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cvs</span>
<a name="line-1738"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span>
<a name="line-1739"></a>      <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>tycos1</span> <span class='hs-varid'>tycos2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sequenceA</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-1740"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>tys1</span><span class='hs-layout'>,</span> <span class='hs-varid'>cotys1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAtList</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tycos1</span>
<a name="line-1741"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>tys2</span><span class='hs-layout'>,</span> <span class='hs-varid'>cotys2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAtList</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tycos2</span>
<a name="line-1742"></a>            <span class='hs-varid'>cos1</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>stripCoercionTy</span> <span class='hs-varid'>cotys1</span>
<a name="line-1743"></a>            <span class='hs-varid'>cos2</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>stripCoercionTy</span> <span class='hs-varid'>cotys2</span>
<a name="line-1744"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>cos</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-1745"></a>                  <span class='hs-comment'>-- Invariant of AxiomInstCo: cos should</span>
<a name="line-1746"></a>                  <span class='hs-comment'>-- exactly saturate the axiom branch</span>
<a name="line-1747"></a>        <span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTyWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys1</span> <span class='hs-varop'>$</span>
<a name="line-1748"></a>              <span class='hs-varid'>substTyWithCoVars</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos1</span> <span class='hs-varop'>$</span>
<a name="line-1749"></a>              <span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomTyCon</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span> <span class='hs-varid'>lhs</span><span class='hs-layout'>)</span>
<a name="line-1750"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>substTyWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys2</span> <span class='hs-varop'>$</span>
<a name="line-1751"></a>              <span class='hs-varid'>substTyWithCoVars</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos2</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-1752"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1753"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>swap</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-1754"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>pFst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>pSnd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1755"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>g</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>d</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1756"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>argss</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>traverse</span> <span class='hs-varid'>tyConAppArgs_maybe</span> <span class='hs-varid'>tys</span>
<a name="line-1757"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>and</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varop'>`lengthExceeds`</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>argss</span> <span class='hs-layout'>)</span>
<a name="line-1758"></a>        <span class='hs-layout'>(</span><span class='hs-varop'>`getNth`</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>argss</span>
<a name="line-1759"></a>
<a name="line-1760"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>d</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>
<a name="line-1761"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>splits</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>traverse</span> <span class='hs-varid'>splitForAllTy_maybe</span> <span class='hs-varid'>tys</span>
<a name="line-1762"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>splits</span>
<a name="line-1763"></a>
<a name="line-1764"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1765"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"coercionKind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>
<a name="line-1766"></a>      <span class='hs-keyword'>where</span>
<a name="line-1767"></a>        <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-1768"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>pickLR</span> <span class='hs-varid'>lr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>splitAppTy</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-1769"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>aco</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_app</span> <span class='hs-varid'>aco</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span>
<a name="line-1770"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoherenceCo</span> <span class='hs-varid'>g</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>
<a name="line-1771"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>g</span> <span class='hs-keyword'>in</span>
<a name="line-1772"></a>        <span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCastTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-1773"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-1774"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-1775"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"coercionKind"</span> <span class='hs-varop'>$</span>
<a name="line-1776"></a>                              <span class='hs-varid'>coaxrProves</span> <span class='hs-varid'>ax</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-1777"></a>
<a name="line-1778"></a>    <span class='hs-varid'>go_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span>
<a name="line-1779"></a>    <span class='hs-comment'>-- Collect up all the arguments and apply all at once</span>
<a name="line-1780"></a>    <span class='hs-comment'>-- See Note [Nested InstCos]</span>
<a name="line-1781"></a>    <span class='hs-varid'>go_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_app</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-1782"></a>    <span class='hs-varid'>go_app</span> <span class='hs-varid'>co</span>              <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>piResultTys</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>sequenceA</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-1783"></a>
<a name="line-1784"></a>    <span class='hs-comment'>-- The real mkCastTy is too slow, and we can easily have nested ForAllCos.</span>
<a name="line-1785"></a>    <span class='hs-varid'>mk_cast_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1786"></a>    <span class='hs-varid'>mk_cast_ty</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-1787"></a>    <span class='hs-varid'>mk_cast_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span>
<a name="line-1788"></a>
<a name="line-1789"></a><a name="coercionKinds"></a><span class='hs-comment'>-- | Apply 'coercionKind' to multiple 'Coercion's</span>
<a name="line-1790"></a><span class='hs-definition'>coercionKinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-1791"></a><span class='hs-definition'>coercionKinds</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sequenceA</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>tys</span>
<a name="line-1792"></a>
<a name="line-1793"></a><a name="coercionKindRole"></a><span class='hs-comment'>-- | Get a coercion's kind and role.</span>
<a name="line-1794"></a><span class='hs-comment'>-- Why both at once?  See Note [Computing a coercion kind and role]</span>
<a name="line-1795"></a><span class='hs-definition'>coercionKindRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Role</span><span class='hs-layout'>)</span>
<a name="line-1796"></a><span class='hs-definition'>coercionKindRole</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span>
<a name="line-1797"></a>  <span class='hs-keyword'>where</span>
<a name="line-1798"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-1799"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-1800"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>sequenceA</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-1801"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1802"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys1</span><span class='hs-layout'>,</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span> <span class='hs-keyword'>in</span>
<a name="line-1803"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>tys1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span>
<a name="line-1804"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>k_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1805"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-conid'>Pair</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>k2</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>k_co</span>
<a name="line-1806"></a>            <span class='hs-varid'>tv2</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setTyVarKind</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>k2</span>
<a name="line-1807"></a>            <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-1808"></a>            <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipTvSubst</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tv1</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv2</span> <span class='hs-varop'>`mkCastTy`</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>k_co</span><span class='hs-keyglyph'>]</span>
<a name="line-1809"></a>            <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyAddInScope</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty2</span> <span class='hs-keyword'>in</span>
<a name="line-1810"></a>            <span class='hs-comment'>-- We need free vars of ty2 in scope to satisfy the invariant</span>
<a name="line-1811"></a>            <span class='hs-comment'>-- from Note [The substitution invariant]</span>
<a name="line-1812"></a>            <span class='hs-comment'>-- This is doing repeated substitutions and probably doesn't</span>
<a name="line-1813"></a>            <span class='hs-comment'>-- need to, see #11735</span>
<a name="line-1814"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>mkInvForAllTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>tv2</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-1815"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1816"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-1817"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>coVarTypes</span> <span class='hs-varid'>cv</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarRole</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-1818"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>coAxiomRole</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span>
<a name="line-1819"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-1820"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>first</span> <span class='hs-varid'>swap</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-1821"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1822"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys1</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span> <span class='hs-keyword'>in</span>
<a name="line-1823"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>pFst</span> <span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>pSnd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-1824"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>d</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1825"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv1</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllTy_maybe</span> <span class='hs-varid'>ty1</span>
<a name="line-1826"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>d</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-layout'>)</span>
<a name="line-1827"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv2</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTy</span> <span class='hs-varid'>ty2</span> <span class='hs-keyword'>in</span>
<a name="line-1828"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>)</span>
<a name="line-1829"></a>
<a name="line-1830"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1831"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc1</span><span class='hs-layout'>,</span>  <span class='hs-varid'>args1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitTyConApp</span> <span class='hs-varid'>ty1</span>
<a name="line-1832"></a>            <span class='hs-layout'>(</span><span class='hs-sel'>_tc2</span><span class='hs-layout'>,</span> <span class='hs-varid'>args2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitTyConApp</span> <span class='hs-varid'>ty2</span>
<a name="line-1833"></a>        <span class='hs-keyword'>in</span>
<a name="line-1834"></a>        <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-sel'>_tc2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>d</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-sel'>_tc2</span> <span class='hs-layout'>)</span>
<a name="line-1835"></a>        <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>`getNth`</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>args1</span> <span class='hs-varid'>args2</span><span class='hs-layout'>,</span> <span class='hs-varid'>nthRole</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>
<a name="line-1836"></a>
<a name="line-1837"></a>      <span class='hs-keyword'>where</span>
<a name="line-1838"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-1839"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>)</span>
<a name="line-1840"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_app</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span>
<a name="line-1841"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoherenceCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1842"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span> <span class='hs-keyword'>in</span>
<a name="line-1843"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>t1</span> <span class='hs-varop'>`mkCastTy`</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-varid'>t2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-1844"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>)</span>
<a name="line-1845"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-conid'>Representational</span><span class='hs-layout'>)</span>
<a name="line-1846"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>ax</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>coaxrRole</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span>
<a name="line-1847"></a>
<a name="line-1848"></a>    <span class='hs-varid'>go_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Role</span><span class='hs-layout'>)</span>
<a name="line-1849"></a>    <span class='hs-comment'>-- Collect up all the arguments and apply all at once</span>
<a name="line-1850"></a>    <span class='hs-comment'>-- See Note [Nested InstCos]</span>
<a name="line-1851"></a>    <span class='hs-varid'>go_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_app</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-1852"></a>    <span class='hs-varid'>go_app</span> <span class='hs-varid'>co</span>              <span class='hs-varid'>args</span>
<a name="line-1853"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>pair</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>in</span>
<a name="line-1854"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>piResultTys</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>pair</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>sequenceA</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-1855"></a>
<a name="line-1856"></a><a name="coercionRole"></a><span class='hs-comment'>-- | Retrieve the role from a coercion.</span>
<a name="line-1857"></a><span class='hs-definition'>coercionRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>
<a name="line-1858"></a><span class='hs-definition'>coercionRole</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>.</span> <span class='hs-varid'>coercionKindRole</span>
<a name="line-1859"></a>  <span class='hs-comment'>-- There's not a better way to do this, because NthCo needs the *kind*</span>
<a name="line-1860"></a>  <span class='hs-comment'>-- and role of its argument. Luckily, laziness should generally avoid</span>
<a name="line-1861"></a>  <span class='hs-comment'>-- the need for computing kinds in other cases.</span>
<a name="line-1862"></a>
<a name="line-1863"></a><span class='hs-comment'>{-
<a name="line-1864"></a>Note [Nested InstCos]
<a name="line-1865"></a>~~~~~~~~~~~~~~~~~~~~~
<a name="line-1866"></a>In Trac #5631 we found that 70% of the entire compilation time was
<a name="line-1867"></a>being spent in coercionKind!  The reason was that we had
<a name="line-1868"></a>   (g @ ty1 @ ty2 .. @ ty100)    -- The "@s" are InstCos
<a name="line-1869"></a>where
<a name="line-1870"></a>   g :: forall a1 a2 .. a100. phi
<a name="line-1871"></a>If we deal with the InstCos one at a time, we'll do this:
<a name="line-1872"></a>   1.  Find the kind of (g @ ty1 .. @ ty99) : forall a100. phi'
<a name="line-1873"></a>   2.  Substitute phi'[ ty100/a100 ], a single tyvar-&gt;type subst
<a name="line-1874"></a>But this is a *quadratic* algorithm, and the blew up Trac #5631.
<a name="line-1875"></a>So it's very important to do the substitution simultaneously;
<a name="line-1876"></a>cf Type.piResultTys (which in fact we call here).
<a name="line-1877"></a>
<a name="line-1878"></a>-}</span>
</pre></body>
</html>
