<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcHsType.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The University of Glasgow 2006
<a name="line-3"></a>(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
<a name="line-4"></a>
<a name="line-5"></a>\section[TcMonoType]{Typechecking user-specified @MonoTypes@}
<a name="line-6"></a>-}</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-comment'>{-# LANGUAGE CPP, TupleSections, MultiWayIf, RankNTypes #-}</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcHsType</span> <span class='hs-layout'>(</span>
<a name="line-11"></a>        <span class='hs-comment'>-- Type signatures</span>
<a name="line-12"></a>        <span class='hs-varid'>kcHsSigType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcClassSigType</span><span class='hs-layout'>,</span>
<a name="line-13"></a>        <span class='hs-varid'>tcHsSigType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsSigWcType</span><span class='hs-layout'>,</span>
<a name="line-14"></a>        <span class='hs-varid'>tcHsPartialSigType</span><span class='hs-layout'>,</span>
<a name="line-15"></a>        <span class='hs-varid'>funsSigCtxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>addSigCtxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprSigCtxt</span><span class='hs-layout'>,</span>
<a name="line-16"></a>
<a name="line-17"></a>        <span class='hs-varid'>tcHsClsInstType</span><span class='hs-layout'>,</span>
<a name="line-18"></a>        <span class='hs-varid'>tcHsDeriv</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsVectInst</span><span class='hs-layout'>,</span>
<a name="line-19"></a>        <span class='hs-varid'>tcHsTypeApp</span><span class='hs-layout'>,</span>
<a name="line-20"></a>        <span class='hs-conid'>UserTypeCtxt</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-21"></a>        <span class='hs-varid'>tcImplicitTKBndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcImplicitTKBndrsType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcExplicitTKBndrs</span><span class='hs-layout'>,</span>
<a name="line-22"></a>
<a name="line-23"></a>                <span class='hs-comment'>-- Type checking type and class decls</span>
<a name="line-24"></a>        <span class='hs-varid'>kcLookupTcTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>kcTyClTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcTyClTyVars</span><span class='hs-layout'>,</span>
<a name="line-25"></a>        <span class='hs-varid'>tcDataKindSig</span><span class='hs-layout'>,</span>
<a name="line-26"></a>
<a name="line-27"></a>        <span class='hs-comment'>-- Kind-checking types</span>
<a name="line-28"></a>        <span class='hs-comment'>-- No kind generalisation, no checkValidType</span>
<a name="line-29"></a>        <span class='hs-varid'>tcWildCardBinders</span><span class='hs-layout'>,</span>
<a name="line-30"></a>        <span class='hs-varid'>kcHsTyVarBndrs</span><span class='hs-layout'>,</span>
<a name="line-31"></a>        <span class='hs-varid'>tcHsLiftedType</span><span class='hs-layout'>,</span>   <span class='hs-varid'>tcHsOpenType</span><span class='hs-layout'>,</span>
<a name="line-32"></a>        <span class='hs-varid'>tcHsLiftedTypeNC</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsOpenTypeNC</span><span class='hs-layout'>,</span>
<a name="line-33"></a>        <span class='hs-varid'>tcLHsType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcCheckLHsType</span><span class='hs-layout'>,</span>
<a name="line-34"></a>        <span class='hs-varid'>tcHsContext</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcLHsPredType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInferApps</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcTyApps</span><span class='hs-layout'>,</span>
<a name="line-35"></a>        <span class='hs-varid'>solveEqualities</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- useful re-export</span>
<a name="line-36"></a>
<a name="line-37"></a>        <span class='hs-varid'>typeLevelMode</span><span class='hs-layout'>,</span> <span class='hs-varid'>kindLevelMode</span><span class='hs-layout'>,</span>
<a name="line-38"></a>
<a name="line-39"></a>        <span class='hs-varid'>kindGeneralize</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkExpectedKindX</span><span class='hs-layout'>,</span> <span class='hs-varid'>instantiateTyUntilN</span><span class='hs-layout'>,</span>
<a name="line-40"></a>
<a name="line-41"></a>        <span class='hs-varid'>reportFloatingKvs</span><span class='hs-layout'>,</span>
<a name="line-42"></a>
<a name="line-43"></a>        <span class='hs-comment'>-- Sort-checking kinds</span>
<a name="line-44"></a>        <span class='hs-varid'>tcLHsKindSig</span><span class='hs-layout'>,</span>
<a name="line-45"></a>
<a name="line-46"></a>        <span class='hs-comment'>-- Pattern type signatures</span>
<a name="line-47"></a>        <span class='hs-varid'>tcHsPatSigType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcPatSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>funAppCtxt</span>
<a name="line-48"></a>   <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-49"></a>
<a name="line-50"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-51"></a>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcValidity</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcUnify</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcIface</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcSimplify</span> <span class='hs-layout'>(</span> <span class='hs-varid'>solveEqualities</span> <span class='hs-layout'>)</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcHsSyn</span><span class='hs-layout'>(</span> <span class='hs-varid'>zonkSigType</span> <span class='hs-layout'>)</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Inst</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>tcInstBinders</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInstBinder</span> <span class='hs-layout'>)</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Kind</span>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>(</span> <span class='hs-varid'>lookupLocalRdrOcc</span> <span class='hs-layout'>)</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ConLike</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameEnv</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-77"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-79"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-80"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Constants</span> <span class='hs-layout'>(</span> <span class='hs-varid'>mAX_CTUPLE_SIZE</span> <span class='hs-layout'>)</span>
<a name="line-81"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span><span class='hs-layout'>(</span> <span class='hs-conid'>MsgDoc</span> <span class='hs-layout'>)</span>
<a name="line-82"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-83"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-84"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-85"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-86"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-87"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-varid'>wildCardName</span> <span class='hs-layout'>)</span>
<a name="line-88"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>LanguageExtensions</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>LangExt</span>
<a name="line-89"></a>
<a name="line-90"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-91"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span> <span class='hs-layout'>(</span> <span class='hs-varid'>partition</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipWith4</span> <span class='hs-layout'>)</span>
<a name="line-92"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-93"></a>
<a name="line-94"></a><span class='hs-comment'>{-
<a name="line-95"></a>        ----------------------------
<a name="line-96"></a>                General notes
<a name="line-97"></a>        ----------------------------
<a name="line-98"></a>
<a name="line-99"></a>Unlike with expressions, type-checking types both does some checking and
<a name="line-100"></a>desugars at the same time. This is necessary because we often want to perform
<a name="line-101"></a>equality checks on the types right away, and it would be incredibly painful
<a name="line-102"></a>to do this on un-desugared types. Luckily, desugared types are close enough
<a name="line-103"></a>to HsTypes to make the error messages sane.
<a name="line-104"></a>
<a name="line-105"></a>During type-checking, we perform as little validity checking as possible.
<a name="line-106"></a>This is because some type-checking is done in a mutually-recursive knot, and
<a name="line-107"></a>if we look too closely at the tycons, we'll loop. This is why we always must
<a name="line-108"></a>use mkNakedTyConApp and mkNakedAppTys, etc., which never look at a tycon.
<a name="line-109"></a>The mkNamed... functions don't uphold Type invariants, but zonkTcTypeToType
<a name="line-110"></a>will repair this for us. Note that zonkTcType *is* safe within a knot, and
<a name="line-111"></a>can be done repeatedly with no ill effect: it just squeezes out metavariables.
<a name="line-112"></a>
<a name="line-113"></a>Generally, after type-checking, you will want to do validity checking, say
<a name="line-114"></a>with TcValidity.checkValidType.
<a name="line-115"></a>
<a name="line-116"></a>Validity checking
<a name="line-117"></a>~~~~~~~~~~~~~~~~~
<a name="line-118"></a>Some of the validity check could in principle be done by the kind checker,
<a name="line-119"></a>but not all:
<a name="line-120"></a>
<a name="line-121"></a>- During desugaring, we normalise by expanding type synonyms.  Only
<a name="line-122"></a>  after this step can we check things like type-synonym saturation
<a name="line-123"></a>  e.g.  type T k = k Int
<a name="line-124"></a>        type S a = a
<a name="line-125"></a>  Then (T S) is ok, because T is saturated; (T S) expands to (S Int);
<a name="line-126"></a>  and then S is saturated.  This is a GHC extension.
<a name="line-127"></a>
<a name="line-128"></a>- Similarly, also a GHC extension, we look through synonyms before complaining
<a name="line-129"></a>  about the form of a class or instance declaration
<a name="line-130"></a>
<a name="line-131"></a>- Ambiguity checks involve functional dependencies, and it's easier to wait
<a name="line-132"></a>  until knots have been resolved before poking into them
<a name="line-133"></a>
<a name="line-134"></a>Also, in a mutually recursive group of types, we can't look at the TyCon until we've
<a name="line-135"></a>finished building the loop.  So to keep things simple, we postpone most validity
<a name="line-136"></a>checking until step (3).
<a name="line-137"></a>
<a name="line-138"></a>Knot tying
<a name="line-139"></a>~~~~~~~~~~
<a name="line-140"></a>During step (1) we might fault in a TyCon defined in another module, and it might
<a name="line-141"></a>(via a loop) refer back to a TyCon defined in this module. So when we tie a big
<a name="line-142"></a>knot around type declarations with ARecThing, so that the fault-in code can get
<a name="line-143"></a>the TyCon being defined.
<a name="line-144"></a>
<a name="line-145"></a>%************************************************************************
<a name="line-146"></a>%*                                                                      *
<a name="line-147"></a>              Check types AND do validity checking
<a name="line-148"></a>*                                                                      *
<a name="line-149"></a>************************************************************************
<a name="line-150"></a>-}</span>
<a name="line-151"></a>
<a name="line-152"></a><a name="funsSigCtxt"></a><span class='hs-definition'>funsSigCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UserTypeCtxt</span>
<a name="line-153"></a><span class='hs-comment'>-- Returns FunSigCtxt, with no redundant-context-reporting,</span>
<a name="line-154"></a><span class='hs-comment'>-- form a list of located names</span>
<a name="line-155"></a><span class='hs-definition'>funsSigCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name1</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>name1</span> <span class='hs-conid'>False</span>
<a name="line-156"></a><span class='hs-definition'>funsSigCtxt</span> <span class='hs-conid'>[]</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"funSigCtxt"</span>
<a name="line-157"></a>
<a name="line-158"></a><a name="addSigCtxt"></a><span class='hs-definition'>addSigCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-159"></a><span class='hs-definition'>addSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-160"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-161"></a>    <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-162"></a>    <span class='hs-varid'>thing_inside</span>
<a name="line-163"></a>
<a name="line-164"></a><a name="pprSigCtxt"></a><span class='hs-definition'>pprSigCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-165"></a><span class='hs-comment'>-- (pprSigCtxt ctxt &lt;extra&gt; &lt;type&gt;)</span>
<a name="line-166"></a><span class='hs-comment'>-- prints    In the type signature for 'f':</span>
<a name="line-167"></a><span class='hs-comment'>--              f :: &lt;type&gt;</span>
<a name="line-168"></a><span class='hs-comment'>-- The &lt;extra&gt; is either empty or "the ambiguity check for"</span>
<a name="line-169"></a><span class='hs-definition'>pprSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span>
<a name="line-170"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isSigMaybe</span> <span class='hs-varid'>ctxt</span>
<a name="line-171"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"In the type signature:"</span><span class='hs-layout'>)</span>
<a name="line-172"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprPrefixOcc</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-173"></a>
<a name="line-174"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-175"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"In"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprUserTypeCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span><span class='hs-layout'>)</span>
<a name="line-176"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-177"></a>
<a name="line-178"></a><a name="tcHsSigWcType"></a><span class='hs-definition'>tcHsSigWcType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigWcType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-179"></a><span class='hs-comment'>-- This one is used when we have a LHsSigWcType, but in</span>
<a name="line-180"></a><span class='hs-comment'>-- a place where wildards aren't allowed. The renamer has</span>
<a name="line-181"></a><span class='hs-comment'>-- already checked this, so we can simply ignore it.</span>
<a name="line-182"></a><span class='hs-definition'>tcHsSigWcType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcHsSigType</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>dropWildCards</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span>
<a name="line-183"></a>
<a name="line-184"></a><a name="kcHsSigType"></a><span class='hs-definition'>kcHsSigType</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-185"></a><span class='hs-definition'>kcHsSigType</span> <span class='hs-varid'>names</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsib_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_ty</span>
<a name="line-186"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>hsib_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_vars</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-187"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addSigCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>funsSigCtxt</span> <span class='hs-varid'>names</span><span class='hs-layout'>)</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varop'>$</span>
<a name="line-188"></a>    <span class='hs-varid'>discardResult</span> <span class='hs-varop'>$</span>
<a name="line-189"></a>    <span class='hs-varid'>tcImplicitTKBndrsType</span> <span class='hs-varid'>sig_vars</span> <span class='hs-varop'>$</span>
<a name="line-190"></a>    <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>typeLevelMode</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-191"></a>
<a name="line-192"></a><a name="tcClassSigType"></a><span class='hs-definition'>tcClassSigType</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-193"></a><span class='hs-comment'>-- Does not do validity checking; this must be done outside</span>
<a name="line-194"></a><span class='hs-comment'>-- the recursive class declaration "knot"</span>
<a name="line-195"></a><span class='hs-definition'>tcClassSigType</span> <span class='hs-varid'>names</span> <span class='hs-varid'>sig_ty</span>
<a name="line-196"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addSigCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>funsSigCtxt</span> <span class='hs-varid'>names</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsSigType</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-197"></a>    <span class='hs-varid'>tc_hs_sig_type_and_gen</span> <span class='hs-varid'>sig_ty</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-198"></a>
<a name="line-199"></a><a name="tcHsSigType"></a><span class='hs-definition'>tcHsSigType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-200"></a><span class='hs-comment'>-- Does validity checking</span>
<a name="line-201"></a><span class='hs-definition'>tcHsSigType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig_ty</span>
<a name="line-202"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsSigType</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-203"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>expectedKindInCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-204"></a>                    <span class='hs-conid'>AnythingKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-205"></a>                    <span class='hs-conid'>TheKind</span> <span class='hs-varid'>k</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>k</span>
<a name="line-206"></a>                    <span class='hs-conid'>OpenKind</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newOpenTypeKind</span>
<a name="line-207"></a>              <span class='hs-comment'>-- The kind is checked by checkValidType, and isn't necessarily</span>
<a name="line-208"></a>              <span class='hs-comment'>-- of kind * in a Template Haskell quote eg [t| Maybe |]</span>
<a name="line-209"></a>
<a name="line-210"></a>          <span class='hs-comment'>-- Generalise here: see Note [Kind generalisation]</span>
<a name="line-211"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>do_kind_gen</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>decideKindGeneralisationPlan</span> <span class='hs-varid'>sig_ty</span>
<a name="line-212"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>do_kind_gen</span>
<a name="line-213"></a>               <span class='hs-keyword'>then</span> <span class='hs-varid'>tc_hs_sig_type_and_gen</span> <span class='hs-varid'>sig_ty</span> <span class='hs-varid'>kind</span>
<a name="line-214"></a>               <span class='hs-keyword'>else</span> <span class='hs-varid'>tc_hs_sig_type</span>         <span class='hs-varid'>sig_ty</span> <span class='hs-varid'>kind</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>zonkTcType</span>
<a name="line-215"></a>
<a name="line-216"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty</span>
<a name="line-217"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-218"></a>
<a name="line-219"></a><a name="tc_hs_sig_type_and_gen"></a><span class='hs-definition'>tc_hs_sig_type_and_gen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-220"></a><span class='hs-comment'>-- Kind-checks/desugars an 'LHsSigType',</span>
<a name="line-221"></a><span class='hs-comment'>--   solve equalities,</span>
<a name="line-222"></a><span class='hs-comment'>--   and then kind-generalizes.</span>
<a name="line-223"></a><span class='hs-comment'>-- This will never emit constraints, as it uses solveEqualities interally.</span>
<a name="line-224"></a><span class='hs-comment'>-- No validity checking, but it does zonk en route to generalization</span>
<a name="line-225"></a><span class='hs-definition'>tc_hs_sig_type_and_gen</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>kind</span>
<a name="line-226"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>solveEqualities</span> <span class='hs-varop'>$</span>
<a name="line-227"></a>               <span class='hs-varid'>tc_hs_sig_type</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>kind</span>
<a name="line-228"></a>         <span class='hs-comment'>-- NB the call to solveEqualities, which unifies all those</span>
<a name="line-229"></a>         <span class='hs-comment'>--    kind variables floating about, immediately prior to</span>
<a name="line-230"></a>         <span class='hs-comment'>--    kind generalisation</span>
<a name="line-231"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kindGeneralizeType</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-232"></a>
<a name="line-233"></a><a name="tc_hs_sig_type"></a><span class='hs-definition'>tc_hs_sig_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-234"></a><span class='hs-comment'>-- Kind-check/desugar a 'LHsSigType', but does not solve</span>
<a name="line-235"></a><span class='hs-comment'>-- the equalities that arise from doing so; instead it may</span>
<a name="line-236"></a><span class='hs-comment'>-- emit kind-equality constraints into the monad</span>
<a name="line-237"></a><span class='hs-comment'>-- No zonking or validity checking</span>
<a name="line-238"></a><span class='hs-definition'>tc_hs_sig_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsib_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_vars</span>
<a name="line-239"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>hsib_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind</span>
<a name="line-240"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tkvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcImplicitTKBndrsType</span> <span class='hs-varid'>sig_vars</span> <span class='hs-varop'>$</span>
<a name="line-241"></a>                       <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>typeLevelMode</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>kind</span>
<a name="line-242"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSpecForAllTys</span> <span class='hs-varid'>tkvs</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-243"></a>
<a name="line-244"></a><a name="tcHsDeriv"></a><span class='hs-comment'>-----------------</span>
<a name="line-245"></a><span class='hs-definition'>tcHsDeriv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Kind</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-246"></a><span class='hs-comment'>-- Like tcHsSigType, but for the ...deriving( C t1 ty2 ) clause</span>
<a name="line-247"></a><span class='hs-comment'>-- Returns the C, [ty1, ty2, and the kinds of C's remaining arguments</span>
<a name="line-248"></a><span class='hs-comment'>-- E.g.    class C (a::*) (b::k-&gt;k)</span>
<a name="line-249"></a><span class='hs-comment'>--         data T a b = ... deriving( C Int )</span>
<a name="line-250"></a><span class='hs-comment'>--    returns ([k], C, [k, Int], [k-&gt;k])</span>
<a name="line-251"></a><span class='hs-definition'>tcHsDeriv</span> <span class='hs-varid'>hs_ty</span>
<a name="line-252"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cls_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-253"></a>                    <span class='hs-comment'>-- always safe to kind-generalize, because there</span>
<a name="line-254"></a>                    <span class='hs-comment'>-- can be no covars in an outer scope</span>
<a name="line-255"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span>
<a name="line-256"></a>                 <span class='hs-comment'>-- avoid redundant error report with "illegal deriving", below</span>
<a name="line-257"></a>               <span class='hs-varid'>tc_hs_sig_type_and_gen</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>cls_kind</span>
<a name="line-258"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>cls_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>cls_kind</span>
<a name="line-259"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTys</span> <span class='hs-varid'>ty</span>
<a name="line-260"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitFunTys</span> <span class='hs-varid'>cls_kind</span>
<a name="line-261"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>getClassPredTys_maybe</span> <span class='hs-varid'>pred</span> <span class='hs-keyword'>of</span>
<a name="line-262"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-263"></a>           <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Illegal deriving item"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-264"></a>
<a name="line-265"></a><a name="tcHsClsInstType"></a><span class='hs-definition'>tcHsClsInstType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span>    <span class='hs-comment'>-- InstDeclCtxt or SpecInstCtxt</span>
<a name="line-266"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span>
<a name="line-267"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-268"></a><span class='hs-comment'>-- Like tcHsSigType, but for a class instance declaration</span>
<a name="line-269"></a><span class='hs-definition'>tcHsClsInstType</span> <span class='hs-varid'>user_ctxt</span> <span class='hs-varid'>hs_inst_ty</span>
<a name="line-270"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsSigType</span> <span class='hs-varid'>hs_inst_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-271"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inst_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_hs_sig_type_and_gen</span> <span class='hs-varid'>hs_inst_ty</span> <span class='hs-varid'>constraintKind</span>
<a name="line-272"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidInstance</span> <span class='hs-varid'>user_ctxt</span> <span class='hs-varid'>hs_inst_ty</span> <span class='hs-varid'>inst_ty</span> <span class='hs-layout'>}</span>
<a name="line-273"></a>
<a name="line-274"></a><a name="tcHsVectInst"></a><span class='hs-comment'>-- Used for 'VECTORISE [SCALAR] instance' declarations</span>
<a name="line-275"></a><span class='hs-definition'>tcHsVectInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-276"></a><span class='hs-definition'>tcHsVectInst</span> <span class='hs-varid'>ty</span>
<a name="line-277"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>hs_cls_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsSigType</span> <span class='hs-varid'>ty</span>
<a name="line-278"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cls_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hsTyGetAppHead_maybe</span> <span class='hs-varid'>hs_cls_ty</span>
<a name="line-279"></a>    <span class='hs-comment'>-- Ignoring the binders looks pretty dodgy to me</span>
<a name="line-280"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>cls_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcClass</span> <span class='hs-varid'>cls_name</span>
<a name="line-281"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>applied_class</span><span class='hs-layout'>,</span> <span class='hs-sel'>_res_kind</span><span class='hs-layout'>)</span>
<a name="line-282"></a>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyApps</span> <span class='hs-varid'>typeLevelMode</span> <span class='hs-varid'>hs_cls_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>cls_kind</span> <span class='hs-varid'>tys</span>
<a name="line-283"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>applied_class</span> <span class='hs-keyword'>of</span>
<a name="line-284"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-sel'>_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-sel'>_tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>classTyCon</span> <span class='hs-varid'>cls</span> <span class='hs-layout'>)</span>
<a name="line-285"></a>                               <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-286"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Too many arguments passed to"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cls_name</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-287"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-288"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Malformed instance type"</span>
<a name="line-289"></a>
<a name="line-290"></a><a name="tcHsTypeApp"></a><span class='hs-comment'>----------------------------------------------</span>
<a name="line-291"></a><span class='hs-comment'>-- | Type-check a visible type application</span>
<a name="line-292"></a><span class='hs-definition'>tcHsTypeApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsWcType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-293"></a><span class='hs-definition'>tcHsTypeApp</span> <span class='hs-varid'>wc_ty</span> <span class='hs-varid'>kind</span>
<a name="line-294"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HsWC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hswc_wcs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>hswc_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wc_ty</span>
<a name="line-295"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcWildCardBindersX</span> <span class='hs-varid'>newWildTyVar</span> <span class='hs-varid'>sig_wcs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-296"></a>               <span class='hs-varid'>tcCheckLHsType</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>kind</span>
<a name="line-297"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty</span>
<a name="line-298"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-conid'>TypeAppCtxt</span> <span class='hs-varid'>ty</span>
<a name="line-299"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-300"></a>        <span class='hs-comment'>-- NB: we don't call emitWildcardHoleConstraints here, because</span>
<a name="line-301"></a>        <span class='hs-comment'>-- we want any holes in visible type applications to be used</span>
<a name="line-302"></a>        <span class='hs-comment'>-- without fuss. No errors, warnings, extensions, etc.</span>
<a name="line-303"></a>
<a name="line-304"></a><span class='hs-comment'>{-
<a name="line-305"></a>************************************************************************
<a name="line-306"></a>*                                                                      *
<a name="line-307"></a>            The main kind checker: no validity checks here
<a name="line-308"></a>*                                                                      *
<a name="line-309"></a>************************************************************************
<a name="line-310"></a>
<a name="line-311"></a>        First a couple of simple wrappers for kcHsType
<a name="line-312"></a>-}</span>
<a name="line-313"></a>
<a name="line-314"></a><a name="tcHsOpenType"></a><span class='hs-comment'>---------------------------</span>
<a name="line-315"></a><span class='hs-definition'>tcHsOpenType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsLiftedType</span><span class='hs-layout'>,</span>
<a name="line-316"></a>  <span class='hs-varid'>tcHsOpenTypeNC</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsLiftedTypeNC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-317"></a><span class='hs-comment'>-- Used for type signatures</span>
<a name="line-318"></a><span class='hs-comment'>-- Do not do validity checking</span>
<a name="line-319"></a><span class='hs-definition'>tcHsOpenType</span> <span class='hs-varid'>ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcHsOpenTypeNC</span> <span class='hs-varid'>ty</span>
<a name="line-320"></a><a name="tcHsLiftedType"></a><span class='hs-definition'>tcHsLiftedType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcHsLiftedTypeNC</span> <span class='hs-varid'>ty</span>
<a name="line-321"></a>
<a name="line-322"></a><a name="tcHsOpenTypeNC"></a><span class='hs-definition'>tcHsOpenTypeNC</span>   <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newOpenTypeKind</span>
<a name="line-323"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>typeLevelMode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ek</span> <span class='hs-layout'>}</span>
<a name="line-324"></a><a name="tcHsLiftedTypeNC"></a><span class='hs-definition'>tcHsLiftedTypeNC</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>typeLevelMode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-325"></a>
<a name="line-326"></a><a name="tcCheckLHsType"></a><span class='hs-comment'>-- Like tcHsType, but takes an expected kind</span>
<a name="line-327"></a><span class='hs-definition'>tcCheckLHsType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-328"></a><span class='hs-definition'>tcCheckLHsType</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-329"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varop'>$</span>
<a name="line-330"></a>    <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>typeLevelMode</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-331"></a>
<a name="line-332"></a><a name="tcLHsType"></a><span class='hs-definition'>tcLHsType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-333"></a><span class='hs-comment'>-- Called from outside: set the context</span>
<a name="line-334"></a><span class='hs-definition'>tcLHsType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>typeLevelMode</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-335"></a>
<a name="line-336"></a><a name="decideKindGeneralisationPlan"></a><span class='hs-comment'>---------------------------</span>
<a name="line-337"></a><span class='hs-comment'>-- | Should we generalise the kind of this type signature?</span>
<a name="line-338"></a><span class='hs-comment'>-- We *should* generalise if the type is closed</span>
<a name="line-339"></a><span class='hs-comment'>-- or if NoMonoLocalBinds is set. Otherwise, nope.</span>
<a name="line-340"></a><span class='hs-comment'>-- See Note [Kind generalisation plan]</span>
<a name="line-341"></a><span class='hs-definition'>decideKindGeneralisationPlan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Bool</span>
<a name="line-342"></a><span class='hs-definition'>decideKindGeneralisationPlan</span> <span class='hs-varid'>sig_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsIB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsib_closed</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closed</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-343"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mono_locals</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>MonoLocalBinds</span>
<a name="line-344"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>should_gen</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varid'>mono_locals</span> <span class='hs-varop'>||</span> <span class='hs-varid'>closed</span>
<a name="line-345"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"decideKindGeneralisationPlan"</span>
<a name="line-346"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sig_ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"should gen?"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>should_gen</span><span class='hs-layout'>)</span>
<a name="line-347"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>should_gen</span> <span class='hs-layout'>}</span>
<a name="line-348"></a>
<a name="line-349"></a><span class='hs-comment'>{- Note [Kind generalisation plan]
<a name="line-350"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-351"></a>When should we do kind-generalisation for user-written type signature?
<a name="line-352"></a>Answer: we use the same rule as for value bindings:
<a name="line-353"></a>
<a name="line-354"></a> * We always kind-generalise if the type signature is closed
<a name="line-355"></a> * Additionally, we attempt to generalise if we have NoMonoLocalBinds
<a name="line-356"></a>
<a name="line-357"></a>Trac #13337 shows the problem if we kind-generalise an open type (i.e.
<a name="line-358"></a>one that mentions in-scope tpe variable
<a name="line-359"></a>  foo :: forall k (a :: k) proxy. (Typeable k, Typeable a)
<a name="line-360"></a>      =&gt; proxy a -&gt; String
<a name="line-361"></a>  foo _ = case eqT :: Maybe (k :~: Type) of
<a name="line-362"></a>            Nothing   -&gt; ...
<a name="line-363"></a>            Just Refl -&gt; case eqT :: Maybe (a :~: Int) of ...
<a name="line-364"></a>
<a name="line-365"></a>In the expression type sig on the last line, we have (a :: k)
<a name="line-366"></a>but (Int :: Type).  Since (:~:) is kind-homogeneous, this requires
<a name="line-367"></a>k ~ *, which is true in the Refl branch of the outer case.
<a name="line-368"></a>
<a name="line-369"></a>That equality will be solved if we allow it to float out to the
<a name="line-370"></a>implication constraint for the Refl match, bnot not if we aggressively
<a name="line-371"></a>attempt to solve all equalities the moment they occur; that is, when
<a name="line-372"></a>checking (Maybe (a :~: Int)).   (NB: solveEqualities fails unless it
<a name="line-373"></a>solves all the kind equalities, which is the right thing at top level.)
<a name="line-374"></a>
<a name="line-375"></a>So here the right thing is simply not to do kind generalisation!
<a name="line-376"></a>
<a name="line-377"></a>************************************************************************
<a name="line-378"></a>*                                                                      *
<a name="line-379"></a>      Type-checking modes
<a name="line-380"></a>*                                                                      *
<a name="line-381"></a>************************************************************************
<a name="line-382"></a>
<a name="line-383"></a>The kind-checker is parameterised by a TcTyMode, which contains some
<a name="line-384"></a>information about where we're checking a type.
<a name="line-385"></a>
<a name="line-386"></a>The renamer issues errors about what it can. All errors issued here must
<a name="line-387"></a>concern things that the renamer can't handle.
<a name="line-388"></a>
<a name="line-389"></a>-}</span>
<a name="line-390"></a>
<a name="line-391"></a><a name="TcTyMode"></a><span class='hs-comment'>-- | Info about the context in which we're checking a type. Currently,</span>
<a name="line-392"></a><a name="TcTyMode"></a><span class='hs-comment'>-- differentiates only between types and kinds, but this will likely</span>
<a name="line-393"></a><a name="TcTyMode"></a><span class='hs-comment'>-- grow, at least to include the distinction between patterns and</span>
<a name="line-394"></a><a name="TcTyMode"></a><span class='hs-comment'>-- not-patterns.</span>
<a name="line-395"></a><a name="TcTyMode"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>TcTyMode</span>
<a name="line-396"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mode_level</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeOrKind</span>  <span class='hs-comment'>-- True &lt;=&gt; type, False &lt;=&gt; kind</span>
<a name="line-397"></a>             <span class='hs-layout'>}</span>
<a name="line-398"></a>
<a name="line-399"></a><a name="typeLevelMode"></a><span class='hs-definition'>typeLevelMode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span>
<a name="line-400"></a><span class='hs-definition'>typeLevelMode</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mode_level</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeLevel</span> <span class='hs-layout'>}</span>
<a name="line-401"></a>
<a name="line-402"></a><a name="kindLevelMode"></a><span class='hs-definition'>kindLevelMode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span>
<a name="line-403"></a><span class='hs-definition'>kindLevelMode</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mode_level</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>KindLevel</span> <span class='hs-layout'>}</span>
<a name="line-404"></a>
<a name="line-405"></a><a name="kindLevel"></a><span class='hs-comment'>-- switch to kind level</span>
<a name="line-406"></a><span class='hs-definition'>kindLevel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyMode</span>
<a name="line-407"></a><span class='hs-definition'>kindLevel</span> <span class='hs-varid'>mode</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mode_level</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>KindLevel</span> <span class='hs-layout'>}</span>
<a name="line-408"></a>
<a name="line-409"></a><a name="instance%20Outputable%20TcTyMode"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyword'>where</span>
<a name="line-410"></a>  <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mode_level</span>
<a name="line-411"></a>
<a name="line-412"></a><span class='hs-comment'>{-
<a name="line-413"></a>Note [Bidirectional type checking]
<a name="line-414"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-415"></a>In expressions, whenever we see a polymorphic identifier, say `id`, we are
<a name="line-416"></a>free to instantiate it with metavariables, knowing that we can always
<a name="line-417"></a>re-generalize with type-lambdas when necessary. For example:
<a name="line-418"></a>
<a name="line-419"></a>  rank2 :: (forall a. a -&gt; a) -&gt; ()
<a name="line-420"></a>  x = rank2 id
<a name="line-421"></a>
<a name="line-422"></a>When checking the body of `x`, we can instantiate `id` with a metavariable.
<a name="line-423"></a>Then, when we're checking the application of `rank2`, we notice that we really
<a name="line-424"></a>need a polymorphic `id`, and then re-generalize over the unconstrained
<a name="line-425"></a>metavariable.
<a name="line-426"></a>
<a name="line-427"></a>In types, however, we're not so lucky, because *we cannot re-generalize*!
<a name="line-428"></a>There is no lambda. So, we must be careful only to instantiate at the last
<a name="line-429"></a>possible moment, when we're sure we're never going to want the lost polymorphism
<a name="line-430"></a>again. This is done in calls to tcInstBinders.
<a name="line-431"></a>
<a name="line-432"></a>To implement this behavior, we use bidirectional type checking, where we
<a name="line-433"></a>explicitly think about whether we know the kind of the type we're checking
<a name="line-434"></a>or not. Note that there is a difference between not knowing a kind and
<a name="line-435"></a>knowing a metavariable kind: the metavariables are TauTvs, and cannot become
<a name="line-436"></a>forall-quantified kinds. Previously (before dependent types), there were
<a name="line-437"></a>no higher-rank kinds, and so we could instantiate early and be sure that
<a name="line-438"></a>no types would have polymorphic kinds, and so we could always assume that
<a name="line-439"></a>the kind of a type was a fresh metavariable. Not so anymore, thus the
<a name="line-440"></a>need for two algorithms.
<a name="line-441"></a>
<a name="line-442"></a>For HsType forms that can never be kind-polymorphic, we implement only the
<a name="line-443"></a>"down" direction, where we safely assume a metavariable kind. For HsType forms
<a name="line-444"></a>that *can* be kind-polymorphic, we implement just the "up" (functions with
<a name="line-445"></a>"infer" in their name) version, as we gain nothing by also implementing the
<a name="line-446"></a>"down" version.
<a name="line-447"></a>
<a name="line-448"></a>Note [Future-proofing the type checker]
<a name="line-449"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-450"></a>As discussed in Note [Bidirectional type checking], each HsType form is
<a name="line-451"></a>handled in *either* tc_infer_hs_type *or* tc_hs_type. These functions
<a name="line-452"></a>are mutually recursive, so that either one can work for any type former.
<a name="line-453"></a>But, we want to make sure that our pattern-matches are complete. So,
<a name="line-454"></a>we have a bunch of repetitive code just so that we get warnings if we're
<a name="line-455"></a>missing any patterns.
<a name="line-456"></a>-}</span>
<a name="line-457"></a>
<a name="line-458"></a><a name="tc_infer_lhs_type"></a><span class='hs-comment'>------------------------------------------</span>
<a name="line-459"></a><span class='hs-comment'>-- | Check and desugar a type, returning the core type and its</span>
<a name="line-460"></a><span class='hs-comment'>-- possibly-polymorphic kind. Much like 'tcInferRho' at the expression</span>
<a name="line-461"></a><span class='hs-comment'>-- level.</span>
<a name="line-462"></a><span class='hs-definition'>tc_infer_lhs_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-463"></a><span class='hs-definition'>tc_infer_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>span</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-464"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>span</span> <span class='hs-varop'>$</span>
<a name="line-465"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span>
<a name="line-466"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-467"></a>
<a name="line-468"></a><a name="tc_infer_hs_type"></a><span class='hs-comment'>-- | Infer the kind of a type and desugar. This is the "up" type-checker,</span>
<a name="line-469"></a><span class='hs-comment'>-- as described in Note [Bidirectional type checking]</span>
<a name="line-470"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-471"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTyVar</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>tv</span>
<a name="line-472"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-473"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitHsAppTys</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span>
<a name="line-474"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun_ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>fun_ty</span>
<a name="line-475"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>fun_kind'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>fun_kind</span>
<a name="line-476"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcTyApps</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>fun_ty'</span> <span class='hs-varid'>fun_kind'</span> <span class='hs-varid'>arg_tys</span> <span class='hs-layout'>}</span>
<a name="line-477"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>t</span>
<a name="line-478"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOpTy</span> <span class='hs-varid'>lhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc_op</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-479"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>op</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>funTyConKey</span><span class='hs-layout'>)</span>
<a name="line-480"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>op_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyVar</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>op</span>
<a name="line-481"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>op_kind'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>op_kind</span>
<a name="line-482"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcTyApps</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsTyVar</span> <span class='hs-conid'>NotPromoted</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc_op</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>op'</span> <span class='hs-varid'>op_kind'</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>lhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-483"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsKindSig</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span>
<a name="line-484"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_kind</span> <span class='hs-layout'>(</span><span class='hs-varid'>kindLevel</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varid'>sig</span>
<a name="line-485"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>sig'</span>
<a name="line-486"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-487"></a><span class='hs-comment'>-- HsSpliced is an annotation produced by 'RnSplice.rnSpliceType' to communicate</span>
<a name="line-488"></a><span class='hs-comment'>-- the splice location to the typechecker. Here we skip over it in order to have</span>
<a name="line-489"></a><span class='hs-comment'>-- the same kind inferred for a given expression whether it was produced from</span>
<a name="line-490"></a><span class='hs-comment'>-- splices or not.</span>
<a name="line-491"></a><span class='hs-comment'>--</span>
<a name="line-492"></a><span class='hs-comment'>-- See Note [Delaying modFinalizers in untyped splices].</span>
<a name="line-493"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliced</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSplicedTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-494"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span>
<a name="line-495"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDocTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span>
<a name="line-496"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-keyword'>_</span>    <span class='hs-layout'>(</span><span class='hs-conid'>HsCoreTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-497"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>other_ty</span>
<a name="line-498"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-499"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>other_ty</span> <span class='hs-varid'>kv</span>
<a name="line-500"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-501"></a>
<a name="line-502"></a><a name="tc_lhs_type"></a><span class='hs-comment'>------------------------------------------</span>
<a name="line-503"></a><span class='hs-definition'>tc_lhs_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-504"></a><span class='hs-definition'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>span</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-505"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>span</span> <span class='hs-varop'>$</span>
<a name="line-506"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-507"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty'</span> <span class='hs-layout'>}</span>
<a name="line-508"></a>
<a name="line-509"></a><a name="tc_fun_type"></a><span class='hs-comment'>------------------------------------------</span>
<a name="line-510"></a><span class='hs-definition'>tc_fun_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>
<a name="line-511"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-512"></a><span class='hs-definition'>tc_fun_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mode_level</span> <span class='hs-varid'>mode</span> <span class='hs-keyword'>of</span>
<a name="line-513"></a>  <span class='hs-conid'>TypeLevel</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-514"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg_k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newOpenTypeKind</span>
<a name="line-515"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res_k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newOpenTypeKind</span>
<a name="line-516"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>arg_k</span>
<a name="line-517"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>res_k</span>
<a name="line-518"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-519"></a>  <span class='hs-conid'>KindLevel</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-comment'>-- no representation polymorphism in kinds. yet.</span>
<a name="line-520"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-521"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-522"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-523"></a>
<a name="line-524"></a><a name="tc_hs_type"></a><span class='hs-comment'>------------------------------------------</span>
<a name="line-525"></a><span class='hs-comment'>-- See also Note [Bidirectional type checking]</span>
<a name="line-526"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-527"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>   <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-528"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDocTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-529"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsBangTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>
<a name="line-530"></a>    <span class='hs-comment'>-- While top-level bangs at this point are eliminated (eg !(Maybe Int)),</span>
<a name="line-531"></a>    <span class='hs-comment'>-- other kinds of bangs are not (eg ((!Maybe) Int)). These kinds of</span>
<a name="line-532"></a>    <span class='hs-comment'>-- bangs are invalid, so fail. (#7210)</span>
<a name="line-533"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Unexpected strictness annotation:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-534"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsRecTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyword'>_</span>
<a name="line-535"></a>      <span class='hs-comment'>-- Record types (which only show up temporarily in constructor</span>
<a name="line-536"></a>      <span class='hs-comment'>-- signatures) should have been removed by now</span>
<a name="line-537"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Record syntax is illegal here:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-538"></a>
<a name="line-539"></a><span class='hs-comment'>-- HsSpliced is an annotation produced by 'RnSplice.rnSpliceType'.</span>
<a name="line-540"></a><span class='hs-comment'>-- Here we get rid of it and add the finalizers to the global environment</span>
<a name="line-541"></a><span class='hs-comment'>-- while capturing the local environment.</span>
<a name="line-542"></a><span class='hs-comment'>--</span>
<a name="line-543"></a><span class='hs-comment'>-- See Note [Delaying modFinalizers in untyped splices].</span>
<a name="line-544"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliced</span> <span class='hs-varid'>mod_finalizers</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSplicedTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-545"></a>                            <span class='hs-keyword'>_</span>
<a name="line-546"></a>                <span class='hs-layout'>)</span>
<a name="line-547"></a>           <span class='hs-varid'>exp_kind</span>
<a name="line-548"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>addModFinalizersWithLclEnv</span> <span class='hs-varid'>mod_finalizers</span>
<a name="line-549"></a>       <span class='hs-varid'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-550"></a>
<a name="line-551"></a><span class='hs-comment'>-- This should never happen; type splices are expanded by the renamer</span>
<a name="line-552"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-sel'>_exp_kind</span>
<a name="line-553"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Unexpected type splice:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-554"></a>
<a name="line-555"></a><span class='hs-comment'>---------- Functions and applications</span>
<a name="line-556"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-557"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_fun_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>exp_kind</span>
<a name="line-558"></a>
<a name="line-559"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOpTy</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-560"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>op</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>funTyConKey</span>
<a name="line-561"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_fun_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>exp_kind</span>
<a name="line-562"></a>
<a name="line-563"></a><span class='hs-comment'>--------- Foralls</span>
<a name="line-564"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hst_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>hst_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-565"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span>
<a name="line-566"></a>    <span class='hs-varid'>tcExplicitTKBndrs</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-567"></a>    <span class='hs-comment'>-- Do not kind-generalise here!  See Note [Kind generalisation]</span>
<a name="line-568"></a>    <span class='hs-comment'>-- Why exp_kind?  See Note [Body kind of HsForAllTy]</span>
<a name="line-569"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-570"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bound_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>allBoundVariables</span> <span class='hs-varid'>ty'</span>
<a name="line-571"></a>             <span class='hs-varid'>bndrs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarBinders</span> <span class='hs-conid'>Specified</span> <span class='hs-varid'>tvs'</span>
<a name="line-572"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkForAllTys</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bound_vars</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-573"></a>
<a name="line-574"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQualTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hst_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>hst_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-575"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-576"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-577"></a>
<a name="line-578"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-579"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctxt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_hs_context</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ctxt</span>
<a name="line-580"></a>
<a name="line-581"></a>         <span class='hs-comment'>-- See Note [Body kind of a HsQualTy]</span>
<a name="line-582"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isConstraintKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-583"></a>                <span class='hs-keyword'>then</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>constraintKind</span>
<a name="line-584"></a>                <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newOpenTypeKind</span>
<a name="line-585"></a>                                <span class='hs-comment'>-- The body kind (result of the function)</span>
<a name="line-586"></a>                                <span class='hs-comment'>-- can be * or #, hence newOpenTypeKind</span>
<a name="line-587"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ek</span>
<a name="line-588"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-589"></a>
<a name="line-590"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPhiTy</span> <span class='hs-varid'>ctxt'</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-591"></a>
<a name="line-592"></a><span class='hs-comment'>--------- Lists, arrays, and tuples</span>
<a name="line-593"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsListTy</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-594"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tau_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>elt_ty</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-595"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>listTyCon</span>
<a name="line-596"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>rn_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkListTy</span> <span class='hs-varid'>tau_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-597"></a>
<a name="line-598"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsPArrTy</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-599"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>MASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTypeLevel</span> <span class='hs-layout'>(</span><span class='hs-varid'>mode_level</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-600"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tau_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>elt_ty</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-601"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>parrTyCon</span>
<a name="line-602"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>rn_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPArrTy</span> <span class='hs-varid'>tau_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-603"></a>
<a name="line-604"></a><span class='hs-comment'>-- See Note [Distinguishing tuple kinds] in HsTypes</span>
<a name="line-605"></a><span class='hs-comment'>-- See Note [Inferring tuple kinds]</span>
<a name="line-606"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-conid'>HsBoxedOrConstraintTuple</span> <span class='hs-varid'>hs_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-607"></a>     <span class='hs-comment'>-- (NB: not zonking before looking at exp_k, to avoid left-right bias)</span>
<a name="line-608"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tupKindSort_maybe</span> <span class='hs-varid'>exp_kind</span>
<a name="line-609"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_hs_type tuple"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_tys</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;</span>
<a name="line-610"></a>    <span class='hs-varid'>tc_tuple</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>hs_tys</span> <span class='hs-varid'>exp_kind</span>
<a name="line-611"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-612"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_hs_type tuple 2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_tys</span><span class='hs-layout'>)</span>
<a name="line-613"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>kinds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varid'>hs_tys</span>
<a name="line-614"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>kinds</span>
<a name="line-615"></a>           <span class='hs-comment'>-- Infer each arg type separately, because errors can be</span>
<a name="line-616"></a>           <span class='hs-comment'>-- confusing if we give them a shared kind.  Eg Trac #7410</span>
<a name="line-617"></a>           <span class='hs-comment'>-- (Either Int, Int), we do not want to get an error saying</span>
<a name="line-618"></a>           <span class='hs-comment'>-- "the second argument of a tuple should have kind *-&gt;*"</span>
<a name="line-619"></a>
<a name="line-620"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>tup_sort</span><span class='hs-layout'>)</span>
<a name="line-621"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kinds</span>
<a name="line-622"></a>                              <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tupKindSort_maybe</span> <span class='hs-varid'>k</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span> <span class='hs-keyword'>of</span>
<a name="line-623"></a>                    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-624"></a>                    <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftedTypeKind</span><span class='hs-layout'>,</span> <span class='hs-conid'>BoxedTuple</span><span class='hs-layout'>)</span>
<a name="line-625"></a>         <span class='hs-comment'>-- In the [] case, it's not clear what the kind is, so guess *</span>
<a name="line-626"></a>
<a name="line-627"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sequence</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-628"></a>                            <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>arg_kind</span>
<a name="line-629"></a>                          <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span><span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zip3</span> <span class='hs-varid'>hs_tys</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>kinds</span> <span class='hs-keyglyph'>]</span>
<a name="line-630"></a>
<a name="line-631"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>finish_tuple</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tys'</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>arg_kind</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-632"></a>
<a name="line-633"></a>
<a name="line-634"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-varid'>hs_tup_sort</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-635"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_tuple</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>exp_kind</span>
<a name="line-636"></a>  <span class='hs-keyword'>where</span>
<a name="line-637"></a>    <span class='hs-varid'>tup_sort</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>hs_tup_sort</span> <span class='hs-keyword'>of</span>  <span class='hs-comment'>-- Fourth case dealt with above</span>
<a name="line-638"></a>                  <span class='hs-conid'>HsUnboxedTuple</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnboxedTuple</span>
<a name="line-639"></a>                  <span class='hs-conid'>HsBoxedTuple</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BoxedTuple</span>
<a name="line-640"></a>                  <span class='hs-conid'>HsConstraintTuple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ConstraintTuple</span>
<a name="line-641"></a>                  <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tc_hs_type HsTupleTy"</span>
<a name="line-642"></a>
<a name="line-643"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsSumTy</span> <span class='hs-varid'>hs_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-644"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>hs_tys</span>
<a name="line-645"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>arg_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newOpenTypeKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>hs_tys</span>
<a name="line-646"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tau_tys</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varid'>hs_tys</span> <span class='hs-varid'>arg_kinds</span>
<a name="line-647"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arg_reps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>getRuntimeRepFromKind</span> <span class='hs-varid'>arg_kinds</span>
<a name="line-648"></a>             <span class='hs-varid'>arg_tys</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_reps</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tau_tys</span>
<a name="line-649"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>rn_ty</span>
<a name="line-650"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>sumTyCon</span> <span class='hs-varid'>arity</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span>
<a name="line-651"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>unboxedSumKind</span> <span class='hs-varid'>arg_reps</span><span class='hs-layout'>)</span>
<a name="line-652"></a>                           <span class='hs-varid'>exp_kind</span>
<a name="line-653"></a>       <span class='hs-layout'>}</span>
<a name="line-654"></a>
<a name="line-655"></a><span class='hs-comment'>--------- Promoted lists and tuples</span>
<a name="line-656"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitListTy</span> <span class='hs-keyword'>_</span> <span class='hs-sel'>_k</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-657"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-658"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>taus'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyKinds</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>tks</span>
<a name="line-659"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_cons</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_nil</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-varid'>taus'</span><span class='hs-layout'>)</span>
<a name="line-660"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkListTy</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-661"></a>  <span class='hs-keyword'>where</span>
<a name="line-662"></a>    <span class='hs-varid'>mk_cons</span> <span class='hs-varid'>k</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteDataCon</span> <span class='hs-varid'>consDataCon</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span>
<a name="line-663"></a>    <span class='hs-varid'>mk_nil</span>  <span class='hs-varid'>k</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteDataCon</span> <span class='hs-varid'>nilDataCon</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k</span><span class='hs-keyglyph'>]</span>
<a name="line-664"></a>
<a name="line-665"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitTupleTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-666"></a>  <span class='hs-comment'>-- using newMetaKindVar means that we force instantiations of any polykinded</span>
<a name="line-667"></a>  <span class='hs-comment'>-- types. At first, I just used tc_infer_lhs_type, but that led to #11255.</span>
<a name="line-668"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ks</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>replicateM</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-669"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>taus</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ks</span>
<a name="line-670"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>kind_con</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tupleTyCon</span>           <span class='hs-conid'>Boxed</span> <span class='hs-varid'>arity</span>
<a name="line-671"></a>             <span class='hs-varid'>ty_con</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>promotedTupleDataCon</span> <span class='hs-conid'>Boxed</span> <span class='hs-varid'>arity</span>
<a name="line-672"></a>             <span class='hs-varid'>tup_k</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>kind_con</span> <span class='hs-varid'>ks</span>
<a name="line-673"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>rn_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>ty_con</span> <span class='hs-layout'>(</span><span class='hs-varid'>ks</span> <span class='hs-varop'>++</span> <span class='hs-varid'>taus</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>tup_k</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-674"></a>  <span class='hs-keyword'>where</span>
<a name="line-675"></a>    <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span>
<a name="line-676"></a>
<a name="line-677"></a><span class='hs-comment'>--------- Constraint types</span>
<a name="line-678"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsIParamTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-679"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>MASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTypeLevel</span> <span class='hs-layout'>(</span><span class='hs-varid'>mode_level</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-680"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-681"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>n'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkStrLitTy</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hsIPNameFS</span> <span class='hs-varid'>n</span>
<a name="line-682"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ipClass</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupClass</span> <span class='hs-varid'>ipClassName</span>
<a name="line-683"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>rn_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>ipClass</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>n'</span><span class='hs-layout'>,</span><span class='hs-varid'>ty'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-684"></a>           <span class='hs-varid'>constraintKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-685"></a>
<a name="line-686"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsEqTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-687"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty1</span>
<a name="line-688"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty2</span>
<a name="line-689"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty2''</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2'</span> <span class='hs-varid'>kind2</span> <span class='hs-varid'>kind1</span>
<a name="line-690"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>eq_tc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupTyCon</span> <span class='hs-varid'>eqTyConName</span>
<a name="line-691"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNakedTyConApp</span> <span class='hs-varid'>eq_tc</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>kind1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2''</span><span class='hs-keyglyph'>]</span>
<a name="line-692"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>constraintKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-693"></a>
<a name="line-694"></a><span class='hs-comment'>--------- Literals</span>
<a name="line-695"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTyLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsNumTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-696"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>typeNatKindCon</span>
<a name="line-697"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>rn_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNumLitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>typeNatKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-698"></a>
<a name="line-699"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTyLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsStrTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-700"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>typeSymbolKindCon</span>
<a name="line-701"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>rn_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkStrLitTy</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varid'>typeSymbolKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-702"></a>
<a name="line-703"></a><span class='hs-comment'>--------- Potentially kind-polymorphic types: call the "up" checker</span>
<a name="line-704"></a><span class='hs-comment'>-- See Note [Future-proofing the type checker]</span>
<a name="line-705"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_hs_type_ek</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ek</span>
<a name="line-706"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_hs_type_ek</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ek</span>
<a name="line-707"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsOpTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_hs_type_ek</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ek</span>
<a name="line-708"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsKindSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_hs_type_ek</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ek</span>
<a name="line-709"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsCoreTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_hs_type_ek</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ek</span>
<a name="line-710"></a>
<a name="line-711"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWildCardTy</span> <span class='hs-varid'>wc</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-712"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcWildCardOcc</span> <span class='hs-varid'>wc</span> <span class='hs-varid'>exp_kind</span>
<a name="line-713"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>wc_tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-714"></a>
<a name="line-715"></a><span class='hs-comment'>-- disposed of by renamer</span>
<a name="line-716"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsAppsTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>
<a name="line-717"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tc_hs_tyep HsAppsTy"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-718"></a>
<a name="line-719"></a><a name="tcWildCardOcc"></a><span class='hs-definition'>tcWildCardOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsWildCardInfo</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-720"></a><span class='hs-definition'>tcWildCardOcc</span> <span class='hs-varid'>wc_info</span> <span class='hs-varid'>exp_kind</span>
<a name="line-721"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>wildCardName</span> <span class='hs-varid'>wc_info</span><span class='hs-layout'>)</span>
<a name="line-722"></a>          <span class='hs-comment'>-- The wildcard's kind should be an un-filled-in meta tyvar</span>
<a name="line-723"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>wc_kind_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>wc_tv</span><span class='hs-layout'>)</span>
<a name="line-724"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>writeMetaTyVar</span> <span class='hs-varid'>wc_kind_var</span> <span class='hs-varid'>exp_kind</span>
<a name="line-725"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>wc_tv</span> <span class='hs-layout'>}</span>
<a name="line-726"></a>
<a name="line-727"></a><a name="tc_infer_hs_type_ek"></a><span class='hs-comment'>---------------------------</span>
<a name="line-728"></a><span class='hs-comment'>-- | Call 'tc_infer_hs_type' and check its result against an expected kind.</span>
<a name="line-729"></a><span class='hs-definition'>tc_infer_hs_type_ek</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-730"></a><span class='hs-definition'>tc_infer_hs_type_ek</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ek</span>
<a name="line-731"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span>
<a name="line-732"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>k</span> <span class='hs-varid'>ek</span> <span class='hs-layout'>}</span>
<a name="line-733"></a>
<a name="line-734"></a><a name="tupKindSort_maybe"></a><span class='hs-comment'>---------------------------</span>
<a name="line-735"></a><span class='hs-definition'>tupKindSort_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TupleSort</span>
<a name="line-736"></a><span class='hs-definition'>tupKindSort_maybe</span> <span class='hs-varid'>k</span>
<a name="line-737"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>k'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitCastTy_maybe</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tupKindSort_maybe</span> <span class='hs-varid'>k'</span>
<a name="line-738"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>k'</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>k</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tupKindSort_maybe</span> <span class='hs-varid'>k'</span>
<a name="line-739"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isConstraintKind</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>ConstraintTuple</span>
<a name="line-740"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>BoxedTuple</span>
<a name="line-741"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-742"></a>
<a name="line-743"></a><a name="tc_tuple"></a><span class='hs-definition'>tc_tuple</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TupleSort</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-744"></a><span class='hs-definition'>tc_tuple</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>exp_kind</span>
<a name="line-745"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyword'>of</span>
<a name="line-746"></a>           <span class='hs-conid'>BoxedTuple</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>nOfThem</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>liftedTypeKind</span><span class='hs-layout'>)</span>
<a name="line-747"></a>           <span class='hs-conid'>UnboxedTuple</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newOpenTypeKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-748"></a>           <span class='hs-conid'>ConstraintTuple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>nOfThem</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>constraintKind</span><span class='hs-layout'>)</span>
<a name="line-749"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tau_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>arg_kinds</span>
<a name="line-750"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>finish_tuple</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tau_tys</span> <span class='hs-varid'>arg_kinds</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-751"></a>  <span class='hs-keyword'>where</span>
<a name="line-752"></a>    <span class='hs-varid'>arity</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span>
<a name="line-753"></a>
<a name="line-754"></a><a name="finish_tuple"></a><span class='hs-definition'>finish_tuple</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>GhcRn</span>
<a name="line-755"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TupleSort</span>
<a name="line-756"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- ^ argument types</span>
<a name="line-757"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcKind</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- ^ of these kinds</span>
<a name="line-758"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>      <span class='hs-comment'>-- ^ expected kind of the whole tuple</span>
<a name="line-759"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-760"></a><span class='hs-definition'>finish_tuple</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tau_tys</span> <span class='hs-varid'>tau_kinds</span> <span class='hs-varid'>exp_kind</span>
<a name="line-761"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"finish_tuple"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>res_kind</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tau_kinds</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>exp_kind</span><span class='hs-layout'>)</span>
<a name="line-762"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arg_tys</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyword'>of</span>
<a name="line-763"></a>                   <span class='hs-comment'>-- See also Note [Unboxed tuple RuntimeRep vars] in TyCon</span>
<a name="line-764"></a>                 <span class='hs-conid'>UnboxedTuple</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tau_reps</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tau_tys</span>
<a name="line-765"></a>                 <span class='hs-conid'>BoxedTuple</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tau_tys</span>
<a name="line-766"></a>                 <span class='hs-conid'>ConstraintTuple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tau_tys</span>
<a name="line-767"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyword'>of</span>
<a name="line-768"></a>           <span class='hs-conid'>ConstraintTuple</span>
<a name="line-769"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>mAX_CTUPLE_SIZE</span>
<a name="line-770"></a>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>bigConstraintTuple</span> <span class='hs-varid'>arity</span><span class='hs-layout'>)</span>
<a name="line-771"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tcLookupTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>cTupleTyConName</span> <span class='hs-varid'>arity</span><span class='hs-layout'>)</span>
<a name="line-772"></a>           <span class='hs-conid'>BoxedTuple</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tupleTyCon</span> <span class='hs-conid'>Boxed</span> <span class='hs-varid'>arity</span>
<a name="line-773"></a>                               <span class='hs-layout'>;</span> <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-774"></a>                               <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>}</span>
<a name="line-775"></a>           <span class='hs-conid'>UnboxedTuple</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tupleTyCon</span> <span class='hs-conid'>Unboxed</span> <span class='hs-varid'>arity</span><span class='hs-layout'>)</span>
<a name="line-776"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>rn_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_kind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-777"></a>  <span class='hs-keyword'>where</span>
<a name="line-778"></a>    <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tau_tys</span>
<a name="line-779"></a>    <span class='hs-varid'>tau_reps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>getRuntimeRepFromKind</span> <span class='hs-varid'>tau_kinds</span>
<a name="line-780"></a>    <span class='hs-varid'>res_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyword'>of</span>
<a name="line-781"></a>                 <span class='hs-conid'>UnboxedTuple</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unboxedTupleKind</span> <span class='hs-varid'>tau_reps</span>
<a name="line-782"></a>                 <span class='hs-conid'>BoxedTuple</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-783"></a>                 <span class='hs-conid'>ConstraintTuple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>constraintKind</span>
<a name="line-784"></a>
<a name="line-785"></a><a name="bigConstraintTuple"></a><span class='hs-definition'>bigConstraintTuple</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-786"></a><span class='hs-definition'>bigConstraintTuple</span> <span class='hs-varid'>arity</span>
<a name="line-787"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Constraint tuple arity too large:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>arity</span>
<a name="line-788"></a>          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"max arity ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>mAX_CTUPLE_SIZE</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-789"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Instead, use a nested tuple"</span><span class='hs-layout'>)</span>
<a name="line-790"></a>
<a name="line-791"></a><a name="tcInferApps"></a><span class='hs-comment'>---------------------------</span>
<a name="line-792"></a><span class='hs-comment'>-- | Apply a type of a given kind to a list of arguments. This instantiates</span>
<a name="line-793"></a><span class='hs-comment'>-- invisible parameters as necessary. Always consumes all the arguments,</span>
<a name="line-794"></a><span class='hs-comment'>-- using matchExpectedFunKind as necessary.</span>
<a name="line-795"></a><span class='hs-comment'>-- This takes an optional @VarEnv Kind@ which maps kind variables to kinds.</span>
<a name="line-796"></a><span class='hs-comment'>-- These kinds should be used to instantiate invisible kind variables;</span>
<a name="line-797"></a><span class='hs-comment'>-- they come from an enclosing class for an associated type/data family.</span>
<a name="line-798"></a><span class='hs-definition'>tcInferApps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span>
<a name="line-799"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarEnv</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- ^ Possibly, kind info (see above)</span>
<a name="line-800"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span>        <span class='hs-comment'>-- ^ Function (for printing only)</span>
<a name="line-801"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>               <span class='hs-comment'>-- ^ Function (could be knot-tied)</span>
<a name="line-802"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>               <span class='hs-comment'>-- ^ Function kind (zonked)</span>
<a name="line-803"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- ^ Args</span>
<a name="line-804"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ (f args, args, result kind)</span>
<a name="line-805"></a><span class='hs-definition'>tcInferApps</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>mb_kind_info</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ki</span> <span class='hs-varid'>args</span>
<a name="line-806"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcInferApps"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>args</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span>
<a name="line-807"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>orig_subst</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>orig_ki_binders</span> <span class='hs-varid'>orig_inner_ki</span> <span class='hs-varid'>args</span> <span class='hs-num'>1</span> <span class='hs-layout'>}</span>
<a name="line-808"></a>  <span class='hs-keyword'>where</span>
<a name="line-809"></a>    <span class='hs-varid'>orig_subst</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEmptyTCvSubst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>ki</span>
<a name="line-810"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>orig_ki_binders</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig_inner_ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitPiTys</span> <span class='hs-varid'>ki</span>
<a name="line-811"></a>
<a name="line-812"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- already type-checked args, in reverse order, for errors</span>
<a name="line-813"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- already type-checked args, in reverse order</span>
<a name="line-814"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>        <span class='hs-comment'>-- instantiating substitution</span>
<a name="line-815"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>          <span class='hs-comment'>-- function applied to some args, could be knot-tied</span>
<a name="line-816"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyBinder</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- binders in function kind (both vis. and invis.)</span>
<a name="line-817"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>          <span class='hs-comment'>-- function kind body (not a Pi-type)</span>
<a name="line-818"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- un-type-checked args</span>
<a name="line-819"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>             <span class='hs-comment'>-- the # of the next argument</span>
<a name="line-820"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- same as overall return type</span>
<a name="line-821"></a>
<a name="line-822"></a>      <span class='hs-comment'>-- no user-written args left. We're done!</span>
<a name="line-823"></a>    <span class='hs-varid'>go</span> <span class='hs-sel'>_acc_hs_args</span> <span class='hs-varid'>acc_args</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>ki_binders</span> <span class='hs-varid'>inner_ki</span> <span class='hs-conid'>[]</span> <span class='hs-keyword'>_</span>
<a name="line-824"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun</span><span class='hs-layout'>,</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>acc_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkPiTys</span> <span class='hs-varid'>ki_binders</span> <span class='hs-varid'>inner_ki</span><span class='hs-layout'>)</span>
<a name="line-825"></a>
<a name="line-826"></a>      <span class='hs-comment'>-- The function's kind has a binder. Is it visible or invisible?</span>
<a name="line-827"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>acc_hs_args</span> <span class='hs-varid'>acc_args</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fun</span> <span class='hs-layout'>(</span><span class='hs-varid'>ki_binder</span><span class='hs-conop'>:</span><span class='hs-varid'>ki_binders</span><span class='hs-layout'>)</span> <span class='hs-varid'>inner_ki</span>
<a name="line-828"></a>       <span class='hs-varid'>all_args</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span>
<a name="line-829"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isInvisibleBinder</span> <span class='hs-varid'>ki_binder</span>
<a name="line-830"></a>        <span class='hs-comment'>-- It's invisible. Instantiate.</span>
<a name="line-831"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcInferApps (invis)"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ki_binder</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span>
<a name="line-832"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstBinder</span> <span class='hs-varid'>mb_kind_info</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ki_binder</span>
<a name="line-833"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>acc_hs_args</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>acc_args</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst'</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNakedAppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span>
<a name="line-834"></a>                <span class='hs-varid'>ki_binders</span> <span class='hs-varid'>inner_ki</span> <span class='hs-varid'>all_args</span> <span class='hs-varid'>n</span> <span class='hs-layout'>}</span>
<a name="line-835"></a>
<a name="line-836"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-837"></a>        <span class='hs-comment'>-- It's visible. Check the next user-written argument</span>
<a name="line-838"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcInferApps (vis)"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ki_binder</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>arg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span>
<a name="line-839"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>arg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>funAppCtxt</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-840"></a>                     <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>arg</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyBinderType</span> <span class='hs-varid'>ki_binder</span><span class='hs-layout'>)</span>
<a name="line-841"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTvSubstBinderAndInScope</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ki_binder</span> <span class='hs-varid'>arg'</span>
<a name="line-842"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span> <span class='hs-conop'>:</span> <span class='hs-varid'>acc_hs_args</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>acc_args</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst'</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNakedAppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span>
<a name="line-843"></a>                <span class='hs-varid'>ki_binders</span> <span class='hs-varid'>inner_ki</span> <span class='hs-varid'>args</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-844"></a>
<a name="line-845"></a>       <span class='hs-comment'>-- We've run out of known binders in the functions's kind.</span>
<a name="line-846"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>acc_hs_args</span> <span class='hs-varid'>acc_args</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fun</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>inner_ki</span> <span class='hs-varid'>all_args</span> <span class='hs-varid'>n</span>
<a name="line-847"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>new_ki_binders</span><span class='hs-layout'>)</span>
<a name="line-848"></a>         <span class='hs-comment'>-- But, after substituting, we have more binders.</span>
<a name="line-849"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>acc_hs_args</span> <span class='hs-varid'>acc_args</span> <span class='hs-varid'>zapped_subst</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>new_ki_binders</span> <span class='hs-varid'>new_inner_ki</span> <span class='hs-varid'>all_args</span> <span class='hs-varid'>n</span>
<a name="line-850"></a>
<a name="line-851"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-852"></a>         <span class='hs-comment'>-- Even after substituting, still no binders. Use matchExpectedFunKind</span>
<a name="line-853"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcInferApps (no binder)"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>new_inner_ki</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>zapped_subst</span><span class='hs-layout'>)</span>
<a name="line-854"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_k</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_k</span><span class='hs-layout'>)</span>
<a name="line-855"></a>               <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedFunKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsAppTys</span> <span class='hs-varid'>orig_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>acc_hs_args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-856"></a>                                       <span class='hs-varid'>substed_inner_ki</span>
<a name="line-857"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zapped_subst</span> <span class='hs-varop'>`extendTCvInScopeSet`</span> <span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg_k</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_k</span><span class='hs-keyglyph'>]</span>
<a name="line-858"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>acc_hs_args</span> <span class='hs-varid'>acc_args</span> <span class='hs-varid'>subst'</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun</span> <span class='hs-varop'>`mkNakedCastTy`</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-859"></a>                <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkAnonBinder</span> <span class='hs-varid'>arg_k</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>res_k</span> <span class='hs-varid'>all_args</span> <span class='hs-varid'>n</span> <span class='hs-layout'>}</span>
<a name="line-860"></a>      <span class='hs-keyword'>where</span>
<a name="line-861"></a>        <span class='hs-varid'>substed_inner_ki</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>inner_ki</span>
<a name="line-862"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>new_ki_binders</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_inner_ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitPiTys</span> <span class='hs-varid'>substed_inner_ki</span>
<a name="line-863"></a>        <span class='hs-varid'>zapped_subst</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zapTCvSubst</span> <span class='hs-varid'>subst</span>
<a name="line-864"></a>
<a name="line-865"></a><a name="tcTyApps"></a><span class='hs-comment'>-- | Applies a type to a list of arguments.</span>
<a name="line-866"></a><span class='hs-comment'>-- Always consumes all the arguments, using 'matchExpectedFunKind' as</span>
<a name="line-867"></a><span class='hs-comment'>-- necessary. If you wish to apply a type to a list of HsTypes, this is</span>
<a name="line-868"></a><span class='hs-comment'>-- your function.</span>
<a name="line-869"></a><span class='hs-comment'>-- Used for type-checking types only.</span>
<a name="line-870"></a><span class='hs-definition'>tcTyApps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span>
<a name="line-871"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span>        <span class='hs-comment'>-- ^ Function (for printing only)</span>
<a name="line-872"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>               <span class='hs-comment'>-- ^ Function (could be knot-tied)</span>
<a name="line-873"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>               <span class='hs-comment'>-- ^ Function kind (zonked)</span>
<a name="line-874"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- ^ Args</span>
<a name="line-875"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ (f args, result kind)</span>
<a name="line-876"></a><span class='hs-definition'>tcTyApps</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ki</span> <span class='hs-varid'>args</span>
<a name="line-877"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-sel'>_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>ki'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferApps</span> <span class='hs-varid'>mode</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ki</span> <span class='hs-varid'>args</span>
<a name="line-878"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ki'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-879"></a>
<a name="line-880"></a><a name="checkExpectedKind"></a><span class='hs-comment'>--------------------------</span>
<a name="line-881"></a><span class='hs-comment'>-- like checkExpectedKindX, but returns only the final type; convenient wrapper</span>
<a name="line-882"></a><span class='hs-definition'>checkExpectedKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>GhcRn</span>
<a name="line-883"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>
<a name="line-884"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>
<a name="line-885"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>
<a name="line-886"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-887"></a><span class='hs-definition'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>act</span> <span class='hs-varid'>exp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fstOf3</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>checkExpectedKindX</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>act</span> <span class='hs-varid'>exp</span>
<a name="line-888"></a>
<a name="line-889"></a><a name="checkExpectedKindX"></a><span class='hs-definition'>checkExpectedKindX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarEnv</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Possibly, instantiations for kind vars</span>
<a name="line-890"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>                 <span class='hs-comment'>-- HsType whose kind we're checking</span>
<a name="line-891"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>               <span class='hs-comment'>-- the type whose kind we're checking</span>
<a name="line-892"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>               <span class='hs-comment'>-- the known kind of that type, k</span>
<a name="line-893"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>               <span class='hs-comment'>-- the expected kind, exp_kind</span>
<a name="line-894"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcCoercionN</span><span class='hs-layout'>)</span>
<a name="line-895"></a>    <span class='hs-comment'>-- (an possibly-inst'ed, casted type :: exp_kind, the new args, the coercion)</span>
<a name="line-896"></a><span class='hs-comment'>-- Instantiate a kind (if necessary) and then call unifyType</span>
<a name="line-897"></a><span class='hs-comment'>--      (checkExpectedKind ty act_kind exp_kind)</span>
<a name="line-898"></a><span class='hs-comment'>-- checks that the actual kind act_kind is compatible</span>
<a name="line-899"></a><span class='hs-comment'>--      with the expected kind exp_kind</span>
<a name="line-900"></a><span class='hs-definition'>checkExpectedKindX</span> <span class='hs-varid'>mb_kind_env</span> <span class='hs-varid'>pp_hs_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>act_kind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-901"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>act_kind'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instantiate</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>act_kind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-902"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act_kind'</span>
<a name="line-903"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp_kind</span>
<a name="line-904"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>uo_thing</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>pp_hs_ty</span>
<a name="line-905"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>uo_visible</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span> <span class='hs-comment'>-- the hs_ty is visible</span>
<a name="line-906"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>co_k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-conid'>KindLevel</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>act_kind'</span> <span class='hs-varid'>exp_kind</span>
<a name="line-907"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"checkExpectedKind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>act_kind</span>
<a name="line-908"></a>                                          <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>exp_kind</span>
<a name="line-909"></a>                                          <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co_k</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-910"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>result_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty'</span> <span class='hs-varop'>`mkNakedCastTy`</span> <span class='hs-varid'>co_k</span>
<a name="line-911"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>result_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>co_k</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-912"></a>  <span class='hs-keyword'>where</span>
<a name="line-913"></a>    <span class='hs-comment'>-- we need to make sure that both kinds have the same number of implicit</span>
<a name="line-914"></a>    <span class='hs-comment'>-- foralls out front. If the actual kind has more, instantiate accordingly.</span>
<a name="line-915"></a>    <span class='hs-comment'>-- Otherwise, just pass the type &amp; kind through -- the errors are caught</span>
<a name="line-916"></a>    <span class='hs-comment'>-- in unifyType.</span>
<a name="line-917"></a>    <span class='hs-varid'>instantiate</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span>    <span class='hs-comment'>-- the type</span>
<a name="line-918"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>    <span class='hs-comment'>-- of this kind</span>
<a name="line-919"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>   <span class='hs-comment'>-- but expected to be of this one</span>
<a name="line-920"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span> <span class='hs-conid'>TcType</span>   <span class='hs-comment'>-- the inst'ed type</span>
<a name="line-921"></a>                       <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- the new args</span>
<a name="line-922"></a>                       <span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span> <span class='hs-layout'>)</span> <span class='hs-comment'>-- its new kind</span>
<a name="line-923"></a>    <span class='hs-varid'>instantiate</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>act_ki</span> <span class='hs-varid'>exp_ki</span>
<a name="line-924"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>exp_bndrs</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitPiTysInvisible</span> <span class='hs-varid'>exp_ki</span> <span class='hs-keyword'>in</span>
<a name="line-925"></a>        <span class='hs-varid'>instantiateTyUntilN</span> <span class='hs-varid'>mb_kind_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>exp_bndrs</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>act_ki</span>
<a name="line-926"></a>
<a name="line-927"></a><a name="instantiateTyN"></a><span class='hs-comment'>-- | Instantiate @n@ invisible arguments to a type. If @n &lt;= 0@, no instantiation</span>
<a name="line-928"></a><span class='hs-comment'>-- occurs. If @n@ is too big, then all available invisible arguments are instantiated.</span>
<a name="line-929"></a><span class='hs-comment'>-- (In other words, this function is very forgiving about bad values of @n@.)</span>
<a name="line-930"></a><span class='hs-definition'>instantiateTyN</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarEnv</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>)</span>              <span class='hs-comment'>-- ^ Predetermined instantiations</span>
<a name="line-931"></a>                                                   <span class='hs-comment'>-- (for assoc. type patterns)</span>
<a name="line-932"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>                              <span class='hs-comment'>-- ^ @n@</span>
<a name="line-933"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>                           <span class='hs-comment'>-- ^ the type</span>
<a name="line-934"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>             <span class='hs-comment'>-- ^ its kind</span>
<a name="line-935"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- ^ The inst'ed type, new args, kind</span>
<a name="line-936"></a><span class='hs-definition'>instantiateTyN</span> <span class='hs-varid'>mb_kind_env</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>inner_ki</span>
<a name="line-937"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>   <span class='hs-comment'>-- NB: splitAt is forgiving with invalid numbers</span>
<a name="line-938"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>inst_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>leftover_bndrs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAt</span> <span class='hs-varid'>n</span> <span class='hs-varid'>bndrs</span>
<a name="line-939"></a>        <span class='hs-varid'>ki</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPiTys</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>inner_ki</span>
<a name="line-940"></a>        <span class='hs-varid'>empty_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEmptyTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-941"></a>    <span class='hs-keyword'>in</span>
<a name="line-942"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;=</span> <span class='hs-num'>0</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span>
<a name="line-943"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>inst_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstBinders</span> <span class='hs-varid'>empty_subst</span> <span class='hs-varid'>mb_kind_env</span> <span class='hs-varid'>inst_bndrs</span>
<a name="line-944"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rebuilt_ki</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPiTys</span> <span class='hs-varid'>leftover_bndrs</span> <span class='hs-varid'>inner_ki</span>
<a name="line-945"></a>             <span class='hs-varid'>ki'</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>rebuilt_ki</span>
<a name="line-946"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"instantiateTyN"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ki</span>
<a name="line-947"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span>
<a name="line-948"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>subst</span>
<a name="line-949"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rebuilt_ki</span>
<a name="line-950"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ki'</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-951"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNakedAppTys</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>inst_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>inst_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>ki'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-952"></a>
<a name="line-953"></a><a name="instantiateTyUntilN"></a><span class='hs-comment'>-- | Instantiate a type to have at most @n@ invisible arguments.</span>
<a name="line-954"></a><span class='hs-definition'>instantiateTyUntilN</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarEnv</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- ^ Possibly, instantiations for vars</span>
<a name="line-955"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>         <span class='hs-comment'>-- ^ @n@</span>
<a name="line-956"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>      <span class='hs-comment'>-- ^ the type</span>
<a name="line-957"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>      <span class='hs-comment'>-- ^ its kind</span>
<a name="line-958"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- ^ The inst'ed type, new args,</span>
<a name="line-959"></a>                                                        <span class='hs-comment'>-- final kind</span>
<a name="line-960"></a><span class='hs-definition'>instantiateTyUntilN</span> <span class='hs-varid'>mb_kind_env</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ki</span>
<a name="line-961"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>inner_ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitPiTysInvisible</span> <span class='hs-varid'>ki</span>
<a name="line-962"></a>        <span class='hs-varid'>num_to_inst</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>bndrs</span> <span class='hs-comment'>-</span> <span class='hs-varid'>n</span>
<a name="line-963"></a>    <span class='hs-keyword'>in</span>
<a name="line-964"></a>    <span class='hs-varid'>instantiateTyN</span> <span class='hs-varid'>mb_kind_env</span> <span class='hs-varid'>num_to_inst</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>inner_ki</span>
<a name="line-965"></a>
<a name="line-966"></a><a name="tcHsContext"></a><span class='hs-comment'>---------------------------</span>
<a name="line-967"></a><span class='hs-definition'>tcHsContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsContext</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span>
<a name="line-968"></a><span class='hs-definition'>tcHsContext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_hs_context</span> <span class='hs-varid'>typeLevelMode</span>
<a name="line-969"></a>
<a name="line-970"></a><a name="tcLHsPredType"></a><span class='hs-definition'>tcLHsPredType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>PredType</span>
<a name="line-971"></a><span class='hs-definition'>tcLHsPredType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_pred</span> <span class='hs-varid'>typeLevelMode</span>
<a name="line-972"></a>
<a name="line-973"></a><a name="tc_hs_context"></a><span class='hs-definition'>tc_hs_context</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsContext</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span>
<a name="line-974"></a><span class='hs-definition'>tc_hs_context</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_lhs_pred</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-975"></a>
<a name="line-976"></a><a name="tc_lhs_pred"></a><span class='hs-definition'>tc_lhs_pred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>PredType</span>
<a name="line-977"></a><span class='hs-definition'>tc_lhs_pred</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>constraintKind</span>
<a name="line-978"></a>
<a name="line-979"></a><a name="tcTyVar"></a><span class='hs-comment'>---------------------------</span>
<a name="line-980"></a><span class='hs-definition'>tcTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-981"></a><span class='hs-comment'>-- See Note [Type checking recursive type and class declarations]</span>
<a name="line-982"></a><span class='hs-comment'>-- in TcTyClsDecls</span>
<a name="line-983"></a><span class='hs-definition'>tcTyVar</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>name</span>         <span class='hs-comment'>-- Could be a tyvar, a tycon, or a datacon</span>
<a name="line-984"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"lk1"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-985"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>name</span>
<a name="line-986"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-987"></a>           <span class='hs-conid'>ATyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-988"></a>
<a name="line-989"></a>           <span class='hs-conid'>ATcTyCon</span> <span class='hs-varid'>tc_tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- See Note [GADT kind self-reference]</span>
<a name="line-990"></a>                                  <span class='hs-varid'>unless</span>
<a name="line-991"></a>                                    <span class='hs-layout'>(</span><span class='hs-varid'>isTypeLevel</span> <span class='hs-layout'>(</span><span class='hs-varid'>mode_level</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-992"></a>                                    <span class='hs-layout'>(</span><span class='hs-varid'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-conid'>TyConPE</span><span class='hs-layout'>)</span>
<a name="line-993"></a>                                <span class='hs-layout'>;</span> <span class='hs-varid'>check_tc</span> <span class='hs-varid'>tc_tc</span>
<a name="line-994"></a>                                <span class='hs-layout'>;</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get_loopy_tc</span> <span class='hs-varid'>name</span> <span class='hs-varid'>tc_tc</span>
<a name="line-995"></a>                                <span class='hs-layout'>;</span> <span class='hs-varid'>handle_tyfams</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tc_tc</span> <span class='hs-layout'>}</span>
<a name="line-996"></a>                             <span class='hs-comment'>-- mkNakedTyConApp: see Note [Type-checking inside the knot]</span>
<a name="line-997"></a>                 <span class='hs-comment'>-- NB: we really should check if we're at the kind level</span>
<a name="line-998"></a>                 <span class='hs-comment'>-- and if the tycon is promotable if -XNoTypeInType is set.</span>
<a name="line-999"></a>                 <span class='hs-comment'>-- But this is a terribly large amount of work! Not worth it.</span>
<a name="line-1000"></a>
<a name="line-1001"></a>           <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1002"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>check_tc</span> <span class='hs-varid'>tc</span>
<a name="line-1003"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>handle_tyfams</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>}</span>
<a name="line-1004"></a>
<a name="line-1005"></a>           <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1006"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>DataKinds</span>
<a name="line-1007"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>data_kinds</span> <span class='hs-varop'>||</span> <span class='hs-varid'>specialPromotedDc</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1008"></a>                       <span class='hs-varid'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-conid'>NoDataKindsDC</span>
<a name="line-1009"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>type_in_type</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>TypeInType</span>
<a name="line-1010"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span> <span class='hs-varid'>type_in_type</span> <span class='hs-varop'>||</span>
<a name="line-1011"></a>                              <span class='hs-layout'>(</span> <span class='hs-varid'>isTypeLevel</span> <span class='hs-layout'>(</span><span class='hs-varid'>mode_level</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-1012"></a>                                <span class='hs-varid'>isLegacyPromotableDataCon</span> <span class='hs-varid'>dc</span> <span class='hs-layout'>)</span> <span class='hs-varop'>||</span>
<a name="line-1013"></a>                              <span class='hs-layout'>(</span> <span class='hs-varid'>isKindLevel</span> <span class='hs-layout'>(</span><span class='hs-varid'>mode_level</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-1014"></a>                                <span class='hs-varid'>specialPromotedDc</span> <span class='hs-varid'>dc</span> <span class='hs-layout'>)</span> <span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1015"></a>                       <span class='hs-varid'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-conid'>NoTypeInTypeDC</span>
<a name="line-1016"></a>                   <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>promoteDataCon</span> <span class='hs-varid'>dc</span>
<a name="line-1017"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNakedTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1018"></a>
<a name="line-1019"></a>           <span class='hs-conid'>APromotionErr</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-varid'>err</span>
<a name="line-1020"></a>
<a name="line-1021"></a>           <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrongThingErr</span> <span class='hs-str'>"type"</span> <span class='hs-varid'>thing</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span>
<a name="line-1022"></a>  <span class='hs-keyword'>where</span>
<a name="line-1023"></a>    <span class='hs-varid'>check_tc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-1024"></a>    <span class='hs-varid'>check_tc</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>type_in_type</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>TypeInType</span>
<a name="line-1025"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>data_kinds</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>DataKinds</span>
<a name="line-1026"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTypeLevel</span> <span class='hs-layout'>(</span><span class='hs-varid'>mode_level</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span>
<a name="line-1027"></a>                               <span class='hs-varid'>data_kinds</span> <span class='hs-varop'>||</span>
<a name="line-1028"></a>                               <span class='hs-varid'>isKindTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1029"></a>                       <span class='hs-varid'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-conid'>NoDataKindsTC</span>
<a name="line-1030"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTypeLevel</span> <span class='hs-layout'>(</span><span class='hs-varid'>mode_level</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span>
<a name="line-1031"></a>                               <span class='hs-varid'>type_in_type</span> <span class='hs-varop'>||</span>
<a name="line-1032"></a>                               <span class='hs-varid'>isLegacyPromotableTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1033"></a>                       <span class='hs-varid'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-conid'>NoTypeInTypeTC</span> <span class='hs-layout'>}</span>
<a name="line-1034"></a>
<a name="line-1035"></a>    <span class='hs-comment'>-- if we are type-checking a type family tycon, we must instantiate</span>
<a name="line-1036"></a>    <span class='hs-comment'>-- any invisible arguments right away. Otherwise, we get #11246</span>
<a name="line-1037"></a>    <span class='hs-varid'>handle_tyfams</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span>     <span class='hs-comment'>-- the tycon to instantiate (might be loopy)</span>
<a name="line-1038"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyCon</span>   <span class='hs-comment'>-- a non-loopy version of the tycon</span>
<a name="line-1039"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-1040"></a>    <span class='hs-varid'>handle_tyfams</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tc_tc</span>
<a name="line-1041"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mightBeUnsaturatedTyCon</span> <span class='hs-varid'>tc_tc</span>
<a name="line-1042"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcTyVar2a"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_tc</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_kind</span><span class='hs-layout'>)</span>
<a name="line-1043"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc_kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1044"></a>
<a name="line-1045"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1046"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_ty</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instantiateTyN</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConBinders</span> <span class='hs-varid'>tc_tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1047"></a>                                                <span class='hs-varid'>ty</span> <span class='hs-varid'>tc_kind_bndrs</span> <span class='hs-varid'>tc_inner_ki</span>
<a name="line-1048"></a>           <span class='hs-comment'>-- tc and tc_ty must not be traced here, because that would</span>
<a name="line-1049"></a>           <span class='hs-comment'>-- force the evaluation of a potentially knot-tied variable (tc),</span>
<a name="line-1050"></a>           <span class='hs-comment'>-- and the typechecker would hang, as per #11708</span>
<a name="line-1051"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcTyVar2b"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_tc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_kind</span>
<a name="line-1052"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1053"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1054"></a>      <span class='hs-keyword'>where</span>
<a name="line-1055"></a>        <span class='hs-varid'>ty</span>                           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNakedTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-conid'>[]</span>
<a name="line-1056"></a>        <span class='hs-varid'>tc_kind</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc_tc</span>
<a name="line-1057"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>tc_kind_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc_inner_ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitPiTysInvisible</span> <span class='hs-varid'>tc_kind</span>
<a name="line-1058"></a>
<a name="line-1059"></a>    <span class='hs-varid'>get_loopy_tc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TyCon</span>
<a name="line-1060"></a>    <span class='hs-comment'>-- Return the knot-tied global TyCon if there is one</span>
<a name="line-1061"></a>    <span class='hs-comment'>-- Otherwise the local TcTyCon; we must be doing kind checking</span>
<a name="line-1062"></a>    <span class='hs-comment'>-- but we still want to return a TyCon of some sort to use in</span>
<a name="line-1063"></a>    <span class='hs-comment'>-- error messages</span>
<a name="line-1064"></a>    <span class='hs-varid'>get_loopy_tc</span> <span class='hs-varid'>name</span> <span class='hs-varid'>tc_tc</span>
<a name="line-1065"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-1066"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_type_env</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>of</span>
<a name="line-1067"></a>                <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tc</span>
<a name="line-1068"></a>                <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"lk1 (loopy)"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-1069"></a>                                       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tc_tc</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1070"></a>
<a name="line-1071"></a><a name="tcClass"></a><span class='hs-definition'>tcClass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-1072"></a><span class='hs-definition'>tcClass</span> <span class='hs-varid'>cls</span>     <span class='hs-comment'>-- Must be a class</span>
<a name="line-1073"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>cls</span>
<a name="line-1074"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-1075"></a>           <span class='hs-conid'>ATcTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>aThingErr</span> <span class='hs-str'>"tcClass"</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1076"></a>           <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1077"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConClass_maybe</span> <span class='hs-varid'>tc</span>
<a name="line-1078"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1079"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrongThingErr</span> <span class='hs-str'>"class"</span> <span class='hs-varid'>thing</span> <span class='hs-varid'>cls</span> <span class='hs-layout'>}</span>
<a name="line-1080"></a>
<a name="line-1081"></a>
<a name="line-1082"></a><a name="aThingErr"></a><span class='hs-definition'>aThingErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-1083"></a><span class='hs-comment'>-- The type checker for types is sometimes called simply to</span>
<a name="line-1084"></a><span class='hs-comment'>-- do *kind* checking; and in that case it ignores the type</span>
<a name="line-1085"></a><span class='hs-comment'>-- returned. Which is a good thing since it may not be available yet!</span>
<a name="line-1086"></a><span class='hs-definition'>aThingErr</span> <span class='hs-varid'>str</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"AThing evaluated unexpectedly"</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>str</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-1087"></a>
<a name="line-1088"></a><span class='hs-comment'>{-
<a name="line-1089"></a>Note [Type-checking inside the knot]
<a name="line-1090"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1091"></a>Suppose we are checking the argument types of a data constructor.  We
<a name="line-1092"></a>must zonk the types before making the DataCon, because once built we
<a name="line-1093"></a>can't change it.  So we must traverse the type.
<a name="line-1094"></a>
<a name="line-1095"></a>BUT the parent TyCon is knot-tied, so we can't look at it yet.
<a name="line-1096"></a>
<a name="line-1097"></a>So we must be careful not to use "smart constructors" for types that
<a name="line-1098"></a>look at the TyCon or Class involved.
<a name="line-1099"></a>
<a name="line-1100"></a>  * Hence the use of mkNakedXXX functions. These do *not* enforce
<a name="line-1101"></a>    the invariants (for example that we use (FunTy s t) rather
<a name="line-1102"></a>    than (TyConApp (-&gt;) [s,t])).
<a name="line-1103"></a>
<a name="line-1104"></a>  * The zonking functions establish invariants (even zonkTcType, a change from
<a name="line-1105"></a>    previous behaviour). So we must never inspect the result of a
<a name="line-1106"></a>    zonk that might mention a knot-tied TyCon. This is generally OK
<a name="line-1107"></a>    because we zonk *kinds* while kind-checking types. And the TyCons
<a name="line-1108"></a>    in kinds shouldn't be knot-tied, because they come from a previous
<a name="line-1109"></a>    mutually recursive group.
<a name="line-1110"></a>
<a name="line-1111"></a>  * TcHsSyn.zonkTcTypeToType also can safely check/establish
<a name="line-1112"></a>    invariants.
<a name="line-1113"></a>
<a name="line-1114"></a>This is horribly delicate.  I hate it.  A good example of how
<a name="line-1115"></a>delicate it is can be seen in Trac #7903.
<a name="line-1116"></a>
<a name="line-1117"></a>Note [GADT kind self-reference]
<a name="line-1118"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1119"></a>
<a name="line-1120"></a>A promoted type cannot be used in the body of that type's declaration.
<a name="line-1121"></a>Trac #11554 shows this example, which made GHC loop:
<a name="line-1122"></a>
<a name="line-1123"></a>  import Data.Kind
<a name="line-1124"></a>  data P (x :: k) = Q
<a name="line-1125"></a>  data A :: Type where
<a name="line-1126"></a>    B :: forall (a :: A). P a -&gt; A
<a name="line-1127"></a>
<a name="line-1128"></a>In order to check the constructor B, we need to have the promoted type A, but in
<a name="line-1129"></a>order to get that promoted type, B must first be checked. To prevent looping, a
<a name="line-1130"></a>TyConPE promotion error is given when tcTyVar checks an ATcTyCon in kind mode.
<a name="line-1131"></a>Any ATcTyCon is a TyCon being defined in the current recursive group (see data
<a name="line-1132"></a>type decl for TcTyThing), and all such TyCons are illegal in kinds.
<a name="line-1133"></a>
<a name="line-1134"></a>Trac #11962 proposes checking the head of a data declaration separately from
<a name="line-1135"></a>its constructors. This would allow the example above to pass.
<a name="line-1136"></a>
<a name="line-1137"></a>Note [Body kind of a HsForAllTy]
<a name="line-1138"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1139"></a>The body of a forall is usually a type, but in principle
<a name="line-1140"></a>there's no reason to prohibit *unlifted* types.
<a name="line-1141"></a>In fact, GHC can itself construct a function with an
<a name="line-1142"></a>unboxed tuple inside a for-all (via CPR analysis; see
<a name="line-1143"></a>typecheck/should_compile/tc170).
<a name="line-1144"></a>
<a name="line-1145"></a>Moreover in instance heads we get forall-types with
<a name="line-1146"></a>kind Constraint.
<a name="line-1147"></a>
<a name="line-1148"></a>It's tempting to check that the body kind is either * or #. But this is
<a name="line-1149"></a>wrong. For example:
<a name="line-1150"></a>
<a name="line-1151"></a>  class C a b
<a name="line-1152"></a>  newtype N = Mk Foo deriving (C a)
<a name="line-1153"></a>
<a name="line-1154"></a>We're doing newtype-deriving for C. But notice how `a` isn't in scope in
<a name="line-1155"></a>the predicate `C a`. So we quantify, yielding `forall a. C a` even though
<a name="line-1156"></a>`C a` has kind `* -&gt; Constraint`. The `forall a. C a` is a bit cheeky, but
<a name="line-1157"></a>convenient. Bottom line: don't check for * or # here.
<a name="line-1158"></a>
<a name="line-1159"></a>Note [Body kind of a HsQualTy]
<a name="line-1160"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1161"></a>If ctxt is non-empty, the HsQualTy really is a /function/, so the
<a name="line-1162"></a>kind of the result really is '*', and in that case the kind of the
<a name="line-1163"></a>body-type can be lifted or unlifted.
<a name="line-1164"></a>
<a name="line-1165"></a>However, consider
<a name="line-1166"></a>    instance Eq a =&gt; Eq [a] where ...
<a name="line-1167"></a>or
<a name="line-1168"></a>    f :: (Eq a =&gt; Eq [a]) =&gt; blah
<a name="line-1169"></a>Here both body-kind of the HsQualTy is Constraint rather than *.
<a name="line-1170"></a>Rather crudely we tell the difference by looking at exp_kind. It's
<a name="line-1171"></a>very convenient to typecheck instance types like any other HsSigType.
<a name="line-1172"></a>
<a name="line-1173"></a>Admittedly the '(Eq a =&gt; Eq [a]) =&gt; blah' case is erroneous, but it's
<a name="line-1174"></a>better to reject in checkValidType.  If we say that the body kind
<a name="line-1175"></a>should be '*' we risk getting TWO error messages, one saying that Eq
<a name="line-1176"></a>[a] doens't have kind '*', and one saying that we need a Constraint to
<a name="line-1177"></a>the left of the outer (=&gt;).
<a name="line-1178"></a>
<a name="line-1179"></a>How do we figure out the right body kind?  Well, it's a bit of a
<a name="line-1180"></a>kludge: I just look at the expected kind.  If it's Constraint, we
<a name="line-1181"></a>must be in this instance situation context. It's a kludge because it
<a name="line-1182"></a>wouldn't work if any unification was involved to compute that result
<a name="line-1183"></a>kind -- but it isn't.  (The true way might be to use the 'mode'
<a name="line-1184"></a>parameter, but that seemed like a sledgehammer to crack a nut.)
<a name="line-1185"></a>
<a name="line-1186"></a>Note [Inferring tuple kinds]
<a name="line-1187"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1188"></a>Give a tuple type (a,b,c), which the parser labels as HsBoxedOrConstraintTuple,
<a name="line-1189"></a>we try to figure out whether it's a tuple of kind * or Constraint.
<a name="line-1190"></a>  Step 1: look at the expected kind
<a name="line-1191"></a>  Step 2: infer argument kinds
<a name="line-1192"></a>
<a name="line-1193"></a>If after Step 2 it's not clear from the arguments that it's
<a name="line-1194"></a>Constraint, then it must be *.  Once having decided that we re-check
<a name="line-1195"></a>the Check the arguments again to give good error messages
<a name="line-1196"></a>in eg. `(Maybe, Maybe)`
<a name="line-1197"></a>
<a name="line-1198"></a>Note that we will still fail to infer the correct kind in this case:
<a name="line-1199"></a>
<a name="line-1200"></a>  type T a = ((a,a), D a)
<a name="line-1201"></a>  type family D :: Constraint -&gt; Constraint
<a name="line-1202"></a>
<a name="line-1203"></a>While kind checking T, we do not yet know the kind of D, so we will default the
<a name="line-1204"></a>kind of T to * -&gt; *. It works if we annotate `a` with kind `Constraint`.
<a name="line-1205"></a>
<a name="line-1206"></a>Note [Desugaring types]
<a name="line-1207"></a>~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1208"></a>The type desugarer is phase 2 of dealing with HsTypes.  Specifically:
<a name="line-1209"></a>
<a name="line-1210"></a>  * It transforms from HsType to Type
<a name="line-1211"></a>
<a name="line-1212"></a>  * It zonks any kinds.  The returned type should have no mutable kind
<a name="line-1213"></a>    or type variables (hence returning Type not TcType):
<a name="line-1214"></a>      - any unconstrained kind variables are defaulted to (Any *) just
<a name="line-1215"></a>        as in TcHsSyn.
<a name="line-1216"></a>      - there are no mutable type variables because we are
<a name="line-1217"></a>        kind-checking a type
<a name="line-1218"></a>    Reason: the returned type may be put in a TyCon or DataCon where
<a name="line-1219"></a>    it will never subsequently be zonked.
<a name="line-1220"></a>
<a name="line-1221"></a>You might worry about nested scopes:
<a name="line-1222"></a>        ..a:kappa in scope..
<a name="line-1223"></a>            let f :: forall b. T '[a,b] -&gt; Int
<a name="line-1224"></a>In this case, f's type could have a mutable kind variable kappa in it;
<a name="line-1225"></a>and we might then default it to (Any *) when dealing with f's type
<a name="line-1226"></a>signature.  But we don't expect this to happen because we can't get a
<a name="line-1227"></a>lexically scoped type variable with a mutable kind variable in it.  A
<a name="line-1228"></a>delicate point, this.  If it becomes an issue we might need to
<a name="line-1229"></a>distinguish top-level from nested uses.
<a name="line-1230"></a>
<a name="line-1231"></a>Moreover
<a name="line-1232"></a>  * it cannot fail,
<a name="line-1233"></a>  * it does no unifications
<a name="line-1234"></a>  * it does no validity checking, except for structural matters, such as
<a name="line-1235"></a>        (a) spurious ! annotations.
<a name="line-1236"></a>        (b) a class used as a type
<a name="line-1237"></a>
<a name="line-1238"></a>Note [Kind of a type splice]
<a name="line-1239"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1240"></a>Consider these terms, each with TH type splice inside:
<a name="line-1241"></a>     [| e1 :: Maybe $(..blah..) |]
<a name="line-1242"></a>     [| e2 :: $(..blah..) |]
<a name="line-1243"></a>When kind-checking the type signature, we'll kind-check the splice
<a name="line-1244"></a>$(..blah..); we want to give it a kind that can fit in any context,
<a name="line-1245"></a>as if $(..blah..) :: forall k. k.
<a name="line-1246"></a>
<a name="line-1247"></a>In the e1 example, the context of the splice fixes kappa to *.  But
<a name="line-1248"></a>in the e2 example, we'll desugar the type, zonking the kind unification
<a name="line-1249"></a>variables as we go.  When we encounter the unconstrained kappa, we
<a name="line-1250"></a>want to default it to '*', not to (Any *).
<a name="line-1251"></a>
<a name="line-1252"></a>
<a name="line-1253"></a>Help functions for type applications
<a name="line-1254"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1255"></a>-}</span>
<a name="line-1256"></a>
<a name="line-1257"></a><a name="addTypeCtxt"></a><span class='hs-definition'>addTypeCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1258"></a>        <span class='hs-comment'>-- Wrap a context around only if we want to show that contexts.</span>
<a name="line-1259"></a>        <span class='hs-comment'>-- Omit invisible ones and ones user's won't grok</span>
<a name="line-1260"></a><span class='hs-definition'>addTypeCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing</span>
<a name="line-1261"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>thing</span>
<a name="line-1262"></a>  <span class='hs-keyword'>where</span>
<a name="line-1263"></a>    <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"In the type"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1264"></a>
<a name="line-1265"></a><span class='hs-comment'>{-
<a name="line-1266"></a>************************************************************************
<a name="line-1267"></a>*                                                                      *
<a name="line-1268"></a>                Type-variable binders
<a name="line-1269"></a>%*                                                                      *
<a name="line-1270"></a>%************************************************************************
<a name="line-1271"></a>
<a name="line-1272"></a>Note [Scope-check inferred kinds]
<a name="line-1273"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1274"></a>Consider
<a name="line-1275"></a>
<a name="line-1276"></a>  data SameKind :: k -&gt; k -&gt; *
<a name="line-1277"></a>  foo :: forall a (b :: Proxy a) (c :: Proxy d). SameKind b c
<a name="line-1278"></a>
<a name="line-1279"></a>d has no binding site. So it gets bound implicitly, at the top. The
<a name="line-1280"></a>problem is that d's kind mentions `a`. So it's all ill-scoped.
<a name="line-1281"></a>
<a name="line-1282"></a>The way we check for this is to gather all variables *bound* in a
<a name="line-1283"></a>type variable's scope. The type variable's kind should not mention
<a name="line-1284"></a>any of these variables. That is, d's kind can't mention a, b, or c.
<a name="line-1285"></a>We can't just check to make sure that d's kind is in scope, because
<a name="line-1286"></a>we might be about to kindGeneralize.
<a name="line-1287"></a>
<a name="line-1288"></a>A little messy, but it works.
<a name="line-1289"></a>
<a name="line-1290"></a>Note [Dependent LHsQTyVars]
<a name="line-1291"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1292"></a>We track (in the renamer) which explicitly bound variables in a
<a name="line-1293"></a>LHsQTyVars are manifestly dependent; only precisely these variables
<a name="line-1294"></a>may be used within the LHsQTyVars. We must do this so that kcHsTyVarBndrs
<a name="line-1295"></a>can produce the right TyConBinders, and tell Anon vs. Required.
<a name="line-1296"></a>
<a name="line-1297"></a>Example   data T k1 (a:k1) (b:k2) c
<a name="line-1298"></a>               = MkT (Proxy a) (Proxy b) (Proxy c)
<a name="line-1299"></a>
<a name="line-1300"></a>Here
<a name="line-1301"></a>  (a:k1),(b:k2),(c:k3)
<a name="line-1302"></a>       are Anon     (explicitly specified as a binder, not used
<a name="line-1303"></a>                     in the kind of any other binder
<a name="line-1304"></a>  k1   is Required  (explicitly specifed as a binder, but used
<a name="line-1305"></a>                     in the kind of another binder i.e. dependently)
<a name="line-1306"></a>  k2   is Specified (not explicitly bound, but used in the kind
<a name="line-1307"></a>                     of another binder)
<a name="line-1308"></a>  k3   in Inferred  (not lexically in scope at all, but inferred
<a name="line-1309"></a>                     by kind inference)
<a name="line-1310"></a>and
<a name="line-1311"></a>  T :: forall {k3} k1. forall k3 -&gt; k1 -&gt; k2 -&gt; k3 -&gt; *
<a name="line-1312"></a>
<a name="line-1313"></a>See Note [TyVarBndrs, TyVarBinders, TyConBinders, and visiblity]
<a name="line-1314"></a>in TyCoRep.
<a name="line-1315"></a>
<a name="line-1316"></a>kcHsTyVarBndrs uses the hsq_dependent field to decide whether
<a name="line-1317"></a>k1, a, b, c should be Required or Anon.
<a name="line-1318"></a>
<a name="line-1319"></a>Earlier, thought it would work simply to do a free-variable check
<a name="line-1320"></a>during kcHsTyVarBndrs, but this is bogus, because there may be
<a name="line-1321"></a>unsolved equalities about. And we don't want to eagerly solve the
<a name="line-1322"></a>equalities, because we may get further information after
<a name="line-1323"></a>kcHsTyVarBndrs is called.  (Recall that kcHsTyVarBndrs is usually
<a name="line-1324"></a>called from getInitialKind.  The only other case is in kcConDecl.)
<a name="line-1325"></a>This is what implements the rule that all variables intended to be
<a name="line-1326"></a>dependent must be manifestly so.
<a name="line-1327"></a>
<a name="line-1328"></a>Sidenote: It's quite possible that later, we'll consider (t -&gt; s)
<a name="line-1329"></a>as a degenerate case of some (pi (x :: t) -&gt; s) and then this will
<a name="line-1330"></a>all get more permissive.
<a name="line-1331"></a>
<a name="line-1332"></a>-}</span>
<a name="line-1333"></a>
<a name="line-1334"></a><a name="tcWildCardBinders"></a><span class='hs-definition'>tcWildCardBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-1335"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1336"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1337"></a><span class='hs-definition'>tcWildCardBinders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcWildCardBindersX</span> <span class='hs-varid'>new_tv</span>
<a name="line-1338"></a>  <span class='hs-keyword'>where</span>
<a name="line-1339"></a>    <span class='hs-varid'>new_tv</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-1340"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>newSkolemTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-1341"></a>
<a name="line-1342"></a><a name="tcWildCardBindersX"></a><span class='hs-definition'>tcWildCardBindersX</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span>
<a name="line-1343"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-1344"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1345"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1346"></a><span class='hs-definition'>tcWildCardBindersX</span> <span class='hs-varid'>new_wc</span> <span class='hs-varid'>wc_names</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1347"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wcs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>new_wc</span> <span class='hs-varid'>wc_names</span>
<a name="line-1348"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>wc_prs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc_names</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>wcs</span>
<a name="line-1349"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendTyVarEnv2</span> <span class='hs-varid'>wc_prs</span> <span class='hs-varop'>$</span>
<a name="line-1350"></a>         <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>wc_prs</span> <span class='hs-layout'>}</span>
<a name="line-1351"></a>
<a name="line-1352"></a><a name="kcHsTyVarBndrs"></a><span class='hs-comment'>-- | Kind-check a 'LHsQTyVars'. If the decl under consideration has a complete,</span>
<a name="line-1353"></a><span class='hs-comment'>-- user-supplied kind signature (CUSK), generalise the result.</span>
<a name="line-1354"></a><span class='hs-comment'>-- Used in 'getInitialKind' (for tycon kinds and other kinds)</span>
<a name="line-1355"></a><span class='hs-comment'>-- and in kind-checking (but not for tycon kinds, which are checked with</span>
<a name="line-1356"></a><span class='hs-comment'>-- tcTyClDecls). See also Note [Complete user-supplied kind signatures] in</span>
<a name="line-1357"></a><span class='hs-comment'>-- HsDecls.</span>
<a name="line-1358"></a><span class='hs-comment'>--</span>
<a name="line-1359"></a><span class='hs-comment'>-- This function does not do telescope checking.</span>
<a name="line-1360"></a><span class='hs-definition'>kcHsTyVarBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>    <span class='hs-comment'>-- ^ of the thing being checked</span>
<a name="line-1361"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyConFlavour</span> <span class='hs-comment'>-- ^ What sort of 'TyCon' is being checked</span>
<a name="line-1362"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>    <span class='hs-comment'>-- ^ True &lt;=&gt; the decl being checked has a CUSK</span>
<a name="line-1363"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>    <span class='hs-comment'>-- ^ True &lt;=&gt; all the hsq_implicit are *kind* vars</span>
<a name="line-1364"></a>                          <span class='hs-comment'>-- (will give these kind * if -XNoTypeInType)</span>
<a name="line-1365"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsQTyVars</span> <span class='hs-conid'>GhcRn</span>
<a name="line-1366"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>     <span class='hs-comment'>-- ^ The result kind, possibly with other info</span>
<a name="line-1367"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- ^ A suitably-kinded TcTyCon</span>
<a name="line-1368"></a><span class='hs-definition'>kcHsTyVarBndrs</span> <span class='hs-varid'>name</span> <span class='hs-varid'>flav</span> <span class='hs-varid'>cusk</span> <span class='hs-varid'>all_kind_vars</span>
<a name="line-1369"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>HsQTvs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsq_implicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kv_ns</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsq_explicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_tvs</span>
<a name="line-1370"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>hsq_dependent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dep_names</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1371"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cusk</span>
<a name="line-1372"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kv_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mk_kv_kinds</span>
<a name="line-1373"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>lvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcLevel</span>
<a name="line-1374"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>scoped_kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_skolem_tv</span> <span class='hs-varid'>lvl</span><span class='hs-layout'>)</span> <span class='hs-varid'>kv_ns</span> <span class='hs-varid'>kv_kinds</span>
<a name="line-1375"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendTyVarEnv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>kv_ns</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>scoped_kvs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1376"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_binders</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>stuff</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>solveEqualities</span> <span class='hs-varop'>$</span>
<a name="line-1377"></a>                                          <span class='hs-varid'>bind_telescope</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1378"></a>
<a name="line-1379"></a>           <span class='hs-comment'>-- Now, because we're in a CUSK, quantify over the mentioned</span>
<a name="line-1380"></a>           <span class='hs-comment'>-- kind vars, in dependency order.</span>
<a name="line-1381"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc_binders</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcTyVarBinder</span> <span class='hs-varid'>tc_binders</span>
<a name="line-1382"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>res_kind</span>
<a name="line-1383"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tc_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binderVars</span> <span class='hs-varid'>tc_binders</span>
<a name="line-1384"></a>             <span class='hs-varid'>qkvs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfTypeWellScoped</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConKind</span> <span class='hs-varid'>tc_binders</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span>
<a name="line-1385"></a>                   <span class='hs-comment'>-- the visibility of tvs doesn't matter here; we just</span>
<a name="line-1386"></a>                   <span class='hs-comment'>-- want the free variables not to include the tvs</span>
<a name="line-1387"></a>
<a name="line-1388"></a>          <span class='hs-comment'>-- If there are any meta-tvs left, the user has</span>
<a name="line-1389"></a>          <span class='hs-comment'>-- lied about having a CUSK. Error.</span>
<a name="line-1390"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>meta_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>good_tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>qkvs</span>
<a name="line-1391"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>meta_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1392"></a>         <span class='hs-varid'>report_non_cusk_tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>qkvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tc_tvs</span><span class='hs-layout'>)</span>
<a name="line-1393"></a>
<a name="line-1394"></a>          <span class='hs-comment'>-- If any of the scoped_kvs aren't actually mentioned in a binder's</span>
<a name="line-1395"></a>          <span class='hs-comment'>-- kind (or the return kind), then we're in the CUSK case from</span>
<a name="line-1396"></a>          <span class='hs-comment'>-- Note [Free-floating kind vars]</span>
<a name="line-1397"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>all_tc_tvs</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>good_tvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tc_tvs</span>
<a name="line-1398"></a>             <span class='hs-varid'>all_mentioned_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapUnionVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyVarKind</span><span class='hs-layout'>)</span>
<a name="line-1399"></a>                                                <span class='hs-varid'>all_tc_tvs</span>
<a name="line-1400"></a>                                 <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>res_kind</span>
<a name="line-1401"></a>             <span class='hs-varid'>unmentioned_kvs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>all_mentioned_tvs</span><span class='hs-layout'>)</span>
<a name="line-1402"></a>                                           <span class='hs-varid'>scoped_kvs</span>
<a name="line-1403"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>reportFloatingKvs</span> <span class='hs-varid'>name</span> <span class='hs-varid'>flav</span> <span class='hs-varid'>all_tc_tvs</span> <span class='hs-varid'>unmentioned_kvs</span>
<a name="line-1404"></a>
<a name="line-1405"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>final_binders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNamedTyConBinder</span> <span class='hs-conid'>Specified</span><span class='hs-layout'>)</span> <span class='hs-varid'>good_tvs</span>
<a name="line-1406"></a>                            <span class='hs-varop'>++</span> <span class='hs-varid'>tc_binders</span>
<a name="line-1407"></a>             <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyCon</span> <span class='hs-varid'>name</span> <span class='hs-varid'>final_binders</span> <span class='hs-varid'>res_kind</span>
<a name="line-1408"></a>                               <span class='hs-layout'>(</span><span class='hs-varid'>scoped_kvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tc_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>flav</span>
<a name="line-1409"></a>                           <span class='hs-comment'>-- the tvs contain the binders already</span>
<a name="line-1410"></a>                           <span class='hs-comment'>-- in scope from an enclosing class, but</span>
<a name="line-1411"></a>                           <span class='hs-comment'>-- re-adding tvs to the env't doesn't cause</span>
<a name="line-1412"></a>                           <span class='hs-comment'>-- harm</span>
<a name="line-1413"></a>
<a name="line-1414"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"kcHsTyVarBndrs: cusk"</span> <span class='hs-varop'>$</span>
<a name="line-1415"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kv_ns</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dep_names</span>
<a name="line-1416"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_binders</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConKind</span> <span class='hs-varid'>tc_binders</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span>
<a name="line-1417"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>qkvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>meta_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>good_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>final_binders</span> <span class='hs-keyglyph'>]</span>
<a name="line-1418"></a>
<a name="line-1419"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tycon</span><span class='hs-layout'>,</span> <span class='hs-varid'>stuff</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-1420"></a>
<a name="line-1421"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1422"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kv_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mk_kv_kinds</span>
<a name="line-1423"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>scoped_kvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-varid'>newSigTyVar</span> <span class='hs-varid'>kv_ns</span> <span class='hs-varid'>kv_kinds</span>
<a name="line-1424"></a>                     <span class='hs-comment'>-- the names must line up in splitTelescopeTvs</span>
<a name="line-1425"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>binders</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>stuff</span><span class='hs-layout'>)</span>
<a name="line-1426"></a>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendTyVarEnv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>kv_ns</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>scoped_kvs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1427"></a>              <span class='hs-varid'>bind_telescope</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1428"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>   <span class='hs-comment'>-- NB: Don't add scoped_kvs to tyConTyVars, because they</span>
<a name="line-1429"></a>               <span class='hs-comment'>-- must remain lined up with the binders</span>
<a name="line-1430"></a>             <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyCon</span> <span class='hs-varid'>name</span> <span class='hs-varid'>binders</span> <span class='hs-varid'>res_kind</span>
<a name="line-1431"></a>                               <span class='hs-layout'>(</span><span class='hs-varid'>scoped_kvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>binderVars</span> <span class='hs-varid'>binders</span><span class='hs-layout'>)</span> <span class='hs-varid'>flav</span>
<a name="line-1432"></a>
<a name="line-1433"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"kcHsTyVarBndrs: not-cusk"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>binders</span><span class='hs-layout'>)</span>
<a name="line-1434"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tycon</span><span class='hs-layout'>,</span> <span class='hs-varid'>stuff</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1435"></a>  <span class='hs-keyword'>where</span>
<a name="line-1436"></a>    <span class='hs-varid'>open_fam</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcFlavourIsOpen</span> <span class='hs-varid'>flav</span>
<a name="line-1437"></a>
<a name="line-1438"></a>      <span class='hs-comment'>-- if -XNoTypeInType and we know all the implicits are kind vars,</span>
<a name="line-1439"></a>      <span class='hs-comment'>-- just give the kind *. This prevents test</span>
<a name="line-1440"></a>      <span class='hs-comment'>-- dependent/should_fail/KindLevelsB from compiling, as it should</span>
<a name="line-1441"></a>    <span class='hs-varid'>mk_kv_kinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Kind</span><span class='hs-keyglyph'>]</span>
<a name="line-1442"></a>    <span class='hs-varid'>mk_kv_kinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>typeintype</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>TypeInType</span>
<a name="line-1443"></a>                     <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-varid'>typeintype</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>all_kind_vars</span>
<a name="line-1444"></a>                       <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>liftedTypeKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>kv_ns</span><span class='hs-layout'>)</span>
<a name="line-1445"></a>                       <span class='hs-keyword'>else</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>newMetaKindVar</span><span class='hs-layout'>)</span> <span class='hs-varid'>kv_ns</span> <span class='hs-layout'>}</span>
<a name="line-1446"></a>
<a name="line-1447"></a>      <span class='hs-comment'>-- there may be dependency between the explicit "ty" vars. So, we have</span>
<a name="line-1448"></a>      <span class='hs-comment'>-- to handle them one at a time.</span>
<a name="line-1449"></a>    <span class='hs-varid'>bind_telescope</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>
<a name="line-1450"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-1451"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyConBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-1452"></a>    <span class='hs-varid'>bind_telescope</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>thing</span>
<a name="line-1453"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>res_kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>stuff</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing</span>
<a name="line-1454"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>stuff</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1455"></a>    <span class='hs-varid'>bind_telescope</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>hs_tv</span> <span class='hs-conop'>:</span> <span class='hs-varid'>hs_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing</span>
<a name="line-1456"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tv_pair</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kc_hs_tv</span> <span class='hs-varid'>hs_tv</span>
<a name="line-1457"></a>               <span class='hs-comment'>-- NB: Bring all tvs into scope, even non-dependent ones,</span>
<a name="line-1458"></a>               <span class='hs-comment'>-- as they're needed in type synonyms, data constructors, etc.</span>
<a name="line-1459"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>binders</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>stuff</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bind_unless_scoped</span> <span class='hs-varid'>tv_pair</span> <span class='hs-varop'>$</span>
<a name="line-1460"></a>                                           <span class='hs-varid'>bind_telescope</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-varop'>$</span>
<a name="line-1461"></a>                                           <span class='hs-varid'>thing</span>
<a name="line-1462"></a>                  <span class='hs-comment'>-- See Note [Dependent LHsQTyVars]</span>
<a name="line-1463"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_binder</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>hsTyVarName</span> <span class='hs-varid'>hs_tv</span> <span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>dep_names</span>
<a name="line-1464"></a>                            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNamedTyConBinder</span> <span class='hs-conid'>Required</span> <span class='hs-varid'>tv</span>
<a name="line-1465"></a>                            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1466"></a>                            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAnonTyConBinder</span> <span class='hs-varid'>tv</span>
<a name="line-1467"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>new_binder</span> <span class='hs-conop'>:</span> <span class='hs-varid'>binders</span>
<a name="line-1468"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>stuff</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1469"></a>
<a name="line-1470"></a>    <span class='hs-comment'>-- | Bind the tyvar in the env't unless the bool is True</span>
<a name="line-1471"></a>    <span class='hs-varid'>bind_unless_scoped</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1472"></a>    <span class='hs-varid'>bind_unless_scoped</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>   <span class='hs-varid'>thing_inside</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1473"></a>    <span class='hs-varid'>bind_unless_scoped</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1474"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tv</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1475"></a>
<a name="line-1476"></a>    <span class='hs-varid'>kc_hs_tv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsTyVarBndr</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>
<a name="line-1477"></a>    <span class='hs-varid'>kc_hs_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>UserTyVar</span> <span class='hs-varid'>lname</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1478"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tv_pair</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>scoped</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsTyVarName</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>name</span>
<a name="line-1479"></a>
<a name="line-1480"></a>              <span class='hs-comment'>-- Open type/data families default their variables to kind *.</span>
<a name="line-1481"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>open_fam</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>scoped</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-comment'>-- (don't default class tyvars)</span>
<a name="line-1482"></a>             <span class='hs-varid'>discardResult</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unifyKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-conid'>NotPromoted</span> <span class='hs-varid'>lname</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-1483"></a>                                       <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-1484"></a>
<a name="line-1485"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tv_pair</span> <span class='hs-layout'>}</span>
<a name="line-1486"></a>
<a name="line-1487"></a>    <span class='hs-varid'>kc_hs_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>lhs_kind</span><span class='hs-layout'>)</span>
<a name="line-1488"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLHsKindSig</span> <span class='hs-varid'>lhs_kind</span>
<a name="line-1489"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>tcHsTyVarName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span>
<a name="line-1490"></a>
<a name="line-1491"></a>    <span class='hs-varid'>report_non_cusk_tvs</span> <span class='hs-varid'>all_tvs</span>
<a name="line-1492"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>all_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTyCoVarKind</span> <span class='hs-varid'>all_tvs</span>
<a name="line-1493"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_tvs</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenTyCoVars</span> <span class='hs-varid'>emptyTidyEnv</span> <span class='hs-varid'>all_tvs</span>
<a name="line-1494"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>meta_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>other_tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tidy_tvs</span>
<a name="line-1495"></a>
<a name="line-1496"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>addErr</span> <span class='hs-varop'>$</span>
<a name="line-1497"></a>             <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"You have written a *complete user-suppled kind signature*,"</span>
<a name="line-1498"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"but the following variable"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>meta_tvs</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-1499"></a>                          <span class='hs-varid'>isOrAre</span> <span class='hs-varid'>meta_tvs</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"undetermined:"</span><span class='hs-layout'>)</span>
<a name="line-1500"></a>                       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pp_tv</span> <span class='hs-varid'>meta_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1501"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Perhaps add a kind signature."</span>
<a name="line-1502"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Inferred kinds of user-written variables:"</span><span class='hs-layout'>)</span>
<a name="line-1503"></a>                       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pp_tv</span> <span class='hs-varid'>other_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-1504"></a>      <span class='hs-keyword'>where</span>
<a name="line-1505"></a>        <span class='hs-varid'>pp_tv</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-1506"></a>
<a name="line-1507"></a>
<a name="line-1508"></a><a name="tcImplicitTKBndrs"></a><span class='hs-definition'>tcImplicitTKBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-1509"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVarSet</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- vars are bound somewhere in the scope</span>
<a name="line-1510"></a>                                         <span class='hs-comment'>-- see Note [Scope-check inferred kinds]</span>
<a name="line-1511"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1512"></a><span class='hs-definition'>tcImplicitTKBndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcImplicitTKBndrsX</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcHsTyVarName</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-1513"></a>
<a name="line-1514"></a><a name="tcImplicitTKBndrsType"></a><span class='hs-comment'>-- | Convenient specialization</span>
<a name="line-1515"></a><span class='hs-definition'>tcImplicitTKBndrsType</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-1516"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-1517"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1518"></a><span class='hs-definition'>tcImplicitTKBndrsType</span> <span class='hs-varid'>var_ns</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1519"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcImplicitTKBndrs</span> <span class='hs-varid'>var_ns</span> <span class='hs-varop'>$</span>
<a name="line-1520"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1521"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>allBoundVariables</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1522"></a>
<a name="line-1523"></a><a name="tcImplicitTKBndrsX"></a><span class='hs-comment'>-- this more general variant is needed in tcHsPatSigType.</span>
<a name="line-1524"></a><span class='hs-comment'>-- See Note [Pattern signature binders]</span>
<a name="line-1525"></a><span class='hs-definition'>tcImplicitTKBndrsX</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- new_tv function</span>
<a name="line-1526"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-1527"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVarSet</span><span class='hs-layout'>)</span>
<a name="line-1528"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1529"></a><span class='hs-comment'>-- Returned TcTyVars have the supplied Names,</span>
<a name="line-1530"></a><span class='hs-comment'>-- but may be in different order to the original [Name]</span>
<a name="line-1531"></a><span class='hs-comment'>--   (because of sorting to respect dependency)</span>
<a name="line-1532"></a><span class='hs-comment'>-- Returned TcTyVars have zonked kinds</span>
<a name="line-1533"></a><span class='hs-definition'>tcImplicitTKBndrsX</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>var_ns</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1534"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tkvs_pairs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>var_ns</span>
<a name="line-1535"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>must_scope_tkvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>tkv</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>tkv</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tkvs_pairs</span> <span class='hs-keyglyph'>]</span>
<a name="line-1536"></a>             <span class='hs-varid'>tkvs</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>tkvs_pairs</span>
<a name="line-1537"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-varid'>bound_tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-varid'>must_scope_tkvs</span> <span class='hs-varop'>$</span>
<a name="line-1538"></a>                                <span class='hs-varid'>thing_inside</span>
<a name="line-1539"></a>
<a name="line-1540"></a>         <span class='hs-comment'>-- Check that the implicitly-bound kind variable</span>
<a name="line-1541"></a>         <span class='hs-comment'>-- really can go at the beginning.</span>
<a name="line-1542"></a>         <span class='hs-comment'>-- e.g.   forall (a :: k) (b :: *). ...(forces k :: b)...</span>
<a name="line-1543"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tkvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTyCoVarKind</span> <span class='hs-varid'>tkvs</span>
<a name="line-1544"></a>                 <span class='hs-comment'>-- NB: /not/ zonkTcTyVarToTyVar. tcImplicitTKBndrsX</span>
<a name="line-1545"></a>                 <span class='hs-comment'>-- guarantees to return TcTyVars with the same Names</span>
<a name="line-1546"></a>                 <span class='hs-comment'>-- as the var_ns.  See [Pattern signature binders]</span>
<a name="line-1547"></a>
<a name="line-1548"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>extra</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"NB: Implicitly-bound variables always come"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-1549"></a>                     <span class='hs-varid'>text</span> <span class='hs-str'>"before other ones."</span>
<a name="line-1550"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidInferredKinds</span> <span class='hs-varid'>tkvs</span> <span class='hs-varid'>bound_tvs</span> <span class='hs-varid'>extra</span>
<a name="line-1551"></a>
<a name="line-1552"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>final_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toposortTyVars</span> <span class='hs-varid'>tkvs</span>
<a name="line-1553"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcImplicitTKBndrs"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>var_ns</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>final_tvs</span><span class='hs-layout'>)</span>
<a name="line-1554"></a>
<a name="line-1555"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>final_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1556"></a>
<a name="line-1557"></a><a name="tcExplicitTKBndrs"></a><span class='hs-definition'>tcExplicitTKBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>
<a name="line-1558"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVarSet</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1559"></a>                        <span class='hs-comment'>-- ^ Thing inside returns the set of variables bound</span>
<a name="line-1560"></a>                        <span class='hs-comment'>-- in the scope. See Note [Scope-check inferred kinds]</span>
<a name="line-1561"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVarSet</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- ^ returns augmented bound vars</span>
<a name="line-1562"></a><span class='hs-comment'>-- No cloning: returned TyVars have the same Name as the incoming LHsTyVarBndrs</span>
<a name="line-1563"></a><span class='hs-definition'>tcExplicitTKBndrs</span> <span class='hs-varid'>orig_hs_tvs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1564"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcExplicitTKBndrsX</span> <span class='hs-varid'>newSkolemTyVar</span> <span class='hs-varid'>orig_hs_tvs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1565"></a>
<a name="line-1566"></a><a name="tcExplicitTKBndrsX"></a><span class='hs-definition'>tcExplicitTKBndrsX</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-1567"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>
<a name="line-1568"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVarSet</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1569"></a>                        <span class='hs-comment'>-- ^ Thing inside returns the set of variables bound</span>
<a name="line-1570"></a>                        <span class='hs-comment'>-- in the scope. See Note [Scope-check inferred kinds]</span>
<a name="line-1571"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVarSet</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- ^ returns augmented bound vars</span>
<a name="line-1572"></a><span class='hs-definition'>tcExplicitTKBndrsX</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>orig_hs_tvs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1573"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>orig_hs_tvs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1574"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-varid'>bound_tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>tvs</span>
<a name="line-1575"></a>
<a name="line-1576"></a>         <span class='hs-comment'>-- Issue an error if the ordering is bogus.</span>
<a name="line-1577"></a>         <span class='hs-comment'>-- See Note [Bad telescopes] in TcValidity.</span>
<a name="line-1578"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkZonkValidTelescope</span> <span class='hs-layout'>(</span><span class='hs-varid'>interppSP</span> <span class='hs-varid'>orig_hs_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>empty</span>
<a name="line-1579"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidInferredKinds</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>bound_tvs</span> <span class='hs-varid'>empty</span>
<a name="line-1580"></a>
<a name="line-1581"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcExplicitTKBndrs"</span> <span class='hs-varop'>$</span>
<a name="line-1582"></a>           <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Hs vars:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_hs_tvs</span>
<a name="line-1583"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"tvs:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprTyVar</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-1584"></a>
<a name="line-1585"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-varid'>bound_tvs</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-1586"></a>       <span class='hs-layout'>}</span>
<a name="line-1587"></a>  <span class='hs-keyword'>where</span>
<a name="line-1588"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thing</span> <span class='hs-conid'>[]</span>
<a name="line-1589"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>hs_tv</span> <span class='hs-conop'>:</span> <span class='hs-varid'>hs_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing</span>
<a name="line-1590"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsTyVarBndr</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>hs_tv</span>
<a name="line-1591"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tv</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span>
<a name="line-1592"></a>             <span class='hs-varid'>go</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1593"></a>             <span class='hs-varid'>thing</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1594"></a>
<a name="line-1595"></a><a name="tcHsTyVarBndr"></a><span class='hs-definition'>tcHsTyVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-1596"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsTyVarBndr</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-1597"></a><span class='hs-comment'>-- Return a SkolemTv TcTyVar, initialised with a kind variable.</span>
<a name="line-1598"></a><span class='hs-comment'>-- Typically the Kind inside the HsTyVarBndr will be a tyvar</span>
<a name="line-1599"></a><span class='hs-comment'>-- with a mutable kind in it.</span>
<a name="line-1600"></a><span class='hs-comment'>-- NB: These variables must not be in scope. This function</span>
<a name="line-1601"></a><span class='hs-comment'>-- is not appropriate for use with associated types, for example.</span>
<a name="line-1602"></a><span class='hs-comment'>--</span>
<a name="line-1603"></a><span class='hs-comment'>-- Returned TcTyVar has the same name; no cloning</span>
<a name="line-1604"></a><span class='hs-comment'>--</span>
<a name="line-1605"></a><span class='hs-comment'>-- See also Note [Associated type tyvar names] in Class</span>
<a name="line-1606"></a><span class='hs-comment'>--</span>
<a name="line-1607"></a><span class='hs-definition'>tcHsTyVarBndr</span> <span class='hs-varid'>new_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>UserTyVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1608"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-1609"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-1610"></a>
<a name="line-1611"></a><span class='hs-definition'>tcHsTyVarBndr</span> <span class='hs-varid'>new_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-1612"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLHsKindSig</span> <span class='hs-varid'>kind</span>
<a name="line-1613"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-1614"></a>
<a name="line-1615"></a><a name="newWildTyVar"></a><span class='hs-definition'>newWildTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-1616"></a><span class='hs-comment'>-- ^ New unification variable for a wildcard</span>
<a name="line-1617"></a><span class='hs-definition'>newWildTyVar</span> <span class='hs-sel'>_name</span>
<a name="line-1618"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-1619"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-1620"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaDetails</span> <span class='hs-conid'>TauTv</span>
<a name="line-1621"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSysTvName</span> <span class='hs-varid'>uniq</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"w"</span><span class='hs-layout'>)</span>
<a name="line-1622"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1623"></a>
<a name="line-1624"></a><a name="tcHsTyVarName"></a><span class='hs-comment'>-- | Produce a tyvar of the given name (with the kind provided, or</span>
<a name="line-1625"></a><span class='hs-comment'>-- otherwise a meta-var kind). If</span>
<a name="line-1626"></a><span class='hs-comment'>-- the name is already in scope, return the scoped variable, checking</span>
<a name="line-1627"></a><span class='hs-comment'>-- to make sure the known kind matches any kind provided. The</span>
<a name="line-1628"></a><span class='hs-comment'>-- second return value says whether the variable is in scope (True)</span>
<a name="line-1629"></a><span class='hs-comment'>-- or not (False). (Use this for associated types, for example.)</span>
<a name="line-1630"></a><span class='hs-definition'>tcHsTyVarName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>
<a name="line-1631"></a><span class='hs-definition'>tcHsTyVarName</span> <span class='hs-varid'>m_kind</span> <span class='hs-varid'>name</span>
<a name="line-1632"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupLcl_maybe</span> <span class='hs-varid'>name</span>
<a name="line-1633"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_tv</span> <span class='hs-keyword'>of</span>
<a name="line-1634"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-1635"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>whenIsJust</span> <span class='hs-varid'>m_kind</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1636"></a>                     <span class='hs-varid'>discardResult</span> <span class='hs-varop'>$</span>
<a name="line-1637"></a>                     <span class='hs-varid'>unifyKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-conid'>NotPromoted</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-1638"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1639"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>m_kind</span> <span class='hs-keyword'>of</span>
<a name="line-1640"></a>                               <span class='hs-conid'>Just</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>kind</span>
<a name="line-1641"></a>                               <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-1642"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSkolemTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span>
<a name="line-1643"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-1644"></a>
<a name="line-1645"></a><a name="newSkolemTyVar"></a><span class='hs-comment'>-- makes a new skolem tv</span>
<a name="line-1646"></a><span class='hs-definition'>newSkolemTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-1647"></a><span class='hs-definition'>newSkolemTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcLevel</span>
<a name="line-1648"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_skolem_tv</span> <span class='hs-varid'>lvl</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1649"></a>
<a name="line-1650"></a><a name="mk_skolem_tv"></a><span class='hs-definition'>mk_skolem_tv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-1651"></a><span class='hs-definition'>mk_skolem_tv</span> <span class='hs-varid'>lvl</span> <span class='hs-varid'>n</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>n</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-conid'>SkolemTv</span> <span class='hs-varid'>lvl</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-1652"></a>
<a name="line-1653"></a><a name="kindGeneralizeType"></a><span class='hs-comment'>------------------</span>
<a name="line-1654"></a><span class='hs-definition'>kindGeneralizeType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-1655"></a><span class='hs-comment'>-- Result is zonked</span>
<a name="line-1656"></a><span class='hs-definition'>kindGeneralizeType</span> <span class='hs-varid'>ty</span>
<a name="line-1657"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kindGeneralize</span> <span class='hs-varid'>ty</span>
<a name="line-1658"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkSigType</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInvForAllTys</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1659"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span>  <span class='hs-layout'>}</span>
<a name="line-1660"></a>
<a name="line-1661"></a><a name="kindGeneralize"></a><span class='hs-definition'>kindGeneralize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>KindVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1662"></a><span class='hs-comment'>-- Quantify the free kind variables of a kind or type</span>
<a name="line-1663"></a><span class='hs-comment'>-- In the latter case the type is closed, so it has no free</span>
<a name="line-1664"></a><span class='hs-comment'>-- type variables.  So in both cases, all the free vars are kind vars</span>
<a name="line-1665"></a><span class='hs-definition'>kindGeneralize</span> <span class='hs-varid'>kind_or_type</span>
<a name="line-1666"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeAndFV</span> <span class='hs-varid'>kind_or_type</span>
<a name="line-1667"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>dvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DV</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dv_kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>dv_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyDVarSet</span> <span class='hs-layout'>}</span>
<a name="line-1668"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>gbl_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetGlobalTyCoVars</span> <span class='hs-comment'>-- Already zonked</span>
<a name="line-1669"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>quantifyTyVars</span> <span class='hs-varid'>gbl_tvs</span> <span class='hs-varid'>dvs</span> <span class='hs-layout'>}</span>
<a name="line-1670"></a>
<a name="line-1671"></a><span class='hs-comment'>{-
<a name="line-1672"></a>Note [Kind generalisation]
<a name="line-1673"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1674"></a>We do kind generalisation only at the outer level of a type signature.
<a name="line-1675"></a>For example, consider
<a name="line-1676"></a>  T :: forall k. k -&gt; *
<a name="line-1677"></a>  f :: (forall a. T a -&gt; Int) -&gt; Int
<a name="line-1678"></a>When kind-checking f's type signature we generalise the kind at
<a name="line-1679"></a>the outermost level, thus:
<a name="line-1680"></a>  f1 :: forall k. (forall (a:k). T k a -&gt; Int) -&gt; Int  -- YES!
<a name="line-1681"></a>and *not* at the inner forall:
<a name="line-1682"></a>  f2 :: (forall k. forall (a:k). T k a -&gt; Int) -&gt; Int  -- NO!
<a name="line-1683"></a>Reason: same as for HM inference on value level declarations,
<a name="line-1684"></a>we want to infer the most general type.  The f2 type signature
<a name="line-1685"></a>would be *less applicable* than f1, because it requires a more
<a name="line-1686"></a>polymorphic argument.
<a name="line-1687"></a>
<a name="line-1688"></a>NB: There are no explicit kind variables written in f's signature.
<a name="line-1689"></a>When there are, the renamer adds these kind variables to the list of
<a name="line-1690"></a>variables bound by the forall, so you can indeed have a type that's
<a name="line-1691"></a>higher-rank in its kind. But only by explicit request.
<a name="line-1692"></a>
<a name="line-1693"></a>Note [Kinds of quantified type variables]
<a name="line-1694"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1695"></a>tcTyVarBndrsGen quantifies over a specified list of type variables,
<a name="line-1696"></a>*and* over the kind variables mentioned in the kinds of those tyvars.
<a name="line-1697"></a>
<a name="line-1698"></a>Note that we must zonk those kinds (obviously) but less obviously, we
<a name="line-1699"></a>must return type variables whose kinds are zonked too. Example
<a name="line-1700"></a>    (a :: k7)  where  k7 := k9 -&gt; k9
<a name="line-1701"></a>We must return
<a name="line-1702"></a>    [k9, a:k9-&gt;k9]
<a name="line-1703"></a>and NOT
<a name="line-1704"></a>    [k9, a:k7]
<a name="line-1705"></a>Reason: we're going to turn this into a for-all type,
<a name="line-1706"></a>   forall k9. forall (a:k7). blah
<a name="line-1707"></a>which the type checker will then instantiate, and instantiate does not
<a name="line-1708"></a>look through unification variables!
<a name="line-1709"></a>
<a name="line-1710"></a>Hence using zonked_kinds when forming tvs'.
<a name="line-1711"></a>
<a name="line-1712"></a>Note [Free-floating kind vars]
<a name="line-1713"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1714"></a>Consider
<a name="line-1715"></a>
<a name="line-1716"></a>  data T = MkT (forall (a :: k). Proxy a)
<a name="line-1717"></a>  -- from test ghci/scripts/T7873
<a name="line-1718"></a>
<a name="line-1719"></a>This is not an existential datatype, but a higher-rank one (the forall
<a name="line-1720"></a>to the right of MkT). Also consider
<a name="line-1721"></a>
<a name="line-1722"></a>  data S a = MkS (Proxy (a :: k))
<a name="line-1723"></a>
<a name="line-1724"></a>According to the rules around implicitly-bound kind variables, in both
<a name="line-1725"></a>cases those k's scope over the whole declaration. The renamer grabs
<a name="line-1726"></a>it and adds it to the hsq_implicits field of the HsQTyVars of the
<a name="line-1727"></a>tycon. So it must be in scope during type-checking, but we want to
<a name="line-1728"></a>reject T while accepting S.
<a name="line-1729"></a>
<a name="line-1730"></a>Why reject T? Because the kind variable isn't fixed by anything. For
<a name="line-1731"></a>a variable like k to be implicit, it needs to be mentioned in the kind
<a name="line-1732"></a>of a tycon tyvar. But it isn't.
<a name="line-1733"></a>
<a name="line-1734"></a>Why accept S? Because kind inference tells us that a has kind k, so it's
<a name="line-1735"></a>all OK.
<a name="line-1736"></a>
<a name="line-1737"></a>Our approach depends on whether or not the datatype has a CUSK.
<a name="line-1738"></a>
<a name="line-1739"></a>Non-CUSK: In the first pass (kcTyClTyVars) we just bring
<a name="line-1740"></a>k into scope. In the second pass (tcTyClTyVars),
<a name="line-1741"></a>we check to make sure that k has been unified with some other variable
<a name="line-1742"></a>(or generalized over, making k into a skolem). If it hasn't been, then
<a name="line-1743"></a>it must be a free-floating kind var. Error.
<a name="line-1744"></a>
<a name="line-1745"></a>CUSK: When we determine the tycon's final, never-to-be-changed kind
<a name="line-1746"></a>in kcHsTyVarBndrs, we check to make sure all implicitly-bound kind
<a name="line-1747"></a>vars are indeed mentioned in a kind somewhere. If not, error.
<a name="line-1748"></a>
<a name="line-1749"></a>We also perform free-floating kind var analysis for type family instances
<a name="line-1750"></a>(see #13985). Here is an interesting example:
<a name="line-1751"></a>
<a name="line-1752"></a>    type family   T :: k
<a name="line-1753"></a>    type instance T = (Nothing :: Maybe a)
<a name="line-1754"></a>
<a name="line-1755"></a>Upon a cursory glance, it may appear that the kind variable `a` is
<a name="line-1756"></a>free-floating above, since there are no (visible) LHS patterns in `T`. However,
<a name="line-1757"></a>there is an *invisible* pattern due to the return kind, so inside of GHC, the
<a name="line-1758"></a>instance looks closer to this:
<a name="line-1759"></a>
<a name="line-1760"></a>    type family T @k :: k
<a name="line-1761"></a>    type instance T @(Maybe a) = (Nothing :: Maybe a)
<a name="line-1762"></a>
<a name="line-1763"></a>Here, we can see that `a` really is bound by a LHS type pattern, so `a` is in
<a name="line-1764"></a>fact not free-floating. Contrast that with this example:
<a name="line-1765"></a>
<a name="line-1766"></a>    type instance T = Proxy (Nothing :: Maybe a)
<a name="line-1767"></a>
<a name="line-1768"></a>This would looks like this inside of GHC:
<a name="line-1769"></a>
<a name="line-1770"></a>    type instance T @(*) = Proxy (Nothing :: Maybe a)
<a name="line-1771"></a>
<a name="line-1772"></a>So this time, `a` is neither bound by a visible nor invisible type pattern on
<a name="line-1773"></a>the LHS, so it would be reported as free-floating.
<a name="line-1774"></a>
<a name="line-1775"></a>Finally, here's one more brain-teaser (from #9574). In the example below:
<a name="line-1776"></a>
<a name="line-1777"></a>    class Funct f where
<a name="line-1778"></a>      type Codomain f :: *
<a name="line-1779"></a>    instance Funct ('KProxy :: KProxy o) where
<a name="line-1780"></a>      type Codomain 'KProxy = NatTr (Proxy :: o -&gt; *)
<a name="line-1781"></a>
<a name="line-1782"></a>As it turns out, `o` is not free-floating in this example. That is because `o`
<a name="line-1783"></a>bound by the kind signature of the LHS type pattern 'KProxy. To make this more
<a name="line-1784"></a>obvious, one can also write the instance like so:
<a name="line-1785"></a>
<a name="line-1786"></a>    instance Funct ('KProxy :: KProxy o) where
<a name="line-1787"></a>      type Codomain ('KProxy :: KProxy o) = NatTr (Proxy :: o -&gt; *)
<a name="line-1788"></a>
<a name="line-1789"></a>-}</span>
<a name="line-1790"></a>
<a name="line-1791"></a><a name="kcLookupTcTyCon"></a><span class='hs-comment'>--------------------</span>
<a name="line-1792"></a><span class='hs-comment'>-- getInitialKind has made a suitably-shaped kind for the type or class</span>
<a name="line-1793"></a><span class='hs-comment'>-- Look it up in the local environment. This is used only for tycons</span>
<a name="line-1794"></a><span class='hs-comment'>-- that we're currently type-checking, so we're sure to find a TcTyCon.</span>
<a name="line-1795"></a><span class='hs-definition'>kcLookupTcTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyCon</span>
<a name="line-1796"></a><span class='hs-definition'>kcLookupTcTyCon</span> <span class='hs-varid'>nm</span>
<a name="line-1797"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tc_ty_thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>nm</span>
<a name="line-1798"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tc_ty_thing</span> <span class='hs-keyword'>of</span>
<a name="line-1799"></a>           <span class='hs-conid'>ATcTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tc</span>
<a name="line-1800"></a>           <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"kcLookupTcTyCon"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_ty_thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1801"></a>
<a name="line-1802"></a><a name="kcTyClTyVars"></a><span class='hs-comment'>-----------------------</span>
<a name="line-1803"></a><span class='hs-comment'>-- | Bring tycon tyvars into scope. This is used during the "kind-checking"</span>
<a name="line-1804"></a><span class='hs-comment'>-- pass in TcTyClsDecls. (Never in getInitialKind, never in the</span>
<a name="line-1805"></a><span class='hs-comment'>-- "type-checking"/desugaring pass.)</span>
<a name="line-1806"></a><span class='hs-comment'>-- Never emits constraints, though the thing_inside might.</span>
<a name="line-1807"></a><span class='hs-definition'>kcTyClTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1808"></a><span class='hs-definition'>kcTyClTyVars</span> <span class='hs-varid'>tycon_name</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1809"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcLookupTcTyCon</span> <span class='hs-varid'>tycon_name</span>
<a name="line-1810"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcTyConScopedTyVars</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>}</span>
<a name="line-1811"></a>
<a name="line-1812"></a><a name="tcTyClTyVars"></a><span class='hs-definition'>tcTyClTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>
<a name="line-1813"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyConBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1814"></a><span class='hs-comment'>-- ^ Used for the type variables of a type or class decl</span>
<a name="line-1815"></a><span class='hs-comment'>-- on the second full pass (type-checking/desugaring) in TcTyClDecls.</span>
<a name="line-1816"></a><span class='hs-comment'>-- This is *not* used in the initial-kind run, nor in the "kind-checking" pass.</span>
<a name="line-1817"></a><span class='hs-comment'>-- Accordingly, everything passed to the continuation is fully zonked.</span>
<a name="line-1818"></a><span class='hs-comment'>--</span>
<a name="line-1819"></a><span class='hs-comment'>-- (tcTyClTyVars T [a,b] thing_inside)</span>
<a name="line-1820"></a><span class='hs-comment'>--   where T : forall k1 k2 (a:k1 -&gt; *) (b:k1). k2 -&gt; *</span>
<a name="line-1821"></a><span class='hs-comment'>--   calls thing_inside with arguments</span>
<a name="line-1822"></a><span class='hs-comment'>--      [k1,k2,a,b] [k1:*, k2:*, Anon (k1 -&gt; *), Anon k1] (k2 -&gt; *)</span>
<a name="line-1823"></a><span class='hs-comment'>--   having also extended the type environment with bindings</span>
<a name="line-1824"></a><span class='hs-comment'>--   for k1,k2,a,b</span>
<a name="line-1825"></a><span class='hs-comment'>--</span>
<a name="line-1826"></a><span class='hs-comment'>-- Never emits constraints.</span>
<a name="line-1827"></a><span class='hs-comment'>--</span>
<a name="line-1828"></a><span class='hs-comment'>-- The LHsTyVarBndrs is always user-written, and the full, generalised</span>
<a name="line-1829"></a><span class='hs-comment'>-- kind of the tycon is available in the local env.</span>
<a name="line-1830"></a><span class='hs-definition'>tcTyClTyVars</span> <span class='hs-varid'>tycon_name</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1831"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcLookupTcTyCon</span> <span class='hs-varid'>tycon_name</span>
<a name="line-1832"></a>
<a name="line-1833"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>scoped_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTyConScopedTyVars</span> <span class='hs-varid'>tycon</span>
<a name="line-1834"></a>               <span class='hs-comment'>-- these are all zonked:</span>
<a name="line-1835"></a>             <span class='hs-varid'>binders</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConBinders</span> <span class='hs-varid'>tycon</span>
<a name="line-1836"></a>             <span class='hs-varid'>res_kind</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConResKind</span> <span class='hs-varid'>tycon</span>
<a name="line-1837"></a>
<a name="line-1838"></a>          <span class='hs-comment'>-- See Note [Free-floating kind vars]</span>
<a name="line-1839"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>zonked_scoped_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcTyVarToTyVar</span> <span class='hs-varid'>scoped_tvs</span>
<a name="line-1840"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>still_sig_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isSigTyVar</span> <span class='hs-varid'>zonked_scoped_tvs</span>
<a name="line-1841"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>reportFloatingKvs</span> <span class='hs-varid'>tycon_name</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConFlavour</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span>
<a name="line-1842"></a>                                         <span class='hs-varid'>zonked_scoped_tvs</span> <span class='hs-varid'>still_sig_tvs</span>
<a name="line-1843"></a>
<a name="line-1844"></a>          <span class='hs-comment'>-- Add the *unzonked* tyvars to the env't, because those</span>
<a name="line-1845"></a>          <span class='hs-comment'>-- are the ones mentioned in the source.</span>
<a name="line-1846"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcTyClTyVars"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tycon_name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>binders</span><span class='hs-layout'>)</span>
<a name="line-1847"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-varid'>scoped_tvs</span> <span class='hs-varop'>$</span>
<a name="line-1848"></a>         <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>binders</span> <span class='hs-varid'>res_kind</span> <span class='hs-layout'>}</span>
<a name="line-1849"></a>
<a name="line-1850"></a><a name="tcDataKindSig"></a><span class='hs-comment'>-----------------------------------</span>
<a name="line-1851"></a><span class='hs-definition'>tcDataKindSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>  <span class='hs-comment'>-- ^ Do we require the result to be *?</span>
<a name="line-1852"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyConBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>)</span>
<a name="line-1853"></a><span class='hs-comment'>-- GADT decls can have a (perhaps partial) kind signature</span>
<a name="line-1854"></a><span class='hs-comment'>--      e.g.  data T :: * -&gt; * -&gt; * where ...</span>
<a name="line-1855"></a><span class='hs-comment'>-- This function makes up suitable (kinded) type variables for</span>
<a name="line-1856"></a><span class='hs-comment'>-- the argument kinds, and checks that the result kind is indeed * if requested.</span>
<a name="line-1857"></a><span class='hs-comment'>-- (Otherwise, checks to make sure that the result kind is either * or a type variable.)</span>
<a name="line-1858"></a><span class='hs-comment'>-- See Note [Arity of data families] in FamInstEnv for more info.</span>
<a name="line-1859"></a><span class='hs-comment'>-- We use it also to make up argument type variables for for data instances.</span>
<a name="line-1860"></a><span class='hs-comment'>-- Never emits constraints.</span>
<a name="line-1861"></a><span class='hs-comment'>-- Returns the new TyVars, the extracted TyBinders, and the new, reduced</span>
<a name="line-1862"></a><span class='hs-comment'>-- result kind (which should always be Type or a synonym thereof)</span>
<a name="line-1863"></a><span class='hs-definition'>tcDataKindSig</span> <span class='hs-varid'>check_for_type</span> <span class='hs-varid'>kind</span>
<a name="line-1864"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varid'>res_kind</span> <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>check_for_type</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-1865"></a>                                                 <span class='hs-varid'>isJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcGetCastedTyVar_maybe</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1866"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>badKindSig</span> <span class='hs-varid'>check_for_type</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-1867"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>span</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-1868"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>us</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUniqueSupply</span>
<a name="line-1869"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>rdr_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLocalRdrEnv</span>
<a name="line-1870"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>uniqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqsFromSupply</span> <span class='hs-varid'>us</span>
<a name="line-1871"></a>              <span class='hs-varid'>occs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>allNameStrings</span>
<a name="line-1872"></a>                            <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkOccName</span> <span class='hs-varid'>tvName</span> <span class='hs-varid'>str</span>
<a name="line-1873"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>isNothing</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupLocalRdrOcc</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-1874"></a>                 <span class='hs-comment'>-- Note [Avoid name clashes for associated data types]</span>
<a name="line-1875"></a>
<a name="line-1876"></a>    <span class='hs-comment'>-- NB: Use the tv from a binder if there is one. Otherwise,</span>
<a name="line-1877"></a>    <span class='hs-comment'>-- we end up inventing a new Unique for it, and any other tv</span>
<a name="line-1878"></a>    <span class='hs-comment'>-- that mentions the first ends up with the wrong kind.</span>
<a name="line-1879"></a>              <span class='hs-varid'>extra_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith4</span> <span class='hs-varid'>mkTyBinderTyConBinder</span>
<a name="line-1880"></a>                              <span class='hs-varid'>tv_bndrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>repeat</span> <span class='hs-varid'>span</span><span class='hs-layout'>)</span> <span class='hs-varid'>uniqs</span> <span class='hs-varid'>occs</span>
<a name="line-1881"></a>
<a name="line-1882"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extra_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1883"></a>  <span class='hs-keyword'>where</span>
<a name="line-1884"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tv_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitPiTys</span> <span class='hs-varid'>kind</span>
<a name="line-1885"></a>
<a name="line-1886"></a><a name="badKindSig"></a><span class='hs-definition'>badKindSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1887"></a><span class='hs-definition'>badKindSig</span> <span class='hs-varid'>check_for_type</span> <span class='hs-varid'>kind</span>
<a name="line-1888"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Kind signature on data type declaration has non-*"</span>
<a name="line-1889"></a>             <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>check_for_type</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>empty</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>text</span> <span class='hs-str'>"and non-variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-1890"></a>               <span class='hs-varid'>text</span> <span class='hs-str'>"return kind"</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1891"></a>        <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-1892"></a>
<a name="line-1893"></a><span class='hs-comment'>{-
<a name="line-1894"></a>Note [Avoid name clashes for associated data types]
<a name="line-1895"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1896"></a>Consider    class C a b where
<a name="line-1897"></a>               data D b :: * -&gt; *
<a name="line-1898"></a>When typechecking the decl for D, we'll invent an extra type variable
<a name="line-1899"></a>for D, to fill out its kind.  Ideally we don't want this type variable
<a name="line-1900"></a>to be 'a', because when pretty printing we'll get
<a name="line-1901"></a>            class C a b where
<a name="line-1902"></a>               data D b a0
<a name="line-1903"></a>(NB: the tidying happens in the conversion to IfaceSyn, which happens
<a name="line-1904"></a>as part of pretty-printing a TyThing.)
<a name="line-1905"></a>
<a name="line-1906"></a>That's why we look in the LocalRdrEnv to see what's in scope. This is
<a name="line-1907"></a>important only to get nice-looking output when doing ":info C" in GHCi.
<a name="line-1908"></a>It isn't essential for correctness.
<a name="line-1909"></a>
<a name="line-1910"></a>
<a name="line-1911"></a>************************************************************************
<a name="line-1912"></a>*                                                                      *
<a name="line-1913"></a>             Partial signatures and pattern signatures
<a name="line-1914"></a>*                                                                      *
<a name="line-1915"></a>************************************************************************
<a name="line-1916"></a>
<a name="line-1917"></a>-}</span>
<a name="line-1918"></a>
<a name="line-1919"></a><a name="tcHsPartialSigType"></a><span class='hs-definition'>tcHsPartialSigType</span>
<a name="line-1920"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span>
<a name="line-1921"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigWcType</span> <span class='hs-conid'>GhcRn</span>       <span class='hs-comment'>-- The type signature</span>
<a name="line-1922"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- Wildcards</span>
<a name="line-1923"></a>         <span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcTyVar</span>      <span class='hs-comment'>-- Extra-constraints wildcard</span>
<a name="line-1924"></a>         <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>          <span class='hs-comment'>-- Implicitly and explicitly bound type variables</span>
<a name="line-1925"></a>         <span class='hs-layout'>,</span> <span class='hs-conid'>TcThetaType</span>        <span class='hs-comment'>-- Theta part</span>
<a name="line-1926"></a>         <span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span> <span class='hs-layout'>)</span>           <span class='hs-comment'>-- Tau part</span>
<a name="line-1927"></a><span class='hs-definition'>tcHsPartialSigType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig_ty</span>
<a name="line-1928"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HsWC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hswc_wcs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_wcs</span><span class='hs-layout'>,</span>         <span class='hs-varid'>hswc_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ib_ty</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sig_ty</span>
<a name="line-1929"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>HsIB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsib_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implicit_hs_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsib_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ib_ty</span>
<a name="line-1930"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>explicit_hs_tvs</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>hs_ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>hs_tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitLHsSigmaTy</span> <span class='hs-varid'>hs_ty</span>
<a name="line-1931"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varop'>$</span>
<a name="line-1932"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>implicit_tvs</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wcx</span><span class='hs-layout'>,</span> <span class='hs-varid'>explicit_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1933"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcWildCardBindersX</span> <span class='hs-varid'>newWildTyVar</span> <span class='hs-varid'>sig_wcs</span>        <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>wcs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1934"></a>               <span class='hs-varid'>tcImplicitTKBndrsX</span> <span class='hs-varid'>new_implicit_tv</span> <span class='hs-varid'>implicit_hs_tvs</span> <span class='hs-varop'>$</span>
<a name="line-1935"></a>               <span class='hs-varid'>tcExplicitTKBndrsX</span> <span class='hs-varid'>newSigTyVar</span> <span class='hs-varid'>explicit_hs_tvs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>explicit_tvs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1936"></a>               <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>   <span class='hs-comment'>-- Instantiate the type-class context; but if there</span>
<a name="line-1937"></a>                      <span class='hs-comment'>-- is an extra-constraints wildcard, just discard it here</span>
<a name="line-1938"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>wcx</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPartialContext</span> <span class='hs-varid'>hs_ctxt</span>
<a name="line-1939"></a>
<a name="line-1940"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>tau</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsOpenType</span> <span class='hs-varid'>hs_tau</span>
<a name="line-1941"></a>
<a name="line-1942"></a>                  <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bound_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionVarSets</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>allBoundVariables</span> <span class='hs-varid'>tau</span>
<a name="line-1943"></a>                                                 <span class='hs-layout'>,</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>explicit_tvs</span>
<a name="line-1944"></a>                                                 <span class='hs-layout'>,</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>wcs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-1945"></a>
<a name="line-1946"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-layout'>(</span><span class='hs-varid'>wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wcx</span><span class='hs-layout'>,</span> <span class='hs-varid'>explicit_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span>
<a name="line-1947"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>bound_tvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1948"></a>
<a name="line-1949"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>emitWildCardHoleConstraints</span> <span class='hs-varid'>wcs</span>
<a name="line-1950"></a>
<a name="line-1951"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>explicit_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTyCoVarKind</span> <span class='hs-varid'>explicit_tvs</span>
<a name="line-1952"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>all_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implicit_tvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>explicit_tvs</span>
<a name="line-1953"></a>                        <span class='hs-comment'>-- The implicit_tvs already have zonked kinds</span>
<a name="line-1954"></a>
<a name="line-1955"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>theta</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>theta</span>
<a name="line-1956"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>tau</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>tau</span>
<a name="line-1957"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSpecForAllTys</span> <span class='hs-varid'>all_tvs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkPhiTy</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span>
<a name="line-1958"></a>
<a name="line-1959"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcHsPartialSigType"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>all_tvs</span><span class='hs-layout'>)</span>
<a name="line-1960"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wcx</span><span class='hs-layout'>,</span> <span class='hs-varid'>all_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1961"></a>  <span class='hs-keyword'>where</span>
<a name="line-1962"></a>    <span class='hs-varid'>new_implicit_tv</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-1963"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSigTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span>
<a name="line-1964"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1965"></a>
<a name="line-1966"></a><a name="tcPartialContext"></a><span class='hs-definition'>tcPartialContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsContext</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span>
<a name="line-1967"></a><span class='hs-definition'>tcPartialContext</span> <span class='hs-varid'>hs_theta</span>
<a name="line-1968"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>hs_theta1</span><span class='hs-layout'>,</span> <span class='hs-varid'>hs_ctxt_last</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>snocView</span> <span class='hs-varid'>hs_theta</span>
<a name="line-1969"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWildCardTy</span> <span class='hs-varid'>wc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ignoreParens</span> <span class='hs-varid'>hs_ctxt_last</span>
<a name="line-1970"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcWildCardOcc</span> <span class='hs-varid'>wc</span> <span class='hs-varid'>constraintKind</span>
<a name="line-1971"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tcLHsPredType</span> <span class='hs-varid'>hs_theta1</span>
<a name="line-1972"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>wc_tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1973"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1974"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tcLHsPredType</span> <span class='hs-varid'>hs_theta</span>
<a name="line-1975"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1976"></a>
<a name="line-1977"></a><a name="tcHsPatSigType"></a><span class='hs-definition'>tcHsPatSigType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span>
<a name="line-1978"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigWcType</span> <span class='hs-conid'>GhcRn</span>          <span class='hs-comment'>-- The type signature</span>
<a name="line-1979"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- Wildcards</span>
<a name="line-1980"></a>                      <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- The new bit of type environment, binding</span>
<a name="line-1981"></a>                                              <span class='hs-comment'>-- the scoped type variables</span>
<a name="line-1982"></a>                      <span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>       <span class='hs-comment'>-- The type</span>
<a name="line-1983"></a><span class='hs-comment'>-- Used for type-checking type signatures in</span>
<a name="line-1984"></a><span class='hs-comment'>-- (a) patterns           e.g  f (x::Int) = e</span>
<a name="line-1985"></a><span class='hs-comment'>-- (b) RULE forall bndrs  e.g. forall (x::Int). f x = x</span>
<a name="line-1986"></a><span class='hs-comment'>--</span>
<a name="line-1987"></a><span class='hs-comment'>-- This may emit constraints</span>
<a name="line-1988"></a>
<a name="line-1989"></a><span class='hs-definition'>tcHsPatSigType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig_ty</span>
<a name="line-1990"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HsWC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hswc_wcs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_wcs</span><span class='hs-layout'>,</span>   <span class='hs-varid'>hswc_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ib_ty</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sig_ty</span>
<a name="line-1991"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>HsIB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsib_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_vars</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsib_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ib_ty</span>
<a name="line-1992"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varop'>$</span>
<a name="line-1993"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>implicit_tvs</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1994"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcWildCardBindersX</span> <span class='hs-varid'>newWildTyVar</span>    <span class='hs-varid'>sig_wcs</span>  <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>wcs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1995"></a>               <span class='hs-varid'>tcImplicitTKBndrsX</span> <span class='hs-varid'>new_implicit_tv</span> <span class='hs-varid'>sig_vars</span> <span class='hs-varop'>$</span>
<a name="line-1996"></a>               <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsOpenType</span> <span class='hs-varid'>hs_ty</span>
<a name="line-1997"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>allBoundVariables</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1998"></a>
<a name="line-1999"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>emitWildCardHoleConstraints</span> <span class='hs-varid'>wcs</span>
<a name="line-2000"></a>
<a name="line-2001"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>sig_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>sig_ty</span>
<a name="line-2002"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig_ty</span>
<a name="line-2003"></a>
<a name="line-2004"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>tv_pairs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>mk_tv_pair</span> <span class='hs-varid'>implicit_tvs</span>
<a name="line-2005"></a>
<a name="line-2006"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcHsPatSigType"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sig_vars</span><span class='hs-layout'>)</span>
<a name="line-2007"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv_pairs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2008"></a>  <span class='hs-keyword'>where</span>
<a name="line-2009"></a>    <span class='hs-varid'>new_implicit_tv</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-2010"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span>
<a name="line-2011"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2012"></a>       <span class='hs-comment'>-- "False" means that these tyvars aren't yet in scope</span>
<a name="line-2013"></a>    <span class='hs-varid'>new_tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-2014"></a>               <span class='hs-conid'>RuleSigCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newSkolemTyVar</span>
<a name="line-2015"></a>               <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newSigTyVar</span>
<a name="line-2016"></a>      <span class='hs-comment'>-- See Note [Pattern signature binders]</span>
<a name="line-2017"></a>      <span class='hs-comment'>-- See Note [Unifying SigTvs]</span>
<a name="line-2018"></a>
<a name="line-2019"></a>    <span class='hs-varid'>mk_tv_pair</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTyVarToTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-2020"></a>                       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2021"></a>         <span class='hs-comment'>-- The Name is one of sig_vars, the lexically scoped name</span>
<a name="line-2022"></a>         <span class='hs-comment'>-- But if it's a SigTyVar, it might have been unified</span>
<a name="line-2023"></a>         <span class='hs-comment'>-- with an existing in-scope skolem, so we must zonk</span>
<a name="line-2024"></a>         <span class='hs-comment'>-- here.  See Note [Pattern signature binders]</span>
<a name="line-2025"></a>
<a name="line-2026"></a><a name="tcPatSig"></a><span class='hs-definition'>tcPatSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>                    <span class='hs-comment'>-- True &lt;=&gt; pattern binding</span>
<a name="line-2027"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigWcType</span> <span class='hs-conid'>GhcRn</span>
<a name="line-2028"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpSigmaType</span>
<a name="line-2029"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span>            <span class='hs-comment'>-- The type to use for "inside" the signature</span>
<a name="line-2030"></a>                 <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span><span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- The new bit of type environment, binding</span>
<a name="line-2031"></a>                                    <span class='hs-comment'>-- the scoped type variables</span>
<a name="line-2032"></a>                 <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span><span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- The wildcards</span>
<a name="line-2033"></a>                 <span class='hs-conid'>HsWrapper</span><span class='hs-layout'>)</span>         <span class='hs-comment'>-- Coercion due to unification with actual ty</span>
<a name="line-2034"></a>                                    <span class='hs-comment'>-- Of shape:  res_ty ~ sig_ty</span>
<a name="line-2035"></a><span class='hs-definition'>tcPatSig</span> <span class='hs-varid'>in_pat_bind</span> <span class='hs-varid'>sig</span> <span class='hs-varid'>res_ty</span>
<a name="line-2036"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsPatSigType</span> <span class='hs-conid'>PatSigCtxt</span> <span class='hs-varid'>sig</span>
<a name="line-2037"></a>        <span class='hs-comment'>-- sig_tvs are the type variables free in 'sig',</span>
<a name="line-2038"></a>        <span class='hs-comment'>-- and not already in scope. These are the ones</span>
<a name="line-2039"></a>        <span class='hs-comment'>-- that should be brought into scope</span>
<a name="line-2040"></a>
<a name="line-2041"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>sig_tvs</span> <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-2042"></a>                <span class='hs-comment'>-- Just do the subsumption check and return</span>
<a name="line-2043"></a>                  <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addErrCtxtM</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_msg</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-2044"></a>                          <span class='hs-varid'>tcSubTypeET</span> <span class='hs-conid'>PatSigOrigin</span> <span class='hs-conid'>PatSigCtxt</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>sig_ty</span>
<a name="line-2045"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrap</span><span class='hs-layout'>)</span>
<a name="line-2046"></a>        <span class='hs-layout'>}</span> <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-2047"></a>                <span class='hs-comment'>-- Type signature binds at least one scoped type variable</span>
<a name="line-2048"></a>
<a name="line-2049"></a>                <span class='hs-comment'>-- A pattern binding cannot bind scoped type variables</span>
<a name="line-2050"></a>                <span class='hs-comment'>-- It is more convenient to make the test here</span>
<a name="line-2051"></a>                <span class='hs-comment'>-- than in the renamer</span>
<a name="line-2052"></a>        <span class='hs-layout'>{</span> <span class='hs-varid'>when</span> <span class='hs-varid'>in_pat_bind</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>patBindSigErr</span> <span class='hs-varid'>sig_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2053"></a>
<a name="line-2054"></a>                <span class='hs-comment'>-- Check that all newly-in-scope tyvars are in fact</span>
<a name="line-2055"></a>                <span class='hs-comment'>-- constrained by the pattern.  This catches tiresome</span>
<a name="line-2056"></a>                <span class='hs-comment'>-- cases like</span>
<a name="line-2057"></a>                <span class='hs-comment'>--      type T a = Int</span>
<a name="line-2058"></a>                <span class='hs-comment'>--      f :: Int -&gt; Int</span>
<a name="line-2059"></a>                <span class='hs-comment'>--      f (x :: T a) = ...</span>
<a name="line-2060"></a>                <span class='hs-comment'>-- Here 'a' doesn't get a binding.  Sigh</span>
<a name="line-2061"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bad_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sig_tvs</span>
<a name="line-2062"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>exactTyCoVarsOfType</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-2063"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>bad_tvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>badPatSigTvs</span> <span class='hs-varid'>sig_ty</span> <span class='hs-varid'>bad_tvs</span><span class='hs-layout'>)</span>
<a name="line-2064"></a>
<a name="line-2065"></a>        <span class='hs-comment'>-- Now do a subsumption check of the pattern signature against res_ty</span>
<a name="line-2066"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addErrCtxtM</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_msg</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-2067"></a>                  <span class='hs-varid'>tcSubTypeET</span> <span class='hs-conid'>PatSigOrigin</span> <span class='hs-conid'>PatSigCtxt</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>sig_ty</span>
<a name="line-2068"></a>
<a name="line-2069"></a>        <span class='hs-comment'>-- Phew!</span>
<a name="line-2070"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrap</span><span class='hs-layout'>)</span>
<a name="line-2071"></a>        <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-2072"></a>  <span class='hs-keyword'>where</span>
<a name="line-2073"></a>    <span class='hs-varid'>mk_msg</span> <span class='hs-varid'>sig_ty</span> <span class='hs-varid'>tidy_env</span>
<a name="line-2074"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>sig_ty</span>
<a name="line-2075"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readExpType</span> <span class='hs-varid'>res_ty</span>   <span class='hs-comment'>-- should be filled in by now</span>
<a name="line-2076"></a>            <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>res_ty</span>
<a name="line-2077"></a>            <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"When checking that the pattern signature:"</span><span class='hs-layout'>)</span>
<a name="line-2078"></a>                                  <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span>
<a name="line-2079"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"fits the type of its context:"</span><span class='hs-layout'>)</span>
<a name="line-2080"></a>                                          <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-2081"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2082"></a>
<a name="line-2083"></a><a name="patBindSigErr"></a><span class='hs-definition'>patBindSigErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span><span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2084"></a><span class='hs-definition'>patBindSigErr</span> <span class='hs-varid'>sig_tvs</span>
<a name="line-2085"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"You cannot bind scoped type variable"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>sig_tvs</span>
<a name="line-2086"></a>          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprQuotedList</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>sig_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2087"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"in a pattern binding signature"</span><span class='hs-layout'>)</span>
<a name="line-2088"></a>
<a name="line-2089"></a><span class='hs-comment'>{- Note [Pattern signature binders]
<a name="line-2090"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2091"></a>Consider
<a name="line-2092"></a>   data T = forall a. T a (a-&gt;Int)
<a name="line-2093"></a>   f (T x (f :: b-&gt;Int)) = blah
<a name="line-2094"></a>
<a name="line-2095"></a>Here
<a name="line-2096"></a> * The pattern (T p1 p2) creates a *skolem* type variable 'a_sk',
<a name="line-2097"></a>   It must be a skolem so that that it retains its identity, and
<a name="line-2098"></a>   TcErrors.getSkolemInfo can thereby find the binding site for the skolem.
<a name="line-2099"></a>
<a name="line-2100"></a> * The type signature pattern (f :: b-&gt;Int) makes a fresh meta-tyvar b_sig
<a name="line-2101"></a>   (a SigTv), and binds "b" :-&gt; b_sig in the envt
<a name="line-2102"></a>
<a name="line-2103"></a> * Then unification makes b_sig := a_sk
<a name="line-2104"></a>   That's why we must make b_sig a MetaTv (albeit a SigTv),
<a name="line-2105"></a>   not a SkolemTv, so that it can unify to a_sk.
<a name="line-2106"></a>
<a name="line-2107"></a> * Finally, in 'blah' we must have the envt "b" :-&gt; a_sk.  The pair
<a name="line-2108"></a>   ("b" :-&gt; a_sk) is returned by tcHsPatSigType, constructed by
<a name="line-2109"></a>   mk_tv_pair in that funcion.
<a name="line-2110"></a>
<a name="line-2111"></a>Another example (Trac #13881):
<a name="line-2112"></a>   fl :: forall (l :: [a]). Sing l -&gt; Sing l
<a name="line-2113"></a>   fl (SNil :: Sing (l :: [y])) = SNil
<a name="line-2114"></a>When we reach the pattern signature, 'l' is in scope from the
<a name="line-2115"></a>outer 'forall':
<a name="line-2116"></a>   "a" :-&gt; a_sk :: *
<a name="line-2117"></a>   "l" :-&gt; l_sk :: [a_sk]
<a name="line-2118"></a>We make up a fresh meta-SigTv, y_sig, for 'y', and kind-check
<a name="line-2119"></a>the pattern signature
<a name="line-2120"></a>   Sing (l :: [y])
<a name="line-2121"></a>That unifies y_sig := a_sk.  We return from tcHsPatSigType with
<a name="line-2122"></a>the pair ("y" :-&gt; a_sk).
<a name="line-2123"></a>
<a name="line-2124"></a>For RULE binders, though, things are a bit different (yuk).
<a name="line-2125"></a>  RULE "foo" forall (x::a) (y::[a]).  f x y = ...
<a name="line-2126"></a>Here this really is the binding site of the type variable so we'd like
<a name="line-2127"></a>to use a skolem, so that we get a complaint if we unify two of them
<a name="line-2128"></a>together.
<a name="line-2129"></a>
<a name="line-2130"></a>Note [Unifying SigTvs]
<a name="line-2131"></a>~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2132"></a>ALAS we have no decent way of avoiding two SigTvs getting unified.
<a name="line-2133"></a>Consider
<a name="line-2134"></a>  f (x::(a,b)) (y::c)) = [fst x, y]
<a name="line-2135"></a>Here we'd really like to complain that 'a' and 'c' are unified. But
<a name="line-2136"></a>for the reasons above we can't make a,b,c into skolems, so they
<a name="line-2137"></a>are just SigTvs that can unify.  And indeed, this would be ok,
<a name="line-2138"></a>  f x (y::c) = case x of
<a name="line-2139"></a>                 (x1 :: a1, True) -&gt; [x,y]
<a name="line-2140"></a>                 (x1 :: a2, False) -&gt; [x,y,y]
<a name="line-2141"></a>Here the type of x's first component is called 'a1' in one branch and
<a name="line-2142"></a>'a2' in the other.  We could try insisting on the same OccName, but
<a name="line-2143"></a>they definitely won't have the sane lexical Name.
<a name="line-2144"></a>
<a name="line-2145"></a>I think we could solve this by recording in a SigTv a list of all the
<a name="line-2146"></a>in-scope variables that it should not unify with, but it's fiddly.
<a name="line-2147"></a>
<a name="line-2148"></a>
<a name="line-2149"></a>************************************************************************
<a name="line-2150"></a>*                                                                      *
<a name="line-2151"></a>        Checking kinds
<a name="line-2152"></a>*                                                                      *
<a name="line-2153"></a>************************************************************************
<a name="line-2154"></a>
<a name="line-2155"></a>-}</span>
<a name="line-2156"></a>
<a name="line-2157"></a><a name="unifyKinds"></a><span class='hs-definition'>unifyKinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-2158"></a><span class='hs-definition'>unifyKinds</span> <span class='hs-varid'>rn_tys</span> <span class='hs-varid'>act_kinds</span>
<a name="line-2159"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-2160"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>check</span> <span class='hs-varid'>rn_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>act_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>rn_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>act_kind</span> <span class='hs-varid'>kind</span>
<a name="line-2161"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-varid'>check</span> <span class='hs-varid'>rn_tys</span> <span class='hs-varid'>act_kinds</span>
<a name="line-2162"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2163"></a>
<a name="line-2164"></a><span class='hs-comment'>{-
<a name="line-2165"></a>************************************************************************
<a name="line-2166"></a>*                                                                      *
<a name="line-2167"></a>        Sort checking kinds
<a name="line-2168"></a>*                                                                      *
<a name="line-2169"></a>************************************************************************
<a name="line-2170"></a>
<a name="line-2171"></a>tcLHsKindSig converts a user-written kind to an internal, sort-checked kind.
<a name="line-2172"></a>It does sort checking and desugaring at the same time, in one single pass.
<a name="line-2173"></a>-}</span>
<a name="line-2174"></a>
<a name="line-2175"></a><a name="tcLHsKindSig"></a><span class='hs-definition'>tcLHsKindSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsKind</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-2176"></a><span class='hs-definition'>tcLHsKindSig</span> <span class='hs-varid'>hs_kind</span>
<a name="line-2177"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_kind</span> <span class='hs-varid'>kindLevelMode</span> <span class='hs-varid'>hs_kind</span>
<a name="line-2178"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-2179"></a>         <span class='hs-comment'>-- This zonk is very important in the case of higher rank kinds</span>
<a name="line-2180"></a>         <span class='hs-comment'>-- E.g. Trac #13879    f :: forall (p :: forall z (y::z). &lt;blah&gt;).</span>
<a name="line-2181"></a>         <span class='hs-comment'>--                          &lt;more blah&gt;</span>
<a name="line-2182"></a>         <span class='hs-comment'>--      When instantiating p's kind at occurrences of p in &lt;more blah&gt;</span>
<a name="line-2183"></a>         <span class='hs-comment'>--      it's crucial that the kind we instantiate is fully zonked,</span>
<a name="line-2184"></a>         <span class='hs-comment'>--      else we may fail to substitute properly</span>
<a name="line-2185"></a>
<a name="line-2186"></a><a name="tc_lhs_kind"></a><span class='hs-definition'>tc_lhs_kind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsKind</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-2187"></a><span class='hs-definition'>tc_lhs_kind</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>k</span>
<a name="line-2188"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"In the kind"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-2189"></a>    <span class='hs-varid'>tc_lhs_type</span> <span class='hs-layout'>(</span><span class='hs-varid'>kindLevel</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varid'>k</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-2190"></a>
<a name="line-2191"></a><a name="promotionErr"></a><span class='hs-definition'>promotionErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PromotionErr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2192"></a><span class='hs-definition'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-varid'>err</span>
<a name="line-2193"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprPECategory</span> <span class='hs-varid'>err</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"cannot be used here"</span><span class='hs-layout'>)</span>
<a name="line-2194"></a>                   <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-varid'>reason</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2195"></a>  <span class='hs-keyword'>where</span>
<a name="line-2196"></a>    <span class='hs-varid'>reason</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>err</span> <span class='hs-keyword'>of</span>
<a name="line-2197"></a>               <span class='hs-conid'>FamDataConPE</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"it comes from a data family instance"</span>
<a name="line-2198"></a>               <span class='hs-conid'>NoDataKindsTC</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Perhaps you intended to use DataKinds"</span>
<a name="line-2199"></a>               <span class='hs-conid'>NoDataKindsDC</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Perhaps you intended to use DataKinds"</span>
<a name="line-2200"></a>               <span class='hs-conid'>NoTypeInTypeTC</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Perhaps you intended to use TypeInType"</span>
<a name="line-2201"></a>               <span class='hs-conid'>NoTypeInTypeDC</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Perhaps you intended to use TypeInType"</span>
<a name="line-2202"></a>               <span class='hs-conid'>PatSynPE</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Pattern synonyms cannot be promoted"</span>
<a name="line-2203"></a>               <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"it is defined and used in the same recursive group"</span>
<a name="line-2204"></a>
<a name="line-2205"></a><span class='hs-comment'>{-
<a name="line-2206"></a>************************************************************************
<a name="line-2207"></a>*                                                                      *
<a name="line-2208"></a>                Scoped type variables
<a name="line-2209"></a>*                                                                      *
<a name="line-2210"></a>************************************************************************
<a name="line-2211"></a>-}</span>
<a name="line-2212"></a>
<a name="line-2213"></a><a name="badPatSigTvs"></a><span class='hs-definition'>badPatSigTvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2214"></a><span class='hs-definition'>badPatSigTvs</span> <span class='hs-varid'>sig_ty</span> <span class='hs-varid'>bad_tvs</span>
<a name="line-2215"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>fsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"The type variable"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>bad_tvs</span><span class='hs-layout'>,</span>
<a name="line-2216"></a>                 <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprWithCommas</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bad_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-2217"></a>                 <span class='hs-varid'>text</span> <span class='hs-str'>"should be bound by the pattern signature"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-2218"></a>                 <span class='hs-varid'>text</span> <span class='hs-str'>"but are actually discarded by a type synonym"</span> <span class='hs-keyglyph'>]</span>
<a name="line-2219"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"To fix this, expand the type synonym"</span>
<a name="line-2220"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"[Note: I hope to lift this restriction in due course]"</span> <span class='hs-keyglyph'>]</span>
<a name="line-2221"></a>
<a name="line-2222"></a><span class='hs-comment'>{-
<a name="line-2223"></a>************************************************************************
<a name="line-2224"></a>*                                                                      *
<a name="line-2225"></a>          Error messages and such
<a name="line-2226"></a>*                                                                      *
<a name="line-2227"></a>************************************************************************
<a name="line-2228"></a>-}</span>
<a name="line-2229"></a>
<a name="line-2230"></a><a name="funAppCtxt"></a><span class='hs-comment'>-- | Make an appropriate message for an error in a function argument.</span>
<a name="line-2231"></a><span class='hs-comment'>-- Used for both expressions and types.</span>
<a name="line-2232"></a><span class='hs-definition'>funAppCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Outputable</span> <span class='hs-varid'>fun</span><span class='hs-layout'>,</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>fun</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>arg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2233"></a><span class='hs-definition'>funAppCtxt</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>arg_no</span>
<a name="line-2234"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"In the"</span><span class='hs-layout'>,</span> <span class='hs-varid'>speakNth</span> <span class='hs-varid'>arg_no</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"argument of"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-2235"></a>                    <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>", namely"</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2236"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2237"></a>
<a name="line-2238"></a><a name="reportFloatingKvs"></a><span class='hs-comment'>-- See Note [Free-floating kind vars]</span>
<a name="line-2239"></a><span class='hs-definition'>reportFloatingKvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>         <span class='hs-comment'>-- of the tycon</span>
<a name="line-2240"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyConFlavour</span> <span class='hs-comment'>-- What sort of TyCon it is</span>
<a name="line-2241"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- all tyvars, not necessarily zonked</span>
<a name="line-2242"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- floating tyvars</span>
<a name="line-2243"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2244"></a><span class='hs-definition'>reportFloatingKvs</span> <span class='hs-varid'>tycon_name</span> <span class='hs-varid'>flav</span> <span class='hs-varid'>all_tvs</span> <span class='hs-varid'>bad_tvs</span>
<a name="line-2245"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>bad_tvs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>  <span class='hs-comment'>-- don't bother zonking if there's no error</span>
<a name="line-2246"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>all_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcTyVarToTyVar</span> <span class='hs-varid'>all_tvs</span>
<a name="line-2247"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>bad_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcTyVarToTyVar</span> <span class='hs-varid'>bad_tvs</span>
<a name="line-2248"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_all_tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenTyCoVars</span> <span class='hs-varid'>emptyTidyEnv</span> <span class='hs-varid'>all_tvs</span>
<a name="line-2249"></a>             <span class='hs-varid'>tidy_bad_tvs</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyTyVarOcc</span> <span class='hs-varid'>tidy_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>bad_tvs</span>
<a name="line-2250"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>typeintype</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>TypeInType</span>
<a name="line-2251"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>report</span> <span class='hs-varid'>typeintype</span> <span class='hs-varid'>tidy_all_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>tidy_bad_tvs</span> <span class='hs-layout'>}</span>
<a name="line-2252"></a>  <span class='hs-keyword'>where</span>
<a name="line-2253"></a>    <span class='hs-varid'>report</span> <span class='hs-varid'>typeintype</span> <span class='hs-varid'>tidy_all_tvs</span> <span class='hs-varid'>tidy_bad_tv</span>
<a name="line-2254"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErr</span> <span class='hs-varop'>$</span>
<a name="line-2255"></a>        <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Kind variable"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tidy_bad_tv</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-2256"></a>               <span class='hs-varid'>text</span> <span class='hs-str'>"is implicitly bound in"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>flav</span>
<a name="line-2257"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tycon_name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-2258"></a>               <span class='hs-varid'>text</span> <span class='hs-str'>"but does not appear as the kind of any"</span>
<a name="line-2259"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"of its type variables. Perhaps you meant"</span>
<a name="line-2260"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"to bind it"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppWhen</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>typeintype</span><span class='hs-layout'>)</span>
<a name="line-2261"></a>                                            <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"(with TypeInType)"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-2262"></a>                                 <span class='hs-varid'>text</span> <span class='hs-str'>"explicitly somewhere?"</span>
<a name="line-2263"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>ppWhen</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>tidy_all_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-2264"></a>                 <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Type variables with inferred kinds:"</span><span class='hs-layout'>)</span>
<a name="line-2265"></a>                 <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_tv_bndrs</span> <span class='hs-varid'>tidy_all_tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-2266"></a>
<a name="line-2267"></a>    <span class='hs-varid'>ppr_tv_bndrs</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pp_tv</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-2268"></a>    <span class='hs-varid'>pp_tv</span> <span class='hs-varid'>tv</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre></body>
</html>
