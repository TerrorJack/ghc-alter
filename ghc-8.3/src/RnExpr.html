<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>rename/RnExpr.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
<a name="line-3"></a>
<a name="line-4"></a>\section[RnExpr]{Renaming of expressions}
<a name="line-5"></a>
<a name="line-6"></a>Basically dependency analysis.
<a name="line-7"></a>
<a name="line-8"></a>Handles @Match@, @GRHSs@, @HsExpr@, and @Qualifier@ datatypes.  In
<a name="line-9"></a>general, all of these functions return a renamed thing, and a set of
<a name="line-10"></a>free variables.
<a name="line-11"></a>-}</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-14"></a><span class='hs-comment'>{-# LANGUAGE ScopedTypeVariables #-}</span>
<a name="line-15"></a><span class='hs-comment'>{-# LANGUAGE MultiWayIf #-}</span>
<a name="line-16"></a><span class='hs-comment'>{-# LANGUAGE TypeFamilies #-}</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>RnExpr</span> <span class='hs-layout'>(</span>
<a name="line-19"></a>        <span class='hs-varid'>rnLExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnStmts</span>
<a name="line-20"></a>   <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnBinds</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>rnLocalBindsAndThen</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnLocalValBindsLHS</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnLocalValBindsRHS</span><span class='hs-layout'>,</span>
<a name="line-25"></a>                   <span class='hs-varid'>rnMatchGroup</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnGRHS</span><span class='hs-layout'>,</span> <span class='hs-varid'>makeMiniFixityEnv</span><span class='hs-layout'>)</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>           <span class='hs-layout'>(</span> <span class='hs-varid'>getModule</span> <span class='hs-layout'>)</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnEnv</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnFixity</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnUtils</span>          <span class='hs-layout'>(</span> <span class='hs-conid'>HsDocContext</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindLocalNamesFV</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkDupNames</span>
<a name="line-32"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>bindLocalNames</span>
<a name="line-33"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>mapMaybeFvRn</span><span class='hs-layout'>,</span> <span class='hs-varid'>mapFvRn</span>
<a name="line-34"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>warnUnusedLocalBinds</span> <span class='hs-layout'>)</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnUnbound</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>reportUnboundName</span> <span class='hs-layout'>)</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnSplice</span>         <span class='hs-layout'>(</span> <span class='hs-varid'>rnBracket</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnSpliceExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkThLocalName</span> <span class='hs-layout'>)</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnTypes</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnPat</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSet</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>removeDups</span> <span class='hs-layout'>)</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>nilDataConName</span> <span class='hs-layout'>)</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>LanguageExtensions</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>LangExt</span>
<a name="line-57"></a>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Ord</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span><span class='hs-varop'>.</span><span class='hs-conid'>NonEmpty</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>NE</span>
<a name="line-61"></a>
<a name="line-62"></a><span class='hs-comment'>{-
<a name="line-63"></a>************************************************************************
<a name="line-64"></a>*                                                                      *
<a name="line-65"></a>\subsubsection{Expressions}
<a name="line-66"></a>*                                                                      *
<a name="line-67"></a>************************************************************************
<a name="line-68"></a>-}</span>
<a name="line-69"></a>
<a name="line-70"></a><a name="rnExprs"></a><span class='hs-definition'>rnExprs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>GhcPs</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-71"></a><span class='hs-definition'>rnExprs</span> <span class='hs-varid'>ls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnExprs'</span> <span class='hs-varid'>ls</span> <span class='hs-varid'>emptyUniqSet</span>
<a name="line-72"></a> <span class='hs-keyword'>where</span>
<a name="line-73"></a>  <span class='hs-varid'>rnExprs'</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-74"></a>  <span class='hs-varid'>rnExprs'</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr</span><span class='hs-conop'>:</span><span class='hs-varid'>exprs</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span>
<a name="line-75"></a>   <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-76"></a>        <span class='hs-comment'>-- Now we do a "seq" on the free vars because typically it's small</span>
<a name="line-77"></a>        <span class='hs-comment'>-- or empty, especially in very long lists of constants</span>
<a name="line-78"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>  <span class='hs-varid'>acc'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvExpr</span>
<a name="line-79"></a>      <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExprs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>acc'</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>rnExprs'</span> <span class='hs-varid'>exprs</span> <span class='hs-varid'>acc'</span>
<a name="line-80"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-conop'>:</span><span class='hs-varid'>exprs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExprs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-81"></a>
<a name="line-82"></a><span class='hs-comment'>-- Variables. We look up the variable and return the resulting name.</span>
<a name="line-83"></a>
<a name="line-84"></a><a name="rnLExpr"></a><span class='hs-definition'>rnLExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>GhcPs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-85"></a><span class='hs-definition'>rnLExpr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapLocFstM</span> <span class='hs-varid'>rnExpr</span>
<a name="line-86"></a>
<a name="line-87"></a><a name="rnExpr"></a><span class='hs-definition'>rnExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcPs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-88"></a>
<a name="line-89"></a><a name="finishHsVar"></a><span class='hs-definition'>finishHsVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-90"></a><span class='hs-comment'>-- Separated from rnExpr because it's also used</span>
<a name="line-91"></a><span class='hs-comment'>-- when renaming infix expressions</span>
<a name="line-92"></a><span class='hs-definition'>finishHsVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-93"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>this_mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-94"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-95"></a>        <span class='hs-varid'>checkThLocalName</span> <span class='hs-varid'>name</span>
<a name="line-96"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>unitFV</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-97"></a>
<a name="line-98"></a><a name="rnUnboundVar"></a><span class='hs-definition'>rnUnboundVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-99"></a><span class='hs-definition'>rnUnboundVar</span> <span class='hs-varid'>v</span>
<a name="line-100"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isUnqual</span> <span class='hs-varid'>v</span>
<a name="line-101"></a>        <span class='hs-keyword'>then</span> <span class='hs-comment'>-- Treat this as a "hole"</span>
<a name="line-102"></a>             <span class='hs-comment'>-- Do not fail right now; instead, return HsUnboundVar</span>
<a name="line-103"></a>             <span class='hs-comment'>-- and let the type checker report the error</span>
<a name="line-104"></a>             <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rdrNameOcc</span> <span class='hs-varid'>v</span>
<a name="line-105"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>uv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>startsWithUnderscore</span> <span class='hs-varid'>occ</span>
<a name="line-106"></a>                        <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TrueExprHole</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>
<a name="line-107"></a>                        <span class='hs-keyword'>else</span> <span class='hs-conid'>OutOfScope</span> <span class='hs-varid'>occ</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getGlobalRdrEnv</span>
<a name="line-108"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnboundVar</span> <span class='hs-varid'>uv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-109"></a>
<a name="line-110"></a>        <span class='hs-keyword'>else</span> <span class='hs-comment'>-- Fail immediately (qualified name)</span>
<a name="line-111"></a>             <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reportUnboundName</span> <span class='hs-varid'>v</span>
<a name="line-112"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-113"></a>
<a name="line-114"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-115"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>opt_DuplicateRecordFields</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>DuplicateRecordFields</span>
<a name="line-116"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mb_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupOccRn_overloaded</span> <span class='hs-varid'>opt_DuplicateRecordFields</span> <span class='hs-varid'>v</span>
<a name="line-117"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_name</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-118"></a>           <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>rnUnboundVar</span> <span class='hs-varid'>v</span> <span class='hs-layout'>;</span>
<a name="line-119"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-120"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>name</span> <span class='hs-varop'>==</span> <span class='hs-varid'>nilDataConName</span> <span class='hs-comment'>-- Treat [] as an ExplicitList, so that</span>
<a name="line-121"></a>                                       <span class='hs-comment'>-- OverloadedLists works correctly</span>
<a name="line-122"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitList</span> <span class='hs-varid'>placeHolderType</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-123"></a>
<a name="line-124"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-125"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>finishHsVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-126"></a>            <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>s</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-127"></a>              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-conid'>HsRecFld</span> <span class='hs-layout'>(</span><span class='hs-varid'>ambiguousFieldOcc</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldOcc</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-128"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>unitFV</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-129"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>fs</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-130"></a>              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-conid'>HsRecFld</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ambiguous</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-conid'>PlaceHolder</span><span class='hs-layout'>)</span>
<a name="line-131"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>mkFVs</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span>
<a name="line-132"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"runExpr/HsVar"</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-133"></a>
<a name="line-134"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIPVar</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-135"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIPVar</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-136"></a>
<a name="line-137"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLabel</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-138"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rebindable_on</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>RebindableSyntax</span>
<a name="line-139"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>rebindable_on</span>
<a name="line-140"></a>         <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fromLabel</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupOccRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarUnqual</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"fromLabel"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-141"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLabel</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>fromLabel</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>unitFV</span> <span class='hs-varid'>fromLabel</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-142"></a>         <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLabel</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-143"></a>
<a name="line-144"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLit</span> <span class='hs-varid'>lit</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsString</span> <span class='hs-varid'>src</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-145"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>opt_OverloadedStrings</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>OverloadedStrings</span>
<a name="line-146"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>opt_OverloadedStrings</span> <span class='hs-keyword'>then</span>
<a name="line-147"></a>            <span class='hs-varid'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLit</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsIsString</span> <span class='hs-varid'>src</span> <span class='hs-varid'>s</span> <span class='hs-varid'>placeHolderType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-148"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-149"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>rnLit</span> <span class='hs-varid'>lit</span>
<a name="line-150"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLit</span> <span class='hs-layout'>(</span><span class='hs-varid'>convertLit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-151"></a>
<a name="line-152"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>
<a name="line-153"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rnLit</span> <span class='hs-varid'>lit</span>
<a name="line-154"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLit</span> <span class='hs-layout'>(</span><span class='hs-varid'>convertLit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-155"></a>
<a name="line-156"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>
<a name="line-157"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>lit'</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_neg</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnOverLit</span> <span class='hs-varid'>lit</span> <span class='hs-comment'>-- See Note [Negative zero]</span>
<a name="line-158"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_neg</span> <span class='hs-keyword'>of</span>
<a name="line-159"></a>              <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLit</span> <span class='hs-varid'>lit'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>
<a name="line-160"></a>              <span class='hs-conid'>Just</span> <span class='hs-varid'>neg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-conid'>HsApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-varid'>neg</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLit</span> <span class='hs-varid'>lit'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-161"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-162"></a>
<a name="line-163"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsApp</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-164"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvFun</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>fun</span>
<a name="line-165"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvArg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>arg</span>
<a name="line-166"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsApp</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvFun</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvArg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-167"></a>
<a name="line-168"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsAppType</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-169"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvFun</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>fun</span>
<a name="line-170"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvArg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnHsWcType</span> <span class='hs-conid'>HsTypeCtx</span> <span class='hs-varid'>arg</span>
<a name="line-171"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsAppType</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvFun</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvArg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-172"></a>
<a name="line-173"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>op</span>  <span class='hs-keyword'>_</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span>
<a name="line-174"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>e1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_e1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>e1</span>
<a name="line-175"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>e2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_e2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>e2</span>
<a name="line-176"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_op</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>op</span>
<a name="line-177"></a>
<a name="line-178"></a>        <span class='hs-comment'>-- Deal with fixity</span>
<a name="line-179"></a>        <span class='hs-comment'>-- When renaming code synthesised from "deriving" declarations</span>
<a name="line-180"></a>        <span class='hs-comment'>-- we used to avoid fixity stuff, but we can't easily tell any</span>
<a name="line-181"></a>        <span class='hs-comment'>-- more, so I've removed the test.  Adding HsPars in TcGenDeriv</span>
<a name="line-182"></a>        <span class='hs-comment'>-- should prevent bad things happening.</span>
<a name="line-183"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>fixity</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>op'</span> <span class='hs-keyword'>of</span>
<a name="line-184"></a>              <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookupFixityRn</span> <span class='hs-varid'>n</span>
<a name="line-185"></a>              <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecFld</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookupFieldFixityRn</span> <span class='hs-varid'>f</span>
<a name="line-186"></a>              <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fixity</span> <span class='hs-conid'>NoSourceText</span> <span class='hs-varid'>minPrecedence</span> <span class='hs-conid'>InfixL</span><span class='hs-layout'>)</span>
<a name="line-187"></a>                   <span class='hs-comment'>-- c.f. lookupFixity for unbound</span>
<a name="line-188"></a>
<a name="line-189"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>final_e</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkOpAppRn</span> <span class='hs-varid'>e1'</span> <span class='hs-varid'>op'</span> <span class='hs-varid'>fixity</span> <span class='hs-varid'>e2'</span>
<a name="line-190"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>final_e</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_e1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fv_op</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fv_e2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-191"></a>
<a name="line-192"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>NegApp</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-193"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>e'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_e</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>e</span>
<a name="line-194"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>neg_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_neg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupSyntaxName</span> <span class='hs-varid'>negateName</span>
<a name="line-195"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>final_e</span>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkNegAppRn</span> <span class='hs-varid'>e'</span> <span class='hs-varid'>neg_name</span>
<a name="line-196"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>final_e</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_e</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fv_neg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-197"></a>
<a name="line-198"></a><span class='hs-comment'>------------------------------------------</span>
<a name="line-199"></a><span class='hs-comment'>-- Template Haskell extensions</span>
<a name="line-200"></a><span class='hs-comment'>-- Don't ifdef-GHCI them because we want to fail gracefully</span>
<a name="line-201"></a><span class='hs-comment'>-- (not with an rnExpr crash) in a stage-1 compiler.</span>
<a name="line-202"></a><span class='hs-definition'>rnExpr</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsBracket</span> <span class='hs-varid'>br_body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnBracket</span> <span class='hs-varid'>e</span> <span class='hs-varid'>br_body</span>
<a name="line-203"></a>
<a name="line-204"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceE</span> <span class='hs-varid'>splice</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnSpliceExpr</span> <span class='hs-varid'>splice</span>
<a name="line-205"></a>
<a name="line-206"></a><span class='hs-comment'>---------------------------------------------</span>
<a name="line-207"></a><span class='hs-comment'>--      Sections</span>
<a name="line-208"></a><span class='hs-comment'>-- See Note [Parsing sections] in Parser.y</span>
<a name="line-209"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>section</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SectionL</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-210"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>section'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnSection</span> <span class='hs-varid'>section</span>
<a name="line-211"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>section'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-212"></a>
<a name="line-213"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>section</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SectionR</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-214"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>section'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnSection</span> <span class='hs-varid'>section</span>
<a name="line-215"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>section'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-216"></a>
<a name="line-217"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-218"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>e'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>e</span>
<a name="line-219"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-varid'>e'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_e</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-220"></a>
<a name="line-221"></a><span class='hs-definition'>rnExpr</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SectionL</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-222"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>sectionErr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span> <span class='hs-varid'>rnSection</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>}</span>
<a name="line-223"></a><span class='hs-definition'>rnExpr</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SectionR</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-224"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>sectionErr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span> <span class='hs-varid'>rnSection</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>}</span>
<a name="line-225"></a>
<a name="line-226"></a><span class='hs-comment'>---------------------------------------------</span>
<a name="line-227"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCoreAnn</span> <span class='hs-varid'>src</span> <span class='hs-varid'>ann</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-228"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-229"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCoreAnn</span> <span class='hs-varid'>src</span> <span class='hs-varid'>ann</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_expr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-230"></a>
<a name="line-231"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSCC</span> <span class='hs-varid'>src</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-232"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-233"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSCC</span> <span class='hs-varid'>src</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_expr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-234"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTickPragma</span> <span class='hs-varid'>src</span> <span class='hs-varid'>info</span> <span class='hs-varid'>srcInfo</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-235"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-236"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTickPragma</span> <span class='hs-varid'>src</span> <span class='hs-varid'>info</span> <span class='hs-varid'>srcInfo</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_expr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-237"></a>
<a name="line-238"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLam</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-239"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>matches'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvMatch</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnMatchGroup</span> <span class='hs-conid'>LambdaExpr</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>matches</span>
<a name="line-240"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLam</span> <span class='hs-varid'>matches'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvMatch</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-241"></a>
<a name="line-242"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLamCase</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-243"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>matches'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_ms</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnMatchGroup</span> <span class='hs-conid'>CaseAlt</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>matches</span>
<a name="line-244"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLamCase</span> <span class='hs-varid'>matches'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_ms</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-245"></a>
<a name="line-246"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCase</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-247"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>e_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-248"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>ms_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnMatchGroup</span> <span class='hs-conid'>CaseAlt</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>matches</span>
<a name="line-249"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCase</span> <span class='hs-varid'>new_expr</span> <span class='hs-varid'>new_matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>e_fvs</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>ms_fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-250"></a>
<a name="line-251"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-252"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLocalBindsAndThen</span> <span class='hs-varid'>binds</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>binds'</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-253"></a>      <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-254"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-255"></a>
<a name="line-256"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDo</span> <span class='hs-varid'>do_or_lc</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-257"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-258"></a>           <span class='hs-varid'>rnStmtsWithPostProcessing</span> <span class='hs-varid'>do_or_lc</span> <span class='hs-varid'>rnLExpr</span>
<a name="line-259"></a>             <span class='hs-varid'>postProcessStmtsForApplicativeDo</span> <span class='hs-varid'>stmts</span>
<a name="line-260"></a>             <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>()</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-261"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-conid'>HsDo</span> <span class='hs-varid'>do_or_lc</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>stmts'</span><span class='hs-layout'>)</span> <span class='hs-varid'>placeHolderType</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-262"></a>
<a name="line-263"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitList</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>  <span class='hs-varid'>exps</span><span class='hs-layout'>)</span>
<a name="line-264"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>opt_OverloadedLists</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>OverloadedLists</span>
<a name="line-265"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>exps'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnExprs</span> <span class='hs-varid'>exps</span>
<a name="line-266"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>opt_OverloadedLists</span>
<a name="line-267"></a>           <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-268"></a>            <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>from_list_n_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupSyntaxName</span> <span class='hs-varid'>fromListNName</span>
<a name="line-269"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitList</span> <span class='hs-varid'>placeHolderType</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>from_list_n_name</span><span class='hs-layout'>)</span> <span class='hs-varid'>exps'</span>
<a name="line-270"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-271"></a>           <span class='hs-keyword'>else</span>
<a name="line-272"></a>            <span class='hs-varid'>return</span>  <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitList</span> <span class='hs-varid'>placeHolderType</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>exps'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-273"></a>
<a name="line-274"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitPArr</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>exps</span><span class='hs-layout'>)</span>
<a name="line-275"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>exps'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnExprs</span> <span class='hs-varid'>exps</span>
<a name="line-276"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span>  <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitPArr</span> <span class='hs-varid'>placeHolderType</span> <span class='hs-varid'>exps'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-277"></a>
<a name="line-278"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitTuple</span> <span class='hs-varid'>tup_args</span> <span class='hs-varid'>boxity</span><span class='hs-layout'>)</span>
<a name="line-279"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkTupleSection</span> <span class='hs-varid'>tup_args</span>
<a name="line-280"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTupSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>tup_args</span><span class='hs-layout'>)</span>
<a name="line-281"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tup_args'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-varid'>rnTupArg</span> <span class='hs-varid'>tup_args</span>
<a name="line-282"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitTuple</span> <span class='hs-varid'>tup_args'</span> <span class='hs-varid'>boxity</span><span class='hs-layout'>,</span> <span class='hs-varid'>plusFVs</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-283"></a>  <span class='hs-keyword'>where</span>
<a name="line-284"></a>    <span class='hs-varid'>rnTupArg</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>Present</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>e'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>e</span>
<a name="line-285"></a>                                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>Present</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-286"></a>    <span class='hs-varid'>rnTupArg</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>Missing</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>Missing</span> <span class='hs-varid'>placeHolderType</span><span class='hs-layout'>)</span>
<a name="line-287"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-288"></a>
<a name="line-289"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitSum</span> <span class='hs-varid'>alt</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>expr</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-290"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-291"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitSum</span> <span class='hs-varid'>alt</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>expr'</span> <span class='hs-conid'>PlaceHolder</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-292"></a>
<a name="line-293"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecordCon</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rcon_con_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con_id</span>
<a name="line-294"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>rcon_flds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rec_binds</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsRecFields</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rec_dotdot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dd</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-295"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>con_lname</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>con_name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupLocatedOccRn</span> <span class='hs-varid'>con_id</span>
<a name="line-296"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>flds</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnHsRecFields</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecFieldCon</span> <span class='hs-varid'>con_name</span><span class='hs-layout'>)</span> <span class='hs-varid'>mk_hs_var</span> <span class='hs-varid'>rec_binds</span>
<a name="line-297"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>flds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-varid'>rn_field</span> <span class='hs-varid'>flds</span>
<a name="line-298"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rec_binds'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsRecFields</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rec_flds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rec_dotdot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dd</span> <span class='hs-layout'>}</span>
<a name="line-299"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecordCon</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rcon_con_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con_lname</span><span class='hs-layout'>,</span> <span class='hs-varid'>rcon_flds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rec_binds'</span>
<a name="line-300"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>rcon_con_expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noPostTcExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>rcon_con_like</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PlaceHolder</span> <span class='hs-layout'>}</span>
<a name="line-301"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>plusFVs</span> <span class='hs-varid'>fvss</span> <span class='hs-varop'>`addOneFV`</span> <span class='hs-varid'>con_name</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-302"></a>  <span class='hs-keyword'>where</span>
<a name="line-303"></a>    <span class='hs-varid'>mk_hs_var</span> <span class='hs-varid'>l</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-304"></a>    <span class='hs-varid'>rn_field</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>fld</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsRecFieldArg</span> <span class='hs-varid'>fld</span><span class='hs-layout'>)</span>
<a name="line-305"></a>                            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-varid'>fld</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsRecFieldArg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-306"></a>
<a name="line-307"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecordUpd</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rupd_expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>rupd_flds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rbinds</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-308"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-309"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>rbinds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvRbinds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnHsRecUpdFields</span> <span class='hs-varid'>rbinds</span>
<a name="line-310"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecordUpd</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rupd_expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rupd_flds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rbinds'</span>
<a name="line-311"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>rupd_cons</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PlaceHolder</span><span class='hs-layout'>,</span> <span class='hs-varid'>rupd_in_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PlaceHolder</span>
<a name="line-312"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>rupd_out_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PlaceHolder</span><span class='hs-layout'>,</span> <span class='hs-varid'>rupd_wrap</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PlaceHolder</span> <span class='hs-layout'>}</span>
<a name="line-313"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvRbinds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-314"></a>
<a name="line-315"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExprWithTySig</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>pty</span><span class='hs-layout'>)</span>
<a name="line-316"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>pty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvTy</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnHsSigWcType</span> <span class='hs-conid'>ExprWithTySigCtx</span> <span class='hs-varid'>pty</span>
<a name="line-317"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindSigTyVarsFV</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsWcScopedTvs</span> <span class='hs-varid'>pty'</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-318"></a>                             <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-319"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExprWithTySig</span> <span class='hs-varid'>expr'</span> <span class='hs-varid'>pty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvTy</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-320"></a>
<a name="line-321"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIf</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>p</span> <span class='hs-varid'>b1</span> <span class='hs-varid'>b2</span><span class='hs-layout'>)</span>
<a name="line-322"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>p'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvP</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>p</span>
<a name="line-323"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>b1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvB1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>b1</span>
<a name="line-324"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>b2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvB2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>b2</span>
<a name="line-325"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>mb_ite</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvITE</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupIfThenElse</span>
<a name="line-326"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIf</span> <span class='hs-varid'>mb_ite</span> <span class='hs-varid'>p'</span> <span class='hs-varid'>b1'</span> <span class='hs-varid'>b2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>plusFVs</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>fvITE</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvP</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvB1</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvB2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-327"></a>
<a name="line-328"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsMultiIf</span> <span class='hs-sel'>_ty</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-329"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>alts'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapFvRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnGRHS</span> <span class='hs-conid'>IfAlt</span> <span class='hs-varid'>rnLExpr</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span>
<a name="line-330"></a>       <span class='hs-comment'>-- ; return (HsMultiIf ty alts', fvs) }</span>
<a name="line-331"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsMultiIf</span> <span class='hs-varid'>placeHolderType</span> <span class='hs-varid'>alts'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-332"></a>
<a name="line-333"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeq</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span>
<a name="line-334"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>opt_OverloadedLists</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>OverloadedLists</span>
<a name="line-335"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_seq</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnArithSeq</span> <span class='hs-varid'>seq</span>
<a name="line-336"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>opt_OverloadedLists</span>
<a name="line-337"></a>           <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-338"></a>            <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>from_list_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupSyntaxName</span> <span class='hs-varid'>fromListName</span>
<a name="line-339"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeq</span> <span class='hs-varid'>noPostTcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>from_list_name</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_seq</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-340"></a>           <span class='hs-keyword'>else</span>
<a name="line-341"></a>            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeq</span> <span class='hs-varid'>noPostTcExpr</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>new_seq</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-342"></a>
<a name="line-343"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PArrSeq</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span>
<a name="line-344"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_seq</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnArithSeq</span> <span class='hs-varid'>seq</span>
<a name="line-345"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PArrSeq</span> <span class='hs-varid'>noPostTcExpr</span> <span class='hs-varid'>new_seq</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-346"></a>
<a name="line-347"></a><span class='hs-comment'>{-
<a name="line-348"></a>These three are pattern syntax appearing in expressions.
<a name="line-349"></a>Since all the symbols are reservedops we can simply reject them.
<a name="line-350"></a>We return a (bogus) EWildPat in each case.
<a name="line-351"></a>-}</span>
<a name="line-352"></a>
<a name="line-353"></a><span class='hs-definition'>rnExpr</span> <span class='hs-conid'>EWildPat</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsHoleExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- "_" is just a hole</span>
<a name="line-354"></a><span class='hs-definition'>rnExpr</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EAsPat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-355"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>opt_TypeApplications</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>TypeApplications</span>
<a name="line-356"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>opt_TypeApplications</span>
<a name="line-357"></a>                    <span class='hs-keyglyph'>=</span> <span class='hs-str'>"Type application syntax requires a space before '@'"</span>
<a name="line-358"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-359"></a>                    <span class='hs-keyglyph'>=</span> <span class='hs-str'>"Did you mean to enable TypeApplications?"</span>
<a name="line-360"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>patSynErr</span> <span class='hs-varid'>e</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-361"></a>       <span class='hs-layout'>}</span>
<a name="line-362"></a><span class='hs-definition'>rnExpr</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EViewPat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>patSynErr</span> <span class='hs-varid'>e</span> <span class='hs-varid'>empty</span>
<a name="line-363"></a><span class='hs-definition'>rnExpr</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ELazyPat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>patSynErr</span> <span class='hs-varid'>e</span> <span class='hs-varid'>empty</span>
<a name="line-364"></a>
<a name="line-365"></a><span class='hs-comment'>{-
<a name="line-366"></a>************************************************************************
<a name="line-367"></a>*                                                                      *
<a name="line-368"></a>        Static values
<a name="line-369"></a>*                                                                      *
<a name="line-370"></a>************************************************************************
<a name="line-371"></a>
<a name="line-372"></a>For the static form we check that the free variables are all top-level
<a name="line-373"></a>value bindings. This is done by checking that the name is external or
<a name="line-374"></a>wired-in. See the Notes about the NameSorts in Name.hs.
<a name="line-375"></a>-}</span>
<a name="line-376"></a>
<a name="line-377"></a><span class='hs-definition'>rnExpr</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsStatic</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-378"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-379"></a>    <span class='hs-varid'>stage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getStage</span>
<a name="line-380"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>stage</span> <span class='hs-keyword'>of</span>
<a name="line-381"></a>      <span class='hs-conid'>Splice</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>addErr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span>
<a name="line-382"></a>             <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"static forms cannot be used in splices:"</span>
<a name="line-383"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>e</span>
<a name="line-384"></a>             <span class='hs-keyglyph'>]</span>
<a name="line-385"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-386"></a>    <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-387"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>fvExpr'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>fvExpr</span>
<a name="line-388"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsStatic</span> <span class='hs-varid'>fvExpr'</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr</span><span class='hs-layout'>)</span>
<a name="line-389"></a>
<a name="line-390"></a><span class='hs-comment'>{-
<a name="line-391"></a>************************************************************************
<a name="line-392"></a>*                                                                      *
<a name="line-393"></a>        Arrow notation
<a name="line-394"></a>*                                                                      *
<a name="line-395"></a>************************************************************************
<a name="line-396"></a>-}</span>
<a name="line-397"></a>
<a name="line-398"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsProc</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-399"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newArrowScope</span> <span class='hs-varop'>$</span>
<a name="line-400"></a>    <span class='hs-varid'>rnPat</span> <span class='hs-conid'>ProcExpr</span> <span class='hs-varid'>pat</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>pat'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-401"></a>      <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>body'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvBody</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnCmdTop</span> <span class='hs-varid'>body</span>
<a name="line-402"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsProc</span> <span class='hs-varid'>pat'</span> <span class='hs-varid'>body'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvBody</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-403"></a>
<a name="line-404"></a><span class='hs-comment'>-- Ideally, these would be done in parsing, but to keep parsing simple, we do it here.</span>
<a name="line-405"></a><span class='hs-definition'>rnExpr</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsArrApp</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arrowFail</span> <span class='hs-varid'>e</span>
<a name="line-406"></a><span class='hs-definition'>rnExpr</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsArrForm</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arrowFail</span> <span class='hs-varid'>e</span>
<a name="line-407"></a>
<a name="line-408"></a><span class='hs-definition'>rnExpr</span> <span class='hs-varid'>other</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rnExpr: unexpected expression"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span>
<a name="line-409"></a>        <span class='hs-comment'>-- HsWrap</span>
<a name="line-410"></a>
<a name="line-411"></a><a name="hsHoleExpr"></a><span class='hs-definition'>hsHoleExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-varid'>id</span>
<a name="line-412"></a><span class='hs-definition'>hsHoleExpr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsUnboundVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>TrueExprHole</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOcc</span> <span class='hs-str'>"_"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-413"></a>
<a name="line-414"></a><a name="arrowFail"></a><span class='hs-definition'>arrowFail</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcPs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-415"></a><span class='hs-definition'>arrowFail</span> <span class='hs-varid'>e</span>
<a name="line-416"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Arrow command found where an expression was expected:"</span>
<a name="line-417"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-418"></a>         <span class='hs-comment'>-- Return a place-holder hole, so that we can carry on</span>
<a name="line-419"></a>         <span class='hs-comment'>-- to report other errors</span>
<a name="line-420"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsHoleExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-421"></a>
<a name="line-422"></a><a name="rnSection"></a><span class='hs-comment'>----------------------</span>
<a name="line-423"></a><span class='hs-comment'>-- See Note [Parsing sections] in Parser.y</span>
<a name="line-424"></a><span class='hs-definition'>rnSection</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcPs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-425"></a><span class='hs-definition'>rnSection</span> <span class='hs-varid'>section</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SectionR</span> <span class='hs-varid'>op</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-426"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_op</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>op</span>
<a name="line-427"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-428"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkSectionPrec</span> <span class='hs-conid'>InfixR</span> <span class='hs-varid'>section</span> <span class='hs-varid'>op'</span> <span class='hs-varid'>expr'</span>
<a name="line-429"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SectionR</span> <span class='hs-varid'>op'</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_op</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs_expr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-430"></a>
<a name="line-431"></a><span class='hs-definition'>rnSection</span> <span class='hs-varid'>section</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SectionL</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-432"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-433"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_op</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>op</span>
<a name="line-434"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkSectionPrec</span> <span class='hs-conid'>InfixL</span> <span class='hs-varid'>section</span> <span class='hs-varid'>op'</span> <span class='hs-varid'>expr'</span>
<a name="line-435"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SectionL</span> <span class='hs-varid'>expr'</span> <span class='hs-varid'>op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_op</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs_expr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-436"></a>
<a name="line-437"></a><span class='hs-definition'>rnSection</span> <span class='hs-varid'>other</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rnSection"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span>
<a name="line-438"></a>
<a name="line-439"></a><span class='hs-comment'>{-
<a name="line-440"></a>************************************************************************
<a name="line-441"></a>*                                                                      *
<a name="line-442"></a>        Arrow commands
<a name="line-443"></a>*                                                                      *
<a name="line-444"></a>************************************************************************
<a name="line-445"></a>-}</span>
<a name="line-446"></a>
<a name="line-447"></a><a name="rnCmdArgs"></a><span class='hs-definition'>rnCmdArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsCmdTop</span> <span class='hs-conid'>GhcPs</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsCmdTop</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-448"></a><span class='hs-definition'>rnCmdArgs</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-449"></a><span class='hs-definition'>rnCmdArgs</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-450"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvArg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnCmdTop</span> <span class='hs-varid'>arg</span>
<a name="line-451"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>args'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvArgs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnCmdArgs</span> <span class='hs-varid'>args</span>
<a name="line-452"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg'</span><span class='hs-conop'>:</span><span class='hs-varid'>args'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvArg</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvArgs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-453"></a>
<a name="line-454"></a><a name="rnCmdTop"></a><span class='hs-definition'>rnCmdTop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsCmdTop</span> <span class='hs-conid'>GhcPs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsCmdTop</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-455"></a><span class='hs-definition'>rnCmdTop</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapLocFstM</span> <span class='hs-varid'>rnCmdTop'</span>
<a name="line-456"></a> <span class='hs-keyword'>where</span>
<a name="line-457"></a>  <span class='hs-varid'>rnCmdTop'</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdTop</span> <span class='hs-varid'>cmd</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-458"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmd'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvCmd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLCmd</span> <span class='hs-varid'>cmd</span>
<a name="line-459"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>cmd_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arrAName</span><span class='hs-layout'>,</span> <span class='hs-varid'>composeAName</span><span class='hs-layout'>,</span> <span class='hs-varid'>firstAName</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span>
<a name="line-460"></a>                          <span class='hs-varid'>nameSetElemsStable</span> <span class='hs-layout'>(</span><span class='hs-varid'>methodNamesCmd</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>cmd'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-461"></a>        <span class='hs-comment'>-- Generate the rebindable syntax for the monad</span>
<a name="line-462"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmd_names'</span><span class='hs-layout'>,</span> <span class='hs-varid'>cmd_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupSyntaxNames</span> <span class='hs-varid'>cmd_names</span>
<a name="line-463"></a>
<a name="line-464"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdTop</span> <span class='hs-varid'>cmd'</span> <span class='hs-varid'>placeHolderType</span> <span class='hs-varid'>placeHolderType</span>
<a name="line-465"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>cmd_names</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>cmd_names'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-466"></a>                  <span class='hs-varid'>fvCmd</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>cmd_fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-467"></a>
<a name="line-468"></a><a name="rnLCmd"></a><span class='hs-definition'>rnLCmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsCmd</span> <span class='hs-conid'>GhcPs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsCmd</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-469"></a><span class='hs-definition'>rnLCmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapLocFstM</span> <span class='hs-varid'>rnCmd</span>
<a name="line-470"></a>
<a name="line-471"></a><a name="rnCmd"></a><span class='hs-definition'>rnCmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsCmd</span> <span class='hs-conid'>GhcPs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmd</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-472"></a>
<a name="line-473"></a><span class='hs-definition'>rnCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrApp</span> <span class='hs-varid'>arrow</span> <span class='hs-varid'>arg</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ho</span> <span class='hs-varid'>rtl</span><span class='hs-layout'>)</span>
<a name="line-474"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>arrow'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvArrow</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>select_arrow_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>arrow</span><span class='hs-layout'>)</span>
<a name="line-475"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvArg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>arg</span>
<a name="line-476"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrApp</span> <span class='hs-varid'>arrow'</span> <span class='hs-varid'>arg'</span> <span class='hs-varid'>placeHolderType</span> <span class='hs-varid'>ho</span> <span class='hs-varid'>rtl</span><span class='hs-layout'>,</span>
<a name="line-477"></a>                 <span class='hs-varid'>fvArrow</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvArg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-478"></a>  <span class='hs-keyword'>where</span>
<a name="line-479"></a>    <span class='hs-varid'>select_arrow_scope</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ho</span> <span class='hs-keyword'>of</span>
<a name="line-480"></a>        <span class='hs-conid'>HsHigherOrderApp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tc</span>
<a name="line-481"></a>        <span class='hs-conid'>HsFirstOrderApp</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>escapeArrowScope</span> <span class='hs-varid'>tc</span>
<a name="line-482"></a>        <span class='hs-comment'>-- See Note [Escaping the arrow scope] in TcRnTypes</span>
<a name="line-483"></a>        <span class='hs-comment'>-- Before renaming 'arrow', use the environment of the enclosing</span>
<a name="line-484"></a>        <span class='hs-comment'>-- proc for the (-&lt;) case.</span>
<a name="line-485"></a>        <span class='hs-comment'>-- Local bindings, inside the enclosing proc, are not in scope</span>
<a name="line-486"></a>        <span class='hs-comment'>-- inside 'arrow'.  In the higher-order case (-&lt;&lt;), they are.</span>
<a name="line-487"></a>
<a name="line-488"></a><span class='hs-comment'>-- infix form</span>
<a name="line-489"></a><span class='hs-definition'>rnCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrForm</span> <span class='hs-varid'>op</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg1</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-490"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>op'</span><span class='hs-layout'>,</span><span class='hs-varid'>fv_op</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>escapeArrowScope</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-491"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>op_name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>op'</span>
<a name="line-492"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg1'</span><span class='hs-layout'>,</span><span class='hs-varid'>fv_arg1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnCmdTop</span> <span class='hs-varid'>arg1</span>
<a name="line-493"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg2'</span><span class='hs-layout'>,</span><span class='hs-varid'>fv_arg2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnCmdTop</span> <span class='hs-varid'>arg2</span>
<a name="line-494"></a>        <span class='hs-comment'>-- Deal with fixity</span>
<a name="line-495"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>fixity</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupFixityRn</span> <span class='hs-varid'>op_name</span>
<a name="line-496"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>final_e</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkOpFormRn</span> <span class='hs-varid'>arg1'</span> <span class='hs-varid'>op'</span> <span class='hs-varid'>fixity</span> <span class='hs-varid'>arg2'</span>
<a name="line-497"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>final_e</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_arg1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fv_op</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fv_arg2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-498"></a>
<a name="line-499"></a><span class='hs-definition'>rnCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrForm</span> <span class='hs-varid'>op</span> <span class='hs-varid'>f</span> <span class='hs-varid'>fixity</span> <span class='hs-varid'>cmds</span><span class='hs-layout'>)</span>
<a name="line-500"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>op'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvOp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>escapeArrowScope</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-501"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmds'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvCmds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnCmdArgs</span> <span class='hs-varid'>cmds</span>
<a name="line-502"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrForm</span> <span class='hs-varid'>op'</span> <span class='hs-varid'>f</span> <span class='hs-varid'>fixity</span> <span class='hs-varid'>cmds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvOp</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvCmds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-503"></a>
<a name="line-504"></a><span class='hs-definition'>rnCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdApp</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-505"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvFun</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLCmd</span>  <span class='hs-varid'>fun</span>
<a name="line-506"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvArg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>arg</span>
<a name="line-507"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdApp</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvFun</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvArg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-508"></a>
<a name="line-509"></a><span class='hs-definition'>rnCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdLam</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-510"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>matches'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvMatch</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnMatchGroup</span> <span class='hs-conid'>LambdaExpr</span> <span class='hs-varid'>rnLCmd</span> <span class='hs-varid'>matches</span>
<a name="line-511"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdLam</span> <span class='hs-varid'>matches'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvMatch</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-512"></a>
<a name="line-513"></a><span class='hs-definition'>rnCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdPar</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-514"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>e'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLCmd</span> <span class='hs-varid'>e</span>
<a name="line-515"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdPar</span> <span class='hs-varid'>e'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_e</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-516"></a>
<a name="line-517"></a><span class='hs-definition'>rnCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdCase</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-518"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>e_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-519"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>ms_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnMatchGroup</span> <span class='hs-conid'>CaseAlt</span> <span class='hs-varid'>rnLCmd</span> <span class='hs-varid'>matches</span>
<a name="line-520"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdCase</span> <span class='hs-varid'>new_expr</span> <span class='hs-varid'>new_matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>e_fvs</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>ms_fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-521"></a>
<a name="line-522"></a><span class='hs-definition'>rnCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdIf</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>p</span> <span class='hs-varid'>b1</span> <span class='hs-varid'>b2</span><span class='hs-layout'>)</span>
<a name="line-523"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>p'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvP</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>p</span>
<a name="line-524"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>b1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvB1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLCmd</span> <span class='hs-varid'>b1</span>
<a name="line-525"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>b2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvB2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLCmd</span> <span class='hs-varid'>b2</span>
<a name="line-526"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>mb_ite</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvITE</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupIfThenElse</span>
<a name="line-527"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdIf</span> <span class='hs-varid'>mb_ite</span> <span class='hs-varid'>p'</span> <span class='hs-varid'>b1'</span> <span class='hs-varid'>b2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>plusFVs</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>fvITE</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvP</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvB1</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvB2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-528"></a>
<a name="line-529"></a><span class='hs-definition'>rnCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-varid'>cmd</span><span class='hs-layout'>)</span>
<a name="line-530"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLocalBindsAndThen</span> <span class='hs-varid'>binds</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>binds'</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-531"></a>      <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmd'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLCmd</span> <span class='hs-varid'>cmd</span>
<a name="line-532"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span> <span class='hs-varid'>cmd'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-533"></a>
<a name="line-534"></a><span class='hs-definition'>rnCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdDo</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-535"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-536"></a>            <span class='hs-varid'>rnStmts</span> <span class='hs-conid'>ArrowExpr</span> <span class='hs-varid'>rnLCmd</span> <span class='hs-varid'>stmts</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>()</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-537"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-conid'>HsCmdDo</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>stmts'</span><span class='hs-layout'>)</span> <span class='hs-varid'>placeHolderType</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-538"></a>
<a name="line-539"></a><span class='hs-definition'>rnCmd</span> <span class='hs-varid'>cmd</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsCmdWrap</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rnCmd"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cmd</span><span class='hs-layout'>)</span>
<a name="line-540"></a>
<a name="line-541"></a><a name="CmdNeeds"></a><span class='hs-comment'>---------------------------------------------------</span>
<a name="line-542"></a><a name="CmdNeeds"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CmdNeeds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FreeVars</span>        <span class='hs-comment'>-- Only inhabitants are</span>
<a name="line-543"></a>                                <span class='hs-comment'>--      appAName, choiceAName, loopAName</span>
<a name="line-544"></a>
<a name="line-545"></a><a name="methodNamesLCmd"></a><span class='hs-comment'>-- find what methods the Cmd needs (loop, choice, apply)</span>
<a name="line-546"></a><span class='hs-definition'>methodNamesLCmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsCmd</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmdNeeds</span>
<a name="line-547"></a><span class='hs-definition'>methodNamesLCmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesCmd</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span>
<a name="line-548"></a>
<a name="line-549"></a><a name="methodNamesCmd"></a><span class='hs-definition'>methodNamesCmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsCmd</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmdNeeds</span>
<a name="line-550"></a>
<a name="line-551"></a><span class='hs-definition'>methodNamesCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrApp</span> <span class='hs-sel'>_arrow</span> <span class='hs-sel'>_arg</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>HsFirstOrderApp</span> <span class='hs-sel'>_rtl</span><span class='hs-layout'>)</span>
<a name="line-552"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFVs</span>
<a name="line-553"></a><span class='hs-definition'>methodNamesCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrApp</span> <span class='hs-sel'>_arrow</span> <span class='hs-sel'>_arg</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>HsHigherOrderApp</span> <span class='hs-sel'>_rtl</span><span class='hs-layout'>)</span>
<a name="line-554"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitFV</span> <span class='hs-varid'>appAName</span>
<a name="line-555"></a><span class='hs-definition'>methodNamesCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrForm</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFVs</span>
<a name="line-556"></a><span class='hs-definition'>methodNamesCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdWrap</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cmd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesCmd</span> <span class='hs-varid'>cmd</span>
<a name="line-557"></a>
<a name="line-558"></a><span class='hs-definition'>methodNamesCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdPar</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesLCmd</span> <span class='hs-varid'>c</span>
<a name="line-559"></a>
<a name="line-560"></a><span class='hs-definition'>methodNamesCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdIf</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span>
<a name="line-561"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesLCmd</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>methodNamesLCmd</span> <span class='hs-varid'>c2</span> <span class='hs-varop'>`addOneFV`</span> <span class='hs-varid'>choiceAName</span>
<a name="line-562"></a>
<a name="line-563"></a><span class='hs-definition'>methodNamesCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdLet</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesLCmd</span> <span class='hs-varid'>c</span>
<a name="line-564"></a><span class='hs-definition'>methodNamesCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdDo</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesStmts</span> <span class='hs-varid'>stmts</span>
<a name="line-565"></a><span class='hs-definition'>methodNamesCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdApp</span> <span class='hs-varid'>c</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesLCmd</span> <span class='hs-varid'>c</span>
<a name="line-566"></a><span class='hs-definition'>methodNamesCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdLam</span> <span class='hs-varid'>match</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesMatch</span> <span class='hs-varid'>match</span>
<a name="line-567"></a>
<a name="line-568"></a><span class='hs-definition'>methodNamesCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdCase</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-569"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesMatch</span> <span class='hs-varid'>matches</span> <span class='hs-varop'>`addOneFV`</span> <span class='hs-varid'>choiceAName</span>
<a name="line-570"></a>
<a name="line-571"></a><span class='hs-comment'>--methodNamesCmd _ = emptyFVs</span>
<a name="line-572"></a>   <span class='hs-comment'>-- Other forms can't occur in commands, but it's not convenient</span>
<a name="line-573"></a>   <span class='hs-comment'>-- to error here so we just do what's convenient.</span>
<a name="line-574"></a>   <span class='hs-comment'>-- The type checker will complain later</span>
<a name="line-575"></a>
<a name="line-576"></a><a name="methodNamesMatch"></a><span class='hs-comment'>---------------------------------------------------</span>
<a name="line-577"></a><span class='hs-definition'>methodNamesMatch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MatchGroup</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsCmd</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVars</span>
<a name="line-578"></a><span class='hs-definition'>methodNamesMatch</span> <span class='hs-layout'>(</span><span class='hs-conid'>MG</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_alts</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ms</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-579"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusFVs</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>do_one</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span>
<a name="line-580"></a> <span class='hs-keyword'>where</span>
<a name="line-581"></a>    <span class='hs-varid'>do_one</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Match</span> <span class='hs-layout'>{</span> <span class='hs-varid'>m_grhss</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>grhss</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesGRHSs</span> <span class='hs-varid'>grhss</span>
<a name="line-582"></a>
<a name="line-583"></a><a name="methodNamesGRHSs"></a><span class='hs-comment'>-------------------------------------------------</span>
<a name="line-584"></a><span class='hs-comment'>-- gaw 2004</span>
<a name="line-585"></a><span class='hs-definition'>methodNamesGRHSs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GRHSs</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsCmd</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVars</span>
<a name="line-586"></a><span class='hs-definition'>methodNamesGRHSs</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHSs</span> <span class='hs-varid'>grhss</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusFVs</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>methodNamesGRHS</span> <span class='hs-varid'>grhss</span><span class='hs-layout'>)</span>
<a name="line-587"></a>
<a name="line-588"></a><span class='hs-comment'>-------------------------------------------------</span>
<a name="line-589"></a>
<a name="line-590"></a><a name="methodNamesGRHS"></a><span class='hs-definition'>methodNamesGRHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHS</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsCmd</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmdNeeds</span>
<a name="line-591"></a><span class='hs-definition'>methodNamesGRHS</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHS</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesLCmd</span> <span class='hs-varid'>rhs</span>
<a name="line-592"></a>
<a name="line-593"></a><a name="methodNamesStmts"></a><span class='hs-comment'>---------------------------------------------------</span>
<a name="line-594"></a><span class='hs-definition'>methodNamesStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtLR</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsCmd</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVars</span>
<a name="line-595"></a><span class='hs-definition'>methodNamesStmts</span> <span class='hs-varid'>stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusFVs</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>methodNamesLStmt</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span>
<a name="line-596"></a>
<a name="line-597"></a><a name="methodNamesLStmt"></a><span class='hs-comment'>---------------------------------------------------</span>
<a name="line-598"></a><span class='hs-definition'>methodNamesLStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtLR</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsCmd</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVars</span>
<a name="line-599"></a><span class='hs-definition'>methodNamesLStmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesStmt</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span>
<a name="line-600"></a>
<a name="line-601"></a><a name="methodNamesStmt"></a><span class='hs-definition'>methodNamesStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StmtLR</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsCmd</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVars</span>
<a name="line-602"></a><span class='hs-definition'>methodNamesStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>cmd</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesLCmd</span> <span class='hs-varid'>cmd</span>
<a name="line-603"></a><span class='hs-definition'>methodNamesStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>cmd</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesLCmd</span> <span class='hs-varid'>cmd</span>
<a name="line-604"></a><span class='hs-definition'>methodNamesStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cmd</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesLCmd</span> <span class='hs-varid'>cmd</span>
<a name="line-605"></a><span class='hs-definition'>methodNamesStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecStmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>recS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-606"></a>  <span class='hs-varid'>methodNamesStmts</span> <span class='hs-varid'>stmts</span> <span class='hs-varop'>`addOneFV`</span> <span class='hs-varid'>loopAName</span>
<a name="line-607"></a><span class='hs-definition'>methodNamesStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFVs</span>
<a name="line-608"></a><span class='hs-definition'>methodNamesStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFVs</span>
<a name="line-609"></a><span class='hs-definition'>methodNamesStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFVs</span>
<a name="line-610"></a><span class='hs-definition'>methodNamesStmt</span> <span class='hs-conid'>ApplicativeStmt</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFVs</span>
<a name="line-611"></a>   <span class='hs-comment'>-- ParStmt and TransStmt can't occur in commands, but it's not</span>
<a name="line-612"></a>   <span class='hs-comment'>-- convenient to error here so we just do what's convenient</span>
<a name="line-613"></a>
<a name="line-614"></a><span class='hs-comment'>{-
<a name="line-615"></a>************************************************************************
<a name="line-616"></a>*                                                                      *
<a name="line-617"></a>        Arithmetic sequences
<a name="line-618"></a>*                                                                      *
<a name="line-619"></a>************************************************************************
<a name="line-620"></a>-}</span>
<a name="line-621"></a>
<a name="line-622"></a><a name="rnArithSeq"></a><span class='hs-definition'>rnArithSeq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ArithSeqInfo</span> <span class='hs-conid'>GhcPs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeqInfo</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-623"></a><span class='hs-definition'>rnArithSeq</span> <span class='hs-layout'>(</span><span class='hs-conid'>From</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-624"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-625"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>From</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-626"></a>
<a name="line-627"></a><span class='hs-definition'>rnArithSeq</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromThen</span> <span class='hs-varid'>expr1</span> <span class='hs-varid'>expr2</span><span class='hs-layout'>)</span>
<a name="line-628"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr1</span>
<a name="line-629"></a>      <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr2</span>
<a name="line-630"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromThen</span> <span class='hs-varid'>expr1'</span> <span class='hs-varid'>expr2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvExpr2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-631"></a>
<a name="line-632"></a><span class='hs-definition'>rnArithSeq</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromTo</span> <span class='hs-varid'>expr1</span> <span class='hs-varid'>expr2</span><span class='hs-layout'>)</span>
<a name="line-633"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr1</span>
<a name="line-634"></a>      <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr2</span>
<a name="line-635"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromTo</span> <span class='hs-varid'>expr1'</span> <span class='hs-varid'>expr2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvExpr2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-636"></a>
<a name="line-637"></a><span class='hs-definition'>rnArithSeq</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromThenTo</span> <span class='hs-varid'>expr1</span> <span class='hs-varid'>expr2</span> <span class='hs-varid'>expr3</span><span class='hs-layout'>)</span>
<a name="line-638"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr1</span>
<a name="line-639"></a>      <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr2</span>
<a name="line-640"></a>      <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr3'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr3</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr3</span>
<a name="line-641"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromThenTo</span> <span class='hs-varid'>expr1'</span> <span class='hs-varid'>expr2'</span> <span class='hs-varid'>expr3'</span><span class='hs-layout'>,</span>
<a name="line-642"></a>                <span class='hs-varid'>plusFVs</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>fvExpr1</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr2</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr3</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-643"></a>
<a name="line-644"></a><span class='hs-comment'>{-
<a name="line-645"></a>************************************************************************
<a name="line-646"></a>*                                                                      *
<a name="line-647"></a>\subsubsection{@Stmt@s: in @do@ expressions}
<a name="line-648"></a>*                                                                      *
<a name="line-649"></a>************************************************************************
<a name="line-650"></a>-}</span>
<a name="line-651"></a>
<a name="line-652"></a><span class='hs-comment'>{-
<a name="line-653"></a>Note [Deterministic ApplicativeDo and RecursiveDo desugaring]
<a name="line-654"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-655"></a>Both ApplicativeDo and RecursiveDo need to create tuples not
<a name="line-656"></a>present in the source text.
<a name="line-657"></a>
<a name="line-658"></a>For ApplicativeDo we create:
<a name="line-659"></a>
<a name="line-660"></a>  (a,b,c) &lt;- (\c b a -&gt; (a,b,c)) &lt;$&gt;
<a name="line-661"></a>
<a name="line-662"></a>For RecursiveDo we create:
<a name="line-663"></a>
<a name="line-664"></a>  mfix (\ ~(a,b,c) -&gt; do ...; return (a',b',c'))
<a name="line-665"></a>
<a name="line-666"></a>The order of the components in those tuples needs to be stable
<a name="line-667"></a>across recompilations, otherwise they can get optimized differently
<a name="line-668"></a>and we end up with incompatible binaries.
<a name="line-669"></a>To get a stable order we use nameSetElemsStable.
<a name="line-670"></a>See Note [Deterministic UniqFM] to learn more about nondeterminism.
<a name="line-671"></a>-}</span>
<a name="line-672"></a>
<a name="line-673"></a><a name="rnStmts"></a><span class='hs-comment'>-- | Rename some Stmts</span>
<a name="line-674"></a><span class='hs-definition'>rnStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-675"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-676"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-677"></a>           <span class='hs-comment'>-- ^ How to rename the body of each statement (e.g. rnLExpr)</span>
<a name="line-678"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-679"></a>           <span class='hs-comment'>-- ^ Statements</span>
<a name="line-680"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-681"></a>           <span class='hs-comment'>-- ^ if these statements scope over something, this renames it</span>
<a name="line-682"></a>           <span class='hs-comment'>-- and returns the result.</span>
<a name="line-683"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-684"></a><span class='hs-definition'>rnStmts</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnStmtsWithPostProcessing</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>noPostProcessStmts</span>
<a name="line-685"></a>
<a name="line-686"></a><a name="rnStmtsWithPostProcessing"></a><span class='hs-comment'>-- | like 'rnStmts' but applies a post-processing step to the renamed Stmts</span>
<a name="line-687"></a><span class='hs-definition'>rnStmtsWithPostProcessing</span>
<a name="line-688"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-689"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-690"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-691"></a>           <span class='hs-comment'>-- ^ How to rename the body of each statement (e.g. rnLExpr)</span>
<a name="line-692"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-693"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-694"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-695"></a>           <span class='hs-comment'>-- ^ postprocess the statements</span>
<a name="line-696"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-697"></a>           <span class='hs-comment'>-- ^ Statements</span>
<a name="line-698"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-699"></a>           <span class='hs-comment'>-- ^ if these statements scope over something, this renames it</span>
<a name="line-700"></a>           <span class='hs-comment'>-- and returns the result.</span>
<a name="line-701"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-702"></a><span class='hs-definition'>rnStmtsWithPostProcessing</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>ppStmts</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>thing_inside</span>
<a name="line-703"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-704"></a>          <span class='hs-varid'>rnStmtsWithFreeVars</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>thing_inside</span>
<a name="line-705"></a>      <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pp_stmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ppStmts</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmts'</span>
<a name="line-706"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>pp_stmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs'</span><span class='hs-layout'>)</span>
<a name="line-707"></a>      <span class='hs-layout'>}</span>
<a name="line-708"></a>
<a name="line-709"></a><a name="postProcessStmtsForApplicativeDo"></a><span class='hs-comment'>-- | maybe rearrange statements according to the ApplicativeDo transformation</span>
<a name="line-710"></a><span class='hs-definition'>postProcessStmtsForApplicativeDo</span>
<a name="line-711"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-712"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>ExprLStmt</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-713"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>ExprLStmt</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-714"></a><span class='hs-definition'>postProcessStmtsForApplicativeDo</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmts</span>
<a name="line-715"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-716"></a>       <span class='hs-comment'>-- rearrange the statements using ApplicativeStmt if</span>
<a name="line-717"></a>       <span class='hs-comment'>-- -XApplicativeDo is on.  Also strip out the FreeVars attached</span>
<a name="line-718"></a>       <span class='hs-comment'>-- to each Stmt body.</span>
<a name="line-719"></a>         <span class='hs-varid'>ado_is_on</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>ApplicativeDo</span>
<a name="line-720"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>is_do_expr</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DoExpr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-721"></a>                        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-722"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>ado_is_on</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>is_do_expr</span>
<a name="line-723"></a>            <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceRn</span> <span class='hs-str'>"ppsfa"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span>
<a name="line-724"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>rearrangeForApplicativeDo</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmts</span> <span class='hs-layout'>}</span>
<a name="line-725"></a>            <span class='hs-keyword'>else</span> <span class='hs-varid'>noPostProcessStmts</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmts</span> <span class='hs-layout'>}</span>
<a name="line-726"></a>
<a name="line-727"></a><a name="noPostProcessStmts"></a><span class='hs-comment'>-- | strip the FreeVars annotations from statements</span>
<a name="line-728"></a><span class='hs-definition'>noPostProcessStmts</span>
<a name="line-729"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-730"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-731"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-732"></a><span class='hs-definition'>noPostProcessStmts</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyNameSet</span><span class='hs-layout'>)</span>
<a name="line-733"></a>
<a name="line-734"></a>
<a name="line-735"></a><a name="rnStmtsWithFreeVars"></a><span class='hs-definition'>rnStmtsWithFreeVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-736"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-737"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-738"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-739"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-740"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-741"></a>               <span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-742"></a><span class='hs-comment'>-- Each Stmt body is annotated with its FreeVars, so that</span>
<a name="line-743"></a><span class='hs-comment'>-- we can rearrange statements for ApplicativeDo.</span>
<a name="line-744"></a><span class='hs-comment'>--</span>
<a name="line-745"></a><span class='hs-comment'>-- Variables bound by the Stmts, and mentioned in thing_inside,</span>
<a name="line-746"></a><span class='hs-comment'>-- do not appear in the result FreeVars</span>
<a name="line-747"></a>
<a name="line-748"></a><span class='hs-definition'>rnStmtsWithFreeVars</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>thing_inside</span>
<a name="line-749"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkEmptyStmts</span> <span class='hs-varid'>ctxt</span>
<a name="line-750"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-conid'>[]</span>
<a name="line-751"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-752"></a>
<a name="line-753"></a><span class='hs-definition'>rnStmtsWithFreeVars</span> <span class='hs-conid'>MDoExpr</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>thing_inside</span>    <span class='hs-comment'>-- Deal with mdo</span>
<a name="line-754"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- Behave like do { rec { ...all but last... }; last }</span>
<a name="line-755"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>stmts1</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmts2</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>
<a name="line-756"></a>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnStmt</span> <span class='hs-conid'>MDoExpr</span> <span class='hs-varid'>rnBody</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkRecStmt</span> <span class='hs-varid'>all_but_last</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-757"></a>              <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>last_stmt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkLastStmt</span> <span class='hs-conid'>MDoExpr</span> <span class='hs-varid'>last_stmt</span>
<a name="line-758"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>rnStmt</span> <span class='hs-conid'>MDoExpr</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>last_stmt'</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>}</span>
<a name="line-759"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>stmts1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>stmts2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-760"></a>  <span class='hs-keyword'>where</span>
<a name="line-761"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>all_but_last</span><span class='hs-layout'>,</span> <span class='hs-varid'>last_stmt</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snocView</span> <span class='hs-varid'>stmts</span>
<a name="line-762"></a>
<a name="line-763"></a><span class='hs-definition'>rnStmtsWithFreeVars</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-layout'>(</span><span class='hs-varid'>lstmt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>lstmts</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-764"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>lstmts</span>
<a name="line-765"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-766"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lstmt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkLastStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>lstmt</span>
<a name="line-767"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rnStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>lstmt'</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>}</span>
<a name="line-768"></a>
<a name="line-769"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-770"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>stmts1</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmts2</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>
<a name="line-771"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span>                         <span class='hs-varop'>$</span>
<a name="line-772"></a>               <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>lstmt</span>
<a name="line-773"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>rnStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>lstmt</span>    <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>bndrs1</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-774"></a>                    <span class='hs-varid'>rnStmtsWithFreeVars</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>lstmts</span>  <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>bndrs2</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-775"></a>                    <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>bndrs2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-776"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>stmts1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>stmts2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-777"></a>
<a name="line-778"></a><span class='hs-comment'>----------------------</span>
<a name="line-779"></a>
<a name="line-780"></a><span class='hs-comment'>{-
<a name="line-781"></a>Note [Failing pattern matches in Stmts]
<a name="line-782"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-783"></a>
<a name="line-784"></a>Many things desugar to HsStmts including monadic things like `do` and `mdo`
<a name="line-785"></a>statements, pattern guards, and list comprehensions (see 'HsStmtContext' for an
<a name="line-786"></a>exhaustive list). How we deal with pattern match failure is context-dependent.
<a name="line-787"></a>
<a name="line-788"></a> * In the case of list comprehensions and pattern guards we don't need any 'fail'
<a name="line-789"></a>   function; the desugarer ignores the fail function field of 'BindStmt' entirely.
<a name="line-790"></a> * In the case of monadic contexts (e.g. monad comprehensions, do, and mdo
<a name="line-791"></a>   expressions) we want pattern match failure to be desugared to the appropriate
<a name="line-792"></a>   'fail' function (either that of Monad or MonadFail, depending on whether
<a name="line-793"></a>   -XMonadFailDesugaring is enabled.)
<a name="line-794"></a>
<a name="line-795"></a>At one point we failed to make this distinction, leading to #11216.
<a name="line-796"></a>-}</span>
<a name="line-797"></a>
<a name="line-798"></a><a name="rnStmt"></a><span class='hs-definition'>rnStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-799"></a>       <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-800"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-801"></a>          <span class='hs-comment'>-- ^ How to rename the body of the statement</span>
<a name="line-802"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-803"></a>          <span class='hs-comment'>-- ^ The statement</span>
<a name="line-804"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-805"></a>          <span class='hs-comment'>-- ^ Rename the stuff that this statement scopes over</span>
<a name="line-806"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-807"></a>              <span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-808"></a><span class='hs-comment'>-- Variables bound by the Stmt, and mentioned in thing_inside,</span>
<a name="line-809"></a><span class='hs-comment'>-- do not appear in the result FreeVars</span>
<a name="line-810"></a>
<a name="line-811"></a><span class='hs-definition'>rnStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>body</span> <span class='hs-varid'>noret</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-812"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>body'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>body</span>
<a name="line-813"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ret_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>returnMName</span>
<a name="line-814"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span>  <span class='hs-varid'>fvs3</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-conid'>[]</span>
<a name="line-815"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>body'</span> <span class='hs-varid'>noret</span> <span class='hs-varid'>ret_op</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_expr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-816"></a>                  <span class='hs-varid'>fv_expr</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs3</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-817"></a>
<a name="line-818"></a><span class='hs-definition'>rnStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>body</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-819"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>body'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>body</span>
<a name="line-820"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>then_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>thenMName</span>
<a name="line-821"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>guard_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isListCompExpr</span> <span class='hs-varid'>ctxt</span>
<a name="line-822"></a>                              <span class='hs-keyword'>then</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>guardMName</span>
<a name="line-823"></a>                              <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>noSyntaxExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-824"></a>                              <span class='hs-comment'>-- Only list/parr/monad comprehensions use 'guard'</span>
<a name="line-825"></a>                              <span class='hs-comment'>-- Also for sub-stmts of same eg [ e | x&lt;-xs, gd | blah ]</span>
<a name="line-826"></a>                              <span class='hs-comment'>-- Here "gd" is a guard</span>
<a name="line-827"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs3</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-conid'>[]</span>
<a name="line-828"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>body'</span>
<a name="line-829"></a>                     <span class='hs-varid'>then_op</span> <span class='hs-varid'>guard_op</span> <span class='hs-varid'>placeHolderType</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_expr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-830"></a>                  <span class='hs-varid'>fv_expr</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs3</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-831"></a>
<a name="line-832"></a><span class='hs-definition'>rnStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>body</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-833"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>body'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>body</span>
<a name="line-834"></a>                <span class='hs-comment'>-- The binders do not scope over the expression</span>
<a name="line-835"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>bindMName</span>
<a name="line-836"></a>
<a name="line-837"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>xMonadFailEnabled</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>xopt</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>MonadFailDesugaring</span><span class='hs-layout'>)</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-838"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>getFailFunction</span>
<a name="line-839"></a>                <span class='hs-comment'>-- If the pattern is irrefutable (e.g.: wildcard, tuple,</span>
<a name="line-840"></a>                <span class='hs-comment'>-- ~pat, etc.) we should not need to fail.</span>
<a name="line-841"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isIrrefutableHsPat</span> <span class='hs-varid'>pat</span>
<a name="line-842"></a>                                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>noSyntaxExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-843"></a>                <span class='hs-comment'>-- For non-monadic contexts (e.g. guard patterns, list</span>
<a name="line-844"></a>                <span class='hs-comment'>-- comprehensions, etc.) we should not need to fail.</span>
<a name="line-845"></a>                <span class='hs-comment'>-- See Note [Failing pattern matches in Stmts]</span>
<a name="line-846"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isMonadFailStmtContext</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-847"></a>                                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>noSyntaxExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-848"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>xMonadFailEnabled</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupSyntaxName</span> <span class='hs-varid'>failMName</span>
<a name="line-849"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupSyntaxName</span> <span class='hs-varid'>failMName_preMFP</span>
<a name="line-850"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>fail_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getFailFunction</span>
<a name="line-851"></a>
<a name="line-852"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>rnPat</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtCtxt</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>pat'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-853"></a>        <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs3</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectPatBinders</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>)</span>
<a name="line-854"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat'</span> <span class='hs-varid'>body'</span> <span class='hs-varid'>bind_op</span> <span class='hs-varid'>fail_op</span> <span class='hs-conid'>PlaceHolder</span><span class='hs-layout'>)</span>
<a name="line-855"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>fv_expr</span> <span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-856"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-857"></a>                  <span class='hs-varid'>fv_expr</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs3</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-858"></a>       <span class='hs-comment'>-- fv_expr shouldn't really be filtered by the rnPatsAndThen</span>
<a name="line-859"></a>        <span class='hs-comment'>-- but it does not matter because the names are unique</span>
<a name="line-860"></a>
<a name="line-861"></a><span class='hs-definition'>rnStmt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-862"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>rnLocalBindsAndThen</span> <span class='hs-varid'>binds</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>binds'</span> <span class='hs-varid'>bind_fvs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-863"></a>        <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectLocalBinders</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span>
<a name="line-864"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_fvs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>  <span class='hs-layout'>}</span>
<a name="line-865"></a>
<a name="line-866"></a><span class='hs-definition'>rnStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecStmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>recS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rec_stmts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-867"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>return_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>returnMName</span>
<a name="line-868"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>mfix_op</span><span class='hs-layout'>,</span>   <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>mfixName</span>
<a name="line-869"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind_op</span><span class='hs-layout'>,</span>   <span class='hs-varid'>fvs3</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>bindMName</span>
<a name="line-870"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>empty_rec_stmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyRecStmtName</span> <span class='hs-layout'>{</span> <span class='hs-varid'>recS_ret_fn</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return_op</span>
<a name="line-871"></a>                                                <span class='hs-layout'>,</span> <span class='hs-varid'>recS_mfix_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mfix_op</span>
<a name="line-872"></a>                                                <span class='hs-layout'>,</span> <span class='hs-varid'>recS_bind_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bind_op</span> <span class='hs-layout'>}</span>
<a name="line-873"></a>
<a name="line-874"></a>        <span class='hs-comment'>-- Step1: Bring all the binders of the mdo into scope</span>
<a name="line-875"></a>        <span class='hs-comment'>-- (Remember that this also removes the binders from the</span>
<a name="line-876"></a>        <span class='hs-comment'>-- finally-returned free-vars.)</span>
<a name="line-877"></a>        <span class='hs-comment'>-- And rename each individual stmt, making a</span>
<a name="line-878"></a>        <span class='hs-comment'>-- singleton segment.  At this stage the FwdRefs field</span>
<a name="line-879"></a>        <span class='hs-comment'>-- isn't finished: it's empty for all except a BindStmt</span>
<a name="line-880"></a>        <span class='hs-comment'>-- for which it's the fwd refs within the bind itself</span>
<a name="line-881"></a>        <span class='hs-comment'>-- (This set may not be empty, because we're in a recursive</span>
<a name="line-882"></a>        <span class='hs-comment'>-- context.)</span>
<a name="line-883"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>rnRecStmtsAndThen</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>rec_stmts</span>   <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>segs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-884"></a>        <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameSetElemsStable</span> <span class='hs-varop'>$</span>
<a name="line-885"></a>                        <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionNameSet</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>ds</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-886"></a>                              <span class='hs-varid'>emptyNameSet</span>
<a name="line-887"></a>                              <span class='hs-varid'>segs</span>
<a name="line-888"></a>          <span class='hs-comment'>-- See Note [Deterministic ApplicativeDo and RecursiveDo desugaring]</span>
<a name="line-889"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_later</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>bndrs</span>
<a name="line-890"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>rec_stmts'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>segmentRecStmts</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>empty_rec_stmt</span> <span class='hs-varid'>segs</span> <span class='hs-varid'>fvs_later</span>
<a name="line-891"></a>        <span class='hs-comment'>-- We aren't going to try to group RecStmts with</span>
<a name="line-892"></a>        <span class='hs-comment'>-- ApplicativeDo, so attaching empty FVs is fine.</span>
<a name="line-893"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-varid'>rec_stmts'</span> <span class='hs-layout'>(</span><span class='hs-varid'>repeat</span> <span class='hs-varid'>emptyNameSet</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-894"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs3</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-895"></a>
<a name="line-896"></a><span class='hs-definition'>rnStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmt</span> <span class='hs-varid'>segs</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-897"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>mzip_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtNamePoly</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>mzipName</span>
<a name="line-898"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>bindMName</span>
<a name="line-899"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>return_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs3</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>returnMName</span>
<a name="line-900"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>segs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs4</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnParallelStmts</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmtCtxt</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>return_op</span> <span class='hs-varid'>segs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-901"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmt</span> <span class='hs-varid'>segs'</span> <span class='hs-varid'>mzip_op</span> <span class='hs-varid'>bind_op</span> <span class='hs-varid'>placeHolderType</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs4</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-902"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs3</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs4</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-903"></a>
<a name="line-904"></a><span class='hs-definition'>rnStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransStmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>trS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_by</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>by</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_form</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>form</span>
<a name="line-905"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>trS_using</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>using</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-906"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- Rename the 'using' expression in the context before the transform is begun</span>
<a name="line-907"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>using'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>using</span>
<a name="line-908"></a>
<a name="line-909"></a>         <span class='hs-comment'>-- Rename the stmts and the 'by' expression</span>
<a name="line-910"></a>         <span class='hs-comment'>-- Keep track of the variables mentioned in the 'by' expression</span>
<a name="line-911"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>by'</span><span class='hs-layout'>,</span> <span class='hs-varid'>used_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span>
<a name="line-912"></a>             <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnStmts</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransStmtCtxt</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>stmts</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>bndrs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-913"></a>                <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>by'</span><span class='hs-layout'>,</span>   <span class='hs-varid'>fvs_by</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapMaybeFvRn</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>by</span>
<a name="line-914"></a>                   <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_thing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>bndrs</span>
<a name="line-915"></a>                   <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvs_by</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs_thing</span>
<a name="line-916"></a>                         <span class='hs-varid'>used_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndrs</span>
<a name="line-917"></a>                         <span class='hs-comment'>-- The paper (Fig 5) has a bug here; we must treat any free variable</span>
<a name="line-918"></a>                         <span class='hs-comment'>-- of the "thing inside", **or of the by-expression**, as used</span>
<a name="line-919"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>by'</span><span class='hs-layout'>,</span> <span class='hs-varid'>used_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-920"></a>
<a name="line-921"></a>       <span class='hs-comment'>-- Lookup `return`, `(&gt;&gt;=)` and `liftM` for monad comprehensions</span>
<a name="line-922"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>return_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs3</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>returnMName</span>
<a name="line-923"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind_op</span><span class='hs-layout'>,</span>   <span class='hs-varid'>fvs4</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>bindMName</span>
<a name="line-924"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap_op</span><span class='hs-layout'>,</span>   <span class='hs-varid'>fvs5</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>form</span> <span class='hs-keyword'>of</span>
<a name="line-925"></a>                                <span class='hs-conid'>ThenForm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>noExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-926"></a>                                <span class='hs-keyword'>_</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookupStmtNamePoly</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>fmapName</span>
<a name="line-927"></a>
<a name="line-928"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>all_fvs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs3</span>
<a name="line-929"></a>                             <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs4</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs5</span>
<a name="line-930"></a>             <span class='hs-varid'>bndr_map</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>used_bndrs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>used_bndrs</span>
<a name="line-931"></a>             <span class='hs-comment'>-- See Note [TransStmt binder map] in HsExpr</span>
<a name="line-932"></a>
<a name="line-933"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceRn</span> <span class='hs-str'>"rnStmt: implicitly rebound these used binders:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>bndr_map</span><span class='hs-layout'>)</span>
<a name="line-934"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransStmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>trS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr_map</span>
<a name="line-935"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>trS_by</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>by'</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_using</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>using'</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_form</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>form</span>
<a name="line-936"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>trS_ret</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bind_op</span>
<a name="line-937"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>trS_bind_arg_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PlaceHolder</span>
<a name="line-938"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>trS_fmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap_op</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>all_fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-939"></a>
<a name="line-940"></a><span class='hs-definition'>rnStmt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>ApplicativeStmt</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span>
<a name="line-941"></a>  <span class='hs-varid'>panic</span> <span class='hs-str'>"rnStmt: ApplicativeStmt"</span>
<a name="line-942"></a>
<a name="line-943"></a><a name="rnParallelStmts"></a><span class='hs-definition'>rnParallelStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>thing</span><span class='hs-varop'>.</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-944"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SyntaxExpr</span> <span class='hs-conid'>GhcRn</span>
<a name="line-945"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ParStmtBlock</span> <span class='hs-conid'>GhcPs</span> <span class='hs-conid'>GhcPs</span><span class='hs-keyglyph'>]</span>
<a name="line-946"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-947"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>ParStmtBlock</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-948"></a><span class='hs-comment'>-- Note [Renaming parallel Stmts]</span>
<a name="line-949"></a><span class='hs-definition'>rnParallelStmts</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>return_op</span> <span class='hs-varid'>segs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-950"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>orig_lcl_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLocalRdrEnv</span>
<a name="line-951"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rn_segs</span> <span class='hs-varid'>orig_lcl_env</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>segs</span> <span class='hs-layout'>}</span>
<a name="line-952"></a>  <span class='hs-keyword'>where</span>
<a name="line-953"></a>    <span class='hs-varid'>rn_segs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LocalRdrEnv</span>
<a name="line-954"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ParStmtBlock</span> <span class='hs-conid'>GhcPs</span> <span class='hs-conid'>GhcPs</span><span class='hs-keyglyph'>]</span>
<a name="line-955"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>ParStmtBlock</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-956"></a>    <span class='hs-varid'>rn_segs</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bndrs_so_far</span> <span class='hs-conid'>[]</span>
<a name="line-957"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>dups</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>removeDups</span> <span class='hs-varid'>cmpByOcc</span> <span class='hs-varid'>bndrs_so_far</span>
<a name="line-958"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>dupErr</span> <span class='hs-varid'>dups</span>
<a name="line-959"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindLocalNames</span> <span class='hs-varid'>bndrs'</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing_inside</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>)</span>
<a name="line-960"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-961"></a>
<a name="line-962"></a>    <span class='hs-varid'>rn_segs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndrs_so_far</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmtBlock</span> <span class='hs-varid'>stmts</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conop'>:</span> <span class='hs-varid'>segs</span><span class='hs-layout'>)</span>
<a name="line-963"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>used_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>segs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>
<a name="line-964"></a>                    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnStmts</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>stmts</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>bndrs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-965"></a>                       <span class='hs-varid'>setLocalRdrEnv</span> <span class='hs-varid'>env</span>       <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-966"></a>                       <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>segs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rn_segs</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>bndrs_so_far</span><span class='hs-layout'>)</span> <span class='hs-varid'>segs</span>
<a name="line-967"></a>                       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>used_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndrs</span>
<a name="line-968"></a>                       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>used_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>segs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-969"></a>
<a name="line-970"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>seg'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ParStmtBlock</span> <span class='hs-varid'>stmts'</span> <span class='hs-varid'>used_bndrs</span> <span class='hs-varid'>return_op</span>
<a name="line-971"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>seg'</span><span class='hs-conop'>:</span><span class='hs-varid'>segs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-972"></a>
<a name="line-973"></a>    <span class='hs-varid'>cmpByOcc</span> <span class='hs-varid'>n1</span> <span class='hs-varid'>n2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>n1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>n2</span>
<a name="line-974"></a>    <span class='hs-varid'>dupErr</span> <span class='hs-varid'>vs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Duplicate binding in parallel list comprehension for:"</span>
<a name="line-975"></a>                    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>NE</span><span class='hs-varop'>.</span><span class='hs-varid'>head</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-976"></a>
<a name="line-977"></a><a name="lookupStmtName"></a><span class='hs-definition'>lookupStmtName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>SyntaxExpr</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-978"></a><span class='hs-comment'>-- Like lookupSyntaxName, but respects contexts</span>
<a name="line-979"></a><span class='hs-definition'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>n</span>
<a name="line-980"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>rebindableContext</span> <span class='hs-varid'>ctxt</span>
<a name="line-981"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupSyntaxName</span> <span class='hs-varid'>n</span>
<a name="line-982"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-983"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkRnSyntaxExpr</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-984"></a>
<a name="line-985"></a><a name="lookupStmtNamePoly"></a><span class='hs-definition'>lookupStmtNamePoly</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-986"></a><span class='hs-definition'>lookupStmtNamePoly</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>name</span>
<a name="line-987"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>rebindableContext</span> <span class='hs-varid'>ctxt</span>
<a name="line-988"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rebindable_on</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>RebindableSyntax</span>
<a name="line-989"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>rebindable_on</span>
<a name="line-990"></a>         <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fm</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupOccRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameRdrName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-991"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-varid'>fm</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>unitFV</span> <span class='hs-varid'>fm</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-992"></a>         <span class='hs-keyword'>else</span> <span class='hs-varid'>not_rebindable</span> <span class='hs-layout'>}</span>
<a name="line-993"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-994"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not_rebindable</span>
<a name="line-995"></a>  <span class='hs-keyword'>where</span>
<a name="line-996"></a>    <span class='hs-varid'>not_rebindable</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-997"></a>
<a name="line-998"></a><a name="rebindableContext"></a><span class='hs-comment'>-- | Is this a context where we respect RebindableSyntax?</span>
<a name="line-999"></a><span class='hs-comment'>-- but ListComp/PArrComp are never rebindable</span>
<a name="line-1000"></a><span class='hs-comment'>-- Neither is ArrowExpr, which has its own desugarer in DsArrows</span>
<a name="line-1001"></a><span class='hs-definition'>rebindableContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1002"></a><span class='hs-definition'>rebindableContext</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-1003"></a>  <span class='hs-conid'>ListComp</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1004"></a>  <span class='hs-conid'>PArrComp</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1005"></a>  <span class='hs-conid'>ArrowExpr</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1006"></a>  <span class='hs-conid'>PatGuard</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1007"></a>
<a name="line-1008"></a>  <span class='hs-conid'>DoExpr</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1009"></a>  <span class='hs-conid'>MDoExpr</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1010"></a>  <span class='hs-conid'>MonadComp</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1011"></a>  <span class='hs-conid'>GhciStmtCtxt</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>   <span class='hs-comment'>-- I suppose?</span>
<a name="line-1012"></a>
<a name="line-1013"></a>  <span class='hs-conid'>ParStmtCtxt</span>   <span class='hs-varid'>c</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>rebindableContext</span> <span class='hs-varid'>c</span>     <span class='hs-comment'>-- Look inside to</span>
<a name="line-1014"></a>  <span class='hs-conid'>TransStmtCtxt</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>rebindableContext</span> <span class='hs-varid'>c</span>     <span class='hs-comment'>-- the parent context</span>
<a name="line-1015"></a>
<a name="line-1016"></a><span class='hs-comment'>{-
<a name="line-1017"></a>Note [Renaming parallel Stmts]
<a name="line-1018"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1019"></a>Renaming parallel statements is painful.  Given, say
<a name="line-1020"></a>     [ a+c | a &lt;- as, bs &lt;- bss
<a name="line-1021"></a>           | c &lt;- bs, a &lt;- ds ]
<a name="line-1022"></a>Note that
<a name="line-1023"></a>  (a) In order to report "Defined but not used" about 'bs', we must
<a name="line-1024"></a>      rename each group of Stmts with a thing_inside whose FreeVars
<a name="line-1025"></a>      include at least {a,c}
<a name="line-1026"></a>
<a name="line-1027"></a>  (b) We want to report that 'a' is illegally bound in both branches
<a name="line-1028"></a>
<a name="line-1029"></a>  (c) The 'bs' in the second group must obviously not be captured by
<a name="line-1030"></a>      the binding in the first group
<a name="line-1031"></a>
<a name="line-1032"></a>To satisfy (a) we nest the segements.
<a name="line-1033"></a>To satisfy (b) we check for duplicates just before thing_inside.
<a name="line-1034"></a>To satisfy (c) we reset the LocalRdrEnv each time.
<a name="line-1035"></a>
<a name="line-1036"></a>************************************************************************
<a name="line-1037"></a>*                                                                      *
<a name="line-1038"></a>\subsubsection{mdo expressions}
<a name="line-1039"></a>*                                                                      *
<a name="line-1040"></a>************************************************************************
<a name="line-1041"></a>-}</span>
<a name="line-1042"></a>
<a name="line-1043"></a><a name="FwdRefs"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>FwdRefs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameSet</span>
<a name="line-1044"></a><a name="Segment"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Segment</span> <span class='hs-varid'>stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Defs</span><span class='hs-layout'>,</span>
<a name="line-1045"></a>                      <span class='hs-conid'>Uses</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- May include defs</span>
<a name="line-1046"></a>                      <span class='hs-conid'>FwdRefs</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- A subset of uses that are</span>
<a name="line-1047"></a>                                <span class='hs-comment'>--   (a) used before they are bound in this segment, or</span>
<a name="line-1048"></a>                                <span class='hs-comment'>--   (b) used here, and bound in subsequent segments</span>
<a name="line-1049"></a>                      <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- Either Stmt or [Stmt]</span>
<a name="line-1050"></a>
<a name="line-1051"></a>
<a name="line-1052"></a><a name="rnRecStmtsAndThen"></a><span class='hs-comment'>-- wrapper that does both the left- and right-hand sides</span>
<a name="line-1053"></a><span class='hs-definition'>rnRecStmtsAndThen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-1054"></a>                     <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-1055"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1056"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1057"></a>                         <span class='hs-comment'>-- assumes that the FreeVars returned includes</span>
<a name="line-1058"></a>                         <span class='hs-comment'>-- the FreeVars of the Segments</span>
<a name="line-1059"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Segment</span> <span class='hs-layout'>(</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1060"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1061"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-1062"></a><span class='hs-definition'>rnRecStmtsAndThen</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>s</span> <span class='hs-varid'>cont</span>
<a name="line-1063"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-comment'>-- (A) Make the mini fixity env for all of the stmts</span>
<a name="line-1064"></a>          <span class='hs-varid'>fix_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>makeMiniFixityEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectRecStmtsFixities</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-1065"></a>
<a name="line-1066"></a>          <span class='hs-comment'>-- (B) Do the LHSes</span>
<a name="line-1067"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>new_lhs_and_fv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rn_rec_stmts_lhs</span> <span class='hs-varid'>fix_env</span> <span class='hs-varid'>s</span>
<a name="line-1068"></a>
<a name="line-1069"></a>          <span class='hs-comment'>--    ...bring them and their fixities into scope</span>
<a name="line-1070"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bound_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectLStmtsBinders</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>new_lhs_and_fv</span><span class='hs-layout'>)</span>
<a name="line-1071"></a>              <span class='hs-comment'>-- Fake uses of variables introduced implicitly (warning suppression, see #4404)</span>
<a name="line-1072"></a>              <span class='hs-varid'>implicit_uses</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lStmtsImplicits</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>new_lhs_and_fv</span><span class='hs-layout'>)</span>
<a name="line-1073"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>bindLocalNamesFV</span> <span class='hs-varid'>bound_names</span> <span class='hs-varop'>$</span>
<a name="line-1074"></a>          <span class='hs-varid'>addLocalFixities</span> <span class='hs-varid'>fix_env</span> <span class='hs-varid'>bound_names</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1075"></a>
<a name="line-1076"></a>          <span class='hs-comment'>-- (C) do the right-hand-sides and thing-inside</span>
<a name="line-1077"></a>        <span class='hs-layout'>{</span> <span class='hs-varid'>segs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rn_rec_stmts</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>bound_names</span> <span class='hs-varid'>new_lhs_and_fv</span>
<a name="line-1078"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cont</span> <span class='hs-varid'>segs</span>
<a name="line-1079"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>warnUnusedLocalBinds</span> <span class='hs-varid'>bound_names</span> <span class='hs-layout'>(</span><span class='hs-varid'>fvs</span> <span class='hs-varop'>`unionNameSet`</span> <span class='hs-varid'>implicit_uses</span><span class='hs-layout'>)</span>
<a name="line-1080"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-1081"></a>
<a name="line-1082"></a><a name="collectRecStmtsFixities"></a><span class='hs-comment'>-- get all the fixity decls in any Let stmt</span>
<a name="line-1083"></a><span class='hs-definition'>collectRecStmtsFixities</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmtLR</span> <span class='hs-conid'>GhcPs</span> <span class='hs-conid'>GhcPs</span> <span class='hs-varid'>body</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LFixitySig</span> <span class='hs-conid'>GhcPs</span><span class='hs-keyglyph'>]</span>
<a name="line-1084"></a><span class='hs-definition'>collectRecStmtsFixities</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span>
<a name="line-1085"></a>    <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>acc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>of</span>
<a name="line-1086"></a>            <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValBindsIn</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1087"></a>                <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-varid'>sig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>sig</span> <span class='hs-keyword'>of</span>
<a name="line-1088"></a>                                           <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>FixSig</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>acc</span>
<a name="line-1089"></a>                                           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>sigs</span>
<a name="line-1090"></a>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>l</span>
<a name="line-1091"></a>
<a name="line-1092"></a><span class='hs-comment'>-- left-hand sides</span>
<a name="line-1093"></a>
<a name="line-1094"></a><a name="rn_rec_stmt_lhs"></a><span class='hs-definition'>rn_rec_stmt_lhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>MiniFixityEnv</span>
<a name="line-1095"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcPs</span> <span class='hs-varid'>body</span>
<a name="line-1096"></a>                   <span class='hs-comment'>-- rename LHS, and return its FVs</span>
<a name="line-1097"></a>                   <span class='hs-comment'>-- Warning: we will only need the FreeVars below in the case of a BindStmt,</span>
<a name="line-1098"></a>                   <span class='hs-comment'>-- so we don't bother to compute it accurately in the other cases</span>
<a name="line-1099"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LStmtLR</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcPs</span> <span class='hs-varid'>body</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1100"></a>
<a name="line-1101"></a><span class='hs-definition'>rn_rec_stmt_lhs</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>body</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1102"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>body</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1103"></a>
<a name="line-1104"></a><span class='hs-definition'>rn_rec_stmt_lhs</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>body</span> <span class='hs-varid'>noret</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1105"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>body</span> <span class='hs-varid'>noret</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1106"></a>
<a name="line-1107"></a><span class='hs-definition'>rn_rec_stmt_lhs</span> <span class='hs-varid'>fix_env</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>body</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1108"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1109"></a>      <span class='hs-comment'>-- should the ctxt be MDo instead?</span>
<a name="line-1110"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_pat</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnBindPat</span> <span class='hs-layout'>(</span><span class='hs-varid'>localRecNameMaker</span> <span class='hs-varid'>fix_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat</span>
<a name="line-1111"></a>      <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat'</span> <span class='hs-varid'>body</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-1112"></a>               <span class='hs-varid'>fv_pat</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1113"></a>
<a name="line-1114"></a><span class='hs-definition'>rn_rec_stmt_lhs</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>binds</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsIPBinds</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1115"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>badIpBinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"an mdo expression"</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-1116"></a>
<a name="line-1117"></a><span class='hs-definition'>rn_rec_stmt_lhs</span> <span class='hs-varid'>fix_env</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span><span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1118"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-sel'>_bound_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLocalValBindsLHS</span> <span class='hs-varid'>fix_env</span> <span class='hs-varid'>binds</span>
<a name="line-1119"></a>         <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-1120"></a>                 <span class='hs-comment'>-- Warning: this is bogus; see function invariant</span>
<a name="line-1121"></a>                 <span class='hs-varid'>emptyFVs</span>
<a name="line-1122"></a>                 <span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1123"></a>
<a name="line-1124"></a><span class='hs-comment'>-- XXX Do we need to do something with the return and mfix names?</span>
<a name="line-1125"></a><span class='hs-definition'>rn_rec_stmt_lhs</span> <span class='hs-varid'>fix_env</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecStmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>recS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Flatten Rec inside Rec</span>
<a name="line-1126"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rn_rec_stmts_lhs</span> <span class='hs-varid'>fix_env</span> <span class='hs-varid'>stmts</span>
<a name="line-1127"></a>
<a name="line-1128"></a><span class='hs-definition'>rn_rec_stmt_lhs</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>       <span class='hs-comment'>-- Syntactically illegal in mdo</span>
<a name="line-1129"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rn_rec_stmt"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span>
<a name="line-1130"></a>
<a name="line-1131"></a><span class='hs-definition'>rn_rec_stmt_lhs</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>     <span class='hs-comment'>-- Syntactically illegal in mdo</span>
<a name="line-1132"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rn_rec_stmt"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span>
<a name="line-1133"></a>
<a name="line-1134"></a><span class='hs-definition'>rn_rec_stmt_lhs</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ApplicativeStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Shouldn't appear yet</span>
<a name="line-1135"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rn_rec_stmt"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span>
<a name="line-1136"></a>
<a name="line-1137"></a><span class='hs-definition'>rn_rec_stmt_lhs</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>EmptyLocalBinds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1138"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"rn_rec_stmt LetStmt EmptyLocalBinds"</span>
<a name="line-1139"></a>
<a name="line-1140"></a><a name="rn_rec_stmts_lhs"></a><span class='hs-definition'>rn_rec_stmts_lhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>MiniFixityEnv</span>
<a name="line-1141"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcPs</span> <span class='hs-varid'>body</span><span class='hs-keyglyph'>]</span>
<a name="line-1142"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LStmtLR</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcPs</span> <span class='hs-varid'>body</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1143"></a><span class='hs-definition'>rn_rec_stmts_lhs</span> <span class='hs-varid'>fix_env</span> <span class='hs-varid'>stmts</span>
<a name="line-1144"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>concatMapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>rn_rec_stmt_lhs</span> <span class='hs-varid'>fix_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>stmts</span>
<a name="line-1145"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>boundNames</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectLStmtsBinders</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>ls</span><span class='hs-layout'>)</span>
<a name="line-1146"></a>            <span class='hs-comment'>-- First do error checking: we need to check for dups here because we</span>
<a name="line-1147"></a>            <span class='hs-comment'>-- don't bind all of the variables from the Stmt at once</span>
<a name="line-1148"></a>            <span class='hs-comment'>-- with bindLocatedLocals.</span>
<a name="line-1149"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkDupNames</span> <span class='hs-varid'>boundNames</span>
<a name="line-1150"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ls</span> <span class='hs-layout'>}</span>
<a name="line-1151"></a>
<a name="line-1152"></a>
<a name="line-1153"></a><span class='hs-comment'>-- right-hand-sides</span>
<a name="line-1154"></a>
<a name="line-1155"></a><a name="rn_rec_stmt"></a><span class='hs-definition'>rn_rec_stmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-1156"></a>               <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1157"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-1158"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LStmtLR</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-1159"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Segment</span> <span class='hs-layout'>(</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1160"></a>        <span class='hs-comment'>-- Rename a Stmt that is inside a RecStmt (or mdo)</span>
<a name="line-1161"></a>        <span class='hs-comment'>-- Assumes all binders are already in scope</span>
<a name="line-1162"></a>        <span class='hs-comment'>-- Turns each stmt into a singleton Stmt</span>
<a name="line-1163"></a><span class='hs-definition'>rn_rec_stmt</span> <span class='hs-varid'>rnBody</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>body</span> <span class='hs-varid'>noret</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-1164"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>body'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>body</span>
<a name="line-1165"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ret_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupSyntaxName</span> <span class='hs-varid'>returnMName</span>
<a name="line-1166"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>emptyNameSet</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_expr</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyNameSet</span><span class='hs-layout'>,</span>
<a name="line-1167"></a>                   <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>body'</span> <span class='hs-varid'>noret</span> <span class='hs-varid'>ret_op</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-1168"></a>
<a name="line-1169"></a><span class='hs-definition'>rn_rec_stmt</span> <span class='hs-varid'>rnBody</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>body</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-1170"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>body'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>body</span>
<a name="line-1171"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>then_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupSyntaxName</span> <span class='hs-varid'>thenMName</span>
<a name="line-1172"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>emptyNameSet</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyNameSet</span><span class='hs-layout'>,</span>
<a name="line-1173"></a>                 <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>body'</span> <span class='hs-varid'>then_op</span> <span class='hs-varid'>noSyntaxExpr</span> <span class='hs-varid'>placeHolderType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-1174"></a>
<a name="line-1175"></a><span class='hs-definition'>rn_rec_stmt</span> <span class='hs-varid'>rnBody</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat'</span> <span class='hs-varid'>body</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_pat</span><span class='hs-layout'>)</span>
<a name="line-1176"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>body'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>body</span>
<a name="line-1177"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupSyntaxName</span> <span class='hs-varid'>bindMName</span>
<a name="line-1178"></a>
<a name="line-1179"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>xMonadFailEnabled</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>xopt</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>MonadFailDesugaring</span><span class='hs-layout'>)</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-1180"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>failFunction</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>xMonadFailEnabled</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failMName</span>
<a name="line-1181"></a>                          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failMName_preMFP</span>
<a name="line-1182"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>fail_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupSyntaxName</span> <span class='hs-varid'>failFunction</span>
<a name="line-1183"></a>
<a name="line-1184"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectPatBinders</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>)</span>
<a name="line-1185"></a>             <span class='hs-varid'>fvs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fv_expr</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fv_pat</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span>
<a name="line-1186"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs</span> <span class='hs-varop'>`intersectNameSet`</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>,</span>
<a name="line-1187"></a>                  <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat'</span> <span class='hs-varid'>body'</span> <span class='hs-varid'>bind_op</span> <span class='hs-varid'>fail_op</span> <span class='hs-conid'>PlaceHolder</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-1188"></a>
<a name="line-1189"></a><span class='hs-definition'>rn_rec_stmt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>binds</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsIPBinds</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-1190"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>badIpBinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"an mdo expression"</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-1191"></a>
<a name="line-1192"></a><span class='hs-definition'>rn_rec_stmt</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>all_bndrs</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-1193"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>du_binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLocalValBindsRHS</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNameSet</span> <span class='hs-varid'>all_bndrs</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds'</span>
<a name="line-1194"></a>           <span class='hs-comment'>-- fixities and unused are handled above in rnRecStmtsAndThen</span>
<a name="line-1195"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>allUses</span> <span class='hs-varid'>du_binds</span>
<a name="line-1196"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>duDefs</span> <span class='hs-varid'>du_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyNameSet</span><span class='hs-layout'>,</span>
<a name="line-1197"></a>                 <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-1198"></a>
<a name="line-1199"></a><span class='hs-comment'>-- no RecStmt case because they get flattened above when doing the LHSes</span>
<a name="line-1200"></a><span class='hs-definition'>rn_rec_stmt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-1201"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rn_rec_stmt: RecStmt"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span>
<a name="line-1202"></a>
<a name="line-1203"></a><span class='hs-definition'>rn_rec_stmt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-comment'>-- Syntactically illegal in mdo</span>
<a name="line-1204"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rn_rec_stmt: ParStmt"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span>
<a name="line-1205"></a>
<a name="line-1206"></a><span class='hs-definition'>rn_rec_stmt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-comment'>-- Syntactically illegal in mdo</span>
<a name="line-1207"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rn_rec_stmt: TransStmt"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span>
<a name="line-1208"></a>
<a name="line-1209"></a><span class='hs-definition'>rn_rec_stmt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>EmptyLocalBinds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-1210"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"rn_rec_stmt: LetStmt EmptyLocalBinds"</span>
<a name="line-1211"></a>
<a name="line-1212"></a><span class='hs-definition'>rn_rec_stmt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ApplicativeStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-1213"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rn_rec_stmt: ApplicativeStmt"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span>
<a name="line-1214"></a>
<a name="line-1215"></a><a name="rn_rec_stmts"></a><span class='hs-definition'>rn_rec_stmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-1216"></a>                <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1217"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-1218"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LStmtLR</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1219"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Segment</span> <span class='hs-layout'>(</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1220"></a><span class='hs-definition'>rn_rec_stmts</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>stmts</span>
<a name="line-1221"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>segs_s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>rn_rec_stmt</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span> <span class='hs-varid'>stmts</span>
<a name="line-1222"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>concat</span> <span class='hs-varid'>segs_s</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1223"></a>
<a name="line-1224"></a><a name="segmentRecStmts"></a><span class='hs-comment'>---------------------------------------------</span>
<a name="line-1225"></a><span class='hs-definition'>segmentRecStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-1226"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Stmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-varid'>body</span>
<a name="line-1227"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Segment</span> <span class='hs-layout'>(</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVars</span>
<a name="line-1228"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-varid'>body</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-1229"></a>
<a name="line-1230"></a><span class='hs-definition'>segmentRecStmts</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>empty_rec_stmt</span> <span class='hs-varid'>segs</span> <span class='hs-varid'>fvs_later</span>
<a name="line-1231"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>segs</span>
<a name="line-1232"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_later</span><span class='hs-layout'>)</span>
<a name="line-1233"></a>
<a name="line-1234"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MDoExpr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ctxt</span>
<a name="line-1235"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>segsToStmts</span> <span class='hs-varid'>empty_rec_stmt</span> <span class='hs-varid'>grouped_segs</span> <span class='hs-varid'>fvs_later</span>
<a name="line-1236"></a>               <span class='hs-comment'>-- Step 4: Turn the segments into Stmts</span>
<a name="line-1237"></a>                <span class='hs-comment'>--         Use RecStmt when and only when there are fwd refs</span>
<a name="line-1238"></a>                <span class='hs-comment'>--         Also gather up the uses from the end towards the</span>
<a name="line-1239"></a>                <span class='hs-comment'>--         start, so we can tell the RecStmt which things are</span>
<a name="line-1240"></a>                <span class='hs-comment'>--         used 'after' the RecStmt</span>
<a name="line-1241"></a>
<a name="line-1242"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1243"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-1244"></a>       <span class='hs-varid'>empty_rec_stmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>recS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ss</span>
<a name="line-1245"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>recS_later_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameSetElemsStable</span>
<a name="line-1246"></a>                                           <span class='hs-layout'>(</span><span class='hs-varid'>defs</span> <span class='hs-varop'>`intersectNameSet`</span> <span class='hs-varid'>fvs_later</span><span class='hs-layout'>)</span>
<a name="line-1247"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>recS_rec_ids</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameSetElemsStable</span>
<a name="line-1248"></a>                                           <span class='hs-layout'>(</span><span class='hs-varid'>defs</span> <span class='hs-varop'>`intersectNameSet`</span> <span class='hs-varid'>uses</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-keyglyph'>]</span>
<a name="line-1249"></a>          <span class='hs-comment'>-- See Note [Deterministic ApplicativeDo and RecursiveDo desugaring]</span>
<a name="line-1250"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>uses</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs_later</span><span class='hs-layout'>)</span>
<a name="line-1251"></a>
<a name="line-1252"></a>  <span class='hs-keyword'>where</span>
<a name="line-1253"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>defs_s</span><span class='hs-layout'>,</span> <span class='hs-varid'>uses_s</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip4</span> <span class='hs-varid'>segs</span>
<a name="line-1254"></a>    <span class='hs-varid'>defs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusFVs</span> <span class='hs-varid'>defs_s</span>
<a name="line-1255"></a>    <span class='hs-varid'>uses</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusFVs</span> <span class='hs-varid'>uses_s</span>
<a name="line-1256"></a>
<a name="line-1257"></a>                <span class='hs-comment'>-- Step 2: Fill in the fwd refs.</span>
<a name="line-1258"></a>                <span class='hs-comment'>--         The segments are all singletons, but their fwd-ref</span>
<a name="line-1259"></a>                <span class='hs-comment'>--         field mentions all the things used by the segment</span>
<a name="line-1260"></a>                <span class='hs-comment'>--         that are bound after their use</span>
<a name="line-1261"></a>    <span class='hs-varid'>segs_w_fwd_refs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addFwdRefs</span> <span class='hs-varid'>segs</span>
<a name="line-1262"></a>
<a name="line-1263"></a>                <span class='hs-comment'>-- Step 3: Group together the segments to make bigger segments</span>
<a name="line-1264"></a>                <span class='hs-comment'>--         Invariant: in the result, no segment uses a variable</span>
<a name="line-1265"></a>                <span class='hs-comment'>--                    bound in a later segment</span>
<a name="line-1266"></a>    <span class='hs-varid'>grouped_segs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>glomSegments</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>segs_w_fwd_refs</span>
<a name="line-1267"></a>
<a name="line-1268"></a><a name="addFwdRefs"></a><span class='hs-comment'>----------------------------</span>
<a name="line-1269"></a><span class='hs-definition'>addFwdRefs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Segment</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Segment</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-1270"></a><span class='hs-comment'>-- So far the segments only have forward refs *within* the Stmt</span>
<a name="line-1271"></a><span class='hs-comment'>--      (which happens for bind:  x &lt;- ...x...)</span>
<a name="line-1272"></a><span class='hs-comment'>-- This function adds the cross-seg fwd ref info</span>
<a name="line-1273"></a>
<a name="line-1274"></a><span class='hs-definition'>addFwdRefs</span> <span class='hs-varid'>segs</span>
<a name="line-1275"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-varid'>mk_seg</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyNameSet</span><span class='hs-layout'>)</span> <span class='hs-varid'>segs</span><span class='hs-layout'>)</span>
<a name="line-1276"></a>  <span class='hs-keyword'>where</span>
<a name="line-1277"></a>    <span class='hs-varid'>mk_seg</span> <span class='hs-layout'>(</span><span class='hs-varid'>defs</span><span class='hs-layout'>,</span> <span class='hs-varid'>uses</span><span class='hs-layout'>,</span> <span class='hs-varid'>fwds</span><span class='hs-layout'>,</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>segs</span><span class='hs-layout'>,</span> <span class='hs-varid'>later_defs</span><span class='hs-layout'>)</span>
<a name="line-1278"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_seg</span> <span class='hs-conop'>:</span> <span class='hs-varid'>segs</span><span class='hs-layout'>,</span> <span class='hs-varid'>all_defs</span><span class='hs-layout'>)</span>
<a name="line-1279"></a>        <span class='hs-keyword'>where</span>
<a name="line-1280"></a>          <span class='hs-varid'>new_seg</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>defs</span><span class='hs-layout'>,</span> <span class='hs-varid'>uses</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_fwds</span><span class='hs-layout'>,</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span>
<a name="line-1281"></a>          <span class='hs-varid'>all_defs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>later_defs</span> <span class='hs-varop'>`unionNameSet`</span> <span class='hs-varid'>defs</span>
<a name="line-1282"></a>          <span class='hs-varid'>new_fwds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fwds</span> <span class='hs-varop'>`unionNameSet`</span> <span class='hs-layout'>(</span><span class='hs-varid'>uses</span> <span class='hs-varop'>`intersectNameSet`</span> <span class='hs-varid'>later_defs</span><span class='hs-layout'>)</span>
<a name="line-1283"></a>                <span class='hs-comment'>-- Add the downstream fwd refs here</span>
<a name="line-1284"></a>
<a name="line-1285"></a><span class='hs-comment'>{-
<a name="line-1286"></a>Note [Segmenting mdo]
<a name="line-1287"></a>~~~~~~~~~~~~~~~~~~~~~
<a name="line-1288"></a>NB. June 7 2012: We only glom segments that appear in an explicit mdo;
<a name="line-1289"></a>and leave those found in "do rec"'s intact.  See
<a name="line-1290"></a><a href="http://ghc.haskell.org/trac/ghc/ticket/4148">http://ghc.haskell.org/trac/ghc/ticket/4148</a> for the discussion
<a name="line-1291"></a>leading to this design choice.  Hence the test in segmentRecStmts.
<a name="line-1292"></a>
<a name="line-1293"></a>Note [Glomming segments]
<a name="line-1294"></a>~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1295"></a>Glomming the singleton segments of an mdo into minimal recursive groups.
<a name="line-1296"></a>
<a name="line-1297"></a>At first I thought this was just strongly connected components, but
<a name="line-1298"></a>there's an important constraint: the order of the stmts must not change.
<a name="line-1299"></a>
<a name="line-1300"></a>Consider
<a name="line-1301"></a>     mdo { x &lt;- ...y...
<a name="line-1302"></a>           p &lt;- z
<a name="line-1303"></a>           y &lt;- ...x...
<a name="line-1304"></a>           q &lt;- x
<a name="line-1305"></a>           z &lt;- y
<a name="line-1306"></a>           r &lt;- x }
<a name="line-1307"></a>
<a name="line-1308"></a>Here, the first stmt mention 'y', which is bound in the third.
<a name="line-1309"></a>But that means that the innocent second stmt (p &lt;- z) gets caught
<a name="line-1310"></a>up in the recursion.  And that in turn means that the binding for
<a name="line-1311"></a>'z' has to be included... and so on.
<a name="line-1312"></a>
<a name="line-1313"></a>Start at the tail { r &lt;- x }
<a name="line-1314"></a>Now add the next one { z &lt;- y ; r &lt;- x }
<a name="line-1315"></a>Now add one more     { q &lt;- x ; z &lt;- y ; r &lt;- x }
<a name="line-1316"></a>Now one more... but this time we have to group a bunch into rec
<a name="line-1317"></a>     { rec { y &lt;- ...x... ; q &lt;- x ; z &lt;- y } ; r &lt;- x }
<a name="line-1318"></a>Now one more, which we can add on without a rec
<a name="line-1319"></a>     { p &lt;- z ;
<a name="line-1320"></a>       rec { y &lt;- ...x... ; q &lt;- x ; z &lt;- y } ;
<a name="line-1321"></a>       r &lt;- x }
<a name="line-1322"></a>Finally we add the last one; since it mentions y we have to
<a name="line-1323"></a>glom it together with the first two groups
<a name="line-1324"></a>     { rec { x &lt;- ...y...; p &lt;- z ; y &lt;- ...x... ;
<a name="line-1325"></a>             q &lt;- x ; z &lt;- y } ;
<a name="line-1326"></a>       r &lt;- x }
<a name="line-1327"></a>-}</span>
<a name="line-1328"></a>
<a name="line-1329"></a><a name="glomSegments"></a><span class='hs-definition'>glomSegments</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-1330"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Segment</span> <span class='hs-layout'>(</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1331"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Segment</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-varid'>body</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-1332"></a>                                  <span class='hs-comment'>-- Each segment has a non-empty list of Stmts</span>
<a name="line-1333"></a><span class='hs-comment'>-- See Note [Glomming segments]</span>
<a name="line-1334"></a>
<a name="line-1335"></a><span class='hs-definition'>glomSegments</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-1336"></a><span class='hs-definition'>glomSegments</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>defs</span><span class='hs-layout'>,</span><span class='hs-varid'>uses</span><span class='hs-layout'>,</span><span class='hs-varid'>fwds</span><span class='hs-layout'>,</span><span class='hs-varid'>stmt</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>segs</span><span class='hs-layout'>)</span>
<a name="line-1337"></a>        <span class='hs-comment'>-- Actually stmts will always be a singleton</span>
<a name="line-1338"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>seg_defs</span><span class='hs-layout'>,</span> <span class='hs-varid'>seg_uses</span><span class='hs-layout'>,</span> <span class='hs-varid'>seg_fwds</span><span class='hs-layout'>,</span> <span class='hs-varid'>seg_stmts</span><span class='hs-layout'>)</span>  <span class='hs-conop'>:</span> <span class='hs-varid'>others</span>
<a name="line-1339"></a>  <span class='hs-keyword'>where</span>
<a name="line-1340"></a>    <span class='hs-varid'>segs'</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>glomSegments</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>segs</span>
<a name="line-1341"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>extras</span><span class='hs-layout'>,</span> <span class='hs-varid'>others</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>grab</span> <span class='hs-varid'>uses</span> <span class='hs-varid'>segs'</span>
<a name="line-1342"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>ds</span><span class='hs-layout'>,</span> <span class='hs-varid'>us</span><span class='hs-layout'>,</span> <span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip4</span> <span class='hs-varid'>extras</span>
<a name="line-1343"></a>
<a name="line-1344"></a>    <span class='hs-varid'>seg_defs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusFVs</span> <span class='hs-varid'>ds</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>defs</span>
<a name="line-1345"></a>    <span class='hs-varid'>seg_uses</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusFVs</span> <span class='hs-varid'>us</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>uses</span>
<a name="line-1346"></a>    <span class='hs-varid'>seg_fwds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusFVs</span> <span class='hs-varid'>fs</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fwds</span>
<a name="line-1347"></a>    <span class='hs-varid'>seg_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmt</span> <span class='hs-conop'>:</span> <span class='hs-varid'>concat</span> <span class='hs-varid'>ss</span>
<a name="line-1348"></a>
<a name="line-1349"></a>    <span class='hs-varid'>grab</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameSet</span>             <span class='hs-comment'>-- The client</span>
<a name="line-1350"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Segment</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-1351"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Segment</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- Needed by the 'client'</span>
<a name="line-1352"></a>             <span class='hs-keyglyph'>[</span><span class='hs-conid'>Segment</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>       <span class='hs-comment'>-- Not needed by the client</span>
<a name="line-1353"></a>        <span class='hs-comment'>-- The result is simply a split of the input</span>
<a name="line-1354"></a>    <span class='hs-varid'>grab</span> <span class='hs-varid'>uses</span> <span class='hs-varid'>dus</span>
<a name="line-1355"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>yeses</span><span class='hs-layout'>,</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>noes</span><span class='hs-layout'>)</span>
<a name="line-1356"></a>        <span class='hs-keyword'>where</span>
<a name="line-1357"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>noes</span><span class='hs-layout'>,</span> <span class='hs-varid'>yeses</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>span</span> <span class='hs-varid'>not_needed</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>dus</span><span class='hs-layout'>)</span>
<a name="line-1358"></a>          <span class='hs-varid'>not_needed</span> <span class='hs-layout'>(</span><span class='hs-varid'>defs</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>intersectsNameSet</span> <span class='hs-varid'>defs</span> <span class='hs-varid'>uses</span><span class='hs-layout'>)</span>
<a name="line-1359"></a>
<a name="line-1360"></a><a name="segsToStmts"></a><span class='hs-comment'>----------------------------------------------------</span>
<a name="line-1361"></a><span class='hs-definition'>segsToStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Stmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-varid'>body</span>
<a name="line-1362"></a>                                  <span class='hs-comment'>-- A RecStmt with the SyntaxOps filled in</span>
<a name="line-1363"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Segment</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-varid'>body</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-1364"></a>                                  <span class='hs-comment'>-- Each Segment has a non-empty list of Stmts</span>
<a name="line-1365"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVars</span>           <span class='hs-comment'>-- Free vars used 'later'</span>
<a name="line-1366"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-varid'>body</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-1367"></a>
<a name="line-1368"></a><span class='hs-definition'>segsToStmts</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>fvs_later</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_later</span><span class='hs-layout'>)</span>
<a name="line-1369"></a><span class='hs-definition'>segsToStmts</span> <span class='hs-varid'>empty_rec_stmt</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>defs</span><span class='hs-layout'>,</span> <span class='hs-varid'>uses</span><span class='hs-layout'>,</span> <span class='hs-varid'>fwds</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>segs</span><span class='hs-layout'>)</span> <span class='hs-varid'>fvs_later</span>
<a name="line-1370"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-1371"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>new_stmt</span> <span class='hs-conop'>:</span> <span class='hs-varid'>later_stmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>later_uses</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>uses</span><span class='hs-layout'>)</span>
<a name="line-1372"></a>  <span class='hs-keyword'>where</span>
<a name="line-1373"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>later_stmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>later_uses</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>segsToStmts</span> <span class='hs-varid'>empty_rec_stmt</span> <span class='hs-varid'>segs</span> <span class='hs-varid'>fvs_later</span>
<a name="line-1374"></a>    <span class='hs-varid'>new_stmt</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>non_rec</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>head</span> <span class='hs-varid'>ss</span>
<a name="line-1375"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>rec_stmt</span>
<a name="line-1376"></a>    <span class='hs-varid'>rec_stmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty_rec_stmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>recS_stmts</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ss</span>
<a name="line-1377"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>recS_later_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameSetElemsStable</span> <span class='hs-varid'>used_later</span>
<a name="line-1378"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>recS_rec_ids</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameSetElemsStable</span> <span class='hs-varid'>fwds</span> <span class='hs-layout'>}</span>
<a name="line-1379"></a>          <span class='hs-comment'>-- See Note [Deterministic ApplicativeDo and RecursiveDo desugaring]</span>
<a name="line-1380"></a>    <span class='hs-varid'>non_rec</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isSingleton</span> <span class='hs-varid'>ss</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyNameSet</span> <span class='hs-varid'>fwds</span>
<a name="line-1381"></a>    <span class='hs-varid'>used_later</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defs</span> <span class='hs-varop'>`intersectNameSet`</span> <span class='hs-varid'>later_uses</span>
<a name="line-1382"></a>                                <span class='hs-comment'>-- The ones needed after the RecStmt</span>
<a name="line-1383"></a>
<a name="line-1384"></a><span class='hs-comment'>{-
<a name="line-1385"></a>************************************************************************
<a name="line-1386"></a>*                                                                      *
<a name="line-1387"></a>ApplicativeDo
<a name="line-1388"></a>*                                                                      *
<a name="line-1389"></a>************************************************************************
<a name="line-1390"></a>
<a name="line-1391"></a>Note [ApplicativeDo]
<a name="line-1392"></a>
<a name="line-1393"></a>= Example =
<a name="line-1394"></a>
<a name="line-1395"></a>For a sequence of statements
<a name="line-1396"></a>
<a name="line-1397"></a> do
<a name="line-1398"></a>     x &lt;- A
<a name="line-1399"></a>     y &lt;- B x
<a name="line-1400"></a>     z &lt;- C
<a name="line-1401"></a>     return (f x y z)
<a name="line-1402"></a>
<a name="line-1403"></a>We want to transform this to
<a name="line-1404"></a>
<a name="line-1405"></a>  (\(x,y) z -&gt; f x y z) &lt;$&gt; (do x &lt;- A; y &lt;- B x; return (x,y)) &lt;*&gt; C
<a name="line-1406"></a>
<a name="line-1407"></a>It would be easy to notice that "y &lt;- B x" and "z &lt;- C" are
<a name="line-1408"></a>independent and do something like this:
<a name="line-1409"></a>
<a name="line-1410"></a> do
<a name="line-1411"></a>     x &lt;- A
<a name="line-1412"></a>     (y,z) &lt;- (,) &lt;$&gt; B x &lt;*&gt; C
<a name="line-1413"></a>     return (f x y z)
<a name="line-1414"></a>
<a name="line-1415"></a>But this isn't enough! A and C were also independent, and this
<a name="line-1416"></a>transformation loses the ability to do A and C in parallel.
<a name="line-1417"></a>
<a name="line-1418"></a>The algorithm works by first splitting the sequence of statements into
<a name="line-1419"></a>independent "segments", and a separate "tail" (the final statement). In
<a name="line-1420"></a>our example above, the segements would be
<a name="line-1421"></a>
<a name="line-1422"></a>     [ x &lt;- A
<a name="line-1423"></a>     , y &lt;- B x ]
<a name="line-1424"></a>
<a name="line-1425"></a>     [ z &lt;- C ]
<a name="line-1426"></a>
<a name="line-1427"></a>and the tail is:
<a name="line-1428"></a>
<a name="line-1429"></a>     return (f x y z)
<a name="line-1430"></a>
<a name="line-1431"></a>Then we take these segments and make an Applicative expression from them:
<a name="line-1432"></a>
<a name="line-1433"></a>     (\(x,y) z -&gt; return (f x y z))
<a name="line-1434"></a>       &lt;$&gt; do { x &lt;- A; y &lt;- B x; return (x,y) }
<a name="line-1435"></a>       &lt;*&gt; C
<a name="line-1436"></a>
<a name="line-1437"></a>Finally, we recursively apply the transformation to each segment, to
<a name="line-1438"></a>discover any nested parallelism.
<a name="line-1439"></a>
<a name="line-1440"></a>= Syntax &amp; spec =
<a name="line-1441"></a>
<a name="line-1442"></a>  expr ::= ... | do {stmt_1; ..; stmt_n} expr | ...
<a name="line-1443"></a>
<a name="line-1444"></a>  stmt ::= pat &lt;- expr
<a name="line-1445"></a>         | (arg_1 | ... | arg_n)  -- applicative composition, n&gt;=1
<a name="line-1446"></a>         | ...                    -- other kinds of statement (e.g. let)
<a name="line-1447"></a>
<a name="line-1448"></a>  arg ::= pat &lt;- expr
<a name="line-1449"></a>        | {stmt_1; ..; stmt_n} {var_1..var_n}
<a name="line-1450"></a>
<a name="line-1451"></a>(note that in the actual implementation,the expr in a do statement is
<a name="line-1452"></a>represented by a LastStmt as the final stmt, this is just a
<a name="line-1453"></a>representational issue and may change later.)
<a name="line-1454"></a>
<a name="line-1455"></a>== Transformation to introduce applicative stmts ==
<a name="line-1456"></a>
<a name="line-1457"></a>ado {} tail = tail
<a name="line-1458"></a>ado {pat &lt;- expr} {return expr'} = (mkArg(pat &lt;- expr)); return expr'
<a name="line-1459"></a>ado {one} tail = one : tail
<a name="line-1460"></a>ado stmts tail
<a name="line-1461"></a>  | n == 1 = ado before (ado after tail)
<a name="line-1462"></a>    where (before,after) = split(stmts_1)
<a name="line-1463"></a>  | n &gt; 1  = (mkArg(stmts_1) | ... | mkArg(stmts_n)); tail
<a name="line-1464"></a>  where
<a name="line-1465"></a>    {stmts_1 .. stmts_n} = segments(stmts)
<a name="line-1466"></a>
<a name="line-1467"></a>segments(stmts) =
<a name="line-1468"></a>  -- divide stmts into segments with no interdependencies
<a name="line-1469"></a>
<a name="line-1470"></a>mkArg({pat &lt;- expr}) = (pat &lt;- expr)
<a name="line-1471"></a>mkArg({stmt_1; ...; stmt_n}) =
<a name="line-1472"></a>  {stmt_1; ...; stmt_n} {vars(stmt_1) u .. u vars(stmt_n)}
<a name="line-1473"></a>
<a name="line-1474"></a>split({stmt_1; ..; stmt_n) =
<a name="line-1475"></a>  ({stmt_1; ..; stmt_i}, {stmt_i+1; ..; stmt_n})
<a name="line-1476"></a>  -- 1 &lt;= i &lt;= n
<a name="line-1477"></a>  -- i is a good place to insert a bind
<a name="line-1478"></a>
<a name="line-1479"></a>== Desugaring for do ==
<a name="line-1480"></a>
<a name="line-1481"></a>dsDo {} expr = expr
<a name="line-1482"></a>
<a name="line-1483"></a>dsDo {pat &lt;- rhs; stmts} expr =
<a name="line-1484"></a>   rhs &gt;&gt;= \pat -&gt; dsDo stmts expr
<a name="line-1485"></a>
<a name="line-1486"></a>dsDo {(arg_1 | ... | arg_n)} (return expr) =
<a name="line-1487"></a>  (\argpat (arg_1) .. argpat(arg_n) -&gt; expr)
<a name="line-1488"></a>     &lt;$&gt; argexpr(arg_1)
<a name="line-1489"></a>     &lt;*&gt; ...
<a name="line-1490"></a>     &lt;*&gt; argexpr(arg_n)
<a name="line-1491"></a>
<a name="line-1492"></a>dsDo {(arg_1 | ... | arg_n); stmts} expr =
<a name="line-1493"></a>  join (\argpat (arg_1) .. argpat(arg_n) -&gt; dsDo stmts expr)
<a name="line-1494"></a>     &lt;$&gt; argexpr(arg_1)
<a name="line-1495"></a>     &lt;*&gt; ...
<a name="line-1496"></a>     &lt;*&gt; argexpr(arg_n)
<a name="line-1497"></a>
<a name="line-1498"></a>-}</span>
<a name="line-1499"></a>
<a name="line-1500"></a><a name="MonadNames"></a><span class='hs-comment'>-- | The 'Name's of @return@ and @pure@. These may not be 'returnName' and</span>
<a name="line-1501"></a><a name="MonadNames"></a><span class='hs-comment'>-- 'pureName' due to @RebindableSyntax@.</span>
<a name="line-1502"></a><a name="MonadNames"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>MonadNames</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MonadNames</span> <span class='hs-layout'>{</span> <span class='hs-varid'>return_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>pure_name</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>}</span>
<a name="line-1503"></a>
<a name="line-1504"></a><a name="rearrangeForApplicativeDo"></a><span class='hs-comment'>-- | rearrange a list of statements using ApplicativeDoStmt.  See</span>
<a name="line-1505"></a><span class='hs-comment'>-- Note [ApplicativeDo].</span>
<a name="line-1506"></a><span class='hs-definition'>rearrangeForApplicativeDo</span>
<a name="line-1507"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-1508"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>ExprLStmt</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1509"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>ExprLStmt</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-1510"></a>
<a name="line-1511"></a><span class='hs-definition'>rearrangeForApplicativeDo</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyNameSet</span><span class='hs-layout'>)</span>
<a name="line-1512"></a><span class='hs-definition'>rearrangeForApplicativeDo</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>one</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>one</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyNameSet</span><span class='hs-layout'>)</span>
<a name="line-1513"></a><span class='hs-definition'>rearrangeForApplicativeDo</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmts0</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1514"></a>  <span class='hs-varid'>optimal_ado</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>goptM</span> <span class='hs-conid'>Opt_OptimalApplicativeDo</span>
<a name="line-1515"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>stmt_tree</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>optimal_ado</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkStmtTreeOptimal</span> <span class='hs-varid'>stmts</span>
<a name="line-1516"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkStmtTreeHeuristic</span> <span class='hs-varid'>stmts</span>
<a name="line-1517"></a>  <span class='hs-varid'>traceRn</span> <span class='hs-str'>"rearrangeForADo"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>stmt_tree</span><span class='hs-layout'>)</span>
<a name="line-1518"></a>  <span class='hs-varid'>return_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupSyntaxName'</span> <span class='hs-varid'>returnMName</span>
<a name="line-1519"></a>  <span class='hs-varid'>pure_name</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupSyntaxName'</span> <span class='hs-varid'>pureAName</span>
<a name="line-1520"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>monad_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MonadNames</span> <span class='hs-layout'>{</span> <span class='hs-varid'>return_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return_name</span>
<a name="line-1521"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>pure_name</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pure_name</span> <span class='hs-layout'>}</span>
<a name="line-1522"></a>  <span class='hs-varid'>stmtTreeToStmts</span> <span class='hs-varid'>monad_names</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt_tree</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>last</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>last_fvs</span>
<a name="line-1523"></a>  <span class='hs-keyword'>where</span>
<a name="line-1524"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>stmts</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>last</span><span class='hs-layout'>,</span><span class='hs-varid'>last_fvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findLast</span> <span class='hs-varid'>stmts0</span>
<a name="line-1525"></a>    <span class='hs-varid'>findLast</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"findLast"</span>
<a name="line-1526"></a>    <span class='hs-varid'>findLast</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>last</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-varid'>last</span><span class='hs-layout'>)</span>
<a name="line-1527"></a>    <span class='hs-varid'>findLast</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>rest</span><span class='hs-layout'>,</span><span class='hs-varid'>last</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>rest</span><span class='hs-layout'>,</span><span class='hs-varid'>last</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findLast</span> <span class='hs-varid'>xs</span>
<a name="line-1528"></a>
<a name="line-1529"></a><a name="StmtTree"></a><span class='hs-comment'>-- | A tree of statements using a mixture of applicative and bind constructs.</span>
<a name="line-1530"></a><a name="StmtTree"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>StmtTree</span> <span class='hs-varid'>a</span>
<a name="line-1531"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StmtTreeOne</span> <span class='hs-varid'>a</span>
<a name="line-1532"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StmtTreeBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtTree</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtTree</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1533"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StmtTreeApplicative</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StmtTree</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-1534"></a>
<a name="line-1535"></a><a name="instance%20Outputable%20(StmtTree%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtTree</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-1536"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtTreeOne</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"StmtTreeOne"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-1537"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtTreeBind</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"StmtTreeBind"</span><span class='hs-layout'>)</span>
<a name="line-1538"></a>                                            <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>y</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1539"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtTreeApplicative</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"StmtTreeApplicative"</span><span class='hs-layout'>)</span>
<a name="line-1540"></a>                                            <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1541"></a>
<a name="line-1542"></a><a name="flattenStmtTree"></a><span class='hs-definition'>flattenStmtTree</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StmtTree</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-1543"></a><span class='hs-definition'>flattenStmtTree</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>t</span> <span class='hs-conid'>[]</span>
<a name="line-1544"></a> <span class='hs-keyword'>where</span>
<a name="line-1545"></a>  <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtTreeOne</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>as</span>
<a name="line-1546"></a>  <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtTreeBind</span> <span class='hs-varid'>l</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span>
<a name="line-1547"></a>  <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtTreeApplicative</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>go</span> <span class='hs-keyword'>as</span> <span class='hs-varid'>ts</span>
<a name="line-1548"></a>
<a name="line-1549"></a><a name="ExprStmtTree"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ExprStmtTree</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StmtTree</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExprLStmt</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-1550"></a><a name="Cost"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Cost</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Int</span>
<a name="line-1551"></a>
<a name="line-1552"></a><a name="mkStmtTreeHeuristic"></a><span class='hs-comment'>-- | Turn a sequence of statements into an ExprStmtTree using a</span>
<a name="line-1553"></a><span class='hs-comment'>-- heuristic algorithm.  /O(n^2)/</span>
<a name="line-1554"></a><span class='hs-definition'>mkStmtTreeHeuristic</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>ExprLStmt</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprStmtTree</span>
<a name="line-1555"></a><span class='hs-definition'>mkStmtTreeHeuristic</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>one</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StmtTreeOne</span> <span class='hs-varid'>one</span>
<a name="line-1556"></a><span class='hs-definition'>mkStmtTreeHeuristic</span> <span class='hs-varid'>stmts</span> <span class='hs-keyglyph'>=</span>
<a name="line-1557"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>segments</span> <span class='hs-varid'>stmts</span> <span class='hs-keyword'>of</span>
<a name="line-1558"></a>    <span class='hs-keyglyph'>[</span><span class='hs-varid'>one</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>split</span> <span class='hs-varid'>one</span>
<a name="line-1559"></a>    <span class='hs-varid'>segs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StmtTreeApplicative</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>split</span> <span class='hs-varid'>segs</span><span class='hs-layout'>)</span>
<a name="line-1560"></a> <span class='hs-keyword'>where</span>
<a name="line-1561"></a>  <span class='hs-varid'>split</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>one</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StmtTreeOne</span> <span class='hs-varid'>one</span>
<a name="line-1562"></a>  <span class='hs-varid'>split</span> <span class='hs-varid'>stmts</span> <span class='hs-keyglyph'>=</span>
<a name="line-1563"></a>    <span class='hs-conid'>StmtTreeBind</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkStmtTreeHeuristic</span> <span class='hs-varid'>before</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkStmtTreeHeuristic</span> <span class='hs-varid'>after</span><span class='hs-layout'>)</span>
<a name="line-1564"></a>    <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>before</span><span class='hs-layout'>,</span> <span class='hs-varid'>after</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitSegment</span> <span class='hs-varid'>stmts</span>
<a name="line-1565"></a>
<a name="line-1566"></a><a name="mkStmtTreeOptimal"></a><span class='hs-comment'>-- | Turn a sequence of statements into an ExprStmtTree optimally,</span>
<a name="line-1567"></a><span class='hs-comment'>-- using dynamic programming.  /O(n^3)/</span>
<a name="line-1568"></a><span class='hs-definition'>mkStmtTreeOptimal</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>ExprLStmt</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprStmtTree</span>
<a name="line-1569"></a><span class='hs-definition'>mkStmtTreeOptimal</span> <span class='hs-varid'>stmts</span> <span class='hs-keyglyph'>=</span>
<a name="line-1570"></a>  <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- the empty case is handled by the caller;</span>
<a name="line-1571"></a>                           <span class='hs-comment'>-- we don't support empty StmtTrees.</span>
<a name="line-1572"></a>  <span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>arr</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1573"></a>  <span class='hs-keyword'>where</span>
<a name="line-1574"></a>    <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>stmts</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span>
<a name="line-1575"></a>    <span class='hs-varid'>stmt_arr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>listArray</span> <span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>stmts</span>
<a name="line-1576"></a>
<a name="line-1577"></a>    <span class='hs-comment'>-- lazy cache of optimal trees for subsequences of the input</span>
<a name="line-1578"></a>    <span class='hs-varid'>arr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Array</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExprStmtTree</span><span class='hs-layout'>,</span> <span class='hs-conid'>Cost</span><span class='hs-layout'>)</span>
<a name="line-1579"></a>    <span class='hs-varid'>arr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>array</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>,</span><span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1580"></a>             <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>lo</span><span class='hs-layout'>,</span><span class='hs-varid'>hi</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>tree</span> <span class='hs-varid'>lo</span> <span class='hs-varid'>hi</span><span class='hs-layout'>)</span>
<a name="line-1581"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>lo</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>n</span><span class='hs-keyglyph'>]</span>
<a name="line-1582"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>hi</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>lo</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>n</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-1583"></a>
<a name="line-1584"></a>    <span class='hs-comment'>-- compute the optimal tree for the sequence [lo..hi]</span>
<a name="line-1585"></a>    <span class='hs-varid'>tree</span> <span class='hs-varid'>lo</span> <span class='hs-varid'>hi</span>
<a name="line-1586"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>hi</span> <span class='hs-varop'>==</span> <span class='hs-varid'>lo</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtTreeOne</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmt_arr</span> <span class='hs-varop'>!</span> <span class='hs-varid'>lo</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-1587"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span>
<a name="line-1588"></a>         <span class='hs-keyword'>case</span> <span class='hs-varid'>segments</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>stmt_arr</span> <span class='hs-varop'>!</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>lo</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>hi</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span> <span class='hs-keyword'>of</span>
<a name="line-1589"></a>           <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"mkStmtTree"</span>
<a name="line-1590"></a>           <span class='hs-keyglyph'>[</span><span class='hs-sel'>_one</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>split</span> <span class='hs-varid'>lo</span> <span class='hs-varid'>hi</span>
<a name="line-1591"></a>           <span class='hs-varid'>segs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtTreeApplicative</span> <span class='hs-varid'>trees</span><span class='hs-layout'>,</span> <span class='hs-varid'>maximum</span> <span class='hs-varid'>costs</span><span class='hs-layout'>)</span>
<a name="line-1592"></a>             <span class='hs-keyword'>where</span>
<a name="line-1593"></a>               <span class='hs-varid'>bounds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>scanl</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>hi</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>hi</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>,</span> <span class='hs-varid'>hi</span> <span class='hs-varop'>+</span> <span class='hs-varid'>length</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>,</span><span class='hs-varid'>lo</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>segs</span>
<a name="line-1594"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>trees</span><span class='hs-layout'>,</span><span class='hs-varid'>costs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-varid'>split</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tail</span> <span class='hs-varid'>bounds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1595"></a>
<a name="line-1596"></a>    <span class='hs-comment'>-- find the best place to split the segment [lo..hi]</span>
<a name="line-1597"></a>    <span class='hs-varid'>split</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExprStmtTree</span><span class='hs-layout'>,</span> <span class='hs-conid'>Cost</span><span class='hs-layout'>)</span>
<a name="line-1598"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>lo</span> <span class='hs-varid'>hi</span>
<a name="line-1599"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>hi</span> <span class='hs-varop'>==</span> <span class='hs-varid'>lo</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtTreeOne</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmt_arr</span> <span class='hs-varop'>!</span> <span class='hs-varid'>lo</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-1600"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtTreeBind</span> <span class='hs-varid'>before</span> <span class='hs-varid'>after</span><span class='hs-layout'>,</span> <span class='hs-varid'>c1</span><span class='hs-varop'>+</span><span class='hs-varid'>c2</span><span class='hs-layout'>)</span>
<a name="line-1601"></a>        <span class='hs-keyword'>where</span>
<a name="line-1602"></a>         <span class='hs-comment'>-- As per the paper, for a sequence s1...sn, we want to find</span>
<a name="line-1603"></a>         <span class='hs-comment'>-- the split with the minimum cost, where the cost is the</span>
<a name="line-1604"></a>         <span class='hs-comment'>-- sum of the cost of the left and right subsequences.</span>
<a name="line-1605"></a>         <span class='hs-comment'>--</span>
<a name="line-1606"></a>         <span class='hs-comment'>-- As an optimisation (also in the paper) if the cost of</span>
<a name="line-1607"></a>         <span class='hs-comment'>-- s1..s(n-1) is different from the cost of s2..sn, we know</span>
<a name="line-1608"></a>         <span class='hs-comment'>-- that the optimal solution is the lower of the two.  Only</span>
<a name="line-1609"></a>         <span class='hs-comment'>-- in the case that these two have the same cost do we need</span>
<a name="line-1610"></a>         <span class='hs-comment'>-- to do the exhaustive search.</span>
<a name="line-1611"></a>         <span class='hs-comment'>--</span>
<a name="line-1612"></a>         <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>before</span><span class='hs-layout'>,</span><span class='hs-varid'>c1</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>after</span><span class='hs-layout'>,</span><span class='hs-varid'>c2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1613"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>hi</span> <span class='hs-comment'>-</span> <span class='hs-varid'>lo</span> <span class='hs-varop'>==</span> <span class='hs-num'>1</span>
<a name="line-1614"></a>           <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>StmtTreeOne</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmt_arr</span> <span class='hs-varop'>!</span> <span class='hs-varid'>lo</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-1615"></a>              <span class='hs-layout'>(</span><span class='hs-conid'>StmtTreeOne</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmt_arr</span> <span class='hs-varop'>!</span> <span class='hs-varid'>hi</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1616"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>left_cost</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>right_cost</span>
<a name="line-1617"></a>           <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>left</span><span class='hs-layout'>,</span><span class='hs-varid'>left_cost</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtTreeOne</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmt_arr</span> <span class='hs-varop'>!</span> <span class='hs-varid'>hi</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1618"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>left_cost</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>right_cost</span>
<a name="line-1619"></a>           <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>StmtTreeOne</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmt_arr</span> <span class='hs-varop'>!</span> <span class='hs-varid'>lo</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>right</span><span class='hs-layout'>,</span><span class='hs-varid'>right_cost</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1620"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>minimumBy</span> <span class='hs-layout'>(</span><span class='hs-varid'>comparing</span> <span class='hs-varid'>cost</span><span class='hs-layout'>)</span> <span class='hs-varid'>alternatives</span>
<a name="line-1621"></a>           <span class='hs-keyword'>where</span>
<a name="line-1622"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>left</span><span class='hs-layout'>,</span> <span class='hs-varid'>left_cost</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arr</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>lo</span><span class='hs-layout'>,</span><span class='hs-varid'>hi</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-1623"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>right</span><span class='hs-layout'>,</span> <span class='hs-varid'>right_cost</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arr</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>lo</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-varid'>hi</span><span class='hs-layout'>)</span>
<a name="line-1624"></a>             <span class='hs-varid'>cost</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>c1</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>c2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>c2</span>
<a name="line-1625"></a>             <span class='hs-varid'>alternatives</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>arr</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>lo</span><span class='hs-layout'>,</span><span class='hs-varid'>k</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>arr</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-varid'>hi</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1626"></a>                            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>lo</span> <span class='hs-keyglyph'>..</span> <span class='hs-varid'>hi</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-1627"></a>
<a name="line-1628"></a>
<a name="line-1629"></a><a name="stmtTreeToStmts"></a><span class='hs-comment'>-- | Turn the ExprStmtTree back into a sequence of statements, using</span>
<a name="line-1630"></a><span class='hs-comment'>-- ApplicativeStmt where necessary.</span>
<a name="line-1631"></a><span class='hs-definition'>stmtTreeToStmts</span>
<a name="line-1632"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadNames</span>
<a name="line-1633"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-1634"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprStmtTree</span>
<a name="line-1635"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ExprLStmt</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>             <span class='hs-comment'>-- ^ the "tail"</span>
<a name="line-1636"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVars</span>                     <span class='hs-comment'>-- ^ free variables of the tail</span>
<a name="line-1637"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ExprLStmt</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>       <span class='hs-comment'>-- ( output statements,</span>
<a name="line-1638"></a>         <span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span> <span class='hs-layout'>)</span>             <span class='hs-comment'>-- , things we needed</span>
<a name="line-1639"></a>
<a name="line-1640"></a><span class='hs-comment'>-- If we have a single bind, and we can do it without a join, transform</span>
<a name="line-1641"></a><span class='hs-comment'>-- to an ApplicativeStmt.  This corresponds to the rule</span>
<a name="line-1642"></a><span class='hs-comment'>--   dsBlock [pat &lt;- rhs] (return expr) = expr &lt;$&gt; rhs</span>
<a name="line-1643"></a><span class='hs-comment'>-- In the spec, but we do it here rather than in the desugarer,</span>
<a name="line-1644"></a><span class='hs-comment'>-- because we need the typechecker to typecheck the &lt;$&gt; form rather than</span>
<a name="line-1645"></a><span class='hs-comment'>-- the bind form, which would give rise to a Monad constraint.</span>
<a name="line-1646"></a><span class='hs-definition'>stmtTreeToStmts</span> <span class='hs-varid'>monad_names</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtTreeOne</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>rhs</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1647"></a>                <span class='hs-varid'>tail</span> <span class='hs-sel'>_tail_fvs</span>
<a name="line-1648"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isStrictPattern</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span><span class='hs-varid'>tail'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>needJoin</span> <span class='hs-varid'>monad_names</span> <span class='hs-varid'>tail</span>
<a name="line-1649"></a>  <span class='hs-comment'>-- See Note [ApplicativeDo and strict patterns]</span>
<a name="line-1650"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkApplicativeStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ApplicativeArgOne</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>rhs</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>False</span> <span class='hs-varid'>tail'</span>
<a name="line-1651"></a>
<a name="line-1652"></a><span class='hs-definition'>stmtTreeToStmts</span> <span class='hs-sel'>_monad_names</span> <span class='hs-sel'>_ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtTreeOne</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>tail</span> <span class='hs-sel'>_tail_fvs</span> <span class='hs-keyglyph'>=</span>
<a name="line-1653"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tail</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyNameSet</span><span class='hs-layout'>)</span>
<a name="line-1654"></a>
<a name="line-1655"></a><span class='hs-definition'>stmtTreeToStmts</span> <span class='hs-varid'>monad_names</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtTreeBind</span> <span class='hs-varid'>before</span> <span class='hs-varid'>after</span><span class='hs-layout'>)</span> <span class='hs-varid'>tail</span> <span class='hs-varid'>tail_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1656"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>stmts1</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stmtTreeToStmts</span> <span class='hs-varid'>monad_names</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>after</span> <span class='hs-varid'>tail</span> <span class='hs-varid'>tail_fvs</span>
<a name="line-1657"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>tail1_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionNameSets</span> <span class='hs-layout'>(</span><span class='hs-varid'>tail_fvs</span> <span class='hs-conop'>:</span> <span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-layout'>(</span><span class='hs-varid'>flattenStmtTree</span> <span class='hs-varid'>after</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1658"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>stmts2</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stmtTreeToStmts</span> <span class='hs-varid'>monad_names</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>before</span> <span class='hs-varid'>stmts1</span> <span class='hs-varid'>tail1_fvs</span>
<a name="line-1659"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmts2</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span>
<a name="line-1660"></a>
<a name="line-1661"></a><span class='hs-definition'>stmtTreeToStmts</span> <span class='hs-varid'>monad_names</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtTreeApplicative</span> <span class='hs-varid'>trees</span><span class='hs-layout'>)</span> <span class='hs-varid'>tail</span> <span class='hs-varid'>tail_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1662"></a>   <span class='hs-varid'>pairs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmtTreeArg</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>tail_fvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>trees</span>
<a name="line-1663"></a>   <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>pairs</span>
<a name="line-1664"></a>   <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>need_join</span><span class='hs-layout'>,</span> <span class='hs-varid'>tail'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>needJoin</span> <span class='hs-varid'>monad_names</span> <span class='hs-varid'>tail</span>
<a name="line-1665"></a>   <span class='hs-layout'>(</span><span class='hs-varid'>stmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkApplicativeStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmts'</span> <span class='hs-varid'>need_join</span> <span class='hs-varid'>tail'</span>
<a name="line-1666"></a>   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>unionNameSets</span> <span class='hs-layout'>(</span><span class='hs-varid'>fvs</span><span class='hs-conop'>:</span><span class='hs-varid'>fvss</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1667"></a> <span class='hs-keyword'>where</span>
<a name="line-1668"></a>   <span class='hs-varid'>stmtTreeArg</span> <span class='hs-sel'>_ctxt</span> <span class='hs-sel'>_tail_fvs</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtTreeOne</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>exp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1669"></a>     <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ApplicativeArgOne</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>exp</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-1670"></a>   <span class='hs-varid'>stmtTreeArg</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>tail_fvs</span> <span class='hs-varid'>tree</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1671"></a>     <span class='hs-keyword'>let</span> <span class='hs-varid'>stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flattenStmtTree</span> <span class='hs-varid'>tree</span>
<a name="line-1672"></a>         <span class='hs-varid'>pvarset</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectStmtBinders</span><span class='hs-varop'>.</span><span class='hs-varid'>unLoc</span><span class='hs-varop'>.</span><span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span>
<a name="line-1673"></a>                     <span class='hs-varop'>`intersectNameSet`</span> <span class='hs-varid'>tail_fvs</span>
<a name="line-1674"></a>         <span class='hs-varid'>pvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameSetElemsStable</span> <span class='hs-varid'>pvarset</span>
<a name="line-1675"></a>           <span class='hs-comment'>-- See Note [Deterministic ApplicativeDo and RecursiveDo desugaring]</span>
<a name="line-1676"></a>         <span class='hs-varid'>pat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkBigLHsVarPatTup</span> <span class='hs-varid'>pvars</span>
<a name="line-1677"></a>         <span class='hs-varid'>tup</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkBigLHsVarTup</span> <span class='hs-varid'>pvars</span>
<a name="line-1678"></a>     <span class='hs-layout'>(</span><span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stmtTreeToStmts</span> <span class='hs-varid'>monad_names</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>tree</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>pvarset</span>
<a name="line-1679"></a>     <span class='hs-layout'>(</span><span class='hs-varid'>mb_ret</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-1680"></a>        <span class='hs-keyword'>if</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>ApplicativeStmt</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>last</span> <span class='hs-varid'>stmts'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1681"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>tup</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyNameSet</span><span class='hs-layout'>)</span>
<a name="line-1682"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1683"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>ret</span><span class='hs-layout'>,</span><span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtNamePoly</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>returnMName</span>
<a name="line-1684"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-varid'>ret</span><span class='hs-layout'>)</span> <span class='hs-varid'>tup</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>
<a name="line-1685"></a>     <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-conid'>ApplicativeArgMany</span> <span class='hs-varid'>stmts'</span> <span class='hs-varid'>mb_ret</span> <span class='hs-varid'>pat</span>
<a name="line-1686"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span>
<a name="line-1687"></a>
<a name="line-1688"></a>
<a name="line-1689"></a><a name="segments"></a><span class='hs-comment'>-- | Divide a sequence of statements into segments, where no segment</span>
<a name="line-1690"></a><span class='hs-comment'>-- depends on any variables defined by a statement in another segment.</span>
<a name="line-1691"></a><span class='hs-definition'>segments</span>
<a name="line-1692"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>ExprLStmt</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1693"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>ExprLStmt</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-1694"></a><span class='hs-definition'>segments</span> <span class='hs-varid'>stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>merge</span> <span class='hs-varop'>$</span> <span class='hs-varid'>reverse</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>reverse</span> <span class='hs-varop'>$</span> <span class='hs-varid'>walk</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span>
<a name="line-1695"></a>  <span class='hs-keyword'>where</span>
<a name="line-1696"></a>    <span class='hs-varid'>allvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectStmtBinders</span><span class='hs-varop'>.</span><span class='hs-varid'>unLoc</span><span class='hs-varop'>.</span><span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span>
<a name="line-1697"></a>
<a name="line-1698"></a>    <span class='hs-comment'>-- We would rather not have a segment that just has LetStmts in</span>
<a name="line-1699"></a>    <span class='hs-comment'>-- it, so combine those with an adjacent segment where possible.</span>
<a name="line-1700"></a>    <span class='hs-varid'>merge</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-1701"></a>    <span class='hs-varid'>merge</span> <span class='hs-layout'>(</span><span class='hs-varid'>seg</span> <span class='hs-conop'>:</span> <span class='hs-varid'>segs</span><span class='hs-layout'>)</span>
<a name="line-1702"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>rest</span> <span class='hs-keyword'>of</span>
<a name="line-1703"></a>          <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>seg</span><span class='hs-layout'>,</span><span class='hs-varid'>all_lets</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1704"></a>          <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span><span class='hs-varid'>s_lets</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>all_lets</span> <span class='hs-varop'>||</span> <span class='hs-varid'>s_lets</span>
<a name="line-1705"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>seg</span> <span class='hs-varop'>++</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>all_lets</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>s_lets</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ss</span>
<a name="line-1706"></a>          <span class='hs-sel'>_otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>seg</span><span class='hs-layout'>,</span><span class='hs-varid'>all_lets</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rest</span>
<a name="line-1707"></a>      <span class='hs-keyword'>where</span>
<a name="line-1708"></a>        <span class='hs-varid'>rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>merge</span> <span class='hs-varid'>segs</span>
<a name="line-1709"></a>        <span class='hs-varid'>all_lets</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varid'>isLetStmt</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varid'>seg</span>
<a name="line-1710"></a>
<a name="line-1711"></a>    <span class='hs-comment'>-- walk splits the statement sequence into segments, traversing</span>
<a name="line-1712"></a>    <span class='hs-comment'>-- the sequence from the back to the front, and keeping track of</span>
<a name="line-1713"></a>    <span class='hs-comment'>-- the set of free variables of the current segment.  Whenever</span>
<a name="line-1714"></a>    <span class='hs-comment'>-- this set of free variables is empty, we have a complete segment.</span>
<a name="line-1715"></a>    <span class='hs-varid'>walk</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>ExprLStmt</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>ExprLStmt</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-1716"></a>    <span class='hs-varid'>walk</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-1717"></a>    <span class='hs-varid'>walk</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>stmt</span><span class='hs-layout'>,</span><span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>stmt</span><span class='hs-layout'>,</span><span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>seg</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>walk</span> <span class='hs-varid'>rest</span>
<a name="line-1718"></a>      <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>seg</span><span class='hs-layout'>,</span><span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>chunter</span> <span class='hs-varid'>fvs'</span> <span class='hs-varid'>stmts</span>
<a name="line-1719"></a>            <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmtRefs</span> <span class='hs-varid'>stmt</span> <span class='hs-varid'>fvs</span>
<a name="line-1720"></a>
<a name="line-1721"></a>    <span class='hs-varid'>chunter</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-1722"></a>    <span class='hs-varid'>chunter</span> <span class='hs-varid'>vars</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>stmt</span><span class='hs-layout'>,</span><span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span>
<a name="line-1723"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyNameSet</span> <span class='hs-varid'>vars</span><span class='hs-layout'>)</span>
<a name="line-1724"></a>       <span class='hs-varop'>||</span> <span class='hs-varid'>isStrictPatternBind</span> <span class='hs-varid'>stmt</span>
<a name="line-1725"></a>           <span class='hs-comment'>-- See Note [ApplicativeDo and strict patterns]</span>
<a name="line-1726"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>stmt</span><span class='hs-layout'>,</span><span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>chunk</span><span class='hs-layout'>,</span> <span class='hs-varid'>rest'</span><span class='hs-layout'>)</span>
<a name="line-1727"></a>       <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>chunk</span><span class='hs-layout'>,</span><span class='hs-varid'>rest'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>chunter</span> <span class='hs-varid'>vars'</span> <span class='hs-varid'>rest</span>
<a name="line-1728"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>pvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>evars</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmtRefs</span> <span class='hs-varid'>stmt</span> <span class='hs-varid'>fvs</span>
<a name="line-1729"></a>             <span class='hs-varid'>vars'</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>vars</span> <span class='hs-varop'>`minusNameSet`</span> <span class='hs-varid'>pvars</span><span class='hs-layout'>)</span> <span class='hs-varop'>`unionNameSet`</span> <span class='hs-varid'>evars</span>
<a name="line-1730"></a>    <span class='hs-varid'>chunter</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span>
<a name="line-1731"></a>
<a name="line-1732"></a>    <span class='hs-varid'>stmtRefs</span> <span class='hs-varid'>stmt</span> <span class='hs-varid'>fvs</span>
<a name="line-1733"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isLetStmt</span> <span class='hs-varid'>stmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>pvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs'</span> <span class='hs-varop'>`minusNameSet`</span> <span class='hs-varid'>pvars</span><span class='hs-layout'>)</span>
<a name="line-1734"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>pvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs'</span><span class='hs-layout'>)</span>
<a name="line-1735"></a>      <span class='hs-keyword'>where</span> <span class='hs-varid'>fvs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvs</span> <span class='hs-varop'>`intersectNameSet`</span> <span class='hs-varid'>allvars</span>
<a name="line-1736"></a>            <span class='hs-varid'>pvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectStmtBinders</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1737"></a>
<a name="line-1738"></a>    <span class='hs-varid'>isStrictPatternBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExprLStmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1739"></a>    <span class='hs-varid'>isStrictPatternBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isStrictPattern</span> <span class='hs-varid'>pat</span>
<a name="line-1740"></a>    <span class='hs-varid'>isStrictPatternBind</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1741"></a>
<a name="line-1742"></a><span class='hs-comment'>{-
<a name="line-1743"></a>Note [ApplicativeDo and strict patterns]
<a name="line-1744"></a>
<a name="line-1745"></a>A strict pattern match is really a dependency.  For example,
<a name="line-1746"></a>
<a name="line-1747"></a>do
<a name="line-1748"></a>  (x,y) &lt;- A
<a name="line-1749"></a>  z &lt;- B
<a name="line-1750"></a>  return C
<a name="line-1751"></a>
<a name="line-1752"></a>The pattern (_,_) must be matched strictly before we do B.  If we
<a name="line-1753"></a>allowed this to be transformed into
<a name="line-1754"></a>
<a name="line-1755"></a>  (\(x,y) -&gt; \z -&gt; C) &lt;$&gt; A &lt;*&gt; B
<a name="line-1756"></a>
<a name="line-1757"></a>then it could be lazier than the standard desuraging using &gt;&gt;=.  See #13875
<a name="line-1758"></a>for more examples.
<a name="line-1759"></a>
<a name="line-1760"></a>Thus, whenever we have a strict pattern match, we treat it as a
<a name="line-1761"></a>dependency between that statement and the following one.  The
<a name="line-1762"></a>dependency prevents those two statements from being performed "in
<a name="line-1763"></a>parallel" in an ApplicativeStmt, but doesn't otherwise affect what we
<a name="line-1764"></a>can do with the rest of the statements in the same "do" expression.
<a name="line-1765"></a>-}</span>
<a name="line-1766"></a>
<a name="line-1767"></a><a name="isStrictPattern"></a><span class='hs-definition'>isStrictPattern</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LPat</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1768"></a><span class='hs-definition'>isStrictPattern</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1769"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>pat</span> <span class='hs-keyword'>of</span>
<a name="line-1770"></a>    <span class='hs-conid'>WildPat</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1771"></a>    <span class='hs-conid'>VarPat</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1772"></a>    <span class='hs-conid'>LazyPat</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1773"></a>    <span class='hs-conid'>AsPat</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isStrictPattern</span> <span class='hs-varid'>p</span>
<a name="line-1774"></a>    <span class='hs-conid'>ParPat</span> <span class='hs-varid'>p</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isStrictPattern</span> <span class='hs-varid'>p</span>
<a name="line-1775"></a>    <span class='hs-conid'>ViewPat</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>p</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isStrictPattern</span> <span class='hs-varid'>p</span>
<a name="line-1776"></a>    <span class='hs-conid'>SigPatIn</span> <span class='hs-varid'>p</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isStrictPattern</span> <span class='hs-varid'>p</span>
<a name="line-1777"></a>    <span class='hs-conid'>SigPatOut</span> <span class='hs-varid'>p</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isStrictPattern</span> <span class='hs-varid'>p</span>
<a name="line-1778"></a>    <span class='hs-conid'>BangPat</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1779"></a>    <span class='hs-conid'>ListPat</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1780"></a>    <span class='hs-conid'>TuplePat</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1781"></a>    <span class='hs-conid'>SumPat</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1782"></a>    <span class='hs-conid'>PArrPat</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1783"></a>    <span class='hs-conid'>ConPatIn</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1784"></a>    <span class='hs-conid'>ConPatOut</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1785"></a>    <span class='hs-conid'>LitPat</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1786"></a>    <span class='hs-conid'>NPat</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1787"></a>    <span class='hs-conid'>NPlusKPat</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1788"></a>    <span class='hs-conid'>SplicePat</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1789"></a>    <span class='hs-sel'>_otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"isStrictPattern"</span>
<a name="line-1790"></a>
<a name="line-1791"></a><a name="isLetStmt"></a><span class='hs-definition'>isLetStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LStmt</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1792"></a><span class='hs-definition'>isLetStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>LetStmt</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1793"></a><span class='hs-definition'>isLetStmt</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1794"></a>
<a name="line-1795"></a><a name="splitSegment"></a><span class='hs-comment'>-- | Find a "good" place to insert a bind in an indivisible segment.</span>
<a name="line-1796"></a><span class='hs-comment'>-- This is the only place where we use heuristics.  The current</span>
<a name="line-1797"></a><span class='hs-comment'>-- heuristic is to peel off the first group of independent statements</span>
<a name="line-1798"></a><span class='hs-comment'>-- and put the bind after those.</span>
<a name="line-1799"></a><span class='hs-definition'>splitSegment</span>
<a name="line-1800"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>ExprLStmt</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1801"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>ExprLStmt</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1802"></a>     <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>ExprLStmt</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>)</span>
<a name="line-1803"></a><span class='hs-definition'>splitSegment</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>one</span><span class='hs-layout'>,</span><span class='hs-varid'>two</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>one</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>two</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1804"></a>  <span class='hs-comment'>-- there is no choice when there are only two statements; this just saves</span>
<a name="line-1805"></a>  <span class='hs-comment'>-- some work in a common case.</span>
<a name="line-1806"></a><span class='hs-definition'>splitSegment</span> <span class='hs-varid'>stmts</span>
<a name="line-1807"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>lets</span><span class='hs-layout'>,</span><span class='hs-varid'>binds</span><span class='hs-layout'>,</span><span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>slurpIndependentStmts</span> <span class='hs-varid'>stmts</span>
<a name="line-1808"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>lets</span><span class='hs-layout'>)</span>
<a name="line-1809"></a>       <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-varid'>lets</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds</span><span class='hs-varop'>++</span><span class='hs-varid'>rest</span><span class='hs-layout'>)</span>
<a name="line-1810"></a>       <span class='hs-keyword'>else</span> <span class='hs-layout'>(</span><span class='hs-varid'>lets</span><span class='hs-varop'>++</span><span class='hs-varid'>binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span>
<a name="line-1811"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1812"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stmts</span> <span class='hs-keyword'>of</span>
<a name="line-1813"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span>
<a name="line-1814"></a>      <span class='hs-sel'>_other</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmts</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-1815"></a>
<a name="line-1816"></a><a name="slurpIndependentStmts"></a><span class='hs-definition'>slurpIndependentStmts</span>
<a name="line-1817"></a>   <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1818"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- LetStmts</span>
<a name="line-1819"></a>            <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- BindStmts</span>
<a name="line-1820"></a>            <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>)</span>
<a name="line-1821"></a><span class='hs-definition'>slurpIndependentStmts</span> <span class='hs-varid'>stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>emptyNameSet</span> <span class='hs-varid'>stmts</span>
<a name="line-1822"></a> <span class='hs-keyword'>where</span>
<a name="line-1823"></a>  <span class='hs-comment'>-- If we encounter a BindStmt that doesn't depend on a previous BindStmt</span>
<a name="line-1824"></a>  <span class='hs-comment'>-- in this group, then add it to the group. We have to be careful about</span>
<a name="line-1825"></a>  <span class='hs-comment'>-- strict patterns though; splitSegments expects that if we return Just</span>
<a name="line-1826"></a>  <span class='hs-comment'>-- then we have actually done some splitting. Otherwise it will go into</span>
<a name="line-1827"></a>  <span class='hs-comment'>-- an infinite loop (#14163).</span>
<a name="line-1828"></a>  <span class='hs-varid'>go</span> <span class='hs-varid'>lets</span> <span class='hs-varid'>indep</span> <span class='hs-varid'>bndrs</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>body</span> <span class='hs-varid'>bind_op</span> <span class='hs-varid'>fail_op</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span>
<a name="line-1829"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span> <span class='hs-varop'>`intersectNameSet`</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isStrictPattern</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span>
<a name="line-1830"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>lets</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>body</span> <span class='hs-varid'>bind_op</span> <span class='hs-varid'>fail_op</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>indep</span><span class='hs-layout'>)</span>
<a name="line-1831"></a>         <span class='hs-varid'>bndrs'</span> <span class='hs-varid'>rest</span>
<a name="line-1832"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>bndrs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs</span> <span class='hs-varop'>`unionNameSet`</span> <span class='hs-varid'>mkNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectPatBinders</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span>
<a name="line-1833"></a>  <span class='hs-comment'>-- If we encounter a LetStmt that doesn't depend on a BindStmt in this</span>
<a name="line-1834"></a>  <span class='hs-comment'>-- group, then move it to the beginning, so that it doesn't interfere with</span>
<a name="line-1835"></a>  <span class='hs-comment'>-- grouping more BindStmts.</span>
<a name="line-1836"></a>  <span class='hs-comment'>-- TODO: perhaps we shouldn't do this if there are any strict bindings,</span>
<a name="line-1837"></a>  <span class='hs-comment'>-- because we might be moving evaluation earlier.</span>
<a name="line-1838"></a>  <span class='hs-varid'>go</span> <span class='hs-varid'>lets</span> <span class='hs-varid'>indep</span> <span class='hs-varid'>bndrs</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span>
<a name="line-1839"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span> <span class='hs-varop'>`intersectNameSet`</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>
<a name="line-1840"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>lets</span><span class='hs-layout'>)</span> <span class='hs-varid'>indep</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>rest</span>
<a name="line-1841"></a>  <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span>  <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1842"></a>  <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>[</span><span class='hs-keyword'>_</span><span class='hs-keyglyph'>]</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1843"></a>  <span class='hs-varid'>go</span> <span class='hs-varid'>lets</span> <span class='hs-varid'>indep</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>lets</span><span class='hs-layout'>,</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>indep</span><span class='hs-layout'>,</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span>
<a name="line-1844"></a>
<a name="line-1845"></a><a name="mkApplicativeStmt"></a><span class='hs-comment'>-- | Build an ApplicativeStmt, and strip the "return" from the tail</span>
<a name="line-1846"></a><span class='hs-comment'>-- if necessary.</span>
<a name="line-1847"></a><span class='hs-comment'>--</span>
<a name="line-1848"></a><span class='hs-comment'>-- For example, if we start with</span>
<a name="line-1849"></a><span class='hs-comment'>--   do x &lt;- E1; y &lt;- E2; return (f x y)</span>
<a name="line-1850"></a><span class='hs-comment'>-- then we get</span>
<a name="line-1851"></a><span class='hs-comment'>--   do (E1[x] | E2[y]); f x y</span>
<a name="line-1852"></a><span class='hs-comment'>--</span>
<a name="line-1853"></a><span class='hs-comment'>-- the LastStmt in this case has the return removed, but we set the</span>
<a name="line-1854"></a><span class='hs-comment'>-- flag on the LastStmt to indicate this, so that we can print out the</span>
<a name="line-1855"></a><span class='hs-comment'>-- original statement correctly in error messages.  It is easier to do</span>
<a name="line-1856"></a><span class='hs-comment'>-- it this way rather than try to ignore the return later in both the</span>
<a name="line-1857"></a><span class='hs-comment'>-- typechecker and the desugarer (I tried it that way first!).</span>
<a name="line-1858"></a><span class='hs-definition'>mkApplicativeStmt</span>
<a name="line-1859"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-1860"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ApplicativeArg</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>         <span class='hs-comment'>-- ^ The args</span>
<a name="line-1861"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>                               <span class='hs-comment'>-- ^ True &lt;=&gt; need a join</span>
<a name="line-1862"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ExprLStmt</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- ^ The body statements</span>
<a name="line-1863"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>ExprLStmt</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-1864"></a><span class='hs-definition'>mkApplicativeStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>args</span> <span class='hs-varid'>need_join</span> <span class='hs-varid'>body_stmts</span>
<a name="line-1865"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>fmapName</span>
<a name="line-1866"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ap_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>apAName</span>
<a name="line-1867"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>mb_join</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs3</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-1868"></a>           <span class='hs-keyword'>if</span> <span class='hs-varid'>need_join</span> <span class='hs-keyword'>then</span>
<a name="line-1869"></a>             <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>join_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>joinMName</span>
<a name="line-1870"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>join_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1871"></a>           <span class='hs-keyword'>else</span>
<a name="line-1872"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyNameSet</span><span class='hs-layout'>)</span>
<a name="line-1873"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>applicative_stmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noLoc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ApplicativeStmt</span>
<a name="line-1874"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap_op</span> <span class='hs-conop'>:</span> <span class='hs-varid'>repeat</span> <span class='hs-varid'>ap_op</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-1875"></a>               <span class='hs-varid'>mb_join</span>
<a name="line-1876"></a>               <span class='hs-varid'>placeHolderType</span>
<a name="line-1877"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>applicative_stmt</span> <span class='hs-conop'>:</span> <span class='hs-varid'>body_stmts</span>
<a name="line-1878"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs3</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1879"></a>
<a name="line-1880"></a><a name="needJoin"></a><span class='hs-comment'>-- | Given the statements following an ApplicativeStmt, determine whether</span>
<a name="line-1881"></a><span class='hs-comment'>-- we need a @join@ or not, and remove the @return@ if necessary.</span>
<a name="line-1882"></a><span class='hs-definition'>needJoin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadNames</span>
<a name="line-1883"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ExprLStmt</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>
<a name="line-1884"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ExprLStmt</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1885"></a><span class='hs-definition'>needJoin</span> <span class='hs-sel'>_monad_names</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- we're in an ApplicativeArg</span>
<a name="line-1886"></a><span class='hs-definition'>needJoin</span> <span class='hs-varid'>monad_names</span>  <span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1887"></a> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>arg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isReturnApp</span> <span class='hs-varid'>monad_names</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span>
<a name="line-1888"></a>       <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>arg</span> <span class='hs-conid'>True</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1889"></a><span class='hs-definition'>needJoin</span> <span class='hs-sel'>_monad_names</span> <span class='hs-varid'>stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span>
<a name="line-1890"></a>
<a name="line-1891"></a><a name="isReturnApp"></a><span class='hs-comment'>-- | @Just e@, if the expression is @return e@ or @return $ e@,</span>
<a name="line-1892"></a><span class='hs-comment'>-- otherwise @Nothing@</span>
<a name="line-1893"></a><span class='hs-definition'>isReturnApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadNames</span>
<a name="line-1894"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>GhcRn</span>
<a name="line-1895"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span>
<a name="line-1896"></a><span class='hs-definition'>isReturnApp</span> <span class='hs-varid'>monad_names</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isReturnApp</span> <span class='hs-varid'>monad_names</span> <span class='hs-varid'>expr</span>
<a name="line-1897"></a><span class='hs-definition'>isReturnApp</span> <span class='hs-varid'>monad_names</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>of</span>
<a name="line-1898"></a>  <span class='hs-conid'>OpApp</span> <span class='hs-varid'>l</span> <span class='hs-varid'>op</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_return</span> <span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_dollar</span> <span class='hs-varid'>op</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>r</span>
<a name="line-1899"></a>  <span class='hs-conid'>HsApp</span> <span class='hs-varid'>f</span> <span class='hs-varid'>arg</span>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_return</span> <span class='hs-varid'>f</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>arg</span>
<a name="line-1900"></a>  <span class='hs-sel'>_otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1901"></a> <span class='hs-keyword'>where</span>
<a name="line-1902"></a>  <span class='hs-varid'>is_var</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_var</span> <span class='hs-varid'>f</span> <span class='hs-varid'>e</span>
<a name="line-1903"></a>  <span class='hs-varid'>is_var</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsAppType</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_var</span> <span class='hs-varid'>f</span> <span class='hs-varid'>e</span>
<a name="line-1904"></a>  <span class='hs-varid'>is_var</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>r</span>
<a name="line-1905"></a>       <span class='hs-comment'>-- TODO: I don't know how to get this right for rebindable syntax</span>
<a name="line-1906"></a>  <span class='hs-varid'>is_var</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1907"></a>
<a name="line-1908"></a>  <span class='hs-varid'>is_return</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_var</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-varid'>return_name</span> <span class='hs-varid'>monad_names</span>
<a name="line-1909"></a>                         <span class='hs-varop'>||</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-varid'>pure_name</span> <span class='hs-varid'>monad_names</span><span class='hs-layout'>)</span>
<a name="line-1910"></a>  <span class='hs-varid'>is_dollar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_var</span> <span class='hs-layout'>(</span><span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>dollarIdKey</span><span class='hs-layout'>)</span>
<a name="line-1911"></a>
<a name="line-1912"></a><span class='hs-comment'>{-
<a name="line-1913"></a>************************************************************************
<a name="line-1914"></a>*                                                                      *
<a name="line-1915"></a>\subsubsection{Errors}
<a name="line-1916"></a>*                                                                      *
<a name="line-1917"></a>************************************************************************
<a name="line-1918"></a>-}</span>
<a name="line-1919"></a>
<a name="line-1920"></a><a name="checkEmptyStmts"></a><span class='hs-definition'>checkEmptyStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-1921"></a><span class='hs-comment'>-- We've seen an empty sequence of Stmts... is that ok?</span>
<a name="line-1922"></a><span class='hs-definition'>checkEmptyStmts</span> <span class='hs-varid'>ctxt</span>
<a name="line-1923"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>okEmpty</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyErr</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1924"></a>
<a name="line-1925"></a><a name="okEmpty"></a><span class='hs-definition'>okEmpty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1926"></a><span class='hs-definition'>okEmpty</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatGuard</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1927"></a><span class='hs-definition'>okEmpty</span> <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1928"></a>
<a name="line-1929"></a><a name="emptyErr"></a><span class='hs-definition'>emptyErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1930"></a><span class='hs-definition'>emptyErr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmtCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Empty statement group in parallel comprehension"</span>
<a name="line-1931"></a><span class='hs-definition'>emptyErr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransStmtCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Empty statement group preceding 'group' or 'then'"</span>
<a name="line-1932"></a><span class='hs-definition'>emptyErr</span> <span class='hs-varid'>ctxt</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Empty"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprStmtContext</span> <span class='hs-varid'>ctxt</span>
<a name="line-1933"></a>
<a name="line-1934"></a><a name="checkLastStmt"></a><span class='hs-comment'>----------------------</span>
<a name="line-1935"></a><span class='hs-definition'>checkLastStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-1936"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1937"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1938"></a><span class='hs-definition'>checkLastStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>lstmt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span>
<a name="line-1939"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-1940"></a>      <span class='hs-conid'>ListComp</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>check_comp</span>
<a name="line-1941"></a>      <span class='hs-conid'>MonadComp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>check_comp</span>
<a name="line-1942"></a>      <span class='hs-conid'>PArrComp</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>check_comp</span>
<a name="line-1943"></a>      <span class='hs-conid'>ArrowExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>check_do</span>
<a name="line-1944"></a>      <span class='hs-conid'>DoExpr</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>check_do</span>
<a name="line-1945"></a>      <span class='hs-conid'>MDoExpr</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>check_do</span>
<a name="line-1946"></a>      <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>check_other</span>
<a name="line-1947"></a>  <span class='hs-keyword'>where</span>
<a name="line-1948"></a>    <span class='hs-varid'>check_do</span>    <span class='hs-comment'>-- Expect BodyStmt, and change it to LastStmt</span>
<a name="line-1949"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stmt</span> <span class='hs-keyword'>of</span>
<a name="line-1950"></a>          <span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLastStmt</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1951"></a>          <span class='hs-conid'>LastStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>lstmt</span>   <span class='hs-comment'>-- "Deriving" clauses may generate a</span>
<a name="line-1952"></a>                                             <span class='hs-comment'>-- LastStmt directly (unlike the parser)</span>
<a name="line-1953"></a>          <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-varid'>last_error</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>lstmt</span> <span class='hs-layout'>}</span>
<a name="line-1954"></a>    <span class='hs-varid'>last_error</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"The last statement in"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprAStmtContext</span> <span class='hs-varid'>ctxt</span>
<a name="line-1955"></a>                  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"must be an expression"</span><span class='hs-layout'>)</span>
<a name="line-1956"></a>
<a name="line-1957"></a>    <span class='hs-varid'>check_comp</span>  <span class='hs-comment'>-- Expect LastStmt; this should be enforced by the parser!</span>
<a name="line-1958"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stmt</span> <span class='hs-keyword'>of</span>
<a name="line-1959"></a>          <span class='hs-conid'>LastStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>lstmt</span>
<a name="line-1960"></a>          <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"checkLastStmt"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>lstmt</span><span class='hs-layout'>)</span>
<a name="line-1961"></a>
<a name="line-1962"></a>    <span class='hs-varid'>check_other</span> <span class='hs-comment'>-- Behave just as if this wasn't the last stmt</span>
<a name="line-1963"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>lstmt</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>lstmt</span> <span class='hs-layout'>}</span>
<a name="line-1964"></a>
<a name="line-1965"></a><a name="checkStmt"></a><span class='hs-comment'>-- Checking when a particular Stmt is ok</span>
<a name="line-1966"></a><span class='hs-definition'>checkStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-1967"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LStmt</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1968"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-1969"></a><span class='hs-definition'>checkStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span>
<a name="line-1970"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-1971"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>okStmt</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span> <span class='hs-keyword'>of</span>
<a name="line-1972"></a>           <span class='hs-conid'>IsValid</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1973"></a>           <span class='hs-conid'>NotValid</span> <span class='hs-varid'>extra</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>extra</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1974"></a>  <span class='hs-keyword'>where</span>
<a name="line-1975"></a>   <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Unexpected"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprStmtCat</span> <span class='hs-varid'>stmt</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"statement"</span><span class='hs-layout'>)</span>
<a name="line-1976"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"in"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprAStmtContext</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>]</span>
<a name="line-1977"></a>
<a name="line-1978"></a><a name="pprStmtCat"></a><span class='hs-definition'>pprStmtCat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Stmt</span> <span class='hs-varid'>a</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1979"></a><span class='hs-definition'>pprStmtCat</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"transform"</span>
<a name="line-1980"></a><span class='hs-definition'>pprStmtCat</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"return expression"</span>
<a name="line-1981"></a><span class='hs-definition'>pprStmtCat</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"body"</span>
<a name="line-1982"></a><span class='hs-definition'>pprStmtCat</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"binding"</span>
<a name="line-1983"></a><span class='hs-definition'>pprStmtCat</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"let"</span>
<a name="line-1984"></a><span class='hs-definition'>pprStmtCat</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"rec"</span>
<a name="line-1985"></a><span class='hs-definition'>pprStmtCat</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"parallel"</span>
<a name="line-1986"></a><span class='hs-definition'>pprStmtCat</span> <span class='hs-layout'>(</span><span class='hs-conid'>ApplicativeStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"pprStmtCat: ApplicativeStmt"</span>
<a name="line-1987"></a>
<a name="line-1988"></a><a name="emptyInvalid"></a><span class='hs-comment'>------------</span>
<a name="line-1989"></a><span class='hs-definition'>emptyInvalid</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Validity</span>  <span class='hs-comment'>-- Payload is the empty document</span>
<a name="line-1990"></a><span class='hs-definition'>emptyInvalid</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NotValid</span> <span class='hs-conid'>Outputable</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-1991"></a>
<a name="line-1992"></a><a name="okStmt"></a><span class='hs-definition'>okStmt</span><span class='hs-layout'>,</span> <span class='hs-varid'>okDoStmt</span><span class='hs-layout'>,</span> <span class='hs-varid'>okCompStmt</span><span class='hs-layout'>,</span> <span class='hs-varid'>okParStmt</span><span class='hs-layout'>,</span> <span class='hs-varid'>okPArrStmt</span>
<a name="line-1993"></a>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-1994"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Stmt</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Validity</span>
<a name="line-1995"></a><span class='hs-comment'>-- Return Nothing if OK, (Just extra) if not ok</span>
<a name="line-1996"></a><span class='hs-comment'>-- The "extra" is an SDoc that is appended to an generic error message</span>
<a name="line-1997"></a>
<a name="line-1998"></a><span class='hs-definition'>okStmt</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-1999"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-2000"></a>      <span class='hs-conid'>PatGuard</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>okPatGuardStmt</span> <span class='hs-varid'>stmt</span>
<a name="line-2001"></a>      <span class='hs-conid'>ParStmtCtxt</span> <span class='hs-varid'>ctxt</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>okParStmt</span>  <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-2002"></a>      <span class='hs-conid'>DoExpr</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>okDoStmt</span>   <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-2003"></a>      <span class='hs-conid'>MDoExpr</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>okDoStmt</span>   <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-2004"></a>      <span class='hs-conid'>ArrowExpr</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>okDoStmt</span>   <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-2005"></a>      <span class='hs-conid'>GhciStmtCtxt</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>okDoStmt</span>   <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-2006"></a>      <span class='hs-conid'>ListComp</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>okCompStmt</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-2007"></a>      <span class='hs-conid'>MonadComp</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>okCompStmt</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-2008"></a>      <span class='hs-conid'>PArrComp</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>okPArrStmt</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-2009"></a>      <span class='hs-conid'>TransStmtCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>okStmt</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-2010"></a>
<a name="line-2011"></a><a name="okPatGuardStmt"></a><span class='hs-comment'>-------------</span>
<a name="line-2012"></a><span class='hs-definition'>okPatGuardStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Stmt</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Validity</span>
<a name="line-2013"></a><span class='hs-definition'>okPatGuardStmt</span> <span class='hs-varid'>stmt</span>
<a name="line-2014"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stmt</span> <span class='hs-keyword'>of</span>
<a name="line-2015"></a>      <span class='hs-conid'>BodyStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsValid</span>
<a name="line-2016"></a>      <span class='hs-conid'>BindStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsValid</span>
<a name="line-2017"></a>      <span class='hs-conid'>LetStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsValid</span>
<a name="line-2018"></a>      <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>emptyInvalid</span>
<a name="line-2019"></a>
<a name="line-2020"></a><a name="okParStmt"></a><span class='hs-comment'>-------------</span>
<a name="line-2021"></a><span class='hs-definition'>okParStmt</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-2022"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stmt</span> <span class='hs-keyword'>of</span>
<a name="line-2023"></a>      <span class='hs-conid'>LetStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIPBinds</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>emptyInvalid</span>
<a name="line-2024"></a>      <span class='hs-keyword'>_</span>                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>okStmt</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-2025"></a>
<a name="line-2026"></a><a name="okDoStmt"></a><span class='hs-comment'>----------------</span>
<a name="line-2027"></a><span class='hs-definition'>okDoStmt</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-2028"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stmt</span> <span class='hs-keyword'>of</span>
<a name="line-2029"></a>       <span class='hs-conid'>RecStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>
<a name="line-2030"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>RecursiveDo</span> <span class='hs-varop'>`xopt`</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsValid</span>
<a name="line-2031"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ArrowExpr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsValid</span>    <span class='hs-comment'>-- Arrows allows 'rec'</span>
<a name="line-2032"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NotValid</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Use RecursiveDo"</span><span class='hs-layout'>)</span>
<a name="line-2033"></a>       <span class='hs-conid'>BindStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsValid</span>
<a name="line-2034"></a>       <span class='hs-conid'>LetStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsValid</span>
<a name="line-2035"></a>       <span class='hs-conid'>BodyStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsValid</span>
<a name="line-2036"></a>       <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>emptyInvalid</span>
<a name="line-2037"></a>
<a name="line-2038"></a><a name="okCompStmt"></a><span class='hs-comment'>----------------</span>
<a name="line-2039"></a><span class='hs-definition'>okCompStmt</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmt</span>
<a name="line-2040"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stmt</span> <span class='hs-keyword'>of</span>
<a name="line-2041"></a>       <span class='hs-conid'>BindStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsValid</span>
<a name="line-2042"></a>       <span class='hs-conid'>LetStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsValid</span>
<a name="line-2043"></a>       <span class='hs-conid'>BodyStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsValid</span>
<a name="line-2044"></a>       <span class='hs-conid'>ParStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>
<a name="line-2045"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>ParallelListComp</span> <span class='hs-varop'>`xopt`</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsValid</span>
<a name="line-2046"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NotValid</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Use ParallelListComp"</span><span class='hs-layout'>)</span>
<a name="line-2047"></a>       <span class='hs-conid'>TransStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>
<a name="line-2048"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>TransformListComp</span> <span class='hs-varop'>`xopt`</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsValid</span>
<a name="line-2049"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NotValid</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Use TransformListComp"</span><span class='hs-layout'>)</span>
<a name="line-2050"></a>       <span class='hs-conid'>RecStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>emptyInvalid</span>
<a name="line-2051"></a>       <span class='hs-conid'>LastStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>emptyInvalid</span>  <span class='hs-comment'>-- Should not happen (dealt with by checkLastStmt)</span>
<a name="line-2052"></a>       <span class='hs-conid'>ApplicativeStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>emptyInvalid</span>
<a name="line-2053"></a>
<a name="line-2054"></a><a name="okPArrStmt"></a><span class='hs-comment'>----------------</span>
<a name="line-2055"></a><span class='hs-definition'>okPArrStmt</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmt</span>
<a name="line-2056"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stmt</span> <span class='hs-keyword'>of</span>
<a name="line-2057"></a>       <span class='hs-conid'>BindStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsValid</span>
<a name="line-2058"></a>       <span class='hs-conid'>LetStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsValid</span>
<a name="line-2059"></a>       <span class='hs-conid'>BodyStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsValid</span>
<a name="line-2060"></a>       <span class='hs-conid'>ParStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>
<a name="line-2061"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>ParallelListComp</span> <span class='hs-varop'>`xopt`</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsValid</span>
<a name="line-2062"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NotValid</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Use ParallelListComp"</span><span class='hs-layout'>)</span>
<a name="line-2063"></a>       <span class='hs-conid'>TransStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>emptyInvalid</span>
<a name="line-2064"></a>       <span class='hs-conid'>RecStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>emptyInvalid</span>
<a name="line-2065"></a>       <span class='hs-conid'>LastStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>emptyInvalid</span>  <span class='hs-comment'>-- Should not happen (dealt with by checkLastStmt)</span>
<a name="line-2066"></a>       <span class='hs-conid'>ApplicativeStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>emptyInvalid</span>
<a name="line-2067"></a>
<a name="line-2068"></a><a name="checkTupleSection"></a><span class='hs-comment'>---------</span>
<a name="line-2069"></a><span class='hs-definition'>checkTupleSection</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTupArg</span> <span class='hs-conid'>GhcPs</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-2070"></a><span class='hs-definition'>checkTupleSection</span> <span class='hs-varid'>args</span>
<a name="line-2071"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>tuple_section</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>TupleSections</span>
<a name="line-2072"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>all</span> <span class='hs-varid'>tupArgPresent</span> <span class='hs-varid'>args</span> <span class='hs-varop'>||</span> <span class='hs-varid'>tuple_section</span><span class='hs-layout'>)</span> <span class='hs-varid'>msg</span> <span class='hs-layout'>}</span>
<a name="line-2073"></a>  <span class='hs-keyword'>where</span>
<a name="line-2074"></a>    <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Illegal tuple section: use TupleSections"</span>
<a name="line-2075"></a>
<a name="line-2076"></a><a name="sectionErr"></a><span class='hs-comment'>---------</span>
<a name="line-2077"></a><span class='hs-definition'>sectionErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcPs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2078"></a><span class='hs-definition'>sectionErr</span> <span class='hs-varid'>expr</span>
<a name="line-2079"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"A section must be enclosed in parentheses"</span><span class='hs-layout'>)</span>
<a name="line-2080"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"thus:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2081"></a>
<a name="line-2082"></a><a name="patSynErr"></a><span class='hs-definition'>patSynErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcPs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-2083"></a><span class='hs-definition'>patSynErr</span> <span class='hs-varid'>e</span> <span class='hs-varid'>explanation</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"Pattern syntax in expression context:"</span><span class='hs-layout'>,</span>
<a name="line-2084"></a>                                <span class='hs-varid'>nest</span> <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$$</span>
<a name="line-2085"></a>                                  <span class='hs-varid'>explanation</span><span class='hs-layout'>)</span>
<a name="line-2086"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>EWildPat</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2087"></a>
<a name="line-2088"></a><a name="badIpBinds"></a><span class='hs-definition'>badIpBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2089"></a><span class='hs-definition'>badIpBinds</span> <span class='hs-varid'>what</span> <span class='hs-varid'>binds</span>
<a name="line-2090"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Implicit-parameter bindings illegal in"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>what</span><span class='hs-layout'>)</span>
<a name="line-2091"></a>         <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
</pre></body>
</html>
