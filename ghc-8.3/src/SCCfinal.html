<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>profiling/SCCfinal.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>-- (c) The GRASP/AQUA Project, Glasgow University, 1992-1998</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-5"></a><span class='hs-comment'>-- Modify and collect code generation for final STG program</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-comment'>{-
<a name="line-8"></a> This is now a sort-of-normal STG-to-STG pass (WDP 94/06), run by stg2stg.
<a name="line-9"></a>
<a name="line-10"></a>  - Traverses the STG program collecting the cost centres. These are required
<a name="line-11"></a>    to declare the cost centres at the start of code generation.
<a name="line-12"></a>
<a name="line-13"></a>    Note: because of cross-module unfolding, some of these cost centres may be
<a name="line-14"></a>    from other modules.
<a name="line-15"></a>
<a name="line-16"></a>  - Puts on CAF cost-centres if the user has asked for individual CAF
<a name="line-17"></a>    cost-centres.
<a name="line-18"></a>-}</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>SCCfinal</span> <span class='hs-layout'>(</span> <span class='hs-varid'>stgMassageForProfiling</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StgSyn</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CostCentre</span>       <span class='hs-comment'>-- lots of things</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>       <span class='hs-layout'>(</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-layout'>)</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>removeDups</span> <span class='hs-layout'>)</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>          <span class='hs-layout'>(</span> <span class='hs-conid'>Tickish</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftM</span><span class='hs-layout'>,</span> <span class='hs-varid'>ap</span><span class='hs-layout'>)</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="stgMassageForProfiling"></a><span class='hs-definition'>stgMassageForProfiling</span>
<a name="line-42"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-43"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span>                       <span class='hs-comment'>-- module name</span>
<a name="line-44"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSupply</span>                   <span class='hs-comment'>-- unique supply</span>
<a name="line-45"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgTopBinding</span><span class='hs-keyglyph'>]</span>              <span class='hs-comment'>-- input</span>
<a name="line-46"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CollectedCCs</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgTopBinding</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-47"></a>
<a name="line-48"></a><span class='hs-definition'>stgMassageForProfiling</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>mod_name</span> <span class='hs-sel'>_us</span> <span class='hs-varid'>stg_binds</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>
<a name="line-50"></a>        <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>local_ccs</span><span class='hs-layout'>,</span> <span class='hs-varid'>extern_ccs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_stacks</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-51"></a>         <span class='hs-varid'>stg_binds2</span><span class='hs-layout'>)</span>
<a name="line-52"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initMM</span> <span class='hs-varid'>mod_name</span> <span class='hs-layout'>(</span><span class='hs-varid'>do_top_bindings</span> <span class='hs-varid'>stg_binds</span><span class='hs-layout'>)</span>
<a name="line-53"></a>
<a name="line-54"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>fixed_ccs</span><span class='hs-layout'>,</span> <span class='hs-varid'>fixed_cc_stacks</span><span class='hs-layout'>)</span>
<a name="line-55"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_AutoSccsOnIndividualCafs</span> <span class='hs-varid'>dflags</span>
<a name="line-56"></a>            <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- don't need "all CAFs" CC</span>
<a name="line-57"></a>            <span class='hs-keyword'>else</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>all_cafs_cc</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>all_cafs_ccs</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-58"></a>
<a name="line-59"></a>        <span class='hs-varid'>local_ccs_no_dups</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>removeDups</span> <span class='hs-varid'>cmpCostCentre</span> <span class='hs-varid'>local_ccs</span><span class='hs-layout'>)</span>
<a name="line-60"></a>        <span class='hs-varid'>extern_ccs_no_dups</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>removeDups</span> <span class='hs-varid'>cmpCostCentre</span> <span class='hs-varid'>extern_ccs</span><span class='hs-layout'>)</span>
<a name="line-61"></a>    <span class='hs-keyword'>in</span>
<a name="line-62"></a>    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>fixed_ccs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>local_ccs_no_dups</span><span class='hs-layout'>,</span>
<a name="line-63"></a>      <span class='hs-varid'>extern_ccs_no_dups</span><span class='hs-layout'>,</span>
<a name="line-64"></a>      <span class='hs-varid'>fixed_cc_stacks</span> <span class='hs-varop'>++</span> <span class='hs-varid'>cc_stacks</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>stg_binds2</span><span class='hs-layout'>)</span>
<a name="line-65"></a>  <span class='hs-keyword'>where</span>
<a name="line-66"></a>
<a name="line-67"></a>    <span class='hs-varid'>span</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkGeneralSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFastString</span> <span class='hs-str'>"&lt;entire-module&gt;"</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- XXX do better</span>
<a name="line-68"></a>    <span class='hs-varid'>all_cafs_cc</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAllCafsCC</span> <span class='hs-varid'>mod_name</span> <span class='hs-varid'>span</span>
<a name="line-69"></a>    <span class='hs-varid'>all_cafs_ccs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSingletonCCS</span> <span class='hs-varid'>all_cafs_cc</span>
<a name="line-70"></a>
<a name="line-71"></a>    <span class='hs-comment'>----------</span>
<a name="line-72"></a>    <span class='hs-varid'>do_top_bindings</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgTopBinding</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MassageM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgTopBinding</span><span class='hs-keyglyph'>]</span>
<a name="line-73"></a>
<a name="line-74"></a>    <span class='hs-varid'>do_top_bindings</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-75"></a>
<a name="line-76"></a>    <span class='hs-varid'>do_top_bindings</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgTopLifted</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgNonRec</span> <span class='hs-varid'>b</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-77"></a>        <span class='hs-varid'>rhs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>do_top_rhs</span> <span class='hs-varid'>b</span> <span class='hs-varid'>rhs</span>
<a name="line-78"></a>        <span class='hs-varid'>bs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>do_top_bindings</span> <span class='hs-varid'>bs</span>
<a name="line-79"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgTopLifted</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgNonRec</span> <span class='hs-varid'>b</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>)</span>
<a name="line-80"></a>
<a name="line-81"></a>    <span class='hs-varid'>do_top_bindings</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgTopLifted</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-82"></a>        <span class='hs-varid'>pairs2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>do_pair</span> <span class='hs-varid'>pairs</span>
<a name="line-83"></a>        <span class='hs-varid'>bs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>do_top_bindings</span> <span class='hs-varid'>bs</span>
<a name="line-84"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgTopLifted</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRec</span> <span class='hs-varid'>pairs2</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>)</span>
<a name="line-85"></a>      <span class='hs-keyword'>where</span>
<a name="line-86"></a>        <span class='hs-varid'>do_pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-87"></a>             <span class='hs-varid'>rhs2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>do_top_rhs</span> <span class='hs-varid'>b</span> <span class='hs-varid'>rhs</span>
<a name="line-88"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs2</span><span class='hs-layout'>)</span>
<a name="line-89"></a>
<a name="line-90"></a>    <span class='hs-varid'>do_top_bindings</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>StgTopStringLit</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-conop'>:</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-91"></a>        <span class='hs-varid'>bs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>do_top_bindings</span> <span class='hs-varid'>bs</span>
<a name="line-92"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span> <span class='hs-conop'>:</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>)</span>
<a name="line-93"></a>
<a name="line-94"></a>    <span class='hs-comment'>----------</span>
<a name="line-95"></a>    <span class='hs-varid'>do_top_rhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgRhs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MassageM</span> <span class='hs-conid'>StgRhs</span>
<a name="line-96"></a>
<a name="line-97"></a>    <span class='hs-varid'>do_top_rhs</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhsClosure</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span>
<a name="line-98"></a>                     <span class='hs-layout'>(</span><span class='hs-conid'>StgTick</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProfNote</span> <span class='hs-sel'>_cc</span> <span class='hs-conid'>False</span><span class='hs-comment'>{-not tick-}</span> <span class='hs-sel'>_push</span><span class='hs-layout'>)</span>
<a name="line-99"></a>                              <span class='hs-layout'>(</span><span class='hs-conid'>StgConApp</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-100"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isDllConApp</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>mod_name</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-101"></a>        <span class='hs-comment'>-- Trivial _scc_ around nothing but static data</span>
<a name="line-102"></a>        <span class='hs-comment'>-- Eliminate _scc_ ... and turn into StgRhsCon</span>
<a name="line-103"></a>
<a name="line-104"></a>        <span class='hs-comment'>-- isDllConApp checks for LitLit args too</span>
<a name="line-105"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhsCon</span> <span class='hs-varid'>dontCareCCS</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-106"></a>
<a name="line-107"></a>    <span class='hs-varid'>do_top_rhs</span> <span class='hs-varid'>binder</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhsClosure</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bi</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>u</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-108"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-109"></a>        <span class='hs-comment'>-- Top level CAF without a cost centre attached</span>
<a name="line-110"></a>        <span class='hs-comment'>-- Attach CAF cc (collect if individual CAF ccs)</span>
<a name="line-111"></a>        <span class='hs-varid'>caf_ccs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_AutoSccsOnIndividualCafs</span> <span class='hs-varid'>dflags</span>
<a name="line-112"></a>                   <span class='hs-keyword'>then</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>cc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAutoCC</span> <span class='hs-varid'>binder</span> <span class='hs-varid'>modl</span> <span class='hs-conid'>CafCC</span>
<a name="line-113"></a>                            <span class='hs-varid'>ccs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSingletonCCS</span> <span class='hs-varid'>cc</span>
<a name="line-114"></a>                                   <span class='hs-comment'>-- careful: the binder might be :Main.main,</span>
<a name="line-115"></a>                                   <span class='hs-comment'>-- which doesn't belong to module mod_name.</span>
<a name="line-116"></a>                                   <span class='hs-comment'>-- bug #249, tests prof001, prof002</span>
<a name="line-117"></a>                            <span class='hs-varid'>modl</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nameModule_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>binder</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span>
<a name="line-118"></a>                                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod_name</span>
<a name="line-119"></a>                        <span class='hs-keyword'>in</span> <span class='hs-keyword'>do</span>
<a name="line-120"></a>                        <span class='hs-varid'>collectNewCC</span>  <span class='hs-varid'>cc</span>
<a name="line-121"></a>                        <span class='hs-varid'>collectCCS</span> <span class='hs-varid'>ccs</span>
<a name="line-122"></a>                        <span class='hs-varid'>return</span> <span class='hs-varid'>ccs</span>
<a name="line-123"></a>                   <span class='hs-keyword'>else</span>
<a name="line-124"></a>                        <span class='hs-varid'>return</span> <span class='hs-varid'>all_cafs_ccs</span>
<a name="line-125"></a>        <span class='hs-varid'>body'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>do_expr</span> <span class='hs-varid'>body</span>
<a name="line-126"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhsClosure</span> <span class='hs-varid'>caf_ccs</span> <span class='hs-varid'>bi</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>u</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span>
<a name="line-127"></a>
<a name="line-128"></a>    <span class='hs-varid'>do_top_rhs</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhsClosure</span> <span class='hs-sel'>_no_ccs</span> <span class='hs-varid'>bi</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>u</span> <span class='hs-varid'>args</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-129"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>body'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>do_expr</span> <span class='hs-varid'>body</span>
<a name="line-130"></a>           <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhsClosure</span> <span class='hs-varid'>dontCareCCS</span> <span class='hs-varid'>bi</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>u</span> <span class='hs-varid'>args</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span>
<a name="line-131"></a>
<a name="line-132"></a>    <span class='hs-varid'>do_top_rhs</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhsCon</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-133"></a>        <span class='hs-comment'>-- Top-level (static) data is not counted in heap</span>
<a name="line-134"></a>        <span class='hs-comment'>-- profiles; nor do we set CCCS from it; so we</span>
<a name="line-135"></a>        <span class='hs-comment'>-- just slam in dontCareCostCentre</span>
<a name="line-136"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhsCon</span> <span class='hs-varid'>dontCareCCS</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-137"></a>
<a name="line-138"></a>    <span class='hs-comment'>------</span>
<a name="line-139"></a>    <span class='hs-varid'>do_expr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StgExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MassageM</span> <span class='hs-conid'>StgExpr</span>
<a name="line-140"></a>
<a name="line-141"></a>    <span class='hs-varid'>do_expr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgLit</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgLit</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-142"></a>
<a name="line-143"></a>    <span class='hs-varid'>do_expr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgApp</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-144"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgApp</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-145"></a>
<a name="line-146"></a>    <span class='hs-varid'>do_expr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgConApp</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span> <span class='hs-varid'>ty_args</span><span class='hs-layout'>)</span>
<a name="line-147"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgConApp</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span> <span class='hs-varid'>ty_args</span><span class='hs-layout'>)</span>
<a name="line-148"></a>
<a name="line-149"></a>    <span class='hs-varid'>do_expr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgOpApp</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-150"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgOpApp</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-151"></a>
<a name="line-152"></a>    <span class='hs-varid'>do_expr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgTick</span> <span class='hs-varid'>note</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ProfNote</span> <span class='hs-varid'>cc</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-153"></a>        <span class='hs-comment'>-- Ha, we found a cost centre!</span>
<a name="line-154"></a>        <span class='hs-varid'>collectCC</span> <span class='hs-varid'>cc</span>
<a name="line-155"></a>        <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>do_expr</span> <span class='hs-varid'>expr</span>
<a name="line-156"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgTick</span> <span class='hs-varid'>note</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span>
<a name="line-157"></a>
<a name="line-158"></a>    <span class='hs-varid'>do_expr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgTick</span> <span class='hs-varid'>ti</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-159"></a>        <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>do_expr</span> <span class='hs-varid'>expr</span>
<a name="line-160"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgTick</span> <span class='hs-varid'>ti</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span>
<a name="line-161"></a>
<a name="line-162"></a>    <span class='hs-varid'>do_expr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgCase</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>alt_type</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-163"></a>        <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>do_expr</span> <span class='hs-varid'>expr</span>
<a name="line-164"></a>        <span class='hs-varid'>alts'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>do_alt</span> <span class='hs-varid'>alts</span>
<a name="line-165"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgCase</span> <span class='hs-varid'>expr'</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>alt_type</span> <span class='hs-varid'>alts'</span><span class='hs-layout'>)</span>
<a name="line-166"></a>      <span class='hs-keyword'>where</span>
<a name="line-167"></a>        <span class='hs-varid'>do_alt</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-168"></a>            <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>do_expr</span> <span class='hs-varid'>e</span>
<a name="line-169"></a>            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span>
<a name="line-170"></a>
<a name="line-171"></a>    <span class='hs-varid'>do_expr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgLet</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-172"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>do_let</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span>
<a name="line-173"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgLet</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-174"></a>
<a name="line-175"></a>    <span class='hs-varid'>do_expr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgLetNoEscape</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-176"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>do_let</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span>
<a name="line-177"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgLetNoEscape</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-178"></a>
<a name="line-179"></a>    <span class='hs-varid'>do_expr</span> <span class='hs-varid'>other</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"SCCfinal.do_expr"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span>
<a name="line-180"></a>
<a name="line-181"></a>    <span class='hs-comment'>----------------------------------</span>
<a name="line-182"></a>
<a name="line-183"></a>    <span class='hs-varid'>do_let</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgNonRec</span> <span class='hs-varid'>b</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-184"></a>        <span class='hs-varid'>rhs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>do_rhs</span> <span class='hs-varid'>rhs</span>
<a name="line-185"></a>        <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>do_expr</span> <span class='hs-varid'>e</span>
<a name="line-186"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgNonRec</span> <span class='hs-varid'>b</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>,</span><span class='hs-varid'>e'</span><span class='hs-layout'>)</span>
<a name="line-187"></a>
<a name="line-188"></a>    <span class='hs-varid'>do_let</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-189"></a>        <span class='hs-varid'>pairs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>do_pair</span> <span class='hs-varid'>pairs</span>
<a name="line-190"></a>        <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>do_expr</span> <span class='hs-varid'>e</span>
<a name="line-191"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRec</span> <span class='hs-varid'>pairs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span>
<a name="line-192"></a>      <span class='hs-keyword'>where</span>
<a name="line-193"></a>        <span class='hs-varid'>do_pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-194"></a>             <span class='hs-varid'>rhs2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>do_rhs</span> <span class='hs-varid'>rhs</span>
<a name="line-195"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs2</span><span class='hs-layout'>)</span>
<a name="line-196"></a>
<a name="line-197"></a>    <span class='hs-comment'>----------------------------------</span>
<a name="line-198"></a>    <span class='hs-varid'>do_rhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StgRhs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MassageM</span> <span class='hs-conid'>StgRhs</span>
<a name="line-199"></a>        <span class='hs-comment'>-- We play much the same game as we did in do_top_rhs above;</span>
<a name="line-200"></a>        <span class='hs-comment'>-- but we don't have to worry about cafs etc.</span>
<a name="line-201"></a>
<a name="line-202"></a>        <span class='hs-comment'>-- throw away the SCC if we don't have to count entries.  This</span>
<a name="line-203"></a>        <span class='hs-comment'>-- is a little bit wrong, because we're attributing the</span>
<a name="line-204"></a>        <span class='hs-comment'>-- allocation of the constructor to the wrong place (XXX)</span>
<a name="line-205"></a>        <span class='hs-comment'>-- We should really attach (PushCC cc CurrentCCS) to the rhs,</span>
<a name="line-206"></a>        <span class='hs-comment'>-- but need to reinstate PushCC for that.</span>
<a name="line-207"></a>    <span class='hs-varid'>do_rhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhsClosure</span> <span class='hs-sel'>_closure_cc</span> <span class='hs-sel'>_bi</span> <span class='hs-sel'>_fv</span> <span class='hs-sel'>_u</span> <span class='hs-conid'>[]</span>
<a name="line-208"></a>               <span class='hs-layout'>(</span><span class='hs-conid'>StgTick</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProfNote</span> <span class='hs-varid'>cc</span> <span class='hs-conid'>False</span><span class='hs-comment'>{-not tick-}</span> <span class='hs-sel'>_push</span><span class='hs-layout'>)</span>
<a name="line-209"></a>                        <span class='hs-layout'>(</span><span class='hs-conid'>StgConApp</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-210"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>collectCC</span> <span class='hs-varid'>cc</span>
<a name="line-211"></a>           <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhsCon</span> <span class='hs-varid'>currentCCS</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-212"></a>
<a name="line-213"></a>    <span class='hs-varid'>do_rhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhsClosure</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bi</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>u</span> <span class='hs-varid'>args</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-214"></a>        <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>do_expr</span> <span class='hs-varid'>expr</span>
<a name="line-215"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhsClosure</span> <span class='hs-varid'>currentCCS</span> <span class='hs-varid'>bi</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>u</span> <span class='hs-varid'>args</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span>
<a name="line-216"></a>
<a name="line-217"></a>    <span class='hs-varid'>do_rhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhsCon</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-218"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhsCon</span> <span class='hs-varid'>currentCCS</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-219"></a>
<a name="line-220"></a>
<a name="line-221"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-222"></a><span class='hs-comment'>-- Boring monad stuff for this</span>
<a name="line-223"></a>
<a name="line-224"></a><a name="MassageM"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>MassageM</span> <span class='hs-varid'>result</span>
<a name="line-225"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MassageM</span> <span class='hs-layout'>{</span>
<a name="line-226"></a>      <span class='hs-varid'>unMassageM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span>              <span class='hs-comment'>-- module name</span>
<a name="line-227"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CollectedCCs</span>
<a name="line-228"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CollectedCCs</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-229"></a>    <span class='hs-layout'>}</span>
<a name="line-230"></a>
<a name="line-231"></a><a name="instance%20Functor%20MassageM"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Functor</span> <span class='hs-conid'>MassageM</span> <span class='hs-keyword'>where</span>
<a name="line-232"></a>      <span class='hs-varid'>fmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span>
<a name="line-233"></a>
<a name="line-234"></a><a name="instance%20Applicative%20MassageM"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Applicative</span> <span class='hs-conid'>MassageM</span> <span class='hs-keyword'>where</span>
<a name="line-235"></a>      <span class='hs-varid'>pure</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MassageM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-varid'>ccs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ccs</span><span class='hs-layout'>,</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-236"></a>      <span class='hs-layout'>(</span><span class='hs-varop'>&lt;*&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ap</span>
<a name="line-237"></a>      <span class='hs-layout'>(</span><span class='hs-varop'>*&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thenMM_</span>
<a name="line-238"></a>
<a name="line-239"></a><a name="instance%20Monad%20MassageM"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monad</span> <span class='hs-conid'>MassageM</span> <span class='hs-keyword'>where</span>
<a name="line-240"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>&gt;&gt;=</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thenMM</span>
<a name="line-241"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>&gt;&gt;</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varop'>*&gt;</span><span class='hs-layout'>)</span>
<a name="line-242"></a>
<a name="line-243"></a><span class='hs-comment'>-- the initMM function also returns the final CollectedCCs</span>
<a name="line-244"></a>
<a name="line-245"></a><a name="initMM"></a><span class='hs-definition'>initMM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span>        <span class='hs-comment'>-- module name, which we may consult</span>
<a name="line-246"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MassageM</span> <span class='hs-varid'>a</span>
<a name="line-247"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CollectedCCs</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-248"></a>
<a name="line-249"></a><span class='hs-definition'>initMM</span> <span class='hs-varid'>mod_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>MassageM</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span> <span class='hs-varid'>mod_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-250"></a>
<a name="line-251"></a><a name="thenMM"></a><span class='hs-definition'>thenMM</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MassageM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MassageM</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MassageM</span> <span class='hs-varid'>b</span>
<a name="line-252"></a><a name="thenMM_"></a><span class='hs-definition'>thenMM_</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MassageM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>MassageM</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MassageM</span> <span class='hs-varid'>b</span>
<a name="line-253"></a>
<a name="line-254"></a><span class='hs-definition'>thenMM</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>cont</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MassageM</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>mod</span> <span class='hs-varid'>ccs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-255"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>unMassageM</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>ccs</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ccs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-256"></a>    <span class='hs-varid'>unMassageM</span> <span class='hs-layout'>(</span><span class='hs-varid'>cont</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>ccs2</span> <span class='hs-layout'>}</span>
<a name="line-257"></a>
<a name="line-258"></a><span class='hs-definition'>thenMM_</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>cont</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MassageM</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>mod</span> <span class='hs-varid'>ccs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-259"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>unMassageM</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>ccs</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ccs2</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-260"></a>    <span class='hs-varid'>unMassageM</span> <span class='hs-varid'>cont</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>ccs2</span> <span class='hs-layout'>}</span>
<a name="line-261"></a>
<a name="line-262"></a>
<a name="line-263"></a><a name="collectCC"></a><span class='hs-definition'>collectCC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CostCentre</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MassageM</span> <span class='hs-conid'>()</span>
<a name="line-264"></a><span class='hs-definition'>collectCC</span> <span class='hs-varid'>cc</span>
<a name="line-265"></a> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MassageM</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>mod_name</span> <span class='hs-layout'>(</span><span class='hs-varid'>local_ccs</span><span class='hs-layout'>,</span> <span class='hs-varid'>extern_ccs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ccss</span><span class='hs-layout'>)</span>
<a name="line-266"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc</span> <span class='hs-varop'>`ccFromThisModule`</span> <span class='hs-varid'>mod_name</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span>
<a name="line-267"></a>        <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>cc</span> <span class='hs-conop'>:</span> <span class='hs-varid'>local_ccs</span><span class='hs-layout'>,</span> <span class='hs-varid'>extern_ccs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ccss</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-268"></a>     <span class='hs-keyword'>else</span> <span class='hs-comment'>-- must declare it "extern"</span>
<a name="line-269"></a>        <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>local_ccs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc</span> <span class='hs-conop'>:</span> <span class='hs-varid'>extern_ccs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ccss</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-270"></a>
<a name="line-271"></a><a name="collectNewCC"></a><span class='hs-comment'>-- Version of collectCC used when we definitely want to declare this</span>
<a name="line-272"></a><span class='hs-comment'>-- CC as local, even if its module name is not the same as the current</span>
<a name="line-273"></a><span class='hs-comment'>-- module name (eg. the special :Main module) see bug #249, #1472,</span>
<a name="line-274"></a><span class='hs-comment'>-- test prof001,prof002.</span>
<a name="line-275"></a><span class='hs-definition'>collectNewCC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CostCentre</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MassageM</span> <span class='hs-conid'>()</span>
<a name="line-276"></a><span class='hs-definition'>collectNewCC</span> <span class='hs-varid'>cc</span>
<a name="line-277"></a> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MassageM</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-sel'>_mod_name</span> <span class='hs-layout'>(</span><span class='hs-varid'>local_ccs</span><span class='hs-layout'>,</span> <span class='hs-varid'>extern_ccs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ccss</span><span class='hs-layout'>)</span>
<a name="line-278"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>cc</span> <span class='hs-conop'>:</span> <span class='hs-varid'>local_ccs</span><span class='hs-layout'>,</span> <span class='hs-varid'>extern_ccs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ccss</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-279"></a>
<a name="line-280"></a><a name="collectCCS"></a><span class='hs-definition'>collectCCS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CostCentreStack</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MassageM</span> <span class='hs-conid'>()</span>
<a name="line-281"></a>
<a name="line-282"></a><span class='hs-definition'>collectCCS</span> <span class='hs-varid'>ccs</span>
<a name="line-283"></a> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MassageM</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-sel'>_mod_name</span> <span class='hs-layout'>(</span><span class='hs-varid'>local_ccs</span><span class='hs-layout'>,</span> <span class='hs-varid'>extern_ccs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ccss</span><span class='hs-layout'>)</span>
<a name="line-284"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>noCCSAttached</span> <span class='hs-varid'>ccs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-285"></a>                       <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>local_ccs</span><span class='hs-layout'>,</span> <span class='hs-varid'>extern_ccs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ccs</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ccss</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
</pre></body>
</html>
