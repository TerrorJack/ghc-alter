<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>coreSyn/CoreUnfold.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The University of Glasgow 2006
<a name="line-3"></a>(c) The AQUA Project, Glasgow University, 1994-1998
<a name="line-4"></a>
<a name="line-5"></a>
<a name="line-6"></a>Core-syntax unfoldings
<a name="line-7"></a>
<a name="line-8"></a>Unfoldings (which can travel across module boundaries) are in Core
<a name="line-9"></a>syntax (namely @CoreExpr@s).
<a name="line-10"></a>
<a name="line-11"></a>The type @Unfolding@ sits ``above'' simply-Core-expressions
<a name="line-12"></a>unfoldings, capturing ``higher-level'' things we know about a binding,
<a name="line-13"></a>usually things that the simplifier found out (e.g., ``it's a
<a name="line-14"></a>literal'').  In the corner of a @CoreUnfolding@ unfolding, you will
<a name="line-15"></a>find, unsurprisingly, a Core expression.
<a name="line-16"></a>-}</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>CoreUnfold</span> <span class='hs-layout'>(</span>
<a name="line-21"></a>        <span class='hs-conid'>Unfolding</span><span class='hs-layout'>,</span> <span class='hs-conid'>UnfoldingGuidance</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- Abstract types</span>
<a name="line-22"></a>
<a name="line-23"></a>        <span class='hs-varid'>noUnfolding</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkImplicitUnfolding</span><span class='hs-layout'>,</span>
<a name="line-24"></a>        <span class='hs-varid'>mkUnfolding</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCoreUnfolding</span><span class='hs-layout'>,</span>
<a name="line-25"></a>        <span class='hs-varid'>mkTopUnfolding</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSimpleUnfolding</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWorkerUnfolding</span><span class='hs-layout'>,</span>
<a name="line-26"></a>        <span class='hs-varid'>mkInlineUnfolding</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkInlineUnfoldingWithArity</span><span class='hs-layout'>,</span>
<a name="line-27"></a>        <span class='hs-varid'>mkInlinableUnfolding</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWwInlineRule</span><span class='hs-layout'>,</span>
<a name="line-28"></a>        <span class='hs-varid'>mkCompulsoryUnfolding</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkDFunUnfolding</span><span class='hs-layout'>,</span>
<a name="line-29"></a>        <span class='hs-varid'>specUnfolding</span><span class='hs-layout'>,</span>
<a name="line-30"></a>
<a name="line-31"></a>        <span class='hs-conid'>ArgSummary</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-32"></a>
<a name="line-33"></a>        <span class='hs-varid'>couldBeSmallEnoughToInline</span><span class='hs-layout'>,</span> <span class='hs-varid'>inlineBoringOk</span><span class='hs-layout'>,</span>
<a name="line-34"></a>        <span class='hs-varid'>certainlyWillInline</span><span class='hs-layout'>,</span> <span class='hs-varid'>smallEnoughToInline</span><span class='hs-layout'>,</span>
<a name="line-35"></a>
<a name="line-36"></a>        <span class='hs-varid'>callSiteInline</span><span class='hs-layout'>,</span> <span class='hs-conid'>CallCtxt</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-37"></a>
<a name="line-38"></a>        <span class='hs-comment'>-- Reexport from CoreSubst (it only live there so it can be used</span>
<a name="line-39"></a>        <span class='hs-comment'>-- by the Very Simple Optimiser)</span>
<a name="line-40"></a>        <span class='hs-varid'>exprIsConApp_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>exprIsLiteral_maybe</span>
<a name="line-41"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-42"></a>
<a name="line-43"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-44"></a>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PprCore</span>          <span class='hs-conid'>()</span>      <span class='hs-comment'>-- Instances</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OccurAnal</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>occurAnalyseExpr</span> <span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreOpt</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreArity</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>manifestArity</span> <span class='hs-layout'>)</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreUtils</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Demand</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>isBottomingSig</span> <span class='hs-layout'>)</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Literal</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrimOp</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IdInfo</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>       <span class='hs-layout'>(</span> <span class='hs-conid'>Arity</span><span class='hs-layout'>,</span> <span class='hs-conid'>InlineSpec</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>inlinePragmaSpec</span> <span class='hs-layout'>)</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysPrim</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>realWorldStatePrimTy</span> <span class='hs-layout'>)</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ForeignCall</span>
<a name="line-66"></a>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>BS</span>
<a name="line-68"></a>
<a name="line-69"></a><span class='hs-comment'>{-
<a name="line-70"></a>************************************************************************
<a name="line-71"></a>*                                                                      *
<a name="line-72"></a>\subsection{Making unfoldings}
<a name="line-73"></a>*                                                                      *
<a name="line-74"></a>************************************************************************
<a name="line-75"></a>-}</span>
<a name="line-76"></a>
<a name="line-77"></a><a name="mkTopUnfolding"></a><span class='hs-definition'>mkTopUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-78"></a><span class='hs-definition'>mkTopUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>is_bottoming</span> <span class='hs-varid'>rhs</span>
<a name="line-79"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>InlineRhs</span> <span class='hs-conid'>True</span> <span class='hs-varid'>is_bottoming</span> <span class='hs-varid'>rhs</span>
<a name="line-80"></a>
<a name="line-81"></a><a name="mkImplicitUnfolding"></a><span class='hs-definition'>mkImplicitUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-82"></a><span class='hs-comment'>-- For implicit Ids, do a tiny bit of optimising first</span>
<a name="line-83"></a><span class='hs-definition'>mkImplicitUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>expr</span>
<a name="line-84"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTopUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>simpleOptExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-85"></a>
<a name="line-86"></a><span class='hs-comment'>-- Note [Top-level flag on inline rules]</span>
<a name="line-87"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-88"></a><span class='hs-comment'>-- Slight hack: note that mk_inline_rules conservatively sets the</span>
<a name="line-89"></a><span class='hs-comment'>-- top-level flag to True.  It gets set more accurately by the simplifier</span>
<a name="line-90"></a><span class='hs-comment'>-- Simplify.simplUnfolding.</span>
<a name="line-91"></a>
<a name="line-92"></a><a name="mkSimpleUnfolding"></a><span class='hs-definition'>mkSimpleUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-93"></a><span class='hs-definition'>mkSimpleUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>rhs</span>
<a name="line-94"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>InlineRhs</span> <span class='hs-conid'>False</span> <span class='hs-conid'>False</span> <span class='hs-varid'>rhs</span>
<a name="line-95"></a>
<a name="line-96"></a><a name="mkDFunUnfolding"></a><span class='hs-definition'>mkDFunUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreExpr</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-97"></a><span class='hs-definition'>mkDFunUnfolding</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ops</span>
<a name="line-98"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DFunUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>df_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs</span>
<a name="line-99"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>df_con</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con</span>
<a name="line-100"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>df_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>occurAnalyseExpr</span> <span class='hs-varid'>ops</span> <span class='hs-layout'>}</span>
<a name="line-101"></a>                  <span class='hs-comment'>-- See Note [Occurrence analysis of unfoldings]</span>
<a name="line-102"></a>
<a name="line-103"></a><a name="mkWwInlineRule"></a><span class='hs-definition'>mkWwInlineRule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-104"></a><span class='hs-definition'>mkWwInlineRule</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>arity</span>
<a name="line-105"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoreUnfolding</span> <span class='hs-conid'>InlineStable</span> <span class='hs-conid'>True</span>
<a name="line-106"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>simpleOptExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-107"></a>                   <span class='hs-layout'>(</span><span class='hs-conid'>UnfWhen</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ug_arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arity</span><span class='hs-layout'>,</span> <span class='hs-varid'>ug_unsat_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unSaturatedOk</span>
<a name="line-108"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>ug_boring_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boringCxtNotOk</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-109"></a>
<a name="line-110"></a><a name="mkCompulsoryUnfolding"></a><span class='hs-definition'>mkCompulsoryUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-111"></a><span class='hs-definition'>mkCompulsoryUnfolding</span> <span class='hs-varid'>expr</span>         <span class='hs-comment'>-- Used for things that absolutely must be unfolded</span>
<a name="line-112"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoreUnfolding</span> <span class='hs-conid'>InlineCompulsory</span> <span class='hs-conid'>True</span>
<a name="line-113"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>simpleOptExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-114"></a>                    <span class='hs-layout'>(</span><span class='hs-conid'>UnfWhen</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ug_arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>    <span class='hs-comment'>-- Arity of unfolding doesn't matter</span>
<a name="line-115"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ug_unsat_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unSaturatedOk</span><span class='hs-layout'>,</span> <span class='hs-varid'>ug_boring_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boringCxtOk</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-116"></a>
<a name="line-117"></a><a name="mkWorkerUnfolding"></a><span class='hs-definition'>mkWorkerUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-118"></a><span class='hs-comment'>-- See Note [Worker-wrapper for INLINABLE functions] in WorkWrap</span>
<a name="line-119"></a><span class='hs-definition'>mkWorkerUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>work_fn</span>
<a name="line-120"></a>                  <span class='hs-layout'>(</span><span class='hs-conid'>CoreUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uf_src</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>src</span><span class='hs-layout'>,</span> <span class='hs-varid'>uf_tmpl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tmpl</span>
<a name="line-121"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>uf_is_top</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>top_lvl</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-122"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isStableSource</span> <span class='hs-varid'>src</span>
<a name="line-123"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoreUnfolding</span> <span class='hs-varid'>src</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>new_tmpl</span> <span class='hs-varid'>guidance</span>
<a name="line-124"></a>  <span class='hs-keyword'>where</span>
<a name="line-125"></a>    <span class='hs-varid'>new_tmpl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simpleOptExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>work_fn</span> <span class='hs-varid'>tmpl</span><span class='hs-layout'>)</span>
<a name="line-126"></a>    <span class='hs-varid'>guidance</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>calcUnfoldingGuidance</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>False</span> <span class='hs-varid'>new_tmpl</span>
<a name="line-127"></a>
<a name="line-128"></a><span class='hs-definition'>mkWorkerUnfolding</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noUnfolding</span>
<a name="line-129"></a>
<a name="line-130"></a><a name="mkInlineUnfolding"></a><span class='hs-comment'>-- | Make an unfolding that may be used unsaturated</span>
<a name="line-131"></a><span class='hs-comment'>-- (ug_unsat_ok = unSaturatedOk) and that is reported as having its</span>
<a name="line-132"></a><span class='hs-comment'>-- manifest arity (the number of outer lambdas applications will</span>
<a name="line-133"></a><span class='hs-comment'>-- resolve before doing any work).</span>
<a name="line-134"></a><span class='hs-definition'>mkInlineUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-135"></a><span class='hs-definition'>mkInlineUnfolding</span> <span class='hs-varid'>expr</span>
<a name="line-136"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoreUnfolding</span> <span class='hs-conid'>InlineStable</span>
<a name="line-137"></a>                    <span class='hs-conid'>True</span>         <span class='hs-comment'>-- Note [Top-level flag on inline rules]</span>
<a name="line-138"></a>                    <span class='hs-varid'>expr'</span> <span class='hs-varid'>guide</span>
<a name="line-139"></a>  <span class='hs-keyword'>where</span>
<a name="line-140"></a>    <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simpleOptExpr</span> <span class='hs-varid'>expr</span>
<a name="line-141"></a>    <span class='hs-varid'>guide</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnfWhen</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ug_arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>manifestArity</span> <span class='hs-varid'>expr'</span>
<a name="line-142"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>ug_unsat_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unSaturatedOk</span>
<a name="line-143"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>ug_boring_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boring_ok</span> <span class='hs-layout'>}</span>
<a name="line-144"></a>    <span class='hs-varid'>boring_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inlineBoringOk</span> <span class='hs-varid'>expr'</span>
<a name="line-145"></a>
<a name="line-146"></a><a name="mkInlineUnfoldingWithArity"></a><span class='hs-comment'>-- | Make an unfolding that will be used once the RHS has been saturated</span>
<a name="line-147"></a><span class='hs-comment'>-- to the given arity.</span>
<a name="line-148"></a><span class='hs-definition'>mkInlineUnfoldingWithArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-149"></a><span class='hs-definition'>mkInlineUnfoldingWithArity</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>expr</span>
<a name="line-150"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoreUnfolding</span> <span class='hs-conid'>InlineStable</span>
<a name="line-151"></a>                    <span class='hs-conid'>True</span>         <span class='hs-comment'>-- Note [Top-level flag on inline rules]</span>
<a name="line-152"></a>                    <span class='hs-varid'>expr'</span> <span class='hs-varid'>guide</span>
<a name="line-153"></a>  <span class='hs-keyword'>where</span>
<a name="line-154"></a>    <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simpleOptExpr</span> <span class='hs-varid'>expr</span>
<a name="line-155"></a>    <span class='hs-varid'>guide</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnfWhen</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ug_arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arity</span>
<a name="line-156"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>ug_unsat_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>needSaturated</span>
<a name="line-157"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>ug_boring_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boring_ok</span> <span class='hs-layout'>}</span>
<a name="line-158"></a>    <span class='hs-varid'>boring_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inlineBoringOk</span> <span class='hs-varid'>expr'</span>
<a name="line-159"></a>
<a name="line-160"></a><a name="mkInlinableUnfolding"></a><span class='hs-definition'>mkInlinableUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-161"></a><span class='hs-definition'>mkInlinableUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>expr</span>
<a name="line-162"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>InlineStable</span> <span class='hs-conid'>False</span> <span class='hs-conid'>False</span> <span class='hs-varid'>expr'</span>
<a name="line-163"></a>  <span class='hs-keyword'>where</span>
<a name="line-164"></a>    <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simpleOptExpr</span> <span class='hs-varid'>expr</span>
<a name="line-165"></a>
<a name="line-166"></a><a name="specUnfolding"></a><span class='hs-definition'>specUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-167"></a><span class='hs-comment'>-- See Note [Specialising unfoldings]</span>
<a name="line-168"></a><span class='hs-comment'>-- specUnfolding spec_bndrs spec_app arity_decrease unf</span>
<a name="line-169"></a><span class='hs-comment'>--   = \spec_bndrs. spec_app( unf )</span>
<a name="line-170"></a><span class='hs-comment'>--</span>
<a name="line-171"></a><span class='hs-definition'>specUnfolding</span> <span class='hs-varid'>spec_bndrs</span> <span class='hs-varid'>spec_app</span> <span class='hs-varid'>arity_decrease</span>
<a name="line-172"></a>              <span class='hs-varid'>df</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DFunUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>df_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>df_con</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>df_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-173"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>arity_decrease</span> <span class='hs-varop'>==</span> <span class='hs-varid'>count</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>old_bndrs</span> <span class='hs-comment'>-</span> <span class='hs-varid'>count</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>spec_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>df</span> <span class='hs-layout'>)</span>
<a name="line-174"></a>    <span class='hs-varid'>mkDFunUnfolding</span> <span class='hs-varid'>spec_bndrs</span> <span class='hs-varid'>con</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>spec_arg</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-175"></a>      <span class='hs-comment'>-- There is a hard-to-check assumption here that the spec_app has</span>
<a name="line-176"></a>      <span class='hs-comment'>-- enough applications to exactly saturate the old_bndrs</span>
<a name="line-177"></a>      <span class='hs-comment'>-- For DFunUnfoldings we transform</span>
<a name="line-178"></a>      <span class='hs-comment'>--       \old_bndrs. MkD &lt;op1&gt; ... &lt;opn&gt;</span>
<a name="line-179"></a>      <span class='hs-comment'>-- to</span>
<a name="line-180"></a>      <span class='hs-comment'>--       \new_bndrs. MkD (spec_app(\old_bndrs. &lt;op1&gt;)) ... ditto &lt;opn&gt;</span>
<a name="line-181"></a>      <span class='hs-comment'>-- The ASSERT checks the value part of that</span>
<a name="line-182"></a>  <span class='hs-keyword'>where</span>
<a name="line-183"></a>    <span class='hs-varid'>spec_arg</span> <span class='hs-varid'>arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simpleOptExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>spec_app</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLams</span> <span class='hs-varid'>old_bndrs</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-184"></a>                   <span class='hs-comment'>-- The beta-redexes created by spec_app will be</span>
<a name="line-185"></a>                   <span class='hs-comment'>-- simplified away by simplOptExpr</span>
<a name="line-186"></a>
<a name="line-187"></a><span class='hs-definition'>specUnfolding</span> <span class='hs-varid'>spec_bndrs</span> <span class='hs-varid'>spec_app</span> <span class='hs-varid'>arity_decrease</span>
<a name="line-188"></a>              <span class='hs-layout'>(</span><span class='hs-conid'>CoreUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uf_src</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>src</span><span class='hs-layout'>,</span> <span class='hs-varid'>uf_tmpl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tmpl</span>
<a name="line-189"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>uf_is_top</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>top_lvl</span>
<a name="line-190"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>uf_guidance</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_guidance</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-191"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isStableSource</span> <span class='hs-varid'>src</span>  <span class='hs-comment'>-- See Note [Specialising unfoldings]</span>
<a name="line-192"></a> <span class='hs-layout'>,</span> <span class='hs-conid'>UnfWhen</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ug_arity</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_arity</span>
<a name="line-193"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>ug_unsat_ok</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsat_ok</span>
<a name="line-194"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>ug_boring_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boring_ok</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>old_guidance</span>
<a name="line-195"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>guidance</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnfWhen</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ug_arity</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_arity</span> <span class='hs-comment'>-</span> <span class='hs-varid'>arity_decrease</span>
<a name="line-196"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>ug_unsat_ok</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsat_ok</span>
<a name="line-197"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>ug_boring_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boring_ok</span> <span class='hs-layout'>}</span>
<a name="line-198"></a>       <span class='hs-varid'>new_tmpl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simpleOptExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLams</span> <span class='hs-varid'>spec_bndrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>spec_app</span> <span class='hs-varid'>tmpl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-199"></a>                   <span class='hs-comment'>-- The beta-redexes created by spec_app will be</span>
<a name="line-200"></a>                   <span class='hs-comment'>-- simplified away by simplOptExpr</span>
<a name="line-201"></a>
<a name="line-202"></a>   <span class='hs-keyword'>in</span> <span class='hs-varid'>mkCoreUnfolding</span> <span class='hs-varid'>src</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>new_tmpl</span> <span class='hs-varid'>guidance</span>
<a name="line-203"></a>
<a name="line-204"></a><span class='hs-definition'>specUnfolding</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noUnfolding</span>
<a name="line-205"></a>
<a name="line-206"></a><span class='hs-comment'>{- Note [Specialising unfoldings]
<a name="line-207"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-208"></a>When we specialise a function for some given type-class arguments, we use
<a name="line-209"></a>specUnfolding to specialise its unfolding.  Some important points:
<a name="line-210"></a>
<a name="line-211"></a>* If the original function has a DFunUnfolding, the specialised one
<a name="line-212"></a>  must do so too!  Otherwise we lose the magic rules that make it
<a name="line-213"></a>  interact with ClassOps
<a name="line-214"></a>
<a name="line-215"></a>* There is a bit of hack for INLINABLE functions:
<a name="line-216"></a>     f :: Ord a =&gt; ....
<a name="line-217"></a>     f = &lt;big-rhs&gt;
<a name="line-218"></a>     {- INLINABLE f #-}
<a name="line-219"></a>  Now if we specialise f, should the specialised version still have
<a name="line-220"></a>  an INLINABLE pragma?  If it does, we'll capture a specialised copy
<a name="line-221"></a>  of &lt;big-rhs&gt; as its unfolding, and that probaby won't inline.  But
<a name="line-222"></a>  if we don't, the specialised version of &lt;big-rhs&gt; might be small
<a name="line-223"></a>  enough to inline at a call site. This happens with Control.Monad.liftM3,
<a name="line-224"></a>  and can cause a lot more allocation as a result (nofib n-body shows this).
<a name="line-225"></a>
<a name="line-226"></a>  Moreover, keeping the INLINABLE thing isn't much help, because
<a name="line-227"></a>  the specialised function (probaby) isn't overloaded any more.
<a name="line-228"></a>
<a name="line-229"></a>  Conclusion: drop the INLINEALE pragma.  In practice what this means is:
<a name="line-230"></a>     if a stable unfolding has UnfoldingGuidance of UnfWhen,
<a name="line-231"></a>        we keep it (so the specialised thing too will always inline)
<a name="line-232"></a>     if a stable unfolding has UnfoldingGuidance of UnfIfGoodArgs
<a name="line-233"></a>        (which arises from INLINABLE), we discard it
<a name="line-234"></a>-}</span>
<a name="line-235"></a>
<a name="line-236"></a><a name="mkCoreUnfolding"></a><span class='hs-definition'>mkCoreUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnfoldingSource</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-237"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnfoldingGuidance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-238"></a><span class='hs-comment'>-- Occurrence-analyses the expression before capturing it</span>
<a name="line-239"></a><span class='hs-definition'>mkCoreUnfolding</span> <span class='hs-varid'>src</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>guidance</span>
<a name="line-240"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uf_tmpl</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occurAnalyseExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>,</span>
<a name="line-241"></a>                      <span class='hs-comment'>-- See Note [Occurrence analysis of unfoldings]</span>
<a name="line-242"></a>                    <span class='hs-varid'>uf_src</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>src</span><span class='hs-layout'>,</span>
<a name="line-243"></a>                    <span class='hs-varid'>uf_is_top</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>top_lvl</span><span class='hs-layout'>,</span>
<a name="line-244"></a>                    <span class='hs-varid'>uf_is_value</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprIsHNF</span>        <span class='hs-varid'>expr</span><span class='hs-layout'>,</span>
<a name="line-245"></a>                    <span class='hs-varid'>uf_is_conlike</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprIsConLike</span>    <span class='hs-varid'>expr</span><span class='hs-layout'>,</span>
<a name="line-246"></a>                    <span class='hs-varid'>uf_is_work_free</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprIsWorkFree</span>   <span class='hs-varid'>expr</span><span class='hs-layout'>,</span>
<a name="line-247"></a>                    <span class='hs-varid'>uf_expandable</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprIsExpandable</span> <span class='hs-varid'>expr</span><span class='hs-layout'>,</span>
<a name="line-248"></a>                    <span class='hs-varid'>uf_guidance</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>guidance</span> <span class='hs-layout'>}</span>
<a name="line-249"></a>
<a name="line-250"></a><a name="mkUnfolding"></a><span class='hs-definition'>mkUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnfoldingSource</span>
<a name="line-251"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>       <span class='hs-comment'>-- Is top-level</span>
<a name="line-252"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>       <span class='hs-comment'>-- Definitely a bottoming binding</span>
<a name="line-253"></a>                          <span class='hs-comment'>-- (only relevant for top-level bindings)</span>
<a name="line-254"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-255"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-256"></a><span class='hs-comment'>-- Calculates unfolding guidance</span>
<a name="line-257"></a><span class='hs-comment'>-- Occurrence-analyses the expression before capturing it</span>
<a name="line-258"></a><span class='hs-definition'>mkUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>src</span> <span class='hs-varid'>is_top_lvl</span> <span class='hs-varid'>is_bottoming</span> <span class='hs-varid'>expr</span>
<a name="line-259"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uf_tmpl</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occurAnalyseExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>,</span>
<a name="line-260"></a>                      <span class='hs-comment'>-- See Note [Occurrence analysis of unfoldings]</span>
<a name="line-261"></a>                    <span class='hs-varid'>uf_src</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>src</span><span class='hs-layout'>,</span>
<a name="line-262"></a>                    <span class='hs-varid'>uf_is_top</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_top_lvl</span><span class='hs-layout'>,</span>
<a name="line-263"></a>                    <span class='hs-varid'>uf_is_value</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprIsHNF</span>        <span class='hs-varid'>expr</span><span class='hs-layout'>,</span>
<a name="line-264"></a>                    <span class='hs-varid'>uf_is_conlike</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprIsConLike</span>    <span class='hs-varid'>expr</span><span class='hs-layout'>,</span>
<a name="line-265"></a>                    <span class='hs-varid'>uf_expandable</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprIsExpandable</span> <span class='hs-varid'>expr</span><span class='hs-layout'>,</span>
<a name="line-266"></a>                    <span class='hs-varid'>uf_is_work_free</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprIsWorkFree</span>   <span class='hs-varid'>expr</span><span class='hs-layout'>,</span>
<a name="line-267"></a>                    <span class='hs-varid'>uf_guidance</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>guidance</span> <span class='hs-layout'>}</span>
<a name="line-268"></a>  <span class='hs-keyword'>where</span>
<a name="line-269"></a>    <span class='hs-varid'>is_top_bottoming</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_top_lvl</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>is_bottoming</span>
<a name="line-270"></a>    <span class='hs-varid'>guidance</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>calcUnfoldingGuidance</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>is_top_bottoming</span> <span class='hs-varid'>expr</span>
<a name="line-271"></a>        <span class='hs-comment'>-- NB: *not* (calcUnfoldingGuidance (occurAnalyseExpr expr))!</span>
<a name="line-272"></a>        <span class='hs-comment'>-- See Note [Calculate unfolding guidance on the non-occ-anal'd expression]</span>
<a name="line-273"></a>
<a name="line-274"></a><span class='hs-comment'>{-
<a name="line-275"></a>Note [Occurrence analysis of unfoldings]
<a name="line-276"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-277"></a>We do occurrence-analysis of unfoldings once and for all, when the
<a name="line-278"></a>unfolding is built, rather than each time we inline them.
<a name="line-279"></a>
<a name="line-280"></a>But given this decision it's vital that we do
<a name="line-281"></a>*always* do it.  Consider this unfolding
<a name="line-282"></a>    \x -&gt; letrec { f = ...g...; g* = f } in body
<a name="line-283"></a>where g* is (for some strange reason) the loop breaker.  If we don't
<a name="line-284"></a>occ-anal it when reading it in, we won't mark g as a loop breaker, and
<a name="line-285"></a>we may inline g entirely in body, dropping its binding, and leaving
<a name="line-286"></a>the occurrence in f out of scope. This happened in Trac #8892, where
<a name="line-287"></a>the unfolding in question was a DFun unfolding.
<a name="line-288"></a>
<a name="line-289"></a>But more generally, the simplifier is designed on the
<a name="line-290"></a>basis that it is looking at occurrence-analysed expressions, so better
<a name="line-291"></a>ensure that they acutally are.
<a name="line-292"></a>
<a name="line-293"></a>Note [Calculate unfolding guidance on the non-occ-anal'd expression]
<a name="line-294"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-295"></a>Notice that we give the non-occur-analysed expression to
<a name="line-296"></a>calcUnfoldingGuidance.  In some ways it'd be better to occur-analyse
<a name="line-297"></a>first; for example, sometimes during simplification, there's a large
<a name="line-298"></a>let-bound thing which has been substituted, and so is now dead; so
<a name="line-299"></a>'expr' contains two copies of the thing while the occurrence-analysed
<a name="line-300"></a>expression doesn't.
<a name="line-301"></a>
<a name="line-302"></a>Nevertheless, we *don't* and *must not* occ-analyse before computing
<a name="line-303"></a>the size because
<a name="line-304"></a>
<a name="line-305"></a>a) The size computation bales out after a while, whereas occurrence
<a name="line-306"></a>   analysis does not.
<a name="line-307"></a>
<a name="line-308"></a>b) Residency increases sharply if you occ-anal first.  I'm not
<a name="line-309"></a>   100% sure why, but it's a large effect.  Compiling Cabal went
<a name="line-310"></a>   from residency of 534M to over 800M with this one change.
<a name="line-311"></a>
<a name="line-312"></a>This can occasionally mean that the guidance is very pessimistic;
<a name="line-313"></a>it gets fixed up next round.  And it should be rare, because large
<a name="line-314"></a>let-bound things that are dead are usually caught by preInlineUnconditionally
<a name="line-315"></a>
<a name="line-316"></a>
<a name="line-317"></a>************************************************************************
<a name="line-318"></a>*                                                                      *
<a name="line-319"></a>\subsection{The UnfoldingGuidance type}
<a name="line-320"></a>*                                                                      *
<a name="line-321"></a>************************************************************************
<a name="line-322"></a>-}</span>
<a name="line-323"></a>
<a name="line-324"></a><a name="inlineBoringOk"></a><span class='hs-definition'>inlineBoringOk</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-325"></a><span class='hs-comment'>-- See Note [INLINE for small functions]</span>
<a name="line-326"></a><span class='hs-comment'>-- True =&gt; the result of inlining the expression is</span>
<a name="line-327"></a><span class='hs-comment'>--         no bigger than the expression itself</span>
<a name="line-328"></a><span class='hs-comment'>--     eg      (\x y -&gt; f y x)</span>
<a name="line-329"></a><span class='hs-comment'>-- This is a quick and dirty version. It doesn't attempt</span>
<a name="line-330"></a><span class='hs-comment'>-- to deal with  (\x y z -&gt; x (y z))</span>
<a name="line-331"></a><span class='hs-comment'>-- The really important one is (x `cast` c)</span>
<a name="line-332"></a><span class='hs-definition'>inlineBoringOk</span> <span class='hs-varid'>e</span>
<a name="line-333"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-num'>0</span> <span class='hs-varid'>e</span>
<a name="line-334"></a>  <span class='hs-keyword'>where</span>
<a name="line-335"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-336"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>credit</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>x</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>x</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>credit</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span>
<a name="line-337"></a>                        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>credit</span> <span class='hs-varid'>e</span>
<a name="line-338"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>credit</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>credit</span> <span class='hs-varid'>f</span>
<a name="line-339"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>credit</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>credit</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span>
<a name="line-340"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>exprIsTrivial</span> <span class='hs-varid'>a</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>credit</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span>
<a name="line-341"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>credit</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>credit</span> <span class='hs-varid'>e</span> <span class='hs-comment'>-- dubious</span>
<a name="line-342"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>credit</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>credit</span> <span class='hs-varid'>e</span>
<a name="line-343"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>      <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boringCxtOk</span>
<a name="line-344"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>      <span class='hs-keyword'>_</span>                            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boringCxtNotOk</span>
<a name="line-345"></a>
<a name="line-346"></a><a name="calcUnfoldingGuidance"></a><span class='hs-definition'>calcUnfoldingGuidance</span>
<a name="line-347"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-348"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>          <span class='hs-comment'>-- Definitely a top-level, bottoming binding</span>
<a name="line-349"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>      <span class='hs-comment'>-- Expression to look at</span>
<a name="line-350"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnfoldingGuidance</span>
<a name="line-351"></a><span class='hs-definition'>calcUnfoldingGuidance</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>is_top_bottoming</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-352"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tickishIsCode</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- non-code ticks don't matter for unfolding</span>
<a name="line-353"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>calcUnfoldingGuidance</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>is_top_bottoming</span> <span class='hs-varid'>expr</span>
<a name="line-354"></a><span class='hs-definition'>calcUnfoldingGuidance</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>is_top_bottoming</span> <span class='hs-varid'>expr</span>
<a name="line-355"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>sizeExpr</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>bOMB_OUT_SIZE</span> <span class='hs-varid'>val_bndrs</span> <span class='hs-varid'>body</span> <span class='hs-keyword'>of</span>
<a name="line-356"></a>      <span class='hs-conid'>TooBig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnfNever</span>
<a name="line-357"></a>      <span class='hs-conid'>SizeIs</span> <span class='hs-varid'>size</span> <span class='hs-varid'>cased_bndrs</span> <span class='hs-varid'>scrut_discount</span>
<a name="line-358"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>uncondInline</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>n_val_bndrs</span> <span class='hs-varid'>size</span>
<a name="line-359"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnfWhen</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ug_unsat_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unSaturatedOk</span>
<a name="line-360"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>ug_boring_ok</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>boringCxtOk</span>
<a name="line-361"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>ug_arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n_val_bndrs</span> <span class='hs-layout'>}</span>   <span class='hs-comment'>-- Note [INLINE for small functions]</span>
<a name="line-362"></a>
<a name="line-363"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_top_bottoming</span>
<a name="line-364"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnfNever</span>   <span class='hs-comment'>-- See Note [Do not inline top-level bottoming functions]</span>
<a name="line-365"></a>
<a name="line-366"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-367"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnfIfGoodArgs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ug_args</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_discount</span> <span class='hs-varid'>cased_bndrs</span><span class='hs-layout'>)</span> <span class='hs-varid'>val_bndrs</span>
<a name="line-368"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>ug_size</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size</span>
<a name="line-369"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>ug_res</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>scrut_discount</span> <span class='hs-layout'>}</span>
<a name="line-370"></a>
<a name="line-371"></a>  <span class='hs-keyword'>where</span>
<a name="line-372"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectBinders</span> <span class='hs-varid'>expr</span>
<a name="line-373"></a>    <span class='hs-varid'>bOMB_OUT_SIZE</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ufCreationThreshold</span> <span class='hs-varid'>dflags</span>
<a name="line-374"></a>           <span class='hs-comment'>-- Bomb out if size gets bigger than this</span>
<a name="line-375"></a>    <span class='hs-varid'>val_bndrs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>bndrs</span>
<a name="line-376"></a>    <span class='hs-varid'>n_val_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>val_bndrs</span>
<a name="line-377"></a>
<a name="line-378"></a>    <span class='hs-varid'>mk_discount</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-379"></a>    <span class='hs-varid'>mk_discount</span> <span class='hs-varid'>cbs</span> <span class='hs-varid'>bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldlBag</span> <span class='hs-varid'>combine</span> <span class='hs-num'>0</span> <span class='hs-varid'>cbs</span>
<a name="line-380"></a>           <span class='hs-keyword'>where</span>
<a name="line-381"></a>             <span class='hs-varid'>combine</span> <span class='hs-varid'>acc</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>disc</span><span class='hs-layout'>)</span>
<a name="line-382"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>==</span> <span class='hs-varid'>bndr'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span> <span class='hs-varop'>`plus_disc`</span> <span class='hs-varid'>disc</span>
<a name="line-383"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-384"></a>
<a name="line-385"></a>             <span class='hs-varid'>plus_disc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-386"></a>             <span class='hs-varid'>plus_disc</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFunTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>max</span>
<a name="line-387"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varop'>+</span><span class='hs-layout'>)</span>
<a name="line-388"></a>             <span class='hs-comment'>-- See Note [Function and non-function discounts]</span>
<a name="line-389"></a>
<a name="line-390"></a><span class='hs-comment'>{-
<a name="line-391"></a>Note [Computing the size of an expression]
<a name="line-392"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-393"></a>The basic idea of sizeExpr is obvious enough: count nodes.  But getting the
<a name="line-394"></a>heuristics right has taken a long time.  Here's the basic strategy:
<a name="line-395"></a>
<a name="line-396"></a>    * Variables, literals: 0
<a name="line-397"></a>      (Exception for string literals, see litSize.)
<a name="line-398"></a>
<a name="line-399"></a>    * Function applications (f e1 .. en): 1 + #value args
<a name="line-400"></a>
<a name="line-401"></a>    * Constructor applications: 1, regardless of #args
<a name="line-402"></a>
<a name="line-403"></a>    * Let(rec): 1 + size of components
<a name="line-404"></a>
<a name="line-405"></a>    * Note, cast: 0
<a name="line-406"></a>
<a name="line-407"></a>Examples
<a name="line-408"></a>
<a name="line-409"></a>  Size  Term
<a name="line-410"></a>  --------------
<a name="line-411"></a>    0     42#
<a name="line-412"></a>    0     x
<a name="line-413"></a>    0     True
<a name="line-414"></a>    2     f x
<a name="line-415"></a>    1     Just x
<a name="line-416"></a>    4     f (g x)
<a name="line-417"></a>
<a name="line-418"></a>Notice that 'x' counts 0, while (f x) counts 2.  That's deliberate: there's
<a name="line-419"></a>a function call to account for.  Notice also that constructor applications
<a name="line-420"></a>are very cheap, because exposing them to a caller is so valuable.
<a name="line-421"></a>
<a name="line-422"></a>[25/5/11] All sizes are now multiplied by 10, except for primops
<a name="line-423"></a>(which have sizes like 1 or 4.  This makes primops look fantastically
<a name="line-424"></a>cheap, and seems to be almost unversally beneficial.  Done partly as a
<a name="line-425"></a>result of #4978.
<a name="line-426"></a>
<a name="line-427"></a>Note [Do not inline top-level bottoming functions]
<a name="line-428"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-429"></a>The FloatOut pass has gone to some trouble to float out calls to 'error'
<a name="line-430"></a>and similar friends.  See Note [Bottoming floats] in SetLevels.
<a name="line-431"></a>Do not re-inline them!  But we *do* still inline if they are very small
<a name="line-432"></a>(the uncondInline stuff).
<a name="line-433"></a>
<a name="line-434"></a>Note [INLINE for small functions]
<a name="line-435"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-436"></a>Consider        {-# INLINE f #-}
<a name="line-437"></a>                f x = Just x
<a name="line-438"></a>                g y = f y
<a name="line-439"></a>Then f's RHS is no larger than its LHS, so we should inline it into
<a name="line-440"></a>even the most boring context.  In general, f the function is
<a name="line-441"></a>sufficiently small that its body is as small as the call itself, the
<a name="line-442"></a>inline unconditionally, regardless of how boring the context is.
<a name="line-443"></a>
<a name="line-444"></a>Things to note:
<a name="line-445"></a>
<a name="line-446"></a>(1) We inline *unconditionally* if inlined thing is smaller (using sizeExpr)
<a name="line-447"></a>    than the thing it's replacing.  Notice that
<a name="line-448"></a>      (f x) --&gt; (g 3)             -- YES, unconditionally
<a name="line-449"></a>      (f x) --&gt; x : []            -- YES, *even though* there are two
<a name="line-450"></a>                                  --      arguments to the cons
<a name="line-451"></a>      x     --&gt; g 3               -- NO
<a name="line-452"></a>      x     --&gt; Just v            -- NO
<a name="line-453"></a>
<a name="line-454"></a>    It's very important not to unconditionally replace a variable by
<a name="line-455"></a>    a non-atomic term.
<a name="line-456"></a>
<a name="line-457"></a>(2) We do this even if the thing isn't saturated, else we end up with the
<a name="line-458"></a>    silly situation that
<a name="line-459"></a>       f x y = x
<a name="line-460"></a>       ...map (f 3)...
<a name="line-461"></a>    doesn't inline.  Even in a boring context, inlining without being
<a name="line-462"></a>    saturated will give a lambda instead of a PAP, and will be more
<a name="line-463"></a>    efficient at runtime.
<a name="line-464"></a>
<a name="line-465"></a>(3) However, when the function's arity &gt; 0, we do insist that it
<a name="line-466"></a>    has at least one value argument at the call site.  (This check is
<a name="line-467"></a>    made in the UnfWhen case of callSiteInline.) Otherwise we find this:
<a name="line-468"></a>         f = /\a \x:a. x
<a name="line-469"></a>         d = /\b. MkD (f b)
<a name="line-470"></a>    If we inline f here we get
<a name="line-471"></a>         d = /\b. MkD (\x:b. x)
<a name="line-472"></a>    and then prepareRhs floats out the argument, abstracting the type
<a name="line-473"></a>    variables, so we end up with the original again!
<a name="line-474"></a>
<a name="line-475"></a>(4) We must be much more cautious about arity-zero things. Consider
<a name="line-476"></a>       let x = y +# z in ...
<a name="line-477"></a>    In *size* terms primops look very small, because the generate a
<a name="line-478"></a>    single instruction, but we do not want to unconditionally replace
<a name="line-479"></a>    every occurrence of x with (y +# z).  So we only do the
<a name="line-480"></a>    unconditional-inline thing for *trivial* expressions.
<a name="line-481"></a>
<a name="line-482"></a>    NB: you might think that PostInlineUnconditionally would do this
<a name="line-483"></a>    but it doesn't fire for top-level things; see SimplUtils
<a name="line-484"></a>    Note [Top level and postInlineUnconditionally]
<a name="line-485"></a>-}</span>
<a name="line-486"></a>
<a name="line-487"></a><a name="uncondInline"></a><span class='hs-definition'>uncondInline</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-488"></a><span class='hs-comment'>-- Inline unconditionally if there no size increase</span>
<a name="line-489"></a><span class='hs-comment'>-- Size of call is arity (+1 for the function)</span>
<a name="line-490"></a><span class='hs-comment'>-- See Note [INLINE for small functions]</span>
<a name="line-491"></a><span class='hs-definition'>uncondInline</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>size</span>
<a name="line-492"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size</span> <span class='hs-varop'>&lt;=</span> <span class='hs-num'>10</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span><span class='hs-varid'>arity</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- See Note [INLINE for small functions] (1)</span>
<a name="line-493"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprIsTrivial</span> <span class='hs-varid'>rhs</span>        <span class='hs-comment'>-- See Note [INLINE for small functions] (4)</span>
<a name="line-494"></a>
<a name="line-495"></a><a name="sizeExpr"></a><span class='hs-definition'>sizeExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-496"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>             <span class='hs-comment'>-- Bomb out if it gets bigger than this</span>
<a name="line-497"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>            <span class='hs-comment'>-- Arguments; we're interested in which of these</span>
<a name="line-498"></a>                            <span class='hs-comment'>-- get case'd</span>
<a name="line-499"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-500"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSize</span>
<a name="line-501"></a>
<a name="line-502"></a><span class='hs-comment'>-- Note [Computing the size of an expression]</span>
<a name="line-503"></a>
<a name="line-504"></a><span class='hs-definition'>sizeExpr</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>bOMB_OUT_SIZE</span> <span class='hs-varid'>top_args</span> <span class='hs-varid'>expr</span>
<a name="line-505"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up</span> <span class='hs-varid'>expr</span>
<a name="line-506"></a>  <span class='hs-keyword'>where</span>
<a name="line-507"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up</span> <span class='hs-varid'>e</span>
<a name="line-508"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up</span> <span class='hs-varid'>e</span>
<a name="line-509"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sizeZero</span>           <span class='hs-comment'>-- Types cost nothing</span>
<a name="line-510"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sizeZero</span>
<a name="line-511"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sizeN</span> <span class='hs-layout'>(</span><span class='hs-varid'>litSize</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>
<a name="line-512"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isRealWorldId</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sizeZero</span>
<a name="line-513"></a>                      <span class='hs-comment'>-- Make sure we get constructor discounts even</span>
<a name="line-514"></a>                      <span class='hs-comment'>-- on nullary constructors</span>
<a name="line-515"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up_call</span> <span class='hs-varid'>f</span> <span class='hs-conid'>[]</span> <span class='hs-num'>0</span>
<a name="line-516"></a>
<a name="line-517"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-518"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyCoArg</span> <span class='hs-varid'>arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up</span> <span class='hs-varid'>fun</span>
<a name="line-519"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up</span> <span class='hs-varid'>arg</span>  <span class='hs-varop'>`addSizeNSD`</span>
<a name="line-520"></a>                        <span class='hs-varid'>size_up_app</span> <span class='hs-varid'>fun</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>isRealWorldExpr</span> <span class='hs-varid'>arg</span> <span class='hs-keyword'>then</span> <span class='hs-num'>1</span> <span class='hs-keyword'>else</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-521"></a>
<a name="line-522"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-523"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>b</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isRealWorldId</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lamScrutDiscount</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>size_up</span> <span class='hs-varid'>e</span> <span class='hs-varop'>`addSizeN`</span> <span class='hs-num'>10</span><span class='hs-layout'>)</span>
<a name="line-524"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up</span> <span class='hs-varid'>e</span>
<a name="line-525"></a>
<a name="line-526"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>binder</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-527"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up_rhs</span> <span class='hs-layout'>(</span><span class='hs-varid'>binder</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-varop'>`addSizeNSD`</span>
<a name="line-528"></a>        <span class='hs-varid'>size_up</span> <span class='hs-varid'>body</span>              <span class='hs-varop'>`addSizeN`</span>
<a name="line-529"></a>        <span class='hs-varid'>size_up_alloc</span> <span class='hs-varid'>binder</span>
<a name="line-530"></a>
<a name="line-531"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-532"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>addSizeNSD</span> <span class='hs-varop'>.</span> <span class='hs-varid'>size_up_rhs</span><span class='hs-layout'>)</span>
<a name="line-533"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>size_up</span> <span class='hs-varid'>body</span> <span class='hs-varop'>`addSizeN`</span> <span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>size_up_alloc</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-534"></a>              <span class='hs-varid'>pairs</span>
<a name="line-535"></a>
<a name="line-536"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-537"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>alts</span>
<a name="line-538"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up</span> <span class='hs-varid'>e</span>    <span class='hs-comment'>-- case e of {} never returns, so take size of scrutinee</span>
<a name="line-539"></a>
<a name="line-540"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-541"></a>        <span class='hs-comment'>-- Now alts is non-empty</span>
<a name="line-542"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>is_top_arg</span> <span class='hs-varid'>e</span> <span class='hs-comment'>-- We are scrutinising an argument variable</span>
<a name="line-543"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>
<a name="line-544"></a>            <span class='hs-varid'>alt_sizes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>size_up_alt</span> <span class='hs-varid'>alts</span>
<a name="line-545"></a>
<a name="line-546"></a>                  <span class='hs-comment'>-- alts_size tries to compute a good discount for</span>
<a name="line-547"></a>                  <span class='hs-comment'>-- the case when we are scrutinising an argument variable</span>
<a name="line-548"></a>            <span class='hs-varid'>alts_size</span> <span class='hs-layout'>(</span><span class='hs-conid'>SizeIs</span> <span class='hs-varid'>tot</span> <span class='hs-varid'>tot_disc</span> <span class='hs-varid'>tot_scrut</span><span class='hs-layout'>)</span>
<a name="line-549"></a>                          <span class='hs-comment'>-- Size of all alternatives</span>
<a name="line-550"></a>                      <span class='hs-layout'>(</span><span class='hs-conid'>SizeIs</span> <span class='hs-varid'>max</span> <span class='hs-keyword'>_</span>        <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-551"></a>                          <span class='hs-comment'>-- Size of biggest alternative</span>
<a name="line-552"></a>                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SizeIs</span> <span class='hs-varid'>tot</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-num'>20</span> <span class='hs-varop'>+</span> <span class='hs-varid'>tot</span> <span class='hs-comment'>-</span> <span class='hs-varid'>max</span><span class='hs-layout'>)</span>
<a name="line-553"></a>                      <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>tot_disc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tot_scrut</span>
<a name="line-554"></a>                          <span class='hs-comment'>-- If the variable is known, we produce a</span>
<a name="line-555"></a>                          <span class='hs-comment'>-- discount that will take us back to 'max',</span>
<a name="line-556"></a>                          <span class='hs-comment'>-- the size of the largest alternative The</span>
<a name="line-557"></a>                          <span class='hs-comment'>-- 1+ is a little discount for reduced</span>
<a name="line-558"></a>                          <span class='hs-comment'>-- allocation in the caller</span>
<a name="line-559"></a>                          <span class='hs-comment'>--</span>
<a name="line-560"></a>                          <span class='hs-comment'>-- Notice though, that we return tot_disc,</span>
<a name="line-561"></a>                          <span class='hs-comment'>-- the total discount from all branches.  I</span>
<a name="line-562"></a>                          <span class='hs-comment'>-- think that's right.</span>
<a name="line-563"></a>
<a name="line-564"></a>            <span class='hs-varid'>alts_size</span> <span class='hs-varid'>tot_size</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tot_size</span>
<a name="line-565"></a>          <span class='hs-keyword'>in</span>
<a name="line-566"></a>          <span class='hs-varid'>alts_size</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr1</span> <span class='hs-varid'>addAltSize</span> <span class='hs-varid'>alt_sizes</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- alts is non-empty</span>
<a name="line-567"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>foldr1</span> <span class='hs-varid'>maxSize</span>    <span class='hs-varid'>alt_sizes</span><span class='hs-layout'>)</span>
<a name="line-568"></a>                <span class='hs-comment'>-- Good to inline if an arg is scrutinised, because</span>
<a name="line-569"></a>                <span class='hs-comment'>-- that may eliminate allocation in the caller</span>
<a name="line-570"></a>                <span class='hs-comment'>-- And it eliminates the case itself</span>
<a name="line-571"></a>        <span class='hs-keyword'>where</span>
<a name="line-572"></a>          <span class='hs-varid'>is_top_arg</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>top_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>v</span>
<a name="line-573"></a>          <span class='hs-varid'>is_top_arg</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_top_arg</span> <span class='hs-varid'>e</span>
<a name="line-574"></a>          <span class='hs-varid'>is_top_arg</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-575"></a>
<a name="line-576"></a>
<a name="line-577"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up</span> <span class='hs-varid'>e</span>  <span class='hs-varop'>`addSizeNSD`</span>
<a name="line-578"></a>                                <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>addAltSize</span> <span class='hs-varop'>.</span> <span class='hs-varid'>size_up_alt</span><span class='hs-layout'>)</span> <span class='hs-varid'>case_size</span> <span class='hs-varid'>alts</span>
<a name="line-579"></a>      <span class='hs-keyword'>where</span>
<a name="line-580"></a>          <span class='hs-varid'>case_size</span>
<a name="line-581"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_inline_scrut</span> <span class='hs-varid'>e</span><span class='hs-layout'>,</span> <span class='hs-varid'>lengthAtMost</span> <span class='hs-varid'>alts</span> <span class='hs-num'>1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sizeN</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-num'>10</span><span class='hs-layout'>)</span>
<a name="line-582"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sizeZero</span>
<a name="line-583"></a>                <span class='hs-comment'>-- Normally we don't charge for the case itself, but</span>
<a name="line-584"></a>                <span class='hs-comment'>-- we charge one per alternative (see size_up_alt,</span>
<a name="line-585"></a>                <span class='hs-comment'>-- below) to account for the cost of the info table</span>
<a name="line-586"></a>                <span class='hs-comment'>-- and comparisons.</span>
<a name="line-587"></a>                <span class='hs-comment'>--</span>
<a name="line-588"></a>                <span class='hs-comment'>-- However, in certain cases (see is_inline_scrut</span>
<a name="line-589"></a>                <span class='hs-comment'>-- below), no code is generated for the case unless</span>
<a name="line-590"></a>                <span class='hs-comment'>-- there are multiple alts.  In these cases we</span>
<a name="line-591"></a>                <span class='hs-comment'>-- subtract one, making the first alt free.</span>
<a name="line-592"></a>                <span class='hs-comment'>-- e.g. case x# +# y# of _ -&gt; ...   should cost 1</span>
<a name="line-593"></a>                <span class='hs-comment'>--      case touch# x# of _ -&gt; ...  should cost 0</span>
<a name="line-594"></a>                <span class='hs-comment'>-- (see #4978)</span>
<a name="line-595"></a>                <span class='hs-comment'>--</span>
<a name="line-596"></a>                <span class='hs-comment'>-- I would like to not have the "lengthAtMost alts 1"</span>
<a name="line-597"></a>                <span class='hs-comment'>-- condition above, but without that some programs got worse</span>
<a name="line-598"></a>                <span class='hs-comment'>-- (spectral/hartel/event and spectral/para).  I don't fully</span>
<a name="line-599"></a>                <span class='hs-comment'>-- understand why. (SDM 24/5/11)</span>
<a name="line-600"></a>
<a name="line-601"></a>                <span class='hs-comment'>-- unboxed variables, inline primops and unsafe foreign calls</span>
<a name="line-602"></a>                <span class='hs-comment'>-- are all "inline" things:</span>
<a name="line-603"></a>          <span class='hs-varid'>is_inline_scrut</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isUnliftedType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-604"></a>          <span class='hs-varid'>is_inline_scrut</span> <span class='hs-varid'>scrut</span>
<a name="line-605"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>f</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>collectArgs</span> <span class='hs-varid'>scrut</span>
<a name="line-606"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>idDetails</span> <span class='hs-varid'>f</span> <span class='hs-keyword'>of</span>
<a name="line-607"></a>                    <span class='hs-conid'>FCallId</span> <span class='hs-varid'>fc</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSafeForeignCall</span> <span class='hs-varid'>fc</span><span class='hs-layout'>)</span>
<a name="line-608"></a>                    <span class='hs-conid'>PrimOpId</span> <span class='hs-varid'>op</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpOutOfLine</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-609"></a>                    <span class='hs-sel'>_other</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-610"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-611"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-612"></a>
<a name="line-613"></a>    <span class='hs-varid'>size_up_rhs</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-614"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>join_arity</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isJoinId_maybe</span> <span class='hs-varid'>bndr</span>
<a name="line-615"></a>        <span class='hs-comment'>-- Skip arguments to join point</span>
<a name="line-616"></a>      <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-sel'>_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>collectNBinders</span> <span class='hs-varid'>join_arity</span> <span class='hs-varid'>rhs</span>
<a name="line-617"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up</span> <span class='hs-varid'>body</span>
<a name="line-618"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-619"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up</span> <span class='hs-varid'>rhs</span>
<a name="line-620"></a>
<a name="line-621"></a>    <span class='hs-comment'>------------</span>
<a name="line-622"></a>    <span class='hs-comment'>-- size_up_app is used when there's ONE OR MORE value args</span>
<a name="line-623"></a>    <span class='hs-varid'>size_up_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-varid'>voids</span>
<a name="line-624"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyCoArg</span> <span class='hs-varid'>arg</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up_app</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>args</span> <span class='hs-varid'>voids</span>
<a name="line-625"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isRealWorldExpr</span> <span class='hs-varid'>arg</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up_app</span> <span class='hs-varid'>fun</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>voids</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-626"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up</span> <span class='hs-varid'>arg</span>  <span class='hs-varop'>`addSizeNSD`</span>
<a name="line-627"></a>                                           <span class='hs-varid'>size_up_app</span> <span class='hs-varid'>fun</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varid'>voids</span>
<a name="line-628"></a>    <span class='hs-varid'>size_up_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span>     <span class='hs-varid'>args</span> <span class='hs-varid'>voids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up_call</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>args</span> <span class='hs-varid'>voids</span>
<a name="line-629"></a>    <span class='hs-varid'>size_up_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-varid'>voids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up_app</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>args</span> <span class='hs-varid'>voids</span>
<a name="line-630"></a>    <span class='hs-varid'>size_up_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>expr</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-varid'>voids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up_app</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>args</span> <span class='hs-varid'>voids</span>
<a name="line-631"></a>    <span class='hs-varid'>size_up_app</span> <span class='hs-varid'>other</span>         <span class='hs-varid'>args</span> <span class='hs-varid'>voids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up</span> <span class='hs-varid'>other</span> <span class='hs-varop'>`addSizeN`</span>
<a name="line-632"></a>                                           <span class='hs-varid'>callSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varid'>voids</span>
<a name="line-633"></a>       <span class='hs-comment'>-- if the lhs is not an App or a Var, or an invisible thing like a</span>
<a name="line-634"></a>       <span class='hs-comment'>-- Tick or Cast, then we should charge for a complete call plus the</span>
<a name="line-635"></a>       <span class='hs-comment'>-- size of the lhs itself.</span>
<a name="line-636"></a>
<a name="line-637"></a>    <span class='hs-comment'>------------</span>
<a name="line-638"></a>    <span class='hs-varid'>size_up_call</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreExpr</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSize</span>
<a name="line-639"></a>    <span class='hs-varid'>size_up_call</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>val_args</span> <span class='hs-varid'>voids</span>
<a name="line-640"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>idDetails</span> <span class='hs-varid'>fun</span> <span class='hs-keyword'>of</span>
<a name="line-641"></a>           <span class='hs-conid'>FCallId</span> <span class='hs-keyword'>_</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sizeN</span> <span class='hs-layout'>(</span><span class='hs-varid'>callSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>val_args</span><span class='hs-layout'>)</span> <span class='hs-varid'>voids</span><span class='hs-layout'>)</span>
<a name="line-642"></a>           <span class='hs-conid'>DataConWorkId</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>conSize</span>    <span class='hs-varid'>dc</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>val_args</span><span class='hs-layout'>)</span>
<a name="line-643"></a>           <span class='hs-conid'>PrimOpId</span> <span class='hs-varid'>op</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>primOpSize</span> <span class='hs-varid'>op</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>val_args</span><span class='hs-layout'>)</span>
<a name="line-644"></a>           <span class='hs-conid'>ClassOpId</span> <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>classOpSize</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>top_args</span> <span class='hs-varid'>val_args</span>
<a name="line-645"></a>           <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>funSize</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>top_args</span> <span class='hs-varid'>fun</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>val_args</span><span class='hs-layout'>)</span> <span class='hs-varid'>voids</span>
<a name="line-646"></a>
<a name="line-647"></a>    <span class='hs-comment'>------------</span>
<a name="line-648"></a>    <span class='hs-varid'>size_up_alt</span> <span class='hs-layout'>(</span><span class='hs-sel'>_con</span><span class='hs-layout'>,</span> <span class='hs-sel'>_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up</span> <span class='hs-varid'>rhs</span> <span class='hs-varop'>`addSizeN`</span> <span class='hs-num'>10</span>
<a name="line-649"></a>        <span class='hs-comment'>-- Don't charge for args, so that wrappers look cheap</span>
<a name="line-650"></a>        <span class='hs-comment'>-- (See comments about wrappers with Case)</span>
<a name="line-651"></a>        <span class='hs-comment'>--</span>
<a name="line-652"></a>        <span class='hs-comment'>-- IMPORTANT: *do* charge 1 for the alternative, else we</span>
<a name="line-653"></a>        <span class='hs-comment'>-- find that giant case nests are treated as practically free</span>
<a name="line-654"></a>        <span class='hs-comment'>-- A good example is Foreign.C.Error.errnoToIOError</span>
<a name="line-655"></a>
<a name="line-656"></a>    <span class='hs-comment'>------------</span>
<a name="line-657"></a>    <span class='hs-comment'>-- Cost to allocate binding with given binder</span>
<a name="line-658"></a>    <span class='hs-varid'>size_up_alloc</span> <span class='hs-varid'>bndr</span>
<a name="line-659"></a>      <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>bndr</span>                 <span class='hs-comment'>-- Doesn't exist at runtime</span>
<a name="line-660"></a>      <span class='hs-varop'>||</span> <span class='hs-varid'>isJoinId</span> <span class='hs-varid'>bndr</span>                <span class='hs-comment'>-- Not allocated at all</span>
<a name="line-661"></a>      <span class='hs-varop'>||</span> <span class='hs-varid'>isUnliftedType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Doesn't live in heap</span>
<a name="line-662"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-663"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-664"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-num'>10</span>
<a name="line-665"></a>
<a name="line-666"></a>    <span class='hs-comment'>------------</span>
<a name="line-667"></a>        <span class='hs-comment'>-- These addSize things have to be here because</span>
<a name="line-668"></a>        <span class='hs-comment'>-- I don't want to give them bOMB_OUT_SIZE as an argument</span>
<a name="line-669"></a>    <span class='hs-varid'>addSizeN</span> <span class='hs-conid'>TooBig</span>          <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TooBig</span>
<a name="line-670"></a>    <span class='hs-varid'>addSizeN</span> <span class='hs-layout'>(</span><span class='hs-conid'>SizeIs</span> <span class='hs-varid'>n</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSizeIs</span> <span class='hs-varid'>bOMB_OUT_SIZE</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-varop'>+</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>d</span>
<a name="line-671"></a>
<a name="line-672"></a>        <span class='hs-comment'>-- addAltSize is used to add the sizes of case alternatives</span>
<a name="line-673"></a>    <span class='hs-varid'>addAltSize</span> <span class='hs-conid'>TooBig</span>            <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TooBig</span>
<a name="line-674"></a>    <span class='hs-varid'>addAltSize</span> <span class='hs-keyword'>_</span>                 <span class='hs-conid'>TooBig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TooBig</span>
<a name="line-675"></a>    <span class='hs-varid'>addAltSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>SizeIs</span> <span class='hs-varid'>n1</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>d1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SizeIs</span> <span class='hs-varid'>n2</span> <span class='hs-varid'>ys</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span>
<a name="line-676"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSizeIs</span> <span class='hs-varid'>bOMB_OUT_SIZE</span> <span class='hs-layout'>(</span><span class='hs-varid'>n1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span>
<a name="line-677"></a>                                 <span class='hs-layout'>(</span><span class='hs-varid'>xs</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span>
<a name="line-678"></a>                                 <span class='hs-layout'>(</span><span class='hs-varid'>d1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Note [addAltSize result discounts]</span>
<a name="line-679"></a>
<a name="line-680"></a>        <span class='hs-comment'>-- This variant ignores the result discount from its LEFT argument</span>
<a name="line-681"></a>        <span class='hs-comment'>-- It's used when the second argument isn't part of the result</span>
<a name="line-682"></a>    <span class='hs-varid'>addSizeNSD</span> <span class='hs-conid'>TooBig</span>            <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TooBig</span>
<a name="line-683"></a>    <span class='hs-varid'>addSizeNSD</span> <span class='hs-keyword'>_</span>                 <span class='hs-conid'>TooBig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TooBig</span>
<a name="line-684"></a>    <span class='hs-varid'>addSizeNSD</span> <span class='hs-layout'>(</span><span class='hs-conid'>SizeIs</span> <span class='hs-varid'>n1</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SizeIs</span> <span class='hs-varid'>n2</span> <span class='hs-varid'>ys</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span>
<a name="line-685"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSizeIs</span> <span class='hs-varid'>bOMB_OUT_SIZE</span> <span class='hs-layout'>(</span><span class='hs-varid'>n1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span>
<a name="line-686"></a>                                 <span class='hs-layout'>(</span><span class='hs-varid'>xs</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span>
<a name="line-687"></a>                                 <span class='hs-varid'>d2</span>  <span class='hs-comment'>-- Ignore d1</span>
<a name="line-688"></a>
<a name="line-689"></a>    <span class='hs-varid'>isRealWorldId</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>id</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>realWorldStatePrimTy</span>
<a name="line-690"></a>
<a name="line-691"></a>    <span class='hs-comment'>-- an expression of type State# RealWorld must be a variable</span>
<a name="line-692"></a>    <span class='hs-varid'>isRealWorldExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isRealWorldId</span> <span class='hs-varid'>id</span>
<a name="line-693"></a>    <span class='hs-varid'>isRealWorldExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isRealWorldExpr</span> <span class='hs-varid'>e</span>
<a name="line-694"></a>    <span class='hs-varid'>isRealWorldExpr</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-695"></a>
<a name="line-696"></a><a name="litSize"></a><span class='hs-comment'>-- | Finds a nominal size of a string literal.</span>
<a name="line-697"></a><span class='hs-definition'>litSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Literal</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-698"></a><span class='hs-comment'>-- Used by CoreUnfold.sizeExpr</span>
<a name="line-699"></a><span class='hs-definition'>litSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitInteger</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>100</span>   <span class='hs-comment'>-- Note [Size of literal integers]</span>
<a name="line-700"></a><span class='hs-definition'>litSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>MachStr</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-num'>10</span> <span class='hs-varop'>+</span> <span class='hs-num'>10</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>BS</span><span class='hs-varop'>.</span><span class='hs-varid'>length</span> <span class='hs-varid'>str</span> <span class='hs-varop'>+</span> <span class='hs-num'>3</span><span class='hs-layout'>)</span> <span class='hs-varop'>`div`</span> <span class='hs-num'>4</span><span class='hs-layout'>)</span>
<a name="line-701"></a>        <span class='hs-comment'>-- If size could be 0 then @f "x"@ might be too small</span>
<a name="line-702"></a>        <span class='hs-comment'>-- [Sept03: make literal strings a bit bigger to avoid fruitless</span>
<a name="line-703"></a>        <span class='hs-comment'>--  duplication of little strings]</span>
<a name="line-704"></a><span class='hs-definition'>litSize</span> <span class='hs-sel'>_other</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>    <span class='hs-comment'>-- Must match size of nullary constructors</span>
<a name="line-705"></a>                      <span class='hs-comment'>-- Key point: if  x |-&gt; 4, then x must inline unconditionally</span>
<a name="line-706"></a>                      <span class='hs-comment'>--            (eg via case binding)</span>
<a name="line-707"></a>
<a name="line-708"></a><a name="classOpSize"></a><span class='hs-definition'>classOpSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreExpr</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSize</span>
<a name="line-709"></a><span class='hs-comment'>-- See Note [Conlike is interesting]</span>
<a name="line-710"></a><span class='hs-definition'>classOpSize</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span>
<a name="line-711"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sizeZero</span>
<a name="line-712"></a><span class='hs-definition'>classOpSize</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>top_args</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg1</span> <span class='hs-conop'>:</span> <span class='hs-varid'>other_args</span><span class='hs-layout'>)</span>
<a name="line-713"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SizeIs</span> <span class='hs-varid'>size</span> <span class='hs-varid'>arg_discount</span> <span class='hs-num'>0</span>
<a name="line-714"></a>  <span class='hs-keyword'>where</span>
<a name="line-715"></a>    <span class='hs-varid'>size</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>20</span> <span class='hs-varop'>+</span> <span class='hs-layout'>(</span><span class='hs-num'>10</span> <span class='hs-varop'>*</span> <span class='hs-varid'>length</span> <span class='hs-varid'>other_args</span><span class='hs-layout'>)</span>
<a name="line-716"></a>    <span class='hs-comment'>-- If the class op is scrutinising a lambda bound dictionary then</span>
<a name="line-717"></a>    <span class='hs-comment'>-- give it a discount, to encourage the inlining of this function</span>
<a name="line-718"></a>    <span class='hs-comment'>-- The actual discount is rather arbitrarily chosen</span>
<a name="line-719"></a>    <span class='hs-varid'>arg_discount</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>arg1</span> <span class='hs-keyword'>of</span>
<a name="line-720"></a>                     <span class='hs-conid'>Var</span> <span class='hs-varid'>dict</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>dict</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>top_args</span>
<a name="line-721"></a>                              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unitBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>dict</span><span class='hs-layout'>,</span> <span class='hs-varid'>ufDictDiscount</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-722"></a>                     <span class='hs-sel'>_other</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>emptyBag</span>
<a name="line-723"></a>
<a name="line-724"></a><a name="callSize"></a><span class='hs-comment'>-- | The size of a function call</span>
<a name="line-725"></a><span class='hs-definition'>callSize</span>
<a name="line-726"></a> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>  <span class='hs-comment'>-- ^ number of value args</span>
<a name="line-727"></a> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>  <span class='hs-comment'>-- ^ number of value args that are void</span>
<a name="line-728"></a> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-729"></a><span class='hs-definition'>callSize</span> <span class='hs-varid'>n_val_args</span> <span class='hs-varid'>voids</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>10</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>n_val_args</span> <span class='hs-comment'>-</span> <span class='hs-varid'>voids</span><span class='hs-layout'>)</span>
<a name="line-730"></a>        <span class='hs-comment'>-- The 1+ is for the function itself</span>
<a name="line-731"></a>        <span class='hs-comment'>-- Add 1 for each non-trivial arg;</span>
<a name="line-732"></a>        <span class='hs-comment'>-- the allocation cost, as in let(rec)</span>
<a name="line-733"></a>
<a name="line-734"></a><a name="jumpSize"></a><span class='hs-comment'>-- | The size of a jump to a join point</span>
<a name="line-735"></a><span class='hs-definition'>jumpSize</span>
<a name="line-736"></a> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>  <span class='hs-comment'>-- ^ number of value args</span>
<a name="line-737"></a> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>  <span class='hs-comment'>-- ^ number of value args that are void</span>
<a name="line-738"></a> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-739"></a><span class='hs-definition'>jumpSize</span> <span class='hs-varid'>n_val_args</span> <span class='hs-varid'>voids</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>2</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>n_val_args</span> <span class='hs-comment'>-</span> <span class='hs-varid'>voids</span><span class='hs-layout'>)</span>
<a name="line-740"></a>  <span class='hs-comment'>-- A jump is 20% the size of a function call. Making jumps free reopens</span>
<a name="line-741"></a>  <span class='hs-comment'>-- bug #6048, but making them any more expensive loses a 21% improvement in</span>
<a name="line-742"></a>  <span class='hs-comment'>-- spectral/puzzle. TODO Perhaps adjusting the default threshold would be a</span>
<a name="line-743"></a>  <span class='hs-comment'>-- better solution?</span>
<a name="line-744"></a>
<a name="line-745"></a><a name="funSize"></a><span class='hs-definition'>funSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSize</span>
<a name="line-746"></a><span class='hs-comment'>-- Size for functions that are not constructors or primops</span>
<a name="line-747"></a><span class='hs-comment'>-- Note [Function applications]</span>
<a name="line-748"></a><span class='hs-definition'>funSize</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>top_args</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>n_val_args</span> <span class='hs-varid'>voids</span>
<a name="line-749"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>buildIdKey</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>buildSize</span>
<a name="line-750"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>augmentIdKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>augmentSize</span>
<a name="line-751"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SizeIs</span> <span class='hs-varid'>size</span> <span class='hs-varid'>arg_discount</span> <span class='hs-varid'>res_discount</span>
<a name="line-752"></a>  <span class='hs-keyword'>where</span>
<a name="line-753"></a>    <span class='hs-varid'>some_val_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n_val_args</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span>
<a name="line-754"></a>    <span class='hs-varid'>is_join</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isJoinId</span> <span class='hs-varid'>fun</span>
<a name="line-755"></a>
<a name="line-756"></a>    <span class='hs-varid'>size</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_join</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>jumpSize</span> <span class='hs-varid'>n_val_args</span> <span class='hs-varid'>voids</span>
<a name="line-757"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>some_val_args</span>    <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-758"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>callSize</span> <span class='hs-varid'>n_val_args</span> <span class='hs-varid'>voids</span>
<a name="line-759"></a>
<a name="line-760"></a>        <span class='hs-comment'>--                  DISCOUNTS</span>
<a name="line-761"></a>        <span class='hs-comment'>--  See Note [Function and non-function discounts]</span>
<a name="line-762"></a>    <span class='hs-varid'>arg_discount</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>some_val_args</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>top_args</span>
<a name="line-763"></a>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun</span><span class='hs-layout'>,</span> <span class='hs-varid'>ufFunAppDiscount</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-764"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span>
<a name="line-765"></a>        <span class='hs-comment'>-- If the function is an argument and is applied</span>
<a name="line-766"></a>        <span class='hs-comment'>-- to some values, give it an arg-discount</span>
<a name="line-767"></a>
<a name="line-768"></a>    <span class='hs-varid'>res_discount</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>idArity</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>n_val_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ufFunAppDiscount</span> <span class='hs-varid'>dflags</span>
<a name="line-769"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-770"></a>        <span class='hs-comment'>-- If the function is partially applied, show a result discount</span>
<a name="line-771"></a><span class='hs-comment'>-- XXX maybe behave like ConSize for eval'd variable</span>
<a name="line-772"></a>
<a name="line-773"></a><a name="conSize"></a><span class='hs-definition'>conSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSize</span>
<a name="line-774"></a><span class='hs-definition'>conSize</span> <span class='hs-varid'>dc</span> <span class='hs-varid'>n_val_args</span>
<a name="line-775"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n_val_args</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SizeIs</span> <span class='hs-num'>0</span> <span class='hs-varid'>emptyBag</span> <span class='hs-num'>10</span>    <span class='hs-comment'>-- Like variables</span>
<a name="line-776"></a>
<a name="line-777"></a><span class='hs-comment'>-- See Note [Unboxed tuple size and result discount]</span>
<a name="line-778"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnboxedTupleCon</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SizeIs</span> <span class='hs-num'>0</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>(</span><span class='hs-num'>10</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>n_val_args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-779"></a>
<a name="line-780"></a><span class='hs-comment'>-- See Note [Constructor size and result discount]</span>
<a name="line-781"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SizeIs</span> <span class='hs-num'>10</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>(</span><span class='hs-num'>10</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>n_val_args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-782"></a>
<a name="line-783"></a><span class='hs-comment'>-- XXX still looks to large to me</span>
<a name="line-784"></a>
<a name="line-785"></a><span class='hs-comment'>{-
<a name="line-786"></a>Note [Constructor size and result discount]
<a name="line-787"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-788"></a>Treat a constructors application as size 10, regardless of how many
<a name="line-789"></a>arguments it has; we are keen to expose them (and we charge separately
<a name="line-790"></a>for their args).  We can't treat them as size zero, else we find that
<a name="line-791"></a>(Just x) has size 0, which is the same as a lone variable; and hence
<a name="line-792"></a>'v' will always be replaced by (Just x), where v is bound to Just x.
<a name="line-793"></a>
<a name="line-794"></a>The "result discount" is applied if the result of the call is
<a name="line-795"></a>scrutinised (say by a case).  For a constructor application that will
<a name="line-796"></a>mean the constructor application will disappear, so we don't need to
<a name="line-797"></a>charge it to the function.  So the discount should at least match the
<a name="line-798"></a>cost of the constructor application, namely 10.  But to give a bit
<a name="line-799"></a>of extra incentive we give a discount of 10*(1 + n_val_args).
<a name="line-800"></a>
<a name="line-801"></a>Simon M tried a MUCH bigger discount: (10 * (10 + n_val_args)),
<a name="line-802"></a>and said it was an "unambiguous win", but its terribly dangerous
<a name="line-803"></a>because a function with many many case branches, each finishing with
<a name="line-804"></a>a constructor, can have an arbitrarily large discount.  This led to
<a name="line-805"></a>terrible code bloat: see Trac #6099.
<a name="line-806"></a>
<a name="line-807"></a>Note [Unboxed tuple size and result discount]
<a name="line-808"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-809"></a>However, unboxed tuples count as size zero. I found occasions where we had
<a name="line-810"></a>        f x y z = case op# x y z of { s -&gt; (# s, () #) }
<a name="line-811"></a>and f wasn't getting inlined.
<a name="line-812"></a>
<a name="line-813"></a>I tried giving unboxed tuples a *result discount* of zero (see the
<a name="line-814"></a>commented-out line).  Why?  When returned as a result they do not
<a name="line-815"></a>allocate, so maybe we don't want to charge so much for them If you
<a name="line-816"></a>have a non-zero discount here, we find that workers often get inlined
<a name="line-817"></a>back into wrappers, because it look like
<a name="line-818"></a>    f x = case $wf x of (# a,b #) -&gt; (a,b)
<a name="line-819"></a>and we are keener because of the case.  However while this change
<a name="line-820"></a>shrank binary sizes by 0.5% it also made spectral/boyer allocate 5%
<a name="line-821"></a>more. All other changes were very small. So it's not a big deal but I
<a name="line-822"></a>didn't adopt the idea.
<a name="line-823"></a>
<a name="line-824"></a>Note [Function and non-function discounts]
<a name="line-825"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-826"></a>We want a discount if the function is applied. A good example is
<a name="line-827"></a>monadic combinators with continuation arguments, where inlining is
<a name="line-828"></a>quite important.
<a name="line-829"></a>
<a name="line-830"></a>But we don't want a big discount when a function is called many times
<a name="line-831"></a>(see the detailed comments with Trac #6048) because if the function is
<a name="line-832"></a>big it won't be inlined at its many call sites and no benefit results.
<a name="line-833"></a>Indeed, we can get exponentially big inlinings this way; that is what
<a name="line-834"></a>Trac #6048 is about.
<a name="line-835"></a>
<a name="line-836"></a>On the other hand, for data-valued arguments, if there are lots of
<a name="line-837"></a>case expressions in the body, each one will get smaller if we apply
<a name="line-838"></a>the function to a constructor application, so we *want* a big discount
<a name="line-839"></a>if the argument is scrutinised by many case expressions.
<a name="line-840"></a>
<a name="line-841"></a>Conclusion:
<a name="line-842"></a>  - For functions, take the max of the discounts
<a name="line-843"></a>  - For data values, take the sum of the discounts
<a name="line-844"></a>
<a name="line-845"></a>
<a name="line-846"></a>Note [Literal integer size]
<a name="line-847"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-848"></a>Literal integers *can* be big (mkInteger [...coefficients...]), but
<a name="line-849"></a>need not be (S# n).  We just use an arbitrary big-ish constant here
<a name="line-850"></a>so that, in particular, we don't inline top-level defns like
<a name="line-851"></a>   n = S# 5
<a name="line-852"></a>There's no point in doing so -- any optimisations will see the S#
<a name="line-853"></a>through n's unfolding.  Nor will a big size inhibit unfoldings functions
<a name="line-854"></a>that mention a literal Integer, because the float-out pass will float
<a name="line-855"></a>all those constants to top level.
<a name="line-856"></a>-}</span>
<a name="line-857"></a>
<a name="line-858"></a><a name="primOpSize"></a><span class='hs-definition'>primOpSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSize</span>
<a name="line-859"></a><span class='hs-definition'>primOpSize</span> <span class='hs-varid'>op</span> <span class='hs-varid'>n_val_args</span>
<a name="line-860"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>primOpOutOfLine</span> <span class='hs-varid'>op</span>
<a name="line-861"></a>      <span class='hs-keyword'>then</span> <span class='hs-varid'>sizeN</span> <span class='hs-layout'>(</span><span class='hs-varid'>op_size</span> <span class='hs-varop'>+</span> <span class='hs-varid'>n_val_args</span><span class='hs-layout'>)</span>
<a name="line-862"></a>      <span class='hs-keyword'>else</span> <span class='hs-varid'>sizeN</span> <span class='hs-varid'>op_size</span>
<a name="line-863"></a> <span class='hs-keyword'>where</span>
<a name="line-864"></a>   <span class='hs-varid'>op_size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>primOpCodeSize</span> <span class='hs-varid'>op</span>
<a name="line-865"></a>
<a name="line-866"></a>
<a name="line-867"></a><a name="buildSize"></a><span class='hs-definition'>buildSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExprSize</span>
<a name="line-868"></a><span class='hs-definition'>buildSize</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SizeIs</span> <span class='hs-num'>0</span> <span class='hs-varid'>emptyBag</span> <span class='hs-num'>40</span>
<a name="line-869"></a>        <span class='hs-comment'>-- We really want to inline applications of build</span>
<a name="line-870"></a>        <span class='hs-comment'>-- build t (\cn -&gt; e) should cost only the cost of e (because build will be inlined later)</span>
<a name="line-871"></a>        <span class='hs-comment'>-- Indeed, we should add a result_discount because build is</span>
<a name="line-872"></a>        <span class='hs-comment'>-- very like a constructor.  We don't bother to check that the</span>
<a name="line-873"></a>        <span class='hs-comment'>-- build is saturated (it usually is).  The "-2" discounts for the \c n,</span>
<a name="line-874"></a>        <span class='hs-comment'>-- The "4" is rather arbitrary.</span>
<a name="line-875"></a>
<a name="line-876"></a><a name="augmentSize"></a><span class='hs-definition'>augmentSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExprSize</span>
<a name="line-877"></a><span class='hs-definition'>augmentSize</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SizeIs</span> <span class='hs-num'>0</span> <span class='hs-varid'>emptyBag</span> <span class='hs-num'>40</span>
<a name="line-878"></a>        <span class='hs-comment'>-- Ditto (augment t (\cn -&gt; e) ys) should cost only the cost of</span>
<a name="line-879"></a>        <span class='hs-comment'>-- e plus ys. The -2 accounts for the \cn</span>
<a name="line-880"></a>
<a name="line-881"></a><a name="lamScrutDiscount"></a><span class='hs-comment'>-- When we return a lambda, give a discount if it's used (applied)</span>
<a name="line-882"></a><span class='hs-definition'>lamScrutDiscount</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSize</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSize</span>
<a name="line-883"></a><span class='hs-definition'>lamScrutDiscount</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-conid'>SizeIs</span> <span class='hs-varid'>n</span> <span class='hs-varid'>vs</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SizeIs</span> <span class='hs-varid'>n</span> <span class='hs-varid'>vs</span> <span class='hs-layout'>(</span><span class='hs-varid'>ufFunAppDiscount</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-884"></a><span class='hs-definition'>lamScrutDiscount</span> <span class='hs-keyword'>_</span>      <span class='hs-conid'>TooBig</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TooBig</span>
<a name="line-885"></a>
<a name="line-886"></a><span class='hs-comment'>{-
<a name="line-887"></a>Note [addAltSize result discounts]
<a name="line-888"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-889"></a>When adding the size of alternatives, we *add* the result discounts
<a name="line-890"></a>too, rather than take the *maximum*.  For a multi-branch case, this
<a name="line-891"></a>gives a discount for each branch that returns a constructor, making us
<a name="line-892"></a>keener to inline.  I did try using 'max' instead, but it makes nofib
<a name="line-893"></a>'rewrite' and 'puzzle' allocate significantly more, and didn't make
<a name="line-894"></a>binary sizes shrink significantly either.
<a name="line-895"></a>
<a name="line-896"></a>Note [Discounts and thresholds]
<a name="line-897"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-898"></a>Constants for discounts and thesholds are defined in main/DynFlags,
<a name="line-899"></a>all of form ufXxxx.   They are:
<a name="line-900"></a>
<a name="line-901"></a>ufCreationThreshold
<a name="line-902"></a>     At a definition site, if the unfolding is bigger than this, we
<a name="line-903"></a>     may discard it altogether
<a name="line-904"></a>
<a name="line-905"></a>ufUseThreshold
<a name="line-906"></a>     At a call site, if the unfolding, less discounts, is smaller than
<a name="line-907"></a>     this, then it's small enough inline
<a name="line-908"></a>
<a name="line-909"></a>ufKeenessFactor
<a name="line-910"></a>     Factor by which the discounts are multiplied before
<a name="line-911"></a>     subtracting from size
<a name="line-912"></a>
<a name="line-913"></a>ufDictDiscount
<a name="line-914"></a>     The discount for each occurrence of a dictionary argument
<a name="line-915"></a>     as an argument of a class method.  Should be pretty small
<a name="line-916"></a>     else big functions may get inlined
<a name="line-917"></a>
<a name="line-918"></a>ufFunAppDiscount
<a name="line-919"></a>     Discount for a function argument that is applied.  Quite
<a name="line-920"></a>     large, because if we inline we avoid the higher-order call.
<a name="line-921"></a>
<a name="line-922"></a>ufDearOp
<a name="line-923"></a>     The size of a foreign call or not-dupable PrimOp
<a name="line-924"></a>
<a name="line-925"></a>ufVeryAggressive
<a name="line-926"></a>     If True, the compiler ignores all the thresholds and inlines very
<a name="line-927"></a>     aggressively. It still adheres to arity, simplifier phase control and
<a name="line-928"></a>     loop breakers.
<a name="line-929"></a>
<a name="line-930"></a>
<a name="line-931"></a>Note [Function applications]
<a name="line-932"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-933"></a>In a function application (f a b)
<a name="line-934"></a>
<a name="line-935"></a>  - If 'f' is an argument to the function being analysed,
<a name="line-936"></a>    and there's at least one value arg, record a FunAppDiscount for f
<a name="line-937"></a>
<a name="line-938"></a>  - If the application if a PAP (arity &gt; 2 in this example)
<a name="line-939"></a>    record a *result* discount (because inlining
<a name="line-940"></a>    with "extra" args in the call may mean that we now
<a name="line-941"></a>    get a saturated application)
<a name="line-942"></a>
<a name="line-943"></a>Code for manipulating sizes
<a name="line-944"></a>-}</span>
<a name="line-945"></a>
<a name="line-946"></a><a name="ExprSize"></a><span class='hs-comment'>-- | The size of an candidate expression for unfolding</span>
<a name="line-947"></a><a name="ExprSize"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ExprSize</span>
<a name="line-948"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TooBig</span>
<a name="line-949"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SizeIs</span> <span class='hs-layout'>{</span> <span class='hs-sel'>_es_size_is</span>  <span class='hs-keyglyph'>::</span> <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Size found</span>
<a name="line-950"></a>             <span class='hs-layout'>,</span> <span class='hs-sel'>_es_args</span>     <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-951"></a>               <span class='hs-comment'>-- ^ Arguments cased herein, and discount for each such</span>
<a name="line-952"></a>             <span class='hs-layout'>,</span> <span class='hs-sel'>_es_discount</span> <span class='hs-keyglyph'>::</span> <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span>
<a name="line-953"></a>               <span class='hs-comment'>-- ^ Size to subtract if result is scrutinised by a case</span>
<a name="line-954"></a>               <span class='hs-comment'>-- expression</span>
<a name="line-955"></a>             <span class='hs-layout'>}</span>
<a name="line-956"></a>
<a name="line-957"></a><a name="instance%20Outputable%20ExprSize"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>ExprSize</span> <span class='hs-keyword'>where</span>
<a name="line-958"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>TooBig</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TooBig"</span>
<a name="line-959"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SizeIs</span> <span class='hs-varid'>a</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>int</span> <span class='hs-varid'>a</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-960"></a>
<a name="line-961"></a><a name="mkSizeIs"></a><span class='hs-comment'>-- subtract the discount before deciding whether to bale out. eg. we</span>
<a name="line-962"></a><span class='hs-comment'>-- want to inline a large constructor application into a selector:</span>
<a name="line-963"></a><span class='hs-comment'>--      tup = (a_1, ..., a_99)</span>
<a name="line-964"></a><span class='hs-comment'>--      x = case tup of ...</span>
<a name="line-965"></a><span class='hs-comment'>--</span>
<a name="line-966"></a><span class='hs-definition'>mkSizeIs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSize</span>
<a name="line-967"></a><span class='hs-definition'>mkSizeIs</span> <span class='hs-varid'>max</span> <span class='hs-varid'>n</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-comment'>-</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>max</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TooBig</span>
<a name="line-968"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SizeIs</span> <span class='hs-varid'>n</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>d</span>
<a name="line-969"></a>
<a name="line-970"></a><a name="maxSize"></a><span class='hs-definition'>maxSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExprSize</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSize</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSize</span>
<a name="line-971"></a><span class='hs-definition'>maxSize</span> <span class='hs-conid'>TooBig</span>         <span class='hs-keyword'>_</span>                                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TooBig</span>
<a name="line-972"></a><span class='hs-definition'>maxSize</span> <span class='hs-keyword'>_</span>              <span class='hs-conid'>TooBig</span>                             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TooBig</span>
<a name="line-973"></a><span class='hs-definition'>maxSize</span> <span class='hs-varid'>s1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SizeIs</span> <span class='hs-varid'>n1</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>s2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SizeIs</span> <span class='hs-varid'>n2</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n1</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>n2</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s1</span>
<a name="line-974"></a>                                              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s2</span>
<a name="line-975"></a>
<a name="line-976"></a><a name="sizeZero"></a><span class='hs-definition'>sizeZero</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExprSize</span>
<a name="line-977"></a><a name="sizeN"></a><span class='hs-definition'>sizeN</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSize</span>
<a name="line-978"></a>
<a name="line-979"></a><span class='hs-definition'>sizeZero</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SizeIs</span> <span class='hs-num'>0</span> <span class='hs-varid'>emptyBag</span> <span class='hs-num'>0</span>
<a name="line-980"></a><span class='hs-definition'>sizeN</span> <span class='hs-varid'>n</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SizeIs</span> <span class='hs-varid'>n</span> <span class='hs-varid'>emptyBag</span> <span class='hs-num'>0</span>
<a name="line-981"></a>
<a name="line-982"></a><span class='hs-comment'>{-
<a name="line-983"></a>************************************************************************
<a name="line-984"></a>*                                                                      *
<a name="line-985"></a>\subsection[considerUnfolding]{Given all the info, do (not) do the unfolding}
<a name="line-986"></a>*                                                                      *
<a name="line-987"></a>************************************************************************
<a name="line-988"></a>
<a name="line-989"></a>We use 'couldBeSmallEnoughToInline' to avoid exporting inlinings that
<a name="line-990"></a>we ``couldn't possibly use'' on the other side.  Can be overridden w/
<a name="line-991"></a>flaggery.  Just the same as smallEnoughToInline, except that it has no
<a name="line-992"></a>actual arguments.
<a name="line-993"></a>-}</span>
<a name="line-994"></a>
<a name="line-995"></a><a name="couldBeSmallEnoughToInline"></a><span class='hs-definition'>couldBeSmallEnoughToInline</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-996"></a><span class='hs-definition'>couldBeSmallEnoughToInline</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>threshold</span> <span class='hs-varid'>rhs</span>
<a name="line-997"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>sizeExpr</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>threshold</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>body</span> <span class='hs-keyword'>of</span>
<a name="line-998"></a>       <span class='hs-conid'>TooBig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-999"></a>       <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1000"></a>  <span class='hs-keyword'>where</span>
<a name="line-1001"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectBinders</span> <span class='hs-varid'>rhs</span>
<a name="line-1002"></a>
<a name="line-1003"></a><a name="smallEnoughToInline"></a><span class='hs-comment'>----------------</span>
<a name="line-1004"></a><span class='hs-definition'>smallEnoughToInline</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1005"></a><span class='hs-definition'>smallEnoughToInline</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreUnfolding</span> <span class='hs-layout'>{</span><span class='hs-varid'>uf_guidance</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnfIfGoodArgs</span> <span class='hs-layout'>{</span><span class='hs-varid'>ug_size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1006"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>ufUseThreshold</span> <span class='hs-varid'>dflags</span>
<a name="line-1007"></a><span class='hs-definition'>smallEnoughToInline</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-1008"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1009"></a>
<a name="line-1010"></a><span class='hs-comment'>----------------</span>
<a name="line-1011"></a>
<a name="line-1012"></a><a name="certainlyWillInline"></a><span class='hs-definition'>certainlyWillInline</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IdInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Unfolding</span>
<a name="line-1013"></a><span class='hs-comment'>-- Sees if the unfolding is pretty certain to inline</span>
<a name="line-1014"></a><span class='hs-comment'>-- If so, return a *stable* unfolding for it, that will always inline</span>
<a name="line-1015"></a><span class='hs-definition'>certainlyWillInline</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>fn_info</span>
<a name="line-1016"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>unfoldingInfo</span> <span class='hs-varid'>fn_info</span> <span class='hs-keyword'>of</span>
<a name="line-1017"></a>      <span class='hs-conid'>CoreUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uf_tmpl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>e</span><span class='hs-layout'>,</span> <span class='hs-varid'>uf_guidance</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>g</span> <span class='hs-layout'>}</span>
<a name="line-1018"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>loop_breaker</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>       <span class='hs-comment'>-- Won't inline, so try w/w</span>
<a name="line-1019"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>do_cunf</span> <span class='hs-varid'>e</span> <span class='hs-varid'>g</span>   <span class='hs-comment'>-- Depends on size, so look at that</span>
<a name="line-1020"></a>
<a name="line-1021"></a>      <span class='hs-conid'>DFunUnfolding</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>fn_unf</span>  <span class='hs-comment'>-- Don't w/w DFuns; it never makes sense</span>
<a name="line-1022"></a>                                       <span class='hs-comment'>-- to do so, and even if it is currently a</span>
<a name="line-1023"></a>                                       <span class='hs-comment'>-- loop breaker, it may not be later</span>
<a name="line-1024"></a>
<a name="line-1025"></a>      <span class='hs-sel'>_other_unf</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1026"></a>
<a name="line-1027"></a>  <span class='hs-keyword'>where</span>
<a name="line-1028"></a>    <span class='hs-varid'>loop_breaker</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isStrongLoopBreaker</span> <span class='hs-layout'>(</span><span class='hs-varid'>occInfo</span> <span class='hs-varid'>fn_info</span><span class='hs-layout'>)</span>
<a name="line-1029"></a>    <span class='hs-varid'>fn_unf</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unfoldingInfo</span> <span class='hs-varid'>fn_info</span>
<a name="line-1030"></a>
<a name="line-1031"></a>    <span class='hs-varid'>do_cunf</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnfoldingGuidance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Unfolding</span>
<a name="line-1032"></a>    <span class='hs-varid'>do_cunf</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>UnfNever</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1033"></a>    <span class='hs-varid'>do_cunf</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnfWhen</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>fn_unf</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uf_src</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InlineStable</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1034"></a>                             <span class='hs-comment'>-- INLINE functions have UnfWhen</span>
<a name="line-1035"></a>
<a name="line-1036"></a>        <span class='hs-comment'>-- The UnfIfGoodArgs case seems important.  If we w/w small functions</span>
<a name="line-1037"></a>        <span class='hs-comment'>-- binary sizes go up by 10%!  (This is with SplitObjs.)</span>
<a name="line-1038"></a>        <span class='hs-comment'>-- I'm not totally sure why.</span>
<a name="line-1039"></a>        <span class='hs-comment'>-- INLINABLE functions come via this path</span>
<a name="line-1040"></a>        <span class='hs-comment'>--    See Note [certainlyWillInline: INLINABLE]</span>
<a name="line-1041"></a>    <span class='hs-varid'>do_cunf</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnfIfGoodArgs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ug_size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size</span><span class='hs-layout'>,</span> <span class='hs-varid'>ug_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1042"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- See Note [certainlyWillInline: be careful of thunks]</span>
<a name="line-1043"></a>      <span class='hs-layout'>,</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>inlinePragmaSpec</span> <span class='hs-layout'>(</span><span class='hs-varid'>inlinePragInfo</span> <span class='hs-varid'>fn_info</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-1044"></a>          <span class='hs-conid'>NoInline</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span> <span class='hs-comment'>-- NOINLINE; do not say certainlyWillInline!</span>
<a name="line-1045"></a>          <span class='hs-keyword'>_</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>  <span class='hs-comment'>-- INLINE, INLINABLE, or nothing</span>
<a name="line-1046"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isBottomingSig</span> <span class='hs-layout'>(</span><span class='hs-varid'>strictnessInfo</span> <span class='hs-varid'>fn_info</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1047"></a>              <span class='hs-comment'>-- Do not unconditionally inline a bottoming functions even if</span>
<a name="line-1048"></a>              <span class='hs-comment'>-- it seems smallish. We've carefully lifted it out to top level,</span>
<a name="line-1049"></a>              <span class='hs-comment'>-- so we don't want to re-inline it.</span>
<a name="line-1050"></a>      <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>args</span>
<a name="line-1051"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>size</span> <span class='hs-comment'>-</span> <span class='hs-layout'>(</span><span class='hs-num'>10</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span><span class='hs-varid'>arity</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>ufUseThreshold</span> <span class='hs-varid'>dflags</span>
<a name="line-1052"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>fn_unf</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uf_src</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InlineStable</span>
<a name="line-1053"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>uf_guidance</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnfWhen</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ug_arity</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arity</span>
<a name="line-1054"></a>                                             <span class='hs-layout'>,</span> <span class='hs-varid'>ug_unsat_ok</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unSaturatedOk</span>
<a name="line-1055"></a>                                             <span class='hs-layout'>,</span> <span class='hs-varid'>ug_boring_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inlineBoringOk</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1056"></a>             <span class='hs-comment'>-- Note the "unsaturatedOk". A function like  f = \ab. a</span>
<a name="line-1057"></a>             <span class='hs-comment'>-- will certainly inline, even if partially applied (f e), so we'd</span>
<a name="line-1058"></a>             <span class='hs-comment'>-- better make sure that the transformed inlining has the same property</span>
<a name="line-1059"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1060"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1061"></a>
<a name="line-1062"></a><span class='hs-comment'>{- Note [certainlyWillInline: be careful of thunks]
<a name="line-1063"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1064"></a>Don't claim that thunks will certainly inline, because that risks work
<a name="line-1065"></a>duplication.  Even if the work duplication is not great (eg is_cheap
<a name="line-1066"></a>holds), it can make a big difference in an inner loop In Trac #5623 we
<a name="line-1067"></a>found that the WorkWrap phase thought that
<a name="line-1068"></a>       y = case x of F# v -&gt; F# (v +# v)
<a name="line-1069"></a>was certainlyWillInline, so the addition got duplicated.
<a name="line-1070"></a>
<a name="line-1071"></a>Note [certainlyWillInline: INLINABLE]
<a name="line-1072"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1073"></a>certainlyWillInline /must/ return Nothing for a large INLINABLE thing,
<a name="line-1074"></a>even though we have a stable inlining, so that strictness w/w takes
<a name="line-1075"></a>place.  It makes a big difference to efficiency, and the w/w pass knows
<a name="line-1076"></a>how to transfer the INLINABLE info to the worker; see WorkWrap
<a name="line-1077"></a>Note [Worker-wrapper for INLINABLE functions]
<a name="line-1078"></a>
<a name="line-1079"></a>************************************************************************
<a name="line-1080"></a>*                                                                      *
<a name="line-1081"></a>\subsection{callSiteInline}
<a name="line-1082"></a>*                                                                      *
<a name="line-1083"></a>************************************************************************
<a name="line-1084"></a>
<a name="line-1085"></a>This is the key function.  It decides whether to inline a variable at a call site
<a name="line-1086"></a>
<a name="line-1087"></a>callSiteInline is used at call sites, so it is a bit more generous.
<a name="line-1088"></a>It's a very important function that embodies lots of heuristics.
<a name="line-1089"></a>A non-WHNF can be inlined if it doesn't occur inside a lambda,
<a name="line-1090"></a>and occurs exactly once or
<a name="line-1091"></a>    occurs once in each branch of a case and is small
<a name="line-1092"></a>
<a name="line-1093"></a>If the thing is in WHNF, there's no danger of duplicating work,
<a name="line-1094"></a>so we can inline if it occurs once, or is small
<a name="line-1095"></a>
<a name="line-1096"></a>NOTE: we don't want to inline top-level functions that always diverge.
<a name="line-1097"></a>It just makes the code bigger.  Tt turns out that the convenient way to prevent
<a name="line-1098"></a>them inlining is to give them a NOINLINE pragma, which we do in
<a name="line-1099"></a>StrictAnal.addStrictnessInfoToTopId
<a name="line-1100"></a>-}</span>
<a name="line-1101"></a>
<a name="line-1102"></a><a name="callSiteInline"></a><span class='hs-definition'>callSiteInline</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-1103"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>                    <span class='hs-comment'>-- The Id</span>
<a name="line-1104"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>                  <span class='hs-comment'>-- True &lt;=&gt; unfolding is active</span>
<a name="line-1105"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>                  <span class='hs-comment'>-- True if there are no arguments at all (incl type args)</span>
<a name="line-1106"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ArgSummary</span><span class='hs-keyglyph'>]</span>          <span class='hs-comment'>-- One for each value arg; True if it is interesting</span>
<a name="line-1107"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CallCtxt</span>              <span class='hs-comment'>-- True &lt;=&gt; continuation is interesting</span>
<a name="line-1108"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CoreExpr</span>        <span class='hs-comment'>-- Unfolding, if any</span>
<a name="line-1109"></a>
<a name="line-1110"></a><a name="ArgSummary"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ArgSummary</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TrivArg</span>       <span class='hs-comment'>-- Nothing interesting</span>
<a name="line-1111"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NonTrivArg</span>    <span class='hs-comment'>-- Arg has structure</span>
<a name="line-1112"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ValueArg</span>      <span class='hs-comment'>-- Arg is a con-app or PAP</span>
<a name="line-1113"></a>                                <span class='hs-comment'>-- ..or con-like. Note [Conlike is interesting]</span>
<a name="line-1114"></a>
<a name="line-1115"></a><a name="instance%20Outputable%20ArgSummary"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>ArgSummary</span> <span class='hs-keyword'>where</span>
<a name="line-1116"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>TrivArg</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TrivArg"</span>
<a name="line-1117"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>NonTrivArg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"NonTrivArg"</span>
<a name="line-1118"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>ValueArg</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ValueArg"</span>
<a name="line-1119"></a>
<a name="line-1120"></a><a name="nonTriv"></a><span class='hs-definition'>nonTriv</span> <span class='hs-keyglyph'>::</span>  <span class='hs-conid'>ArgSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1121"></a><span class='hs-definition'>nonTriv</span> <span class='hs-conid'>TrivArg</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1122"></a><span class='hs-definition'>nonTriv</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1123"></a>
<a name="line-1124"></a><a name="CallCtxt"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CallCtxt</span>
<a name="line-1125"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BoringCtxt</span>
<a name="line-1126"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RhsCtxt</span>             <span class='hs-comment'>-- Rhs of a let-binding; see Note [RHS of lets]</span>
<a name="line-1127"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DiscArgCtxt</span>         <span class='hs-comment'>-- Argument of a function with non-zero arg discount</span>
<a name="line-1128"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RuleArgCtxt</span>         <span class='hs-comment'>-- We are somewhere in the argument of a function with rules</span>
<a name="line-1129"></a>
<a name="line-1130"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ValAppCtxt</span>          <span class='hs-comment'>-- We're applied to at least one value arg</span>
<a name="line-1131"></a>                        <span class='hs-comment'>-- This arises when we have ((f x |&gt; co) y)</span>
<a name="line-1132"></a>                        <span class='hs-comment'>-- Then the (f x) has argument 'x' but in a ValAppCtxt</span>
<a name="line-1133"></a>
<a name="line-1134"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CaseCtxt</span>            <span class='hs-comment'>-- We're the scrutinee of a case</span>
<a name="line-1135"></a>                        <span class='hs-comment'>-- that decomposes its scrutinee</span>
<a name="line-1136"></a>
<a name="line-1137"></a><a name="instance%20Outputable%20CallCtxt"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>CallCtxt</span> <span class='hs-keyword'>where</span>
<a name="line-1138"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>CaseCtxt</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"CaseCtxt"</span>
<a name="line-1139"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>ValAppCtxt</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ValAppCtxt"</span>
<a name="line-1140"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>BoringCtxt</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"BoringCtxt"</span>
<a name="line-1141"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>RhsCtxt</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"RhsCtxt"</span>
<a name="line-1142"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>DiscArgCtxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"DiscArgCtxt"</span>
<a name="line-1143"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>RuleArgCtxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"RuleArgCtxt"</span>
<a name="line-1144"></a>
<a name="line-1145"></a><span class='hs-definition'>callSiteInline</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>id</span> <span class='hs-varid'>active_unfolding</span> <span class='hs-varid'>lone_variable</span> <span class='hs-varid'>arg_infos</span> <span class='hs-varid'>cont_info</span>
<a name="line-1146"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>idUnfolding</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-1147"></a>      <span class='hs-comment'>-- idUnfolding checks for loop-breakers, returning NoUnfolding</span>
<a name="line-1148"></a>      <span class='hs-comment'>-- Things with an INLINE pragma may have an unfolding *and*</span>
<a name="line-1149"></a>      <span class='hs-comment'>-- be a loop breaker  (maybe the knot is not yet untied)</span>
<a name="line-1150"></a>        <span class='hs-conid'>CoreUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uf_tmpl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unf_template</span><span class='hs-layout'>,</span> <span class='hs-varid'>uf_is_top</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_top</span>
<a name="line-1151"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>uf_is_work_free</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_wf</span>
<a name="line-1152"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>uf_guidance</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>guidance</span><span class='hs-layout'>,</span> <span class='hs-varid'>uf_expandable</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_exp</span> <span class='hs-layout'>}</span>
<a name="line-1153"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>active_unfolding</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tryUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>id</span> <span class='hs-varid'>lone_variable</span>
<a name="line-1154"></a>                                    <span class='hs-varid'>arg_infos</span> <span class='hs-varid'>cont_info</span> <span class='hs-varid'>unf_template</span> <span class='hs-varid'>is_top</span>
<a name="line-1155"></a>                                    <span class='hs-varid'>is_wf</span> <span class='hs-varid'>is_exp</span> <span class='hs-varid'>guidance</span>
<a name="line-1156"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>traceInline</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"Inactive unfolding:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-conid'>Nothing</span>
<a name="line-1157"></a>        <span class='hs-conid'>NoUnfolding</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1158"></a>        <span class='hs-conid'>BootUnfolding</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1159"></a>        <span class='hs-conid'>OtherCon</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1160"></a>        <span class='hs-conid'>DFunUnfolding</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>     <span class='hs-comment'>-- Never unfold a DFun</span>
<a name="line-1161"></a>
<a name="line-1162"></a><a name="traceInline"></a><span class='hs-definition'>traceInline</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-1163"></a><span class='hs-definition'>traceInline</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>str</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>result</span>
<a name="line-1164"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_inlinings</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_verbose_core2core</span> <span class='hs-varid'>dflags</span>
<a name="line-1165"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTrace</span> <span class='hs-varid'>str</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>result</span>
<a name="line-1166"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1167"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>result</span>
<a name="line-1168"></a>
<a name="line-1169"></a><a name="tryUnfolding"></a><span class='hs-definition'>tryUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ArgSummary</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CallCtxt</span>
<a name="line-1170"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnfoldingGuidance</span>
<a name="line-1171"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-1172"></a><span class='hs-definition'>tryUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>id</span> <span class='hs-varid'>lone_variable</span>
<a name="line-1173"></a>             <span class='hs-varid'>arg_infos</span> <span class='hs-varid'>cont_info</span> <span class='hs-varid'>unf_template</span> <span class='hs-varid'>is_top</span>
<a name="line-1174"></a>             <span class='hs-varid'>is_wf</span> <span class='hs-varid'>is_exp</span> <span class='hs-varid'>guidance</span>
<a name="line-1175"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>guidance</span> <span class='hs-keyword'>of</span>
<a name="line-1176"></a>     <span class='hs-conid'>UnfNever</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>traceInline</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>str</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"UnfNever"</span><span class='hs-layout'>)</span> <span class='hs-conid'>Nothing</span>
<a name="line-1177"></a>
<a name="line-1178"></a>     <span class='hs-conid'>UnfWhen</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ug_arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uf_arity</span><span class='hs-layout'>,</span> <span class='hs-varid'>ug_unsat_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsat_ok</span><span class='hs-layout'>,</span> <span class='hs-varid'>ug_boring_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boring_ok</span> <span class='hs-layout'>}</span>
<a name="line-1179"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>enough_args</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>boring_ok</span> <span class='hs-varop'>||</span> <span class='hs-varid'>some_benefit</span> <span class='hs-varop'>||</span> <span class='hs-varid'>ufVeryAggressive</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-1180"></a>                <span class='hs-comment'>-- See Note [INLINE for small functions (3)]</span>
<a name="line-1181"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>traceInline</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>str</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_doc</span> <span class='hs-varid'>some_benefit</span> <span class='hs-varid'>empty</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>unf_template</span><span class='hs-layout'>)</span>
<a name="line-1182"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1183"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>traceInline</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>str</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_doc</span> <span class='hs-varid'>some_benefit</span> <span class='hs-varid'>empty</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-conid'>Nothing</span>
<a name="line-1184"></a>        <span class='hs-keyword'>where</span>
<a name="line-1185"></a>          <span class='hs-varid'>some_benefit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>calc_some_benefit</span> <span class='hs-varid'>uf_arity</span>
<a name="line-1186"></a>          <span class='hs-varid'>enough_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_val_args</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>uf_arity</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsat_ok</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>n_val_args</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-1187"></a>
<a name="line-1188"></a>     <span class='hs-conid'>UnfIfGoodArgs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ug_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_discounts</span><span class='hs-layout'>,</span> <span class='hs-varid'>ug_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res_discount</span><span class='hs-layout'>,</span> <span class='hs-varid'>ug_size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size</span> <span class='hs-layout'>}</span>
<a name="line-1189"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ufVeryAggressive</span> <span class='hs-varid'>dflags</span>
<a name="line-1190"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>traceInline</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>str</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_doc</span> <span class='hs-varid'>some_benefit</span> <span class='hs-varid'>extra_doc</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>unf_template</span><span class='hs-layout'>)</span>
<a name="line-1191"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_wf</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>some_benefit</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>small_enough</span>
<a name="line-1192"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>traceInline</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>str</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_doc</span> <span class='hs-varid'>some_benefit</span> <span class='hs-varid'>extra_doc</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>unf_template</span><span class='hs-layout'>)</span>
<a name="line-1193"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1194"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>traceInline</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>str</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_doc</span> <span class='hs-varid'>some_benefit</span> <span class='hs-varid'>extra_doc</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-conid'>Nothing</span>
<a name="line-1195"></a>        <span class='hs-keyword'>where</span>
<a name="line-1196"></a>          <span class='hs-varid'>some_benefit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>calc_some_benefit</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>arg_discounts</span><span class='hs-layout'>)</span>
<a name="line-1197"></a>          <span class='hs-varid'>extra_doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"discounted size ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>discounted_size</span>
<a name="line-1198"></a>          <span class='hs-varid'>discounted_size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size</span> <span class='hs-comment'>-</span> <span class='hs-varid'>discount</span>
<a name="line-1199"></a>          <span class='hs-varid'>small_enough</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>discounted_size</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>ufUseThreshold</span> <span class='hs-varid'>dflags</span>
<a name="line-1200"></a>          <span class='hs-varid'>discount</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>computeDiscount</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>arg_discounts</span>
<a name="line-1201"></a>                                     <span class='hs-varid'>res_discount</span> <span class='hs-varid'>arg_infos</span> <span class='hs-varid'>cont_info</span>
<a name="line-1202"></a>
<a name="line-1203"></a>  <span class='hs-keyword'>where</span>
<a name="line-1204"></a>    <span class='hs-varid'>mk_doc</span> <span class='hs-varid'>some_benefit</span> <span class='hs-varid'>extra_doc</span> <span class='hs-varid'>yes_or_no</span>
<a name="line-1205"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"arg infos"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>arg_infos</span>
<a name="line-1206"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"interesting continuation"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cont_info</span>
<a name="line-1207"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"some_benefit"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>some_benefit</span>
<a name="line-1208"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"is exp:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>is_exp</span>
<a name="line-1209"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"is work-free:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>is_wf</span>
<a name="line-1210"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"guidance"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>guidance</span>
<a name="line-1211"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>extra_doc</span>
<a name="line-1212"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ANSWER ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>yes_or_no</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>text</span> <span class='hs-str'>"YES"</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>text</span> <span class='hs-str'>"NO"</span><span class='hs-keyglyph'>]</span>
<a name="line-1213"></a>
<a name="line-1214"></a>    <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"Considering inlining: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>showSDocDump</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-1215"></a>    <span class='hs-varid'>n_val_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>arg_infos</span>
<a name="line-1216"></a>
<a name="line-1217"></a>           <span class='hs-comment'>-- some_benefit is used when the RHS is small enough</span>
<a name="line-1218"></a>           <span class='hs-comment'>-- and the call has enough (or too many) value</span>
<a name="line-1219"></a>           <span class='hs-comment'>-- arguments (ie n_val_args &gt;= arity). But there must</span>
<a name="line-1220"></a>           <span class='hs-comment'>-- be *something* interesting about some argument, or the</span>
<a name="line-1221"></a>           <span class='hs-comment'>-- result context, to make it worth inlining</span>
<a name="line-1222"></a>    <span class='hs-varid'>calc_some_benefit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>   <span class='hs-comment'>-- The Arity is the number of args</span>
<a name="line-1223"></a>                                         <span class='hs-comment'>-- expected by the unfolding</span>
<a name="line-1224"></a>    <span class='hs-varid'>calc_some_benefit</span> <span class='hs-varid'>uf_arity</span>
<a name="line-1225"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>saturated</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>interesting_args</span>       <span class='hs-comment'>-- Under-saturated</span>
<a name="line-1226"></a>                                        <span class='hs-comment'>-- Note [Unsaturated applications]</span>
<a name="line-1227"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>interesting_args</span>   <span class='hs-comment'>-- Saturated or over-saturated</span>
<a name="line-1228"></a>                  <span class='hs-varop'>||</span> <span class='hs-varid'>interesting_call</span>
<a name="line-1229"></a>      <span class='hs-keyword'>where</span>
<a name="line-1230"></a>        <span class='hs-varid'>saturated</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n_val_args</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>uf_arity</span>
<a name="line-1231"></a>        <span class='hs-varid'>over_saturated</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n_val_args</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>uf_arity</span>
<a name="line-1232"></a>        <span class='hs-varid'>interesting_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-varid'>nonTriv</span> <span class='hs-varid'>arg_infos</span>
<a name="line-1233"></a>                <span class='hs-comment'>-- NB: (any nonTriv arg_infos) looks at the</span>
<a name="line-1234"></a>                <span class='hs-comment'>-- over-saturated args too which is "wrong";</span>
<a name="line-1235"></a>                <span class='hs-comment'>-- but if over-saturated we inline anyway.</span>
<a name="line-1236"></a>
<a name="line-1237"></a>        <span class='hs-varid'>interesting_call</span>
<a name="line-1238"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>over_saturated</span>
<a name="line-1239"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1240"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1241"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cont_info</span> <span class='hs-keyword'>of</span>
<a name="line-1242"></a>              <span class='hs-conid'>CaseCtxt</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>lone_variable</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>is_wf</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Note [Lone variables]</span>
<a name="line-1243"></a>              <span class='hs-conid'>ValAppCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>                              <span class='hs-comment'>-- Note [Cast then apply]</span>
<a name="line-1244"></a>              <span class='hs-conid'>RuleArgCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>uf_arity</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span>  <span class='hs-comment'>-- See Note [Unfold info lazy contexts]</span>
<a name="line-1245"></a>              <span class='hs-conid'>DiscArgCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>uf_arity</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span>  <span class='hs-comment'>--</span>
<a name="line-1246"></a>              <span class='hs-conid'>RhsCtxt</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>uf_arity</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span>  <span class='hs-comment'>--</span>
<a name="line-1247"></a>              <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>is_top</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>uf_arity</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span>   <span class='hs-comment'>-- Note [Nested functions]</span>
<a name="line-1248"></a>                                                      <span class='hs-comment'>-- Note [Inlining in ArgCtxt]</span>
<a name="line-1249"></a>
<a name="line-1250"></a><span class='hs-comment'>{-
<a name="line-1251"></a>Note [Unfold into lazy contexts], Note [RHS of lets]
<a name="line-1252"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1253"></a>When the call is the argument of a function with a RULE, or the RHS of a let,
<a name="line-1254"></a>we are a little bit keener to inline.  For example
<a name="line-1255"></a>     f y = (y,y,y)
<a name="line-1256"></a>     g y = let x = f y in ...(case x of (a,b,c) -&gt; ...) ...
<a name="line-1257"></a>We'd inline 'f' if the call was in a case context, and it kind-of-is,
<a name="line-1258"></a>only we can't see it.  Also
<a name="line-1259"></a>     x = f v
<a name="line-1260"></a>could be expensive whereas
<a name="line-1261"></a>     x = case v of (a,b) -&gt; a
<a name="line-1262"></a>is patently cheap and may allow more eta expansion.
<a name="line-1263"></a>So we treat the RHS of a let as not-totally-boring.
<a name="line-1264"></a>
<a name="line-1265"></a>Note [Unsaturated applications]
<a name="line-1266"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1267"></a>When a call is not saturated, we *still* inline if one of the
<a name="line-1268"></a>arguments has interesting structure.  That's sometimes very important.
<a name="line-1269"></a>A good example is the Ord instance for Bool in Base:
<a name="line-1270"></a>
<a name="line-1271"></a> Rec {
<a name="line-1272"></a>    $fOrdBool =GHC.Classes.D:Ord
<a name="line-1273"></a>                 @ Bool
<a name="line-1274"></a>                 ...
<a name="line-1275"></a>                 $cmin_ajX
<a name="line-1276"></a>
<a name="line-1277"></a>    $cmin_ajX [Occ=LoopBreaker] :: Bool -&gt; Bool -&gt; Bool
<a name="line-1278"></a>    $cmin_ajX = GHC.Classes.$dmmin @ Bool $fOrdBool
<a name="line-1279"></a>  }
<a name="line-1280"></a>
<a name="line-1281"></a>But the defn of GHC.Classes.$dmmin is:
<a name="line-1282"></a>
<a name="line-1283"></a>  $dmmin :: forall a. GHC.Classes.Ord a =&gt; a -&gt; a -&gt; a
<a name="line-1284"></a>    {- Arity: 3, HasNoCafRefs, Strictness: SLL,
<a name="line-1285"></a>       Unfolding: (\ @ a $dOrd :: GHC.Classes.Ord a x :: a y :: a -&gt;
<a name="line-1286"></a>                   case @ a GHC.Classes.&lt;= @ a $dOrd x y of wild {
<a name="line-1287"></a>                     GHC.Types.False -&gt; y GHC.Types.True -&gt; x }) -}
<a name="line-1288"></a>
<a name="line-1289"></a>We *really* want to inline $dmmin, even though it has arity 3, in
<a name="line-1290"></a>order to unravel the recursion.
<a name="line-1291"></a>
<a name="line-1292"></a>
<a name="line-1293"></a>Note [Things to watch]
<a name="line-1294"></a>~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1295"></a>*   { y = I# 3; x = y `cast` co; ...case (x `cast` co) of ... }
<a name="line-1296"></a>    Assume x is exported, so not inlined unconditionally.
<a name="line-1297"></a>    Then we want x to inline unconditionally; no reason for it
<a name="line-1298"></a>    not to, and doing so avoids an indirection.
<a name="line-1299"></a>
<a name="line-1300"></a>*   { x = I# 3; ....f x.... }
<a name="line-1301"></a>    Make sure that x does not inline unconditionally!
<a name="line-1302"></a>    Lest we get extra allocation.
<a name="line-1303"></a>
<a name="line-1304"></a>Note [Inlining an InlineRule]
<a name="line-1305"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1306"></a>An InlineRules is used for
<a name="line-1307"></a>  (a) programmer INLINE pragmas
<a name="line-1308"></a>  (b) inlinings from worker/wrapper
<a name="line-1309"></a>
<a name="line-1310"></a>For (a) the RHS may be large, and our contract is that we *only* inline
<a name="line-1311"></a>when the function is applied to all the arguments on the LHS of the
<a name="line-1312"></a>source-code defn.  (The uf_arity in the rule.)
<a name="line-1313"></a>
<a name="line-1314"></a>However for worker/wrapper it may be worth inlining even if the
<a name="line-1315"></a>arity is not satisfied (as we do in the CoreUnfolding case) so we don't
<a name="line-1316"></a>require saturation.
<a name="line-1317"></a>
<a name="line-1318"></a>
<a name="line-1319"></a>Note [Nested functions]
<a name="line-1320"></a>~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1321"></a>If a function has a nested defn we also record some-benefit, on the
<a name="line-1322"></a>grounds that we are often able to eliminate the binding, and hence the
<a name="line-1323"></a>allocation, for the function altogether; this is good for join points.
<a name="line-1324"></a>But this only makes sense for *functions*; inlining a constructor
<a name="line-1325"></a>doesn't help allocation unless the result is scrutinised.  UNLESS the
<a name="line-1326"></a>constructor occurs just once, albeit possibly in multiple case
<a name="line-1327"></a>branches.  Then inlining it doesn't increase allocation, but it does
<a name="line-1328"></a>increase the chance that the constructor won't be allocated at all in
<a name="line-1329"></a>the branches that don't use it.
<a name="line-1330"></a>
<a name="line-1331"></a>Note [Cast then apply]
<a name="line-1332"></a>~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1333"></a>Consider
<a name="line-1334"></a>   myIndex = __inline_me ( (/\a. &lt;blah&gt;) |&gt; co )
<a name="line-1335"></a>   co :: (forall a. a -&gt; a) ~ (forall a. T a)
<a name="line-1336"></a>     ... /\a.\x. case ((myIndex a) |&gt; sym co) x of { ... } ...
<a name="line-1337"></a>
<a name="line-1338"></a>We need to inline myIndex to unravel this; but the actual call (myIndex a) has
<a name="line-1339"></a>no value arguments.  The ValAppCtxt gives it enough incentive to inline.
<a name="line-1340"></a>
<a name="line-1341"></a>Note [Inlining in ArgCtxt]
<a name="line-1342"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1343"></a>The condition (arity &gt; 0) here is very important, because otherwise
<a name="line-1344"></a>we end up inlining top-level stuff into useless places; eg
<a name="line-1345"></a>   x = I# 3#
<a name="line-1346"></a>   f = \y.  g x
<a name="line-1347"></a>This can make a very big difference: it adds 16% to nofib 'integer' allocs,
<a name="line-1348"></a>and 20% to 'power'.
<a name="line-1349"></a>
<a name="line-1350"></a>At one stage I replaced this condition by 'True' (leading to the above
<a name="line-1351"></a>slow-down).  The motivation was test eyeball/inline1.hs; but that seems
<a name="line-1352"></a>to work ok now.
<a name="line-1353"></a>
<a name="line-1354"></a>NOTE: arguably, we should inline in ArgCtxt only if the result of the
<a name="line-1355"></a>call is at least CONLIKE.  At least for the cases where we use ArgCtxt
<a name="line-1356"></a>for the RHS of a 'let', we only profit from the inlining if we get a
<a name="line-1357"></a>CONLIKE thing (modulo lets).
<a name="line-1358"></a>
<a name="line-1359"></a>Note [Lone variables]   See also Note [Interaction of exprIsWorkFree and lone variables]
<a name="line-1360"></a>~~~~~~~~~~~~~~~~~~~~~   which appears below
<a name="line-1361"></a>The "lone-variable" case is important.  I spent ages messing about
<a name="line-1362"></a>with unsatisfactory variants, but this is nice.  The idea is that if a
<a name="line-1363"></a>variable appears all alone
<a name="line-1364"></a>
<a name="line-1365"></a>        as an arg of lazy fn, or rhs    BoringCtxt
<a name="line-1366"></a>        as scrutinee of a case          CaseCtxt
<a name="line-1367"></a>        as arg of a fn                  ArgCtxt
<a name="line-1368"></a>AND
<a name="line-1369"></a>        it is bound to a cheap expression
<a name="line-1370"></a>
<a name="line-1371"></a>then we should not inline it (unless there is some other reason,
<a name="line-1372"></a>e.g. it is the sole occurrence).  That is what is happening at
<a name="line-1373"></a>the use of 'lone_variable' in 'interesting_call'.
<a name="line-1374"></a>
<a name="line-1375"></a>Why?  At least in the case-scrutinee situation, turning
<a name="line-1376"></a>        let x = (a,b) in case x of y -&gt; ...
<a name="line-1377"></a>into
<a name="line-1378"></a>        let x = (a,b) in case (a,b) of y -&gt; ...
<a name="line-1379"></a>and thence to
<a name="line-1380"></a>        let x = (a,b) in let y = (a,b) in ...
<a name="line-1381"></a>is bad if the binding for x will remain.
<a name="line-1382"></a>
<a name="line-1383"></a>Another example: I discovered that strings
<a name="line-1384"></a>were getting inlined straight back into applications of 'error'
<a name="line-1385"></a>because the latter is strict.
<a name="line-1386"></a>        s = "foo"
<a name="line-1387"></a>        f = \x -&gt; ...(error s)...
<a name="line-1388"></a>
<a name="line-1389"></a>Fundamentally such contexts should not encourage inlining because the
<a name="line-1390"></a>context can ``see'' the unfolding of the variable (e.g. case or a
<a name="line-1391"></a>RULE) so there's no gain.  If the thing is bound to a value.
<a name="line-1392"></a>
<a name="line-1393"></a>However, watch out:
<a name="line-1394"></a>
<a name="line-1395"></a> * Consider this:
<a name="line-1396"></a>        foo = _inline_ (\n. [n])
<a name="line-1397"></a>        bar = _inline_ (foo 20)
<a name="line-1398"></a>        baz = \n. case bar of { (m:_) -&gt; m + n }
<a name="line-1399"></a>   Here we really want to inline 'bar' so that we can inline 'foo'
<a name="line-1400"></a>   and the whole thing unravels as it should obviously do.  This is
<a name="line-1401"></a>   important: in the NDP project, 'bar' generates a closure data
<a name="line-1402"></a>   structure rather than a list.
<a name="line-1403"></a>
<a name="line-1404"></a>   So the non-inlining of lone_variables should only apply if the
<a name="line-1405"></a>   unfolding is regarded as cheap; because that is when exprIsConApp_maybe
<a name="line-1406"></a>   looks through the unfolding.  Hence the "&amp;&amp; is_wf" in the
<a name="line-1407"></a>   InlineRule branch.
<a name="line-1408"></a>
<a name="line-1409"></a> * Even a type application or coercion isn't a lone variable.
<a name="line-1410"></a>   Consider
<a name="line-1411"></a>        case $fMonadST @ RealWorld of { :DMonad a b c -&gt; c }
<a name="line-1412"></a>   We had better inline that sucker!  The case won't see through it.
<a name="line-1413"></a>
<a name="line-1414"></a>   For now, I'm treating treating a variable applied to types
<a name="line-1415"></a>   in a *lazy* context "lone". The motivating example was
<a name="line-1416"></a>        f = /\a. \x. BIG
<a name="line-1417"></a>        g = /\a. \y.  h (f a)
<a name="line-1418"></a>   There's no advantage in inlining f here, and perhaps
<a name="line-1419"></a>   a significant disadvantage.  Hence some_val_args in the Stop case
<a name="line-1420"></a>
<a name="line-1421"></a>Note [Interaction of exprIsWorkFree and lone variables]
<a name="line-1422"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1423"></a>The lone-variable test says "don't inline if a case expression
<a name="line-1424"></a>scrutinises a lone variable whose unfolding is cheap".  It's very
<a name="line-1425"></a>important that, under these circumstances, exprIsConApp_maybe
<a name="line-1426"></a>can spot a constructor application. So, for example, we don't
<a name="line-1427"></a>consider
<a name="line-1428"></a>        let x = e in (x,x)
<a name="line-1429"></a>to be cheap, and that's good because exprIsConApp_maybe doesn't
<a name="line-1430"></a>think that expression is a constructor application.
<a name="line-1431"></a>
<a name="line-1432"></a>In the 'not (lone_variable &amp;&amp; is_wf)' test, I used to test is_value
<a name="line-1433"></a>rather than is_wf, which was utterly wrong, because the above
<a name="line-1434"></a>expression responds True to exprIsHNF, which is what sets is_value.
<a name="line-1435"></a>
<a name="line-1436"></a>This kind of thing can occur if you have
<a name="line-1437"></a>
<a name="line-1438"></a>        {-# INLINE foo #-}
<a name="line-1439"></a>        foo = let x = e in (x,x)
<a name="line-1440"></a>
<a name="line-1441"></a>which Roman did.
<a name="line-1442"></a>-}</span>
<a name="line-1443"></a>
<a name="line-1444"></a><a name="computeDiscount"></a><span class='hs-definition'>computeDiscount</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Int</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ArgSummary</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CallCtxt</span>
<a name="line-1445"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-1446"></a><span class='hs-definition'>computeDiscount</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>arg_discounts</span> <span class='hs-varid'>res_discount</span> <span class='hs-varid'>arg_infos</span> <span class='hs-varid'>cont_info</span>
<a name="line-1447"></a>        <span class='hs-comment'>-- We multiple the raw discounts (args_discount and result_discount)</span>
<a name="line-1448"></a>        <span class='hs-comment'>-- ty opt_UnfoldingKeenessFactor because the former have to do with</span>
<a name="line-1449"></a>        <span class='hs-comment'>--  *size* whereas the discounts imply that there's some extra</span>
<a name="line-1450"></a>        <span class='hs-comment'>--  *efficiency* to be gained (e.g. beta reductions, case reductions)</span>
<a name="line-1451"></a>        <span class='hs-comment'>-- by inlining.</span>
<a name="line-1452"></a>
<a name="line-1453"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-num'>10</span>          <span class='hs-comment'>-- Discount of 10 because the result replaces the call</span>
<a name="line-1454"></a>                <span class='hs-comment'>-- so we count 10 for the function itself</span>
<a name="line-1455"></a>
<a name="line-1456"></a>    <span class='hs-varop'>+</span> <span class='hs-num'>10</span> <span class='hs-varop'>*</span> <span class='hs-varid'>length</span> <span class='hs-varid'>actual_arg_discounts</span>
<a name="line-1457"></a>               <span class='hs-comment'>-- Discount of 10 for each arg supplied,</span>
<a name="line-1458"></a>               <span class='hs-comment'>-- because the result replaces the call</span>
<a name="line-1459"></a>
<a name="line-1460"></a>    <span class='hs-varop'>+</span> <span class='hs-varid'>round</span> <span class='hs-layout'>(</span><span class='hs-varid'>ufKeenessFactor</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>*</span>
<a name="line-1461"></a>             <span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>total_arg_discount</span> <span class='hs-varop'>+</span> <span class='hs-varid'>res_discount'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1462"></a>  <span class='hs-keyword'>where</span>
<a name="line-1463"></a>    <span class='hs-varid'>actual_arg_discounts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>mk_arg_discount</span> <span class='hs-varid'>arg_discounts</span> <span class='hs-varid'>arg_infos</span>
<a name="line-1464"></a>    <span class='hs-varid'>total_arg_discount</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sum</span> <span class='hs-varid'>actual_arg_discounts</span>
<a name="line-1465"></a>
<a name="line-1466"></a>    <span class='hs-varid'>mk_arg_discount</span> <span class='hs-keyword'>_</span>        <span class='hs-conid'>TrivArg</span>    <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-1467"></a>    <span class='hs-varid'>mk_arg_discount</span> <span class='hs-keyword'>_</span>        <span class='hs-conid'>NonTrivArg</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>10</span>
<a name="line-1468"></a>    <span class='hs-varid'>mk_arg_discount</span> <span class='hs-varid'>discount</span> <span class='hs-conid'>ValueArg</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>discount</span>
<a name="line-1469"></a>
<a name="line-1470"></a>    <span class='hs-varid'>res_discount'</span>
<a name="line-1471"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LT</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>arg_discounts</span> <span class='hs-varop'>`compareLength`</span> <span class='hs-varid'>arg_infos</span>
<a name="line-1472"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res_discount</span>   <span class='hs-comment'>-- Over-saturated</span>
<a name="line-1473"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1474"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cont_info</span> <span class='hs-keyword'>of</span>
<a name="line-1475"></a>           <span class='hs-conid'>BoringCtxt</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>0</span>
<a name="line-1476"></a>           <span class='hs-conid'>CaseCtxt</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>res_discount</span>  <span class='hs-comment'>-- Presumably a constructor</span>
<a name="line-1477"></a>           <span class='hs-conid'>ValAppCtxt</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>res_discount</span>  <span class='hs-comment'>-- Presumably a function</span>
<a name="line-1478"></a>           <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>40</span> <span class='hs-varop'>`min`</span> <span class='hs-varid'>res_discount</span>
<a name="line-1479"></a>                <span class='hs-comment'>-- ToDo: this 40 `min` res_discount doesn't seem right</span>
<a name="line-1480"></a>                <span class='hs-comment'>--   for DiscArgCtxt it shouldn't matter because the function will</span>
<a name="line-1481"></a>                <span class='hs-comment'>--       get the arg discount for any non-triv arg</span>
<a name="line-1482"></a>                <span class='hs-comment'>--   for RuleArgCtxt we do want to be keener to inline; but not only</span>
<a name="line-1483"></a>                <span class='hs-comment'>--       constructor results</span>
<a name="line-1484"></a>                <span class='hs-comment'>--   for RhsCtxt I suppose that exposing a data con is good in general</span>
<a name="line-1485"></a>                <span class='hs-comment'>--   And 40 seems very arbitrary</span>
<a name="line-1486"></a>                <span class='hs-comment'>--</span>
<a name="line-1487"></a>                <span class='hs-comment'>-- res_discount can be very large when a function returns</span>
<a name="line-1488"></a>                <span class='hs-comment'>-- constructors; but we only want to invoke that large discount</span>
<a name="line-1489"></a>                <span class='hs-comment'>-- when there's a case continuation.</span>
<a name="line-1490"></a>                <span class='hs-comment'>-- Otherwise we, rather arbitrarily, threshold it.  Yuk.</span>
<a name="line-1491"></a>                <span class='hs-comment'>-- But we want to aovid inlining large functions that return</span>
<a name="line-1492"></a>                <span class='hs-comment'>-- constructors into contexts that are simply "interesting"</span>
</pre></body>
</html>
