<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcSMonad.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE CPP, TypeFamilies #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-comment'>-- Type definitions for the constraint solver</span>
<a name="line-4"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcSMonad</span> <span class='hs-layout'>(</span>
<a name="line-5"></a>
<a name="line-6"></a>    <span class='hs-comment'>-- The work list</span>
<a name="line-7"></a>    <span class='hs-conid'>WorkList</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEmptyWorkList</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyWorkList</span><span class='hs-layout'>,</span>
<a name="line-8"></a>    <span class='hs-varid'>extendWorkListNonEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendWorkListCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendWorkListDerived</span><span class='hs-layout'>,</span>
<a name="line-9"></a>    <span class='hs-varid'>extendWorkListCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendWorkListEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendWorkListFunEq</span><span class='hs-layout'>,</span>
<a name="line-10"></a>    <span class='hs-varid'>appendWorkList</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendWorkListImplic</span><span class='hs-layout'>,</span>
<a name="line-11"></a>    <span class='hs-varid'>selectNextWorkItem</span><span class='hs-layout'>,</span>
<a name="line-12"></a>    <span class='hs-varid'>workListSize</span><span class='hs-layout'>,</span> <span class='hs-varid'>workListWantedCount</span><span class='hs-layout'>,</span>
<a name="line-13"></a>    <span class='hs-varid'>getWorkList</span><span class='hs-layout'>,</span> <span class='hs-varid'>updWorkListTcS</span><span class='hs-layout'>,</span>
<a name="line-14"></a>
<a name="line-15"></a>    <span class='hs-comment'>-- The TcS monad</span>
<a name="line-16"></a>    <span class='hs-conid'>TcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>runTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>runTcSDeriveds</span><span class='hs-layout'>,</span> <span class='hs-varid'>runTcSWithEvBinds</span><span class='hs-layout'>,</span>
<a name="line-17"></a>    <span class='hs-varid'>failTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>warnTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>addErrTcS</span><span class='hs-layout'>,</span>
<a name="line-18"></a>    <span class='hs-varid'>runTcSEqualities</span><span class='hs-layout'>,</span>
<a name="line-19"></a>    <span class='hs-varid'>nestTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>nestImplicTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>setEvBindsTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>buildImplication</span><span class='hs-layout'>,</span>
<a name="line-20"></a>
<a name="line-21"></a>    <span class='hs-varid'>runTcPluginTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>addUsedGRE</span><span class='hs-layout'>,</span> <span class='hs-varid'>addUsedGREs</span><span class='hs-layout'>,</span>
<a name="line-22"></a>
<a name="line-23"></a>    <span class='hs-comment'>-- Tracing etc</span>
<a name="line-24"></a>    <span class='hs-varid'>panicTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>traceTcS</span><span class='hs-layout'>,</span>
<a name="line-25"></a>    <span class='hs-varid'>traceFireTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>bumpStepCountTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>csTraceTcS</span><span class='hs-layout'>,</span>
<a name="line-26"></a>    <span class='hs-varid'>wrapErrTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrapWarnTcS</span><span class='hs-layout'>,</span>
<a name="line-27"></a>
<a name="line-28"></a>    <span class='hs-comment'>-- Evidence creation and transformation</span>
<a name="line-29"></a>    <span class='hs-conid'>MaybeNew</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>freshGoals</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFresh</span><span class='hs-layout'>,</span> <span class='hs-varid'>getEvTerm</span><span class='hs-layout'>,</span>
<a name="line-30"></a>
<a name="line-31"></a>    <span class='hs-varid'>newTcEvBinds</span><span class='hs-layout'>,</span>
<a name="line-32"></a>    <span class='hs-varid'>newWantedEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitNewWantedEq</span><span class='hs-layout'>,</span>
<a name="line-33"></a>    <span class='hs-varid'>newWanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>newWantedEvVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>newWantedNC</span><span class='hs-layout'>,</span> <span class='hs-varid'>newWantedEvVarNC</span><span class='hs-layout'>,</span> <span class='hs-varid'>newDerivedNC</span><span class='hs-layout'>,</span>
<a name="line-34"></a>    <span class='hs-varid'>newBoundEvVarId</span><span class='hs-layout'>,</span>
<a name="line-35"></a>    <span class='hs-varid'>unifyTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>unflattenFmv</span><span class='hs-layout'>,</span> <span class='hs-varid'>reportUnifications</span><span class='hs-layout'>,</span>
<a name="line-36"></a>    <span class='hs-varid'>setEvBind</span><span class='hs-layout'>,</span> <span class='hs-varid'>setWantedEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>setEqIfWanted</span><span class='hs-layout'>,</span>
<a name="line-37"></a>    <span class='hs-varid'>setWantedEvTerm</span><span class='hs-layout'>,</span> <span class='hs-varid'>setWantedEvBind</span><span class='hs-layout'>,</span> <span class='hs-varid'>setEvBindIfWanted</span><span class='hs-layout'>,</span>
<a name="line-38"></a>    <span class='hs-varid'>newEvVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>newGivenEvVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>newGivenEvVars</span><span class='hs-layout'>,</span>
<a name="line-39"></a>    <span class='hs-varid'>emitNewDerived</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitNewDeriveds</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitNewDerivedEq</span><span class='hs-layout'>,</span>
<a name="line-40"></a>    <span class='hs-varid'>checkReductionDepth</span><span class='hs-layout'>,</span>
<a name="line-41"></a>
<a name="line-42"></a>    <span class='hs-varid'>getInstEnvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>getFamInstEnvs</span><span class='hs-layout'>,</span>                <span class='hs-comment'>-- Getting the environments</span>
<a name="line-43"></a>    <span class='hs-varid'>getTopEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>getGblEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>getLclEnv</span><span class='hs-layout'>,</span>
<a name="line-44"></a>    <span class='hs-varid'>getTcEvBindsVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTcLevel</span><span class='hs-layout'>,</span>
<a name="line-45"></a>    <span class='hs-varid'>getTcEvBindsAndTCVs</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTcEvBindsMap</span><span class='hs-layout'>,</span>
<a name="line-46"></a>    <span class='hs-varid'>tcLookupClass</span><span class='hs-layout'>,</span>
<a name="line-47"></a>    <span class='hs-varid'>tcLookupId</span><span class='hs-layout'>,</span>
<a name="line-48"></a>
<a name="line-49"></a>    <span class='hs-comment'>-- Inerts</span>
<a name="line-50"></a>    <span class='hs-conid'>InertSet</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>InertCans</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-51"></a>    <span class='hs-varid'>updInertTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>updInertCans</span><span class='hs-layout'>,</span> <span class='hs-varid'>updInertDicts</span><span class='hs-layout'>,</span> <span class='hs-varid'>updInertIrreds</span><span class='hs-layout'>,</span>
<a name="line-52"></a>    <span class='hs-varid'>getNoGivenEqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>setInertCans</span><span class='hs-layout'>,</span>
<a name="line-53"></a>    <span class='hs-varid'>getInertEqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>getInertCans</span><span class='hs-layout'>,</span> <span class='hs-varid'>getInertGivens</span><span class='hs-layout'>,</span>
<a name="line-54"></a>    <span class='hs-varid'>getInertInsols</span><span class='hs-layout'>,</span>
<a name="line-55"></a>    <span class='hs-varid'>getTcSInerts</span><span class='hs-layout'>,</span> <span class='hs-varid'>setTcSInerts</span><span class='hs-layout'>,</span>
<a name="line-56"></a>    <span class='hs-varid'>matchableGivens</span><span class='hs-layout'>,</span> <span class='hs-varid'>prohibitedSuperClassSolve</span><span class='hs-layout'>,</span>
<a name="line-57"></a>    <span class='hs-varid'>getUnsolvedInerts</span><span class='hs-layout'>,</span>
<a name="line-58"></a>    <span class='hs-varid'>removeInertCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>getPendingScDicts</span><span class='hs-layout'>,</span>
<a name="line-59"></a>    <span class='hs-varid'>addInertCan</span><span class='hs-layout'>,</span> <span class='hs-varid'>addInertEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>insertFunEq</span><span class='hs-layout'>,</span>
<a name="line-60"></a>    <span class='hs-varid'>emitInsoluble</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitWorkNC</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitWork</span><span class='hs-layout'>,</span>
<a name="line-61"></a>    <span class='hs-varid'>isImprovable</span><span class='hs-layout'>,</span>
<a name="line-62"></a>
<a name="line-63"></a>    <span class='hs-comment'>-- The Model</span>
<a name="line-64"></a>    <span class='hs-varid'>kickOutAfterUnification</span><span class='hs-layout'>,</span>
<a name="line-65"></a>
<a name="line-66"></a>    <span class='hs-comment'>-- Inert Safe Haskell safe-overlap failures</span>
<a name="line-67"></a>    <span class='hs-varid'>addInertSafehask</span><span class='hs-layout'>,</span> <span class='hs-varid'>insertSafeOverlapFailureTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>updInertSafehask</span><span class='hs-layout'>,</span>
<a name="line-68"></a>    <span class='hs-varid'>getSafeOverlapFailures</span><span class='hs-layout'>,</span>
<a name="line-69"></a>
<a name="line-70"></a>    <span class='hs-comment'>-- Inert CDictCans</span>
<a name="line-71"></a>    <span class='hs-conid'>DictMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyDictMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupInertDict</span><span class='hs-layout'>,</span> <span class='hs-varid'>findDictsByClass</span><span class='hs-layout'>,</span> <span class='hs-varid'>addDict</span><span class='hs-layout'>,</span>
<a name="line-72"></a>    <span class='hs-varid'>addDictsByClass</span><span class='hs-layout'>,</span> <span class='hs-varid'>delDict</span><span class='hs-layout'>,</span> <span class='hs-varid'>foldDicts</span><span class='hs-layout'>,</span> <span class='hs-varid'>filterDicts</span><span class='hs-layout'>,</span> <span class='hs-varid'>findDict</span><span class='hs-layout'>,</span>
<a name="line-73"></a>
<a name="line-74"></a>    <span class='hs-comment'>-- Inert CTyEqCans</span>
<a name="line-75"></a>    <span class='hs-conid'>EqualCtList</span><span class='hs-layout'>,</span> <span class='hs-varid'>findTyEqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>foldTyEqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>isInInertEqs</span><span class='hs-layout'>,</span>
<a name="line-76"></a>    <span class='hs-varid'>lookupFlattenTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupInertTyVar</span><span class='hs-layout'>,</span>
<a name="line-77"></a>
<a name="line-78"></a>    <span class='hs-comment'>-- Inert solved dictionaries</span>
<a name="line-79"></a>    <span class='hs-varid'>addSolvedDict</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupSolvedDict</span><span class='hs-layout'>,</span>
<a name="line-80"></a>
<a name="line-81"></a>    <span class='hs-comment'>-- Irreds</span>
<a name="line-82"></a>    <span class='hs-varid'>foldIrreds</span><span class='hs-layout'>,</span>
<a name="line-83"></a>
<a name="line-84"></a>    <span class='hs-comment'>-- The flattening cache</span>
<a name="line-85"></a>    <span class='hs-varid'>lookupFlatCache</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendFlatCache</span><span class='hs-layout'>,</span> <span class='hs-varid'>newFlattenSkolem</span><span class='hs-layout'>,</span>            <span class='hs-comment'>-- Flatten skolems</span>
<a name="line-86"></a>
<a name="line-87"></a>    <span class='hs-comment'>-- Inert CFunEqCans</span>
<a name="line-88"></a>    <span class='hs-varid'>updInertFunEqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>findFunEq</span><span class='hs-layout'>,</span>
<a name="line-89"></a>    <span class='hs-varid'>findFunEqsByTyCon</span><span class='hs-layout'>,</span>
<a name="line-90"></a>
<a name="line-91"></a>    <span class='hs-varid'>instDFunType</span><span class='hs-layout'>,</span>                              <span class='hs-comment'>-- Instantiation</span>
<a name="line-92"></a>
<a name="line-93"></a>    <span class='hs-comment'>-- MetaTyVars</span>
<a name="line-94"></a>    <span class='hs-varid'>newFlexiTcSTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>instFlexi</span><span class='hs-layout'>,</span> <span class='hs-varid'>instFlexiX</span><span class='hs-layout'>,</span>
<a name="line-95"></a>    <span class='hs-varid'>cloneMetaTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>demoteUnfilledFmv</span><span class='hs-layout'>,</span>
<a name="line-96"></a>    <span class='hs-varid'>tcInstType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInstSkolTyVarsX</span><span class='hs-layout'>,</span>
<a name="line-97"></a>
<a name="line-98"></a>    <span class='hs-conid'>TcLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTouchableMetaTyVarTcS</span><span class='hs-layout'>,</span>
<a name="line-99"></a>    <span class='hs-varid'>isFilledMetaTyVar_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFilledMetaTyVar</span><span class='hs-layout'>,</span>
<a name="line-100"></a>    <span class='hs-varid'>zonkTyCoVarsAndFV</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTcType</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTcTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTcTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkCo</span><span class='hs-layout'>,</span>
<a name="line-101"></a>    <span class='hs-varid'>zonkTyCoVarsAndFVList</span><span class='hs-layout'>,</span>
<a name="line-102"></a>    <span class='hs-varid'>zonkSimples</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkWC</span><span class='hs-layout'>,</span>
<a name="line-103"></a>
<a name="line-104"></a>    <span class='hs-comment'>-- References</span>
<a name="line-105"></a>    <span class='hs-varid'>newTcRef</span><span class='hs-layout'>,</span> <span class='hs-varid'>readTcRef</span><span class='hs-layout'>,</span> <span class='hs-varid'>updTcRef</span><span class='hs-layout'>,</span>
<a name="line-106"></a>
<a name="line-107"></a>    <span class='hs-comment'>-- Misc</span>
<a name="line-108"></a>    <span class='hs-varid'>getDefaultInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>getDynFlags</span><span class='hs-layout'>,</span> <span class='hs-varid'>getGlobalRdrEnvTcS</span><span class='hs-layout'>,</span>
<a name="line-109"></a>    <span class='hs-varid'>matchFam</span><span class='hs-layout'>,</span> <span class='hs-varid'>matchFamTcM</span><span class='hs-layout'>,</span>
<a name="line-110"></a>    <span class='hs-varid'>checkWellStagedDFun</span><span class='hs-layout'>,</span>
<a name="line-111"></a>    <span class='hs-varid'>pprEq</span>                                    <span class='hs-comment'>-- Smaller utils, re-exported from TcM</span>
<a name="line-112"></a>                                             <span class='hs-comment'>-- TODO (DV): these are only really used in the</span>
<a name="line-113"></a>                                             <span class='hs-comment'>-- instance matcher in TcSimplify. I am wondering</span>
<a name="line-114"></a>                                             <span class='hs-comment'>-- if the whole instance matcher simply belongs</span>
<a name="line-115"></a>                                             <span class='hs-comment'>-- here</span>
<a name="line-116"></a><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-117"></a>
<a name="line-118"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-119"></a>
<a name="line-120"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-121"></a>
<a name="line-122"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Inst</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-123"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span>
<a name="line-124"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInst</span>
<a name="line-125"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-126"></a>
<a name="line-127"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>TcRnMonad</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-128"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>TcMType</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-129"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>TcEnv</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-130"></a>       <span class='hs-layout'>(</span> <span class='hs-varid'>checkWellStaged</span><span class='hs-layout'>,</span> <span class='hs-varid'>topIdLvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcGetDefaultTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcLookupClass</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-layout'>)</span>
<a name="line-131"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span><span class='hs-layout'>(</span> <span class='hs-varid'>heqTyConKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqTyConKey</span> <span class='hs-layout'>)</span>
<a name="line-132"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Kind</span>
<a name="line-133"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-134"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-135"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-136"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span>
<a name="line-137"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unify</span>
<a name="line-138"></a>
<a name="line-139"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-140"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-141"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-142"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcErrors</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>solverDepthErrorTcS</span> <span class='hs-layout'>)</span>
<a name="line-143"></a>
<a name="line-144"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-145"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span> <span class='hs-conid'>GlobalRdrEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>GlobalRdrElt</span> <span class='hs-layout'>)</span>
<a name="line-146"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>RnEnv</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-147"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-148"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-149"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-150"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-151"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-152"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-153"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-154"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnTypes</span>
<a name="line-155"></a>
<a name="line-156"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-157"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-158"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqDFM</span>
<a name="line-159"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-160"></a>
<a name="line-161"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TrieMap</span>
<a name="line-162"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-163"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Fail</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>MonadFail</span>
<a name="line-164"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MonadUtils</span>
<a name="line-165"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span>
<a name="line-166"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span> <span class='hs-layout'>(</span> <span class='hs-varid'>foldl'</span><span class='hs-layout'>,</span> <span class='hs-varid'>partition</span> <span class='hs-layout'>)</span>
<a name="line-167"></a>
<a name="line-168"></a><span class='hs-cpp'>#if defined(DEBUG)</span>
<a name="line-169"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Digraph</span>
<a name="line-170"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSet</span>
<a name="line-171"></a><span class='hs-cpp'>#endif</span>
<a name="line-172"></a>
<a name="line-173"></a><span class='hs-comment'>{-
<a name="line-174"></a>************************************************************************
<a name="line-175"></a>*                                                                      *
<a name="line-176"></a>*                            Worklists                                *
<a name="line-177"></a>*  Canonical and non-canonical constraints that the simplifier has to  *
<a name="line-178"></a>*  work on. Including their simplification depths.                     *
<a name="line-179"></a>*                                                                      *
<a name="line-180"></a>*                                                                      *
<a name="line-181"></a>************************************************************************
<a name="line-182"></a>
<a name="line-183"></a>Note [WorkList priorities]
<a name="line-184"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-185"></a>A WorkList contains canonical and non-canonical items (of all flavors).
<a name="line-186"></a>Notice that each Ct now has a simplification depth. We may
<a name="line-187"></a>consider using this depth for prioritization as well in the future.
<a name="line-188"></a>
<a name="line-189"></a>As a simple form of priority queue, our worklist separates out
<a name="line-190"></a>equalities (wl_eqs) from the rest of the canonical constraints,
<a name="line-191"></a>so that it's easier to deal with them first, but the separation
<a name="line-192"></a>is not strictly necessary. Notice that non-canonical constraints
<a name="line-193"></a>are also parts of the worklist.
<a name="line-194"></a>
<a name="line-195"></a>Note [Process derived items last]
<a name="line-196"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-197"></a>We can often solve all goals without processing *any* derived constraints.
<a name="line-198"></a>The derived constraints are just there to help us if we get stuck.  So
<a name="line-199"></a>we keep them in a separate list.
<a name="line-200"></a>
<a name="line-201"></a>Note [Prioritise class equalities]
<a name="line-202"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-203"></a>We prioritise equalities in the solver (see selectWorkItem). But class
<a name="line-204"></a>constraints like (a ~ b) and (a ~~ b) are actually equalities too;
<a name="line-205"></a>see Note [The equality types story] in TysPrim.
<a name="line-206"></a>
<a name="line-207"></a>Failing to prioritise these is inefficient (more kick-outs etc).
<a name="line-208"></a>But, worse, it can prevent us spotting a "recursive knot" among
<a name="line-209"></a>Wanted constraints.  See comment:10 of Trac #12734 for a worked-out
<a name="line-210"></a>example.
<a name="line-211"></a>
<a name="line-212"></a>So we arrange to put these particular class constraints in the wl_eqs.
<a name="line-213"></a>
<a name="line-214"></a>  NB: since we do not currently apply the substitution to the
<a name="line-215"></a>  inert_solved_dicts, the knot-tying still seems a bit fragile.
<a name="line-216"></a>  But this makes it better.
<a name="line-217"></a>-}</span>
<a name="line-218"></a>
<a name="line-219"></a><a name="WorkList"></a><span class='hs-comment'>-- See Note [WorkList priorities]</span>
<a name="line-220"></a><a name="WorkList"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>WorkList</span>
<a name="line-221"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- Both equality constraints and their</span>
<a name="line-222"></a>                             <span class='hs-comment'>-- class-level variants (a~b) and (a~~b);</span>
<a name="line-223"></a>                             <span class='hs-comment'>-- See Note [Prioritise class equalities]</span>
<a name="line-224"></a>
<a name="line-225"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- LIFO stack of goals</span>
<a name="line-226"></a>
<a name="line-227"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span>    <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-228"></a>
<a name="line-229"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wl_deriv</span>   <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CtEvidence</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- Implicitly non-canonical</span>
<a name="line-230"></a>                                     <span class='hs-comment'>-- See Note [Process derived items last]</span>
<a name="line-231"></a>
<a name="line-232"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span>  <span class='hs-comment'>-- See Note [Residual implications]</span>
<a name="line-233"></a>    <span class='hs-layout'>}</span>
<a name="line-234"></a>
<a name="line-235"></a><a name="appendWorkList"></a><span class='hs-definition'>appendWorkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-236"></a><span class='hs-definition'>appendWorkList</span>
<a name="line-237"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest1</span>
<a name="line-238"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>wl_deriv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ders1</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-239"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest2</span>
<a name="line-240"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>wl_deriv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ders2</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-241"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs1</span>     <span class='hs-varop'>++</span> <span class='hs-varid'>eqs2</span>
<a name="line-242"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqs1</span>  <span class='hs-varop'>++</span> <span class='hs-varid'>funeqs2</span>
<a name="line-243"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest1</span>    <span class='hs-varop'>++</span> <span class='hs-varid'>rest2</span>
<a name="line-244"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>wl_deriv</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ders1</span>    <span class='hs-varop'>++</span> <span class='hs-varid'>ders2</span>
<a name="line-245"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics1</span> <span class='hs-varop'>`unionBags`</span>   <span class='hs-varid'>implics2</span> <span class='hs-layout'>}</span>
<a name="line-246"></a>
<a name="line-247"></a><a name="workListSize"></a><span class='hs-definition'>workListSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-248"></a><span class='hs-definition'>workListSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_deriv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ders</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-249"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>eqs</span> <span class='hs-varop'>+</span> <span class='hs-varid'>length</span> <span class='hs-varid'>funeqs</span> <span class='hs-varop'>+</span> <span class='hs-varid'>length</span> <span class='hs-varid'>rest</span> <span class='hs-varop'>+</span> <span class='hs-varid'>length</span> <span class='hs-varid'>ders</span>
<a name="line-250"></a>
<a name="line-251"></a><a name="workListWantedCount"></a><span class='hs-definition'>workListWantedCount</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-252"></a><span class='hs-definition'>workListWantedCount</span> <span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-253"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count</span> <span class='hs-varid'>isWantedCt</span> <span class='hs-varid'>eqs</span> <span class='hs-varop'>+</span> <span class='hs-varid'>count</span> <span class='hs-varid'>isWantedCt</span> <span class='hs-varid'>rest</span>
<a name="line-254"></a>
<a name="line-255"></a><a name="extendWorkListEq"></a><span class='hs-definition'>extendWorkListEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-256"></a><span class='hs-definition'>extendWorkListEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>}</span>
<a name="line-257"></a>
<a name="line-258"></a><a name="extendWorkListEqs"></a><span class='hs-definition'>extendWorkListEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-259"></a><span class='hs-definition'>extendWorkListEqs</span> <span class='hs-varid'>cts</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span> <span class='hs-varop'>++</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>}</span>
<a name="line-260"></a>
<a name="line-261"></a><a name="extendWorkListFunEq"></a><span class='hs-definition'>extendWorkListFunEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-262"></a><span class='hs-definition'>extendWorkListFunEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>}</span>
<a name="line-263"></a>
<a name="line-264"></a><a name="extendWorkListNonEq"></a><span class='hs-definition'>extendWorkListNonEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-265"></a><span class='hs-comment'>-- Extension by non equality</span>
<a name="line-266"></a><span class='hs-definition'>extendWorkListNonEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>wl_rest</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>}</span>
<a name="line-267"></a>
<a name="line-268"></a><a name="extendWorkListDerived"></a><span class='hs-definition'>extendWorkListDerived</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-269"></a><span class='hs-definition'>extendWorkListDerived</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>wl</span>
<a name="line-270"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDroppableDerivedLoc</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_deriv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-conop'>:</span> <span class='hs-varid'>wl_deriv</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>}</span>
<a name="line-271"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendWorkListEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNonCanonical</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span> <span class='hs-varid'>wl</span>
<a name="line-272"></a>
<a name="line-273"></a><a name="extendWorkListDeriveds"></a><span class='hs-definition'>extendWorkListDeriveds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CtEvidence</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-274"></a><span class='hs-definition'>extendWorkListDeriveds</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>evs</span> <span class='hs-varid'>wl</span>
<a name="line-275"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDroppableDerivedLoc</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_deriv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>wl_deriv</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>}</span>
<a name="line-276"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendWorkListEqs</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mkNonCanonical</span> <span class='hs-varid'>evs</span><span class='hs-layout'>)</span> <span class='hs-varid'>wl</span>
<a name="line-277"></a>
<a name="line-278"></a><a name="extendWorkListImplic"></a><span class='hs-definition'>extendWorkListImplic</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-279"></a><span class='hs-definition'>extendWorkListImplic</span> <span class='hs-varid'>implics</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>wl_implics</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>}</span>
<a name="line-280"></a>
<a name="line-281"></a><a name="extendWorkListCt"></a><span class='hs-definition'>extendWorkListCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-282"></a><span class='hs-comment'>-- Agnostic</span>
<a name="line-283"></a><span class='hs-definition'>extendWorkListCt</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-284"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-285"></a>     <span class='hs-conid'>EqPred</span> <span class='hs-conid'>NomEq</span> <span class='hs-varid'>ty1</span> <span class='hs-keyword'>_</span>
<a name="line-286"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyConAppTyCon_maybe</span> <span class='hs-varid'>ty1</span>
<a name="line-287"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>isTypeFamilyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-288"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendWorkListFunEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-289"></a>
<a name="line-290"></a>     <span class='hs-conid'>EqPred</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>
<a name="line-291"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendWorkListEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-292"></a>
<a name="line-293"></a>     <span class='hs-conid'>ClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-keyword'>_</span>  <span class='hs-comment'>-- See Note [Prioritise class equalities]</span>
<a name="line-294"></a>       <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>cls</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>heqTyConKey</span>
<a name="line-295"></a>       <span class='hs-varop'>||</span> <span class='hs-varid'>cls</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqTyConKey</span>
<a name="line-296"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendWorkListEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-297"></a>
<a name="line-298"></a>     <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendWorkListNonEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-299"></a>
<a name="line-300"></a><a name="extendWorkListCts"></a><span class='hs-definition'>extendWorkListCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-301"></a><span class='hs-comment'>-- Agnostic</span>
<a name="line-302"></a><span class='hs-definition'>extendWorkListCts</span> <span class='hs-varid'>cts</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>extendWorkListCt</span> <span class='hs-varid'>wl</span> <span class='hs-varid'>cts</span>
<a name="line-303"></a>
<a name="line-304"></a><a name="isEmptyWorkList"></a><span class='hs-definition'>isEmptyWorkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-305"></a><span class='hs-definition'>isEmptyWorkList</span> <span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqs</span>
<a name="line-306"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_deriv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ders</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-307"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>null</span> <span class='hs-varid'>eqs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>rest</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>funeqs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>implics</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>ders</span>
<a name="line-308"></a>
<a name="line-309"></a><a name="emptyWorkList"></a><span class='hs-definition'>emptyWorkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span>
<a name="line-310"></a><span class='hs-definition'>emptyWorkList</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-311"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_deriv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>}</span>
<a name="line-312"></a>
<a name="line-313"></a><a name="selectWorkItem"></a><span class='hs-definition'>selectWorkItem</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span><span class='hs-layout'>,</span> <span class='hs-conid'>WorkList</span><span class='hs-layout'>)</span>
<a name="line-314"></a><span class='hs-definition'>selectWorkItem</span> <span class='hs-varid'>wl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>feqs</span>
<a name="line-315"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-316"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>eqs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-317"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>fes</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>feqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fes</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-318"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_rest</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-319"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-320"></a>
<a name="line-321"></a><a name="getWorkList"></a><span class='hs-definition'>getWorkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>WorkList</span>
<a name="line-322"></a><span class='hs-definition'>getWorkList</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSWorkListRef</span>
<a name="line-323"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>wl_var</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-324"></a>
<a name="line-325"></a><a name="selectDerivedWorkItem"></a><span class='hs-definition'>selectDerivedWorkItem</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span><span class='hs-layout'>,</span> <span class='hs-conid'>WorkList</span><span class='hs-layout'>)</span>
<a name="line-326"></a><span class='hs-definition'>selectDerivedWorkItem</span> <span class='hs-varid'>wl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_deriv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ders</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-327"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ev</span><span class='hs-conop'>:</span><span class='hs-varid'>evs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ders</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNonCanonical</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_deriv</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-328"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-329"></a>
<a name="line-330"></a><a name="selectNextWorkItem"></a><span class='hs-definition'>selectNextWorkItem</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span>
<a name="line-331"></a><span class='hs-definition'>selectNextWorkItem</span>
<a name="line-332"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSWorkListRef</span>
<a name="line-333"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>wl_var</span><span class='hs-layout'>)</span>
<a name="line-334"></a>
<a name="line-335"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>try</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span><span class='hs-layout'>,</span><span class='hs-conid'>WorkList</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span>
<a name="line-336"></a>             <span class='hs-varid'>try</span> <span class='hs-varid'>mb_work</span> <span class='hs-varid'>do_this_if_fail</span>
<a name="line-337"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_wl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mb_work</span>
<a name="line-338"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkReductionDepth</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLoc</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-339"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>wl_var</span> <span class='hs-varid'>new_wl</span><span class='hs-layout'>)</span>
<a name="line-340"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-341"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-342"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_this_if_fail</span>
<a name="line-343"></a>
<a name="line-344"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>try</span> <span class='hs-layout'>(</span><span class='hs-varid'>selectWorkItem</span> <span class='hs-varid'>wl</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-345"></a>
<a name="line-346"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-347"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>inert_count</span> <span class='hs-varid'>ics</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>
<a name="line-348"></a>         <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-349"></a>         <span class='hs-keyword'>else</span> <span class='hs-varid'>try</span> <span class='hs-layout'>(</span><span class='hs-varid'>selectDerivedWorkItem</span> <span class='hs-varid'>wl</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-350"></a>
<a name="line-351"></a><a name="instance%20Outputable%20WorkList"></a><span class='hs-comment'>-- Pretty printing</span>
<a name="line-352"></a><a name="instance%20Outputable%20WorkList"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyword'>where</span>
<a name="line-353"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>feqs</span>
<a name="line-354"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_deriv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ders</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-355"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"WL"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>braces</span> <span class='hs-varop'>$</span>
<a name="line-356"></a>     <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-357"></a>            <span class='hs-varid'>text</span> <span class='hs-str'>"Eqs ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>)</span>
<a name="line-358"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>feqs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-359"></a>            <span class='hs-varid'>text</span> <span class='hs-str'>"Funeqs ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>feqs</span><span class='hs-layout'>)</span>
<a name="line-360"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-361"></a>            <span class='hs-varid'>text</span> <span class='hs-str'>"Non-eqs ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span>
<a name="line-362"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>ders</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-363"></a>            <span class='hs-varid'>text</span> <span class='hs-str'>"Derived ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ders</span><span class='hs-layout'>)</span>
<a name="line-364"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>implics</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-365"></a>            <span class='hs-varid'>ifPprDebug</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Implics ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>implics</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-366"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"(Implics omitted)"</span><span class='hs-layout'>)</span>
<a name="line-367"></a>          <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-368"></a>
<a name="line-369"></a>
<a name="line-370"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-371"></a>*                                                                      *
<a name="line-372"></a>                InertSet: the inert set
<a name="line-373"></a>*                                                                      *
<a name="line-374"></a>*                                                                      *
<a name="line-375"></a>********************************************************************* -}</span>
<a name="line-376"></a>
<a name="line-377"></a><a name="InertSet"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>InertSet</span>
<a name="line-378"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span>
<a name="line-379"></a>              <span class='hs-comment'>-- Canonical Given, Wanted, Derived</span>
<a name="line-380"></a>              <span class='hs-comment'>-- Sometimes called "the inert set"</span>
<a name="line-381"></a>
<a name="line-382"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_fsks</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TcTyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-383"></a>              <span class='hs-comment'>-- A list of (fsk, ty) pairs; we add one element when we flatten</span>
<a name="line-384"></a>              <span class='hs-comment'>-- a function application in a Given constraint, creating</span>
<a name="line-385"></a>              <span class='hs-comment'>-- a new fsk in newFlattenSkolem.  When leaving a nested scope,</span>
<a name="line-386"></a>              <span class='hs-comment'>-- unflattenGivens unifies fsk := ty</span>
<a name="line-387"></a>              <span class='hs-comment'>--</span>
<a name="line-388"></a>              <span class='hs-comment'>-- We could also get this info from inert_funeqs, filtered by</span>
<a name="line-389"></a>              <span class='hs-comment'>-- level, but it seems simpler and more direct to capture the</span>
<a name="line-390"></a>              <span class='hs-comment'>-- fsk as we generate them.</span>
<a name="line-391"></a>
<a name="line-392"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_flat_cache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExactFunEqMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>CtFlavour</span><span class='hs-layout'>)</span>
<a name="line-393"></a>              <span class='hs-comment'>-- See Note [Type family equations]</span>
<a name="line-394"></a>              <span class='hs-comment'>-- If    F tys :-&gt; (co, rhs, flav),</span>
<a name="line-395"></a>              <span class='hs-comment'>-- then  co :: F tys ~ rhs</span>
<a name="line-396"></a>              <span class='hs-comment'>--       flav is [G] or [WD]</span>
<a name="line-397"></a>              <span class='hs-comment'>--</span>
<a name="line-398"></a>              <span class='hs-comment'>-- Just a hash-cons cache for use when flattening only</span>
<a name="line-399"></a>              <span class='hs-comment'>-- These include entirely un-processed goals, so don't use</span>
<a name="line-400"></a>              <span class='hs-comment'>-- them to solve a top-level goal, else you may end up solving</span>
<a name="line-401"></a>              <span class='hs-comment'>-- (w:F ty ~ a) by setting w:=w!  We just use the flat-cache</span>
<a name="line-402"></a>              <span class='hs-comment'>-- when allocating a new flatten-skolem.</span>
<a name="line-403"></a>              <span class='hs-comment'>-- Not necessarily inert wrt top-level equations (or inert_cans)</span>
<a name="line-404"></a>
<a name="line-405"></a>              <span class='hs-comment'>-- NB: An ExactFunEqMap -- this doesn't match via loose types!</span>
<a name="line-406"></a>
<a name="line-407"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_solved_dicts</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-408"></a>              <span class='hs-comment'>-- Of form ev :: C t1 .. tn</span>
<a name="line-409"></a>              <span class='hs-comment'>-- See Note [Solved dictionaries]</span>
<a name="line-410"></a>              <span class='hs-comment'>-- and Note [Do not add superclasses of solved dictionaries]</span>
<a name="line-411"></a>       <span class='hs-layout'>}</span>
<a name="line-412"></a>
<a name="line-413"></a><a name="instance%20Outputable%20InertSet"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyword'>where</span>
<a name="line-414"></a>  <span class='hs-varid'>ppr</span> <span class='hs-varid'>is</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>inert_cans</span> <span class='hs-varid'>is</span>
<a name="line-415"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>dicts</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-416"></a>                  <span class='hs-varid'>text</span> <span class='hs-str'>"Solved dicts"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dicts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-417"></a>         <span class='hs-keyword'>where</span>
<a name="line-418"></a>           <span class='hs-varid'>dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bagToList</span> <span class='hs-layout'>(</span><span class='hs-varid'>dictsToBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_solved_dicts</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-419"></a>
<a name="line-420"></a><a name="emptyInert"></a><span class='hs-definition'>emptyInert</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertSet</span>
<a name="line-421"></a><span class='hs-definition'>emptyInert</span>
<a name="line-422"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_count</span>    <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-423"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>inert_eqs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyDVarEnv</span>
<a name="line-424"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyDicts</span>
<a name="line-425"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyDicts</span>
<a name="line-426"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFunEqs</span>
<a name="line-427"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCts</span>
<a name="line-428"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>inert_insols</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCts</span> <span class='hs-layout'>}</span>
<a name="line-429"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_flat_cache</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyExactFunEqs</span>
<a name="line-430"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_fsks</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-431"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_solved_dicts</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyDictMap</span> <span class='hs-layout'>}</span>
<a name="line-432"></a>
<a name="line-433"></a>
<a name="line-434"></a><span class='hs-comment'>{- Note [Solved dictionaries]
<a name="line-435"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-436"></a>When we apply a top-level instance declaration, we add the "solved"
<a name="line-437"></a>dictionary to the inert_solved_dicts.  In general, we use it to avoid
<a name="line-438"></a>creating a new EvVar when we have a new goal that we have solved in
<a name="line-439"></a>the past.
<a name="line-440"></a>
<a name="line-441"></a>But in particular, we can use it to create *recursive* dictionaries.
<a name="line-442"></a>The simplest, degnerate case is
<a name="line-443"></a>    instance C [a] =&gt; C [a] where ...
<a name="line-444"></a>If we have
<a name="line-445"></a>    [W] d1 :: C [x]
<a name="line-446"></a>then we can apply the instance to get
<a name="line-447"></a>    d1 = $dfCList d
<a name="line-448"></a>    [W] d2 :: C [x]
<a name="line-449"></a>Now 'd1' goes in inert_solved_dicts, and we can solve d2 directly from d1.
<a name="line-450"></a>    d1 = $dfCList d
<a name="line-451"></a>    d2 = d1
<a name="line-452"></a>
<a name="line-453"></a>See Note [Example of recursive dictionaries]
<a name="line-454"></a>Other notes about solved dictionaries
<a name="line-455"></a>
<a name="line-456"></a>* See also Note [Do not add superclasses of solved dictionaries]
<a name="line-457"></a>
<a name="line-458"></a>* The inert_solved_dicts field is not rewritten by equalities, so it may
<a name="line-459"></a>  get out of date.
<a name="line-460"></a>
<a name="line-461"></a>Note [Do not add superclasses of solved dictionaries]
<a name="line-462"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-463"></a>Every member of inert_solved_dicts is the result of applying a dictionary
<a name="line-464"></a>function, NOT of applying superclass selection to anything.
<a name="line-465"></a>Consider
<a name="line-466"></a>
<a name="line-467"></a>        class Ord a =&gt; C a where
<a name="line-468"></a>        instance Ord [a] =&gt; C [a] where ...
<a name="line-469"></a>
<a name="line-470"></a>Suppose we are trying to solve
<a name="line-471"></a>  [G] d1 : Ord a
<a name="line-472"></a>  [W] d2 : C [a]
<a name="line-473"></a>
<a name="line-474"></a>Then we'll use the instance decl to give
<a name="line-475"></a>
<a name="line-476"></a>  [G] d1 : Ord a     Solved: d2 : C [a] = $dfCList d3
<a name="line-477"></a>  [W] d3 : Ord [a]
<a name="line-478"></a>
<a name="line-479"></a>We must not add d4 : Ord [a] to the 'solved' set (by taking the
<a name="line-480"></a>superclass of d2), otherwise we'll use it to solve d3, without ever
<a name="line-481"></a>using d1, which would be a catastrophe.
<a name="line-482"></a>
<a name="line-483"></a>Solution: when extending the solved dictionaries, do not add superclasses.
<a name="line-484"></a>That's why each element of the inert_solved_dicts is the result of applying
<a name="line-485"></a>a dictionary function.
<a name="line-486"></a>
<a name="line-487"></a>Note [Example of recursive dictionaries]
<a name="line-488"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-489"></a>--- Example 1
<a name="line-490"></a>
<a name="line-491"></a>    data D r = ZeroD | SuccD (r (D r));
<a name="line-492"></a>
<a name="line-493"></a>    instance (Eq (r (D r))) =&gt; Eq (D r) where
<a name="line-494"></a>        ZeroD     == ZeroD     = True
<a name="line-495"></a>        (SuccD a) == (SuccD b) = a == b
<a name="line-496"></a>        _         == _         = False;
<a name="line-497"></a>
<a name="line-498"></a>    equalDC :: D [] -&gt; D [] -&gt; Bool;
<a name="line-499"></a>    equalDC = (==);
<a name="line-500"></a>
<a name="line-501"></a>We need to prove (Eq (D [])). Here's how we go:
<a name="line-502"></a>
<a name="line-503"></a>   [W] d1 : Eq (D [])
<a name="line-504"></a>By instance decl of Eq (D r):
<a name="line-505"></a>   [W] d2 : Eq [D []]      where   d1 = dfEqD d2
<a name="line-506"></a>By instance decl of Eq [a]:
<a name="line-507"></a>   [W] d3 : Eq (D [])      where   d2 = dfEqList d3
<a name="line-508"></a>                                   d1 = dfEqD d2
<a name="line-509"></a>Now this wanted can interact with our "solved" d1 to get:
<a name="line-510"></a>    d3 = d1
<a name="line-511"></a>
<a name="line-512"></a>-- Example 2:
<a name="line-513"></a>This code arises in the context of "Scrap Your Boilerplate with Class"
<a name="line-514"></a>
<a name="line-515"></a>    class Sat a
<a name="line-516"></a>    class Data ctx a
<a name="line-517"></a>    instance  Sat (ctx Char)             =&gt; Data ctx Char       -- dfunData1
<a name="line-518"></a>    instance (Sat (ctx [a]), Data ctx a) =&gt; Data ctx [a]        -- dfunData2
<a name="line-519"></a>
<a name="line-520"></a>    class Data Maybe a =&gt; Foo a
<a name="line-521"></a>
<a name="line-522"></a>    instance Foo t =&gt; Sat (Maybe t)                             -- dfunSat
<a name="line-523"></a>
<a name="line-524"></a>    instance Data Maybe a =&gt; Foo a                              -- dfunFoo1
<a name="line-525"></a>    instance Foo a        =&gt; Foo [a]                            -- dfunFoo2
<a name="line-526"></a>    instance                 Foo [Char]                         -- dfunFoo3
<a name="line-527"></a>
<a name="line-528"></a>Consider generating the superclasses of the instance declaration
<a name="line-529"></a>         instance Foo a =&gt; Foo [a]
<a name="line-530"></a>
<a name="line-531"></a>So our problem is this
<a name="line-532"></a>    [G] d0 : Foo t
<a name="line-533"></a>    [W] d1 : Data Maybe [t]   -- Desired superclass
<a name="line-534"></a>
<a name="line-535"></a>We may add the given in the inert set, along with its superclasses
<a name="line-536"></a>  Inert:
<a name="line-537"></a>    [G] d0 : Foo t
<a name="line-538"></a>    [G] d01 : Data Maybe t   -- Superclass of d0
<a name="line-539"></a>  WorkList
<a name="line-540"></a>    [W] d1 : Data Maybe [t]
<a name="line-541"></a>
<a name="line-542"></a>Solve d1 using instance dfunData2; d1 := dfunData2 d2 d3
<a name="line-543"></a>  Inert:
<a name="line-544"></a>    [G] d0 : Foo t
<a name="line-545"></a>    [G] d01 : Data Maybe t   -- Superclass of d0
<a name="line-546"></a>  Solved:
<a name="line-547"></a>        d1 : Data Maybe [t]
<a name="line-548"></a>  WorkList:
<a name="line-549"></a>    [W] d2 : Sat (Maybe [t])
<a name="line-550"></a>    [W] d3 : Data Maybe t
<a name="line-551"></a>
<a name="line-552"></a>Now, we may simplify d2 using dfunSat; d2 := dfunSat d4
<a name="line-553"></a>  Inert:
<a name="line-554"></a>    [G] d0 : Foo t
<a name="line-555"></a>    [G] d01 : Data Maybe t   -- Superclass of d0
<a name="line-556"></a>  Solved:
<a name="line-557"></a>        d1 : Data Maybe [t]
<a name="line-558"></a>        d2 : Sat (Maybe [t])
<a name="line-559"></a>  WorkList:
<a name="line-560"></a>    [W] d3 : Data Maybe t
<a name="line-561"></a>    [W] d4 : Foo [t]
<a name="line-562"></a>
<a name="line-563"></a>Now, we can just solve d3 from d01; d3 := d01
<a name="line-564"></a>  Inert
<a name="line-565"></a>    [G] d0 : Foo t
<a name="line-566"></a>    [G] d01 : Data Maybe t   -- Superclass of d0
<a name="line-567"></a>  Solved:
<a name="line-568"></a>        d1 : Data Maybe [t]
<a name="line-569"></a>        d2 : Sat (Maybe [t])
<a name="line-570"></a>  WorkList
<a name="line-571"></a>    [W] d4 : Foo [t]
<a name="line-572"></a>
<a name="line-573"></a>Now, solve d4 using dfunFoo2;  d4 := dfunFoo2 d5
<a name="line-574"></a>  Inert
<a name="line-575"></a>    [G] d0  : Foo t
<a name="line-576"></a>    [G] d01 : Data Maybe t   -- Superclass of d0
<a name="line-577"></a>  Solved:
<a name="line-578"></a>        d1 : Data Maybe [t]
<a name="line-579"></a>        d2 : Sat (Maybe [t])
<a name="line-580"></a>        d4 : Foo [t]
<a name="line-581"></a>  WorkList:
<a name="line-582"></a>    [W] d5 : Foo t
<a name="line-583"></a>
<a name="line-584"></a>Now, d5 can be solved! d5 := d0
<a name="line-585"></a>
<a name="line-586"></a>Result
<a name="line-587"></a>   d1 := dfunData2 d2 d3
<a name="line-588"></a>   d2 := dfunSat d4
<a name="line-589"></a>   d3 := d01
<a name="line-590"></a>   d4 := dfunFoo2 d5
<a name="line-591"></a>   d5 := d0
<a name="line-592"></a>-}</span>
<a name="line-593"></a>
<a name="line-594"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-595"></a>*                                                                      *
<a name="line-596"></a>                InertCans: the canonical inerts
<a name="line-597"></a>*                                                                      *
<a name="line-598"></a>*                                                                      *
<a name="line-599"></a>********************************************************************* -}</span>
<a name="line-600"></a>
<a name="line-601"></a><a name="InertCans"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>InertCans</span>   <span class='hs-comment'>-- See Note [Detailed InertCans Invariants] for more</span>
<a name="line-602"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertEqs</span>
<a name="line-603"></a>              <span class='hs-comment'>-- See Note [inert_eqs: the inert equalities]</span>
<a name="line-604"></a>              <span class='hs-comment'>-- All CTyEqCans; index is the LHS tyvar</span>
<a name="line-605"></a>              <span class='hs-comment'>-- Domain = skolems and untouchables; a touchable would be unified</span>
<a name="line-606"></a>
<a name="line-607"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>Ct</span>
<a name="line-608"></a>              <span class='hs-comment'>-- All CFunEqCans; index is the whole family head type.</span>
<a name="line-609"></a>              <span class='hs-comment'>-- All Nominal (that's an invarint of all CFunEqCans)</span>
<a name="line-610"></a>              <span class='hs-comment'>-- LHS is fully rewritten (modulo eqCanRewrite constraints)</span>
<a name="line-611"></a>              <span class='hs-comment'>--     wrt inert_eqs</span>
<a name="line-612"></a>              <span class='hs-comment'>-- Can include all flavours, [G], [W], [WD], [D]</span>
<a name="line-613"></a>              <span class='hs-comment'>-- See Note [Type family equations]</span>
<a name="line-614"></a>
<a name="line-615"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span>
<a name="line-616"></a>              <span class='hs-comment'>-- Dictionaries only</span>
<a name="line-617"></a>              <span class='hs-comment'>-- All fully rewritten (modulo flavour constraints)</span>
<a name="line-618"></a>              <span class='hs-comment'>--     wrt inert_eqs</span>
<a name="line-619"></a>
<a name="line-620"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span>
<a name="line-621"></a>              <span class='hs-comment'>-- Failed dictionary resolution due to Safe Haskell overlapping</span>
<a name="line-622"></a>              <span class='hs-comment'>-- instances restriction. We keep this separate from inert_dicts</span>
<a name="line-623"></a>              <span class='hs-comment'>-- as it doesn't cause compilation failure, just safe inference</span>
<a name="line-624"></a>              <span class='hs-comment'>-- failure.</span>
<a name="line-625"></a>              <span class='hs-comment'>--</span>
<a name="line-626"></a>              <span class='hs-comment'>-- ^ See Note [Safe Haskell Overlapping Instances Implementation]</span>
<a name="line-627"></a>              <span class='hs-comment'>-- in TcSimplify</span>
<a name="line-628"></a>
<a name="line-629"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span>
<a name="line-630"></a>              <span class='hs-comment'>-- Irreducible predicates</span>
<a name="line-631"></a>
<a name="line-632"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_insols</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span>
<a name="line-633"></a>              <span class='hs-comment'>-- Frozen errors (as non-canonicals)</span>
<a name="line-634"></a>
<a name="line-635"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_count</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-636"></a>              <span class='hs-comment'>-- Number of Wanted goals in</span>
<a name="line-637"></a>              <span class='hs-comment'>--     inert_eqs, inert_dicts, inert_safehask, inert_irreds</span>
<a name="line-638"></a>              <span class='hs-comment'>-- Does not include insolubles</span>
<a name="line-639"></a>              <span class='hs-comment'>-- When non-zero, keep trying to solved</span>
<a name="line-640"></a>       <span class='hs-layout'>}</span>
<a name="line-641"></a>
<a name="line-642"></a><a name="InertEqs"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>InertEqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DTyVarEnv</span> <span class='hs-conid'>EqualCtList</span>
<a name="line-643"></a><a name="EqualCtList"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- See Note [EqualCtList invariants]</span>
<a name="line-644"></a>
<a name="line-645"></a><span class='hs-comment'>{- Note [Detailed InertCans Invariants]
<a name="line-646"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-647"></a>The InertCans represents a collection of constraints with the following properties:
<a name="line-648"></a>
<a name="line-649"></a>  * All canonical
<a name="line-650"></a>
<a name="line-651"></a>  * No two dictionaries with the same head
<a name="line-652"></a>  * No two CIrreds with the same type
<a name="line-653"></a>
<a name="line-654"></a>  * Family equations inert wrt top-level family axioms
<a name="line-655"></a>
<a name="line-656"></a>  * Dictionaries have no matching top-level instance
<a name="line-657"></a>
<a name="line-658"></a>  * Given family or dictionary constraints don't mention touchable
<a name="line-659"></a>    unification variables
<a name="line-660"></a>
<a name="line-661"></a>  * Non-CTyEqCan constraints are fully rewritten with respect
<a name="line-662"></a>    to the CTyEqCan equalities (modulo canRewrite of course;
<a name="line-663"></a>    eg a wanted cannot rewrite a given)
<a name="line-664"></a>
<a name="line-665"></a>  * CTyEqCan equalities: see Note [Applying the inert substitution]
<a name="line-666"></a>                         in TcFlatten
<a name="line-667"></a>
<a name="line-668"></a>Note [EqualCtList invariants]
<a name="line-669"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-670"></a>    * All are equalities
<a name="line-671"></a>    * All these equalities have the same LHS
<a name="line-672"></a>    * The list is never empty
<a name="line-673"></a>    * No element of the list can rewrite any other
<a name="line-674"></a>    * Derived before Wanted
<a name="line-675"></a>
<a name="line-676"></a>From the fourth invariant it follows that the list is
<a name="line-677"></a>   - A single [G], or
<a name="line-678"></a>   - Zero or one [D] or [WD], followd by any number of [W]
<a name="line-679"></a>
<a name="line-680"></a>The Wanteds can't rewrite anything which is why we put them last
<a name="line-681"></a>
<a name="line-682"></a>Note [Type family equations]
<a name="line-683"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-684"></a>Type-family equations, CFunEqCans, of form (ev : F tys ~ ty),
<a name="line-685"></a>live in three places
<a name="line-686"></a>
<a name="line-687"></a>  * The work-list, of course
<a name="line-688"></a>
<a name="line-689"></a>  * The inert_funeqs are un-solved but fully processed, and in
<a name="line-690"></a>    the InertCans. They can be [G], [W], [WD], or [D].
<a name="line-691"></a>
<a name="line-692"></a>  * The inert_flat_cache.  This is used when flattening, to get maximal
<a name="line-693"></a>    sharing. Everthing in the inert_flat_cache is [G] or [WD]
<a name="line-694"></a>
<a name="line-695"></a>    It contains lots of things that are still in the work-list.
<a name="line-696"></a>    E.g Suppose we have (w1: F (G a) ~ Int), and (w2: H (G a) ~ Int) in the
<a name="line-697"></a>        work list.  Then we flatten w1, dumping (w3: G a ~ f1) in the work
<a name="line-698"></a>        list.  Now if we flatten w2 before we get to w3, we still want to
<a name="line-699"></a>        share that (G a).
<a name="line-700"></a>    Because it contains work-list things, DO NOT use the flat cache to solve
<a name="line-701"></a>    a top-level goal.  Eg in the above example we don't want to solve w3
<a name="line-702"></a>    using w3 itself!
<a name="line-703"></a>
<a name="line-704"></a>The CFunEqCan Ownership Invariant:
<a name="line-705"></a>
<a name="line-706"></a>  * Each [G/W/WD] CFunEqCan has a distinct fsk or fmv
<a name="line-707"></a>    It "owns" that fsk/fmv, in the sense that:
<a name="line-708"></a>      - reducing a [W/WD] CFunEqCan fills in the fmv
<a name="line-709"></a>      - unflattening a [W/WD] CFunEqCan fills in the fmv
<a name="line-710"></a>      (in both cases unless an occurs-check would result)
<a name="line-711"></a>
<a name="line-712"></a>  * In contrast a [D] CFunEqCan does not "own" its fmv:
<a name="line-713"></a>      - reducing a [D] CFunEqCan does not fill in the fmv;
<a name="line-714"></a>        it just generates an equality
<a name="line-715"></a>      - unflattening ignores [D] CFunEqCans altogether
<a name="line-716"></a>
<a name="line-717"></a>
<a name="line-718"></a>Note [inert_eqs: the inert equalities]
<a name="line-719"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-720"></a>Definition [Can-rewrite relation]
<a name="line-721"></a>A "can-rewrite" relation between flavours, written f1 &gt;= f2, is a
<a name="line-722"></a>binary relation with the following properties
<a name="line-723"></a>
<a name="line-724"></a>  (R1) &gt;= is transitive
<a name="line-725"></a>  (R2) If f1 &gt;= f, and f2 &gt;= f,
<a name="line-726"></a>       then either f1 &gt;= f2 or f2 &gt;= f1
<a name="line-727"></a>
<a name="line-728"></a>Lemma.  If f1 &gt;= f then f1 &gt;= f1
<a name="line-729"></a>Proof.  By property (R2), with f1=f2
<a name="line-730"></a>
<a name="line-731"></a>Definition [Generalised substitution]
<a name="line-732"></a>A "generalised substitution" S is a set of triples (a -f-&gt; t), where
<a name="line-733"></a>  a is a type variable
<a name="line-734"></a>  t is a type
<a name="line-735"></a>  f is a flavour
<a name="line-736"></a>such that
<a name="line-737"></a>  (WF1) if (a -f1-&gt; t1) in S
<a name="line-738"></a>           (a -f2-&gt; t2) in S
<a name="line-739"></a>        then neither (f1 &gt;= f2) nor (f2 &gt;= f1) hold
<a name="line-740"></a>  (WF2) if (a -f-&gt; t) is in S, then t /= a
<a name="line-741"></a>
<a name="line-742"></a>Definition [Applying a generalised substitution]
<a name="line-743"></a>If S is a generalised substitution
<a name="line-744"></a>   S(f,a) = t,  if (a -fs-&gt; t) in S, and fs &gt;= f
<a name="line-745"></a>          = a,  otherwise
<a name="line-746"></a>Application extends naturally to types S(f,t), modulo roles.
<a name="line-747"></a>See Note [Flavours with roles].
<a name="line-748"></a>
<a name="line-749"></a>Theorem: S(f,a) is well defined as a function.
<a name="line-750"></a>Proof: Suppose (a -f1-&gt; t1) and (a -f2-&gt; t2) are both in S,
<a name="line-751"></a>               and  f1 &gt;= f and f2 &gt;= f
<a name="line-752"></a>       Then by (R2) f1 &gt;= f2 or f2 &gt;= f1, which contradicts (WF1)
<a name="line-753"></a>
<a name="line-754"></a>Notation: repeated application.
<a name="line-755"></a>  S^0(f,t)     = t
<a name="line-756"></a>  S^(n+1)(f,t) = S(f, S^n(t))
<a name="line-757"></a>
<a name="line-758"></a>Definition: inert generalised substitution
<a name="line-759"></a>A generalised substitution S is "inert" iff
<a name="line-760"></a>
<a name="line-761"></a>  (IG1) there is an n such that
<a name="line-762"></a>        for every f,t, S^n(f,t) = S^(n+1)(f,t)
<a name="line-763"></a>
<a name="line-764"></a>By (IG1) we define S*(f,t) to be the result of exahaustively
<a name="line-765"></a>applying S(f,_) to t.
<a name="line-766"></a>
<a name="line-767"></a>----------------------------------------------------------------
<a name="line-768"></a>Our main invariant:
<a name="line-769"></a>   the inert CTyEqCans should be an inert generalised substitution
<a name="line-770"></a>----------------------------------------------------------------
<a name="line-771"></a>
<a name="line-772"></a>Note that inertness is not the same as idempotence.  To apply S to a
<a name="line-773"></a>type, you may have to apply it recursive.  But inertness does
<a name="line-774"></a>guarantee that this recursive use will terminate.
<a name="line-775"></a>
<a name="line-776"></a>Note [Extending the inert equalities]
<a name="line-777"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-778"></a>Theorem [Stability under extension]
<a name="line-779"></a>   This is the main theorem!
<a name="line-780"></a>   Suppose we have a "work item"
<a name="line-781"></a>       a -fw-&gt; t
<a name="line-782"></a>   and an inert generalised substitution S,
<a name="line-783"></a>   such that
<a name="line-784"></a>      (T1) S(fw,a) = a     -- LHS of work-item is a fixpoint of S(fw,_)
<a name="line-785"></a>      (T2) S(fw,t) = t     -- RHS of work-item is a fixpoint of S(fw,_)
<a name="line-786"></a>      (T3) a not in t      -- No occurs check in the work item
<a name="line-787"></a>
<a name="line-788"></a>      (K1) for every (a -fs-&gt; s) in S, then not (fw &gt;= fs)
<a name="line-789"></a>           Reason: the work item is fully rewritten by S, hence not (fs &gt;= fw)
<a name="line-790"></a>                   but if (fw &gt;= fs) then the work item could rewrite
<a name="line-791"></a>                   the inert item
<a name="line-792"></a>
<a name="line-793"></a>      (K2) for every (b -fs-&gt; s) in S, where b /= a, then
<a name="line-794"></a>              (K2a) not (fs &gt;= fs)
<a name="line-795"></a>           or (K2b) fs &gt;= fw
<a name="line-796"></a>           or (K2c) not (fw &gt;= fs)
<a name="line-797"></a>           or (K2d) a not in s
<a name="line-798"></a>
<a name="line-799"></a>      (K3) See Note [K3: completeness of solving]
<a name="line-800"></a>           If (b -fs-&gt; s) is in S with (fw &gt;= fs), then
<a name="line-801"></a>        (K3a) If the role of fs is nominal: s /= a
<a name="line-802"></a>        (K3b) If the role of fs is representational: EITHER
<a name="line-803"></a>                a not in s, OR
<a name="line-804"></a>                the path from the top of s to a includes at least one non-newtype
<a name="line-805"></a>
<a name="line-806"></a>   then the extended substitution T = S+(a -fw-&gt; t)
<a name="line-807"></a>   is an inert generalised substitution.
<a name="line-808"></a>
<a name="line-809"></a>Conditions (T1-T3) are established by the canonicaliser
<a name="line-810"></a>Conditions (K1-K3) are established by TcSMonad.kickOutRewritable
<a name="line-811"></a>
<a name="line-812"></a>The idea is that
<a name="line-813"></a>* (T1-2) are guaranteed by exhaustively rewriting the work-item
<a name="line-814"></a>  with S(fw,_).
<a name="line-815"></a>
<a name="line-816"></a>* T3 is guaranteed by a simple occurs-check on the work item.
<a name="line-817"></a>  This is done during canonicalisation, in canEqTyVar;
<a name="line-818"></a>  (invariant: a CTyEqCan never has an occurs check).
<a name="line-819"></a>
<a name="line-820"></a>* (K1-3) are the "kick-out" criteria.  (As stated, they are really the
<a name="line-821"></a>  "keep" criteria.) If the current inert S contains a triple that does
<a name="line-822"></a>  not satisfy (K1-3), then we remove it from S by "kicking it out",
<a name="line-823"></a>  and re-processing it.
<a name="line-824"></a>
<a name="line-825"></a>* Note that kicking out is a Bad Thing, because it means we have to
<a name="line-826"></a>  re-process a constraint.  The less we kick out, the better.
<a name="line-827"></a>  TODO: Make sure that kicking out really *is* a Bad Thing. We've assumed
<a name="line-828"></a>  this but haven't done the empirical study to check.
<a name="line-829"></a>
<a name="line-830"></a>* Assume we have  G&gt;=G, G&gt;=W and that's all.  Then, when performing
<a name="line-831"></a>  a unification we add a new given  a -G-&gt; ty.  But doing so does NOT require
<a name="line-832"></a>  us to kick out an inert wanted that mentions a, because of (K2a).  This
<a name="line-833"></a>  is a common case, hence good not to kick out.
<a name="line-834"></a>
<a name="line-835"></a>* Lemma (L2): if not (fw &gt;= fw), then K1-K3 all hold.
<a name="line-836"></a>  Proof: using Definition [Can-rewrite relation], fw can't rewrite anything
<a name="line-837"></a>         and so K1-K3 hold.  Intuitively, since fw can't rewrite anything,
<a name="line-838"></a>         adding it cannot cause any loops
<a name="line-839"></a>  This is a common case, because Wanteds cannot rewrite Wanteds.
<a name="line-840"></a>
<a name="line-841"></a>* Lemma (L1): The conditions of the Main Theorem imply that there is no
<a name="line-842"></a>              (a -fs-&gt; t) in S, s.t.  (fs &gt;= fw).
<a name="line-843"></a>  Proof. Suppose the contrary (fs &gt;= fw).  Then because of (T1),
<a name="line-844"></a>  S(fw,a)=a.  But since fs&gt;=fw, S(fw,a) = s, hence s=a.  But now we
<a name="line-845"></a>  have (a -fs-&gt; a) in S, which contradicts (WF2).
<a name="line-846"></a>
<a name="line-847"></a>* The extended substitution satisfies (WF1) and (WF2)
<a name="line-848"></a>  - (K1) plus (L1) guarantee that the extended substitution satisfies (WF1).
<a name="line-849"></a>  - (T3) guarantees (WF2).
<a name="line-850"></a>
<a name="line-851"></a>* (K2) is about inertness.  Intuitively, any infinite chain T^0(f,t),
<a name="line-852"></a>  T^1(f,t), T^2(f,T).... must pass through the new work item infnitely
<a name="line-853"></a>  often, since the substitution without the work item is inert; and must
<a name="line-854"></a>  pass through at least one of the triples in S infnitely often.
<a name="line-855"></a>
<a name="line-856"></a>  - (K2a): if not(fs&gt;=fs) then there is no f that fs can rewrite (fs&gt;=f),
<a name="line-857"></a>    and hence this triple never plays a role in application S(f,a).
<a name="line-858"></a>    It is always safe to extend S with such a triple.
<a name="line-859"></a>
<a name="line-860"></a>    (NB: we could strengten K1) in this way too, but see K3.
<a name="line-861"></a>
<a name="line-862"></a>  - (K2b): If this holds then, by (T2), b is not in t.  So applying the
<a name="line-863"></a>    work item does not genenerate any new opportunities for applying S
<a name="line-864"></a>
<a name="line-865"></a>  - (K2c): If this holds, we can't pass through this triple infinitely
<a name="line-866"></a>    often, because if we did then fs&gt;=f, fw&gt;=f, hence by (R2)
<a name="line-867"></a>      * either fw&gt;=fs, contradicting K2c
<a name="line-868"></a>      * or fs&gt;=fw; so by the argument in K2b we can't have a loop
<a name="line-869"></a>
<a name="line-870"></a>  - (K2d): if a not in s, we hae no further opportunity to apply the
<a name="line-871"></a>    work item, similar to (K2b)
<a name="line-872"></a>
<a name="line-873"></a>  NB: Dimitrios has a PDF that does this in more detail
<a name="line-874"></a>
<a name="line-875"></a>Key lemma to make it watertight.
<a name="line-876"></a>  Under the conditions of the Main Theorem,
<a name="line-877"></a>  forall f st fw &gt;= f, a is not in S^k(f,t), for any k
<a name="line-878"></a>
<a name="line-879"></a>Also, consider roles more carefully. See Note [Flavours with roles]
<a name="line-880"></a>
<a name="line-881"></a>Note [K3: completeness of solving]
<a name="line-882"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-883"></a>(K3) is not necessary for the extended substitution
<a name="line-884"></a>to be inert.  In fact K1 could be made stronger by saying
<a name="line-885"></a>   ... then (not (fw &gt;= fs) or not (fs &gt;= fs))
<a name="line-886"></a>But it's not enough for S to be inert; we also want completeness.
<a name="line-887"></a>That is, we want to be able to solve all soluble wanted equalities.
<a name="line-888"></a>Suppose we have
<a name="line-889"></a>
<a name="line-890"></a>   work-item   b -G-&gt; a
<a name="line-891"></a>   inert-item  a -W-&gt; b
<a name="line-892"></a>
<a name="line-893"></a>Assuming (G &gt;= W) but not (W &gt;= W), this fulfills all the conditions,
<a name="line-894"></a>so we could extend the inerts, thus:
<a name="line-895"></a>
<a name="line-896"></a>   inert-items   b -G-&gt; a
<a name="line-897"></a>                 a -W-&gt; b
<a name="line-898"></a>
<a name="line-899"></a>But if we kicked-out the inert item, we'd get
<a name="line-900"></a>
<a name="line-901"></a>   work-item     a -W-&gt; b
<a name="line-902"></a>   inert-item    b -G-&gt; a
<a name="line-903"></a>
<a name="line-904"></a>Then rewrite the work-item gives us (a -W-&gt; a), which is soluble via Refl.
<a name="line-905"></a>So we add one more clause to the kick-out criteria
<a name="line-906"></a>
<a name="line-907"></a>Another way to understand (K3) is that we treat an inert item
<a name="line-908"></a>        a -f-&gt; b
<a name="line-909"></a>in the same way as
<a name="line-910"></a>        b -f-&gt; a
<a name="line-911"></a>So if we kick out one, we should kick out the other.  The orientation
<a name="line-912"></a>is somewhat accidental.
<a name="line-913"></a>
<a name="line-914"></a>When considering roles, we also need the second clause (K3b). Consider
<a name="line-915"></a>
<a name="line-916"></a>  inert-item   a -W/R-&gt; b c
<a name="line-917"></a>  work-item    c -G/N-&gt; a
<a name="line-918"></a>
<a name="line-919"></a>The work-item doesn't get rewritten by the inert, because (&gt;=) doesn't hold.
<a name="line-920"></a>We've satisfied conditions (T1)-(T3) and (K1) and (K2). If all we had were
<a name="line-921"></a>condition (K3a), then we would keep the inert around and add the work item.
<a name="line-922"></a>But then, consider if we hit the following:
<a name="line-923"></a>
<a name="line-924"></a>  work-item2   b -G/N-&gt; Id
<a name="line-925"></a>
<a name="line-926"></a>where
<a name="line-927"></a>
<a name="line-928"></a>  newtype Id x = Id x
<a name="line-929"></a>
<a name="line-930"></a>For similar reasons, if we only had (K3a), we wouldn't kick the
<a name="line-931"></a>representational inert out. And then, we'd miss solving the inert, which
<a name="line-932"></a>now reduced to reflexivity. The solution here is to kick out representational
<a name="line-933"></a>inerts whenever the tyvar of a work item is "exposed", where exposed means
<a name="line-934"></a>not under some proper data-type constructor, like [] or Maybe. See
<a name="line-935"></a>isTyVarExposed in TcType. This is encoded in (K3b).
<a name="line-936"></a>
<a name="line-937"></a>Note [Flavours with roles]
<a name="line-938"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-939"></a>The system described in Note [inert_eqs: the inert equalities]
<a name="line-940"></a>discusses an abstract
<a name="line-941"></a>set of flavours. In GHC, flavours have two components: the flavour proper,
<a name="line-942"></a>taken from {Wanted, Derived, Given} and the equality relation (often called
<a name="line-943"></a>role), taken from {NomEq, ReprEq}.
<a name="line-944"></a>When substituting w.r.t. the inert set,
<a name="line-945"></a>as described in Note [inert_eqs: the inert equalities],
<a name="line-946"></a>we must be careful to respect all components of a flavour.
<a name="line-947"></a>For example, if we have
<a name="line-948"></a>
<a name="line-949"></a>  inert set: a -G/R-&gt; Int
<a name="line-950"></a>             b -G/R-&gt; Bool
<a name="line-951"></a>
<a name="line-952"></a>  type role T nominal representational
<a name="line-953"></a>
<a name="line-954"></a>and we wish to compute S(W/R, T a b), the correct answer is T a Bool, NOT
<a name="line-955"></a>T Int Bool. The reason is that T's first parameter has a nominal role, and
<a name="line-956"></a>thus rewriting a to Int in T a b is wrong. Indeed, this non-congruence of
<a name="line-957"></a>substitution means that the proof in Note [The inert equalities] may need
<a name="line-958"></a>to be revisited, but we don't think that the end conclusion is wrong.
<a name="line-959"></a>-}</span>
<a name="line-960"></a>
<a name="line-961"></a><a name="instance%20Outputable%20InertCans"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyword'>where</span>
<a name="line-962"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span>
<a name="line-963"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dicts</span>
<a name="line-964"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>safehask</span><span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>irreds</span>
<a name="line-965"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>inert_insols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insols</span><span class='hs-layout'>,</span> <span class='hs-varid'>inert_count</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-966"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>braces</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span>
<a name="line-967"></a>      <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyDVarEnv</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-968"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"Equalities:"</span>
<a name="line-969"></a>          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldDVarEnv</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>eqs</span> <span class='hs-varid'>rest</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>listToBag</span> <span class='hs-varid'>eqs</span> <span class='hs-varop'>`andCts`</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyCts</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>)</span>
<a name="line-970"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyTcAppMap</span> <span class='hs-varid'>funeqs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-971"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"Type-function equalities ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>funEqsToBag</span> <span class='hs-varid'>funeqs</span><span class='hs-layout'>)</span>
<a name="line-972"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyTcAppMap</span> <span class='hs-varid'>dicts</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-973"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"Dictionaries ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>dictsToBag</span> <span class='hs-varid'>dicts</span><span class='hs-layout'>)</span>
<a name="line-974"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyTcAppMap</span> <span class='hs-varid'>safehask</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-975"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"Safe Haskell unsafe overlap ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>dictsToBag</span> <span class='hs-varid'>safehask</span><span class='hs-layout'>)</span>
<a name="line-976"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyCts</span> <span class='hs-varid'>irreds</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-977"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"Irreds ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCts</span> <span class='hs-varid'>irreds</span>
<a name="line-978"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyCts</span> <span class='hs-varid'>insols</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-979"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"Insolubles ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCts</span> <span class='hs-varid'>insols</span>
<a name="line-980"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Unsolved goals ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>count</span>
<a name="line-981"></a>      <span class='hs-keyglyph'>]</span>
<a name="line-982"></a>
<a name="line-983"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-984"></a>*                                                                      *
<a name="line-985"></a>             Shadow constraints and improvement
<a name="line-986"></a>*                                                                      *
<a name="line-987"></a>************************************************************************
<a name="line-988"></a>
<a name="line-989"></a>Note [The improvement story and derived shadows]
<a name="line-990"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-991"></a>Because Wanteds cannot rewrite Wanteds (see Note [Wanteds do not
<a name="line-992"></a>rewrite Wanteds] in TcRnTypes), we may miss some opportunities for
<a name="line-993"></a>solving.  Here's a classic example (indexed-types/should_fail/T4093a)
<a name="line-994"></a>
<a name="line-995"></a>    Ambiguity check for f: (Foo e ~ Maybe e) =&gt; Foo e
<a name="line-996"></a>
<a name="line-997"></a>    We get [G] Foo e ~ Maybe e
<a name="line-998"></a>           [W] Foo e ~ Foo ee      -- ee is a unification variable
<a name="line-999"></a>           [W] Foo ee ~ Maybe ee
<a name="line-1000"></a>
<a name="line-1001"></a>    Flatten: [G] Foo e ~ fsk
<a name="line-1002"></a>             [G] fsk ~ Maybe e   -- (A)
<a name="line-1003"></a>
<a name="line-1004"></a>             [W] Foo ee ~ fmv
<a name="line-1005"></a>             [W] fmv ~ fsk       -- (B) From Foo e ~ Foo ee
<a name="line-1006"></a>             [W] fmv ~ Maybe ee
<a name="line-1007"></a>
<a name="line-1008"></a>    --&gt; rewrite (B) with (A)
<a name="line-1009"></a>             [W] Foo ee ~ fmv
<a name="line-1010"></a>             [W] fmv ~ Maybe e
<a name="line-1011"></a>             [W] fmv ~ Maybe ee
<a name="line-1012"></a>
<a name="line-1013"></a>    But now we appear to be stuck, since we don't rewrite Wanteds with
<a name="line-1014"></a>    Wanteds.  This is silly because we can see that ee := e is the
<a name="line-1015"></a>    only solution.
<a name="line-1016"></a>
<a name="line-1017"></a>The basic plan is
<a name="line-1018"></a>  * generate Derived constraints that shadow Wanted constraints
<a name="line-1019"></a>  * allow Derived to rewrite Derived
<a name="line-1020"></a>  * in order to cause some unifications to take place
<a name="line-1021"></a>  * that in turn solve the original Wanteds
<a name="line-1022"></a>
<a name="line-1023"></a>The ONLY reason for all these Derived equalities is to tell us how to
<a name="line-1024"></a>unify a variable: that is, what Mark Jones calls "improvement".
<a name="line-1025"></a>
<a name="line-1026"></a>The same idea is sometimes also called "saturation"; find all the
<a name="line-1027"></a>equalities that must hold in any solution.
<a name="line-1028"></a>
<a name="line-1029"></a>Or, equivalently, you can think of the derived shadows as implementing
<a name="line-1030"></a>the "model": an non-idempotent but no-occurs-check substitution,
<a name="line-1031"></a>reflecting *all* *Nominal* equalities (a ~N ty) that are not
<a name="line-1032"></a>immediately soluble by unification.
<a name="line-1033"></a>
<a name="line-1034"></a>More specifically, here's how it works (Oct 16):
<a name="line-1035"></a>
<a name="line-1036"></a>* Wanted constraints are born as [WD]; this behaves like a
<a name="line-1037"></a>  [W] and a [D] paired together.
<a name="line-1038"></a>
<a name="line-1039"></a>* When we are about to add a [WD] to the inert set, if it can
<a name="line-1040"></a>  be rewritten by a [D] a ~ ty, then we split it into [W] and [D],
<a name="line-1041"></a>  putting the latter into the work list (see maybeEmitShadow).
<a name="line-1042"></a>
<a name="line-1043"></a>In the example above, we get to the point where we are stuck:
<a name="line-1044"></a>    [WD] Foo ee ~ fmv
<a name="line-1045"></a>    [WD] fmv ~ Maybe e
<a name="line-1046"></a>    [WD] fmv ~ Maybe ee
<a name="line-1047"></a>
<a name="line-1048"></a>But now when [WD] fmv ~ Maybe ee is about to be added, we'll
<a name="line-1049"></a>split it into [W] and [D], since the inert [WD] fmv ~ Maybe e
<a name="line-1050"></a>can rewrite it.  Then:
<a name="line-1051"></a>    work item: [D] fmv ~ Maybe ee
<a name="line-1052"></a>    inert:     [W] fmv ~ Maybe ee
<a name="line-1053"></a>               [WD] fmv ~ Maybe e   -- (C)
<a name="line-1054"></a>               [WD] Foo ee ~ fmv
<a name="line-1055"></a>
<a name="line-1056"></a>See Note [Splitting WD constraints].  Now the work item is rewritten
<a name="line-1057"></a>by (C) and we soon get ee := e.
<a name="line-1058"></a>
<a name="line-1059"></a>Additional notes:
<a name="line-1060"></a>
<a name="line-1061"></a>  * The derived shadow equalities live in inert_eqs, along with
<a name="line-1062"></a>    the Givens and Wanteds; see Note [EqualCtList invariants].
<a name="line-1063"></a>
<a name="line-1064"></a>  * We make Derived shadows only for Wanteds, not Givens.  So we
<a name="line-1065"></a>    have only [G], not [GD] and [G] plus splitting.  See
<a name="line-1066"></a>    Note [Add derived shadows only for Wanteds]
<a name="line-1067"></a>
<a name="line-1068"></a>  * We also get Derived equalities from functional dependencies
<a name="line-1069"></a>    and type-function injectivity; see calls to unifyDerived.
<a name="line-1070"></a>
<a name="line-1071"></a>  * This splitting business applies to CFunEqCans too; and then
<a name="line-1072"></a>    we do apply type-function reductions to the [D] CFunEqCan.
<a name="line-1073"></a>    See Note [Reduction for Derived CFunEqCans]
<a name="line-1074"></a>
<a name="line-1075"></a>  * It's worth having [WD] rather than just [W] and [D] because
<a name="line-1076"></a>    * efficiency: silly to process the same thing twice
<a name="line-1077"></a>    * inert_funeqs, inert_dicts is a finite map keyed by
<a name="line-1078"></a>      the type; it's inconvenient for it to map to TWO constraints
<a name="line-1079"></a>
<a name="line-1080"></a>Note [Splitting WD constraints]
<a name="line-1081"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1082"></a>We are about to add a [WD] constraint to the inert set; and we
<a name="line-1083"></a>know that the inert set has fully rewritten it.  Should we split
<a name="line-1084"></a>it into [W] and [D], and put the [D] in the work list for further
<a name="line-1085"></a>work?
<a name="line-1086"></a>
<a name="line-1087"></a>* CDictCan (C tys) or CFunEqCan (F tys ~ fsk):
<a name="line-1088"></a>  Yes if the inert set could rewrite tys to make the class constraint,
<a name="line-1089"></a>  or type family, fire.  That is, yes if the inert_eqs intersects
<a name="line-1090"></a>  with the free vars of tys.  For this test we use
<a name="line-1091"></a>  (anyRewritableTyVar True) which ignores casts and coercions in tys,
<a name="line-1092"></a>  because rewriting the casts or coercions won't make the thing fire
<a name="line-1093"></a>  more often.
<a name="line-1094"></a>
<a name="line-1095"></a>* CTyEqCan (a ~ ty): Yes if the inert set could rewrite 'a' or 'ty'.
<a name="line-1096"></a>  We need to check both 'a' and 'ty' against the inert set:
<a name="line-1097"></a>    - Inert set contains  [D] a ~ ty2
<a name="line-1098"></a>      Then we want to put [D] a ~ ty in the worklist, so we'll
<a name="line-1099"></a>      get [D] ty ~ ty2 with consequent good things
<a name="line-1100"></a>
<a name="line-1101"></a>    - Inert set contains [D] b ~ a, where b is in ty.
<a name="line-1102"></a>      We can't just add [WD] a ~ ty[b] to the inert set, because
<a name="line-1103"></a>      that breaks the inert-set invariants.  If we tried to
<a name="line-1104"></a>      canonicalise another [D] constraint mentioning 'a', we'd
<a name="line-1105"></a>      get an infinite loop
<a name="line-1106"></a>
<a name="line-1107"></a>  Moreover we must use (anyRewritableTyVar False) for the RHS,
<a name="line-1108"></a>  because even tyvars in the casts and coercions could give
<a name="line-1109"></a>  an infinite loop if we don't expose it
<a name="line-1110"></a>
<a name="line-1111"></a>* Others: nothing is gained by splitting.
<a name="line-1112"></a>
<a name="line-1113"></a>Note [Examples of how Derived shadows helps completeness]
<a name="line-1114"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1115"></a>Trac #10009, a very nasty example:
<a name="line-1116"></a>
<a name="line-1117"></a>    f :: (UnF (F b) ~ b) =&gt; F b -&gt; ()
<a name="line-1118"></a>
<a name="line-1119"></a>    g :: forall a. (UnF (F a) ~ a) =&gt; a -&gt; ()
<a name="line-1120"></a>    g _ = f (undefined :: F a)
<a name="line-1121"></a>
<a name="line-1122"></a>  For g we get [G] UnF (F a) ~ a
<a name="line-1123"></a>               [WD] UnF (F beta) ~ beta
<a name="line-1124"></a>               [WD] F a ~ F beta
<a name="line-1125"></a>  Flatten:
<a name="line-1126"></a>      [G] g1: F a ~ fsk1         fsk1 := F a
<a name="line-1127"></a>      [G] g2: UnF fsk1 ~ fsk2    fsk2 := UnF fsk1
<a name="line-1128"></a>      [G] g3: fsk2 ~ a
<a name="line-1129"></a>
<a name="line-1130"></a>      [WD] w1: F beta ~ fmv1
<a name="line-1131"></a>      [WD] w2: UnF fmv1 ~ fmv2
<a name="line-1132"></a>      [WD] w3: fmv2 ~ beta
<a name="line-1133"></a>      [WD] w4: fmv1 ~ fsk1   -- From F a ~ F beta using flat-cache
<a name="line-1134"></a>                             -- and re-orient to put meta-var on left
<a name="line-1135"></a>
<a name="line-1136"></a>Rewrite w2 with w4: [D] d1: UnF fsk1 ~ fmv2
<a name="line-1137"></a>React that with g2: [D] d2: fmv2 ~ fsk2
<a name="line-1138"></a>React that with w3: [D] beta ~ fsk2
<a name="line-1139"></a>            and g3: [D] beta ~ a -- Hooray beta := a
<a name="line-1140"></a>And that is enough to solve everything
<a name="line-1141"></a>
<a name="line-1142"></a>Note [Add derived shadows only for Wanteds]
<a name="line-1143"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1144"></a>We only add shadows for Wanted constraints. That is, we have
<a name="line-1145"></a>[WD] but not [GD]; and maybeEmitShaodw looks only at [WD]
<a name="line-1146"></a>constraints.
<a name="line-1147"></a>
<a name="line-1148"></a>It does just possibly make sense ot add a derived shadow for a
<a name="line-1149"></a>Given. If we created a Derived shadow of a Given, it could be
<a name="line-1150"></a>rewritten by other Deriveds, and that could, conceivably, lead to a
<a name="line-1151"></a>useful unification.
<a name="line-1152"></a>
<a name="line-1153"></a>But (a) I have been unable to come up with an example of this
<a name="line-1154"></a>        happening
<a name="line-1155"></a>    (b) see Trac #12660 for how adding the derived shadows
<a name="line-1156"></a>        of a Given led to an infinite loop.
<a name="line-1157"></a>    (c) It's unlikely that rewriting derived Givens will lead
<a name="line-1158"></a>        to a unification because Givens don't mention touchable
<a name="line-1159"></a>        unification variables
<a name="line-1160"></a>
<a name="line-1161"></a>For (b) there may be other ways to solve the loop, but simply
<a name="line-1162"></a>reraining from adding derived shadows of Givens is particularly
<a name="line-1163"></a>simple.  And it's more efficient too!
<a name="line-1164"></a>
<a name="line-1165"></a>Still, here's one possible reason for adding derived shadows
<a name="line-1166"></a>for Givens.  Consider
<a name="line-1167"></a>           work-item [G] a ~ [b], inerts has [D] b ~ a.
<a name="line-1168"></a>If we added the derived shadow (into the work list)
<a name="line-1169"></a>         [D] a ~ [b]
<a name="line-1170"></a>When we process it, we'll rewrite to a ~ [a] and get an
<a name="line-1171"></a>occurs check.  Without it we'll miss the occurs check (reporting
<a name="line-1172"></a>inaccessible code); but that's probably OK.
<a name="line-1173"></a>
<a name="line-1174"></a>Note [Keep CDictCan shadows as CDictCan]
<a name="line-1175"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1176"></a>Suppose we have
<a name="line-1177"></a>  class C a =&gt; D a b
<a name="line-1178"></a>and [G] D a b, [G] C a in the inert set.  Now we insert
<a name="line-1179"></a>[D] b ~ c.  We want to kick out a derived shadow for [D] D a b,
<a name="line-1180"></a>so we can rewrite it with the new constraint, and perhaps get
<a name="line-1181"></a>instance reduction or other consequences.
<a name="line-1182"></a>
<a name="line-1183"></a>BUT we do not want to kick out a *non-canonical* (D a b). If we
<a name="line-1184"></a>did, we would do this:
<a name="line-1185"></a>  - rewrite it to [D] D a c, with pend_sc = True
<a name="line-1186"></a>  - use expandSuperClasses to add C a
<a name="line-1187"></a>  - go round again, which solves C a from the givens
<a name="line-1188"></a>This loop goes on for ever and triggers the simpl_loop limit.
<a name="line-1189"></a>
<a name="line-1190"></a>Solution: kick out the CDictCan which will have pend_sc = False,
<a name="line-1191"></a>because we've already added its superclasses.  So we won't re-add
<a name="line-1192"></a>them.  If we forget the pend_sc flag, our cunning scheme for avoiding
<a name="line-1193"></a>generating superclasses repeatedly will fail.
<a name="line-1194"></a>
<a name="line-1195"></a>See Trac #11379 for a case of this.
<a name="line-1196"></a>
<a name="line-1197"></a>Note [Do not do improvement for WOnly]
<a name="line-1198"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1199"></a>We do improvement between two constraints (e.g. for injectivity
<a name="line-1200"></a>or functional dependencies) only if both are "improvable". And
<a name="line-1201"></a>we improve a constraint wrt the top-level instances only if
<a name="line-1202"></a>it is improvable.
<a name="line-1203"></a>
<a name="line-1204"></a>Improvable:     [G] [WD] [D}
<a name="line-1205"></a>Not improvable: [W]
<a name="line-1206"></a>
<a name="line-1207"></a>Reasons:
<a name="line-1208"></a>
<a name="line-1209"></a>* It's less work: fewer pairs to compare
<a name="line-1210"></a>
<a name="line-1211"></a>* Every [W] has a shadow [D] so nothing is lost
<a name="line-1212"></a>
<a name="line-1213"></a>* Consider [WD] C Int b,  where 'b' is a skolem, and
<a name="line-1214"></a>    class C a b | a -&gt; b
<a name="line-1215"></a>    instance C Int Bool
<a name="line-1216"></a>  We'll do a fundep on it and emit [D] b ~ Bool
<a name="line-1217"></a>  That will kick out constraint [WD] C Int b
<a name="line-1218"></a>  Then we'll split it to [W] C Int b (keep in inert)
<a name="line-1219"></a>                     and [D] C Int b (in work list)
<a name="line-1220"></a>  When processing the latter we'll rewrite it to
<a name="line-1221"></a>        [D] C Int Bool
<a name="line-1222"></a>  At that point it would be /stupid/ to interact it
<a name="line-1223"></a>  with the inert [W] C Int b in the inert set; after all,
<a name="line-1224"></a>  it's the very constraint from which the [D] C Int Bool
<a name="line-1225"></a>  was split!  We can avoid this by not doing improvement
<a name="line-1226"></a>  on [W] constraints. This came up in Trac #12860.
<a name="line-1227"></a>-}</span>
<a name="line-1228"></a>
<a name="line-1229"></a><a name="maybeEmitShadow"></a><span class='hs-definition'>maybeEmitShadow</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Ct</span>
<a name="line-1230"></a><span class='hs-comment'>-- See Note [The improvement story and derived shadows]</span>
<a name="line-1231"></a><span class='hs-definition'>maybeEmitShadow</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>ct</span>
<a name="line-1232"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>ct</span>
<a name="line-1233"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span>
<a name="line-1234"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_nosh</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WDeriv</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ev</span>
<a name="line-1235"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>shouldSplitWD</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-varid'>ct</span>
<a name="line-1236"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emit derived shadow"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-1237"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>derived_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span>
<a name="line-1238"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span>
<a name="line-1239"></a>             <span class='hs-varid'>shadow_ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>derived_ev</span> <span class='hs-layout'>}</span>
<a name="line-1240"></a>               <span class='hs-comment'>-- Te shadow constraint keeps the canonical shape.</span>
<a name="line-1241"></a>               <span class='hs-comment'>-- This just saves work, but is sometimes important;</span>
<a name="line-1242"></a>               <span class='hs-comment'>-- see Note [Keep CDictCan shadows as CDictCan]</span>
<a name="line-1243"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>emitWork</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>shadow_ct</span><span class='hs-keyglyph'>]</span>
<a name="line-1244"></a>
<a name="line-1245"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ev'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_nosh</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WOnly</span> <span class='hs-layout'>}</span>
<a name="line-1246"></a>             <span class='hs-varid'>ct'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev'</span> <span class='hs-layout'>}</span>
<a name="line-1247"></a>                 <span class='hs-comment'>-- Record that it now has a shadow</span>
<a name="line-1248"></a>                 <span class='hs-comment'>-- This is /the/ place we set the flag to WOnly</span>
<a name="line-1249"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ct'</span> <span class='hs-layout'>}</span>
<a name="line-1250"></a>
<a name="line-1251"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1252"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ct</span>
<a name="line-1253"></a>
<a name="line-1254"></a><a name="shouldSplitWD"></a><span class='hs-definition'>shouldSplitWD</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertEqs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1255"></a><span class='hs-comment'>-- Precondition: 'ct' is [WD], and is inert</span>
<a name="line-1256"></a><span class='hs-comment'>-- True &lt;=&gt; we should split ct ito [W] and [D] because</span>
<a name="line-1257"></a><span class='hs-comment'>--          the inert_eqs can make progress on the [D]</span>
<a name="line-1258"></a><span class='hs-comment'>-- See Note [Splitting WD constraints]</span>
<a name="line-1259"></a>
<a name="line-1260"></a><span class='hs-definition'>shouldSplitWD</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1261"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>should_split_match_args</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>tys</span>
<a name="line-1262"></a>    <span class='hs-comment'>-- We don't need to split if the tv is the RHS fsk</span>
<a name="line-1263"></a>
<a name="line-1264"></a><span class='hs-definition'>shouldSplitWD</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1265"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>should_split_match_args</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>tys</span>
<a name="line-1266"></a>    <span class='hs-comment'>-- NB True: ignore coercions</span>
<a name="line-1267"></a>    <span class='hs-comment'>-- See Note [Splitting WD constraints]</span>
<a name="line-1268"></a>
<a name="line-1269"></a><span class='hs-definition'>shouldSplitWD</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-layout'>(</span><span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1270"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>tv</span> <span class='hs-varop'>`elemDVarEnv`</span> <span class='hs-varid'>inert_eqs</span>
<a name="line-1271"></a>  <span class='hs-varop'>||</span> <span class='hs-varid'>anyRewritableTyVar</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemDVarEnv`</span> <span class='hs-varid'>inert_eqs</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1272"></a>  <span class='hs-comment'>-- NB False: do not ignore casts and coercions</span>
<a name="line-1273"></a>  <span class='hs-comment'>-- See Note [Splitting WD constraints]</span>
<a name="line-1274"></a>
<a name="line-1275"></a><span class='hs-definition'>shouldSplitWD</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>   <span class='hs-comment'>-- No point in splitting otherwise</span>
<a name="line-1276"></a>
<a name="line-1277"></a><a name="should_split_match_args"></a><span class='hs-definition'>should_split_match_args</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertEqs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1278"></a><span class='hs-comment'>-- True if the inert_eqs can rewrite anything in the argument</span>
<a name="line-1279"></a><span class='hs-comment'>-- types, ignoring casts and coercions</span>
<a name="line-1280"></a><span class='hs-definition'>should_split_match_args</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>tys</span>
<a name="line-1281"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>anyRewritableTyVar</span> <span class='hs-conid'>True</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemDVarEnv`</span> <span class='hs-varid'>inert_eqs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-1282"></a>    <span class='hs-comment'>-- NB True: ignore casts coercions</span>
<a name="line-1283"></a>    <span class='hs-comment'>-- See Note [Splitting WD constraints]</span>
<a name="line-1284"></a>
<a name="line-1285"></a><a name="isImprovable"></a><span class='hs-definition'>isImprovable</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1286"></a><span class='hs-comment'>-- See Note [Do not do improvement for WOnly]</span>
<a name="line-1287"></a><span class='hs-definition'>isImprovable</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_nosh</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WOnly</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1288"></a><span class='hs-definition'>isImprovable</span> <span class='hs-keyword'>_</span>                                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1289"></a>
<a name="line-1290"></a>
<a name="line-1291"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1292"></a>*                                                                      *
<a name="line-1293"></a>                   Inert equalities
<a name="line-1294"></a>*                                                                      *
<a name="line-1295"></a>********************************************************************* -}</span>
<a name="line-1296"></a>
<a name="line-1297"></a><a name="addTyEq"></a><span class='hs-definition'>addTyEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertEqs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertEqs</span>
<a name="line-1298"></a><span class='hs-definition'>addTyEq</span> <span class='hs-varid'>old_eqs</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ct</span>
<a name="line-1299"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendDVarEnv_C</span> <span class='hs-varid'>add_eq</span> <span class='hs-varid'>old_eqs</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ct</span><span class='hs-keyglyph'>]</span>
<a name="line-1300"></a>  <span class='hs-keyword'>where</span>
<a name="line-1301"></a>    <span class='hs-varid'>add_eq</span> <span class='hs-varid'>old_eqs</span> <span class='hs-keyword'>_</span>
<a name="line-1302"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isWantedCt</span> <span class='hs-varid'>ct</span>
<a name="line-1303"></a>      <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>eq1</span> <span class='hs-conop'>:</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>old_eqs</span>
<a name="line-1304"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq1</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>eqs</span>
<a name="line-1305"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1306"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>old_eqs</span>
<a name="line-1307"></a>
<a name="line-1308"></a><a name="foldTyEqs"></a><span class='hs-definition'>foldTyEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertEqs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-1309"></a><span class='hs-definition'>foldTyEqs</span> <span class='hs-varid'>k</span> <span class='hs-varid'>eqs</span> <span class='hs-varid'>z</span>
<a name="line-1310"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldDVarEnv</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>cts</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>k</span> <span class='hs-varid'>z</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span> <span class='hs-varid'>z</span> <span class='hs-varid'>eqs</span>
<a name="line-1311"></a>
<a name="line-1312"></a><a name="findTyEqs"></a><span class='hs-definition'>findTyEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqualCtList</span>
<a name="line-1313"></a><span class='hs-definition'>findTyEqs</span> <span class='hs-varid'>icans</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupDVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>icans</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`orElse`</span> <span class='hs-conid'>[]</span>
<a name="line-1314"></a>
<a name="line-1315"></a><a name="delTyEq"></a><span class='hs-definition'>delTyEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertEqs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertEqs</span>
<a name="line-1316"></a><span class='hs-definition'>delTyEq</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyDVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isThisOne</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tv</span>
<a name="line-1317"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>isThisOne</span> <span class='hs-layout'>(</span><span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqType</span> <span class='hs-varid'>t</span> <span class='hs-varid'>t1</span>
<a name="line-1318"></a>        <span class='hs-varid'>isThisOne</span> <span class='hs-keyword'>_</span>                          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1319"></a>
<a name="line-1320"></a><a name="lookupInertTyVar"></a><span class='hs-definition'>lookupInertTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertEqs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcType</span>
<a name="line-1321"></a><span class='hs-definition'>lookupInertTyVar</span> <span class='hs-varid'>ieqs</span> <span class='hs-varid'>tv</span>
<a name="line-1322"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupDVarEnv</span> <span class='hs-varid'>ieqs</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-1323"></a>      <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_eq_rel</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NomEq</span> <span class='hs-layout'>}</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>rhs</span>
<a name="line-1324"></a>      <span class='hs-keyword'>_</span>                                                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1325"></a>
<a name="line-1326"></a><a name="lookupFlattenTyVar"></a><span class='hs-definition'>lookupFlattenTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertEqs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>
<a name="line-1327"></a><span class='hs-comment'>-- See Note [lookupFlattenTyVar]</span>
<a name="line-1328"></a><span class='hs-definition'>lookupFlattenTyVar</span> <span class='hs-varid'>ieqs</span> <span class='hs-varid'>ftv</span>
<a name="line-1329"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupInertTyVar</span> <span class='hs-varid'>ieqs</span> <span class='hs-varid'>ftv</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>ftv</span>
<a name="line-1330"></a>
<a name="line-1331"></a><span class='hs-comment'>{- Note [lookupFlattenTyVar]
<a name="line-1332"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1333"></a>Suppose we have an injective function F and
<a name="line-1334"></a>  inert_funeqs:   F t1 ~ fsk1
<a name="line-1335"></a>                  F t2 ~ fsk2
<a name="line-1336"></a>  inert_eqs:      fsk1 ~ fsk2
<a name="line-1337"></a>
<a name="line-1338"></a>We never rewrite the RHS (cc_fsk) of a CFunEqCan.  But we /do/ want to
<a name="line-1339"></a>get the [D] t1 ~ t2 from the injectiveness of F.  So we look up the
<a name="line-1340"></a>cc_fsk of CFunEqCans in the inert_eqs when trying to find derived
<a name="line-1341"></a>equalities arising from injectivity.
<a name="line-1342"></a>-}</span>
<a name="line-1343"></a>
<a name="line-1344"></a>
<a name="line-1345"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1346"></a>*                                                                      *
<a name="line-1347"></a>                  Adding an inert
<a name="line-1348"></a>*                                                                      *
<a name="line-1349"></a>************************************************************************
<a name="line-1350"></a>
<a name="line-1351"></a>Note [Adding an equality to the InertCans]
<a name="line-1352"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1353"></a>When adding an equality to the inerts:
<a name="line-1354"></a>
<a name="line-1355"></a>* Split [WD] into [W] and [D] if the inerts can rewrite the latter;
<a name="line-1356"></a>  done by maybeEmitShadow.
<a name="line-1357"></a>
<a name="line-1358"></a>* Kick out any constraints that can be rewritten by the thing
<a name="line-1359"></a>  we are adding.  Done by kickOutRewritable.
<a name="line-1360"></a>
<a name="line-1361"></a>* Note that unifying a:=ty, is like adding [G] a~ty; just use
<a name="line-1362"></a>  kickOutRewritable with Nominal, Given.  See kickOutAfterUnification.
<a name="line-1363"></a>
<a name="line-1364"></a>Note [Kicking out CFunEqCan for fundeps]
<a name="line-1365"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1366"></a>Consider:
<a name="line-1367"></a>   New:    [D] fmv1 ~ fmv2
<a name="line-1368"></a>   Inert:  [W] F alpha ~ fmv1
<a name="line-1369"></a>           [W] F beta  ~ fmv2
<a name="line-1370"></a>
<a name="line-1371"></a>where F is injective. The new (derived) equality certainly can't
<a name="line-1372"></a>rewrite the inerts. But we *must* kick out the first one, to get:
<a name="line-1373"></a>
<a name="line-1374"></a>   New:   [W] F alpha ~ fmv1
<a name="line-1375"></a>   Inert: [W] F beta ~ fmv2
<a name="line-1376"></a>          [D] fmv1 ~ fmv2
<a name="line-1377"></a>
<a name="line-1378"></a>and now improvement will discover [D] alpha ~ beta. This is important;
<a name="line-1379"></a>eg in Trac #9587.
<a name="line-1380"></a>
<a name="line-1381"></a>So in kickOutRewritable we look at all the tyvars of the
<a name="line-1382"></a>CFunEqCan, including the fsk.
<a name="line-1383"></a>-}</span>
<a name="line-1384"></a>
<a name="line-1385"></a><a name="addInertEq"></a><span class='hs-definition'>addInertEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1386"></a><span class='hs-comment'>-- This is a key function, because of the kick-out stuff</span>
<a name="line-1387"></a><span class='hs-comment'>-- Precondition: item /is/ canonical</span>
<a name="line-1388"></a><span class='hs-comment'>-- See Note [Adding an equality to the InertCans]</span>
<a name="line-1389"></a><span class='hs-definition'>addInertEq</span> <span class='hs-varid'>ct</span>
<a name="line-1390"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"addInertEq {"</span> <span class='hs-varop'>$</span>
<a name="line-1391"></a>         <span class='hs-varid'>text</span> <span class='hs-str'>"Adding new inert equality:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span>
<a name="line-1392"></a>
<a name="line-1393"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-1394"></a>
<a name="line-1395"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ct</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybeEmitShadow</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>ct</span>
<a name="line-1396"></a>
<a name="line-1397"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ics1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kickOutRewritable</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvFlavourRole</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ics</span>
<a name="line-1398"></a>
<a name="line-1399"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ics2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics1</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTyEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>ics1</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ct</span>
<a name="line-1400"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>inert_count</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bumpUnsolvedCount</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_count</span> <span class='hs-varid'>ics1</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1401"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setInertCans</span> <span class='hs-varid'>ics2</span>
<a name="line-1402"></a>
<a name="line-1403"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"addInertEq }"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>}</span>
<a name="line-1404"></a>
<a name="line-1405"></a><a name="addInertCan"></a><span class='hs-comment'>--------------</span>
<a name="line-1406"></a><span class='hs-definition'>addInertCan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>  <span class='hs-comment'>-- Constraints *other than* equalities</span>
<a name="line-1407"></a><span class='hs-definition'>addInertCan</span> <span class='hs-varid'>ct</span>
<a name="line-1408"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"insertInertCan {"</span> <span class='hs-varop'>$</span>
<a name="line-1409"></a>         <span class='hs-varid'>text</span> <span class='hs-str'>"Trying to insert new non-eq inert item:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span>
<a name="line-1410"></a>
<a name="line-1411"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-1412"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybeEmitShadow</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>ct</span>
<a name="line-1413"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setInertCans</span> <span class='hs-layout'>(</span><span class='hs-varid'>add_item</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-1414"></a>
<a name="line-1415"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"addInertCan }"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>}</span>
<a name="line-1416"></a>
<a name="line-1417"></a><a name="add_item"></a><span class='hs-definition'>add_item</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span>
<a name="line-1418"></a><span class='hs-definition'>add_item</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_fun</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1419"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertFunEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>item</span> <span class='hs-layout'>}</span>
<a name="line-1420"></a>
<a name="line-1421"></a><span class='hs-definition'>add_item</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CIrredEvCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1422"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>ics</span> <span class='hs-varop'>`</span><span class='hs-conid'>Bag</span><span class='hs-varop'>.</span><span class='hs-varid'>snocBag</span><span class='hs-varop'>`</span> <span class='hs-varid'>item</span>
<a name="line-1423"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>inert_count</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bumpUnsolvedCount</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_count</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1424"></a>       <span class='hs-comment'>-- The 'False' is because the irreducible constraint might later instantiate</span>
<a name="line-1425"></a>       <span class='hs-comment'>-- to an equality.</span>
<a name="line-1426"></a>       <span class='hs-comment'>-- But since we try to simplify first, if there's a constraint function FC with</span>
<a name="line-1427"></a>       <span class='hs-comment'>--    type instance FC Int = Show</span>
<a name="line-1428"></a>       <span class='hs-comment'>-- we'll reduce a constraint (FC Int a) to Show a, and never add an inert irreducible</span>
<a name="line-1429"></a>
<a name="line-1430"></a><span class='hs-definition'>add_item</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1431"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addDict</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>item</span>
<a name="line-1432"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>inert_count</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bumpUnsolvedCount</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_count</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1433"></a>
<a name="line-1434"></a><span class='hs-definition'>add_item</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>item</span>
<a name="line-1435"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"upd_inert set: can't happen! Inserting "</span> <span class='hs-varop'>$</span>
<a name="line-1436"></a>    <span class='hs-varid'>ppr</span> <span class='hs-varid'>item</span>   <span class='hs-comment'>-- CTyEqCan is dealt with by addInertEq</span>
<a name="line-1437"></a>               <span class='hs-comment'>-- Can't be CNonCanonical, CHoleCan,</span>
<a name="line-1438"></a>               <span class='hs-comment'>-- because they only land in inert_insols</span>
<a name="line-1439"></a>
<a name="line-1440"></a><a name="bumpUnsolvedCount"></a><span class='hs-definition'>bumpUnsolvedCount</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-1441"></a><span class='hs-definition'>bumpUnsolvedCount</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isWanted</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span>
<a name="line-1442"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>
<a name="line-1443"></a>
<a name="line-1444"></a>
<a name="line-1445"></a><a name="kickOutRewritable"></a><span class='hs-comment'>-----------------------------------------</span>
<a name="line-1446"></a><span class='hs-definition'>kickOutRewritable</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavourRole</span>  <span class='hs-comment'>-- Flavour/role of the equality that</span>
<a name="line-1447"></a>                                      <span class='hs-comment'>-- is being added to the inert set</span>
<a name="line-1448"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span>        <span class='hs-comment'>-- The new equality is tv ~ ty</span>
<a name="line-1449"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span>
<a name="line-1450"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>InertCans</span><span class='hs-layout'>)</span>
<a name="line-1451"></a><span class='hs-definition'>kickOutRewritable</span> <span class='hs-varid'>new_fr</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>ics</span>
<a name="line-1452"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>kicked_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>ics'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kick_out_rewritable</span> <span class='hs-varid'>new_fr</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>ics</span>
<a name="line-1453"></a>             <span class='hs-varid'>n_kicked</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>workListSize</span> <span class='hs-varid'>kicked_out</span>
<a name="line-1454"></a>
<a name="line-1455"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_kicked</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1456"></a>         <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>appendWorkList</span> <span class='hs-varid'>kicked_out</span><span class='hs-layout'>)</span>
<a name="line-1457"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>csTraceTcS</span> <span class='hs-varop'>$</span>
<a name="line-1458"></a>              <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Kick out, tv ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>new_tv</span><span class='hs-layout'>)</span>
<a name="line-1459"></a>                 <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"n-kicked ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n_kicked</span>
<a name="line-1460"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"kicked_out ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kicked_out</span>
<a name="line-1461"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Residual inerts ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ics'</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1462"></a>
<a name="line-1463"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_kicked</span><span class='hs-layout'>,</span> <span class='hs-varid'>ics'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1464"></a>
<a name="line-1465"></a><a name="kick_out_rewritable"></a><span class='hs-definition'>kick_out_rewritable</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavourRole</span>  <span class='hs-comment'>-- Flavour/role of the equality that</span>
<a name="line-1466"></a>                                      <span class='hs-comment'>-- is being added to the inert set</span>
<a name="line-1467"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span>        <span class='hs-comment'>-- The new equality is tv ~ ty</span>
<a name="line-1468"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span>
<a name="line-1469"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>WorkList</span><span class='hs-layout'>,</span> <span class='hs-conid'>InertCans</span><span class='hs-layout'>)</span>
<a name="line-1470"></a><span class='hs-comment'>-- See Note [kickOutRewritable]</span>
<a name="line-1471"></a><span class='hs-definition'>kick_out_rewritable</span> <span class='hs-varid'>new_fr</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>ics</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_eqs</span>
<a name="line-1472"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dictmap</span>
<a name="line-1473"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>safehask</span>
<a name="line-1474"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqmap</span>
<a name="line-1475"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>irreds</span>
<a name="line-1476"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>inert_insols</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insols</span>
<a name="line-1477"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>inert_count</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1478"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_fr</span> <span class='hs-varop'>`eqMayRewriteFR`</span> <span class='hs-varid'>new_fr</span><span class='hs-layout'>)</span>
<a name="line-1479"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyWorkList</span><span class='hs-layout'>,</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span>
<a name="line-1480"></a>        <span class='hs-comment'>-- If new_fr can't rewrite itself, it can't rewrite</span>
<a name="line-1481"></a>        <span class='hs-comment'>-- anything else, so no need to kick out anything.</span>
<a name="line-1482"></a>        <span class='hs-comment'>-- (This is a common case: wanteds can't rewrite wanteds)</span>
<a name="line-1483"></a>        <span class='hs-comment'>-- Lemma (L2) in Note [Extending the inert equalities]</span>
<a name="line-1484"></a>
<a name="line-1485"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1486"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>kicked_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>inert_cans_in</span><span class='hs-layout'>)</span>
<a name="line-1487"></a>  <span class='hs-keyword'>where</span>
<a name="line-1488"></a>    <span class='hs-varid'>inert_cans_in</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_eqs_in</span>
<a name="line-1489"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dicts_in</span>
<a name="line-1490"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>safehask</span>   <span class='hs-comment'>-- ??</span>
<a name="line-1491"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>feqs_in</span>
<a name="line-1492"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>irs_in</span>
<a name="line-1493"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_insols</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insols_in</span>
<a name="line-1494"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_count</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-comment'>-</span> <span class='hs-varid'>workListWantedCount</span> <span class='hs-varid'>kicked_out</span> <span class='hs-layout'>}</span>
<a name="line-1495"></a>
<a name="line-1496"></a>    <span class='hs-varid'>kicked_out</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_eqs_out</span>
<a name="line-1497"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>feqs_out</span>
<a name="line-1498"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>wl_deriv</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-1499"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bagToList</span> <span class='hs-layout'>(</span><span class='hs-varid'>dicts_out</span> <span class='hs-varop'>`andCts`</span> <span class='hs-varid'>irs_out</span>
<a name="line-1500"></a>                                             <span class='hs-varop'>`andCts`</span> <span class='hs-varid'>insols_out</span><span class='hs-layout'>)</span>
<a name="line-1501"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>}</span>
<a name="line-1502"></a>
<a name="line-1503"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tv_eqs_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv_eqs_in</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldDVarEnv</span> <span class='hs-varid'>kick_out_eqs</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyDVarEnv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv_eqs</span>
<a name="line-1504"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>feqs_out</span><span class='hs-layout'>,</span>   <span class='hs-varid'>feqs_in</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionFunEqs</span>  <span class='hs-varid'>kick_out_ct</span> <span class='hs-varid'>funeqmap</span>
<a name="line-1505"></a>           <span class='hs-comment'>-- See Note [Kicking out CFunEqCan for fundeps]</span>
<a name="line-1506"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>dicts_out</span><span class='hs-layout'>,</span>  <span class='hs-varid'>dicts_in</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionDicts</span>   <span class='hs-varid'>kick_out_ct</span> <span class='hs-varid'>dictmap</span>
<a name="line-1507"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>irs_out</span><span class='hs-layout'>,</span>    <span class='hs-varid'>irs_in</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionBag</span>     <span class='hs-varid'>kick_out_ct</span> <span class='hs-varid'>irreds</span>
<a name="line-1508"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>insols_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>insols_in</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionBag</span>     <span class='hs-varid'>kick_out_ct</span> <span class='hs-varid'>insols</span>
<a name="line-1509"></a>      <span class='hs-comment'>-- Kick out even insolubles: See Note [Rewrite insolubles]</span>
<a name="line-1510"></a>
<a name="line-1511"></a>    <span class='hs-varid'>fr_may_rewrite</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavourRole</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1512"></a>    <span class='hs-varid'>fr_may_rewrite</span> <span class='hs-varid'>fs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_fr</span> <span class='hs-varop'>`eqMayRewriteFR`</span> <span class='hs-varid'>fs</span>
<a name="line-1513"></a>        <span class='hs-comment'>-- Can the new item rewrite the inert item?</span>
<a name="line-1514"></a>
<a name="line-1515"></a>    <span class='hs-varid'>kick_out_ct</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1516"></a>    <span class='hs-comment'>-- Kick it out if the new CTyEqCan can rewrite the inert one</span>
<a name="line-1517"></a>    <span class='hs-comment'>-- See Note [kickOutRewritable]</span>
<a name="line-1518"></a>    <span class='hs-varid'>kick_out_ct</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>ct</span>
<a name="line-1519"></a>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fr_may_rewrite</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvFlavourRole</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-1520"></a>                   <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>anyRewritableTyVar</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varop'>==</span> <span class='hs-varid'>new_tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-1521"></a>                  <span class='hs-comment'>-- False: ignore casts and coercions</span>
<a name="line-1522"></a>                  <span class='hs-comment'>-- NB: this includes the fsk of a CFunEqCan.  It can't</span>
<a name="line-1523"></a>                  <span class='hs-comment'>--     actually be rewritten, but we need to kick it out</span>
<a name="line-1524"></a>                  <span class='hs-comment'>--     so we get to take advantage of injectivity</span>
<a name="line-1525"></a>                  <span class='hs-comment'>-- See Note [Kicking out CFunEqCan for fundeps]</span>
<a name="line-1526"></a>
<a name="line-1527"></a>    <span class='hs-varid'>kick_out_eqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>DTyVarEnv</span> <span class='hs-conid'>EqualCtList</span><span class='hs-layout'>)</span>
<a name="line-1528"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>DTyVarEnv</span> <span class='hs-conid'>EqualCtList</span><span class='hs-layout'>)</span>
<a name="line-1529"></a>    <span class='hs-varid'>kick_out_eqs</span> <span class='hs-varid'>eqs</span> <span class='hs-layout'>(</span><span class='hs-varid'>acc_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc_in</span><span class='hs-layout'>)</span>
<a name="line-1530"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqs_out</span> <span class='hs-varop'>++</span> <span class='hs-varid'>acc_out</span><span class='hs-layout'>,</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>eqs_in</span> <span class='hs-keyword'>of</span>
<a name="line-1531"></a>                               <span class='hs-conid'>[]</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>acc_in</span>
<a name="line-1532"></a>                               <span class='hs-layout'>(</span><span class='hs-varid'>eq1</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendDVarEnv</span> <span class='hs-varid'>acc_in</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_tyvar</span> <span class='hs-varid'>eq1</span><span class='hs-layout'>)</span> <span class='hs-varid'>eqs_in</span><span class='hs-layout'>)</span>
<a name="line-1533"></a>      <span class='hs-keyword'>where</span>
<a name="line-1534"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>eqs_in</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqs_out</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>keep_eq</span> <span class='hs-varid'>eqs</span>
<a name="line-1535"></a>
<a name="line-1536"></a>    <span class='hs-comment'>-- Implements criteria K1-K3 in Note [Extending the inert equalities]</span>
<a name="line-1537"></a>    <span class='hs-varid'>keep_eq</span> <span class='hs-layout'>(</span><span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span>
<a name="line-1538"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>cc_eq_rel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq_rel</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1539"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>==</span> <span class='hs-varid'>new_tv</span>
<a name="line-1540"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>fr_may_rewrite</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- (K1)</span>
<a name="line-1541"></a>
<a name="line-1542"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1543"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>check_k2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>check_k3</span>
<a name="line-1544"></a>      <span class='hs-keyword'>where</span>
<a name="line-1545"></a>        <span class='hs-varid'>fs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvFlavourRole</span> <span class='hs-varid'>ev</span>
<a name="line-1546"></a>        <span class='hs-varid'>check_k2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span>  <span class='hs-varop'>`eqMayRewriteFR`</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span>                   <span class='hs-comment'>-- (K2a)</span>
<a name="line-1547"></a>                <span class='hs-varop'>||</span>     <span class='hs-layout'>(</span><span class='hs-varid'>fs</span>  <span class='hs-varop'>`eqMayRewriteFR`</span> <span class='hs-varid'>new_fr</span><span class='hs-layout'>)</span>               <span class='hs-comment'>-- (K2b)</span>
<a name="line-1548"></a>                <span class='hs-varop'>||</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>fr_may_rewrite</span>  <span class='hs-varid'>fs</span><span class='hs-layout'>)</span>                        <span class='hs-comment'>-- (K2c)</span>
<a name="line-1549"></a>                <span class='hs-varop'>||</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- (K2d)</span>
<a name="line-1550"></a>
<a name="line-1551"></a>        <span class='hs-varid'>check_k3</span>
<a name="line-1552"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>fr_may_rewrite</span> <span class='hs-varid'>fs</span>
<a name="line-1553"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>eq_rel</span> <span class='hs-keyword'>of</span>
<a name="line-1554"></a>              <span class='hs-conid'>NomEq</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>rhs_ty</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>new_tv</span><span class='hs-layout'>)</span>
<a name="line-1555"></a>              <span class='hs-conid'>ReprEq</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTyVarExposed</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>)</span>
<a name="line-1556"></a>
<a name="line-1557"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1558"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1559"></a>
<a name="line-1560"></a>    <span class='hs-varid'>keep_eq</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"keep_eq"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-1561"></a>
<a name="line-1562"></a><a name="kickOutAfterUnification"></a><span class='hs-definition'>kickOutAfterUnification</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Int</span>
<a name="line-1563"></a><span class='hs-definition'>kickOutAfterUnification</span> <span class='hs-varid'>new_tv</span>
<a name="line-1564"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-1565"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_kicked</span><span class='hs-layout'>,</span> <span class='hs-varid'>ics2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kickOutRewritable</span> <span class='hs-layout'>(</span><span class='hs-conid'>Given</span><span class='hs-layout'>,</span><span class='hs-conid'>NomEq</span><span class='hs-layout'>)</span>
<a name="line-1566"></a>                                                 <span class='hs-varid'>new_tv</span> <span class='hs-varid'>ics</span>
<a name="line-1567"></a>                     <span class='hs-comment'>-- Given because the tv := xi is given; NomEq because</span>
<a name="line-1568"></a>                     <span class='hs-comment'>-- only nominal equalities are solved by unification</span>
<a name="line-1569"></a>
<a name="line-1570"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setInertCans</span> <span class='hs-varid'>ics2</span>
<a name="line-1571"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>n_kicked</span> <span class='hs-layout'>}</span>
<a name="line-1572"></a>
<a name="line-1573"></a><span class='hs-comment'>{- Note [kickOutRewritable]
<a name="line-1574"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1575"></a>See also Note [inert_eqs: the inert equalities].
<a name="line-1576"></a>
<a name="line-1577"></a>When we add a new inert equality (a ~N ty) to the inert set,
<a name="line-1578"></a>we must kick out any inert items that could be rewritten by the
<a name="line-1579"></a>new equality, to maintain the inert-set invariants.
<a name="line-1580"></a>
<a name="line-1581"></a>  - We want to kick out an existing inert constraint if
<a name="line-1582"></a>    a) the new constraint can rewrite the inert one
<a name="line-1583"></a>    b) 'a' is free in the inert constraint (so that it *will*)
<a name="line-1584"></a>       rewrite it if we kick it out.
<a name="line-1585"></a>
<a name="line-1586"></a>    For (b) we use tyCoVarsOfCt, which returns the type variables /and
<a name="line-1587"></a>    the kind variables/ that are directly visible in the type. Hence
<a name="line-1588"></a>    we will have exposed all the rewriting we care about to make the
<a name="line-1589"></a>    most precise kinds visible for matching classes etc. No need to
<a name="line-1590"></a>    kick out constraints that mention type variables whose kinds
<a name="line-1591"></a>    contain this variable!
<a name="line-1592"></a>
<a name="line-1593"></a>  - A Derived equality can kick out [D] constraints in inert_eqs,
<a name="line-1594"></a>    inert_dicts, inert_irreds etc.
<a name="line-1595"></a>
<a name="line-1596"></a>  - We don't kick out constraints from inert_solved_dicts, and
<a name="line-1597"></a>    inert_solved_funeqs optimistically. But when we lookup we have to
<a name="line-1598"></a>    take the substitution into account
<a name="line-1599"></a>
<a name="line-1600"></a>
<a name="line-1601"></a>Note [Rewrite insolubles]
<a name="line-1602"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1603"></a>Suppose we have an insoluble alpha ~ [alpha], which is insoluble
<a name="line-1604"></a>because an occurs check.  And then we unify alpha := [Int].  Then we
<a name="line-1605"></a>really want to rewrite the insoluble to [Int] ~ [[Int]].  Now it can
<a name="line-1606"></a>be decomposed.  Otherwise we end up with a "Can't match [Int] ~
<a name="line-1607"></a>[[Int]]" which is true, but a bit confusing because the outer type
<a name="line-1608"></a>constructors match.
<a name="line-1609"></a>
<a name="line-1610"></a>Similarly, if we have a CHoleCan, we'd like to rewrite it with any
<a name="line-1611"></a>Givens, to give as informative an error messasge as possible
<a name="line-1612"></a>(Trac #12468, #11325).
<a name="line-1613"></a>
<a name="line-1614"></a>Hence:
<a name="line-1615"></a> * In the main simlifier loops in TcSimplify (solveWanteds,
<a name="line-1616"></a>   simpl_loop), we feed the insolubles in solveSimpleWanteds,
<a name="line-1617"></a>   so that they get rewritten (albeit not solved).
<a name="line-1618"></a>
<a name="line-1619"></a> * We kick insolubles out of the inert set, if they can be
<a name="line-1620"></a>   rewritten (see TcSMonad.kick_out_rewritable)
<a name="line-1621"></a>
<a name="line-1622"></a> * We rewrite those insolubles in TcCanonical.
<a name="line-1623"></a>   See Note [Make sure that insolubles are fully rewritten]
<a name="line-1624"></a>-}</span>
<a name="line-1625"></a>
<a name="line-1626"></a>
<a name="line-1627"></a>
<a name="line-1628"></a><a name="addInertSafehask"></a><span class='hs-comment'>--------------</span>
<a name="line-1629"></a><span class='hs-definition'>addInertSafehask</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span>
<a name="line-1630"></a><span class='hs-definition'>addInertSafehask</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1631"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addDict</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>item</span> <span class='hs-layout'>}</span>
<a name="line-1632"></a>
<a name="line-1633"></a><span class='hs-definition'>addInertSafehask</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>item</span>
<a name="line-1634"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"addInertSafehask: can't happen! Inserting "</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>item</span>
<a name="line-1635"></a>
<a name="line-1636"></a><a name="insertSafeOverlapFailureTcS"></a><span class='hs-definition'>insertSafeOverlapFailureTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1637"></a><span class='hs-comment'>-- See Note [Safe Haskell Overlapping Instances Implementation] in TcSimplify</span>
<a name="line-1638"></a><span class='hs-definition'>insertSafeOverlapFailureTcS</span> <span class='hs-varid'>item</span>
<a name="line-1639"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertCans</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>addInertSafehask</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>item</span><span class='hs-layout'>)</span>
<a name="line-1640"></a>
<a name="line-1641"></a><a name="getSafeOverlapFailures"></a><span class='hs-definition'>getSafeOverlapFailures</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Cts</span>
<a name="line-1642"></a><span class='hs-comment'>-- See Note [Safe Haskell Overlapping Instances Implementation] in TcSimplify</span>
<a name="line-1643"></a><span class='hs-definition'>getSafeOverlapFailures</span>
<a name="line-1644"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>safehask</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-1645"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>foldDicts</span> <span class='hs-varid'>consCts</span> <span class='hs-varid'>safehask</span> <span class='hs-varid'>emptyCts</span> <span class='hs-layout'>}</span>
<a name="line-1646"></a>
<a name="line-1647"></a><a name="addSolvedDict"></a><span class='hs-comment'>--------------</span>
<a name="line-1648"></a><span class='hs-definition'>addSolvedDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1649"></a><span class='hs-comment'>-- Add a new item in the solved set of the monad</span>
<a name="line-1650"></a><span class='hs-comment'>-- See Note [Solved dictionaries]</span>
<a name="line-1651"></a><span class='hs-definition'>addSolvedDict</span> <span class='hs-varid'>item</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-1652"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isIPPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>item</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- Never cache "solved" implicit parameters (not sure why!)</span>
<a name="line-1653"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1654"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1655"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"updSolvedSetTcs:"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>item</span>
<a name="line-1656"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1657"></a>             <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addDict</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_solved_dicts</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>item</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1658"></a>
<a name="line-1659"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1660"></a>*                                                                      *
<a name="line-1661"></a>                  Other inert-set operations
<a name="line-1662"></a>*                                                                      *
<a name="line-1663"></a>********************************************************************* -}</span>
<a name="line-1664"></a>
<a name="line-1665"></a><a name="updInertTcS"></a><span class='hs-definition'>updInertTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertSet</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1666"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-1667"></a><span class='hs-definition'>updInertTcS</span> <span class='hs-varid'>upd_fn</span>
<a name="line-1668"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInertsRef</span>
<a name="line-1669"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>curr_inert</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>is_var</span>
<a name="line-1670"></a>                     <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>is_var</span> <span class='hs-layout'>(</span><span class='hs-varid'>upd_fn</span> <span class='hs-varid'>curr_inert</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1671"></a>
<a name="line-1672"></a><a name="getInertCans"></a><span class='hs-definition'>getInertCans</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>InertCans</span>
<a name="line-1673"></a><span class='hs-definition'>getInertCans</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_cans</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1674"></a>
<a name="line-1675"></a><a name="setInertCans"></a><span class='hs-definition'>setInertCans</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1676"></a><span class='hs-definition'>setInertCans</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>inerts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>}</span>
<a name="line-1677"></a>
<a name="line-1678"></a><a name="updRetInertCans"></a><span class='hs-definition'>updRetInertCans</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>InertCans</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-1679"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-1680"></a><span class='hs-definition'>updRetInertCans</span> <span class='hs-varid'>upd_fn</span>
<a name="line-1681"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInertsRef</span>
<a name="line-1682"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>is_var</span>
<a name="line-1683"></a>                     <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>cans'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_cans</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span>
<a name="line-1684"></a>                     <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>is_var</span> <span class='hs-layout'>(</span><span class='hs-varid'>inerts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cans'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1685"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1686"></a>
<a name="line-1687"></a><a name="updInertCans"></a><span class='hs-definition'>updInertCans</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1688"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-1689"></a><span class='hs-definition'>updInertCans</span> <span class='hs-varid'>upd_fn</span>
<a name="line-1690"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>inerts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_cans</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1691"></a>
<a name="line-1692"></a><a name="updInertDicts"></a><span class='hs-definition'>updInertDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1693"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-1694"></a><span class='hs-definition'>updInertDicts</span> <span class='hs-varid'>upd_fn</span>
<a name="line-1695"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertCans</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1696"></a>
<a name="line-1697"></a><a name="updInertSafehask"></a><span class='hs-definition'>updInertSafehask</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1698"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-1699"></a><span class='hs-definition'>updInertSafehask</span> <span class='hs-varid'>upd_fn</span>
<a name="line-1700"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertCans</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_safehask</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1701"></a>
<a name="line-1702"></a><a name="updInertFunEqs"></a><span class='hs-definition'>updInertFunEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1703"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-1704"></a><span class='hs-definition'>updInertFunEqs</span> <span class='hs-varid'>upd_fn</span>
<a name="line-1705"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertCans</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1706"></a>
<a name="line-1707"></a><a name="updInertIrreds"></a><span class='hs-definition'>updInertIrreds</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1708"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-1709"></a><span class='hs-definition'>updInertIrreds</span> <span class='hs-varid'>upd_fn</span>
<a name="line-1710"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertCans</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1711"></a>
<a name="line-1712"></a><a name="getInertEqs"></a><span class='hs-definition'>getInertEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>DTyVarEnv</span> <span class='hs-conid'>EqualCtList</span><span class='hs-layout'>)</span>
<a name="line-1713"></a><span class='hs-definition'>getInertEqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>inert</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1714"></a>
<a name="line-1715"></a><a name="getInertInsols"></a><span class='hs-definition'>getInertInsols</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Cts</span>
<a name="line-1716"></a><span class='hs-definition'>getInertInsols</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_insols</span> <span class='hs-varid'>inert</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1717"></a>
<a name="line-1718"></a><a name="getInertGivens"></a><span class='hs-definition'>getInertGivens</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-1719"></a><span class='hs-comment'>-- Returns the Given constraints in the inert set,</span>
<a name="line-1720"></a><span class='hs-comment'>-- with type functions *not* unflattened</span>
<a name="line-1721"></a><span class='hs-definition'>getInertGivens</span>
<a name="line-1722"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-1723"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>all_cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldDicts</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span>
<a name="line-1724"></a>                     <span class='hs-varop'>$</span> <span class='hs-varid'>foldFunEqs</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span>
<a name="line-1725"></a>                     <span class='hs-varop'>$</span> <span class='hs-varid'>concat</span> <span class='hs-layout'>(</span><span class='hs-varid'>dVarEnvElts</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1726"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-varid'>isGivenCt</span> <span class='hs-varid'>all_cts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1727"></a>
<a name="line-1728"></a><a name="getPendingScDicts"></a><span class='hs-definition'>getPendingScDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-1729"></a><span class='hs-comment'>-- Find all inert Given dictionaries whose cc_pend_sc flag is True</span>
<a name="line-1730"></a><span class='hs-comment'>-- Set the flag to False in the inert set, and return that Ct</span>
<a name="line-1731"></a><span class='hs-definition'>getPendingScDicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updRetInertCans</span> <span class='hs-varid'>get_sc_dicts</span>
<a name="line-1732"></a>  <span class='hs-keyword'>where</span>
<a name="line-1733"></a>    <span class='hs-varid'>get_sc_dicts</span> <span class='hs-varid'>ic</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dicts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1734"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>sc_pend_dicts</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic'</span><span class='hs-layout'>)</span>
<a name="line-1735"></a>      <span class='hs-keyword'>where</span>
<a name="line-1736"></a>        <span class='hs-varid'>ic'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>add</span> <span class='hs-varid'>dicts</span> <span class='hs-varid'>sc_pend_dicts</span> <span class='hs-layout'>}</span>
<a name="line-1737"></a>
<a name="line-1738"></a>        <span class='hs-varid'>sc_pend_dicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-1739"></a>        <span class='hs-varid'>sc_pend_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldDicts</span> <span class='hs-varid'>get_pending</span> <span class='hs-varid'>dicts</span> <span class='hs-conid'>[]</span>
<a name="line-1740"></a>
<a name="line-1741"></a>    <span class='hs-varid'>get_pending</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- Get dicts with cc_pend_sc = True</span>
<a name="line-1742"></a>                                       <span class='hs-comment'>-- but flipping the flag</span>
<a name="line-1743"></a>    <span class='hs-varid'>get_pending</span> <span class='hs-varid'>dict</span> <span class='hs-varid'>dicts</span>
<a name="line-1744"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>dict'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isPendingScDict</span> <span class='hs-varid'>dict</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dict'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>dicts</span>
<a name="line-1745"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dicts</span>
<a name="line-1746"></a>
<a name="line-1747"></a>    <span class='hs-varid'>add</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span>
<a name="line-1748"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>dicts</span>
<a name="line-1749"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addDict</span> <span class='hs-varid'>dicts</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ct</span>
<a name="line-1750"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"getPendingScDicts"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-1751"></a>
<a name="line-1752"></a><a name="getUnsolvedInerts"></a><span class='hs-definition'>getUnsolvedInerts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span>
<a name="line-1753"></a>                         <span class='hs-layout'>,</span> <span class='hs-conid'>Cts</span>     <span class='hs-comment'>-- Tyvar eqs: a ~ ty</span>
<a name="line-1754"></a>                         <span class='hs-layout'>,</span> <span class='hs-conid'>Cts</span>     <span class='hs-comment'>-- Fun eqs:   F a ~ ty</span>
<a name="line-1755"></a>                         <span class='hs-layout'>,</span> <span class='hs-conid'>Cts</span>     <span class='hs-comment'>-- Insoluble</span>
<a name="line-1756"></a>                         <span class='hs-layout'>,</span> <span class='hs-conid'>Cts</span> <span class='hs-layout'>)</span>   <span class='hs-comment'>-- All others</span>
<a name="line-1757"></a><span class='hs-comment'>-- Return all the unsolved [Wanted] or [Derived] constraints</span>
<a name="line-1758"></a><span class='hs-comment'>--</span>
<a name="line-1759"></a><span class='hs-comment'>-- Post-condition: the returned simple constraints are all fully zonked</span>
<a name="line-1760"></a><span class='hs-comment'>--                     (because they come from the inert set)</span>
<a name="line-1761"></a><span class='hs-comment'>--                 the unsolved implics may not be</span>
<a name="line-1762"></a><span class='hs-definition'>getUnsolvedInerts</span>
<a name="line-1763"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_eqs</span>
<a name="line-1764"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fun_eqs</span>
<a name="line-1765"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>irreds</span>
<a name="line-1766"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idicts</span>
<a name="line-1767"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>inert_insols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insols</span>
<a name="line-1768"></a>           <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-1769"></a>
<a name="line-1770"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>unsolved_tv_eqs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTyEqs</span> <span class='hs-varid'>add_if_unsolved</span> <span class='hs-varid'>tv_eqs</span> <span class='hs-varid'>emptyCts</span>
<a name="line-1771"></a>            <span class='hs-varid'>unsolved_fun_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldFunEqs</span> <span class='hs-varid'>add_if_wanted</span> <span class='hs-varid'>fun_eqs</span> <span class='hs-varid'>emptyCts</span>
<a name="line-1772"></a>            <span class='hs-varid'>unsolved_irreds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bag</span><span class='hs-varop'>.</span><span class='hs-varid'>filterBag</span> <span class='hs-varid'>is_unsolved</span> <span class='hs-varid'>irreds</span>
<a name="line-1773"></a>            <span class='hs-varid'>unsolved_dicts</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldDicts</span> <span class='hs-varid'>add_if_unsolved</span> <span class='hs-varid'>idicts</span> <span class='hs-varid'>emptyCts</span>
<a name="line-1774"></a>            <span class='hs-varid'>unsolved_others</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsolved_irreds</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>unsolved_dicts</span>
<a name="line-1775"></a>            <span class='hs-varid'>unsolved_insols</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterBag</span> <span class='hs-varid'>is_unsolved</span> <span class='hs-varid'>insols</span>
<a name="line-1776"></a>
<a name="line-1777"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>implics</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getWorkListImplics</span>
<a name="line-1778"></a>
<a name="line-1779"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"getUnsolvedInerts"</span> <span class='hs-varop'>$</span>
<a name="line-1780"></a>        <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>" tv eqs ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>unsolved_tv_eqs</span>
<a name="line-1781"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"fun eqs ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>unsolved_fun_eqs</span>
<a name="line-1782"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"insols ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>unsolved_insols</span>
<a name="line-1783"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"others ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>unsolved_others</span>
<a name="line-1784"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"implics ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>implics</span> <span class='hs-keyglyph'>]</span>
<a name="line-1785"></a>
<a name="line-1786"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>implics</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsolved_tv_eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsolved_fun_eqs</span>
<a name="line-1787"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>unsolved_insols</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsolved_others</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1788"></a>  <span class='hs-keyword'>where</span>
<a name="line-1789"></a>    <span class='hs-varid'>add_if_unsolved</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-1790"></a>    <span class='hs-varid'>add_if_unsolved</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_unsolved</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-varop'>`consCts`</span> <span class='hs-varid'>cts</span>
<a name="line-1791"></a>                           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span>
<a name="line-1792"></a>
<a name="line-1793"></a>    <span class='hs-varid'>is_unsolved</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isGivenCt</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Wanted or Derived</span>
<a name="line-1794"></a>
<a name="line-1795"></a>    <span class='hs-comment'>-- For CFunEqCans we ignore the Derived ones, and keep</span>
<a name="line-1796"></a>    <span class='hs-comment'>-- only the Wanteds for flattening.  The Derived ones</span>
<a name="line-1797"></a>    <span class='hs-comment'>-- share a unification variable with the corresponding</span>
<a name="line-1798"></a>    <span class='hs-comment'>-- Wanted, so we definitely don't want to to participate</span>
<a name="line-1799"></a>    <span class='hs-comment'>-- in unflattening</span>
<a name="line-1800"></a>    <span class='hs-comment'>-- See Note [Type family equations]</span>
<a name="line-1801"></a>    <span class='hs-varid'>add_if_wanted</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isWantedCt</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-varop'>`consCts`</span> <span class='hs-varid'>cts</span>
<a name="line-1802"></a>                         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span>
<a name="line-1803"></a>
<a name="line-1804"></a><a name="isInInertEqs"></a><span class='hs-definition'>isInInertEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DTyVarEnv</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1805"></a><span class='hs-comment'>-- True if (a ~N ty) is in the inert set, in either Given or Wanted</span>
<a name="line-1806"></a><span class='hs-definition'>isInInertEqs</span> <span class='hs-varid'>eqs</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>rhs</span>
<a name="line-1807"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupDVarEnv</span> <span class='hs-varid'>eqs</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-1808"></a>      <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1809"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>same_pred</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-varid'>cts</span>
<a name="line-1810"></a>  <span class='hs-keyword'>where</span>
<a name="line-1811"></a>    <span class='hs-varid'>same_pred</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>ct</span>
<a name="line-1812"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_eq_rel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq_rel</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ct</span>
<a name="line-1813"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>NomEq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>eq_rel</span>
<a name="line-1814"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>rhs2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1815"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1816"></a>
<a name="line-1817"></a><a name="getNoGivenEqs"></a><span class='hs-definition'>getNoGivenEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span>          <span class='hs-comment'>-- TcLevel of this implication</span>
<a name="line-1818"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>       <span class='hs-comment'>-- Skolems of this implication</span>
<a name="line-1819"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Bool</span>      <span class='hs-comment'>-- True &lt;=&gt; definitely no residual given equalities</span>
<a name="line-1820"></a>                      <span class='hs-layout'>,</span> <span class='hs-conid'>Cts</span> <span class='hs-layout'>)</span>     <span class='hs-comment'>-- Insoluble constraints arising from givens</span>
<a name="line-1821"></a><span class='hs-comment'>-- See Note [When does an implication have given equalities?]</span>
<a name="line-1822"></a><span class='hs-definition'>getNoGivenEqs</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-1823"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ieqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>iirreds</span>
<a name="line-1824"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>inert_insols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insols</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1825"></a>              <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-1826"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>has_given_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>||</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ev_given_here</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ctEvidence</span><span class='hs-layout'>)</span> <span class='hs-conid'>False</span>
<a name="line-1827"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>iirreds</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>insols</span><span class='hs-layout'>)</span>
<a name="line-1828"></a>                          <span class='hs-varop'>||</span> <span class='hs-varid'>anyDVarEnv</span> <span class='hs-varid'>eqs_given_here</span> <span class='hs-varid'>ieqs</span>
<a name="line-1829"></a>
<a name="line-1830"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"getNoGivenEqs"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>has_given_eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>inerts</span>
<a name="line-1831"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>insols</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1832"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>has_given_eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>insols</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1833"></a>  <span class='hs-keyword'>where</span>
<a name="line-1834"></a>    <span class='hs-varid'>eqs_given_here</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1835"></a>    <span class='hs-varid'>eqs_given_here</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span><span class='hs-keyglyph'>]</span>
<a name="line-1836"></a>                              <span class='hs-comment'>-- Givens are always a sigleton</span>
<a name="line-1837"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>skolem_bound_here</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>ev_given_here</span> <span class='hs-varid'>ev</span>
<a name="line-1838"></a>    <span class='hs-varid'>eqs_given_here</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1839"></a>
<a name="line-1840"></a>    <span class='hs-varid'>ev_given_here</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1841"></a>    <span class='hs-comment'>-- True for a Given bound by the current implication,</span>
<a name="line-1842"></a>    <span class='hs-comment'>-- i.e. the current level</span>
<a name="line-1843"></a>    <span class='hs-varid'>ev_given_here</span> <span class='hs-varid'>ev</span>
<a name="line-1844"></a>      <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>isGiven</span> <span class='hs-varid'>ev</span>
<a name="line-1845"></a>      <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>tclvl</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ctLocLevel</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvLoc</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-1846"></a>
<a name="line-1847"></a>    <span class='hs-varid'>skol_tv_set</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-1848"></a>    <span class='hs-varid'>skolem_bound_here</span> <span class='hs-varid'>tv</span> <span class='hs-comment'>-- See Note [Let-bound skolems]</span>
<a name="line-1849"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-1850"></a>          <span class='hs-conid'>SkolemTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>skol_tv_set</span>
<a name="line-1851"></a>          <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1852"></a>
<a name="line-1853"></a><a name="matchableGivens"></a><span class='hs-comment'>-- | Returns Given constraints that might,</span>
<a name="line-1854"></a><span class='hs-comment'>-- potentially, match the given pred. This is used when checking to see if a</span>
<a name="line-1855"></a><span class='hs-comment'>-- Given might overlap with an instance. See Note [Instance and Given overlap]</span>
<a name="line-1856"></a><span class='hs-comment'>-- in TcInteract.</span>
<a name="line-1857"></a><span class='hs-definition'>matchableGivens</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-1858"></a><span class='hs-definition'>matchableGivens</span> <span class='hs-varid'>loc_w</span> <span class='hs-varid'>pred</span> <span class='hs-layout'>(</span><span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_cans</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1859"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterBag</span> <span class='hs-varid'>matchable_given</span> <span class='hs-varid'>all_relevant_givens</span>
<a name="line-1860"></a>  <span class='hs-keyword'>where</span>
<a name="line-1861"></a>    <span class='hs-comment'>-- just look in class constraints and irreds. matchableGivens does get called</span>
<a name="line-1862"></a>    <span class='hs-comment'>-- for ~R constraints, but we don't need to look through equalities, because</span>
<a name="line-1863"></a>    <span class='hs-comment'>-- canonical equalities are used for rewriting. We'll only get caught by</span>
<a name="line-1864"></a>    <span class='hs-comment'>-- non-canonical -- that is, irreducible -- equalities.</span>
<a name="line-1865"></a>    <span class='hs-varid'>all_relevant_givens</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span>
<a name="line-1866"></a>    <span class='hs-varid'>all_relevant_givens</span>
<a name="line-1867"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>clas</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getClassPredTys_maybe</span> <span class='hs-varid'>pred</span>
<a name="line-1868"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findDictsByClass</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>inert_cans</span><span class='hs-layout'>)</span> <span class='hs-varid'>clas</span>
<a name="line-1869"></a>        <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>inert_cans</span>
<a name="line-1870"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1871"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>inert_cans</span>
<a name="line-1872"></a>
<a name="line-1873"></a>    <span class='hs-varid'>matchable_given</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1874"></a>    <span class='hs-varid'>matchable_given</span> <span class='hs-varid'>ct</span>
<a name="line-1875"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc_g</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ctev</span>
<a name="line-1876"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcUnifyTys</span> <span class='hs-varid'>bind_meta_tv</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>ctev</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pred</span><span class='hs-keyglyph'>]</span>
<a name="line-1877"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>prohibitedSuperClassSolve</span> <span class='hs-varid'>loc_g</span> <span class='hs-varid'>loc_w</span><span class='hs-layout'>)</span>
<a name="line-1878"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1879"></a>
<a name="line-1880"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1881"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1882"></a>      <span class='hs-keyword'>where</span>
<a name="line-1883"></a>        <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cc_ev</span> <span class='hs-varid'>ct</span>
<a name="line-1884"></a>
<a name="line-1885"></a>    <span class='hs-varid'>bind_meta_tv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BindFlag</span>
<a name="line-1886"></a>    <span class='hs-comment'>-- Any meta tyvar may be unified later, so we treat it as</span>
<a name="line-1887"></a>    <span class='hs-comment'>-- bindable when unifying with givens. That ensures that we</span>
<a name="line-1888"></a>    <span class='hs-comment'>-- conservatively assume that a meta tyvar might get unified with</span>
<a name="line-1889"></a>    <span class='hs-comment'>-- something that matches the 'given', until demonstrated</span>
<a name="line-1890"></a>    <span class='hs-comment'>-- otherwise.  More info in Note [Instance and Given overlap]</span>
<a name="line-1891"></a>    <span class='hs-comment'>-- in TcInteract</span>
<a name="line-1892"></a>    <span class='hs-varid'>bind_meta_tv</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-1893"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isFskTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BindMe</span>
<a name="line-1894"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Skolem</span>
<a name="line-1895"></a>
<a name="line-1896"></a><a name="prohibitedSuperClassSolve"></a><span class='hs-definition'>prohibitedSuperClassSolve</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1897"></a><span class='hs-comment'>-- See Note [Solving superclass constraints] in TcInstDcls</span>
<a name="line-1898"></a><span class='hs-definition'>prohibitedSuperClassSolve</span> <span class='hs-varid'>from_loc</span> <span class='hs-varid'>solve_loc</span>
<a name="line-1899"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>GivenOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstSC</span> <span class='hs-varid'>given_size</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>from_loc</span>
<a name="line-1900"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>ScOrigin</span> <span class='hs-varid'>wanted_size</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>solve_loc</span>
<a name="line-1901"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>given_size</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>wanted_size</span>
<a name="line-1902"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1903"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1904"></a>
<a name="line-1905"></a><span class='hs-comment'>{- Note [Unsolved Derived equalities]
<a name="line-1906"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1907"></a>In getUnsolvedInerts, we return a derived equality from the inert_eqs
<a name="line-1908"></a>because it is a candidate for floating out of this implication.  We
<a name="line-1909"></a>only float equalities with a meta-tyvar on the left, so we only pull
<a name="line-1910"></a>those out here.
<a name="line-1911"></a>
<a name="line-1912"></a>Note [When does an implication have given equalities?]
<a name="line-1913"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1914"></a>Consider an implication
<a name="line-1915"></a>   beta =&gt; alpha ~ Int
<a name="line-1916"></a>where beta is a unification variable that has already been unified
<a name="line-1917"></a>to () in an outer scope.  Then we can float the (alpha ~ Int) out
<a name="line-1918"></a>just fine. So when deciding whether the givens contain an equality,
<a name="line-1919"></a>we should canonicalise first, rather than just looking at the original
<a name="line-1920"></a>givens (Trac #8644).
<a name="line-1921"></a>
<a name="line-1922"></a>So we simply look at the inert, canonical Givens and see if there are
<a name="line-1923"></a>any equalities among them, the calculation of has_given_eqs.  There
<a name="line-1924"></a>are some wrinkles:
<a name="line-1925"></a>
<a name="line-1926"></a> * We must know which ones are bound in *this* implication and which
<a name="line-1927"></a>   are bound further out.  We can find that out from the TcLevel
<a name="line-1928"></a>   of the Given, which is itself recorded in the tcl_tclvl field
<a name="line-1929"></a>   of the TcLclEnv stored in the Given (ev_given_here).
<a name="line-1930"></a>
<a name="line-1931"></a>   What about interactions between inner and outer givens?
<a name="line-1932"></a>      - Outer given is rewritten by an inner given, then there must
<a name="line-1933"></a>        have been an inner given equality, hence the “given-eq” flag
<a name="line-1934"></a>        will be true anyway.
<a name="line-1935"></a>
<a name="line-1936"></a>      - Inner given rewritten by outer, retains its level (ie. The inner one)
<a name="line-1937"></a>
<a name="line-1938"></a> * We must take account of *potential* equalities, like the one above:
<a name="line-1939"></a>      beta =&gt; ...blah...
<a name="line-1940"></a>   If we still don't know what beta is, we conservatively treat it as potentially
<a name="line-1941"></a>   becoming an equality. Hence including 'irreds' in the calculation or has_given_eqs.
<a name="line-1942"></a>
<a name="line-1943"></a> * When flattening givens, we generate Given equalities like
<a name="line-1944"></a>     &lt;F [a]&gt; : F [a] ~ f,
<a name="line-1945"></a>   with Refl evidence, and we *don't* want those to count as an equality
<a name="line-1946"></a>   in the givens!  After all, the entire flattening business is just an
<a name="line-1947"></a>   internal matter, and the evidence does not mention any of the 'givens'
<a name="line-1948"></a>   of this implication.  So we do not treat inert_funeqs as a 'given equality'.
<a name="line-1949"></a>
<a name="line-1950"></a> * See Note [Let-bound skolems] for another wrinkle
<a name="line-1951"></a>
<a name="line-1952"></a> * We do *not* need to worry about representational equalities, because
<a name="line-1953"></a>   these do not affect the ability to float constraints.
<a name="line-1954"></a>
<a name="line-1955"></a>Note [Let-bound skolems]
<a name="line-1956"></a>~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1957"></a>If   * the inert set contains a canonical Given CTyEqCan (a ~ ty)
<a name="line-1958"></a>and  * 'a' is a skolem bound in this very implication, b
<a name="line-1959"></a>
<a name="line-1960"></a>then:
<a name="line-1961"></a>a) The Given is pretty much a let-binding, like
<a name="line-1962"></a>      f :: (a ~ b-&gt;c) =&gt; a -&gt; a
<a name="line-1963"></a>   Here the equality constraint is like saying
<a name="line-1964"></a>      let a = b-&gt;c in ...
<a name="line-1965"></a>   It is not adding any new, local equality  information,
<a name="line-1966"></a>   and hence can be ignored by has_given_eqs
<a name="line-1967"></a>
<a name="line-1968"></a>b) 'a' will have been completely substituted out in the inert set,
<a name="line-1969"></a>   so we can safely discard it.  Notably, it doesn't need to be
<a name="line-1970"></a>   returned as part of 'fsks'
<a name="line-1971"></a>
<a name="line-1972"></a>For an example, see Trac #9211.
<a name="line-1973"></a>-}</span>
<a name="line-1974"></a>
<a name="line-1975"></a><a name="removeInertCts"></a><span class='hs-definition'>removeInertCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span>
<a name="line-1976"></a><span class='hs-comment'>-- ^ Remove inert constraints from the 'InertCans', for use when a</span>
<a name="line-1977"></a><span class='hs-comment'>-- typechecker plugin wishes to discard a given.</span>
<a name="line-1978"></a><span class='hs-definition'>removeInertCts</span> <span class='hs-varid'>cts</span> <span class='hs-varid'>icans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl'</span> <span class='hs-varid'>removeInertCt</span> <span class='hs-varid'>icans</span> <span class='hs-varid'>cts</span>
<a name="line-1979"></a>
<a name="line-1980"></a><a name="removeInertCt"></a><span class='hs-definition'>removeInertCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span>
<a name="line-1981"></a><span class='hs-definition'>removeInertCt</span> <span class='hs-varid'>is</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span>
<a name="line-1982"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>of</span>
<a name="line-1983"></a>
<a name="line-1984"></a>    <span class='hs-conid'>CDictCan</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cl</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1985"></a>      <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delDict</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span> <span class='hs-varid'>cl</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span>
<a name="line-1986"></a>
<a name="line-1987"></a>    <span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_fun</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tf</span><span class='hs-layout'>,</span>  <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1988"></a>      <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delFunEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span> <span class='hs-varid'>tf</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span>
<a name="line-1989"></a>
<a name="line-1990"></a>    <span class='hs-conid'>CTyEqCan</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span>  <span class='hs-varid'>cc_rhs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1991"></a>      <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delTyEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span> <span class='hs-varid'>x</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-1992"></a>
<a name="line-1993"></a>    <span class='hs-conid'>CIrredEvCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"removeInertCt: CIrredEvCan"</span>
<a name="line-1994"></a>    <span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"removeInertCt: CNonCanonical"</span>
<a name="line-1995"></a>    <span class='hs-conid'>CHoleCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"removeInertCt: CHoleCan"</span>
<a name="line-1996"></a>
<a name="line-1997"></a>
<a name="line-1998"></a><a name="lookupFlatCache"></a><span class='hs-definition'>lookupFlatCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>CtFlavour</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1999"></a><span class='hs-definition'>lookupFlatCache</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>tys</span>
<a name="line-2000"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_flat_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flat_cache</span>
<a name="line-2001"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span>
<a name="line-2002"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>firstJusts</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>lookup_inerts</span> <span class='hs-varid'>inert_funeqs</span><span class='hs-layout'>,</span>
<a name="line-2003"></a>                             <span class='hs-varid'>lookup_flats</span> <span class='hs-varid'>flat_cache</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2004"></a>  <span class='hs-keyword'>where</span>
<a name="line-2005"></a>    <span class='hs-varid'>lookup_inerts</span> <span class='hs-varid'>inert_funeqs</span>
<a name="line-2006"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_fsk</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fsk</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xis</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2007"></a>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findFunEq</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>tys</span>
<a name="line-2008"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`eqTypes`</span> <span class='hs-varid'>xis</span>   <span class='hs-comment'>-- The lookup might find a near-match; see</span>
<a name="line-2009"></a>                            <span class='hs-comment'>-- Note [Use loose types in inert set]</span>
<a name="line-2010"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvCoercion</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>fsk</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEvFlavour</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span>
<a name="line-2011"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-2012"></a>
<a name="line-2013"></a>    <span class='hs-varid'>lookup_flats</span> <span class='hs-varid'>flat_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findExactFunEq</span> <span class='hs-varid'>flat_cache</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>tys</span>
<a name="line-2014"></a>
<a name="line-2015"></a>
<a name="line-2016"></a><a name="lookupInInerts"></a><span class='hs-definition'>lookupInInerts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>)</span>
<a name="line-2017"></a><span class='hs-comment'>-- Is this exact predicate type cached in the solved or canonicals of the InertSet?</span>
<a name="line-2018"></a><span class='hs-definition'>lookupInInerts</span> <span class='hs-varid'>pty</span>
<a name="line-2019"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-varid'>pty</span>
<a name="line-2020"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span>
<a name="line-2021"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupSolvedDict</span> <span class='hs-varid'>inerts</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`mplus`</span>
<a name="line-2022"></a>                 <span class='hs-varid'>lookupInertDict</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_cans</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2023"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-comment'>-- NB: No caching for equalities, IPs, holes, or errors</span>
<a name="line-2024"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-2025"></a>
<a name="line-2026"></a><a name="lookupInertDict"></a><span class='hs-comment'>-- | Look up a dictionary inert. NB: the returned 'CtEvidence' might not</span>
<a name="line-2027"></a><span class='hs-comment'>-- match the input exactly. Note [Use loose types in inert set].</span>
<a name="line-2028"></a><span class='hs-definition'>lookupInertDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-2029"></a><span class='hs-definition'>lookupInertDict</span> <span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dicts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-2030"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>findDict</span> <span class='hs-varid'>dicts</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyword'>of</span>
<a name="line-2031"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-2032"></a>      <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-2033"></a>
<a name="line-2034"></a><a name="lookupSolvedDict"></a><span class='hs-comment'>-- | Look up a solved inert. NB: the returned 'CtEvidence' might not</span>
<a name="line-2035"></a><span class='hs-comment'>-- match the input exactly. See Note [Use loose types in inert set].</span>
<a name="line-2036"></a><span class='hs-definition'>lookupSolvedDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-2037"></a><span class='hs-comment'>-- Returns just if exactly this predicate type exists in the solved.</span>
<a name="line-2038"></a><span class='hs-definition'>lookupSolvedDict</span> <span class='hs-layout'>(</span><span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>solved</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-2039"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>findDict</span> <span class='hs-varid'>solved</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyword'>of</span>
<a name="line-2040"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ev</span>
<a name="line-2041"></a>      <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-2042"></a>
<a name="line-2043"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-2044"></a>*                                                                      *
<a name="line-2045"></a>                   Irreds
<a name="line-2046"></a>*                                                                      *
<a name="line-2047"></a>********************************************************************* -}</span>
<a name="line-2048"></a>
<a name="line-2049"></a><a name="foldIrreds"></a><span class='hs-definition'>foldIrreds</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-2050"></a><span class='hs-definition'>foldIrreds</span> <span class='hs-varid'>k</span> <span class='hs-varid'>irreds</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-varid'>k</span> <span class='hs-varid'>z</span> <span class='hs-varid'>irreds</span>
<a name="line-2051"></a>
<a name="line-2052"></a>
<a name="line-2053"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-2054"></a>*                                                                      *
<a name="line-2055"></a>                   TcAppMap
<a name="line-2056"></a>*                                                                      *
<a name="line-2057"></a>************************************************************************
<a name="line-2058"></a>
<a name="line-2059"></a>Note [Use loose types in inert set]
<a name="line-2060"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2061"></a>Say we know (Eq (a |&gt; c1)) and we need (Eq (a |&gt; c2)). One is clearly
<a name="line-2062"></a>solvable from the other. So, we do lookup in the inert set using
<a name="line-2063"></a>loose types, which omit the kind-check.
<a name="line-2064"></a>
<a name="line-2065"></a>We must be careful when using the result of a lookup because it may
<a name="line-2066"></a>not match the requested info exactly!
<a name="line-2067"></a>
<a name="line-2068"></a>-}</span>
<a name="line-2069"></a>
<a name="line-2070"></a><a name="TcAppMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UniqDFM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListMap</span> <span class='hs-conid'>LooseTypeMap</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-2071"></a>    <span class='hs-comment'>-- Indexed by tycon then the arg types, using "loose" matching, where</span>
<a name="line-2072"></a>    <span class='hs-comment'>-- we don't require kind equality. This allows, for example, (a |&gt; co)</span>
<a name="line-2073"></a>    <span class='hs-comment'>-- to match (a).</span>
<a name="line-2074"></a>    <span class='hs-comment'>-- See Note [Use loose types in inert set]</span>
<a name="line-2075"></a>    <span class='hs-comment'>-- Used for types and classes; hence UniqDFM</span>
<a name="line-2076"></a>    <span class='hs-comment'>-- See Note [foldTM determinism] for why we use UniqDFM here</span>
<a name="line-2077"></a>
<a name="line-2078"></a><a name="isEmptyTcAppMap"></a><span class='hs-definition'>isEmptyTcAppMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2079"></a><span class='hs-definition'>isEmptyTcAppMap</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isNullUDFM</span> <span class='hs-varid'>m</span>
<a name="line-2080"></a>
<a name="line-2081"></a><a name="emptyTcAppMap"></a><span class='hs-definition'>emptyTcAppMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>
<a name="line-2082"></a><span class='hs-definition'>emptyTcAppMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUDFM</span>
<a name="line-2083"></a>
<a name="line-2084"></a><a name="findTcApp"></a><span class='hs-definition'>findTcApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>
<a name="line-2085"></a><span class='hs-definition'>findTcApp</span> <span class='hs-varid'>m</span> <span class='hs-varid'>u</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tys_map</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupUDFM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>u</span>
<a name="line-2086"></a>                       <span class='hs-layout'>;</span> <span class='hs-varid'>lookupTM</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>tys_map</span> <span class='hs-layout'>}</span>
<a name="line-2087"></a>
<a name="line-2088"></a><a name="delTcApp"></a><span class='hs-definition'>delTcApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>
<a name="line-2089"></a><span class='hs-definition'>delTcApp</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>adjustUDFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>deleteTM</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span>
<a name="line-2090"></a>
<a name="line-2091"></a><a name="insertTcApp"></a><span class='hs-definition'>insertTcApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>
<a name="line-2092"></a><span class='hs-definition'>insertTcApp</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alterUDFM</span> <span class='hs-varid'>alter_tm</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span>
<a name="line-2093"></a>  <span class='hs-keyword'>where</span>
<a name="line-2094"></a>    <span class='hs-varid'>alter_tm</span> <span class='hs-varid'>mb_tm</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>insertTM</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>(</span><span class='hs-varid'>mb_tm</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>emptyTM</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2095"></a>
<a name="line-2096"></a><span class='hs-comment'>-- mapTcApp :: (a-&gt;b) -&gt; TcAppMap a -&gt; TcAppMap b</span>
<a name="line-2097"></a><span class='hs-comment'>-- mapTcApp f = mapUDFM (mapTM f)</span>
<a name="line-2098"></a>
<a name="line-2099"></a><a name="filterTcAppMap"></a><span class='hs-definition'>filterTcAppMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-conid'>Ct</span>
<a name="line-2100"></a><span class='hs-definition'>filterTcAppMap</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span>
<a name="line-2101"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapUDFM</span> <span class='hs-varid'>do_tm</span> <span class='hs-varid'>m</span>
<a name="line-2102"></a>  <span class='hs-keyword'>where</span>
<a name="line-2103"></a>    <span class='hs-varid'>do_tm</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTM</span> <span class='hs-varid'>insert_mb</span> <span class='hs-varid'>tm</span> <span class='hs-varid'>emptyTM</span>
<a name="line-2104"></a>    <span class='hs-varid'>insert_mb</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>tm</span>
<a name="line-2105"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ct</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertTM</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>tm</span>
<a name="line-2106"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tm</span>
<a name="line-2107"></a>       <span class='hs-keyword'>where</span>
<a name="line-2108"></a>         <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>of</span>
<a name="line-2109"></a>                <span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tys</span>
<a name="line-2110"></a>                <span class='hs-conid'>CDictCan</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tys</span>
<a name="line-2111"></a>                <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"filterTcAppMap"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-2112"></a>
<a name="line-2113"></a><a name="tcAppMapToBag"></a><span class='hs-definition'>tcAppMapToBag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-varid'>a</span>
<a name="line-2114"></a><span class='hs-definition'>tcAppMapToBag</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTcAppMap</span> <span class='hs-varid'>consBag</span> <span class='hs-varid'>m</span> <span class='hs-varid'>emptyBag</span>
<a name="line-2115"></a>
<a name="line-2116"></a><a name="foldTcAppMap"></a><span class='hs-definition'>foldTcAppMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-2117"></a><span class='hs-definition'>foldTcAppMap</span> <span class='hs-varid'>k</span> <span class='hs-varid'>m</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldUDFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldTM</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-varid'>z</span> <span class='hs-varid'>m</span>
<a name="line-2118"></a>
<a name="line-2119"></a>
<a name="line-2120"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-2121"></a>*                                                                      *
<a name="line-2122"></a>                   DictMap
<a name="line-2123"></a>*                                                                      *
<a name="line-2124"></a>********************************************************************* -}</span>
<a name="line-2125"></a>
<a name="line-2126"></a><a name="DictMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>
<a name="line-2127"></a>
<a name="line-2128"></a><a name="emptyDictMap"></a><span class='hs-definition'>emptyDictMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span>
<a name="line-2129"></a><span class='hs-definition'>emptyDictMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyTcAppMap</span>
<a name="line-2130"></a>
<a name="line-2131"></a><span class='hs-comment'>-- sizeDictMap :: DictMap a -&gt; Int</span>
<a name="line-2132"></a><span class='hs-comment'>-- sizeDictMap m = foldDicts (\ _ x -&gt; x+1) m 0</span>
<a name="line-2133"></a>
<a name="line-2134"></a><a name="findDict"></a><span class='hs-definition'>findDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>
<a name="line-2135"></a><span class='hs-definition'>findDict</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findTcApp</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-2136"></a>
<a name="line-2137"></a><a name="findDictsByClass"></a><span class='hs-definition'>findDictsByClass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-varid'>a</span>
<a name="line-2138"></a><span class='hs-definition'>findDictsByClass</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span>
<a name="line-2139"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupUDFM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTM</span> <span class='hs-varid'>consBag</span> <span class='hs-varid'>tm</span> <span class='hs-varid'>emptyBag</span>
<a name="line-2140"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span>
<a name="line-2141"></a>
<a name="line-2142"></a><a name="delDict"></a><span class='hs-definition'>delDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span>
<a name="line-2143"></a><span class='hs-definition'>delDict</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delTcApp</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-2144"></a>
<a name="line-2145"></a><a name="addDict"></a><span class='hs-definition'>addDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span>
<a name="line-2146"></a><span class='hs-definition'>addDict</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>item</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertTcApp</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>item</span>
<a name="line-2147"></a>
<a name="line-2148"></a><a name="addDictsByClass"></a><span class='hs-definition'>addDictsByClass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span>
<a name="line-2149"></a><span class='hs-definition'>addDictsByClass</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>items</span>
<a name="line-2150"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addToUDFM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldrBag</span> <span class='hs-varid'>add</span> <span class='hs-varid'>emptyTM</span> <span class='hs-varid'>items</span><span class='hs-layout'>)</span>
<a name="line-2151"></a>  <span class='hs-keyword'>where</span>
<a name="line-2152"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertTM</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>tm</span>
<a name="line-2153"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"addDictsByClass"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-2154"></a>
<a name="line-2155"></a><a name="filterDicts"></a><span class='hs-definition'>filterDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span>
<a name="line-2156"></a><span class='hs-definition'>filterDicts</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterTcAppMap</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span>
<a name="line-2157"></a>
<a name="line-2158"></a><a name="partitionDicts"></a><span class='hs-definition'>partitionDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>,</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span>
<a name="line-2159"></a><span class='hs-definition'>partitionDicts</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTcAppMap</span> <span class='hs-varid'>k</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyDicts</span><span class='hs-layout'>)</span>
<a name="line-2160"></a>  <span class='hs-keyword'>where</span>
<a name="line-2161"></a>    <span class='hs-varid'>k</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>(</span><span class='hs-varid'>yeses</span><span class='hs-layout'>,</span> <span class='hs-varid'>noes</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ct</span>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span> <span class='hs-varop'>`consBag`</span> <span class='hs-varid'>yeses</span><span class='hs-layout'>,</span> <span class='hs-varid'>noes</span><span class='hs-layout'>)</span>
<a name="line-2162"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>yeses</span><span class='hs-layout'>,</span>              <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>noes</span><span class='hs-layout'>)</span>
<a name="line-2163"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span>
<a name="line-2164"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addDict</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ct</span>
<a name="line-2165"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"partitionDicts"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-2166"></a>
<a name="line-2167"></a><a name="dictsToBag"></a><span class='hs-definition'>dictsToBag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-varid'>a</span>
<a name="line-2168"></a><span class='hs-definition'>dictsToBag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcAppMapToBag</span>
<a name="line-2169"></a>
<a name="line-2170"></a><a name="foldDicts"></a><span class='hs-definition'>foldDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-2171"></a><span class='hs-definition'>foldDicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTcAppMap</span>
<a name="line-2172"></a>
<a name="line-2173"></a><a name="emptyDicts"></a><span class='hs-definition'>emptyDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span>
<a name="line-2174"></a><span class='hs-definition'>emptyDicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyTcAppMap</span>
<a name="line-2175"></a>
<a name="line-2176"></a>
<a name="line-2177"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-2178"></a>*                                                                      *
<a name="line-2179"></a>                   FunEqMap
<a name="line-2180"></a>*                                                                      *
<a name="line-2181"></a>********************************************************************* -}</span>
<a name="line-2182"></a>
<a name="line-2183"></a><a name="FunEqMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>  <span class='hs-comment'>-- A map whose key is a (TyCon, [Type]) pair</span>
<a name="line-2184"></a>
<a name="line-2185"></a><a name="emptyFunEqs"></a><span class='hs-definition'>emptyFunEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>
<a name="line-2186"></a><span class='hs-definition'>emptyFunEqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyTcAppMap</span>
<a name="line-2187"></a>
<a name="line-2188"></a><a name="findFunEq"></a><span class='hs-definition'>findFunEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>
<a name="line-2189"></a><span class='hs-definition'>findFunEq</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findTcApp</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-2190"></a>
<a name="line-2191"></a><a name="funEqsToBag"></a><span class='hs-definition'>funEqsToBag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-varid'>a</span>
<a name="line-2192"></a><span class='hs-definition'>funEqsToBag</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTcAppMap</span> <span class='hs-varid'>consBag</span> <span class='hs-varid'>m</span> <span class='hs-varid'>emptyBag</span>
<a name="line-2193"></a>
<a name="line-2194"></a><a name="findFunEqsByTyCon"></a><span class='hs-definition'>findFunEqsByTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-2195"></a><span class='hs-comment'>-- Get inert function equation constraints that have the given tycon</span>
<a name="line-2196"></a><span class='hs-comment'>-- in their head.  Not that the constraints remain in the inert set.</span>
<a name="line-2197"></a><span class='hs-comment'>-- We use this to check for derived interactions with built-in type-function</span>
<a name="line-2198"></a><span class='hs-comment'>-- constructors.</span>
<a name="line-2199"></a><span class='hs-definition'>findFunEqsByTyCon</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span>
<a name="line-2200"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupUDFM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTM</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varid'>tm</span> <span class='hs-conid'>[]</span>
<a name="line-2201"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-2202"></a>
<a name="line-2203"></a><a name="foldFunEqs"></a><span class='hs-definition'>foldFunEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-2204"></a><span class='hs-definition'>foldFunEqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTcAppMap</span>
<a name="line-2205"></a>
<a name="line-2206"></a><span class='hs-comment'>-- mapFunEqs :: (a -&gt; b) -&gt; FunEqMap a -&gt; FunEqMap b</span>
<a name="line-2207"></a><span class='hs-comment'>-- mapFunEqs = mapTcApp</span>
<a name="line-2208"></a>
<a name="line-2209"></a><span class='hs-comment'>-- filterFunEqs :: (Ct -&gt; Bool) -&gt; FunEqMap Ct -&gt; FunEqMap Ct</span>
<a name="line-2210"></a><span class='hs-comment'>-- filterFunEqs = filterTcAppMap</span>
<a name="line-2211"></a>
<a name="line-2212"></a><a name="insertFunEq"></a><span class='hs-definition'>insertFunEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span>
<a name="line-2213"></a><span class='hs-definition'>insertFunEq</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>val</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertTcApp</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>val</span>
<a name="line-2214"></a>
<a name="line-2215"></a><a name="partitionFunEqs"></a><span class='hs-definition'>partitionFunEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span>
<a name="line-2216"></a><span class='hs-comment'>-- Optimise for the case where the predicate is false</span>
<a name="line-2217"></a><span class='hs-comment'>-- partitionFunEqs is called only from kick-out, and kick-out usually</span>
<a name="line-2218"></a><span class='hs-comment'>-- kicks out very few equalities, so we want to optimise for that case</span>
<a name="line-2219"></a><span class='hs-definition'>partitionFunEqs</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>yeses</span><span class='hs-layout'>,</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>del</span> <span class='hs-varid'>m</span> <span class='hs-varid'>yeses</span><span class='hs-layout'>)</span>
<a name="line-2220"></a>  <span class='hs-keyword'>where</span>
<a name="line-2221"></a>    <span class='hs-varid'>yeses</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTcAppMap</span> <span class='hs-varid'>k</span> <span class='hs-varid'>m</span> <span class='hs-conid'>[]</span>
<a name="line-2222"></a>    <span class='hs-varid'>k</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>yeses</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ct</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>yeses</span>
<a name="line-2223"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>yeses</span>
<a name="line-2224"></a>    <span class='hs-varid'>del</span> <span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_fun</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span>
<a name="line-2225"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delFunEq</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-2226"></a>    <span class='hs-varid'>del</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"partitionFunEqs"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-2227"></a>
<a name="line-2228"></a><a name="delFunEq"></a><span class='hs-definition'>delFunEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span>
<a name="line-2229"></a><span class='hs-definition'>delFunEq</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delTcApp</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-2230"></a>
<a name="line-2231"></a><a name="ExactFunEqMap"></a><span class='hs-comment'>------------------------------</span>
<a name="line-2232"></a><a name="ExactFunEqMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ExactFunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UniqFM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListMap</span> <span class='hs-conid'>TypeMap</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-2233"></a>
<a name="line-2234"></a><a name="emptyExactFunEqs"></a><span class='hs-definition'>emptyExactFunEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExactFunEqMap</span> <span class='hs-varid'>a</span>
<a name="line-2235"></a><span class='hs-definition'>emptyExactFunEqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUFM</span>
<a name="line-2236"></a>
<a name="line-2237"></a><a name="findExactFunEq"></a><span class='hs-definition'>findExactFunEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExactFunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>
<a name="line-2238"></a><span class='hs-definition'>findExactFunEq</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tys_map</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupUFM</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-2239"></a>                             <span class='hs-layout'>;</span> <span class='hs-varid'>lookupTM</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>tys_map</span> <span class='hs-layout'>}</span>
<a name="line-2240"></a>
<a name="line-2241"></a><a name="insertExactFunEq"></a><span class='hs-definition'>insertExactFunEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExactFunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExactFunEqMap</span> <span class='hs-varid'>a</span>
<a name="line-2242"></a><span class='hs-definition'>insertExactFunEq</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>val</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alterUFM</span> <span class='hs-varid'>alter_tm</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-2243"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>alter_tm</span> <span class='hs-varid'>mb_tm</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>insertTM</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>val</span> <span class='hs-layout'>(</span><span class='hs-varid'>mb_tm</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>emptyTM</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2244"></a>
<a name="line-2245"></a><span class='hs-comment'>{-
<a name="line-2246"></a>************************************************************************
<a name="line-2247"></a>*                                                                      *
<a name="line-2248"></a>*              The TcS solver monad                                    *
<a name="line-2249"></a>*                                                                      *
<a name="line-2250"></a>************************************************************************
<a name="line-2251"></a>
<a name="line-2252"></a>Note [The TcS monad]
<a name="line-2253"></a>~~~~~~~~~~~~~~~~~~~~
<a name="line-2254"></a>The TcS monad is a weak form of the main Tc monad
<a name="line-2255"></a>
<a name="line-2256"></a>All you can do is
<a name="line-2257"></a>    * fail
<a name="line-2258"></a>    * allocate new variables
<a name="line-2259"></a>    * fill in evidence variables
<a name="line-2260"></a>
<a name="line-2261"></a>Filling in a dictionary evidence variable means to create a binding
<a name="line-2262"></a>for it, so TcS carries a mutable location where the binding can be
<a name="line-2263"></a>added.  This is initialised from the innermost implication constraint.
<a name="line-2264"></a>-}</span>
<a name="line-2265"></a>
<a name="line-2266"></a><a name="TcSEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcSEnv</span>
<a name="line-2267"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span>
<a name="line-2268"></a>      <span class='hs-varid'>tcs_ev_binds</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span><span class='hs-layout'>,</span>
<a name="line-2269"></a>
<a name="line-2270"></a>      <span class='hs-varid'>tcs_unified</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span>
<a name="line-2271"></a>         <span class='hs-comment'>-- The number of unification variables we have filled</span>
<a name="line-2272"></a>         <span class='hs-comment'>-- The important thing is whether it is non-zero</span>
<a name="line-2273"></a>
<a name="line-2274"></a>      <span class='hs-varid'>tcs_count</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Global step count</span>
<a name="line-2275"></a>
<a name="line-2276"></a>      <span class='hs-varid'>tcs_inerts</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>InertSet</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Current inert set</span>
<a name="line-2277"></a>
<a name="line-2278"></a>      <span class='hs-comment'>-- The main work-list and the flattening worklist</span>
<a name="line-2279"></a>      <span class='hs-comment'>-- See Note [Work list priorities] and</span>
<a name="line-2280"></a>      <span class='hs-varid'>tcs_worklist</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>WorkList</span> <span class='hs-comment'>-- Current worklist</span>
<a name="line-2281"></a>    <span class='hs-layout'>}</span>
<a name="line-2282"></a>
<a name="line-2283"></a><a name="TcS"></a><span class='hs-comment'>---------------</span>
<a name="line-2284"></a><a name="TcS"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span>
<a name="line-2285"></a>
<a name="line-2286"></a><a name="instance%20Functor%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Functor</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-2287"></a>  <span class='hs-varid'>fmap</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>f</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unTcS</span> <span class='hs-varid'>m</span>
<a name="line-2288"></a>
<a name="line-2289"></a><a name="instance%20Applicative%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Applicative</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-2290"></a>  <span class='hs-varid'>pure</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-2291"></a>  <span class='hs-layout'>(</span><span class='hs-varop'>&lt;*&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ap</span>
<a name="line-2292"></a>
<a name="line-2293"></a><a name="instance%20Monad%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monad</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-2294"></a>  <span class='hs-varid'>fail</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MonadFail</span><span class='hs-varop'>.</span><span class='hs-varid'>fail</span>
<a name="line-2295"></a>  <span class='hs-varid'>m</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>k</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ebs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unTcS</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ebs</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>r</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>ebs</span><span class='hs-layout'>)</span>
<a name="line-2296"></a>
<a name="line-2297"></a><a name="instance%20MonadFail.MonadFail%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadFail</span><span class='hs-varop'>.</span><span class='hs-conid'>MonadFail</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-2298"></a>  <span class='hs-varid'>fail</span> <span class='hs-varid'>err</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span>
<a name="line-2299"></a>
<a name="line-2300"></a><a name="instance%20MonadUnique%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadUnique</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-2301"></a>   <span class='hs-varid'>getUniqueSupplyM</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varid'>getUniqueSupplyM</span>
<a name="line-2302"></a>
<a name="line-2303"></a><a name="wrapTcS"></a><span class='hs-comment'>-- Basic functionality</span>
<a name="line-2304"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-2305"></a><span class='hs-definition'>wrapTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-2306"></a><span class='hs-comment'>-- Do not export wrapTcS, because it promotes an arbitrary TcM to TcS,</span>
<a name="line-2307"></a><span class='hs-comment'>-- and TcS is supposed to have limited functionality</span>
<a name="line-2308"></a><span class='hs-definition'>wrapTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>.</span> <span class='hs-varid'>const</span> <span class='hs-comment'>-- a TcM action will not use the TcEvBinds</span>
<a name="line-2309"></a>
<a name="line-2310"></a><a name="wrapErrTcS"></a><span class='hs-definition'>wrapErrTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-2311"></a><span class='hs-comment'>-- The thing wrapped should just fail</span>
<a name="line-2312"></a><span class='hs-comment'>-- There's no static check; it's up to the user</span>
<a name="line-2313"></a><span class='hs-comment'>-- Having a variant for each error message is too painful</span>
<a name="line-2314"></a><span class='hs-definition'>wrapErrTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span>
<a name="line-2315"></a>
<a name="line-2316"></a><a name="wrapWarnTcS"></a><span class='hs-definition'>wrapWarnTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-2317"></a><span class='hs-comment'>-- The thing wrapped should just add a warning, or no-op</span>
<a name="line-2318"></a><span class='hs-comment'>-- There's no static check; it's up to the user</span>
<a name="line-2319"></a><span class='hs-definition'>wrapWarnTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span>
<a name="line-2320"></a>
<a name="line-2321"></a><a name="failTcS"></a><span class='hs-definition'>failTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>panicTcS</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-2322"></a><a name="warnTcS"></a><span class='hs-definition'>warnTcS</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WarningFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2323"></a><a name="addErrTcS"></a><span class='hs-definition'>addErrTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2324"></a><span class='hs-definition'>failTcS</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>failWith</span>
<a name="line-2325"></a><span class='hs-definition'>warnTcS</span> <span class='hs-varid'>flag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>addWarn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Reason</span> <span class='hs-varid'>flag</span><span class='hs-layout'>)</span>
<a name="line-2326"></a><span class='hs-definition'>addErrTcS</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>addErr</span>
<a name="line-2327"></a><a name="panicTcS"></a><span class='hs-definition'>panicTcS</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"TcCanonical"</span> <span class='hs-varid'>doc</span>
<a name="line-2328"></a>
<a name="line-2329"></a><a name="traceTcS"></a><span class='hs-definition'>traceTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2330"></a><span class='hs-definition'>traceTcS</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>traceTc</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span>
<a name="line-2331"></a>
<a name="line-2332"></a><a name="runTcPluginTcS"></a><span class='hs-definition'>runTcPluginTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-2333"></a><span class='hs-definition'>runTcPluginTcS</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-varid'>runTcPluginM</span> <span class='hs-varid'>m</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>getTcEvBindsVar</span>
<a name="line-2334"></a>
<a name="line-2335"></a><a name="instance%20HasDynFlags%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasDynFlags</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-2336"></a>    <span class='hs-varid'>getDynFlags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-2337"></a>
<a name="line-2338"></a><a name="getGlobalRdrEnvTcS"></a><span class='hs-definition'>getGlobalRdrEnvTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>GlobalRdrEnv</span>
<a name="line-2339"></a><span class='hs-definition'>getGlobalRdrEnvTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getGlobalRdrEnv</span>
<a name="line-2340"></a>
<a name="line-2341"></a><a name="bumpStepCountTcS"></a><span class='hs-definition'>bumpStepCountTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2342"></a><span class='hs-definition'>bumpStepCountTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcs_count</span> <span class='hs-varid'>env</span>
<a name="line-2343"></a>                                    <span class='hs-layout'>;</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>ref</span>
<a name="line-2344"></a>                                    <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2345"></a>
<a name="line-2346"></a><a name="csTraceTcS"></a><span class='hs-definition'>csTraceTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2347"></a><span class='hs-definition'>csTraceTcS</span> <span class='hs-varid'>doc</span>
<a name="line-2348"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>csTraceTcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span>
<a name="line-2349"></a>
<a name="line-2350"></a><a name="traceFireTcS"></a><span class='hs-definition'>traceFireTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2351"></a><span class='hs-comment'>-- Dump a rule-firing trace</span>
<a name="line-2352"></a><span class='hs-definition'>traceFireTcS</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>doc</span>
<a name="line-2353"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>csTraceTcM</span> <span class='hs-varop'>$</span>
<a name="line-2354"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcs_count</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-2355"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tclvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getTcLevel</span>
<a name="line-2356"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Step"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n</span>
<a name="line-2357"></a>                       <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"l:"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tclvl</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-2358"></a>                                    <span class='hs-varid'>text</span> <span class='hs-str'>"d:"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocDepth</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvLoc</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2359"></a>                       <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>doc</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span><span class='hs-layout'>)</span>
<a name="line-2360"></a>                     <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2361"></a>
<a name="line-2362"></a><a name="csTraceTcM"></a><span class='hs-definition'>csTraceTcM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2363"></a><span class='hs-comment'>-- Constraint-solver tracing, -ddump-cs-trace</span>
<a name="line-2364"></a><span class='hs-definition'>csTraceTcM</span> <span class='hs-varid'>mk_doc</span>
<a name="line-2365"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-2366"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span>  <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_cs_trace</span> <span class='hs-varid'>dflags</span>
<a name="line-2367"></a>                  <span class='hs-varop'>||</span> <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_tc_trace</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>)</span>
<a name="line-2368"></a>              <span class='hs-layout'>(</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mk_doc</span>
<a name="line-2369"></a>                   <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>traceTcRn</span> <span class='hs-conid'>Opt_D_dump_cs_trace</span> <span class='hs-varid'>msg</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2370"></a>
<a name="line-2371"></a><a name="runTcS"></a><span class='hs-definition'>runTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>                <span class='hs-comment'>-- What to run</span>
<a name="line-2372"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvBindMap</span><span class='hs-layout'>)</span>
<a name="line-2373"></a><span class='hs-definition'>runTcS</span> <span class='hs-varid'>tcs</span>
<a name="line-2374"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcEvBinds</span>
<a name="line-2375"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runTcSWithEvBinds</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varid'>tcs</span>
<a name="line-2376"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getTcEvBindsMap</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-2377"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2378"></a>
<a name="line-2379"></a><a name="runTcSDeriveds"></a><span class='hs-comment'>-- | This variant of 'runTcS' will keep solving, even when only Deriveds</span>
<a name="line-2380"></a><span class='hs-comment'>-- are left around. It also doesn't return any evidence, as callers won't</span>
<a name="line-2381"></a><span class='hs-comment'>-- need it.</span>
<a name="line-2382"></a><span class='hs-definition'>runTcSDeriveds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2383"></a><span class='hs-definition'>runTcSDeriveds</span> <span class='hs-varid'>tcs</span>
<a name="line-2384"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcEvBinds</span>
<a name="line-2385"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>runTcSWithEvBinds</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varid'>tcs</span> <span class='hs-layout'>}</span>
<a name="line-2386"></a>
<a name="line-2387"></a><a name="runTcSEqualities"></a><span class='hs-comment'>-- | This can deal only with equality constraints.</span>
<a name="line-2388"></a><span class='hs-definition'>runTcSEqualities</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2389"></a><span class='hs-definition'>runTcSEqualities</span> <span class='hs-varid'>thing_inside</span>
<a name="line-2390"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcEvBinds</span>
<a name="line-2391"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>runTcSWithEvBinds</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>}</span>
<a name="line-2392"></a>
<a name="line-2393"></a><a name="runTcSWithEvBinds"></a><span class='hs-definition'>runTcSWithEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-2394"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-2395"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2396"></a><span class='hs-definition'>runTcSWithEvBinds</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varid'>tcs</span>
<a name="line-2397"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unified_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-num'>0</span>
<a name="line-2398"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>step_count</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-num'>0</span>
<a name="line-2399"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>inert_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>emptyInert</span>
<a name="line-2400"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>emptyWorkList</span>
<a name="line-2401"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_ev_binds</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-2402"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_unified</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unified_var</span>
<a name="line-2403"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_count</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>step_count</span>
<a name="line-2404"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_inerts</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_var</span>
<a name="line-2405"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_worklist</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl_var</span> <span class='hs-layout'>}</span>
<a name="line-2406"></a>
<a name="line-2407"></a>             <span class='hs-comment'>-- Run the computation</span>
<a name="line-2408"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unTcS</span> <span class='hs-varid'>tcs</span> <span class='hs-varid'>env</span>
<a name="line-2409"></a>
<a name="line-2410"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>count</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>step_count</span>
<a name="line-2411"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>count</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-2412"></a>         <span class='hs-varid'>csTraceTcM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Constraint solver steps ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>count</span><span class='hs-layout'>)</span>
<a name="line-2413"></a>
<a name="line-2414"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unflattenGivens</span> <span class='hs-varid'>inert_var</span>
<a name="line-2415"></a>
<a name="line-2416"></a><span class='hs-cpp'>#if defined(DEBUG)</span>
<a name="line-2417"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getTcEvBindsMap</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-2418"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkForCyclicBinds</span> <span class='hs-varid'>ev_binds</span>
<a name="line-2419"></a><span class='hs-cpp'>#endif</span>
<a name="line-2420"></a>
<a name="line-2421"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span>
<a name="line-2422"></a>
<a name="line-2423"></a><span class='hs-comment'>----------------------------</span>
<a name="line-2424"></a><span class='hs-cpp'>#if defined(DEBUG)</span>
<a name="line-2425"></a><a name="checkForCyclicBinds"></a><span class='hs-definition'>checkForCyclicBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2426"></a><span class='hs-definition'>checkForCyclicBinds</span> <span class='hs-varid'>ev_binds_map</span>
<a name="line-2427"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>cycles</span>
<a name="line-2428"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-2429"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>coercion_cycles</span>
<a name="line-2430"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>traceTc</span> <span class='hs-str'>"Cycle in evidence binds"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cycles</span>
<a name="line-2431"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2432"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"Cycle in coercion bindings"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>coercion_cycles</span>
<a name="line-2433"></a>  <span class='hs-keyword'>where</span>
<a name="line-2434"></a>    <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evBindMapBinds</span> <span class='hs-varid'>ev_binds_map</span>
<a name="line-2435"></a>
<a name="line-2436"></a>    <span class='hs-varid'>cycles</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>EvBind</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-2437"></a>    <span class='hs-varid'>cycles</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CyclicSCC</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stronglyConnCompFromEdgedVerticesUniq</span> <span class='hs-varid'>edges</span><span class='hs-keyglyph'>]</span>
<a name="line-2438"></a>
<a name="line-2439"></a>    <span class='hs-varid'>coercion_cycles</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cycles</span><span class='hs-layout'>,</span> <span class='hs-varid'>any</span> <span class='hs-varid'>is_co_bind</span> <span class='hs-varid'>c</span><span class='hs-keyglyph'>]</span>
<a name="line-2440"></a>    <span class='hs-varid'>is_co_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eb_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEqPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-2441"></a>
<a name="line-2442"></a>    <span class='hs-varid'>edges</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Node</span> <span class='hs-conid'>EvVar</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>]</span>
<a name="line-2443"></a>    <span class='hs-varid'>edges</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>DigraphNode</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-varid'>nonDetEltsUniqSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarsOfTerm</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2444"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eb_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>eb_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bagToList</span> <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>]</span>
<a name="line-2445"></a>            <span class='hs-comment'>-- It's OK to use nonDetEltsUFM here as</span>
<a name="line-2446"></a>            <span class='hs-comment'>-- stronglyConnCompFromEdgedVertices is still deterministic even</span>
<a name="line-2447"></a>            <span class='hs-comment'>-- if the edges are in nondeterministic order as explained in</span>
<a name="line-2448"></a>            <span class='hs-comment'>-- Note [Deterministic SCC] in Digraph.</span>
<a name="line-2449"></a><span class='hs-cpp'>#endif</span>
<a name="line-2450"></a>
<a name="line-2451"></a><a name="setEvBindsTcS"></a><span class='hs-comment'>----------------------------</span>
<a name="line-2452"></a><span class='hs-definition'>setEvBindsTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-2453"></a><span class='hs-definition'>setEvBindsTcS</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-2454"></a> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2455"></a>
<a name="line-2456"></a><a name="nestImplicTcS"></a><span class='hs-definition'>nestImplicTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-2457"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcLevel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-2458"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-2459"></a><span class='hs-definition'>nestImplicTcS</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>inner_tclvl</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-2460"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_unified</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unified_var</span>
<a name="line-2461"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_inerts</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_inert_var</span>
<a name="line-2462"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_count</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count</span>
<a name="line-2463"></a>                   <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2464"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>old_inert_var</span>
<a name="line-2465"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>nest_inert</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyInert</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_cans</span> <span class='hs-varid'>inerts</span>
<a name="line-2466"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-varid'>inerts</span> <span class='hs-layout'>}</span>
<a name="line-2467"></a>                          <span class='hs-comment'>-- See Note [Do not inherit the flat cache]</span>
<a name="line-2468"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_inert_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>nest_inert</span>
<a name="line-2469"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_wl_var</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>emptyWorkList</span>
<a name="line-2470"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>nest_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_ev_binds</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span>
<a name="line-2471"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_unified</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unified_var</span>
<a name="line-2472"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_count</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count</span>
<a name="line-2473"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_inerts</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_inert_var</span>
<a name="line-2474"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_worklist</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_wl_var</span> <span class='hs-layout'>}</span>
<a name="line-2475"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>setTcLevel</span> <span class='hs-varid'>inner_tclvl</span> <span class='hs-varop'>$</span>
<a name="line-2476"></a>                <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>nest_env</span>
<a name="line-2477"></a>
<a name="line-2478"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unflattenGivens</span> <span class='hs-varid'>new_inert_var</span>
<a name="line-2479"></a>
<a name="line-2480"></a><span class='hs-cpp'>#if defined(DEBUG)</span>
<a name="line-2481"></a>       <span class='hs-comment'>-- Perform a check that the thing_inside did not cause cycles</span>
<a name="line-2482"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getTcEvBindsMap</span> <span class='hs-varid'>ref</span>
<a name="line-2483"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkForCyclicBinds</span> <span class='hs-varid'>ev_binds</span>
<a name="line-2484"></a><span class='hs-cpp'>#endif</span>
<a name="line-2485"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span>
<a name="line-2486"></a>
<a name="line-2487"></a><span class='hs-comment'>{- Note [Do not inherit the flat cache]
<a name="line-2488"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2489"></a>We do not want to inherit the flat cache when processing nested
<a name="line-2490"></a>implications.  Consider
<a name="line-2491"></a>   a ~ F b, forall c. b~Int =&gt; blah
<a name="line-2492"></a>If we have F b ~ fsk in the flat-cache, and we push that into the
<a name="line-2493"></a>nested implication, we might miss that F b can be rewritten to F Int,
<a name="line-2494"></a>and hence perhpas solve it.  Moreover, the fsk from outside is
<a name="line-2495"></a>flattened out after solving the outer level, but and we don't
<a name="line-2496"></a>do that flattening recursively.
<a name="line-2497"></a>-}</span>
<a name="line-2498"></a>
<a name="line-2499"></a><a name="nestTcS"></a><span class='hs-definition'>nestTcS</span> <span class='hs-keyglyph'>::</span>  <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-2500"></a><span class='hs-comment'>-- Use the current untouchables, augmenting the current</span>
<a name="line-2501"></a><span class='hs-comment'>-- evidence bindings, and solved dictionaries</span>
<a name="line-2502"></a><span class='hs-comment'>-- But have no effect on the InertCans, or on the inert_flat_cache</span>
<a name="line-2503"></a><span class='hs-comment'>-- (we want to inherit the latter from processing the Givens)</span>
<a name="line-2504"></a><span class='hs-definition'>nestTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-2505"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_inerts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inerts_var</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2506"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>inerts_var</span>
<a name="line-2507"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_inert_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>inerts</span>
<a name="line-2508"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_wl_var</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>emptyWorkList</span>
<a name="line-2509"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>nest_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_inerts</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_inert_var</span>
<a name="line-2510"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_worklist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_wl_var</span> <span class='hs-layout'>}</span>
<a name="line-2511"></a>
<a name="line-2512"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>nest_env</span>
<a name="line-2513"></a>
<a name="line-2514"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>new_inert_var</span>
<a name="line-2515"></a>
<a name="line-2516"></a>       <span class='hs-comment'>-- we want to propogate the safe haskell failures</span>
<a name="line-2517"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>old_ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_cans</span> <span class='hs-varid'>inerts</span>
<a name="line-2518"></a>             <span class='hs-varid'>new_ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_cans</span> <span class='hs-varid'>new_inerts</span>
<a name="line-2519"></a>             <span class='hs-varid'>nxt_ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_ic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-varid'>new_ic</span> <span class='hs-layout'>}</span>
<a name="line-2520"></a>
<a name="line-2521"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>inerts_var</span>  <span class='hs-comment'>-- See Note [Propagate the solved dictionaries]</span>
<a name="line-2522"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>inerts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-varid'>new_inerts</span>
<a name="line-2523"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nxt_ic</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2524"></a>
<a name="line-2525"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span>
<a name="line-2526"></a>
<a name="line-2527"></a><a name="buildImplication"></a><span class='hs-definition'>buildImplication</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span>
<a name="line-2528"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- Skolems</span>
<a name="line-2529"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span>          <span class='hs-comment'>-- Givens</span>
<a name="line-2530"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>result</span>
<a name="line-2531"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-2532"></a><span class='hs-comment'>-- Just like TcUnify.buildImplication, but in the TcS monnad,</span>
<a name="line-2533"></a><span class='hs-comment'>-- using the work-list to gather the constraints</span>
<a name="line-2534"></a><span class='hs-definition'>buildImplication</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>givens</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-2535"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2536"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>emptyWorkList</span>
<a name="line-2537"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc_lvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getTcLevel</span>
<a name="line-2538"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_tclvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pushTcLevel</span> <span class='hs-varid'>tc_lvl</span>
<a name="line-2539"></a>
<a name="line-2540"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>setTcLevel</span> <span class='hs-varid'>new_tclvl</span> <span class='hs-varop'>$</span>
<a name="line-2541"></a>                <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_worklist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_wl_var</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2542"></a>
<a name="line-2543"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wl</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>new_wl_var</span>
<a name="line-2544"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>eqs</span>
<a name="line-2545"></a>         <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyTcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-2546"></a>         <span class='hs-keyword'>else</span>
<a name="line-2547"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getLclEnv</span>
<a name="line-2548"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcEvBinds</span>
<a name="line-2549"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>wc</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>wl_funeqs</span> <span class='hs-varid'>wl</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>wl_rest</span> <span class='hs-varid'>wl</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-2550"></a>                            <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>wl_deriv</span> <span class='hs-varid'>wl</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>wl_implics</span> <span class='hs-varid'>wl</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>)</span>
<a name="line-2551"></a>                   <span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>listToCts</span> <span class='hs-varid'>eqs</span>
<a name="line-2552"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span>
<a name="line-2553"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCts</span> <span class='hs-layout'>}</span>
<a name="line-2554"></a>             <span class='hs-varid'>imp</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_tclvl</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_tclvl</span>
<a name="line-2555"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>ic_skols</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-2556"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>ic_no_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2557"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>givens</span>
<a name="line-2558"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc</span>
<a name="line-2559"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>ic_status</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC_Unsolved</span>
<a name="line-2560"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>ic_binds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-2561"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>ic_env</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>
<a name="line-2562"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>ic_needed</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-2563"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skol_info</span> <span class='hs-layout'>}</span>
<a name="line-2564"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitBag</span> <span class='hs-varid'>imp</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcEvBinds</span> <span class='hs-varid'>ev_binds_var</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-2565"></a>
<a name="line-2566"></a><span class='hs-comment'>{-
<a name="line-2567"></a>Note [Propagate the solved dictionaries]
<a name="line-2568"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2569"></a>It's really quite important that nestTcS does not discard the solved
<a name="line-2570"></a>dictionaries from the thing_inside.
<a name="line-2571"></a>Consider
<a name="line-2572"></a>   Eq [a]
<a name="line-2573"></a>   forall b. empty =&gt;  Eq [a]
<a name="line-2574"></a>We solve the simple (Eq [a]), under nestTcS, and then turn our attention to
<a name="line-2575"></a>the implications.  It's definitely fine to use the solved dictionaries on
<a name="line-2576"></a>the inner implications, and it can make a signficant performance difference
<a name="line-2577"></a>if you do so.
<a name="line-2578"></a>-}</span>
<a name="line-2579"></a>
<a name="line-2580"></a><span class='hs-comment'>-- Getters and setters of TcEnv fields</span>
<a name="line-2581"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-2582"></a>
<a name="line-2583"></a><a name="getTcSInertsRef"></a><span class='hs-comment'>-- Getter of inerts and worklist</span>
<a name="line-2584"></a><span class='hs-definition'>getTcSInertsRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>InertSet</span><span class='hs-layout'>)</span>
<a name="line-2585"></a><span class='hs-definition'>getTcSInertsRef</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcs_inerts</span><span class='hs-layout'>)</span>
<a name="line-2586"></a>
<a name="line-2587"></a><a name="getTcSWorkListRef"></a><span class='hs-definition'>getTcSWorkListRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>WorkList</span><span class='hs-layout'>)</span>
<a name="line-2588"></a><span class='hs-definition'>getTcSWorkListRef</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcs_worklist</span><span class='hs-layout'>)</span>
<a name="line-2589"></a>
<a name="line-2590"></a><a name="getTcSInerts"></a><span class='hs-definition'>getTcSInerts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>InertSet</span>
<a name="line-2591"></a><span class='hs-definition'>getTcSInerts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getTcSInertsRef</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span><span class='hs-layout'>)</span>
<a name="line-2592"></a>
<a name="line-2593"></a><a name="setTcSInerts"></a><span class='hs-definition'>setTcSInerts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2594"></a><span class='hs-definition'>setTcSInerts</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInertsRef</span><span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2595"></a>
<a name="line-2596"></a><a name="getWorkListImplics"></a><span class='hs-definition'>getWorkListImplics</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span><span class='hs-layout'>)</span>
<a name="line-2597"></a><span class='hs-definition'>getWorkListImplics</span>
<a name="line-2598"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSWorkListRef</span>
<a name="line-2599"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wl_curr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>wl_var</span><span class='hs-layout'>)</span>
<a name="line-2600"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wl_implics</span> <span class='hs-varid'>wl_curr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2601"></a>
<a name="line-2602"></a><a name="updWorkListTcS"></a><span class='hs-definition'>updWorkListTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2603"></a><span class='hs-definition'>updWorkListTcS</span> <span class='hs-varid'>f</span>
<a name="line-2604"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSWorkListRef</span>
<a name="line-2605"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wl_curr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>wl_var</span><span class='hs-layout'>)</span>
<a name="line-2606"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_work</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>wl_curr</span>
<a name="line-2607"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>wl_var</span> <span class='hs-varid'>new_work</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2608"></a>
<a name="line-2609"></a><a name="emitWorkNC"></a><span class='hs-definition'>emitWorkNC</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CtEvidence</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2610"></a><span class='hs-definition'>emitWorkNC</span> <span class='hs-varid'>evs</span>
<a name="line-2611"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>evs</span>
<a name="line-2612"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-2613"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2614"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emitWork</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mkNonCanonical</span> <span class='hs-varid'>evs</span><span class='hs-layout'>)</span>
<a name="line-2615"></a>
<a name="line-2616"></a><a name="emitWork"></a><span class='hs-definition'>emitWork</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2617"></a><span class='hs-definition'>emitWork</span> <span class='hs-varid'>cts</span>
<a name="line-2618"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emitting fresh work"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2619"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendWorkListCts</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2620"></a>
<a name="line-2621"></a><a name="emitInsoluble"></a><span class='hs-definition'>emitInsoluble</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2622"></a><span class='hs-comment'>-- Emits a non-canonical constraint that will stand for a frozen error in the inerts.</span>
<a name="line-2623"></a><span class='hs-definition'>emitInsoluble</span> <span class='hs-varid'>ct</span>
<a name="line-2624"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emit insoluble"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>pprCtLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLoc</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2625"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varid'>add_insol</span> <span class='hs-layout'>}</span>
<a name="line-2626"></a>  <span class='hs-keyword'>where</span>
<a name="line-2627"></a>    <span class='hs-varid'>this_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span>
<a name="line-2628"></a>    <span class='hs-varid'>add_insol</span> <span class='hs-varid'>is</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_insols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_insols</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2629"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>drop_it</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is</span>
<a name="line-2630"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_insols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_insols</span> <span class='hs-varop'>`snocCts`</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-2631"></a>      <span class='hs-keyword'>where</span>
<a name="line-2632"></a>        <span class='hs-varid'>drop_it</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isDroppableDerivedCt</span> <span class='hs-varid'>ct</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-2633"></a>                  <span class='hs-varid'>anyBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcEqType</span> <span class='hs-varid'>this_pred</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ctPred</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_insols</span>
<a name="line-2634"></a>             <span class='hs-comment'>-- See Note [Do not add duplicate derived insolubles]</span>
<a name="line-2635"></a>
<a name="line-2636"></a><a name="newTcRef"></a><span class='hs-definition'>newTcRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRef</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-2637"></a><span class='hs-definition'>newTcRef</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-2638"></a>
<a name="line-2639"></a><a name="readTcRef"></a><span class='hs-definition'>readTcRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-2640"></a><span class='hs-definition'>readTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>ref</span><span class='hs-layout'>)</span>
<a name="line-2641"></a>
<a name="line-2642"></a><a name="updTcRef"></a><span class='hs-definition'>updTcRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>-&gt;</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2643"></a><span class='hs-definition'>updTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>upd_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>updTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>upd_fn</span><span class='hs-layout'>)</span>
<a name="line-2644"></a>
<a name="line-2645"></a><a name="getTcEvBindsVar"></a><span class='hs-definition'>getTcEvBindsVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-2646"></a><span class='hs-definition'>getTcEvBindsVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcs_ev_binds</span><span class='hs-layout'>)</span>
<a name="line-2647"></a>
<a name="line-2648"></a><a name="getTcLevel"></a><span class='hs-definition'>getTcLevel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcLevel</span>
<a name="line-2649"></a><span class='hs-definition'>getTcLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getTcLevel</span>
<a name="line-2650"></a>
<a name="line-2651"></a><a name="getTcEvBindsAndTCVs"></a><span class='hs-definition'>getTcEvBindsAndTCVs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBindMap</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCoVarSet</span><span class='hs-layout'>)</span>
<a name="line-2652"></a><span class='hs-definition'>getTcEvBindsAndTCVs</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-2653"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>bnds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getTcEvBindsMap</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-2654"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>tcvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getTcEvTyCoVars</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-2655"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bnds</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2656"></a>
<a name="line-2657"></a><a name="getTcEvBindsMap"></a><span class='hs-definition'>getTcEvBindsMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvBindMap</span>
<a name="line-2658"></a><span class='hs-definition'>getTcEvBindsMap</span>
<a name="line-2659"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcEvBindsVar</span>
<a name="line-2660"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getTcEvBindsMap</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-layout'>}</span>
<a name="line-2661"></a>
<a name="line-2662"></a><a name="unifyTyVar"></a><span class='hs-definition'>unifyTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2663"></a><span class='hs-comment'>-- Unify a meta-tyvar with a type</span>
<a name="line-2664"></a><span class='hs-comment'>-- We keep track of how many unifications have happened in tcs_unified,</span>
<a name="line-2665"></a><span class='hs-comment'>--</span>
<a name="line-2666"></a><span class='hs-comment'>-- We should never unify the same variable twice!</span>
<a name="line-2667"></a><span class='hs-definition'>unifyTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-2668"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-2669"></a>    <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2670"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>traceTc</span> <span class='hs-str'>"unifyTyVar"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>":="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2671"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-2672"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>updTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcs_unified</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2673"></a>
<a name="line-2674"></a><a name="reportUnifications"></a><span class='hs-definition'>reportUnifications</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-2675"></a><span class='hs-definition'>reportUnifications</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-2676"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2677"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inner_unified</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-num'>0</span>
<a name="line-2678"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_unified</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inner_unified</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2679"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>n_unifs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>inner_unified</span>
<a name="line-2680"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>updTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcs_unified</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varop'>+</span> <span class='hs-varid'>n_unifs</span><span class='hs-layout'>)</span>
<a name="line-2681"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_unifs</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2682"></a>
<a name="line-2683"></a><a name="getDefaultInfo"></a><span class='hs-definition'>getDefaultInfo</span> <span class='hs-keyglyph'>::</span>  <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2684"></a><span class='hs-definition'>getDefaultInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>tcGetDefaultTys</span>
<a name="line-2685"></a>
<a name="line-2686"></a><span class='hs-comment'>-- Just get some environments needed for instance looking up and matching</span>
<a name="line-2687"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-2688"></a>
<a name="line-2689"></a><a name="getInstEnvs"></a><span class='hs-definition'>getInstEnvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>InstEnvs</span>
<a name="line-2690"></a><span class='hs-definition'>getInstEnvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>tcGetInstEnvs</span>
<a name="line-2691"></a>
<a name="line-2692"></a><a name="getFamInstEnvs"></a><span class='hs-definition'>getFamInstEnvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>)</span>
<a name="line-2693"></a><span class='hs-definition'>getFamInstEnvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>FamInst</span><span class='hs-varop'>.</span><span class='hs-varid'>tcGetFamInstEnvs</span>
<a name="line-2694"></a>
<a name="line-2695"></a><a name="getTopEnv"></a><span class='hs-definition'>getTopEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>HscEnv</span>
<a name="line-2696"></a><span class='hs-definition'>getTopEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getTopEnv</span>
<a name="line-2697"></a>
<a name="line-2698"></a><a name="getGblEnv"></a><span class='hs-definition'>getGblEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-2699"></a><span class='hs-definition'>getGblEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getGblEnv</span>
<a name="line-2700"></a>
<a name="line-2701"></a><a name="getLclEnv"></a><span class='hs-definition'>getLclEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcLclEnv</span>
<a name="line-2702"></a><span class='hs-definition'>getLclEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getLclEnv</span>
<a name="line-2703"></a>
<a name="line-2704"></a><a name="tcLookupClass"></a><span class='hs-definition'>tcLookupClass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Class</span>
<a name="line-2705"></a><span class='hs-definition'>tcLookupClass</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>tcLookupClass</span> <span class='hs-varid'>c</span>
<a name="line-2706"></a>
<a name="line-2707"></a><a name="tcLookupId"></a><span class='hs-definition'>tcLookupId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Id</span>
<a name="line-2708"></a><span class='hs-definition'>tcLookupId</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>n</span>
<a name="line-2709"></a>
<a name="line-2710"></a><a name="addUsedGREs"></a><span class='hs-comment'>-- Setting names as used (used in the deriving of Coercible evidence)</span>
<a name="line-2711"></a><span class='hs-comment'>-- Too hackish to expose it to TcS? In that case somehow extract the used</span>
<a name="line-2712"></a><span class='hs-comment'>-- constructors from the result of solveInteract</span>
<a name="line-2713"></a><span class='hs-definition'>addUsedGREs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2714"></a><span class='hs-definition'>addUsedGREs</span> <span class='hs-varid'>gres</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span>  <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>addUsedGREs</span> <span class='hs-varid'>gres</span>
<a name="line-2715"></a>
<a name="line-2716"></a><a name="addUsedGRE"></a><span class='hs-definition'>addUsedGRE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalRdrElt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2717"></a><span class='hs-definition'>addUsedGRE</span> <span class='hs-varid'>warn_if_deprec</span> <span class='hs-varid'>gre</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>addUsedGRE</span> <span class='hs-varid'>warn_if_deprec</span> <span class='hs-varid'>gre</span>
<a name="line-2718"></a>
<a name="line-2719"></a>
<a name="line-2720"></a><span class='hs-comment'>-- Various smaller utilities [TODO, maybe will be absorbed in the instance matcher]</span>
<a name="line-2721"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-2722"></a>
<a name="line-2723"></a><a name="checkWellStagedDFun"></a><span class='hs-definition'>checkWellStagedDFun</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DFunId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2724"></a><span class='hs-definition'>checkWellStagedDFun</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>dfun_id</span> <span class='hs-varid'>loc</span>
<a name="line-2725"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>setCtLocM</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-2726"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>use_stage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getStage</span>
<a name="line-2727"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>checkWellStaged</span> <span class='hs-varid'>pp_thing</span> <span class='hs-varid'>bind_lvl</span> <span class='hs-layout'>(</span><span class='hs-varid'>thLevel</span> <span class='hs-varid'>use_stage</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2728"></a>  <span class='hs-keyword'>where</span>
<a name="line-2729"></a>    <span class='hs-varid'>pp_thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"instance for"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-2730"></a>    <span class='hs-varid'>bind_lvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>topIdLvl</span> <span class='hs-varid'>dfun_id</span>
<a name="line-2731"></a>
<a name="line-2732"></a><a name="pprEq"></a><span class='hs-definition'>pprEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2733"></a><span class='hs-definition'>pprEq</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprParendType</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'~'</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprParendType</span> <span class='hs-varid'>ty2</span>
<a name="line-2734"></a>
<a name="line-2735"></a><a name="isTouchableMetaTyVarTcS"></a><span class='hs-definition'>isTouchableMetaTyVarTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Bool</span>
<a name="line-2736"></a><span class='hs-definition'>isTouchableMetaTyVarTcS</span> <span class='hs-varid'>tv</span>
<a name="line-2737"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tclvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcLevel</span>
<a name="line-2738"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>isTouchableMetaTyVar</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>}</span>
<a name="line-2739"></a>
<a name="line-2740"></a><a name="isFilledMetaTyVar_maybe"></a><span class='hs-definition'>isFilledMetaTyVar_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-2741"></a><span class='hs-definition'>isFilledMetaTyVar_maybe</span> <span class='hs-varid'>tv</span>
<a name="line-2742"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-2743"></a>     <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>}</span>
<a name="line-2744"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>ref</span><span class='hs-layout'>)</span>
<a name="line-2745"></a>              <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cts</span> <span class='hs-keyword'>of</span>
<a name="line-2746"></a>                  <span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2747"></a>                  <span class='hs-conid'>Flexi</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-2748"></a>     <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-2749"></a>
<a name="line-2750"></a><a name="isFilledMetaTyVar"></a><span class='hs-definition'>isFilledMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Bool</span>
<a name="line-2751"></a><span class='hs-definition'>isFilledMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>isFilledMetaTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-2752"></a>
<a name="line-2753"></a><a name="zonkTyCoVarsAndFV"></a><span class='hs-definition'>zonkTyCoVarsAndFV</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyCoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcTyCoVarSet</span>
<a name="line-2754"></a><span class='hs-definition'>zonkTyCoVarsAndFV</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>zonkTyCoVarsAndFV</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-2755"></a>
<a name="line-2756"></a><a name="zonkTyCoVarsAndFVList"></a><span class='hs-definition'>zonkTyCoVarsAndFVList</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyCoVar</span><span class='hs-keyglyph'>]</span>
<a name="line-2757"></a><span class='hs-definition'>zonkTyCoVarsAndFVList</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>zonkTyCoVarsAndFVList</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-2758"></a>
<a name="line-2759"></a><a name="zonkCo"></a><span class='hs-definition'>zonkCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Coercion</span>
<a name="line-2760"></a><span class='hs-definition'>zonkCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>zonkCo</span>
<a name="line-2761"></a>
<a name="line-2762"></a><a name="zonkTcType"></a><span class='hs-definition'>zonkTcType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcType</span>
<a name="line-2763"></a><span class='hs-definition'>zonkTcType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2764"></a>
<a name="line-2765"></a><a name="zonkTcTypes"></a><span class='hs-definition'>zonkTcTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>
<a name="line-2766"></a><span class='hs-definition'>zonkTcTypes</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>zonkTcTypes</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2767"></a>
<a name="line-2768"></a><a name="zonkTcTyVar"></a><span class='hs-definition'>zonkTcTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcType</span>
<a name="line-2769"></a><span class='hs-definition'>zonkTcTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>zonkTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-2770"></a>
<a name="line-2771"></a><a name="zonkSimples"></a><span class='hs-definition'>zonkSimples</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Cts</span>
<a name="line-2772"></a><span class='hs-definition'>zonkSimples</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>zonkSimples</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span>
<a name="line-2773"></a>
<a name="line-2774"></a><a name="zonkWC"></a><span class='hs-definition'>zonkWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-2775"></a><span class='hs-definition'>zonkWC</span> <span class='hs-varid'>wc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>zonkWC</span> <span class='hs-varid'>wc</span><span class='hs-layout'>)</span>
<a name="line-2776"></a>
<a name="line-2777"></a><span class='hs-comment'>{-
<a name="line-2778"></a>Note [Do not add duplicate derived insolubles]
<a name="line-2779"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2780"></a>In general we *must* add an insoluble (Int ~ Bool) even if there is
<a name="line-2781"></a>one such there already, because they may come from distinct call
<a name="line-2782"></a>sites.  Not only do we want an error message for each, but with
<a name="line-2783"></a>-fdefer-type-errors we must generate evidence for each.  But for
<a name="line-2784"></a>*derived* insolubles, we only want to report each one once.  Why?
<a name="line-2785"></a>
<a name="line-2786"></a>(a) A constraint (C r s t) where r -&gt; s, say, may generate the same fundep
<a name="line-2787"></a>    equality many times, as the original constraint is successively rewritten.
<a name="line-2788"></a>
<a name="line-2789"></a>(b) Ditto the successive iterations of the main solver itself, as it traverses
<a name="line-2790"></a>    the constraint tree. See example below.
<a name="line-2791"></a>
<a name="line-2792"></a>Also for *given* insolubles we may get repeated errors, as we
<a name="line-2793"></a>repeatedly traverse the constraint tree.  These are relatively rare
<a name="line-2794"></a>anyway, so removing duplicates seems ok.  (Alternatively we could take
<a name="line-2795"></a>the SrcLoc into account.)
<a name="line-2796"></a>
<a name="line-2797"></a>Note that the test does not need to be particularly efficient because
<a name="line-2798"></a>it is only used if the program has a type error anyway.
<a name="line-2799"></a>
<a name="line-2800"></a>Example of (b): assume a top-level class and instance declaration:
<a name="line-2801"></a>
<a name="line-2802"></a>  class D a b | a -&gt; b
<a name="line-2803"></a>  instance D [a] [a]
<a name="line-2804"></a>
<a name="line-2805"></a>Assume we have started with an implication:
<a name="line-2806"></a>
<a name="line-2807"></a>  forall c. Eq c =&gt; { wc_simple = D [c] c [W] }
<a name="line-2808"></a>
<a name="line-2809"></a>which we have simplified to:
<a name="line-2810"></a>
<a name="line-2811"></a>  forall c. Eq c =&gt; { wc_simple = D [c] c [W]
<a name="line-2812"></a>                    , wc_insols = (c ~ [c]) [D] }
<a name="line-2813"></a>
<a name="line-2814"></a>For some reason, e.g. because we floated an equality somewhere else,
<a name="line-2815"></a>we might try to re-solve this implication. If we do not do a
<a name="line-2816"></a>dropDerivedWC, then we will end up trying to solve the following
<a name="line-2817"></a>constraints the second time:
<a name="line-2818"></a>
<a name="line-2819"></a>  (D [c] c) [W]
<a name="line-2820"></a>  (c ~ [c]) [D]
<a name="line-2821"></a>
<a name="line-2822"></a>which will result in two Deriveds to end up in the insoluble set:
<a name="line-2823"></a>
<a name="line-2824"></a>  wc_simple   = D [c] c [W]
<a name="line-2825"></a>  wc_insols = (c ~ [c]) [D], (c ~ [c]) [D]
<a name="line-2826"></a>-}</span>
<a name="line-2827"></a>
<a name="line-2828"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-2829"></a>*                                                                      *
<a name="line-2830"></a>*                Flatten skolems                                       *
<a name="line-2831"></a>*                                                                      *
<a name="line-2832"></a>********************************************************************* -}</span>
<a name="line-2833"></a>
<a name="line-2834"></a><a name="newFlattenSkolem"></a><span class='hs-definition'>newFlattenSkolem</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavour</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-2835"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>                    <span class='hs-comment'>-- F xis</span>
<a name="line-2836"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- [G/WD] x:: F xis ~ fsk</span>
<a name="line-2837"></a><span class='hs-definition'>newFlattenSkolem</span> <span class='hs-varid'>flav</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>xis</span>
<a name="line-2838"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>stuff</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>fsk</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>new_skolem</span>
<a name="line-2839"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fsk_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>fsk</span>
<a name="line-2840"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>extendFlatCache</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>xis</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>fsk_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEvFlavour</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-2841"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>stuff</span> <span class='hs-layout'>}</span>
<a name="line-2842"></a>  <span class='hs-keyword'>where</span>
<a name="line-2843"></a>    <span class='hs-varid'>fam_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>xis</span>
<a name="line-2844"></a>
<a name="line-2845"></a>    <span class='hs-varid'>new_skolem</span>
<a name="line-2846"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Given</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>flav</span>
<a name="line-2847"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fsk</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newFskTyVar</span> <span class='hs-varid'>fam_ty</span><span class='hs-layout'>)</span>
<a name="line-2848"></a>
<a name="line-2849"></a>           <span class='hs-comment'>-- Extend the inert_fsks list, for use by unflattenGivens</span>
<a name="line-2850"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>is</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_fsks</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsk</span><span class='hs-layout'>,</span> <span class='hs-varid'>fam_ty</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>inert_fsks</span> <span class='hs-varid'>is</span> <span class='hs-layout'>}</span>
<a name="line-2851"></a>
<a name="line-2852"></a>           <span class='hs-comment'>-- Construct the Refl evidence</span>
<a name="line-2853"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPrimEqPred</span> <span class='hs-varid'>fam_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>fsk</span><span class='hs-layout'>)</span>
<a name="line-2854"></a>                 <span class='hs-varid'>co</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>fam_ty</span>
<a name="line-2855"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>ev</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newGivenEvVar</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2856"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>fsk</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2857"></a>
<a name="line-2858"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-comment'>-- Generate a [WD] for both Wanted and Derived</span>
<a name="line-2859"></a>                   <span class='hs-comment'>-- See Note [No Derived CFunEqCans]</span>
<a name="line-2860"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fmv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newFmvTyVar</span> <span class='hs-varid'>fam_ty</span><span class='hs-layout'>)</span>
<a name="line-2861"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>hole_co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newWantedEq</span> <span class='hs-varid'>loc</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>fam_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>fmv</span><span class='hs-layout'>)</span>
<a name="line-2862"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>hole_co</span><span class='hs-layout'>,</span> <span class='hs-varid'>fmv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2863"></a>
<a name="line-2864"></a><a name="unflattenGivens"></a><span class='hs-comment'>----------------------------</span>
<a name="line-2865"></a><span class='hs-definition'>unflattenGivens</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2866"></a><span class='hs-comment'>-- Unflatten all the fsks created by flattening types in Given</span>
<a name="line-2867"></a><span class='hs-comment'>-- constraints We must be sure to do this, else we end up with</span>
<a name="line-2868"></a><span class='hs-comment'>-- flatten-skolems buried in any residual Wanteds</span>
<a name="line-2869"></a><span class='hs-comment'>--</span>
<a name="line-2870"></a><span class='hs-comment'>-- NB: this is the /only/ way that a fsk (MetaDetails = FlatSkolTv)</span>
<a name="line-2871"></a><span class='hs-comment'>--     is filled in. Nothing else does so.</span>
<a name="line-2872"></a><span class='hs-comment'>--</span>
<a name="line-2873"></a><span class='hs-comment'>-- It's here (rather than in TcFlatten) because the Right Places</span>
<a name="line-2874"></a><span class='hs-comment'>-- to call it are in runTcSWithEvBinds/nestImplicTcS, where it</span>
<a name="line-2875"></a><span class='hs-comment'>-- is nicely paired with the creation an empty inert_fsks list.</span>
<a name="line-2876"></a><span class='hs-definition'>unflattenGivens</span> <span class='hs-varid'>inert_var</span>
<a name="line-2877"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>inert_var</span>
<a name="line-2878"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>flatten_one</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_fsks</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2879"></a>  <span class='hs-keyword'>where</span>
<a name="line-2880"></a>    <span class='hs-varid'>flatten_one</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsk</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeMetaTyVar</span> <span class='hs-varid'>fsk</span> <span class='hs-varid'>ty</span>
<a name="line-2881"></a>
<a name="line-2882"></a><a name="extendFlatCache"></a><span class='hs-comment'>----------------------------</span>
<a name="line-2883"></a><span class='hs-definition'>extendFlatCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>CtFlavour</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2884"></a><span class='hs-definition'>extendFlatCache</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>xi_args</span> <span class='hs-varid'>stuff</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span>
<a name="line-2885"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGivenOrWDeriv</span> <span class='hs-varid'>fl</span>  <span class='hs-comment'>-- Maintain the invariant that inert_flat_cache</span>
<a name="line-2886"></a>                        <span class='hs-comment'>-- only has [G] and [WD] CFunEqCans</span>
<a name="line-2887"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-2888"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_FlatCache</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-2889"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"extendFlatCache"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>xi_args</span>
<a name="line-2890"></a>                                          <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fl</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2891"></a>            <span class='hs-comment'>-- 'co' can be bottom, in the case of derived items</span>
<a name="line-2892"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>is</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_flat_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2893"></a>            <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_flat_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertExactFunEq</span> <span class='hs-varid'>fc</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>xi_args</span> <span class='hs-varid'>stuff</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-2894"></a>
<a name="line-2895"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2896"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-2897"></a>
<a name="line-2898"></a><a name="unflattenFmv"></a><span class='hs-comment'>----------------------------</span>
<a name="line-2899"></a><span class='hs-definition'>unflattenFmv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2900"></a><span class='hs-comment'>-- Fill a flatten-meta-var, simply by unifying it.</span>
<a name="line-2901"></a><span class='hs-comment'>-- This does NOT count as a unification in tcs_unified.</span>
<a name="line-2902"></a><span class='hs-definition'>unflattenFmv</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-2903"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-2904"></a>    <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2905"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>traceTc</span> <span class='hs-str'>"unflattenFmv"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>":="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2906"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-2907"></a>
<a name="line-2908"></a><a name="demoteUnfilledFmv"></a><span class='hs-comment'>----------------------------</span>
<a name="line-2909"></a><span class='hs-definition'>demoteUnfilledFmv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2910"></a><span class='hs-comment'>-- If a flatten-meta-var is still un-filled,</span>
<a name="line-2911"></a><span class='hs-comment'>-- turn it into an ordinary meta-var</span>
<a name="line-2912"></a><span class='hs-definition'>demoteUnfilledFmv</span> <span class='hs-varid'>fmv</span>
<a name="line-2913"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_filled</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>isFilledMetaTyVar</span> <span class='hs-varid'>fmv</span>
<a name="line-2914"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>is_filled</span> <span class='hs-varop'>$</span>
<a name="line-2915"></a>                   <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tv_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>fmv</span><span class='hs-layout'>)</span>
<a name="line-2916"></a>                      <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeMetaTyVar</span> <span class='hs-varid'>fmv</span> <span class='hs-varid'>tv_ty</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-2917"></a>
<a name="line-2918"></a>
<a name="line-2919"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-2920"></a>*                                                                      *
<a name="line-2921"></a>*                Instantiation etc.
<a name="line-2922"></a>*                                                                      *
<a name="line-2923"></a>********************************************************************* -}</span>
<a name="line-2924"></a>
<a name="line-2925"></a><span class='hs-comment'>-- Instantiations</span>
<a name="line-2926"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-2927"></a>
<a name="line-2928"></a><a name="instDFunType"></a><span class='hs-definition'>instDFunType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DFunId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DFunInstType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcThetaType</span><span class='hs-layout'>)</span>
<a name="line-2929"></a><span class='hs-definition'>instDFunType</span> <span class='hs-varid'>dfun_id</span> <span class='hs-varid'>inst_tys</span>
<a name="line-2930"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>instDFunType</span> <span class='hs-varid'>dfun_id</span> <span class='hs-varid'>inst_tys</span>
<a name="line-2931"></a>
<a name="line-2932"></a><a name="newFlexiTcSTy"></a><span class='hs-definition'>newFlexiTcSTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcType</span>
<a name="line-2933"></a><span class='hs-definition'>newFlexiTcSTy</span> <span class='hs-varid'>knd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>knd</span><span class='hs-layout'>)</span>
<a name="line-2934"></a>
<a name="line-2935"></a><a name="cloneMetaTyVar"></a><span class='hs-definition'>cloneMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-2936"></a><span class='hs-definition'>cloneMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>cloneMetaTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-2937"></a>
<a name="line-2938"></a><a name="instFlexi"></a><span class='hs-definition'>instFlexi</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TKVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2939"></a><span class='hs-definition'>instFlexi</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>instFlexiX</span> <span class='hs-varid'>emptyTCvSubst</span>
<a name="line-2940"></a>
<a name="line-2941"></a><a name="instFlexiX"></a><span class='hs-definition'>instFlexiX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TKVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2942"></a><span class='hs-definition'>instFlexiX</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span>
<a name="line-2943"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldlM</span> <span class='hs-varid'>instFlexiHelper</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-2944"></a>
<a name="line-2945"></a><a name="instFlexiHelper"></a><span class='hs-definition'>instFlexiHelper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TKVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2946"></a><span class='hs-definition'>instFlexiHelper</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span>
<a name="line-2947"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newUnique</span>
<a name="line-2948"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newMetaDetails</span> <span class='hs-conid'>TauTv</span>
<a name="line-2949"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setNameUnique</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>uniq</span>
<a name="line-2950"></a>             <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyUnchecked</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-2951"></a>             <span class='hs-varid'>ty'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span>
<a name="line-2952"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2953"></a>
<a name="line-2954"></a><a name="tcInstType"></a><span class='hs-definition'>tcInstType</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2955"></a>                   <span class='hs-comment'>-- ^ How to instantiate the type variables</span>
<a name="line-2956"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>   <span class='hs-comment'>-- ^ Type to instantiate</span>
<a name="line-2957"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ Result</span>
<a name="line-2958"></a>                <span class='hs-comment'>-- (type vars, preds (incl equalities), rho)</span>
<a name="line-2959"></a><span class='hs-definition'>tcInstType</span> <span class='hs-varid'>inst_tyvars</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>tcInstType</span> <span class='hs-varid'>inst_tyvars</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-2960"></a>
<a name="line-2961"></a><a name="tcInstSkolTyVarsX"></a><span class='hs-definition'>tcInstSkolTyVarsX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2962"></a><span class='hs-definition'>tcInstSkolTyVarsX</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>tcInstSkolTyVarsX</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span>
<a name="line-2963"></a>
<a name="line-2964"></a><span class='hs-comment'>-- Creating and setting evidence variables and CtFlavors</span>
<a name="line-2965"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-2966"></a>
<a name="line-2967"></a><a name="MaybeNew"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>MaybeNew</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Fresh</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Cached</span> <span class='hs-conid'>EvTerm</span>
<a name="line-2968"></a>
<a name="line-2969"></a><a name="isFresh"></a><span class='hs-definition'>isFresh</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeNew</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2970"></a><span class='hs-definition'>isFresh</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fresh</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2971"></a><span class='hs-definition'>isFresh</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cached</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2972"></a>
<a name="line-2973"></a><a name="freshGoals"></a><span class='hs-definition'>freshGoals</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeNew</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CtEvidence</span><span class='hs-keyglyph'>]</span>
<a name="line-2974"></a><span class='hs-definition'>freshGoals</span> <span class='hs-varid'>mns</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Fresh</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mns</span> <span class='hs-keyglyph'>]</span>
<a name="line-2975"></a>
<a name="line-2976"></a><a name="getEvTerm"></a><span class='hs-definition'>getEvTerm</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeNew</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span>
<a name="line-2977"></a><span class='hs-definition'>getEvTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fresh</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvTerm</span> <span class='hs-varid'>ctev</span>
<a name="line-2978"></a><span class='hs-definition'>getEvTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cached</span> <span class='hs-varid'>evt</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evt</span>
<a name="line-2979"></a>
<a name="line-2980"></a><a name="setEvBind"></a><span class='hs-definition'>setEvBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2981"></a><span class='hs-definition'>setEvBind</span> <span class='hs-varid'>ev_bind</span>
<a name="line-2982"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>evb</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcEvBindsVar</span>
<a name="line-2983"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>addTcEvBind</span> <span class='hs-varid'>evb</span> <span class='hs-varid'>ev_bind</span> <span class='hs-layout'>}</span>
<a name="line-2984"></a>
<a name="line-2985"></a><a name="useVars"></a><span class='hs-comment'>-- | Mark variables as used filling a coercion hole</span>
<a name="line-2986"></a><span class='hs-definition'>useVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2987"></a><span class='hs-definition'>useVars</span> <span class='hs-varid'>vars</span>
<a name="line-2988"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ebv_tcvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcEvBindsVar</span>
<a name="line-2989"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span>
<a name="line-2990"></a>         <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>ref</span>
<a name="line-2991"></a>            <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tcvs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcvs</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>vars</span>
<a name="line-2992"></a>            <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>tcvs'</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-2993"></a>
<a name="line-2994"></a><a name="setWantedEq"></a><span class='hs-comment'>-- | Equalities only</span>
<a name="line-2995"></a><span class='hs-definition'>setWantedEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcEvDest</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2996"></a><span class='hs-definition'>setWantedEq</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleDest</span> <span class='hs-varid'>hole</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-2997"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>useVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2998"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>fillCoercionHole</span> <span class='hs-varid'>hole</span> <span class='hs-varid'>co</span> <span class='hs-layout'>}</span>
<a name="line-2999"></a><span class='hs-definition'>setWantedEq</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvVarDest</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"setWantedEq"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-3000"></a>
<a name="line-3001"></a><a name="setEqIfWanted"></a><span class='hs-comment'>-- | Equalities only</span>
<a name="line-3002"></a><span class='hs-definition'>setEqIfWanted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3003"></a><span class='hs-definition'>setEqIfWanted</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_dest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dest</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setWantedEq</span> <span class='hs-varid'>dest</span> <span class='hs-varid'>co</span>
<a name="line-3004"></a><span class='hs-definition'>setEqIfWanted</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-3005"></a>
<a name="line-3006"></a><a name="setWantedEvTerm"></a><span class='hs-comment'>-- | Good for equalities and non-equalities</span>
<a name="line-3007"></a><span class='hs-definition'>setWantedEvTerm</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcEvDest</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3008"></a><span class='hs-definition'>setWantedEvTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleDest</span> <span class='hs-varid'>hole</span><span class='hs-layout'>)</span> <span class='hs-varid'>tm</span>
<a name="line-3009"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evTermCoercion</span> <span class='hs-varid'>tm</span>
<a name="line-3010"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>useVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3011"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>fillCoercionHole</span> <span class='hs-varid'>hole</span> <span class='hs-varid'>co</span> <span class='hs-layout'>}</span>
<a name="line-3012"></a><span class='hs-definition'>setWantedEvTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvVarDest</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setWantedEvBind</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>tm</span>
<a name="line-3013"></a>
<a name="line-3014"></a><a name="setWantedEvBind"></a><span class='hs-definition'>setWantedEvBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3015"></a><span class='hs-definition'>setWantedEvBind</span> <span class='hs-varid'>ev_id</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setEvBind</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWantedEvBind</span> <span class='hs-varid'>ev_id</span> <span class='hs-varid'>tm</span><span class='hs-layout'>)</span>
<a name="line-3016"></a>
<a name="line-3017"></a><a name="setEvBindIfWanted"></a><span class='hs-definition'>setEvBindIfWanted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3018"></a><span class='hs-definition'>setEvBindIfWanted</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>tm</span>
<a name="line-3019"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ev</span> <span class='hs-keyword'>of</span>
<a name="line-3020"></a>      <span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_dest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dest</span> <span class='hs-layout'>}</span>
<a name="line-3021"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>setWantedEvTerm</span> <span class='hs-varid'>dest</span> <span class='hs-varid'>tm</span>
<a name="line-3022"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-3023"></a>
<a name="line-3024"></a><a name="newTcEvBinds"></a><span class='hs-definition'>newTcEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-3025"></a><span class='hs-definition'>newTcEvBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcEvBinds</span>
<a name="line-3026"></a>
<a name="line-3027"></a><a name="newEvVar"></a><span class='hs-definition'>newEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvVar</span>
<a name="line-3028"></a><span class='hs-definition'>newEvVar</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newEvVar</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-3029"></a>
<a name="line-3030"></a><a name="newGivenEvVar"></a><span class='hs-definition'>newGivenEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPredType</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvTerm</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-3031"></a><span class='hs-comment'>-- Make a new variable of the given PredType,</span>
<a name="line-3032"></a><span class='hs-comment'>-- immediately bind it to the given term</span>
<a name="line-3033"></a><span class='hs-comment'>-- and return its CtEvidence</span>
<a name="line-3034"></a><span class='hs-comment'>-- See Note [Bind new Givens immediately] in TcRnTypes</span>
<a name="line-3035"></a><span class='hs-definition'>newGivenEvVar</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-3036"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newBoundEvVarId</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>rhs</span>
<a name="line-3037"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3038"></a>
<a name="line-3039"></a><a name="newBoundEvVarId"></a><span class='hs-comment'>-- | Make a new 'Id' of the given type, bound (in the monad's EvBinds) to the</span>
<a name="line-3040"></a><span class='hs-comment'>-- given term</span>
<a name="line-3041"></a><span class='hs-definition'>newBoundEvVarId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvVar</span>
<a name="line-3042"></a><span class='hs-definition'>newBoundEvVarId</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>rhs</span>
<a name="line-3043"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEvVar</span> <span class='hs-varid'>pred</span>
<a name="line-3044"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setEvBind</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkGivenEvBind</span> <span class='hs-varid'>new_ev</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-3045"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>new_ev</span> <span class='hs-layout'>}</span>
<a name="line-3046"></a>
<a name="line-3047"></a><a name="newGivenEvVars"></a><span class='hs-definition'>newGivenEvVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TcPredType</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvTerm</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CtEvidence</span><span class='hs-keyglyph'>]</span>
<a name="line-3048"></a><span class='hs-definition'>newGivenEvVars</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>newGivenEvVar</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varid'>pts</span>
<a name="line-3049"></a>
<a name="line-3050"></a><a name="emitNewWantedEq"></a><span class='hs-definition'>emitNewWantedEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Coercion</span>
<a name="line-3051"></a><span class='hs-comment'>-- | Emit a new Wanted equality into the work-list</span>
<a name="line-3052"></a><span class='hs-definition'>emitNewWantedEq</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-3053"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3054"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newWantedEq</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-3055"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-varop'>$</span>
<a name="line-3056"></a>         <span class='hs-varid'>extendWorkListEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNonCanonical</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-3057"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>co</span> <span class='hs-layout'>}</span>
<a name="line-3058"></a>
<a name="line-3059"></a><a name="newWantedEq"></a><span class='hs-comment'>-- | Make a new equality CtEvidence</span>
<a name="line-3060"></a><span class='hs-definition'>newWantedEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-3061"></a><span class='hs-definition'>newWantedEq</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-3062"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hole</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newCoercionHole</span>
<a name="line-3063"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emitting new coercion hole"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hole</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>pty</span><span class='hs-layout'>)</span>
<a name="line-3064"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_dest</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HoleDest</span> <span class='hs-varid'>hole</span>
<a name="line-3065"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_nosh</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WDeriv</span>
<a name="line-3066"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span><span class='hs-layout'>}</span>
<a name="line-3067"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>mkHoleCo</span> <span class='hs-varid'>hole</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3068"></a>  <span class='hs-keyword'>where</span>
<a name="line-3069"></a>    <span class='hs-varid'>pty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPrimEqPredRole</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-3070"></a>
<a name="line-3071"></a><a name="newWantedEvVarNC"></a><span class='hs-comment'>-- no equalities here. Use newWantedEq instead</span>
<a name="line-3072"></a><span class='hs-definition'>newWantedEvVarNC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-3073"></a><span class='hs-comment'>-- Don't look up in the solved/inerts; we know it's not there</span>
<a name="line-3074"></a><span class='hs-definition'>newWantedEvVarNC</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-3075"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEvVar</span> <span class='hs-varid'>pty</span>
<a name="line-3076"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emitting new wanted"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>new_ev</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>pty</span> <span class='hs-varop'>$$</span>
<a name="line-3077"></a>                                         <span class='hs-varid'>pprCtLoc</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-3078"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_dest</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvVarDest</span> <span class='hs-varid'>new_ev</span>
<a name="line-3079"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_nosh</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WDeriv</span>
<a name="line-3080"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>}</span>
<a name="line-3081"></a>
<a name="line-3082"></a><a name="newWantedEvVar"></a><span class='hs-definition'>newWantedEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>MaybeNew</span>
<a name="line-3083"></a><span class='hs-comment'>-- For anything except ClassPred, this is the same as newWantedEvVarNC</span>
<a name="line-3084"></a><span class='hs-definition'>newWantedEvVar</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-3085"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_ct</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupInInerts</span> <span class='hs-varid'>pty</span>
<a name="line-3086"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_ct</span> <span class='hs-keyword'>of</span>
<a name="line-3087"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>ctev</span>
<a name="line-3088"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isDerived</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span>
<a name="line-3089"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"newWantedEvVar/cache hit"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ctev</span>
<a name="line-3090"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Cached</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvTerm</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3091"></a>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newWantedEvVarNC</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-3092"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fresh</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-3093"></a>
<a name="line-3094"></a><a name="newWanted"></a><span class='hs-comment'>-- deals with both equalities and non equalities. Tries to look</span>
<a name="line-3095"></a><span class='hs-comment'>-- up non-equalities in the cache</span>
<a name="line-3096"></a><span class='hs-definition'>newWanted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>MaybeNew</span>
<a name="line-3097"></a><span class='hs-definition'>newWanted</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-3098"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>role</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEqPredTys_maybe</span> <span class='hs-varid'>pty</span>
<a name="line-3099"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Fresh</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>newWantedEq</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-3100"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3101"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newWantedEvVar</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-3102"></a>
<a name="line-3103"></a><a name="newWantedNC"></a><span class='hs-comment'>-- deals with both equalities and non equalities. Doesn't do any cache lookups.</span>
<a name="line-3104"></a><span class='hs-definition'>newWantedNC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-3105"></a><span class='hs-definition'>newWantedNC</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-3106"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>role</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEqPredTys_maybe</span> <span class='hs-varid'>pty</span>
<a name="line-3107"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>newWantedEq</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-3108"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3109"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newWantedEvVarNC</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-3110"></a>
<a name="line-3111"></a><a name="emitNewDerived"></a><span class='hs-definition'>emitNewDerived</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3112"></a><span class='hs-definition'>emitNewDerived</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pred</span>
<a name="line-3113"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newDerivedNC</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pred</span>
<a name="line-3114"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emitting new derived"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-3115"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendWorkListDerived</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3116"></a>
<a name="line-3117"></a><a name="emitNewDeriveds"></a><span class='hs-definition'>emitNewDeriveds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcPredType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3118"></a><span class='hs-definition'>emitNewDeriveds</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>preds</span>
<a name="line-3119"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>preds</span>
<a name="line-3120"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-3121"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3122"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>evs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>newDerivedNC</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varid'>preds</span>
<a name="line-3123"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emitting new deriveds"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>evs</span><span class='hs-layout'>)</span>
<a name="line-3124"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendWorkListDeriveds</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>evs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3125"></a>
<a name="line-3126"></a><a name="emitNewDerivedEq"></a><span class='hs-definition'>emitNewDerivedEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3127"></a><span class='hs-comment'>-- Create new equality Derived and put it in the work list</span>
<a name="line-3128"></a><span class='hs-comment'>-- There's no caching, no lookupInInerts</span>
<a name="line-3129"></a><span class='hs-definition'>emitNewDerivedEq</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-3130"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newDerivedNC</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPrimEqPredRole</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-3131"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emitting new derived equality"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>pprCtLoc</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-3132"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendWorkListDerived</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3133"></a>
<a name="line-3134"></a><a name="newDerivedNC"></a><span class='hs-definition'>newDerivedNC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-3135"></a><span class='hs-definition'>newDerivedNC</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pred</span>
<a name="line-3136"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- checkReductionDepth loc pred</span>
<a name="line-3137"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3138"></a>
<a name="line-3139"></a><a name="checkReductionDepth"></a><span class='hs-comment'>-- --------- Check done in TcInteract.selectNewWorkItem???? ---------</span>
<a name="line-3140"></a><span class='hs-comment'>-- | Checks if the depth of the given location is too much. Fails if</span>
<a name="line-3141"></a><span class='hs-comment'>-- it's too big, with an appropriate error message.</span>
<a name="line-3142"></a><span class='hs-definition'>checkReductionDepth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>   <span class='hs-comment'>-- ^ type being reduced</span>
<a name="line-3143"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3144"></a><span class='hs-definition'>checkReductionDepth</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ty</span>
<a name="line-3145"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-3146"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>subGoalDepthExceeded</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocDepth</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-3147"></a>         <span class='hs-varid'>wrapErrTcS</span> <span class='hs-varop'>$</span>
<a name="line-3148"></a>         <span class='hs-varid'>solverDepthErrorTcS</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-3149"></a>
<a name="line-3150"></a><a name="matchFam"></a><span class='hs-definition'>matchFam</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3151"></a><span class='hs-definition'>matchFam</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>matchFamTcM</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span>
<a name="line-3152"></a>
<a name="line-3153"></a><a name="matchFamTcM"></a><span class='hs-definition'>matchFamTcM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3154"></a><span class='hs-comment'>-- Given (F tys) return (ty, co), where co :: F tys ~ ty</span>
<a name="line-3155"></a><span class='hs-definition'>matchFamTcM</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span>
<a name="line-3156"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fam_envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>FamInst</span><span class='hs-varop'>.</span><span class='hs-varid'>tcGetFamInstEnvs</span>
<a name="line-3157"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>match_fam_result</span>
<a name="line-3158"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reduceTyFamApp_maybe</span> <span class='hs-varid'>fam_envs</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span>
<a name="line-3159"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>traceTc</span> <span class='hs-str'>"matchFamTcM"</span> <span class='hs-varop'>$</span>
<a name="line-3160"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Matching:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-3161"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ppr_res</span> <span class='hs-varid'>match_fam_result</span> <span class='hs-keyglyph'>]</span>
<a name="line-3162"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>match_fam_result</span> <span class='hs-layout'>}</span>
<a name="line-3163"></a>  <span class='hs-keyword'>where</span>
<a name="line-3164"></a>    <span class='hs-varid'>ppr_res</span> <span class='hs-conid'>Nothing</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Match failed"</span>
<a name="line-3165"></a>    <span class='hs-varid'>ppr_res</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Match succeeded:"</span><span class='hs-layout'>)</span>
<a name="line-3166"></a>                                <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Rewrites to:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
<a name="line-3167"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Coercion:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-3168"></a>
<a name="line-3169"></a><span class='hs-comment'>{-
<a name="line-3170"></a>Note [Residual implications]
<a name="line-3171"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-3172"></a>The wl_implics in the WorkList are the residual implication
<a name="line-3173"></a>constraints that are generated while solving or canonicalising the
<a name="line-3174"></a>current worklist.  Specifically, when canonicalising
<a name="line-3175"></a>   (forall a. t1 ~ forall a. t2)
<a name="line-3176"></a>from which we get the implication
<a name="line-3177"></a>   (forall a. t1 ~ t2)
<a name="line-3178"></a>See TcSMonad.deferTcSForAllEq
<a name="line-3179"></a>-}</span>
<a name="line-3180"></a>
</pre></body>
</html>
