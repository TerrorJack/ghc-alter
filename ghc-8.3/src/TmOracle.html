<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>deSugar/TmOracle.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>Author: George Karachalias &lt;george.karachalias@cs.kuleuven.be&gt;
<a name="line-3"></a>
<a name="line-4"></a>The term equality oracle. The main export of the module is function `tmOracle'.
<a name="line-5"></a>-}</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-comment'>{-# LANGUAGE CPP, MultiWayIf #-}</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TmOracle</span> <span class='hs-layout'>(</span>
<a name="line-10"></a>
<a name="line-11"></a>        <span class='hs-comment'>-- re-exported from PmExpr</span>
<a name="line-12"></a>        <span class='hs-conid'>PmExpr</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>PmLit</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>SimpleEq</span><span class='hs-layout'>,</span> <span class='hs-conid'>ComplexEq</span><span class='hs-layout'>,</span> <span class='hs-conid'>PmVarEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>falsePmExpr</span><span class='hs-layout'>,</span>
<a name="line-13"></a>        <span class='hs-varid'>eqPmLit</span><span class='hs-layout'>,</span> <span class='hs-varid'>filterComplex</span><span class='hs-layout'>,</span> <span class='hs-varid'>isNotPmExprOther</span><span class='hs-layout'>,</span> <span class='hs-varid'>runPmPprM</span><span class='hs-layout'>,</span> <span class='hs-varid'>lhsExprToPmExpr</span><span class='hs-layout'>,</span>
<a name="line-14"></a>        <span class='hs-varid'>hsExprToPmExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprPmExprWithParens</span><span class='hs-layout'>,</span>
<a name="line-15"></a>
<a name="line-16"></a>        <span class='hs-comment'>-- the term oracle</span>
<a name="line-17"></a>        <span class='hs-varid'>tmOracle</span><span class='hs-layout'>,</span> <span class='hs-conid'>TmState</span><span class='hs-layout'>,</span> <span class='hs-varid'>initialTmState</span><span class='hs-layout'>,</span> <span class='hs-varid'>solveOneEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>canDiverge</span><span class='hs-layout'>,</span>
<a name="line-18"></a>
<a name="line-19"></a>        <span class='hs-comment'>-- misc.</span>
<a name="line-20"></a>        <span class='hs-varid'>toComplex</span><span class='hs-layout'>,</span> <span class='hs-varid'>exprDeepLookup</span><span class='hs-layout'>,</span> <span class='hs-varid'>pmLitType</span><span class='hs-layout'>,</span> <span class='hs-varid'>flattenPmVarEnv</span>
<a name="line-21"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PmExpr</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsLit</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcHsSyn</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MonadUtils</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-34"></a>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameEnv</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-comment'>{-
<a name="line-38"></a>%************************************************************************
<a name="line-39"></a>%*                                                                      *
<a name="line-40"></a>                      The term equality oracle
<a name="line-41"></a>%*                                                                      *
<a name="line-42"></a>%************************************************************************
<a name="line-43"></a>-}</span>
<a name="line-44"></a>
<a name="line-45"></a><a name="PmVarEnv"></a><span class='hs-comment'>-- | The type of substitutions.</span>
<a name="line-46"></a><a name="PmVarEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>PmVarEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameEnv</span> <span class='hs-conid'>PmExpr</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="TmOracleEnv"></a><span class='hs-comment'>-- | The environment of the oracle contains</span>
<a name="line-49"></a><a name="TmOracleEnv"></a><span class='hs-comment'>--     1. A Bool (are there any constraints we cannot handle? (PmExprOther)).</span>
<a name="line-50"></a><a name="TmOracleEnv"></a><span class='hs-comment'>--     2. A substitution we extend with every step and return as a result.</span>
<a name="line-51"></a><a name="TmOracleEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TmOracleEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>PmVarEnv</span><span class='hs-layout'>)</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="canDiverge"></a><span class='hs-comment'>-- | Check whether a constraint (x ~ BOT) can succeed,</span>
<a name="line-54"></a><span class='hs-comment'>-- given the resulting state of the term oracle.</span>
<a name="line-55"></a><span class='hs-definition'>canDiverge</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TmState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-56"></a><span class='hs-definition'>canDiverge</span> <span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-varid'>standby</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-sel'>_unhandled</span><span class='hs-layout'>,</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-57"></a>  <span class='hs-comment'>-- If the variable seems not evaluated, there is a possibility for</span>
<a name="line-58"></a>  <span class='hs-comment'>-- constraint x ~ BOT to be satisfiable.</span>
<a name="line-59"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PmExprVar</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>varDeepLookup</span> <span class='hs-varid'>env</span> <span class='hs-varid'>x</span> <span class='hs-comment'>-- seems not forced</span>
<a name="line-60"></a>  <span class='hs-comment'>-- If it is involved (directly or indirectly) in any equality in the</span>
<a name="line-61"></a>  <span class='hs-comment'>-- worklist, we can assume that it is already indirectly evaluated,</span>
<a name="line-62"></a>  <span class='hs-comment'>-- as a side-effect of equality checking. If not, then we can assume</span>
<a name="line-63"></a>  <span class='hs-comment'>-- that the constraint is satisfiable.</span>
<a name="line-64"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>isForcedByEq</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>standby</span> <span class='hs-varop'>||</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>isForcedByEq</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span> <span class='hs-varid'>standby</span>
<a name="line-65"></a>  <span class='hs-comment'>-- Variable x is already in WHNF so the constraint is non-satisfiable</span>
<a name="line-66"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-67"></a>
<a name="line-68"></a>  <span class='hs-keyword'>where</span>
<a name="line-69"></a>    <span class='hs-varid'>isForcedByEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ComplexEq</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-70"></a>    <span class='hs-varid'>isForcedByEq</span> <span class='hs-varid'>y</span> <span class='hs-layout'>(</span><span class='hs-varid'>e1</span><span class='hs-layout'>,</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varIn</span> <span class='hs-varid'>y</span> <span class='hs-varid'>e1</span> <span class='hs-varop'>||</span> <span class='hs-varid'>varIn</span> <span class='hs-varid'>y</span> <span class='hs-varid'>e2</span>
<a name="line-71"></a>
<a name="line-72"></a><a name="varIn"></a><span class='hs-comment'>-- | Check whether a variable is in the free variables of an expression</span>
<a name="line-73"></a><span class='hs-definition'>varIn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-74"></a><span class='hs-definition'>varIn</span> <span class='hs-varid'>x</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>of</span>
<a name="line-75"></a>  <span class='hs-conid'>PmExprVar</span> <span class='hs-varid'>y</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span> <span class='hs-varop'>==</span> <span class='hs-varid'>y</span>
<a name="line-76"></a>  <span class='hs-conid'>PmExprCon</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>es</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span> <span class='hs-varop'>`varIn`</span><span class='hs-layout'>)</span> <span class='hs-varid'>es</span>
<a name="line-77"></a>  <span class='hs-conid'>PmExprLit</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-78"></a>  <span class='hs-conid'>PmExprEq</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span> <span class='hs-varop'>`varIn`</span> <span class='hs-varid'>e1</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span> <span class='hs-varop'>`varIn`</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span>
<a name="line-79"></a>  <span class='hs-conid'>PmExprOther</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-80"></a>
<a name="line-81"></a><a name="flattenPmVarEnv"></a><span class='hs-comment'>-- | Flatten the DAG (Could be improved in terms of performance.).</span>
<a name="line-82"></a><span class='hs-definition'>flattenPmVarEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PmVarEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PmVarEnv</span>
<a name="line-83"></a><span class='hs-definition'>flattenPmVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapNameEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprDeepLookup</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span>
<a name="line-84"></a>
<a name="line-85"></a><a name="TmState"></a><span class='hs-comment'>-- | The state of the term oracle (includes complex constraints that cannot</span>
<a name="line-86"></a><a name="TmState"></a><span class='hs-comment'>-- progress unless we get more information).</span>
<a name="line-87"></a><a name="TmState"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TmState</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>ComplexEq</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TmOracleEnv</span><span class='hs-layout'>)</span>
<a name="line-88"></a>
<a name="line-89"></a><a name="initialTmState"></a><span class='hs-comment'>-- | Initial state of the oracle.</span>
<a name="line-90"></a><span class='hs-definition'>initialTmState</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TmState</span>
<a name="line-91"></a><span class='hs-definition'>initialTmState</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyNameEnv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-92"></a>
<a name="line-93"></a><a name="solveOneEq"></a><span class='hs-comment'>-- | Solve a complex equality (top-level).</span>
<a name="line-94"></a><span class='hs-definition'>solveOneEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TmState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ComplexEq</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TmState</span>
<a name="line-95"></a><span class='hs-definition'>solveOneEq</span> <span class='hs-varid'>solver_env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>complex</span>
<a name="line-96"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>solveComplexEq</span> <span class='hs-varid'>solver_env</span> <span class='hs-comment'>-- do the actual *merging* with existing state</span>
<a name="line-97"></a>  <span class='hs-varop'>$</span> <span class='hs-varid'>simplifyComplexEq</span>               <span class='hs-comment'>-- simplify as much as you can</span>
<a name="line-98"></a>  <span class='hs-varop'>$</span> <span class='hs-varid'>applySubstComplexEq</span> <span class='hs-varid'>env</span> <span class='hs-varid'>complex</span> <span class='hs-comment'>-- replace everything we already know</span>
<a name="line-99"></a>
<a name="line-100"></a><a name="solveComplexEq"></a><span class='hs-comment'>-- | Solve a complex equality.</span>
<a name="line-101"></a><span class='hs-definition'>solveComplexEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TmState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ComplexEq</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TmState</span>
<a name="line-102"></a><span class='hs-definition'>solveComplexEq</span> <span class='hs-varid'>solver_state</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>standby</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>unhandled</span><span class='hs-layout'>,</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>eq</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>e1</span><span class='hs-layout'>,</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>eq</span> <span class='hs-keyword'>of</span>
<a name="line-103"></a>  <span class='hs-comment'>-- We cannot do a thing about these cases</span>
<a name="line-104"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>PmExprOther</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>standby</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-105"></a>  <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-conid'>PmExprOther</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>standby</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-106"></a>
<a name="line-107"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>PmExprLit</span> <span class='hs-varid'>l1</span><span class='hs-layout'>,</span> <span class='hs-conid'>PmExprLit</span> <span class='hs-varid'>l2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>eqPmLit</span> <span class='hs-varid'>l1</span> <span class='hs-varid'>l2</span> <span class='hs-keyword'>of</span>
<a name="line-108"></a>    <span class='hs-comment'>-- See Note [Undecidable Equality for Overloaded Literals]</span>
<a name="line-109"></a>    <span class='hs-conid'>True</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>solver_state</span>
<a name="line-110"></a>    <span class='hs-conid'>False</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-111"></a>
<a name="line-112"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>PmExprCon</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>ts1</span><span class='hs-layout'>,</span> <span class='hs-conid'>PmExprCon</span> <span class='hs-varid'>c2</span> <span class='hs-varid'>ts2</span><span class='hs-layout'>)</span>
<a name="line-113"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>c2</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>foldlM</span> <span class='hs-varid'>solveComplexEq</span> <span class='hs-varid'>solver_state</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-varid'>ts1</span> <span class='hs-varid'>ts2</span><span class='hs-layout'>)</span>
<a name="line-114"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-115"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>PmExprCon</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>PmExprEq</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-116"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTruePmExpr</span> <span class='hs-varid'>e1</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>solveComplexEq</span> <span class='hs-varid'>solver_state</span> <span class='hs-layout'>(</span><span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-117"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFalsePmExpr</span> <span class='hs-varid'>e1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>eq</span><span class='hs-conop'>:</span><span class='hs-varid'>standby</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>unhandled</span><span class='hs-layout'>,</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-118"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>PmExprEq</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>,</span> <span class='hs-conid'>PmExprCon</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-119"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTruePmExpr</span> <span class='hs-varid'>e2</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>solveComplexEq</span> <span class='hs-varid'>solver_state</span> <span class='hs-layout'>(</span><span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-120"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFalsePmExpr</span> <span class='hs-varid'>e2</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>eq</span><span class='hs-conop'>:</span><span class='hs-varid'>standby</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>unhandled</span><span class='hs-layout'>,</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-121"></a>
<a name="line-122"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>PmExprVar</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-conid'>PmExprVar</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span>
<a name="line-123"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span> <span class='hs-varop'>==</span> <span class='hs-varid'>y</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>solver_state</span>
<a name="line-124"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendSubstAndSolve</span> <span class='hs-varid'>x</span> <span class='hs-varid'>e2</span> <span class='hs-varid'>solver_state</span>
<a name="line-125"></a>
<a name="line-126"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>PmExprVar</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendSubstAndSolve</span> <span class='hs-varid'>x</span> <span class='hs-varid'>e2</span> <span class='hs-varid'>solver_state</span>
<a name="line-127"></a>  <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>PmExprVar</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendSubstAndSolve</span> <span class='hs-varid'>x</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>solver_state</span>
<a name="line-128"></a>
<a name="line-129"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>PmExprEq</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>PmExprEq</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>eq</span><span class='hs-conop'>:</span><span class='hs-varid'>standby</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>unhandled</span><span class='hs-layout'>,</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-130"></a>
<a name="line-131"></a>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>standby</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- I HATE CATCH-ALLS</span>
<a name="line-132"></a>
<a name="line-133"></a><a name="extendSubstAndSolve"></a><span class='hs-comment'>-- | Extend the substitution and solve the (possibly updated) constraints.</span>
<a name="line-134"></a><span class='hs-definition'>extendSubstAndSolve</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TmState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TmState</span>
<a name="line-135"></a><span class='hs-definition'>extendSubstAndSolve</span> <span class='hs-varid'>x</span> <span class='hs-varid'>e</span> <span class='hs-layout'>(</span><span class='hs-varid'>standby</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>unhandled</span><span class='hs-layout'>,</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-136"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldlM</span> <span class='hs-varid'>solveComplexEq</span> <span class='hs-varid'>new_incr_state</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>simplifyComplexEq</span> <span class='hs-varid'>changed</span><span class='hs-layout'>)</span>
<a name="line-137"></a>  <span class='hs-keyword'>where</span>
<a name="line-138"></a>    <span class='hs-comment'>-- Apply the substitution to the worklist and partition them to the ones</span>
<a name="line-139"></a>    <span class='hs-comment'>-- that had some progress and the rest. Then, recurse over the ones that</span>
<a name="line-140"></a>    <span class='hs-comment'>-- had some progress. Careful about performance:</span>
<a name="line-141"></a>    <span class='hs-comment'>-- See Note [Representation of Term Equalities] in deSugar/Check.hs</span>
<a name="line-142"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>changed</span><span class='hs-layout'>,</span> <span class='hs-varid'>unchanged</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>substComplexEq</span> <span class='hs-varid'>x</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-varid'>standby</span>
<a name="line-143"></a>    <span class='hs-varid'>new_incr_state</span>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>unchanged</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>unhandled</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendNameEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>x</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-144"></a>
<a name="line-145"></a><a name="extendSubst"></a><span class='hs-comment'>-- | When we know that a variable is fresh, we do not actually have to</span>
<a name="line-146"></a><span class='hs-comment'>-- check whether anything changes, we know that nothing does. Hence,</span>
<a name="line-147"></a><span class='hs-comment'>-- `extendSubst` simply extends the substitution, unlike what</span>
<a name="line-148"></a><span class='hs-comment'>-- `extendSubstAndSolve` does.</span>
<a name="line-149"></a><span class='hs-definition'>extendSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TmState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TmState</span>
<a name="line-150"></a><span class='hs-definition'>extendSubst</span> <span class='hs-varid'>y</span> <span class='hs-varid'>e</span> <span class='hs-layout'>(</span><span class='hs-varid'>standby</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>unhandled</span><span class='hs-layout'>,</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-151"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isNotPmExprOther</span> <span class='hs-varid'>simpl_e</span>
<a name="line-152"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>standby</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>unhandled</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendNameEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>x</span> <span class='hs-varid'>simpl_e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-153"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>standby</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-154"></a>  <span class='hs-keyword'>where</span>
<a name="line-155"></a>    <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>y</span>
<a name="line-156"></a>    <span class='hs-varid'>simpl_e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>simplifyPmExpr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>exprDeepLookup</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span>
<a name="line-157"></a>
<a name="line-158"></a><a name="simplifyComplexEq"></a><span class='hs-comment'>-- | Simplify a complex equality.</span>
<a name="line-159"></a><span class='hs-definition'>simplifyComplexEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ComplexEq</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ComplexEq</span>
<a name="line-160"></a><span class='hs-definition'>simplifyComplexEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>e1</span><span class='hs-layout'>,</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>simplifyPmExpr</span> <span class='hs-varid'>e1</span><span class='hs-layout'>,</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>simplifyPmExpr</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span>
<a name="line-161"></a>
<a name="line-162"></a><a name="simplifyPmExpr"></a><span class='hs-comment'>-- | Simplify an expression. The boolean indicates if there has been any</span>
<a name="line-163"></a><span class='hs-comment'>-- simplification or if the operation was a no-op.</span>
<a name="line-164"></a><span class='hs-definition'>simplifyPmExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>PmExpr</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>
<a name="line-165"></a><span class='hs-comment'>-- See Note [Deep equalities]</span>
<a name="line-166"></a><span class='hs-definition'>simplifyPmExpr</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>of</span>
<a name="line-167"></a>  <span class='hs-conid'>PmExprCon</span> <span class='hs-varid'>c</span> <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mapAndUnzip</span> <span class='hs-varid'>simplifyPmExpr</span> <span class='hs-varid'>ts</span> <span class='hs-keyword'>of</span>
<a name="line-168"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>ts'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>PmExprCon</span> <span class='hs-varid'>c</span> <span class='hs-varid'>ts'</span><span class='hs-layout'>,</span> <span class='hs-varid'>or</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-169"></a>  <span class='hs-conid'>PmExprEq</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>simplifyEqExpr</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-170"></a>  <span class='hs-sel'>_other_expr</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>e</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- the others are terminals</span>
<a name="line-171"></a>
<a name="line-172"></a><a name="simplifyEqExpr"></a><span class='hs-comment'>-- | Simplify an equality expression. The equality is given in parts.</span>
<a name="line-173"></a><span class='hs-definition'>simplifyEqExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>PmExpr</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>
<a name="line-174"></a><span class='hs-comment'>-- See Note [Deep equalities]</span>
<a name="line-175"></a><span class='hs-definition'>simplifyEqExpr</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>e1</span><span class='hs-layout'>,</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-176"></a>  <span class='hs-comment'>-- Varables</span>
<a name="line-177"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>PmExprVar</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-conid'>PmExprVar</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span>
<a name="line-178"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span> <span class='hs-varop'>==</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>truePmExpr</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
<a name="line-179"></a>
<a name="line-180"></a>  <span class='hs-comment'>-- Literals</span>
<a name="line-181"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>PmExprLit</span> <span class='hs-varid'>l1</span><span class='hs-layout'>,</span> <span class='hs-conid'>PmExprLit</span> <span class='hs-varid'>l2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>eqPmLit</span> <span class='hs-varid'>l1</span> <span class='hs-varid'>l2</span> <span class='hs-keyword'>of</span>
<a name="line-182"></a>    <span class='hs-comment'>-- See Note [Undecidable Equality for Overloaded Literals]</span>
<a name="line-183"></a>    <span class='hs-conid'>True</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>truePmExpr</span><span class='hs-layout'>,</span>  <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
<a name="line-184"></a>    <span class='hs-conid'>False</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>falsePmExpr</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
<a name="line-185"></a>
<a name="line-186"></a>  <span class='hs-comment'>-- Can potentially be simplified</span>
<a name="line-187"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>PmExprEq</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>simplifyPmExpr</span> <span class='hs-varid'>e1</span><span class='hs-layout'>,</span> <span class='hs-varid'>simplifyPmExpr</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-188"></a>    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>e1'</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span> <span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>e2'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span>    <span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>simplifyEqExpr</span> <span class='hs-varid'>e1'</span> <span class='hs-varid'>e2'</span>
<a name="line-189"></a>    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>e1'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span>    <span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>e2'</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span> <span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>simplifyEqExpr</span> <span class='hs-varid'>e1'</span> <span class='hs-varid'>e2'</span>
<a name="line-190"></a>    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>e1'</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>e2'</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>PmExprEq</span> <span class='hs-varid'>e1'</span> <span class='hs-varid'>e2'</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- cannot progress</span>
<a name="line-191"></a>  <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>PmExprEq</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>simplifyPmExpr</span> <span class='hs-varid'>e1</span><span class='hs-layout'>,</span> <span class='hs-varid'>simplifyPmExpr</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-192"></a>    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>e1'</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span> <span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>e2'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span>    <span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>simplifyEqExpr</span> <span class='hs-varid'>e1'</span> <span class='hs-varid'>e2'</span>
<a name="line-193"></a>    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>e1'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span>    <span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>e2'</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span> <span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>simplifyEqExpr</span> <span class='hs-varid'>e1'</span> <span class='hs-varid'>e2'</span>
<a name="line-194"></a>    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>e1'</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>e2'</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>PmExprEq</span> <span class='hs-varid'>e1'</span> <span class='hs-varid'>e2'</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- cannot progress</span>
<a name="line-195"></a>
<a name="line-196"></a>  <span class='hs-comment'>-- Constructors</span>
<a name="line-197"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>PmExprCon</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>ts1</span><span class='hs-layout'>,</span> <span class='hs-conid'>PmExprCon</span> <span class='hs-varid'>c2</span> <span class='hs-varid'>ts2</span><span class='hs-layout'>)</span>
<a name="line-198"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>c2</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-199"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>ts1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAndUnzip</span> <span class='hs-varid'>simplifyPmExpr</span> <span class='hs-varid'>ts1</span>
<a name="line-200"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>ts2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAndUnzip</span> <span class='hs-varid'>simplifyPmExpr</span> <span class='hs-varid'>ts2</span>
<a name="line-201"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>tss</span><span class='hs-layout'>,</span> <span class='hs-sel'>_bss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWithAndUnzip</span> <span class='hs-varid'>simplifyEqExpr</span> <span class='hs-varid'>ts1'</span> <span class='hs-varid'>ts2'</span>
<a name="line-202"></a>            <span class='hs-varid'>worst_case</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PmExprEq</span> <span class='hs-layout'>(</span><span class='hs-conid'>PmExprCon</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>ts1'</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>PmExprCon</span> <span class='hs-varid'>c2</span> <span class='hs-varid'>ts2'</span><span class='hs-layout'>)</span>
<a name="line-203"></a>        <span class='hs-keyword'>in</span>  <span class='hs-keyword'>if</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>or</span> <span class='hs-varid'>bs1</span> <span class='hs-varop'>||</span> <span class='hs-varid'>or</span> <span class='hs-varid'>bs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>worst_case</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- no progress</span>
<a name="line-204"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isTruePmExpr</span>  <span class='hs-varid'>tss</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>truePmExpr</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
<a name="line-205"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-varid'>isFalsePmExpr</span> <span class='hs-varid'>tss</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>falsePmExpr</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
<a name="line-206"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>worst_case</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-207"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>falsePmExpr</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
<a name="line-208"></a>
<a name="line-209"></a>  <span class='hs-comment'>-- We cannot do anything about the rest..</span>
<a name="line-210"></a>  <span class='hs-sel'>_other_equality</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>original</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-211"></a>
<a name="line-212"></a>  <span class='hs-keyword'>where</span>
<a name="line-213"></a>    <span class='hs-varid'>original</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PmExprEq</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span> <span class='hs-comment'>-- reconstruct equality</span>
<a name="line-214"></a>
<a name="line-215"></a><a name="applySubstComplexEq"></a><span class='hs-comment'>-- | Apply an (un-flattened) substitution to a simple equality.</span>
<a name="line-216"></a><span class='hs-definition'>applySubstComplexEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PmVarEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ComplexEq</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ComplexEq</span>
<a name="line-217"></a><span class='hs-definition'>applySubstComplexEq</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>e1</span><span class='hs-layout'>,</span><span class='hs-varid'>e2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprDeepLookup</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e1</span><span class='hs-layout'>,</span> <span class='hs-varid'>exprDeepLookup</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span>
<a name="line-218"></a>
<a name="line-219"></a><a name="varDeepLookup"></a><span class='hs-comment'>-- | Apply an (un-flattened) substitution to a variable.</span>
<a name="line-220"></a><span class='hs-definition'>varDeepLookup</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PmVarEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PmExpr</span>
<a name="line-221"></a><span class='hs-definition'>varDeepLookup</span> <span class='hs-varid'>env</span> <span class='hs-varid'>x</span>
<a name="line-222"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprDeepLookup</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span> <span class='hs-comment'>-- go deeper</span>
<a name="line-223"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PmExprVar</span> <span class='hs-varid'>x</span>          <span class='hs-comment'>-- terminal</span>
<a name="line-224"></a><span class='hs-comment'>{-# INLINE varDeepLookup #-}</span>
<a name="line-225"></a>
<a name="line-226"></a><a name="exprDeepLookup"></a><span class='hs-comment'>-- | Apply an (un-flattened) substitution to an expression.</span>
<a name="line-227"></a><span class='hs-definition'>exprDeepLookup</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PmVarEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PmExpr</span>
<a name="line-228"></a><span class='hs-definition'>exprDeepLookup</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>PmExprVar</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varDeepLookup</span> <span class='hs-varid'>env</span> <span class='hs-varid'>x</span>
<a name="line-229"></a><span class='hs-definition'>exprDeepLookup</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>PmExprCon</span> <span class='hs-varid'>c</span> <span class='hs-varid'>es</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PmExprCon</span> <span class='hs-varid'>c</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprDeepLookup</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>es</span><span class='hs-layout'>)</span>
<a name="line-230"></a><span class='hs-definition'>exprDeepLookup</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>PmExprEq</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PmExprEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprDeepLookup</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e1</span><span class='hs-layout'>)</span>
<a name="line-231"></a>                                               <span class='hs-layout'>(</span><span class='hs-varid'>exprDeepLookup</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span>
<a name="line-232"></a><span class='hs-definition'>exprDeepLookup</span> <span class='hs-keyword'>_</span>   <span class='hs-varid'>other_expr</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>other_expr</span> <span class='hs-comment'>-- PmExprLit, PmExprOther</span>
<a name="line-233"></a>
<a name="line-234"></a><a name="tmOracle"></a><span class='hs-comment'>-- | External interface to the term oracle.</span>
<a name="line-235"></a><span class='hs-definition'>tmOracle</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TmState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ComplexEq</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TmState</span>
<a name="line-236"></a><span class='hs-definition'>tmOracle</span> <span class='hs-varid'>tm_state</span> <span class='hs-varid'>eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldlM</span> <span class='hs-varid'>solveOneEq</span> <span class='hs-varid'>tm_state</span> <span class='hs-varid'>eqs</span>
<a name="line-237"></a>
<a name="line-238"></a><a name="pmLitType"></a><span class='hs-comment'>-- | Type of a PmLit</span>
<a name="line-239"></a><span class='hs-definition'>pmLitType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PmLit</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-comment'>-- should be in PmExpr but gives cyclic imports :(</span>
<a name="line-240"></a><span class='hs-definition'>pmLitType</span> <span class='hs-layout'>(</span><span class='hs-conid'>PmSLit</span>   <span class='hs-varid'>lit</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsLitType</span>   <span class='hs-varid'>lit</span>
<a name="line-241"></a><span class='hs-definition'>pmLitType</span> <span class='hs-layout'>(</span><span class='hs-conid'>PmOLit</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>overLitType</span> <span class='hs-varid'>lit</span>
<a name="line-242"></a>
<a name="line-243"></a><span class='hs-comment'>{- Note [Deep equalities]
<a name="line-244"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-245"></a>Solving nested equalities is the most difficult part. The general strategy
<a name="line-246"></a>is the following:
<a name="line-247"></a>
<a name="line-248"></a>  * Equalities of the form (True ~ (e1 ~ e2)) are transformed to just
<a name="line-249"></a>    (e1 ~ e2) and then treated recursively.
<a name="line-250"></a>
<a name="line-251"></a>  * Equalities of the form (False ~ (e1 ~ e2)) cannot be analyzed unless
<a name="line-252"></a>    we know more about the inner equality (e1 ~ e2). That's exactly what
<a name="line-253"></a>    `simplifyEqExpr' tries to do: It takes e1 and e2 and either returns
<a name="line-254"></a>    truePmExpr, falsePmExpr or (e1' ~ e2') in case it is uncertain. Note
<a name="line-255"></a>    that it is not e but rather e', since it may perform some
<a name="line-256"></a>    simplifications deeper.
<a name="line-257"></a>-}</span>
</pre></body>
</html>
