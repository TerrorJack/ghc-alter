<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Distribution/Backpack/ModuleScope.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>-- | See &lt;https://github.com/ezyang/ghc-proposals/blob/backpack/proposals/0000-backpack.rst&gt;</span>
<a name="line-2"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Distribution</span><span class='hs-varop'>.</span><span class='hs-conid'>Backpack</span><span class='hs-varop'>.</span><span class='hs-conid'>ModuleScope</span> <span class='hs-layout'>(</span>
<a name="line-3"></a>    <span class='hs-comment'>-- * Module scopes</span>
<a name="line-4"></a>    <span class='hs-conid'>ModuleScope</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-5"></a>    <span class='hs-conid'>ModuleProvides</span><span class='hs-layout'>,</span>
<a name="line-6"></a>    <span class='hs-conid'>ModuleRequires</span><span class='hs-layout'>,</span>
<a name="line-7"></a>    <span class='hs-conid'>ModuleSource</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-8"></a>    <span class='hs-varid'>emptyModuleScope</span><span class='hs-layout'>,</span>
<a name="line-9"></a><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span> <span class='hs-conid'>()</span>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution</span><span class='hs-varop'>.</span><span class='hs-conid'>Compat</span><span class='hs-varop'>.</span><span class='hs-conid'>Prelude</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution</span><span class='hs-varop'>.</span><span class='hs-conid'>ModuleName</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span><span class='hs-varop'>.</span><span class='hs-conid'>IncludeRenaming</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span><span class='hs-varop'>.</span><span class='hs-conid'>PackageName</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span><span class='hs-varop'>.</span><span class='hs-conid'>ComponentName</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution</span><span class='hs-varop'>.</span><span class='hs-conid'>Backpack</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution</span><span class='hs-varop'>.</span><span class='hs-conid'>Backpack</span><span class='hs-varop'>.</span><span class='hs-conid'>ModSubst</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-23"></a>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-comment'>-----------------------------------------------------------------------</span>
<a name="line-26"></a><span class='hs-comment'>-- Module scopes</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-comment'>-- Why is ModuleProvides so complicated?  The basic problem is that</span>
<a name="line-29"></a><span class='hs-comment'>-- we want to support this:</span>
<a name="line-30"></a><span class='hs-comment'>--</span>
<a name="line-31"></a><span class='hs-comment'>--  package p where</span>
<a name="line-32"></a><span class='hs-comment'>--      include q (A)</span>
<a name="line-33"></a><span class='hs-comment'>--      include r (A)</span>
<a name="line-34"></a><span class='hs-comment'>--      module B where</span>
<a name="line-35"></a><span class='hs-comment'>--          import "q" A</span>
<a name="line-36"></a><span class='hs-comment'>--          import "r" A</span>
<a name="line-37"></a><span class='hs-comment'>--</span>
<a name="line-38"></a><span class='hs-comment'>-- Specifically, in Cabal today it is NOT an error have two modules in</span>
<a name="line-39"></a><span class='hs-comment'>-- scope with the same identifier.  So we need to preserve this for</span>
<a name="line-40"></a><span class='hs-comment'>-- Backpack.  The modification is that an ambiguous module name is</span>
<a name="line-41"></a><span class='hs-comment'>-- OK... as long as it is NOT used to fill a requirement!</span>
<a name="line-42"></a><span class='hs-comment'>--</span>
<a name="line-43"></a><span class='hs-comment'>-- So as a first try, we might try deferring unifying provisions that</span>
<a name="line-44"></a><span class='hs-comment'>-- are being glommed together, and check for equality after the fact.</span>
<a name="line-45"></a><span class='hs-comment'>-- But this doesn't work, because what if a multi-module provision</span>
<a name="line-46"></a><span class='hs-comment'>-- is used to fill a requirement?!  So you do the equality test</span>
<a name="line-47"></a><span class='hs-comment'>-- IMMEDIATELY before a requirement fill happens... or never at all.</span>
<a name="line-48"></a><span class='hs-comment'>--</span>
<a name="line-49"></a><span class='hs-comment'>-- Alternate strategy: go ahead and unify, and then if it is revealed</span>
<a name="line-50"></a><span class='hs-comment'>-- that some requirements got filled "out-of-thin-air", error.</span>
<a name="line-51"></a>
<a name="line-52"></a>
<a name="line-53"></a><a name="ModuleScope"></a><span class='hs-comment'>-- | A 'ModuleScope' describes the modules and requirements that</span>
<a name="line-54"></a><a name="ModuleScope"></a><span class='hs-comment'>-- are in-scope as we are processing a Cabal package.  Unlike</span>
<a name="line-55"></a><a name="ModuleScope"></a><span class='hs-comment'>-- a 'ModuleShape', there may be multiple modules in scope at</span>
<a name="line-56"></a><a name="ModuleScope"></a><span class='hs-comment'>-- the same 'ModuleName'; this is only an error if we attempt</span>
<a name="line-57"></a><a name="ModuleScope"></a><span class='hs-comment'>-- to use those modules to fill a requirement.  A 'ModuleScope'</span>
<a name="line-58"></a><a name="ModuleScope"></a><span class='hs-comment'>-- can influence the 'ModuleShape' via a reexport.</span>
<a name="line-59"></a><a name="ModuleScope"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ModuleScope</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ModuleScope</span> <span class='hs-layout'>{</span>
<a name="line-60"></a>    <span class='hs-varid'>modScopeProvides</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleProvides</span><span class='hs-layout'>,</span>
<a name="line-61"></a>    <span class='hs-varid'>modScopeRequires</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleRequires</span>
<a name="line-62"></a>    <span class='hs-layout'>}</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="ModuleProvides"></a><span class='hs-comment'>-- | Every 'Module' in scope at a 'ModuleName' is annotated with</span>
<a name="line-65"></a><a name="ModuleProvides"></a><span class='hs-comment'>-- the 'PackageName' it comes from.</span>
<a name="line-66"></a><a name="ModuleProvides"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ModuleProvides</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleSource</span><span class='hs-keyglyph'>]</span>
<a name="line-67"></a><a name="ModuleRequires"></a><span class='hs-comment'>-- | INVARIANT: entries for ModuleName m, have msrc_module is OpenModuleVar m</span>
<a name="line-68"></a><a name="ModuleRequires"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ModuleRequires</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleSource</span><span class='hs-keyglyph'>]</span>
<a name="line-69"></a><span class='hs-comment'>-- TODO: consider newtping the two types above.</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="ModuleSource"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ModuleSource</span> <span class='hs-keyglyph'>=</span>
<a name="line-72"></a>    <span class='hs-conid'>ModuleSource</span> <span class='hs-layout'>{</span>
<a name="line-73"></a>        <span class='hs-comment'>-- We don't have line numbers, but if we did the</span>
<a name="line-74"></a>        <span class='hs-comment'>-- package name and renaming could be associated</span>
<a name="line-75"></a>        <span class='hs-comment'>-- with that as well</span>
<a name="line-76"></a>        <span class='hs-varid'>msrc_pkgname</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PackageName</span><span class='hs-layout'>,</span>
<a name="line-77"></a>        <span class='hs-varid'>msrc_compname</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ComponentName</span><span class='hs-layout'>,</span>
<a name="line-78"></a>        <span class='hs-varid'>msrc_renaming</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IncludeRenaming</span><span class='hs-layout'>,</span>
<a name="line-79"></a>        <span class='hs-varid'>msrc_module</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OpenModule</span><span class='hs-layout'>,</span>
<a name="line-80"></a>        <span class='hs-varid'>msrc_implicit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-81"></a>    <span class='hs-layout'>}</span>
<a name="line-82"></a>
<a name="line-83"></a><a name="emptyModuleScope"></a><span class='hs-comment'>-- | An empty 'ModuleScope'.</span>
<a name="line-84"></a><span class='hs-definition'>emptyModuleScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleScope</span>
<a name="line-85"></a><span class='hs-definition'>emptyModuleScope</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ModuleScope</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-86"></a>
<a name="line-87"></a><a name="instance%20ModSubst%20ModuleSource"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ModSubst</span> <span class='hs-conid'>ModuleSource</span> <span class='hs-keyword'>where</span>
<a name="line-88"></a>    <span class='hs-varid'>modSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>src</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>src</span> <span class='hs-layout'>{</span> <span class='hs-varid'>msrc_module</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modSubst</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>msrc_module</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre></body>
</html>
